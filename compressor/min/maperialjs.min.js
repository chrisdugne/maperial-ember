(function(a){function c(b){var c=b||window.event,e=[].slice.call(arguments,1),h=0,m=0,r=0;return b=a.event.fix(c),b.type="mousewheel",c.wheelDelta&&(h=c.wheelDelta/120),c.detail&&(h=-c.detail/3),r=h,void 0!==c.axis&&c.axis===c.HORIZONTAL_AXIS&&(r=0,m=-1*h),void 0!==c.wheelDeltaY&&(r=c.wheelDeltaY/120),void 0!==c.wheelDeltaX&&(m=-1*c.wheelDeltaX/120),e.unshift(b,h,m,r),(a.event.dispatch||a.event.handle).apply(this,e)}var b=["DOMMouseScroll","mousewheel"];if(a.event.fixHooks)for(var e=b.length;e;)a.event.fixHooks[b[--e]]=
a.event.mouseHooks;a.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var a=b.length;a;)this.addEventListener(b[--a],c,!1);else this.onmousewheel=c},teardown:function(){if(this.removeEventListener)for(var a=b.length;a;)this.removeEventListener(b[--a],c,!1);else this.onmousewheel=null}};a.fn.extend({mousewheel:function(a){return a?this.bind("mousewheel",a):this.trigger("mousewheel")},unmousewheel:function(a){return this.unbind("mousewheel",a)}})})(jQuery);(function(a,c){function b(){this._state=[];this._defaults={classHolder:"sbHolder",classHolderDisabled:"sbHolderDisabled",classSelector:"sbSelector",classOptions:"sbOptions",classGroup:"sbGroup",classSub:"sbSub",classDisabled:"sbDisabled",classToggleOpen:"sbToggleOpen",classToggle:"sbToggle",classFocus:"sbFocus",speed:200,effect:"slide",onChange:null,onOpen:null,onClose:null}}var e=!0;a.extend(b.prototype,{_isOpenSelectbox:function(a){return!a?!1:this._getInst(a).isOpen},_isDisabledSelectbox:function(a){return!a?
!1:this._getInst(a).isDisabled},_attachSelectbox:function(b,c){function g(){var b,c,d=this.attr("id").split("_")[1];for(b in r._state)b!==d&&r._state.hasOwnProperty(b)&&(c=a("select[sb='"+b+"']")[0])&&r._closeSelectbox(c)}function h(c,B){var f=B&&B.sub?!0:!1,g=B&&B.disabled?!0:!1;c.each(function(c){var B=a(this),h=a("<li>");B.is(":selected")&&(v.text(B.text()),x=e);c===y-1&&h.addClass("last");!B.is(":disabled")&&!g?(c=a("<a>",{href:"#"+B.val(),rel:B.val()}).text(B.text()).bind("click.sb",function(c){c&&
c.preventDefault&&c.preventDefault();c=t;var B=a(this);c.attr("id").split("_");r._changeSelectbox(b,B.attr("rel"),B.text());r._closeSelectbox(b)}).bind("mouseover.sb",function(){var b=a(this);b.parent().siblings().find("a").removeClass(u.settings.classFocus);b.addClass(u.settings.classFocus)}).bind("mouseout.sb",function(){a(this).removeClass(u.settings.classFocus)}),f&&c.addClass(u.settings.classSub),B.is(":selected")&&c.addClass(u.settings.classFocus)):(c=a("<span>",{text:B.text()}).addClass(u.settings.classDisabled),
f&&c.addClass(u.settings.classSub));c.appendTo(h);h.appendTo(w)})}if(this._getInst(b))return!1;var m=a(b),r=this,u=r._newInst(m),q,v,t,w,x=!1;m.find("optgroup");var A=m.find("option"),y=A.length;m.attr("sb",u.uid);a.extend(u.settings,r._defaults,c);r._state[u.uid]=!1;m.hide();q=a("<div>",{id:"sbHolder_"+u.uid,"class":u.settings.classHolder,tabindex:m.attr("tabindex")});v=a("<a>",{id:"sbSelector_"+u.uid,href:"#","class":u.settings.classSelector,click:function(c){c.preventDefault();g.apply(a(this),
[]);c=a(this).attr("id").split("_")[1];r._state[c]?r._closeSelectbox(b):r._openSelectbox(b)}});t=a("<a>",{id:"sbToggle_"+u.uid,href:"#","class":u.settings.classToggle,click:function(c){c.preventDefault();g.apply(a(this),[]);c=a(this).attr("id").split("_")[1];r._state[c]?r._closeSelectbox(b):r._openSelectbox(b)}});t.appendTo(q);w=a("<ul>",{id:"sbOptions_"+u.uid,"class":u.settings.classOptions,css:{display:"none"}});m.children().each(function(b){b=a(this);var c,d={};b.is("option")?h(b):b.is("optgroup")&&
(c=a("<li>"),a("<span>",{text:b.attr("label")}).addClass(u.settings.classGroup).appendTo(c),c.appendTo(w),b.is(":disabled")&&(d.disabled=!0),d.sub=!0,h(b.find("option"),d))});x||v.text(A.first().text());a.data(b,"selectbox",u);q.data("uid",u.uid).bind("keydown.sb",function(b){var c=b.charCode?b.charCode:b.keyCode?b.keyCode:0,d=a(this),f=d.data("uid"),e=d.siblings("select[sb='"+f+"']").data("selectbox"),g=d.siblings(["select[sb='",f,"']"].join("")).get(0),h=d.find("ul").find("a."+e.settings.classFocus);
switch(c){case 37:case 38:0<h.length&&(a("a",d).removeClass(e.settings.classFocus),c=h.parent().prevAll("li:has(a)").eq(0).find("a"),0<c.length&&(c.addClass(e.settings.classFocus).focus(),a("#sbSelector_"+f).text(c.text())));break;case 39:case 40:a("a",d).removeClass(e.settings.classFocus);c=0<h.length?h.parent().nextAll("li:has(a)").eq(0).find("a"):d.find("ul").find("a").eq(0);0<c.length&&(c.addClass(e.settings.classFocus).focus(),a("#sbSelector_"+f).text(c.text()));break;case 13:0<h.length&&r._changeSelectbox(g,
h.attr("rel"),h.text());r._closeSelectbox(g);break;case 9:if(g&&(e=r._getInst(g)))0<h.length&&r._changeSelectbox(g,h.attr("rel"),h.text()),r._closeSelectbox(g);f=parseInt(d.attr("tabindex"),10);b.shiftKey?f--:f++;a("*[tabindex='"+f+"']").focus();break;case 27:r._closeSelectbox(g)}b.stopPropagation();return!1}).delegate("a","mouseover",function(b){a(this).addClass(u.settings.classFocus)}).delegate("a","mouseout",function(b){a(this).removeClass(u.settings.classFocus)});v.appendTo(q);w.appendTo(q);q.insertAfter(m);
a("html").on("mousedown",function(b){b.stopPropagation();a("select").selectbox("close")});a([".",u.settings.classHolder,", .",u.settings.classSelector].join("")).mousedown(function(a){a.stopPropagation()})},_detachSelectbox:function(b){var c=this._getInst(b);if(!c)return!1;a("#sbHolder_"+c.uid).remove();a.data(b,"selectbox",null);a(b).show()},_changeSelectbox:function(b,c,g){var h,m=this._getInst(b);m&&(h=this._get(m,"onChange"),a("#sbSelector_"+m.uid).text(g));c=c.replace(/\'/g,"\\'");a(b).find("option[value='"+
c+"']").attr("selected",e);m&&h?h.apply(m.input?m.input[0]:null,[c,m]):m&&m.input&&m.input.trigger("change")},_enableSelectbox:function(b){var c=this._getInst(b);if(!c||!c.isDisabled)return!1;a("#sbHolder_"+c.uid).removeClass(c.settings.classHolderDisabled);c.isDisabled=!1;a.data(b,"selectbox",c)},_disableSelectbox:function(b){var c=this._getInst(b);if(!c||c.isDisabled)return!1;a("#sbHolder_"+c.uid).addClass(c.settings.classHolderDisabled);c.isDisabled=e;a.data(b,"selectbox",c)},_optionSelectbox:function(b,
c,e){var h=this._getInst(b);if(!h)return!1;h[c]=e;a.data(b,"selectbox",h)},_openSelectbox:function(b){var c=this._getInst(b);if(c&&!c.isOpen&&!c.isDisabled){var g=a("#sbOptions_"+c.uid),h=parseInt(a(window).height(),10),m=a("#sbHolder_"+c.uid).offset(),r=a(window).scrollTop(),u=g.prev().height(),h=h-(m.top-r)-u/2,m=this._get(c,"onOpen");g.css({top:u+"px",maxHeight:h-u+"px"});"fade"===c.settings.effect?g.fadeIn(c.settings.speed):g.slideDown(c.settings.speed);a("#sbToggle_"+c.uid).addClass(c.settings.classToggleOpen);
this._state[c.uid]=e;c.isOpen=e;m&&m.apply(c.input?c.input[0]:null,[c]);a.data(b,"selectbox",c)}},_closeSelectbox:function(b){var c=this._getInst(b);if(c&&c.isOpen){var e=this._get(c,"onClose");"fade"===c.settings.effect?a("#sbOptions_"+c.uid).fadeOut(c.settings.speed):a("#sbOptions_"+c.uid).slideUp(c.settings.speed);a("#sbToggle_"+c.uid).removeClass(c.settings.classToggleOpen);this._state[c.uid]=!1;c.isOpen=!1;e&&e.apply(c.input?c.input[0]:null,[c]);a.data(b,"selectbox",c)}},_newInst:function(a){return{id:a[0].id.replace(/([^A-Za-z0-9_-])/g,
"\\\\$1"),input:a,uid:Math.floor(99999999*Math.random()),isOpen:!1,isDisabled:!1,settings:{}}},_getInst:function(b){try{return a.data(b,"selectbox")}catch(c){throw"Missing instance data for this selectbox";}},_get:function(a,b){return a.settings[b]!==c?a.settings[b]:this._defaults[b]}});a.fn.selectbox=function(b){var c=Array.prototype.slice.call(arguments,1);return"string"==typeof b&&"isDisabled"==b||"option"==b&&2==arguments.length&&"string"==typeof arguments[1]?a.selectbox["_"+b+"Selectbox"].apply(a.selectbox,
[this[0]].concat(c)):this.each(function(){"string"==typeof b?a.selectbox["_"+b+"Selectbox"].apply(a.selectbox,[this].concat(c)):a.selectbox._attachSelectbox(this,b)})};a.selectbox=new b;a.selectbox.version="0.2"})(jQuery);this.Utils={};Utils.zeroPad=function(a,c){var b=c-a.toString().length+1;return Array(+(0<b&&b)).join("0")+a};Utils.dateTime=function(){var a=new Date;return a.getFullYear()+"-"+Utils.zeroPad(a.getMonth()+1,2)+"-"+Utils.zeroPad(a.getDate(),2)};
Utils.alert=function(a,c,b,e){$("#"+a).append($("<div class='alert-message alert-"+c+' fade in\' data-alert><a class="btn btn-rounded btn-icon-only btn-dark closer" data-dismiss="alert"> <i class="icon icon-ex-white-outline"></i></a><h4 class="alert-heading">'+b+"</h4> "+e+" </div>"))};Utils.htmlEncode=function(a){return $("<div/>").text(a).html()};Utils.htmlDecode=function(a){return $("<div/>").html(a).text()};Utils.replaceAll=function(a,c,b){return a.replace(RegExp(c,"g"),b)};
Utils.rgbToHex=function(a,c,b){if(255<a||255<c||255<b)throw"Invalid color component";return(a<<16|c<<8|b).toString(16)};Utils.formatFileSize=function(a){return"number"!==typeof a?"":1E9<=a?(a/1E9).toFixed(2)+" GB":1E6<=a?(a/1E6).toFixed(2)+" MB":(a/1E3).toFixed(2)+" KB"};Utils.formatDate=function(a){var c=void 0==a?new Date:new Date(a);a=Utils.zeroPad(c.getDate(),2);var b=Utils.zeroPad(c.getMonth()+1,2),c=c.getFullYear();return a+"/"+b+"/"+c};
Utils.generateGuid=function(){var a,c,b;a="";for(b=0;32>b;b++){if(8==b||12==b||16==b||20==b)a+="_";c=Math.floor(16*Math.random()).toString(16).toUpperCase();a+=c}return a};Utils.random=function(a){return Math.floor(Math.random()*a)+1};Utils.popup=function(a,c,b,e){return window.open(a,c,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+b+", height="+e+", top="+(screen.height/2-e/2)+", left="+(screen.width/2-b/2))};
Utils.toHtml=function(a,c){for(;-1!=a.indexOf("{");){var b=a.substring(a.indexOf("{"),a.indexOf("}")+1),e=eval(b);a=a.replace(b,e)}return a};Utils.isObject=function(a){return"[object Object]"===Object.prototype.toString.call(a)};Utils.editObjectInArray=function(a,c,b){Ember.ObjectProxy.create({content:a}).set(c,b)};Utils.styleThumbURL=function(a){return Utils.thumbURL(a,"style")};Utils.colorbarThumbURL=function(a){return Utils.thumbURL(a,"colorbar")};
Utils.thumbURL=function(a,c){if(void 0==a||null==a)return"";var b=a.substring(a.length-4).split(""),e="//maperial.com/thumbs"+c;b.forEach(function(a){e+="/"+a});return e+"/"+a+".png"};Utils.getSourceThumb=function(a){switch(a.source.type){case Source.MaperialOSM:return' src="'+Utils.styleThumbURL(a.params.styles[a.params.selectedStyle])+'"';case Source.Vector:case Source.Images:return' src="assets/images/icons/layer.'+a.source.params.src+'.png"';default:return' src="assets/images/icons/layer.raster.png"'}};
Utils.buildSliderStyle=function(a){$("#"+a+" a").css({color:"#000"});$("#"+a+" a").css({textDecoration:"none"});$("#"+a+" a").css({textAlign:"center"});$("#"+a+" a").css({width:"20px"});$("#"+a+" a").css({height:"20px"});$("#"+a+" a").css({borderTopLeftRadius:"30px"});$("#"+a+" a").css({borderTopRightRadius:"30px"});$("#"+a+" a").css({borderBottomLeftRadius:"30px"});$("#"+a+" a").css({borderBottomRightRadius:"30px"});$("#"+a+" a").css({outline:"none"})};
Utils.apply=function(a,c){return function(b,e,d,f,g,h){a[c](b,e,d,f,g,h)}};Utils.getPoint=function(a){var c=a.clientX-$(a.target).offset().left;a=a.clientY-$(a.target).offset().top;return new Point(c,a)};function odump(a){console.log($.parseJSON(JSON.stringify(a)))};(function(a,c){"object"===typeof exports?module.exports=c(global):"function"===typeof define&&define.amd?define([],function(){return c(a)}):c(a)})(this,function(a){function c(a){return d=a}function b(){return d="undefined"!==typeof Float32Array?Float32Array:Array}var e={};(function(){if("undefined"!=typeof Float32Array){var a=new Float32Array(1),b=new Int32Array(a.buffer);e.invsqrt=function(c){a[0]=c;b[0]=1597463007-(b[0]>>1);var d=a[0];return d*(1.5-0.5*c*d*d)}}else e.invsqrt=function(a){return 1/
Math.sqrt(a)}})();var d=null;b();var f={create:function(a){var b=new d(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):b[0]=b[1]=b[2]=0;return b},createFrom:function(a,b,c){var e=new d(3);e[0]=a;e[1]=b;e[2]=c;return e},set:function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];return b},equal:function(a,b){return a===b||1E-6>Math.abs(a[0]-b[0])&&1E-6>Math.abs(a[1]-b[1])&&1E-6>Math.abs(a[2]-b[2])},add:function(a,b,c){if(!c||a===c)return a[0]+=b[0],a[1]+=b[1],a[2]+=b[2],a;c[0]=a[0]+b[0];c[1]=a[1]+b[1];c[2]=a[2]+b[2];return c},
subtract:function(a,b,c){if(!c||a===c)return a[0]-=b[0],a[1]-=b[1],a[2]-=b[2],a;c[0]=a[0]-b[0];c[1]=a[1]-b[1];c[2]=a[2]-b[2];return c},multiply:function(a,b,c){if(!c||a===c)return a[0]*=b[0],a[1]*=b[1],a[2]*=b[2],a;c[0]=a[0]*b[0];c[1]=a[1]*b[1];c[2]=a[2]*b[2];return c},negate:function(a,b){b||(b=a);b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];return b},scale:function(a,b,c){if(!c||a===c)return a[0]*=b,a[1]*=b,a[2]*=b,a;c[0]=a[0]*b;c[1]=a[1]*b;c[2]=a[2]*b;return c},normalize:function(a,b){b||(b=a);var c=a[0],
d=a[1],e=a[2],f=Math.sqrt(c*c+d*d+e*e);if(!f)return b[0]=0,b[1]=0,b[2]=0,b;if(1===f)return b[0]=c,b[1]=d,b[2]=e,b;f=1/f;b[0]=c*f;b[1]=d*f;b[2]=e*f;return b},cross:function(a,b,c){c||(c=a);var d=a[0],e=a[1];a=a[2];var f=b[0],g=b[1];b=b[2];c[0]=e*b-a*g;c[1]=a*f-d*b;c[2]=d*g-e*f;return c},length:function(a){var b=a[0],c=a[1];a=a[2];return Math.sqrt(b*b+c*c+a*a)},squaredLength:function(a){var b=a[0],c=a[1];a=a[2];return b*b+c*c+a*a},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},direction:function(a,
b,c){c||(c=a);var d=a[0]-b[0],e=a[1]-b[1];a=a[2]-b[2];b=Math.sqrt(d*d+e*e+a*a);if(!b)return c[0]=0,c[1]=0,c[2]=0,c;b=1/b;c[0]=d*b;c[1]=e*b;c[2]=a*b;return c},lerp:function(a,b,c,d){d||(d=a);d[0]=a[0]+c*(b[0]-a[0]);d[1]=a[1]+c*(b[1]-a[1]);d[2]=a[2]+c*(b[2]-a[2]);return d},dist:function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2];return Math.sqrt(c*c+d*d+e*e)}},g=null,h=new d(4);f.unproject=function(a,b,c,d,e){e||(e=a);g||(g=t.create());var f=g;h[0]=2*(a[0]-d[0])/d[2]-1;h[1]=2*(a[1]-d[1])/d[3]-1;h[2]=
2*a[2]-1;h[3]=1;t.multiply(c,b,f);if(!t.inverse(f))return null;t.multiplyVec4(f,h);if(0===h[3])return null;e[0]=h[0]/h[3];e[1]=h[1]/h[3];e[2]=h[2]/h[3];return e};var m=f.createFrom(1,0,0),r=f.createFrom(0,1,0),u=f.createFrom(0,0,1),q=f.create();f.rotationTo=function(a,b,c){c||(c=w.create());var d=f.dot(a,b);if(1<=d)w.set(x,c);else if(-0.999999>d)f.cross(m,a,q),1E-6>f.length(q)&&f.cross(r,a,q),1E-6>f.length(q)&&f.cross(u,a,q),f.normalize(q),w.fromAngleAxis(Math.PI,q,c);else{var d=Math.sqrt(2*(1+d)),
e=1/d;f.cross(a,b,q);c[0]=q[0]*e;c[1]=q[1]*e;c[2]=q[2]*e;c[3]=0.5*d;w.normalize(c)}1<c[3]?c[3]=1:-1>c[3]&&(c[3]=-1);return c};f.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+"]"};var v={create:function(a){var b=new d(9);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8]):b[0]=b[1]=b[2]=b[3]=b[4]=b[5]=b[6]=b[7]=b[8]=0;return b},createFrom:function(a,b,c,e,f,g,h,m,t){var v=new d(9);v[0]=a;v[1]=b;v[2]=c;v[3]=e;v[4]=f;v[5]=g;v[6]=h;v[7]=m;v[8]=t;return v},
determinant:function(a){var b=a[3],c=a[4],d=a[5],e=a[6],f=a[7],g=a[8];return a[0]*(g*c-d*f)+a[1]*(-g*b+d*e)+a[2]*(f*b-c*e)},inverse:function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],m=a[6],t=a[7],q=a[8],r=q*g-h*t,u=-q*f+h*m,w=t*f-g*m,y=c*r+d*u+e*w;if(!y)return null;y=1/y;b||(b=v.create());b[0]=r*y;b[1]=(-q*d+e*t)*y;b[2]=(h*d-e*g)*y;b[3]=u*y;b[4]=(q*c-e*m)*y;b[5]=(-h*c+e*f)*y;b[6]=w*y;b[7]=(-t*c+d*m)*y;b[8]=(g*c-d*f)*y;return b},multiply:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],
g=a[3],h=a[4],m=a[5],t=a[6],v=a[7];a=a[8];var q=b[0],r=b[1],u=b[2],w=b[3],y=b[4],A=b[5],x=b[6],G=b[7];b=b[8];c[0]=q*d+r*g+u*t;c[1]=q*e+r*h+u*v;c[2]=q*f+r*m+u*a;c[3]=w*d+y*g+A*t;c[4]=w*e+y*h+A*v;c[5]=w*f+y*m+A*a;c[6]=x*d+G*g+b*t;c[7]=x*e+G*h+b*v;c[8]=x*f+G*m+b*a;return c},multiplyVec2:function(a,b,c){c||(c=b);var d=b[0];b=b[1];c[0]=d*a[0]+b*a[3]+a[6];c[1]=d*a[1]+b*a[4]+a[7];return c},multiplyVec3:function(a,b,c){c||(c=b);var d=b[0],e=b[1];b=b[2];c[0]=d*a[0]+e*a[3]+b*a[6];c[1]=d*a[1]+e*a[4]+b*a[7];
c[2]=d*a[2]+e*a[5]+b*a[8];return c},set:function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return b},equal:function(a,b){return a===b||1E-6>Math.abs(a[0]-b[0])&&1E-6>Math.abs(a[1]-b[1])&&1E-6>Math.abs(a[2]-b[2])&&1E-6>Math.abs(a[3]-b[3])&&1E-6>Math.abs(a[4]-b[4])&&1E-6>Math.abs(a[5]-b[5])&&1E-6>Math.abs(a[6]-b[6])&&1E-6>Math.abs(a[7]-b[7])&&1E-6>Math.abs(a[8]-b[8])},identity:function(a){a||(a=v.create());a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=1;a[5]=
0;a[6]=0;a[7]=0;a[8]=1;return a},transpose:function(a,b){if(!b||a===b){var c=a[1],d=a[2],e=a[5];a[1]=a[3];a[2]=a[6];a[3]=c;a[5]=a[7];a[6]=d;a[7]=e;return a}b[0]=a[0];b[1]=a[3];b[2]=a[6];b[3]=a[1];b[4]=a[4];b[5]=a[7];b[6]=a[2];b[7]=a[5];b[8]=a[8];return b},toMat4:function(a,b){b||(b=t.create());b[15]=1;b[14]=0;b[13]=0;b[12]=0;b[11]=0;b[10]=a[8];b[9]=a[7];b[8]=a[6];b[7]=0;b[6]=a[5];b[5]=a[4];b[4]=a[3];b[3]=0;b[2]=a[2];b[1]=a[1];b[0]=a[0];return b},str:function(a){return"["+a[0]+", "+a[1]+", "+a[2]+
", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+"]"}},t={create:function(a){var b=new d(16);a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15]);return b},createFrom:function(a,b,c,e,f,g,h,m,t,v,q,r,u,w,y,A){var x=new d(16);x[0]=a;x[1]=b;x[2]=c;x[3]=e;x[4]=f;x[5]=g;x[6]=h;x[7]=m;x[8]=t;x[9]=v;x[10]=q;x[11]=r;x[12]=u;x[13]=w;x[14]=y;x[15]=A;return x},set:function(a,
b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return b},equal:function(a,b){return a===b||1E-6>Math.abs(a[0]-b[0])&&1E-6>Math.abs(a[1]-b[1])&&1E-6>Math.abs(a[2]-b[2])&&1E-6>Math.abs(a[3]-b[3])&&1E-6>Math.abs(a[4]-b[4])&&1E-6>Math.abs(a[5]-b[5])&&1E-6>Math.abs(a[6]-b[6])&&1E-6>Math.abs(a[7]-b[7])&&1E-6>Math.abs(a[8]-b[8])&&1E-6>Math.abs(a[9]-b[9])&&1E-6>Math.abs(a[10]-b[10])&&
1E-6>Math.abs(a[11]-b[11])&&1E-6>Math.abs(a[12]-b[12])&&1E-6>Math.abs(a[13]-b[13])&&1E-6>Math.abs(a[14]-b[14])&&1E-6>Math.abs(a[15]-b[15])},identity:function(a){a||(a=t.create());a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},transpose:function(a,b){if(!b||a===b){var c=a[1],d=a[2],e=a[3],f=a[6],g=a[7],h=a[11];a[1]=a[4];a[2]=a[8];a[3]=a[12];a[4]=c;a[6]=a[9];a[7]=a[13];a[8]=d;a[9]=f;a[11]=a[14];a[12]=e;a[13]=g;a[14]=h;
return a}b[0]=a[0];b[1]=a[4];b[2]=a[8];b[3]=a[12];b[4]=a[1];b[5]=a[5];b[6]=a[9];b[7]=a[13];b[8]=a[2];b[9]=a[6];b[10]=a[10];b[11]=a[14];b[12]=a[3];b[13]=a[7];b[14]=a[11];b[15]=a[15];return b},determinant:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],m=a[7],t=a[8],v=a[9],q=a[10],r=a[11],u=a[12],w=a[13],y=a[14];a=a[15];return u*v*h*e-t*w*h*e-u*g*q*e+f*w*q*e+t*g*y*e-f*v*y*e-u*v*d*m+t*w*d*m+u*c*q*m-b*w*q*m-t*c*y*m+b*v*y*m+u*g*d*r-f*w*d*r-u*c*h*r+b*w*h*r+f*c*y*r-b*g*y*r-t*g*d*a+f*v*d*
a+t*c*h*a-b*v*h*a-f*c*q*a+b*g*q*a},inverse:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],m=a[6],t=a[7],v=a[8],q=a[9],r=a[10],u=a[11],w=a[12],y=a[13],x=a[14],A=a[15],G=c*h-d*g,K=c*m-e*g,C=c*t-f*g,H=d*m-e*h,T=d*t-f*h,U=e*t-f*m,V=v*y-q*w,W=v*x-r*w,X=v*A-u*w,ca=q*x-r*y,da=q*A-u*y,ea=r*A-u*x,P=G*ea-K*da+C*ca+H*X-T*W+U*V;if(!P)return null;P=1/P;b[0]=(h*ea-m*da+t*ca)*P;b[1]=(-d*ea+e*da-f*ca)*P;b[2]=(y*U-x*T+A*H)*P;b[3]=(-q*U+r*T-u*H)*P;b[4]=(-g*ea+m*X-t*W)*P;b[5]=(c*ea-e*X+f*W)*P;
b[6]=(-w*U+x*C-A*K)*P;b[7]=(v*U-r*C+u*K)*P;b[8]=(g*da-h*X+t*V)*P;b[9]=(-c*da+d*X-f*V)*P;b[10]=(w*T-y*C+A*G)*P;b[11]=(-v*T+q*C-u*G)*P;b[12]=(-g*ca+h*W-m*V)*P;b[13]=(c*ca-d*W+e*V)*P;b[14]=(-w*H+y*K-x*G)*P;b[15]=(v*H-q*K+r*G)*P;return b},toRotationMat:function(a,b){b||(b=t.create());b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b},toMat3:function(a,b){b||(b=v.create());b[0]=a[0];b[1]=
a[1];b[2]=a[2];b[3]=a[4];b[4]=a[5];b[5]=a[6];b[6]=a[8];b[7]=a[9];b[8]=a[10];return b},toInverseMat3:function(a,b){var c=a[0],d=a[1],e=a[2],f=a[4],g=a[5],h=a[6],m=a[8],t=a[9],q=a[10],r=q*g-h*t,u=-q*f+h*m,w=t*f-g*m,y=c*r+d*u+e*w;if(!y)return null;y=1/y;b||(b=v.create());b[0]=r*y;b[1]=(-q*d+e*t)*y;b[2]=(h*d-e*g)*y;b[3]=u*y;b[4]=(q*c-e*m)*y;b[5]=(-h*c+e*f)*y;b[6]=w*y;b[7]=(-t*c+d*m)*y;b[8]=(g*c-d*f)*y;return b},multiply:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],m=a[5],t=a[6],v=a[7],
q=a[8],r=a[9],u=a[10],w=a[11],y=a[12],x=a[13],A=a[14];a=a[15];var G=b[0],K=b[1],C=b[2],H=b[3];c[0]=G*d+K*h+C*q+H*y;c[1]=G*e+K*m+C*r+H*x;c[2]=G*f+K*t+C*u+H*A;c[3]=G*g+K*v+C*w+H*a;G=b[4];K=b[5];C=b[6];H=b[7];c[4]=G*d+K*h+C*q+H*y;c[5]=G*e+K*m+C*r+H*x;c[6]=G*f+K*t+C*u+H*A;c[7]=G*g+K*v+C*w+H*a;G=b[8];K=b[9];C=b[10];H=b[11];c[8]=G*d+K*h+C*q+H*y;c[9]=G*e+K*m+C*r+H*x;c[10]=G*f+K*t+C*u+H*A;c[11]=G*g+K*v+C*w+H*a;G=b[12];K=b[13];C=b[14];H=b[15];c[12]=G*d+K*h+C*q+H*y;c[13]=G*e+K*m+C*r+H*x;c[14]=G*f+K*t+C*u+H*
A;c[15]=G*g+K*v+C*w+H*a;return c},multiplyVec3:function(a,b,c){c||(c=b);var d=b[0],e=b[1];b=b[2];c[0]=a[0]*d+a[4]*e+a[8]*b+a[12];c[1]=a[1]*d+a[5]*e+a[9]*b+a[13];c[2]=a[2]*d+a[6]*e+a[10]*b+a[14];return c},multiplyVec4:function(a,b,c){c||(c=b);var d=b[0],e=b[1],f=b[2];b=b[3];c[0]=a[0]*d+a[4]*e+a[8]*f+a[12]*b;c[1]=a[1]*d+a[5]*e+a[9]*f+a[13]*b;c[2]=a[2]*d+a[6]*e+a[10]*f+a[14]*b;c[3]=a[3]*d+a[7]*e+a[11]*f+a[15]*b;return c},translate:function(a,b,c){var d=b[0],e=b[1];b=b[2];var f,g,h,m,t,v,q,r,u,w,y,x;
if(!c||a===c)return a[12]=a[0]*d+a[4]*e+a[8]*b+a[12],a[13]=a[1]*d+a[5]*e+a[9]*b+a[13],a[14]=a[2]*d+a[6]*e+a[10]*b+a[14],a[15]=a[3]*d+a[7]*e+a[11]*b+a[15],a;f=a[0];g=a[1];h=a[2];m=a[3];t=a[4];v=a[5];q=a[6];r=a[7];u=a[8];w=a[9];y=a[10];x=a[11];c[0]=f;c[1]=g;c[2]=h;c[3]=m;c[4]=t;c[5]=v;c[6]=q;c[7]=r;c[8]=u;c[9]=w;c[10]=y;c[11]=x;c[12]=f*d+t*e+u*b+a[12];c[13]=g*d+v*e+w*b+a[13];c[14]=h*d+q*e+y*b+a[14];c[15]=m*d+r*e+x*b+a[15];return c},scale:function(a,b,c){var d=b[0],e=b[1];b=b[2];if(!c||a===c)return a[0]*=
d,a[1]*=d,a[2]*=d,a[3]*=d,a[4]*=e,a[5]*=e,a[6]*=e,a[7]*=e,a[8]*=b,a[9]*=b,a[10]*=b,a[11]*=b,a;c[0]=a[0]*d;c[1]=a[1]*d;c[2]=a[2]*d;c[3]=a[3]*d;c[4]=a[4]*e;c[5]=a[5]*e;c[6]=a[6]*e;c[7]=a[7]*e;c[8]=a[8]*b;c[9]=a[9]*b;c[10]=a[10]*b;c[11]=a[11]*b;c[12]=a[12];c[13]=a[13];c[14]=a[14];c[15]=a[15];return c},rotate:function(a,b,c,d){var e=c[0],f=c[1];c=c[2];var g=Math.sqrt(e*e+f*f+c*c),h,m,t,v,q,r,u,w,y,x,A,G,C,ba,H,T,U,V,W,X;if(!g)return null;1!==g&&(g=1/g,e*=g,f*=g,c*=g);h=Math.sin(b);m=Math.cos(b);t=1-m;
b=a[0];g=a[1];v=a[2];q=a[3];r=a[4];u=a[5];w=a[6];y=a[7];x=a[8];A=a[9];G=a[10];C=a[11];ba=e*e*t+m;H=f*e*t+c*h;T=c*e*t-f*h;U=e*f*t-c*h;V=f*f*t+m;W=c*f*t+e*h;X=e*c*t+f*h;e=f*c*t-e*h;f=c*c*t+m;d?a!==d&&(d[12]=a[12],d[13]=a[13],d[14]=a[14],d[15]=a[15]):d=a;d[0]=b*ba+r*H+x*T;d[1]=g*ba+u*H+A*T;d[2]=v*ba+w*H+G*T;d[3]=q*ba+y*H+C*T;d[4]=b*U+r*V+x*W;d[5]=g*U+u*V+A*W;d[6]=v*U+w*V+G*W;d[7]=q*U+y*V+C*W;d[8]=b*X+r*e+x*f;d[9]=g*X+u*e+A*f;d[10]=v*X+w*e+G*f;d[11]=q*X+y*e+C*f;return d},rotateX:function(a,b,c){var d=
Math.sin(b);b=Math.cos(b);var e=a[4],f=a[5],g=a[6],h=a[7],m=a[8],t=a[9],v=a[10],q=a[11];c?a!==c&&(c[0]=a[0],c[1]=a[1],c[2]=a[2],c[3]=a[3],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a;c[4]=e*b+m*d;c[5]=f*b+t*d;c[6]=g*b+v*d;c[7]=h*b+q*d;c[8]=e*-d+m*b;c[9]=f*-d+t*b;c[10]=g*-d+v*b;c[11]=h*-d+q*b;return c},rotateY:function(a,b,c){var d=Math.sin(b);b=Math.cos(b);var e=a[0],f=a[1],g=a[2],h=a[3],m=a[8],t=a[9],v=a[10],q=a[11];c?a!==c&&(c[4]=a[4],c[5]=a[5],c[6]=a[6],c[7]=a[7],c[12]=a[12],c[13]=a[13],
c[14]=a[14],c[15]=a[15]):c=a;c[0]=e*b+m*-d;c[1]=f*b+t*-d;c[2]=g*b+v*-d;c[3]=h*b+q*-d;c[8]=e*d+m*b;c[9]=f*d+t*b;c[10]=g*d+v*b;c[11]=h*d+q*b;return c},rotateZ:function(a,b,c){var d=Math.sin(b);b=Math.cos(b);var e=a[0],f=a[1],g=a[2],h=a[3],m=a[4],t=a[5],v=a[6],q=a[7];c?a!==c&&(c[8]=a[8],c[9]=a[9],c[10]=a[10],c[11]=a[11],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a;c[0]=e*b+m*d;c[1]=f*b+t*d;c[2]=g*b+v*d;c[3]=h*b+q*d;c[4]=e*-d+m*b;c[5]=f*-d+t*b;c[6]=g*-d+v*b;c[7]=h*-d+q*b;return c},frustum:function(a,
b,c,d,e,f,g){g||(g=t.create());var h=b-a,m=d-c,v=f-e;g[0]=2*e/h;g[1]=0;g[2]=0;g[3]=0;g[4]=0;g[5]=2*e/m;g[6]=0;g[7]=0;g[8]=(b+a)/h;g[9]=(d+c)/m;g[10]=-(f+e)/v;g[11]=-1;g[12]=0;g[13]=0;g[14]=-(2*f*e)/v;g[15]=0;return g},perspective:function(a,b,c,d,e){a=c*Math.tan(a*Math.PI/360);b*=a;return t.frustum(-b,b,-a,a,c,d,e)},ortho:function(a,b,c,d,e,f,g){g||(g=t.create());var h=b-a,m=d-c,v=f-e;g[0]=2/h;g[1]=0;g[2]=0;g[3]=0;g[4]=0;g[5]=2/m;g[6]=0;g[7]=0;g[8]=0;g[9]=0;g[10]=-2/v;g[11]=0;g[12]=-(a+b)/h;g[13]=
-(d+c)/m;g[14]=-(f+e)/v;g[15]=1;return g},lookAt:function(a,b,c,d){d||(d=t.create());var e,f,g,h,m,v,q,r,u=a[0],w=a[1];a=a[2];g=c[0];h=c[1];f=c[2];q=b[0];c=b[1];e=b[2];if(u===q&&w===c&&a===e)return t.identity(d);b=u-q;c=w-c;q=a-e;r=1/Math.sqrt(b*b+c*c+q*q);b*=r;c*=r;q*=r;e=h*q-f*c;f=f*b-g*q;g=g*c-h*b;(r=Math.sqrt(e*e+f*f+g*g))?(r=1/r,e*=r,f*=r,g*=r):g=f=e=0;h=c*g-q*f;m=q*e-b*g;v=b*f-c*e;(r=Math.sqrt(h*h+m*m+v*v))?(r=1/r,h*=r,m*=r,v*=r):v=m=h=0;d[0]=e;d[1]=h;d[2]=b;d[3]=0;d[4]=f;d[5]=m;d[6]=c;d[7]=
0;d[8]=g;d[9]=v;d[10]=q;d[11]=0;d[12]=-(e*u+f*w+g*a);d[13]=-(h*u+m*w+v*a);d[14]=-(b*u+c*w+q*a);d[15]=1;return d},fromRotationTranslation:function(a,b,c){c||(c=t.create());var d=a[0],e=a[1],f=a[2],g=a[3],h=d+d,m=e+e,v=f+f;a=d*h;var q=d*m,d=d*v,r=e*m,e=e*v,f=f*v,h=g*h,m=g*m,g=g*v;c[0]=1-(r+f);c[1]=q+g;c[2]=d-m;c[3]=0;c[4]=q-g;c[5]=1-(a+f);c[6]=e+h;c[7]=0;c[8]=d+m;c[9]=e-h;c[10]=1-(a+r);c[11]=0;c[12]=b[0];c[13]=b[1];c[14]=b[2];c[15]=1;return c},str:function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+
a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+"]"}},w={create:function(a){var b=new d(4);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]):b[0]=b[1]=b[2]=b[3]=0;return b},createFrom:function(a,b,c,e){var f=new d(4);f[0]=a;f[1]=b;f[2]=c;f[3]=e;return f},set:function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return b},equal:function(a,b){return a===b||1E-6>Math.abs(a[0]-b[0])&&1E-6>Math.abs(a[1]-b[1])&&1E-6>Math.abs(a[2]-
b[2])&&1E-6>Math.abs(a[3]-b[3])},identity:function(a){a||(a=w.create());a[0]=0;a[1]=0;a[2]=0;a[3]=1;return a}},x=w.identity();w.calculateW=function(a,b){var c=a[0],d=a[1],e=a[2];if(!b||a===b)return a[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e)),a;b[0]=c;b[1]=d;b[2]=e;b[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e));return b};w.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]};w.inverse=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],c=(c=c*c+d*d+e*e+f*f)?1/c:0;if(!b||a===b)return a[0]*=-c,a[1]*=-c,
a[2]*=-c,a[3]*=c,a;b[0]=-a[0]*c;b[1]=-a[1]*c;b[2]=-a[2]*c;b[3]=a[3]*c;return b};w.conjugate=function(a,b){if(!b||a===b)return a[0]*=-1,a[1]*=-1,a[2]*=-1,a;b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];b[3]=a[3];return b};w.length=function(a){var b=a[0],c=a[1],d=a[2];a=a[3];return Math.sqrt(b*b+c*c+d*d+a*a)};w.normalize=function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=a[3],g=Math.sqrt(c*c+d*d+e*e+f*f);if(0===g)return b[0]=0,b[1]=0,b[2]=0,b[3]=0,b;g=1/g;b[0]=c*g;b[1]=d*g;b[2]=e*g;b[3]=f*g;return b};w.add=function(a,
b,c){if(!c||a===c)return a[0]+=b[0],a[1]+=b[1],a[2]+=b[2],a[3]+=b[3],a;c[0]=a[0]+b[0];c[1]=a[1]+b[1];c[2]=a[2]+b[2];c[3]=a[3]+b[3];return c};w.multiply=function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2];a=a[3];var g=b[0],h=b[1],m=b[2];b=b[3];c[0]=d*b+a*g+e*m-f*h;c[1]=e*b+a*h+f*g-d*m;c[2]=f*b+a*m+d*h-e*g;c[3]=a*b-d*g-e*h-f*m;return c};w.multiplyVec3=function(a,b,c){c||(c=b);var d=b[0],e=b[1],f=b[2];b=a[0];var g=a[1],h=a[2];a=a[3];var m=a*d+g*f-h*e,t=a*e+h*d-b*f,v=a*f+b*e-g*d,d=-b*d-g*e-h*f;c[0]=m*a+
d*-b+t*-h-v*-g;c[1]=t*a+d*-g+v*-b-m*-h;c[2]=v*a+d*-h+m*-g-t*-b;return c};w.scale=function(a,b,c){if(!c||a===c)return a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b,a;c[0]=a[0]*b;c[1]=a[1]*b;c[2]=a[2]*b;c[3]=a[3]*b;return c};w.toMat3=function(a,b){b||(b=v.create());var c=a[0],d=a[1],e=a[2],f=a[3],g=c+c,h=d+d,m=e+e,t=c*g,q=c*h,c=c*m,r=d*h,d=d*m,e=e*m,g=f*g,h=f*h,f=f*m;b[0]=1-(r+e);b[1]=q+f;b[2]=c-h;b[3]=q-f;b[4]=1-(t+e);b[5]=d+g;b[6]=c+h;b[7]=d-g;b[8]=1-(t+r);return b};w.toMat4=function(a,b){b||(b=t.create());var c=
a[0],d=a[1],e=a[2],f=a[3],g=c+c,h=d+d,m=e+e,v=c*g,q=c*h,c=c*m,r=d*h,d=d*m,e=e*m,g=f*g,h=f*h,f=f*m;b[0]=1-(r+e);b[1]=q+f;b[2]=c-h;b[3]=0;b[4]=q-f;b[5]=1-(v+e);b[6]=d+g;b[7]=0;b[8]=c+h;b[9]=d-g;b[10]=1-(v+r);b[11]=0;b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b};w.slerp=function(a,b,c,d){d||(d=a);var e=a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3],f,g;if(1<=Math.abs(e))return d!==a&&(d[0]=a[0],d[1]=a[1],d[2]=a[2],d[3]=a[3]),d;f=Math.acos(e);g=Math.sqrt(1-e*e);if(0.0010>Math.abs(g))return d[0]=0.5*a[0]+0.5*b[0],
d[1]=0.5*a[1]+0.5*b[1],d[2]=0.5*a[2]+0.5*b[2],d[3]=0.5*a[3]+0.5*b[3],d;e=Math.sin((1-c)*f)/g;c=Math.sin(c*f)/g;d[0]=a[0]*e+b[0]*c;d[1]=a[1]*e+b[1]*c;d[2]=a[2]*e+b[2]*c;d[3]=a[3]*e+b[3]*c;return d};w.fromRotationMatrix=function(a,b){b||(b=w.create());var c=a[0]+a[4]+a[8],d;if(0<c)d=Math.sqrt(c+1),b[3]=0.5*d,d=0.5/d,b[0]=(a[7]-a[5])*d,b[1]=(a[2]-a[6])*d,b[2]=(a[3]-a[1])*d;else{d=w.fromRotationMatrix.s_iNext=w.fromRotationMatrix.s_iNext||[1,2,0];c=0;a[4]>a[0]&&(c=1);a[8]>a[3*c+c]&&(c=2);var e=d[c],f=
d[e];d=Math.sqrt(a[3*c+c]-a[3*e+e]-a[3*f+f]+1);b[c]=0.5*d;d=0.5/d;b[3]=(a[3*f+e]-a[3*e+f])*d;b[e]=(a[3*e+c]+a[3*c+e])*d;b[f]=(a[3*f+c]+a[3*c+f])*d}return b};v.toQuat4=w.fromRotationMatrix;(function(){var a=v.create();w.fromAxes=function(b,c,d,e){a[0]=c[0];a[3]=c[1];a[6]=c[2];a[1]=d[0];a[4]=d[1];a[7]=d[2];a[2]=b[0];a[5]=b[1];a[8]=b[2];return w.fromRotationMatrix(a,e)}})();w.identity=function(a){a||(a=w.create());a[0]=0;a[1]=0;a[2]=0;a[3]=1;return a};w.fromAngleAxis=function(a,b,c){c||(c=w.create());
a*=0.5;var d=Math.sin(a);c[3]=Math.cos(a);c[0]=d*b[0];c[1]=d*b[1];c[2]=d*b[2];return c};w.toAngleAxis=function(a,b){b||(b=a);var c=a[0]*a[0]+a[1]*a[1]+a[2]*a[2];0<c?(b[3]=2*Math.acos(a[3]),c=e.invsqrt(c),b[0]=a[0]*c,b[1]=a[1]*c,b[2]=a[2]*c):(b[3]=0,b[0]=1,b[1]=0,b[2]=0);return b};w.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"};var A={create:function(a){var b=new d(2);a?(b[0]=a[0],b[1]=a[1]):(b[0]=0,b[1]=0);return b},createFrom:function(a,b){var c=new d(2);c[0]=a;c[1]=b;return c},
add:function(a,b,c){c||(c=b);c[0]=a[0]+b[0];c[1]=a[1]+b[1];return c},subtract:function(a,b,c){c||(c=b);c[0]=a[0]-b[0];c[1]=a[1]-b[1];return c},multiply:function(a,b,c){c||(c=b);c[0]=a[0]*b[0];c[1]=a[1]*b[1];return c},divide:function(a,b,c){c||(c=b);c[0]=a[0]/b[0];c[1]=a[1]/b[1];return c},scale:function(a,b,c){c||(c=a);c[0]=a[0]*b;c[1]=a[1]*b;return c},dist:function(a,b){var c=b[0]-a[0],d=b[1]-a[1];return Math.sqrt(c*c+d*d)},set:function(a,b){b[0]=a[0];b[1]=a[1];return b},equal:function(a,b){return a===
b||1E-6>Math.abs(a[0]-b[0])&&1E-6>Math.abs(a[1]-b[1])},negate:function(a,b){b||(b=a);b[0]=-a[0];b[1]=-a[1];return b},normalize:function(a,b){b||(b=a);var c=a[0]*a[0]+a[1]*a[1];0<c?(c=Math.sqrt(c),b[0]=a[0]/c,b[1]=a[1]/c):b[0]=b[1]=0;return b},cross:function(a,b,c){a=a[0]*b[1]-a[1]*b[0];if(!c)return a;c[0]=c[1]=0;c[2]=a;return c},length:function(a){var b=a[0];a=a[1];return Math.sqrt(b*b+a*a)},squaredLength:function(a){var b=a[0];a=a[1];return b*b+a*a},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]},
direction:function(a,b,c){c||(c=a);var d=a[0]-b[0];a=a[1]-b[1];b=d*d+a*a;if(!b)return c[0]=0,c[1]=0,c[2]=0,c;b=1/Math.sqrt(b);c[0]=d*b;c[1]=a*b;return c},lerp:function(a,b,c,d){d||(d=a);d[0]=a[0]+c*(b[0]-a[0]);d[1]=a[1]+c*(b[1]-a[1]);return d},str:function(a){return"["+a[0]+", "+a[1]+"]"}},y={create:function(a){var b=new d(4);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]):b[0]=b[1]=b[2]=b[3]=0;return b},createFrom:function(a,b,c,e){var f=new d(4);f[0]=a;f[1]=b;f[2]=c;f[3]=e;return f},set:function(a,
b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return b},equal:function(a,b){return a===b||1E-6>Math.abs(a[0]-b[0])&&1E-6>Math.abs(a[1]-b[1])&&1E-6>Math.abs(a[2]-b[2])&&1E-6>Math.abs(a[3]-b[3])},identity:function(a){a||(a=y.create());a[0]=1;a[1]=0;a[2]=0;a[3]=1;return a},transpose:function(a,b){if(!b||a===b){var c=a[1];a[1]=a[2];a[2]=c;return a}b[0]=a[0];b[1]=a[2];b[2]=a[1];b[3]=a[3];return b},determinant:function(a){return a[0]*a[3]-a[2]*a[1]},inverse:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],
f=a[3],g=c*f-e*d;if(!g)return null;g=1/g;b[0]=f*g;b[1]=-d*g;b[2]=-e*g;b[3]=c*g;return b},multiply:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2];a=a[3];c[0]=d*b[0]+e*b[2];c[1]=d*b[1]+e*b[3];c[2]=f*b[0]+a*b[2];c[3]=f*b[1]+a*b[3];return c},rotate:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2];a=a[3];var g=Math.sin(b);b=Math.cos(b);c[0]=d*b+e*g;c[1]=d*-g+e*b;c[2]=f*b+a*g;c[3]=f*-g+a*b;return c},multiplyVec2:function(a,b,c){c||(c=b);var d=b[0];b=b[1];c[0]=d*a[0]+b*a[1];c[1]=d*a[2]+b*a[3];return c},
scale:function(a,b,c){c||(c=a);var d=a[1],e=a[2],f=a[3],g=b[0];b=b[1];c[0]=a[0]*g;c[1]=d*b;c[2]=e*g;c[3]=f*b;return c},str:function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"}},C={create:function(a){var b=new d(4);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]):(b[0]=0,b[1]=0,b[2]=0,b[3]=0);return b},createFrom:function(a,b,c,e){var f=new d(4);f[0]=a;f[1]=b;f[2]=c;f[3]=e;return f},add:function(a,b,c){c||(c=b);c[0]=a[0]+b[0];c[1]=a[1]+b[1];c[2]=a[2]+b[2];c[3]=a[3]+b[3];return c},subtract:function(a,
b,c){c||(c=b);c[0]=a[0]-b[0];c[1]=a[1]-b[1];c[2]=a[2]-b[2];c[3]=a[3]-b[3];return c},multiply:function(a,b,c){c||(c=b);c[0]=a[0]*b[0];c[1]=a[1]*b[1];c[2]=a[2]*b[2];c[3]=a[3]*b[3];return c},divide:function(a,b,c){c||(c=b);c[0]=a[0]/b[0];c[1]=a[1]/b[1];c[2]=a[2]/b[2];c[3]=a[3]/b[3];return c},scale:function(a,b,c){c||(c=a);c[0]=a[0]*b;c[1]=a[1]*b;c[2]=a[2]*b;c[3]=a[3]*b;return c},set:function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return b},equal:function(a,b){return a===b||1E-6>Math.abs(a[0]-b[0])&&
1E-6>Math.abs(a[1]-b[1])&&1E-6>Math.abs(a[2]-b[2])&&1E-6>Math.abs(a[3]-b[3])},negate:function(a,b){b||(b=a);b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];b[3]=-a[3];return b},length:function(a){var b=a[0],c=a[1],d=a[2];a=a[3];return Math.sqrt(b*b+c*c+d*d+a*a)},squaredLength:function(a){var b=a[0],c=a[1],d=a[2];a=a[3];return b*b+c*c+d*d+a*a},lerp:function(a,b,c,d){d||(d=a);d[0]=a[0]+c*(b[0]-a[0]);d[1]=a[1]+c*(b[1]-a[1]);d[2]=a[2]+c*(b[2]-a[2]);d[3]=a[3]+c*(b[3]-a[3]);return d},str:function(a){return"["+a[0]+", "+
a[1]+", "+a[2]+", "+a[3]+"]"}};a&&(a.glMatrixArrayType=d,a.MatrixArray=d,a.setMatrixArrayType=c,a.determineMatrixArrayType=b,a.glMath=e,a.vec2=A,a.vec3=f,a.vec4=C,a.mat2=y,a.mat3=v,a.mat4=t,a.quat4=w);return{glMatrixArrayType:d,MatrixArray:d,setMatrixArrayType:c,determineMatrixArrayType:b,glMath:e,vec2:A,vec3:f,vec4:C,mat2:y,mat3:v,mat4:t,quat4:w}});function Point(a,c){this.x=a;this.y=c}function CoordinateSystem(a){this.tileSize=a;this.initialResolution=12756274*Math.PI/a;this.originShift=12756274*Math.PI/2}CoordinateSystem.prototype.LatLonToMeters=function(a,c){mx=c*this.originShift/180;my=Math.log(Math.tan((90+a)*Math.PI/360))/(Math.PI/180);my=my*this.originShift/180;return new Point(mx,my)};
CoordinateSystem.prototype.MetersToLatLon=function(a,c){lon=180*(a/this.originShift);lat=180*(c/this.originShift);lat=180/Math.PI*(2*Math.atan(Math.exp(lat*Math.PI/180))-Math.PI/2);return new Point(lon,lat)};CoordinateSystem.prototype.PixelsToMeters=function(a,c,b){res=this.Resolution(b);mx=a*res-this.originShift;my=c*res-this.originShift;return new Point(mx,my)};
CoordinateSystem.prototype.MetersToPixels=function(a,c,b){res=this.Resolution(b);px=(a+this.originShift)/res;py=(c+this.originShift)/res;return new Point(px,py)};CoordinateSystem.prototype.MetersToPixelsAccurate=function(a,c,b){var e=this.MetersToLatLon(a,c).y;res=this.ResolutionByLat(b,e);px=(a+this.originShift)/res;py=(c+this.originShift)/res;return new Point(px,py)};
CoordinateSystem.prototype.PixelsToTile=function(a,c){tx=Math.floor(Math.ceil(a/this.tileSize)-1);ty=Math.floor(Math.ceil(c/this.tileSize)-1);return new Point(tx,ty)};CoordinateSystem.prototype.PixelsToRaster=function(a,c,b){mapSize=this.tileSize*Math.pow(2,b);return new Point(a,mapSize-c)};CoordinateSystem.prototype.MetersToTile=function(a,c,b){p=this.MetersToPixels(a,c,b);return this.PixelsToTile(p.x,p.y)};
CoordinateSystem.prototype.Resolution=function(a){return this.initialResolution/Math.pow(2,a)};CoordinateSystem.prototype.ResolutionByLat=function(a,c){var b=6378*Math.cos(c/180*Math.PI);return 1E3*2*Math.PI*b/this.tileSize/Math.pow(2,a)};CoordinateSystem.prototype.GoogleTile=function(a,c,b){return new Point(a,Math.pow(2,b)-1-c)};this.GeoLoc={};
GeoLoc.init=function(a,c,b,e){function d(){var b=document.getElementById(a).value;h.geocode({address:b},function(a,b){if(b==google.maps.GeocoderStatus.OK){var c=a[0].geometry.location.lat(),d=a[0].geometry.location.lng();r.SetCenter(c,d)}else m&&console.log("Geocode failed: "+b)})}function f(){var b=document.getElementById(a),b=new google.maps.places.Autocomplete(b,{types:["geocode"]});google.maps.event.addListener(b,"place_changed",function(){d()});d()}function g(a){r.SetCenter(a.coords.latitude,a.coords.longitude);
f()}var h,m=!1,r=b;c.bind("click",function(){d()});(function(a){h=new google.maps.Geocoder;a&&navigator.geolocation?navigator.geolocation.getCurrentPosition(g):(m&&console.log("No HTML5 geoloc OR tryGeoloc "+a),f())})(e)};var fabric=fabric||{version:"1.0.6"};"undefined"!==typeof exports&&(exports.fabric=fabric);"undefined"!==typeof document&&"undefined"!==typeof window?(fabric.document=document,fabric.window=window):(fabric.document=require("jsdom").jsdom("<!DOCTYPE html><html><head></head><body></body></html>"),fabric.window=fabric.document.createWindow());fabric.isTouchSupported="ontouchstart"in fabric.document.documentElement;fabric.isLikelyNode="undefined"!==typeof Buffer&&"undefined"===typeof window;
var Cufon=function(){function a(a){var b=this.face=a.face;this.glyphs=a.glyphs;this.w=a.w;this.baseSize=parseInt(b["units-per-em"],10);this.family=b["font-family"].toLowerCase();this.weight=b["font-weight"];this.style=b["font-style"]||"normal";this.viewBox=function(){var a=b.bbox.split(/\s+/),a={minX:parseInt(a[0],10),minY:parseInt(a[1],10),maxX:parseInt(a[2],10),maxY:parseInt(a[3],10)};a.width=a.maxX-a.minX;a.height=a.maxY-a.minY;a.toString=function(){return[this.minX,this.minY,this.width,this.height].join(" ")};
return a}();this.ascent=-parseInt(b.ascent,10);this.descent=-parseInt(b.descent,10);this.height=-this.ascent+this.descent}function c(){var a={},b={oblique:"italic",italic:"oblique"};this.add=function(b){(a[b.style]||(a[b.style]={}))[b.weight]=b};this.get=function(c,d){var e=a[c]||a[b[c]]||a.normal||a.italic||a.oblique;if(!e)return null;d={normal:400,bold:700}[d]||parseInt(d,10);if(e[d])return e[d];var f={1:1,99:0}[d%100],g=[],h,m;void 0===f&&(f=400<d);500==d&&(d=400);for(var t in e){t=parseInt(t,
10);if(!h||t<h)h=t;if(!m||t>m)m=t;g.push(t)}d<h&&(d=h);d>m&&(d=m);g.sort(function(a,b){return(f?a>d&&b>d?a<b:a>b:a<d&&b<d?a>b:a<b)?-1:1});return e[g[0]]}}function b(a){var b={},c={};this.get=function(c){return void 0!=b[c]?b[c]:a[c]};this.getSize=function(a,b){return c[a]||(c[a]=new q.Size(this.get(a),b))};this.extend=function(a){for(var c in a)b[c]=a[c];return this}}function e(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,function(){return c.call(a,fabric.window.event)})}
function d(a){var b={};return function(c){b.hasOwnProperty(c)||(b[c]=a.apply(null,arguments));return b[c]}}function f(a){return fabric.document.getElementsByTagName(a)}function g(){for(var a={},b,c=0,d=arguments.length;c<d;++c)for(b in arguments[c])a[b]=arguments[c][b];return a}function h(a,b,c,d,e,f){var g=d.separate;if("none"==g)return A[d.engine].apply(null,arguments);var h=fabric.document.createDocumentFragment(),m=b.split(B[g]),t="words"==g;t&&v&&(/^\s/.test(b)&&m.unshift(""),/\s$/.test(b)&&
m.push(""));for(var r=0,u=m.length;r<u;++r)(g=A[d.engine](a,t?q.textAlign(m[r],c,r,u):m[r],c,d,e,f,r<u-1))&&h.appendChild(g);return h}function m(a,b){var c,d,e,f;e=t.get(a);e.options||(b.hover&&b.hoverables[a.nodeName.toLowerCase()]&&w.attach(a),e.options=b);for(var g=a.firstChild;g;g=e){e=g.nextSibling;f=!1;if(1==g.nodeType){if(!g.firstChild)continue;if(/cufon/.test(g.className))f=!0;else{arguments.callee(g,b);continue}}d||(d=q.getStyle(a).extend(b));if(!c)a:{(c=d)||(c=q.getStyle(a));for(var m=q.quotedList(c.get("fontFamily").toLowerCase()),
v=void 0,r=0,u=m.length;r<u;++r)if(v=m[r],y[v]){c=y[v].get(c.get("fontStyle"),c.get("fontWeight"));break a}c=null}if(c)if(f)A[b.engine](c,null,d,b,g,a);else f=g.data,"undefined"!=typeof G_vmlCanvasManager&&(f=f.replace(/\r/g,"\n")),""!==f&&((f=h(c,f,d,b,g,a))?g.parentNode.replaceChild(f,g):g.parentNode.removeChild(g))}}var r=function(){return r.replace.apply(null,arguments)},u=r.DOM={ready:function(){var a=!1,b={loaded:1,complete:1},c=[],d=function(){if(!a){a=!0;for(var b;b=c.shift();b());}};fabric.document.addEventListener&&
(fabric.document.addEventListener("DOMContentLoaded",d,!1),fabric.window.addEventListener("pageshow",d,!1));!fabric.window.opera&&fabric.document.readyState&&function(){b[fabric.document.readyState]?d():setTimeout(arguments.callee,10)}();fabric.document.readyState&&fabric.document.createStyleSheet&&function(){try{fabric.document.body.doScroll("left"),d()}catch(a){setTimeout(arguments.callee,1)}}();e(fabric.window,"load",d);return function(b){arguments.length?a?b():c.push(b):d()}}()},q=r.CSS={Size:function(a,
b){this.value=parseFloat(a);this.unit=String(a).match(/[a-z%]*$/)[0]||"px";this.convert=function(a){return a/b*this.value};this.convertFrom=function(a){return a/this.value*b};this.toString=function(){return this.value+this.unit}},getStyle:function(a){return new b(a.style)},quotedList:d(function(a){for(var b=[],c=/\s*((["'])([\s\S]*?[^\\])\2|[^,]+)\s*/g,d;d=c.exec(a);)b.push(d[3]||d[1]);return b}),ready:function(){var a=!1,b=[],c=Object.prototype.propertyIsEnumerable?f("style"):{length:0},d=f("link");
u.ready(function(){for(var e=0,f,g=0,h=d.length;f=d[g],g<h;++g)!f.disabled&&"stylesheet"==f.rel.toLowerCase()&&++e;if(fabric.document.styleSheets.length>=c.length+e)for(a=!0;e=b.shift();e());else setTimeout(arguments.callee,10)});return function(c){a?c():b.push(c)}}(),supports:function(a,b){var c=fabric.document.createElement("span").style;if(void 0===c[a])return!1;c[a]=b;return c[a]===b},textAlign:function(a,b,c,d){"right"==b.get("textAlign")?0<c&&(a=" "+a):c<d-1&&(a+=" ");return a},textDecoration:function(a,
b){b||(b=this.getStyle(a));for(var c={underline:null,overline:null,"line-through":null},d=a;d.parentNode&&1==d.parentNode.nodeType;){var e=!0,f;for(f in c)c[f]||(-1!=b.get("textDecoration").indexOf(f)&&(c[f]=b.get("color")),e=!1);if(e)break;b=this.getStyle(d=d.parentNode)}return c},textShadow:d(function(a){if("none"==a)return null;for(var b=[],c={},d,e=0,f=/(#[a-f0-9]+|[a-z]+\(.*?\)|[a-z]+)|(-?[\d.]+[a-z%]*)|,/ig;d=f.exec(a);)","==d[0]?(b.push(c),c={},e=0):d[1]?c.color=d[1]:c[["offX","offY","blur"][e++]]=
d[2];b.push(c);return b}),color:d(function(a){var b={};b.color=a.replace(/^rgba\((.*?),\s*([\d.]+)\)/,function(a,c,d){b.opacity=parseFloat(d);return"rgb("+c+")"});return b}),textTransform:function(a,b){return a[{uppercase:"toUpperCase",lowercase:"toLowerCase"}[b.get("textTransform")]||"toString"]()}},v=0==" ".split(/\s+/).length,t=new function(){var a={},b=0;this.get=function(c){c=c.cufid||(c.cufid=++b);return a[c]||(a[c]={})}},w=new function(){function a(b){b=b.relatedTarget;var d;if(!(d=!b))d=this.contains?
this.contains(b):this.compareDocumentPosition(b)&16;d||c(this)}function b(a){c(this)}function c(a){setTimeout(function(){r.replace(a,t.get(a).options,!0)},10)}this.attach=function(c){void 0===c.onmouseenter?(e(c,"mouseover",a),e(c,"mouseout",a)):(e(c,"mouseenter",b),e(c,"mouseleave",b))}},x=[],A={},y={},C={engine:null,hover:!1,hoverables:{a:!0},printable:!0,selector:fabric.window.Sizzle||fabric.window.jQuery&&function(a){return jQuery(a)}||fabric.window.dojo&&dojo.query||fabric.window.$$&&function(a){return $$(a)}||
fabric.window.$&&function(a){return $(a)}||fabric.document.querySelectorAll&&function(a){return fabric.document.querySelectorAll(a)}||f,separate:"words",textShadow:"none"},B={words:/\s+/,characters:""};r.now=function(){u.ready();return r};r.refresh=function(){for(var a=x.splice(0,x.length),b=0,c=a.length;b<c;++b)r.replace.apply(null,a[b]);return r};r.registerEngine=function(a,b){if(!b)return r;A[a]=b;return r.set("engine",a)};r.registerFont=function(b){b=new a(b);var d=b.family;y[d]||(y[d]=new c);
y[d].add(b);return r.set("fontFamily",'"'+d+'"')};r.replace=function(a,b,c){b=g(C,b);if(!b.engine)return r;"string"==typeof b.textShadow&&b.textShadow&&(b.textShadow=q.textShadow(b.textShadow));c||x.push(arguments);if(a.nodeType||"string"==typeof a)a=[a];q.ready(function(){for(var c=0,d=a.length;c<d;++c){var e=a[c];"string"==typeof e?r.replace(b.selector(e),b,!0):m(e,b)}});return r};r.replaceElement=function(a,b){b=g(C,b);"string"==typeof b.textShadow&&b.textShadow&&(b.textShadow=q.textShadow(b.textShadow));
return m(a,b)};r.engines=A;r.fonts=y;r.getOptions=function(){return g(C)};r.set=function(a,b){C[a]=b;return r};return r}();
Cufon.registerEngine("canvas",function(){var a=Cufon.CSS.supports("display","inline-block"),c=!a&&("BackCompat"==fabric.document.compatMode||/frameset|transitional/i.test(fabric.document.doctype.publicId)),b=fabric.document.createElement("style");b.type="text/css";c=fabric.document.createTextNode(".cufon-canvas{text-indent:0}@media screen,projection{.cufon-canvas{display:inline;display:inline-block;position:relative;vertical-align:middle"+(c?"":";font-size:1px;line-height:1px")+"}.cufon-canvas .cufon-alt{display:-moz-inline-box;display:inline-block;width:0;height:0;overflow:hidden}"+
(a?".cufon-canvas canvas{position:relative}":".cufon-canvas canvas{position:absolute}")+"}@media print{.cufon-canvas{padding:0 !important}.cufon-canvas canvas{display:none}.cufon-canvas .cufon-alt{display:inline}}");try{b.appendChild(c)}catch(e){b.setAttribute("type","text/css"),b.styleSheet.cssText=c.data}fabric.document.getElementsByTagName("head")[0].appendChild(b);return function(b,c,e,h,m,r){function u(a){z.fillStyle=a||Cufon.textOptions.color||e.get("color");var c=a=0;"right"===h.textAlign?
z.translate(O[c],0):"center"===h.textAlign&&z.translate(O[c]/2,0);for(var f=0,m=L.length;f<m;++f)if("\n"===L[f]){c++;var t=-b.ascent-b.ascent/5*h.lineHeight;"right"===h.textAlign?(z.translate(-J,t),z.translate(O[c],0)):"center"===h.textAlign?(z.translate(-a-O[c-1]/2,t),z.translate(O[c]/2,0)):z.translate(-a,t);a=0}else{var v=b.glyphs[L[f]]||b.missingGlyph;if(v){t=Number(v.w||b.w)+w;M&&(z.save(),z.strokeStyle=z.fillStyle,z.lineWidth+=z.lineWidth,z.beginPath(),M.underline&&(z.moveTo(0,-b.face["underline-position"]+
0.5),z.lineTo(t,-b.face["underline-position"]+0.5)),M.overline&&(z.moveTo(0,b.ascent+0.5),z.lineTo(t,b.ascent+0.5)),M["line-through"]&&(z.moveTo(0,-b.descent+0.5),z.lineTo(t,-b.descent+0.5)),z.stroke(),z.restore());N&&(z.save(),z.transform(1,0,-0.25,1,0,0));z.beginPath();if(v.d)if(v.code)for(var q=v.code,v=z,r=0,u=q.length;r<u;++r){var y=q[r];v[y.m].apply(v,y.a)}else{var q=v,v="m"+v.d,r=z,y=u=0,x=[],A=/([mrvxe])([^a-z]*)/g,B=void 0,C=0;a:for(;B=A.exec(v);++C){var E=B[2].split(",");switch(B[1]){case "v":x[C]=
{m:"bezierCurveTo",a:[u+~~E[0],y+~~E[1],u+~~E[2],y+~~E[3],u+=~~E[4],y+=~~E[5]]};break;case "r":x[C]={m:"lineTo",a:[u+=~~E[0],y+=~~E[1]]};break;case "m":x[C]={m:"moveTo",a:[u=~~E[0],y=~~E[1]]};break;case "x":x[C]={m:"closePath",a:[]};break;case "e":break a}r[x[C].m].apply(r,x[C].a)}q.code=x}z.fill();h.strokeStyle&&(z.closePath(),z.save(),z.lineWidth=h.strokeWidth,z.strokeStyle=h.strokeStyle,z.stroke(),z.restore());N&&z.restore();z.translate(t,0);a+=t}}}var q=null===c,v=b.viewBox,t=e.getSize("fontSize",
b.baseSize),w=e.get("letterSpacing"),w="normal"==w?0:t.convertFrom(parseInt(w,10)),x=r=0,A=0,y=h.textShadow,C=[];Cufon.textOptions.shadowOffsets=[];Cufon.textOptions.shadows=null;if(y){Cufon.textOptions.shadows=y;for(var B=0,E=y.length;B<E;++B){var D=y[B],I=t.convertFrom(parseFloat(D.offX)),D=t.convertFrom(parseFloat(D.offY));C[B]=[I,D]}}for(var L=Cufon.CSS.textTransform(q?m.alt:c,e).split(""),J=0,D=null,I=0,Q=1,Z=[],B=0,E=L.length;B<E;++B)if("\n"===L[B])Q++,J>I&&(I=J),Z.push(J),J=0;else{var Y=b.glyphs[L[B]]||
b.missingGlyph;Y&&(J+=D=Number(Y.w||b.w)+w)}Z.push(J);for(var J=Math.max(I,J),O=[],B=Z.length;B--;)O[B]=J-Z[B];if(null===D)return null;x+=v.width-D;A+=v.minX;q?(q=m,m=m.firstChild):(q=fabric.document.createElement("span"),q.className="cufon cufon-canvas",q.alt=c,m=fabric.document.createElement("canvas"),q.appendChild(m),h.printable&&(B=fabric.document.createElement("span"),B.className="cufon-alt",B.appendChild(fabric.document.createTextNode(c)),q.appendChild(B)));c=q.style;E=m.style||{};D=t.convert(v.height-
r+0);B=Math.ceil(D);D=B/D;m.width=Math.ceil(t.convert(J+x-A)*D);m.height=B;r+=v.minY;E.top=Math.round(t.convert(r-b.ascent))+"px";E.left=Math.round(t.convert(A))+"px";x=Math.ceil(t.convert(J*D));E=x+"px";D=t.convert(b.height);t=(h.lineHeight-1)*t.convert(-b.ascent/5)*(Q-1);Cufon.textOptions.width=x;Cufon.textOptions.height=D*Q+t;Cufon.textOptions.lines=Q;Cufon.textOptions.totalLineHeight=t;a?(c.width=E,c.height=D+"px"):(c.paddingLeft=E,c.paddingBottom=D-1+"px");var z=Cufon.textOptions.context||m.getContext("2d"),
F=B/v.height;Cufon.textOptions.fontAscent=b.ascent*F;Cufon.textOptions.boundaries=null;v=Cufon.textOptions.shadowOffsets;for(B=C.length;B--;)v[B]=[C[B][0]*F,C[B][1]*F];z.save();z.scale(F,F);z.translate(-A-1/F*m.width/2+(Cufon.fonts[b.family].offsetLeft||0),-r-Cufon.textOptions.height/F/2+(Cufon.fonts[b.family].offsetTop||0));z.lineWidth=b.face["underline-thickness"];z.save();var M=Cufon.getTextDecoration(h),N="italic"===h.fontStyle;z.save();(function(){z.save();var a=0,c=0,e=[{left:0}];h.backgroundColor&&
(z.save(),z.fillStyle=h.backgroundColor,z.translate(0,b.ascent),z.fillRect(0,0,J+10,(-b.ascent+b.descent)*Q),z.restore());"right"===h.textAlign?(z.translate(O[c],0),e[0].left=O[c]*F):"center"===h.textAlign&&(z.translate(O[c]/2,0),e[0].left=O[c]/2*F);for(var f=0,g=L.length;f<g;++f)if("\n"===L[f]){c++;var m=-b.ascent-b.ascent/5*h.lineHeight,t=e[e.length-1],v={left:0};t.width=a*F;t.height=(-b.ascent+b.descent)*F;"right"===h.textAlign?(z.translate(-J,m),z.translate(O[c],0),v.left=O[c]*F):"center"===h.textAlign?
(z.translate(-a-O[c-1]/2,m),z.translate(O[c]/2,0),v.left=O[c]/2*F):z.translate(-a,m);e.push(v);a=0}else if(m=b.glyphs[L[f]]||b.missingGlyph)m=Number(m.w||b.w)+w,h.textBackgroundColor&&(z.save(),z.fillStyle=h.textBackgroundColor,z.translate(0,b.ascent),z.fillRect(0,0,m+10,-b.ascent+b.descent),z.restore()),z.translate(m,0),a+=m,f==g-1&&(e[e.length-1].width=a*F,e[e.length-1].height=(-b.ascent+b.descent)*F);z.restore();Cufon.textOptions.boundaries=e})();if(y){B=0;for(E=y.length;B<E;++B)D=y[B],z.save(),
z.translate.apply(z,C[B]),u(D.color),z.restore()}u();z.restore();z.restore();z.restore();return q}}());
Cufon.registerEngine("vml",function(){function a(a,c){if(/px$/i.test(c))return parseFloat(c);var d=a.style.left,f=a.runtimeStyle.left;a.runtimeStyle.left=a.currentStyle.left;a.style.left=c;var g=a.style.pixelLeft;a.style.left=d;a.runtimeStyle.left=f;return g}if(fabric.document.namespaces){var c=fabric.document.createElement("canvas");if(!c||!c.getContext||!c.getContext.apply)if(null==fabric.document.namespaces.cvml&&fabric.document.namespaces.add("cvml","urn:schemas-microsoft-com:vml"),c=fabric.document.createElement("cvml:shape"),
c.style.behavior="url(#default#VML)",c.coordsize)return c=null,fabric.document.write('<style type="text/css">.cufon-vml-canvas{text-indent:0}@media screen{cvml\\:shape,cvml\\:shadow{behavior:url(#default#VML);display:block;antialias:true;position:absolute}.cufon-vml-canvas{position:absolute;text-align:left}.cufon-vml{display:inline-block;position:relative;vertical-align:middle}.cufon-vml .cufon-alt{position:absolute;left:-10000in;font-size:1px}a .cufon-vml{cursor:pointer}}@media print{.cufon-vml *{display:none}.cufon-vml .cufon-alt{display:inline}}</style>'),
function(b,c,d,f,g,h,m){var r=null===c;r&&(c=g.alt);var u=b.viewBox,q;if(!(q=d.computedFontSize)){q=Cufon.CSS.Size;var v;v=d.get("fontSize");v=a(h,/(?:em|ex|%)$/i.test(v)?"1em":v);q=d.computedFontSize=new q(v+"px",b.baseSize)}v=d.computedLSpacing;void 0==v&&(v=d.get("letterSpacing"),d.computedLSpacing=v="normal"==v?0:~~q.convertFrom(a(h,v)));if(r)h=g,g=g.firstChild;else{h=fabric.document.createElement("span");h.className="cufon cufon-vml";h.alt=c;g=fabric.document.createElement("span");g.className=
"cufon-vml-canvas";h.appendChild(g);if(f.printable){var t=fabric.document.createElement("span");t.className="cufon-alt";t.appendChild(fabric.document.createTextNode(c));h.appendChild(t)}m||h.appendChild(fabric.document.createElement("cvml:shape"))}m=h.style;var w=g.style,x=q.convert(u.height),t=Math.ceil(x),x=t/x,A=u.minX,y=u.minY;w.height=t;w.top=Math.round(q.convert(y-b.ascent));w.left=Math.round(q.convert(A));m.height=q.convert(b.height)+"px";Cufon.getTextDecoration(f);w=d.get("color");c=Cufon.CSS.textTransform(c,
d).split("");var C=d=0,B=null,E;f=f.textShadow;for(var D=0,I=0,L=c.length;D<L;++D)(E=b.glyphs[c[D]]||b.missingGlyph)&&(d+=B=~~(E.w||b.w)+v);if(null===B)return null;E=-A+d+(u.width-B);for(var D=q.convert(E*x),B=Math.round(D),J=E+","+u.height,Q,Z="r"+J+"nsnf",D=0;D<L;++D)if(E=b.glyphs[c[D]]||b.missingGlyph){r?(u=g.childNodes[I],u.firstChild&&u.removeChild(u.firstChild)):(u=fabric.document.createElement("cvml:shape"),g.appendChild(u));u.stroked="f";u.coordsize=J;u.coordorigin=Q=A-C+","+y;u.path=(E.d?
"m"+E.d+"xe":"")+"m"+Q+Z;u.fillcolor=w;Q=u.style;Q.width=B;Q.height=t;if(f){Q=f[0];var Y=f[1],O=Cufon.CSS.color(Q.color),z,F=fabric.document.createElement("cvml:shadow");F.on="t";F.color=O.color;F.offset=Q.offX+","+Q.offY;Y&&(z=Cufon.CSS.color(Y.color),F.type="double",F.color2=z.color,F.offset2=Y.offX+","+Y.offY);F.opacity=O.opacity||z&&z.opacity||1;u.appendChild(F)}C+=~~(E.w||b.w)+v;++I}m.width=Math.max(Math.ceil(q.convert(d*x)),0);return h}}}());
Cufon.getTextDecoration=function(a){return{underline:"underline"===a.textDecoration,overline:"overline"===a.textDecoration,"line-through":"line-through"===a.textDecoration}};"undefined"!=typeof exports&&(exports.Cufon=Cufon);var JSON;JSON||(JSON={});
(function(){function a(a){return 10>a?"0"+a:a}function c(a){d.lastIndex=0;return d.test(a)?'"'+a.replace(d,function(a){var b=h[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function b(a,d){var e,h,t,w,x=f,A,y=d[a];y&&("object"===typeof y&&"function"===typeof y.toJSON)&&(y=y.toJSON(a));"function"===typeof m&&(y=m.call(d,a,y));switch(typeof y){case "string":return c(y);case "number":return isFinite(y)?String(y):"null";case "boolean":case "null":return String(y);
case "object":if(!y)return"null";f+=g;A=[];if("[object Array]"===Object.prototype.toString.apply(y)){w=y.length;for(e=0;e<w;e+=1)A[e]=b(e,y)||"null";t=0===A.length?"[]":f?"[\n"+f+A.join(",\n"+f)+"\n"+x+"]":"["+A.join(",")+"]";f=x;return t}if(m&&"object"===typeof m){w=m.length;for(e=0;e<w;e+=1)"string"===typeof m[e]&&(h=m[e],(t=b(h,y))&&A.push(c(h)+(f?": ":":")+t))}else for(h in y)Object.prototype.hasOwnProperty.call(y,h)&&(t=b(h,y))&&A.push(c(h)+(f?": ":":")+t);t=0===A.length?"{}":f?"{\n"+f+A.join(",\n"+
f)+"\n"+x+"}":"{"+A.join(",")+"}";f=x;return t}}"function"!==typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(b){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(a){return this.valueOf()});var e=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
d=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,f,g,h={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},m;"function"!==typeof JSON.stringify&&(JSON.stringify=function(a,c,d){var e;g=f="";if("number"===typeof d)for(e=0;e<d;e+=1)g+=" ";else"string"===typeof d&&(g=d);if((m=c)&&"function"!==typeof c&&("object"!==typeof c||"number"!==typeof c.length))throw Error("JSON.stringify");return b("",{"":a})});
"function"!==typeof JSON.parse&&(JSON.parse=function(a,b){function c(a,d){var e,f,g=a[d];if(g&&"object"===typeof g)for(e in g)Object.prototype.hasOwnProperty.call(g,e)&&(f=c(g,e),void 0!==f?g[e]=f:delete g[e]);return b.call(a,d,g)}var d;a=String(a);e.lastIndex=0;e.test(a)&&(a=a.replace(e,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return d=eval("("+a+")"),"function"===typeof b?c({"":d},""):d;throw new SyntaxError("JSON.parse");})})();fabric.log=function(){};fabric.warn=function(){};"undefined"!==typeof console&&("undefined"!==typeof console.log&&console.log.apply&&(fabric.log=function(){return console.log.apply(console,arguments)}),"undefined"!==typeof console.warn&&console.warn.apply&&(fabric.warn=function(){return console.warn.apply(console,arguments)}));
fabric.Observable={observe:function(a,c){this.__eventListeners||(this.__eventListeners={});if(1===arguments.length)for(var b in a)this.on(b,a[b]);else this.__eventListeners[a]||(this.__eventListeners[a]=[]),this.__eventListeners[a].push(c)},stopObserving:function(a,c){this.__eventListeners||(this.__eventListeners={});this.__eventListeners[a]&&(c?fabric.util.removeFromArray(this.__eventListeners[a],c):this.__eventListeners[a].length=0)},fire:function(a,c){this.__eventListeners||(this.__eventListeners=
{});var b=this.__eventListeners[a];if(b)for(var e=0,d=b.length;e<d;e++)b[e](c||{})}};fabric.Observable.on=fabric.Observable.observe;fabric.Observable.off=fabric.Observable.stopObserving;
(function(){var a=Math.sqrt,c=Math.atan2;fabric.util={};var b=Math.PI/180,e=fabric.window.requestAnimationFrame||fabric.window.webkitRequestAnimationFrame||fabric.window.mozRequestAnimationFrame||fabric.window.oRequestAnimationFrame||fabric.window.msRequestAnimationFrame||function(a){fabric.window.setTimeout(a,1E3/60)},d=function(){return e.apply(fabric.window,arguments)};fabric.util.removeFromArray=function(a,b){var c=a.indexOf(b);-1!==c&&a.splice(c,1);return a};fabric.util.degreesToRadians=function(a){return a*
b};fabric.util.radiansToDegrees=function(a){return a/b};fabric.util.rotatePoint=function(a,b,c){var d=Math.sin(c);c=Math.cos(c);a.subtractEquals(b);return(new fabric.Point(a.x*c-a.y*d,a.x*d+a.y*c)).addEquals(b)};fabric.util.toFixed=function(a,b){return parseFloat(Number(a).toFixed(b))};fabric.util.getRandomInt=function(a,b){return Math.floor(Math.random()*(b-a+1))+a};fabric.util.falseFunction=function(){return!1};fabric.util.animate=function(a){a||(a={});var b=+new Date,c=a.duration||500,e=b+c,r,
u=a.onChange||function(){},q=a.abort||function(){return!1},v=a.easing||function(a,b,c,d){return-c*Math.cos(a/d*(Math.PI/2))+c+b},t="startValue"in a?a.startValue:0,w="endValue"in a?a.endValue:100,x=a.byValue||w-t;a.onStart&&a.onStart();(function y(){r=+new Date;u(v(r>e?c:r-b,t,x,c));r>e||q()?a.onComplete&&a.onComplete():d(y)})()};fabric.util.requestAnimFrame=d;fabric.util.loadImage=function(a,b,c){if(a){var d=new Image;d.onload=function(){b&&b.call(c,d);d=d.onload=null};d.src=a}else b&&b.call(c,a)};
fabric.util.enlivenObjects=function(a,b){var c=[],d=0,e=a.length;a.forEach(function(a,f){if(a.type){var v=fabric[fabric.util.string.camelize(fabric.util.string.capitalize(a.type))];v.async?v.fromObject(a,function(a,v){v||(c[f]=a);++d===e&&b&&b(c)}):(c[f]=v.fromObject(a),++d===e&&b&&b(c))}})};fabric.util.groupSVGElements=function(a,b,c){var d;1<a.length?a.some(function(a){return"text"===a.type})?(d=new fabric.Group([],b),a.reverse().forEach(function(a){a.cx&&(a.left=a.cx);a.cy&&(a.top=a.cy);d.addWithUpdate(a)})):
d=new fabric.PathGroup(a,b):d=a[0];"undefined"!==typeof c&&d.setSourcePath(c);return d};fabric.util.populateWithProperties=function(a,b,c){if(c&&"[object Array]"===Object.prototype.toString.call(c))for(var d=0,e=c.length;d<e;d++)b[c[d]]=a[c[d]]};fabric.util.drawDashedLine=function(b,d,e,m,r,u){m-=d;var q=r-e;r=a(m*m+q*q);m=c(q,m);var q=u.length,v=0,t=!0;b.save();b.translate(d,e);b.moveTo(0,0);b.rotate(m);for(d=0;r>d;)d+=u[v++%q],d>r&&(d=r),b[t?"lineTo":"moveTo"](d,0),t=!t;b.restore()};fabric.util.createCanvasElement=
function(){var a=fabric.document.createElement("canvas");!a.getContext&&"undefined"!==typeof G_vmlCanvasManager&&G_vmlCanvasManager.initElement(a);return a}})();
(function(){var a=Array.prototype.slice;Array.prototype.indexOf||(Array.prototype.indexOf=function(a){if(void 0===this||null===this)throw new TypeError;var b=Object(this),e=b.length>>>0;if(0===e)return-1;var d=0;0<arguments.length&&(d=Number(arguments[1]),d!==d?d=0:0!==d&&(d!==1/0&&d!==-(1/0))&&(d=(0<d||-1)*Math.floor(Math.abs(d))));if(d>=e)return-1;for(d=0<=d?d:Math.max(e-Math.abs(d),0);d<e;d++)if(d in b&&b[d]===a)return d;return-1});Array.prototype.forEach||(Array.prototype.forEach=function(a,b){for(var e=
0,d=this.length>>>0;e<d;e++)e in this&&a.call(b,this[e],e,this)});Array.prototype.map||(Array.prototype.map=function(a,b){for(var e=[],d=0,f=this.length>>>0;d<f;d++)d in this&&(e[d]=a.call(b,this[d],d,this));return e});Array.prototype.every||(Array.prototype.every=function(a,b){for(var e=0,d=this.length>>>0;e<d;e++)if(e in this&&!a.call(b,this[e],e,this))return!1;return!0});Array.prototype.some||(Array.prototype.some=function(a,b){for(var e=0,d=this.length>>>0;e<d;e++)if(e in this&&a.call(b,this[e],
e,this))return!0;return!1});Array.prototype.filter||(Array.prototype.filter=function(a,b){for(var e=[],d,f=0,g=this.length>>>0;f<g;f++)f in this&&(d=this[f],a.call(b,d,f,this)&&e.push(d));return e});Array.prototype.reduce||(Array.prototype.reduce=function(a){var b=this.length>>>0,e=0,d;if(1<arguments.length)d=arguments[1];else{do{if(e in this){d=this[e++];break}if(++e>=b)throw new TypeError;}while(1)}for(;e<b;e++)e in this&&(d=a.call(null,d,this[e],e,this));return d});fabric.util.array={invoke:function(c,
b){for(var e=a.call(arguments,2),d=[],f=0,g=c.length;f<g;f++)d[f]=e.length?c[f][b].apply(c[f],e):c[f][b].call(c[f]);return d},min:function(a,b){if(a&&0!==a.length){var e=a.length-1,d=b?a[e][b]:a[e];if(b)for(;e--;)a[e][b]<d&&(d=a[e][b]);else for(;e--;)a[e]<d&&(d=a[e]);return d}},max:function(a,b){if(a&&0!==a.length){var e=a.length-1,d=b?a[e][b]:a[e];if(b)for(;e--;)a[e][b]>=d&&(d=a[e][b]);else for(;e--;)a[e]>=d&&(d=a[e]);return d}}}})();
(function(){function a(a,b){for(var e in b)a[e]=b[e];return a}fabric.util.object={extend:a,clone:function(c){return a({},c)}}})();
(function(){String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s\xA0]+/,"").replace(/[\s\xA0]+$/,"")});fabric.util.string={camelize:function(a){return a.replace(/-+(.)?/g,function(a,b){return b?b.toUpperCase():""})},capitalize:function(a){return a.charAt(0).toUpperCase()+a.slice(1).toLowerCase()},escapeXml:function(a){return a.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}}})();
(function(){var a=Array.prototype.slice,c=Function.prototype.apply,b=function(){};Function.prototype.bind||(Function.prototype.bind=function(e){var d=this,f=a.call(arguments,1),g;g=f.length?function(){return c.call(d,this instanceof b?this:e,f.concat(a.call(arguments)))}:function(){return c.call(d,this instanceof b?this:e,arguments)};b.prototype=this.prototype;g.prototype=new b;return g})})();
(function(){function a(){}function c(a){var c=this.constructor.superclass.prototype[a];return 1<arguments.length?c.apply(this,b.call(arguments,1)):c.call(this)}var b=Array.prototype.slice,e=function(){},d=function(){for(var a in{toString:1})if("toString"===a)return!1;return!0}(),f=function(a,b,c){for(var e in b)e in a.prototype&&"function"===typeof a.prototype[e]&&-1<(b[e]+"").indexOf("callSuper")?a.prototype[e]=function(a){return function(){var d=this.constructor.superclass;this.constructor.superclass=
c;var e=b[a].apply(this,arguments);this.constructor.superclass=d;if("initialize"!==a)return e}}(e):a.prototype[e]=b[e],d&&(b.toString!==Object.prototype.toString&&(a.prototype.toString=b.toString),b.valueOf!==Object.prototype.valueOf&&(a.prototype.valueOf=b.valueOf))};fabric.util.createClass=function(){function d(){this.initialize.apply(this,arguments)}var h=null,m=b.call(arguments,0);"function"===typeof m[0]&&(h=m.shift());d.superclass=h;d.subclasses=[];h&&(a.prototype=h.prototype,d.prototype=new a,
h.subclasses.push(d));for(var r=0,u=m.length;r<u;r++)f(d,m[r],h);d.prototype.initialize||(d.prototype.initialize=e);d.prototype.constructor=d;d.prototype.callSuper=c;return d}})();
(function(){function a(a){var b=Array.prototype.slice.call(arguments,1),c,d,e=b.length;for(d=0;d<e;d++)if(c=typeof a[b[d]],!/^(?:function|object|unknown)$/.test(c))return!1;return!0}function c(a,b){return function(c){b.call(d(a),c||fabric.window.event)}}function b(a,b){return function(c){if(r[a]&&r[a][b])for(var d=r[a][b],e=0,f=d.length;e<f;e++)d[e].call(this,c||fabric.window.event)}}var e=function(){var a=0;return function(b){return b.__uniqueID||(b.__uniqueID="uniqueID__"+a++)}}(),d,f;(function(){var a=
{};d=function(b){return a[b]};f=function(b,c){a[b]=c}})();var g=a(fabric.document.documentElement,"addEventListener","removeEventListener")&&a(fabric.window,"addEventListener","removeEventListener"),h=a(fabric.document.documentElement,"attachEvent","detachEvent")&&a(fabric.window,"attachEvent","detachEvent"),m={},r={};g?(g=function(a,b,c){a.addEventListener(b,c,!1)},h=function(a,b,c){a.removeEventListener(b,c,!1)}):h?(g=function(a,b,d){var g=e(a);f(g,a);m[g]||(m[g]={});m[g][b]||(m[g][b]=[]);d={handler:d,
wrappedHandler:c(g,d)};m[g][b].push(d);a.attachEvent("on"+b,d.wrappedHandler)},h=function(a,b,c){var d=e(a),f;if(m[d]&&m[d][b])for(var g=0,h=m[d][b].length;g<h;g++)if((f=m[d][b][g])&&f.handler===c)a.detachEvent("on"+b,f.wrappedHandler),m[d][b][g]=null}):(g=function(a,c,d){var f=e(a);r[f]||(r[f]={});if(!r[f][c]){r[f][c]=[];var g=a["on"+c];g&&r[f][c].push(g);a["on"+c]=b(f,c)}r[f][c].push(d)},h=function(a,b,c){a=e(a);if(r[a]&&r[a][b]){b=r[a][b];a=0;for(var d=b.length;a<d;a++)b[a]===c&&b.splice(a,1)}});
fabric.util.addListener=g;fabric.util.removeListener=h;var u=function(a){return"unknown"!==typeof a.clientX?a.clientX:0},q=function(a){return"unknown"!==typeof a.clientY?a.clientY:0};fabric.isTouchSupported&&(u=function(a){return a.touches&&a.touches[0]?a.touches[0].pageX-(a.touches[0].pageX-a.touches[0].clientX)||a.clientX:a.clientX},q=function(a){return a.touches&&a.touches[0]?a.touches[0].pageY-(a.touches[0].pageY-a.touches[0].clientY)||a.clientY:a.clientY});fabric.util.getPointer=function(a,b){a||
(a=fabric.window.event);for(var c=a.target||("unknown"!==typeof a.srcElement?a.srcElement:null),d=fabric.document.body||{scrollLeft:0,scrollTop:0},e=fabric.document.documentElement,f=c,g=0,h=0,m;c&&c.parentNode&&!m;)c=c.parentNode,c!==fabric.document&&"fixed"===fabric.util.getElementPosition(c)&&(m=c),c!==fabric.document&&f!==b&&"absolute"===fabric.util.getElementPosition(c)?h=g=0:c===fabric.document&&f!==b?(g=d.scrollLeft||e.scrollLeft||0,h=d.scrollTop||e.scrollTop||0):(g+=c.scrollLeft||0,h+=c.scrollTop||
0);return{x:u(a)+g,y:q(a)+h}};fabric.util.object.extend(fabric.util,fabric.Observable)})();
(function(){var a=fabric.document.createElement("div"),c="string"===typeof a.style.filter,b=/alpha\s*\(\s*opacity\s*=\s*([^\)]+)\)/,e=function(a){return a};"string"===typeof a.style.opacity?e=function(a,b){a.style.opacity=b;return a}:c&&(e=function(a,c){var e=a.style;a.currentStyle&&!a.currentStyle.hasLayout&&(e.zoom=1);b.test(e.filter)?e.filter=e.filter.replace(b,0.9999<=c?"":"alpha(opacity="+100*c+")"):e.filter+=" alpha(opacity="+100*c+")";return a});fabric.util.setStyle=function(a,b){var c=a.style;
if(!c)return a;if("string"===typeof b)return a.style.cssText+=";"+b,-1<b.indexOf("opacity")?e(a,b.match(/opacity:\s*(\d?\.?\d*)/)[1]):a;for(var h in b)"opacity"===h?e(a,b[h]):c["float"===h||"cssFloat"===h?"undefined"===typeof c.styleFloat?"cssFloat":"styleFloat":h]=b[h];return a}})();
(function(){function a(a,b){var c=fabric.document.createElement(a),d;for(d in b)"class"===d?c.className=b[d]:"for"===d?c.htmlFor=b[d]:c.setAttribute(d,b[d]);return c}var c=Array.prototype.slice,b=function(a){return c.call(a,0)},e;try{e=b(fabric.document.childNodes)instanceof Array}catch(d){}e||(b=function(a){for(var b=Array(a.length),c=a.length;c--;)b[c]=a[c];return b});e=fabric.document.defaultView&&fabric.document.defaultView.getComputedStyle?function(a){return fabric.document.defaultView.getComputedStyle(a,
null).position}:function(a){var b=a.style.position;!b&&a.currentStyle&&(b=a.currentStyle.position);return b};(function(){var a=fabric.document.documentElement.style,b="userSelect"in a?"userSelect":"MozUserSelect"in a?"MozUserSelect":"WebkitUserSelect"in a?"WebkitUserSelect":"KhtmlUserSelect"in a?"KhtmlUserSelect":"";fabric.util.makeElementUnselectable=function(a){"undefined"!==typeof a.onselectstart&&(a.onselectstart=fabric.util.falseFunction);b?a.style[b]="none":"string"===typeof a.unselectable&&
(a.unselectable="on");return a};fabric.util.makeElementSelectable=function(a){"undefined"!==typeof a.onselectstart&&(a.onselectstart=null);b?a.style[b]="":"string"===typeof a.unselectable&&(a.unselectable="");return a}})();(function(){fabric.util.getScript=function(a,b){var c=fabric.document.getElementsByTagName("head")[0],d=fabric.document.createElement("script"),e=!0;d.type="text/javascript";d.setAttribute("runat","server");d.onload=d.onreadystatechange=function(a){e&&!("string"===typeof this.readyState&&
"loaded"!==this.readyState&&"complete"!==this.readyState)&&(e=!1,b(a||fabric.window.event),d=d.onload=d.onreadystatechange=null)};d.src=a;c.appendChild(d)}})();fabric.util.getById=function(a){return"string"===typeof a?fabric.document.getElementById(a):a};fabric.util.toArray=b;fabric.util.makeElement=a;fabric.util.addClass=function(a,b){-1===(" "+a.className+" ").indexOf(" "+b+" ")&&(a.className+=(a.className?" ":"")+b)};fabric.util.wrapElement=function(b,c,d){"string"===typeof c&&(c=a(c,d));b.parentNode&&
b.parentNode.replaceChild(c,b);c.appendChild(b);return c};fabric.util.getElementOffset=function(a){var b=0,c=0;do b+=a.offsetTop||0,c+=a.offsetLeft||0,a=a.offsetParent;while(a);return{left:c,top:b}};fabric.util.getElementPosition=e})();
(function(){function a(){}var c=function(){for(var a=[function(){return new ActiveXObject("Microsoft.XMLHTTP")},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml2.XMLHTTP.3.0")},function(){return new XMLHttpRequest}],c=a.length;c--;)try{if(a[c]())return a[c]}catch(d){}}();fabric.util.request=function(b,e){e||(e={});var d=e.method?e.method.toUpperCase():"GET",f=e.onComplete||function(){},g=c(),h;g.onreadystatechange=function(){4===g.readyState&&(f(g),
g.onreadystatechange=a)};"GET"===d&&(h=null,"string"===typeof e.parameters&&(b=b+(/\?/.test(b)?"&":"?")+e.parameters));g.open(d,b,!0);("POST"===d||"PUT"===d)&&g.setRequestHeader("Content-Type","application/x-www-form-urlencoded");g.send(h);return g}})();
(function(){function a(a,e,d,f){return d-c(f-a,0,d,f)+e}function c(a,c,d,f){return(a/=f)<1/2.75?d*7.5625*a*a+c:a<2/2.75?d*(7.5625*(a-=1.5/2.75)*a+0.75)+c:a<2.5/2.75?d*(7.5625*(a-=2.25/2.75)*a+0.9375)+c:d*(7.5625*(a-=2.625/2.75)*a+0.984375)+c}fabric.util.ease={easeInQuad:function(a,c,d,f){return d*(a/=f)*a+c},easeOutQuad:function(a,c,d,f){return-d*(a/=f)*(a-2)+c},easeInOutQuad:function(a,c,d,f){a/=f/2;return 1>a?d/2*a*a+c:-d/2*(--a*(a-2)-1)+c},easeInCubic:function(a,c,d,f){return d*(a/=f)*a*a+c},easeOutCubic:function(a,
c,d,f){return d*((a=a/f-1)*a*a+1)+c},easeInOutCubic:function(a,c,d,f){a/=f/2;return 1>a?d/2*a*a*a+c:d/2*((a-=2)*a*a+2)+c},easeInQuart:function(a,c,d,f){return d*(a/=f)*a*a*a+c},easeOutQuart:function(a,c,d,f){return-d*((a=a/f-1)*a*a*a-1)+c},easeInOutQuart:function(a,c,d,f){a/=f/2;return 1>a?d/2*a*a*a*a+c:-d/2*((a-=2)*a*a*a-2)+c},easeInQuint:function(a,c,d,f){return d*(a/=f)*a*a*a*a+c},easeOutQuint:function(a,c,d,f){return d*((a=a/f-1)*a*a*a*a+1)+c},easeInOutQuint:function(a,c,d,f){a/=f/2;return 1>
a?d/2*a*a*a*a*a+c:d/2*((a-=2)*a*a*a*a+2)+c},easeInSine:function(a,c,d,f){return-d*Math.cos(a/f*(Math.PI/2))+d+c},easeOutSine:function(a,c,d,f){return d*Math.sin(a/f*(Math.PI/2))+c},easeInOutSine:function(a,c,d,f){return-d/2*(Math.cos(Math.PI*a/f)-1)+c},easeInExpo:function(a,c,d,f){return 0===a?c:d*Math.pow(2,10*(a/f-1))+c},easeOutExpo:function(a,c,d,f){return a===f?c+d:d*(-Math.pow(2,-10*a/f)+1)+c},easeInOutExpo:function(a,c,d,f){if(0===a)return c;if(a===f)return c+d;a/=f/2;return 1>a?d/2*Math.pow(2,
10*(a-1))+c:d/2*(-Math.pow(2,-10*--a)+2)+c},easeInCirc:function(a,c,d,f){return-d*(Math.sqrt(1-(a/=f)*a)-1)+c},easeOutCirc:function(a,c,d,f){return d*Math.sqrt(1-(a=a/f-1)*a)+c},easeInOutCirc:function(a,c,d,f){a/=f/2;return 1>a?-d/2*(Math.sqrt(1-a*a)-1)+c:d/2*(Math.sqrt(1-(a-=2)*a)+1)+c},easeInElastic:function(a,c,d,f){var g=1.70158,h=0,m=d;if(0===a)return c;a/=f;if(1===a)return c+d;h||(h=0.3*f);m<Math.abs(d)?(m=d,g=h/4):g=h/(2*Math.PI)*Math.asin(d/m);return-(m*Math.pow(2,10*(a-=1))*Math.sin((a*f-
g)*2*Math.PI/h))+c},easeOutElastic:function(a,c,d,f){var g=1.70158,h=0,m=d;if(0===a)return c;a/=f;if(1===a)return c+d;h||(h=0.3*f);m<Math.abs(d)?(m=d,g=h/4):g=h/(2*Math.PI)*Math.asin(d/m);return m*Math.pow(2,-10*a)*Math.sin((a*f-g)*2*Math.PI/h)+d+c},easeInOutElastic:function(a,c,d,f){var g=1.70158,h=0,m=d;if(0===a)return c;a/=f/2;if(2===a)return c+d;h||(h=f*0.3*1.5);m<Math.abs(d)?(m=d,g=h/4):g=h/(2*Math.PI)*Math.asin(d/m);return 1>a?-0.5*m*Math.pow(2,10*(a-=1))*Math.sin((a*f-g)*2*Math.PI/h)+c:0.5*
m*Math.pow(2,-10*(a-=1))*Math.sin((a*f-g)*2*Math.PI/h)+d+c},easeInBack:function(a,c,d,f,g){void 0===g&&(g=1.70158);return d*(a/=f)*a*((g+1)*a-g)+c},easeOutBack:function(a,c,d,f,g){void 0===g&&(g=1.70158);return d*((a=a/f-1)*a*((g+1)*a+g)+1)+c},easeInOutBack:function(a,c,d,f,g){void 0===g&&(g=1.70158);a/=f/2;return 1>a?d/2*a*a*(((g*=1.525)+1)*a-g)+c:d/2*((a-=2)*a*(((g*=1.525)+1)*a+g)+2)+c},easeInBounce:a,easeOutBounce:c,easeInOutBounce:function(b,e,d,f){return b<f/2?0.5*a(2*b,0,d,f)+e:0.5*c(2*b-f,
0,d,f)+0.5*d+e}}})();
(function(a){function c(a){return a in u?u[a]:a}function b(a){for(var b=a.length;b--;){var c=a[b].get("fill");/^url\(/.test(c)&&(c=c.slice(5,c.length-1),g.gradientDefs[c]&&a[b].set("fill",g.Gradient.fromElement(g.gradientDefs[c],a[b])))}}function e(a){a=a.getElementsByTagName("style");for(var b={},c,d=0,e=a.length;d<e;d++)c=a[0].textContent,c=c.replace(/\/\*[\s\S]*?\*\//g,""),c=c.match(/[^{]*\{[\s\S]*?\}/g),c=c.map(function(a){return a.trim()}),c.forEach(function(a){var c=a.match(/([\s\S]*?)\s*\{([^}]*)\}/);a=
c[1];c=c[2].trim().replace(/;$/,"").split(/\s*;\s*/);b[a]||(b[a]={});for(var d=0,e=c.length;d<e;d++){var f=c[d].split(/\s*:\s*/);b[a][f[0]]=f[1]}});return b}function d(a){var b=a.nodeName,c=a.getAttribute("class");a=a.getAttribute("id");var d={},e;for(e in g.cssRules)if(c&&RegExp("^\\."+c).test(e)||a&&RegExp("^#"+a).test(e)||RegExp("^"+b).test(e))for(var f in g.cssRules[e])d[f]=g.cssRules[e][f];return d}function f(a){var b=a.objects;a=a.options;b=b.map(function(a){return g[m(a.type)].fromObject(a)});
return{objects:b,options:a}}var g=a.fabric||(a.fabric={}),h=g.util.object.extend,m=g.util.string.capitalize,r=g.util.object.clone,u={cx:"left",x:"left",cy:"top",y:"top",r:"radius","fill-opacity":"opacity","fill-rule":"fillRule","stroke-width":"strokeWidth",transform:"transformMatrix","text-decoration":"textDecoration","font-size":"fontSize","font-weight":"fontWeight","font-style":"fontStyle","font-family":"fontFamily"};g.parseTransformAttribute=function(){function a(b,c){var d=c[0];b[0]=Math.cos(d);
b[1]=Math.sin(d);b[2]=-Math.sin(d);b[3]=Math.cos(d)}function b(a,c){var d=2===c.length?c[1]:c[0];a[0]=c[0];a[3]=d}function c(a,b){a[4]=b[0];2===b.length&&(a[5]=b[1])}var d=[1,0,0,1,0,0],e=RegExp("^\\s*(?:(?:(?:(?:(matrix)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\))|(?:(translate)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(scale)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(rotate)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(skewX)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\))|(?:(skewY)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\)))(?:(?:\\s+,?\\s*|,\\s*)(?:(?:(matrix)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\))|(?:(translate)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(scale)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(rotate)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(skewX)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\))|(?:(skewY)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\))))*)?)\\s*$"),
f=RegExp("(?:(?:(matrix)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\))|(?:(translate)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(scale)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(rotate)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(skewX)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\))|(?:(skewY)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\)))");
return function(g){var h=d.concat();if(!g||g&&!e.test(g))return h;g.replace(f,function(d){var e=RegExp("(?:(?:(matrix)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\))|(?:(translate)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(scale)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(rotate)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(skewX)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\))|(?:(skewY)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\)))").exec(d).filter(function(a){return""!==
a&&null!=a});d=e[1];e=e.slice(2).map(parseFloat);switch(d){case "translate":c(h,e);break;case "rotate":a(h,e);break;case "scale":b(h,e);break;case "skewX":h[2]=e[0];break;case "skewY":h[1]=e[0];break;case "matrix":h=e}});return h}}();g.parseSVGDocument=function(){var a=/^(path|circle|polygon|polyline|ellipse|rect|line|image|text)$/,b=RegExp("^\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)+)\\s*,?\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)+)\\s*,?\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)+)\\s*,?\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)+)\\s*$");
return function(c,d,f){if(c){var h=new Date,m=g.util.toArray(c.getElementsByTagName("*"));if(0===m.length){for(var m=c.selectNodes("//*[name(.)!='svg']"),q=[],u=0,D=m.length;u<D;u++)q[u]=m[u];m=q}if((m=m.filter(function(b){var c;if(c=a.test(b.tagName)){a:{for(c=/^(?:pattern|defs)$/;b&&(b=b.parentNode);)if(c.test(b.nodeName)){b=!0;break a}b=!1}c=!b}return c}))&&(!m||m.length)){var q=c.getAttribute("viewBox"),u=c.getAttribute("width"),D=c.getAttribute("height"),I=null,L=null;if(q&&(q=q.match(b)))parseInt(q[1],
10),parseInt(q[2],10),I=parseInt(q[3],10),L=parseInt(q[4],10);var I=u?parseFloat(u):I,L=D?parseFloat(D):L,J={width:I,height:L};g.gradientDefs=g.getGradientDefs(c);g.cssRules=e(c);g.parseElements(m,function(a){g.documentParsingTime=new Date-h;d&&d(a,J)},r(J),f)}}}}();var q={has:function(a,b){b(!1)},get:function(){},set:function(){}};h(g,{parseAttributes:function(a,b){if(a){var e,f,m={};a.parentNode&&/^g$/i.test(a.parentNode.nodeName)&&(m=g.parseAttributes(a.parentNode,b));var q=b.reduce(function(b,
d){e=a.getAttribute(d);f=parseFloat(e);if(e){if(("fill"===d||"stroke"===d)&&"none"===e)e="";"fill-rule"===d&&(e="evenodd"===e?"destination-over":e);"transform"===d&&(e=g.parseTransformAttribute(e));d=c(d);b[d]=isNaN(f)?e:f}return b},{}),q=h(q,h(d(a),g.parseStyleAttribute(a)));return h(m,q)}},parseElements:function(a,c,d,e){function f(){0===--q&&(h=h.filter(function(a){return null!=a}),b(h),c(h))}for(var h=Array(a.length),q=a.length,r=0,u,D=a.length;r<D;r++){u=a[r];var I=g[m(u.tagName)];if(I&&I.fromElement)try{if(I.async)I.fromElement(u,
function(a,b){return function(c){e&&e(b,c);h.splice(a,0,c);f()}}(r),d);else{var L=I.fromElement(u,d);e&&e(u,L);h.splice(r,0,L);f()}}catch(J){g.log(J)}else f()}},parseStyleAttribute:function(a){var b={};a=a.getAttribute("style");if(!a)return b;if("string"===typeof a)a=a.replace(/;$/,"").split(";").forEach(function(a){a=a.split(":");var d=a[1].trim(),e=parseFloat(d);b[c(a[0].trim().toLowerCase())]=isNaN(e)?d:e});else for(var d in a)if("undefined"!==typeof a[d]){var e=parseFloat(a[d]);b[c(d.toLowerCase())]=
isNaN(e)?a[d]:e}return b},parsePointsAttribute:function(a){if(!a)return null;a=a.trim();var b=-1<a.indexOf(",");a=a.split(/\s+/);var c=[],d;if(b){b=0;for(d=a.length;b<d;b++){var e=a[b].split(",");c.push({x:parseFloat(e[0]),y:parseFloat(e[1])})}}else{b=0;for(d=a.length;b<d;b+=2)c.push({x:parseFloat(a[b]),y:parseFloat(a[b+1])})}return c},getCSSRules:e,loadSVGFromURL:function(a,b,c){function d(e){var f=e.responseXML;!f.documentElement&&(g.window.ActiveXObject&&e.responseText)&&(f=new ActiveXObject("Microsoft.XMLDOM"),
f.async="false",f.loadXML(e.responseText.replace(/<!DOCTYPE[\s\S]*?(\[[\s\S]*\])*?>/i,"")));f.documentElement&&g.parseSVGDocument(f.documentElement,function(c,d){q.set(a,{objects:g.util.array.invoke(c,"toObject"),options:d});b(c,d)},c)}a=a.replace(/^\n\s*/,"").trim();q.has(a,function(c){c?q.get(a,function(a){a=f(a);b(a.objects,a.options)}):new g.util.request(a,{method:"get",onComplete:d})})},loadSVGFromString:function(a,b,c){a=a.trim();var d;if("undefined"!==typeof DOMParser){var e=new DOMParser;
e&&e.parseFromString&&(d=e.parseFromString(a,"text/xml"))}else g.window.ActiveXObject&&(d=new ActiveXObject("Microsoft.XMLDOM"),d.async="false",d.loadXML(a.replace(/<!DOCTYPE[\s\S]*?(\[[\s\S]*\])*?>/i,"")));g.parseSVGDocument(d.documentElement,function(a,c){b(a,c)},c)},createSVGFontFacesMarkup:function(a){for(var b="",c=0,d=a.length;c<d;c++)"text"===a[c].type&&a[c].path&&(b+=["@font-face {font-family: ",a[c].fontFamily,"; src: url('",a[c].path,"')}"].join(""));b&&(b=['<defs><style type="text/css"><![CDATA[',
b,"]]\x3e</style></defs>"].join(""));return b}})})("undefined"!==typeof exports?exports:this);
(function(){function a(a,b){for(var e in b){if("string"===typeof b[e]&&/^\d+%$/.test(b[e])){var d=parseFloat(b[e],10);if("x1"===e||"x2"===e)b[e]=fabric.util.toFixed(a.width*d/100,2);else if("y1"===e||"y2"===e)b[e]=fabric.util.toFixed(a.height*d/100,2)}if("x1"===e||"x2"===e)b[e]-=fabric.util.toFixed(a.width/2,2);else if("y1"===e||"y2"===e)b[e]-=fabric.util.toFixed(a.height/2,2)}}fabric.Gradient=fabric.util.createClass({initialize:function(a){a||(a={});this.x1=a.x1||0;this.y1=a.y1||0;this.x2=a.x2||
0;this.y2=a.y2||0;this.colorStops=a.colorStops},toObject:function(){return{x1:this.x1,x2:this.x2,y1:this.y1,y2:this.y2,colorStops:this.colorStops}},toLive:function(a){a=a.createLinearGradient(this.x1,this.y1,this.x2||a.canvas.width,this.y2);for(var b in this.colorStops){var e=this.colorStops[b];a.addColorStop(parseFloat(b),e)}return a}});fabric.util.object.extend(fabric.Gradient,{fromElement:function(c,b){for(var e=c.getElementsByTagName("stop"),d,f={},g={x1:c.getAttribute("x1")||0,y1:c.getAttribute("y1")||
0,x2:c.getAttribute("x2")||"100%",y2:c.getAttribute("y2")||0},h=e.length;h--;){c=e[h];d=c.getAttribute("offset");d=parseFloat(d)/(/%$/.test(d)?100:1);var m=f,r;a:{if(r=c.getAttribute("style")){r=r.split(/\s*;\s*/);""===r[r.length-1]&&r.pop();for(var u=r.length;u--;){var q=r[u].split(/\s*:\s*/),v=q[0].trim(),q=q[1].trim();if("stop-color"===v){r=q;break a}}}r=void 0}m[d]=r||c.getAttribute("stop-color")}a(b,g);return new fabric.Gradient({x1:g.x1,y1:g.y1,x2:g.x2,y2:g.y2,colorStops:f})},forObject:function(c,
b){b||(b={});a(c,b);return new fabric.Gradient(b)}});fabric.getGradientDefs=function(a){var b=a.getElementsByTagName("linearGradient");a=a.getElementsByTagName("radialGradient");var e,d,f={};for(d=b.length;d--;)e=b[d],f[e.getAttribute("id")]=e;for(d=a.length;d--;)e=a[d],f[e.getAttribute("id")]=e;return f}})();
fabric.Pattern=fabric.util.createClass({repeat:"repeat",initialize:function(a){a||(a={});a.source&&(this.source="string"===typeof a.source?new Function(a.source):a.source);a.repeat&&(this.repeat=a.repeat)},toObject:function(){var a;"function"===typeof this.source?a=String(this.source).match(/function\s+\w*\s*\(.*\)\s+\{([\s\S]*)\}/)[1]:"string"===typeof this.source.src&&(a=this.source.src);return{source:a,repeat:this.repeat}},toLive:function(a){var c="function"===typeof this.source?this.source():
this.source;return a.createPattern(c,this.repeat)}});fabric.Shadow=fabric.util.createClass({color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,initialize:function(a){for(var c in a)this[c]=a[c]},toObject:function(){return{color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY}},toSVG:function(){}});
(function(a){function c(a,c){0<arguments.length&&this.init(a,c)}a=a.fabric||(a.fabric={});a.Point?a.warn("fabric.Point is already defined"):(a.Point=c,c.prototype={constructor:c,init:function(a,c){this.x=a;this.y=c},add:function(a){return new c(this.x+a.x,this.y+a.y)},addEquals:function(a){this.x+=a.x;this.y+=a.y;return this},scalarAdd:function(a){return new c(this.x+a,this.y+a)},scalarAddEquals:function(a){this.x+=a;this.y+=a;return this},subtract:function(a){return new c(this.x-a.x,this.y-a.y)},
subtractEquals:function(a){this.x-=a.x;this.y-=a.y;return this},scalarSubtract:function(a){return new c(this.x-a,this.y-a)},scalarSubtractEquals:function(a){this.x-=a;this.y-=a;return this},multiply:function(a){return new c(this.x*a,this.y*a)},multiplyEquals:function(a){this.x*=a;this.y*=a;return this},divide:function(a){return new c(this.x/a,this.y/a)},divideEquals:function(a){this.x/=a;this.y/=a;return this},eq:function(a){return this.x===a.x&&this.y===a.y},lt:function(a){return this.x<a.x&&this.y<
a.y},lte:function(a){return this.x<=a.x&&this.y<=a.y},gt:function(a){return this.x>a.x&&this.y>a.y},gte:function(a){return this.x>=a.x&&this.y>=a.y},lerp:function(a,e){return new c(this.x+(a.x-this.x)*e,this.y+(a.y-this.y)*e)},distanceFrom:function(a){var c=this.x-a.x;a=this.y-a.y;return Math.sqrt(c*c+a*a)},midPointFrom:function(a){return new c(this.x+(a.x-this.x)/2,this.y+(a.y-this.y)/2)},min:function(a){return new c(Math.min(this.x,a.x),Math.min(this.y,a.y))},max:function(a){return new c(Math.max(this.x,
a.x),Math.max(this.y,a.y))},toString:function(){return this.x+","+this.y},setXY:function(a,c){this.x=a;this.y=c},setFromPoint:function(a){this.x=a.x;this.y=a.y},swap:function(a){var c=this.x,d=this.y;this.x=a.x;this.y=a.y;a.x=c;a.y=d}})})("undefined"!==typeof exports?exports:this);
(function(a){function c(a){0<arguments.length&&this.init(a)}var b=a.fabric||(a.fabric={});b.Intersection?b.warn("fabric.Intersection is already defined"):(b.Intersection=c,b.Intersection.prototype={init:function(a){this.status=a;this.points=[]},appendPoint:function(a){this.points.push(a)},appendPoints:function(a){this.points=this.points.concat(a)}},b.Intersection.intersectLineLine=function(a,d,f,g){var h,m=(g.x-f.x)*(a.y-f.y)-(g.y-f.y)*(a.x-f.x);h=(d.x-a.x)*(a.y-f.y)-(d.y-a.y)*(a.x-f.x);f=(g.y-f.y)*
(d.x-a.x)-(g.x-f.x)*(d.y-a.y);0!==f?(m/=f,h/=f,0<=m&&1>=m&&0<=h&&1>=h?(h=new c("Intersection"),h.points.push(new b.Point(a.x+m*(d.x-a.x),a.y+m*(d.y-a.y)))):h=new c("No Intersection")):h=0===m||0===h?new c("Coincident"):new c("Parallel");return h},b.Intersection.intersectLinePolygon=function(a,b,f){for(var g=new c("No Intersection"),h=f.length,m=0;m<h;m++){var r=c.intersectLineLine(a,b,f[m],f[(m+1)%h]);g.appendPoints(r.points)}0<g.points.length&&(g.status="Intersection");return g},b.Intersection.intersectPolygonPolygon=
function(a,b){for(var f=new c("No Intersection"),g=a.length,h=0;h<g;h++){var m=c.intersectLinePolygon(a[h],a[(h+1)%g],b);f.appendPoints(m.points)}0<f.points.length&&(f.status="Intersection");return f},b.Intersection.intersectPolygonRectangle=function(a,d,f){var g=d.min(f),h=d.max(f);f=new b.Point(h.x,g.y);var m=new b.Point(g.x,h.y);d=c.intersectLinePolygon(g,f,a);f=c.intersectLinePolygon(f,h,a);h=c.intersectLinePolygon(h,m,a);a=c.intersectLinePolygon(m,g,a);g=new c("No Intersection");g.appendPoints(d.points);
g.appendPoints(f.points);g.appendPoints(h.points);g.appendPoints(a.points);0<g.points.length&&(g.status="Intersection");return g})})("undefined"!==typeof exports?exports:this);
(function(a){function c(a){a?this._tryParsingColor(a):this.setSource([0,0,0,1])}a=a.fabric||(a.fabric={});a.Color?a.warn("fabric.Color is already defined."):(a.Color=c,a.Color.prototype={_tryParsingColor:function(a){var e=c.sourceFromHex(a);e||(e=c.sourceFromRgb(a));e&&this.setSource(e)},getSource:function(){return this._source},setSource:function(a){this._source=a},toRgb:function(){var a=this.getSource();return"rgb("+a[0]+","+a[1]+","+a[2]+")"},toRgba:function(){var a=this.getSource();return"rgba("+
a[0]+","+a[1]+","+a[2]+","+a[3]+")"},toHex:function(){var a=this.getSource(),c=a[0].toString(16),c=1===c.length?"0"+c:c,d=a[1].toString(16),d=1===d.length?"0"+d:d,a=a[2].toString(16),a=1===a.length?"0"+a:a;return c.toUpperCase()+d.toUpperCase()+a.toUpperCase()},getAlpha:function(){return this.getSource()[3]},setAlpha:function(a){var c=this.getSource();c[3]=a;this.setSource(c);return this},toGrayscale:function(){var a=this.getSource(),c=parseInt((0.3*a[0]+0.59*a[1]+0.11*a[2]).toFixed(0),10);this.setSource([c,
c,c,a[3]]);return this},toBlackWhite:function(a){var c=this.getSource(),d=(0.3*c[0]+0.59*c[1]+0.11*c[2]).toFixed(0),c=c[3],d=Number(d)<Number(a||127)?0:255;this.setSource([d,d,d,c]);return this},overlayWith:function(a){a instanceof c||(a=new c(a));var e=[],d=this.getAlpha(),f=this.getSource();a=a.getSource();for(var g=0;3>g;g++)e.push(Math.round(0.5*f[g]+0.5*a[g]));e[3]=d;this.setSource(e);return this}},a.Color.reRGBa=/^rgba?\((\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})(?:\s*,\s*(\d+(?:\.\d+)?))?\)$/,
a.Color.reHex=/^#?([0-9a-f]{6}|[0-9a-f]{3})$/i,a.Color.fromRgb=function(a){return c.fromSource(c.sourceFromRgb(a))},a.Color.sourceFromRgb=function(a){if(a=a.match(c.reRGBa))return[parseInt(a[1],10),parseInt(a[2],10),parseInt(a[3],10),a[4]?parseFloat(a[4]):1]},a.Color.fromRgba=c.fromRgb,a.Color.fromHex=function(a){return c.fromSource(c.sourceFromHex(a))},a.Color.sourceFromHex=function(a){if(a.match(c.reHex)){var e=a.slice(a.indexOf("#")+1),d=3===e.length;a=d?e.charAt(0)+e.charAt(0):e.substring(0,2);
var f=d?e.charAt(1)+e.charAt(1):e.substring(2,4),e=d?e.charAt(2)+e.charAt(2):e.substring(4,6);return[parseInt(a,16),parseInt(f,16),parseInt(e,16),1]}},a.Color.fromSource=function(a){var e=new c;e.setSource(a);return e})})("undefined"!==typeof exports?exports:this);
(function(){if(fabric.StaticCanvas)fabric.warn("fabric.StaticCanvas is already defined.");else{var a=fabric.util.object.extend,c=fabric.util.getElementOffset,b=fabric.util.removeFromArray,e=fabric.util.removeListener,d=Error("Could not initialize `canvas` element");fabric.StaticCanvas=function(a,b){b||(b={});this._initStatic(a,b);fabric.StaticCanvas.activeInstance=this};a(fabric.StaticCanvas.prototype,fabric.Observable);a(fabric.StaticCanvas.prototype,{backgroundColor:"",backgroundImage:"",backgroundImageOpacity:1,
backgroundImageStretch:!0,overlayImage:"",overlayImageLeft:0,overlayImageTop:0,includeDefaultValues:!0,stateful:!0,renderOnAddition:!0,clipTo:null,controlsAboveOverlay:!1,onBeforeScaleRotate:function(){},_initStatic:function(a,b){this._objects=[];this._createLowerCanvas(a);this._initOptions(b);b.overlayImage&&this.setOverlayImage(b.overlayImage,this.renderAll.bind(this));b.backgroundImage&&this.setBackgroundImage(b.backgroundImage,this.renderAll.bind(this));b.backgroundColor&&this.setBackgroundColor(b.backgroundColor,
this.renderAll.bind(this));this.calcOffset()},calcOffset:function(){this._offset=c(this.lowerCanvasEl);return this},setOverlayImage:function(a,b,c){fabric.util.loadImage(a,function(a){this.overlayImage=a;c&&"overlayImageLeft"in c&&(this.overlayImageLeft=c.overlayImageLeft);c&&"overlayImageTop"in c&&(this.overlayImageTop=c.overlayImageTop);b&&b()},this);return this},setBackgroundImage:function(a,b,c){fabric.util.loadImage(a,function(a){this.backgroundImage=a;c&&"backgroundImageOpacity"in c&&(this.backgroundImageOpacity=
c.backgroundImageOpacity);c&&"backgroundImageStretch"in c&&(this.backgroundImageStretch=c.backgroundImageStretch);b&&b()},this);return this},setBackgroundColor:function(a,b){if(a.source){var c=this;fabric.util.loadImage(a.source,function(d){c.backgroundColor=new fabric.Pattern({source:d,pattern:a.pattern});b&&b()})}else this.backgroundColor=a,b&&b();return this},_createCanvasElement:function(){var a=fabric.document.createElement("canvas");a.style||(a.style={});if(!a)throw d;this._initCanvasElement(a);
return a},_initCanvasElement:function(a){fabric.util.createCanvasElement(a);if("undefined"===typeof a.getContext)throw d;},_initOptions:function(a){for(var b in a)this[b]=a[b];this.width=parseInt(this.lowerCanvasEl.width,10)||0;this.height=parseInt(this.lowerCanvasEl.height,10)||0;this.lowerCanvasEl.style&&(this.lowerCanvasEl.style.width=this.width+"px",this.lowerCanvasEl.style.height=this.height+"px")},_createLowerCanvas:function(a){this.lowerCanvasEl=fabric.util.getById(a)||this._createCanvasElement();
this._initCanvasElement(this.lowerCanvasEl);fabric.util.addClass(this.lowerCanvasEl,"lower-canvas");this.interactive&&this._applyCanvasStyle(this.lowerCanvasEl);this.contextContainer=this.lowerCanvasEl.getContext("2d")},getWidth:function(){return this.width},getHeight:function(){return this.height},setWidth:function(a){return this._setDimension("width",a)},setHeight:function(a){return this._setDimension("height",a)},setDimensions:function(a){for(var b in a)this._setDimension(b,a[b]);return this},
_setDimension:function(a,b){this.lowerCanvasEl[a]=b;this.lowerCanvasEl.style[a]=b+"px";this.upperCanvasEl&&(this.upperCanvasEl[a]=b,this.upperCanvasEl.style[a]=b+"px");this.cacheCanvasEl&&(this.cacheCanvasEl[a]=b);this.wrapperEl&&(this.wrapperEl.style[a]=b+"px");this[a]=b;this.calcOffset();this.renderAll();return this},getElement:function(){return this.lowerCanvasEl},getActiveObject:function(){return null},getActiveGroup:function(){return null},_draw:function(a,b){if(b)if(this.controlsAboveOverlay){var c=
b.hasBorders,d=b.hasCorners;b.hasBorders=b.hasCorners=!1;b.render(a);b.hasBorders=c;b.hasCorners=d}else b.render(a)},add:function(){this._objects.push.apply(this._objects,arguments);for(var a=arguments.length;a--;)this._initObject(arguments[a]);this.renderOnAddition&&this.renderAll();return this},_initObject:function(a){this.stateful&&a.setupState();a.setCoords();a.canvas=this;this.fire("object:added",{target:a});a.fire("added")},insertAt:function(a,b,c){c?this._objects[b]=a:this._objects.splice(b,
0,a);this._initObject(a);this.renderOnAddition&&this.renderAll();return this},getObjects:function(){return this._objects},clearContext:function(a){a.clearRect(0,0,this.width,this.height);return this},getContext:function(){return this.contextContainer},clear:function(){this._objects.length=0;this.discardActiveGroup&&this.discardActiveGroup();this.clearContext(this.contextContainer);this.contextTop&&this.clearContext(this.contextTop);this.fire("canvas:cleared");this.renderAll();return this},renderAll:function(a){var b=
this[!0===a&&this.interactive?"contextTop":"contextContainer"];this.contextTop&&this.selection&&this.clearContext(this.contextTop);a||this.clearContext(b);this.fire("before:render");this.clipTo&&this._clipCanvas(b);this.backgroundColor&&(b.fillStyle=this.backgroundColor.toLive?this.backgroundColor.toLive(b):this.backgroundColor,b.fillRect(0,0,this.width,this.height));"object"===typeof this.backgroundImage&&this._drawBackroundImage(b);var c=this.getActiveGroup();a=0;for(var d=this._objects.length;a<
d;++a)(!c||c&&this._objects[a]&&!c.contains(this._objects[a]))&&this._draw(b,this._objects[a]);if(c){var e=[];this.forEachObject(function(a){c.contains(a)&&e.push(a)});c._set("objects",e);this._draw(b,c)}this.clipTo&&b.restore();this.overlayImage&&b.drawImage(this.overlayImage,this.overlayImageLeft,this.overlayImageTop);this.controlsAboveOverlay&&this.drawControls(b);this.fire("after:render");return this},_clipCanvas:function(a){a.save();a.beginPath();this.clipTo(a);a.clip()},_drawBackroundImage:function(a){a.save();
a.globalAlpha=this.backgroundImageOpacity;this.backgroundImageStretch?a.drawImage(this.backgroundImage,0,0,this.width,this.height):a.drawImage(this.backgroundImage,0,0);a.restore()},renderTop:function(){var a=this.contextTop||this.contextContainer;this.clearContext(a);this.selection&&this._groupSelector&&this._drawSelection();var b=this.getActiveGroup();b&&b.render(a);this.overlayImage&&a.drawImage(this.overlayImage,this.overlayImageLeft,this.overlayImageTop);this.fire("after:render");return this},
drawControls:function(a){var b=this.getActiveGroup();if(b)a.save(),fabric.Group.prototype.transform.call(b,a),b.drawBorders(a).drawCorners(a),a.restore();else for(var b=0,c=this._objects.length;b<c;++b)this._objects[b]&&this._objects[b].active&&(a.save(),fabric.Object.prototype.transform.call(this._objects[b],a),this._objects[b].drawBorders(a).drawCorners(a),a.restore(),this.lastRenderedObjectWithControlsAboveOverlay=this._objects[b])},toDataURL:function(a,b){var c=this.upperCanvasEl||this.lowerCanvasEl;
this.renderAll(!0);c=fabric.StaticCanvas.supports("toDataURLWithQuality")?c.toDataURL("image/"+a,b):c.toDataURL("image/"+a);this.contextTop&&this.clearContext(this.contextTop);this.renderAll();return c},toDataURLWithMultiplier:function(a,b,c){var d=this.getWidth(),e=this.getHeight(),u=d*b,q=e*b,v=this.getActiveObject(),t=this.getActiveGroup(),w=this.contextTop||this.contextContainer;this.setWidth(u).setHeight(q);w.scale(b,b);t?this._tempRemoveBordersCornersFromGroup(t):v&&this.deactivateAll&&this.deactivateAll();
this.width=d;this.height=e;this.renderAll(!0);a=this.toDataURL(a,c);w.scale(1/b,1/b);this.setWidth(d).setHeight(e);t?this._restoreBordersCornersOnGroup(t):v&&this.setActiveObject&&this.setActiveObject(v);this.contextTop&&this.clearContext(this.contextTop);this.renderAll();return a},_tempRemoveBordersCornersFromGroup:function(a){a.origHideCorners=a.hideCorners;a.origBorderColor=a.borderColor;a.hideCorners=!0;a.borderColor="rgba(0,0,0,0)";a.forEachObject(function(a){a.origBorderColor=a.borderColor;
a.borderColor="rgba(0,0,0,0)"})},_restoreBordersCornersOnGroup:function(a){a.hideCorners=a.origHideCorners;a.borderColor=a.origBorderColor;a.forEachObject(function(a){a.borderColor=a.origBorderColor;delete a.origBorderColor})},getCenter:function(){return{top:this.getHeight()/2,left:this.getWidth()/2}},centerObjectH:function(a){a.set("left",this.getCenter().left);this.renderAll();return this},centerObjectV:function(a){a.set("top",this.getCenter().top);this.renderAll();return this},centerObject:function(a){return this.centerObjectH(a).centerObjectV(a)},
toDatalessJSON:function(a){return this.toDatalessObject(a)},toObject:function(a){return this._toObjectMethod("toObject",a)},toDatalessObject:function(a){return this._toObjectMethod("toDatalessObject",a)},_toObjectMethod:function(a,b){var c={objects:this._objects.map(function(c){var d;this.includeDefaultValues||(d=c.includeDefaultValues,c.includeDefaultValues=!1);var e=c[a](b);this.includeDefaultValues||(c.includeDefaultValues=d);return e},this),background:this.backgroundColor&&this.backgroundColor.toObject?
this.backgroundColor.toObject():this.backgroundColor};this.backgroundImage&&(c.backgroundImage=this.backgroundImage.src,c.backgroundImageOpacity=this.backgroundImageOpacity,c.backgroundImageStretch=this.backgroundImageStretch);this.overlayImage&&(c.overlayImage=this.overlayImage.src,c.overlayImageLeft=this.overlayImageLeft,c.overlayImageTop=this.overlayImageTop);fabric.util.populateWithProperties(this,c,b);return c},toSVG:function(){var a=['<?xml version="1.0" standalone="no" ?>','<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN" ',
'"http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">',"<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',this.width,'" ','height="',this.height,'" ','xml:space="preserve">',"<desc>Created with Fabric.js ",fabric.version,"</desc>",fabric.createSVGFontFacesMarkup(this.getObjects())];this.backgroundImage&&a.push('<image x="0" y="0" ','width="',this.width,'" height="',this.height,'" preserveAspectRatio="',this.backgroundImageStretch?
"none":"defer",'" xlink:href="',this.backgroundImage.src,'" style="opacity:',this.backgroundImageOpacity,'"></image>');this.overlayImage&&a.push('<image x="',this.overlayImageLeft,'" y="',this.overlayImageTop,'" width="',this.overlayImage.width,'" height="',this.overlayImage.height,'" xlink:href="',this.overlayImage.src,'"></image>');for(var b=0,c=this.getObjects(),d=c.length;b<d;b++)a.push(c[b].toSVG());a.push("</svg>");return a.join("")},isEmpty:function(){return 0===this._objects.length},remove:function(a){this.getActiveObject()===
a&&(this.fire("before:selection:cleared",{target:a}),this.discardActiveObject(),this.fire("selection:cleared"));var b=this._objects,c=b.indexOf(a);-1!==c&&(b.splice(c,1),this.fire("object:removed",{target:a}));this.renderAll();return a},sendToBack:function(a){b(this._objects,a);this._objects.unshift(a);return this.renderAll()},bringToFront:function(a){b(this._objects,a);this._objects.push(a);return this.renderAll()},sendBackwards:function(a){var c=this._objects.indexOf(a),d=c;if(0!==c){for(c-=1;0<=
c;--c)if(a.intersectsWithObject(this._objects[c])||a.isContainedWithinObject(this._objects[c])||this._objects[c].isContainedWithinObject(a)){d=c;break}b(this._objects,a);this._objects.splice(d,0,a)}return this.renderAll()},bringForward:function(a){var c=this.getObjects(),d=c.indexOf(a),e=d;if(d!==c.length-1){for(var d=d+1,r=this._objects.length;d<r;++d)if(a.intersectsWithObject(c[d])||a.isContainedWithinObject(this._objects[d])||this._objects[d].isContainedWithinObject(a)){e=d;break}b(c,a);c.splice(e,
0,a)}this.renderAll()},item:function(a){return this.getObjects()[a]},complexity:function(){return this.getObjects().reduce(function(a,b){return a+=b.complexity?b.complexity():0},0)},forEachObject:function(a,b){for(var c=this.getObjects(),d=c.length;d--;)a.call(b,c[d],d,c);return this},dispose:function(){this.clear();this.interactive&&(e(this.upperCanvasEl,"mousedown",this._onMouseDown),e(this.upperCanvasEl,"mousemove",this._onMouseMove),e(fabric.window,"resize",this._onResize));return this},_resizeImageToFit:function(a){var b=
a.width||a.offsetWidth,c=this.getWidth()/b;b&&(a.width=b*c)}});fabric.StaticCanvas.prototype.toString=function(){return"#<fabric.Canvas ("+this.complexity()+"): { objects: "+this.getObjects().length+" }>"};a(fabric.StaticCanvas,{EMPTY_JSON:'{"objects": [], "background": "white"}',toGrayscale:function(a){var b=a.getContext("2d");a=b.getImageData(0,0,a.width,a.height);var c=a.data,d=a.width,e=a.height,u,q,v,t;for(v=0;v<d;v++)for(t=0;t<e;t++)u=4*v*e+4*t,q=(c[u]+c[u+1]+c[u+2])/3,c[u]=q,c[u+1]=q,c[u+2]=
q;b.putImageData(a,0,0)},supports:function(a){var b=fabric.util.createCanvasElement();if(!b||!b.getContext)return null;var c=b.getContext("2d");if(!c)return null;switch(a){case "getImageData":return"undefined"!==typeof c.getImageData;case "toDataURL":return"undefined"!==typeof b.toDataURL;case "toDataURLWithQuality":try{return b.toDataURL("image/jpeg",0),!0}catch(d){}return!1;default:return null}}});fabric.StaticCanvas.prototype.toJSON=fabric.StaticCanvas.prototype.toObject}})();
(function(a){var c=a.fabric||(a.fabric={}),b=c.util.array.min,e=c.util.array.max;c.FreeDrawing?c.warn("fabric.FreeDrawing is already defined"):c.FreeDrawing=c.util.createClass({initialize:function(a){this.canvas=a;this._points=[]},_addPoint:function(a){this._points.push(a)},_reset:function(){this._points.length=0;var a=this.canvas.contextTop;a.strokeStyle=this.canvas.freeDrawingColor;a.lineWidth=this.canvas.freeDrawingLineWidth;a.lineCap=a.lineJoin="round"},_prepareForDrawing:function(a){this.canvas._isCurrentlyDrawing=
!0;this.canvas.discardActiveObject().renderAll();a=new c.Point(a.x,a.y);this._reset();this._addPoint(a);this.canvas.contextTop.moveTo(a.x,a.y)},_captureDrawingPath:function(a){a=new c.Point(a.x,a.y);this._addPoint(a)},_render:function(){var a=this.canvas.contextTop;a.beginPath();var b=this._points[0],c=this._points[1];a.moveTo(b.x,b.y);for(var e=1,m=this._points.length;e<m;e++)c=b.midPointFrom(c),a.quadraticCurveTo(b.x,b.y,c.x,c.y),b=this._points[e],c=this._points[e+1];a.lineTo(b.x,b.y);a.stroke()},
_getSVGPathData:function(){this.box=this.getPathBoundingBox(this._points);return this.convertPointsToSVGPath(this._points,this.box.minx,this.box.maxx,this.box.miny,this.box.maxy)},getPathBoundingBox:function(a){for(var c=[],g=[],h=a[0],m=a[1],r=h,u=1,q=a.length;u<q;u++){var v=h.midPointFrom(m);c.push(r.x);c.push(v.x);g.push(r.y);g.push(v.y);h=a[u];m=a[u+1];r=v}c.push(h.x);g.push(h.y);return{minx:b(c),miny:b(g),maxx:e(c),maxy:e(g)}},convertPointsToSVGPath:function(a,b,e,h,m){e=[];m=new c.Point(a[0].x-
b,a[0].y-h);var r=new c.Point(a[1].x-b,a[1].y-h);e.push("M ",a[0].x-b," ",a[0].y-h," ");for(var u=1,q=a.length;u<q;u++){var v=m.midPointFrom(r);e.push("Q ",m.x," ",m.y," ",v.x," ",v.y," ");m=new c.Point(a[u].x-b,a[u].y-h);u+1<a.length&&(r=new c.Point(a[u+1].x-b,a[u+1].y-h))}e.push("L ",m.x," ",m.y," ");return e},createPath:function(a){a=new c.Path(a);a.fill=null;a.stroke=this.color;a.strokeWidth=this.width;return a},_finalizeAndAddPath:function(){this.canvas._isCurrentlyDrawing=!1;this.canvas.contextTop.closePath();
var a=this._getSVGPathData().join("");if("M 0 0 Q 0 0 0 0 L 0 0"===a)this.canvas.renderAll();else{var b=this.box.minx+(this.box.maxx-this.box.minx)/2,c=this.box.miny+(this.box.maxy-this.box.miny)/2;this.canvas.contextTop.arc(b,c,3,0,2*Math.PI,!1);a=this.createPath(a);a.set({left:b,top:c});this.canvas.add(a);a.setCoords();this.canvas.contextTop&&this.canvas.clearContext(this.canvas.contextTop);this.canvas.renderAll();this.canvas.fire("path:created",{path:a})}}})})("undefined"!==typeof exports?exports:
this);
(function(){function a(){}var c=fabric.util.object.extend,b=fabric.util.getPointer,e=fabric.util.degreesToRadians,d=fabric.util.radiansToDegrees,f=Math.atan2,g=Math.abs,h=Math.min,m=Math.max;fabric.Canvas=function(a,b){b||(b={});this._initStatic(a,b);this._initInteractive();this._createCacheCanvas();fabric.Canvas.activeInstance=this};a.prototype=fabric.StaticCanvas.prototype;fabric.Canvas.prototype=new a;fabric.Canvas.prototype.toString=fabric.StaticCanvas.prototype.toString;c(fabric.Canvas.prototype,{uniScaleTransform:!1,
centerTransform:!1,interactive:!0,selection:!0,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,freeDrawingColor:"rgb(0, 0, 0)",freeDrawingLineWidth:1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",rotationCursor:"crosshair",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,_initInteractive:function(){this._groupSelector=this._currentTransform=
null;this.freeDrawing=fabric.FreeDrawing&&new fabric.FreeDrawing(this);this._initWrapperElement();this._createUpperCanvas();this._initEvents();this.calcOffset()},_resetCurrentTransform:function(a){var b=this._currentTransform;b.target.set("scaleX",b.original.scaleX);b.target.set("scaleY",b.original.scaleY);b.target.set("left",b.original.left);b.target.set("top",b.original.top);a.altKey||this.centerTransform?("center"!==b.originX&&(b.mouseXSign="right"===b.originX?-1:1),"center"!==b.originY&&(b.mouseYSign=
"bottom"===b.originY?-1:1),b.originX="center",b.originY="center"):(b.originX=b.original.originX,b.originY=b.original.originY)},containsPoint:function(a,b){var c=this.getPointer(a),d=this._normalizePointer(b,c),c=d.x,d=d.y,e=b._getImageLines(b.oCoords);return(c=b._findCrossPoints(c,d,e))&&1===c%2||b._findTargetCorner(a,this._offset)?!0:!1},_normalizePointer:function(a,b){var c=this.getActiveGroup(),d=b.x,e=b.y;c&&("group"!==a.type&&c.contains(a))&&(d-=c.left,e-=c.top);return{x:d,y:e}},_isTargetTransparent:function(a,
b,c){var d=this.contextCache,e=a.hasBorders,f=a.transparentCorners;a.hasBorders=a.transparentCorners=!1;this._draw(d,a);a.hasBorders=e;a.transparentCorners=f;0<this.targetFindTolerance&&(b=b>this.targetFindTolerance?b-this.targetFindTolerance:0,c=c>this.targetFindTolerance?c-this.targetFindTolerance:0);a=!0;b=d.getImageData(b,c,2*this.targetFindTolerance||1,2*this.targetFindTolerance||1);for(c=3;c<b.data.length&&!(a=0>=b.data[c],!1===a);c+=4);this.clearContext(d);return a},_shouldClearSelection:function(a){var b=
this.findTarget(a),c=this.getActiveGroup();return!b||b&&c&&!c.contains(b)&&c!==b&&!a.shiftKey},_setupCurrentTransform:function(a,c){var d="drag",f,g=b(a,c.canvas.upperCanvasEl);(f=c._findTargetCorner(a,this._offset))&&(d="ml"===f||"mr"===f?"scaleX":"mt"===f||"mb"===f?"scaleY":"mtr"===f?"rotate":"scale");var h="center",m="center";if("ml"===f||"tl"===f||"bl"===f)h="right";else if("mr"===f||"tr"===f||"br"===f)h="left";if("tl"===f||"mt"===f||"tr"===f)m="bottom";else if("bl"===f||"mb"===f||"br"===f)m=
"top";"mtr"===f&&(m=h="center");this._currentTransform={target:c,action:d,scaleX:c.scaleX,scaleY:c.scaleY,offsetX:g.x-c.left,offsetY:g.y-c.top,originX:h,originY:m,ex:g.x,ey:g.y,left:c.left,top:c.top,theta:e(c.angle),width:c.width*c.scaleX,mouseXSign:1,mouseYSign:1};this._currentTransform.original={left:c.left,top:c.top,scaleX:c.scaleX,scaleY:c.scaleY,originX:h,originY:m};this._resetCurrentTransform(a)},_shouldHandleGroupLogic:function(a,b){var c=this.getActiveObject();return a.shiftKey&&(this.getActiveGroup()||
c&&c!==b)&&this.selection},_handleGroupLogic:function(a,b){if(b===this.getActiveGroup()&&(b=this.findTarget(a,!0),!b||b.isType("group")))return;var c=this.getActiveGroup();c?(c.contains(b)?(c.removeWithUpdate(b),this._resetObjectTransform(c),b.setActive(!1),1===c.size()&&this.discardActiveGroup()):(c.addWithUpdate(b),this._resetObjectTransform(c)),this.fire("selection:created",{target:c,e:a}),c.setActive(!0)):(this._activeObject&&b!==this._activeObject&&(c=new fabric.Group([this._activeObject,b]),
this.setActiveGroup(c),c=this.getActiveGroup()),b.setActive(!0));c&&c.saveCoords()},_translateObject:function(a,b){var c=this._currentTransform.target;c.get("lockMovementX")||c.set("left",a-this._currentTransform.offsetX);c.get("lockMovementY")||c.set("top",b-this._currentTransform.offsetY)},_scaleObject:function(a,b,c){var d=this._currentTransform,e=this._offset,f=d.target,g=f.get("lockScalingX"),h=f.get("lockScalingY");if(!g||!h){var m=f.translateToOriginPoint(f.getCenterPoint(),d.originX,d.originY);
b=f.toLocalPoint(new fabric.Point(a-e.left,b-e.top),d.originX,d.originY);"right"===d.originX?b.x*=-1:"center"===d.originX&&(b.x*=2*d.mouseXSign,0>b.x&&(d.mouseXSign=-d.mouseXSign));"bottom"===d.originY?b.y*=-1:"center"===d.originY&&(b.y*=2*d.mouseYSign,0>b.y&&(d.mouseYSign=-d.mouseYSign));a=f.scaleX;e=f.scaleY;"equally"===c&&!g&&!h?(c=b.y+b.x,g=f.height*d.original.scaleY+f.width*d.original.scaleX+2*f.padding-2*f.strokeWidth+1,a=d.original.scaleX*c/g,e=d.original.scaleY*c/g,f.set("scaleX",a),f.set("scaleY",
e)):c?"x"===c&&!f.get("lockUniScaling")?(a=b.x/(f.width+f.padding),g||f.set("scaleX",a)):"y"===c&&!f.get("lockUniScaling")&&(e=b.y/(f.height+f.padding),h||f.set("scaleY",e)):(a=b.x/(f.width+f.padding),e=b.y/(f.height+f.padding),g||f.set("scaleX",a),h||f.set("scaleY",e));0>a&&("left"===d.originX?d.originX="right":"right"===d.originX&&(d.originX="left"));0>e&&("top"===d.originY?d.originY="bottom":"bottom"===d.originY&&(d.originY="top"));f.setPositionByOrigin(m,d.originX,d.originY)}},_rotateObject:function(a,
b){var c=this._currentTransform,e=this._offset;if(!c.target.get("lockRotation")){var g=f(c.ey-c.top-e.top,c.ex-c.left-e.left),e=f(b-c.top-e.top,a-c.left-e.left);c.target.angle=d(e-g+c.theta)}},_setCursor:function(a){this.upperCanvasEl.style.cursor=a},_resetObjectTransform:function(a){a.scaleX=1;a.scaleY=1;a.setAngle(0)},_drawSelection:function(){var a=this.contextTop,b=this._groupSelector,c=b.left,d=b.top,e=g(c),f=g(d);a.fillStyle=this.selectionColor;a.fillRect(b.ex-(0<c?0:-c),b.ey-(0<d?0:-d),e,f);
a.lineWidth=this.selectionLineWidth;a.strokeStyle=this.selectionBorderColor;1<this.selectionDashArray.length?(c=b.ex+0.5-(0<c?0:e),b=b.ey+0.5-(0<d?0:f),a.beginPath(),fabric.util.drawDashedLine(a,c,b,c+e,b,this.selectionDashArray),fabric.util.drawDashedLine(a,c,b+f-1,c+e,b+f-1,this.selectionDashArray),fabric.util.drawDashedLine(a,c,b,c,b+f,this.selectionDashArray),fabric.util.drawDashedLine(a,c+e-1,b,c+e-1,b+f,this.selectionDashArray),a.closePath(),a.stroke()):a.strokeRect(b.ex+0.5-(0<c?0:e),b.ey+
0.5-(0<d?0:f),e,f)},_findSelectedObjects:function(a){for(var b=[],c=this._groupSelector.ex,d=this._groupSelector.ey,e=c+this._groupSelector.left,f=d+this._groupSelector.top,g=new fabric.Point(h(c,e),h(d,f)),d=new fabric.Point(m(c,e),m(d,f)),e=0,f=this._objects.length;e<f;++e)if((c=this._objects[e])&&(c.intersectsWithRect(g,d)||c.isContainedWithinRect(g,d))&&this.selection&&c.selectable)c.setActive(!0),b.push(c);1===b.length?this.setActiveObject(b[0],a):1<b.length&&(b=new fabric.Group(b),this.setActiveGroup(b),
b.saveCoords(),this.fire("selection:created",{target:b}));this.renderAll()},findTarget:function(a,b){var c,d=this.getPointer(a);if(this.controlsAboveOverlay&&this.lastRenderedObjectWithControlsAboveOverlay&&this.containsPoint(a,this.lastRenderedObjectWithControlsAboveOverlay)&&this.lastRenderedObjectWithControlsAboveOverlay._findTargetCorner(a,this._offset))return c=this.lastRenderedObjectWithControlsAboveOverlay;var e=this.getActiveGroup();if(e&&!b&&this.containsPoint(a,e))return e;e=[];for(d=this._objects.length;d--;)if(this._objects[d]&&
this.containsPoint(a,this._objects[d]))if(this.perPixelTargetFind||this._objects[d].perPixelTargetFind)e[e.length]=this._objects[d];else{this.relatedTarget=c=this._objects[d];break}for(var f=0,g=e.length;f<g;f++)if(d=this.getPointer(a),!this._isTargetTransparent(e[f],d.x,d.y)){this.relatedTarget=c=e[f];break}if(c&&c.selectable)return c},getPointer:function(a){a=b(a,this.upperCanvasEl);return{x:a.x-this._offset.left,y:a.y-this._offset.top}},_createUpperCanvas:function(){this.upperCanvasEl=this._createCanvasElement();
this.upperCanvasEl.className="upper-canvas";this.wrapperEl.appendChild(this.upperCanvasEl);this._applyCanvasStyle(this.upperCanvasEl);this.contextTop=this.upperCanvasEl.getContext("2d")},_createCacheCanvas:function(){this.cacheCanvasEl=this._createCanvasElement();this.cacheCanvasEl.setAttribute("width",this.width);this.cacheCanvasEl.setAttribute("height",this.height);this.contextCache=this.cacheCanvasEl.getContext("2d")},_initWrapperElement:function(){this.wrapperEl=fabric.util.wrapElement(this.lowerCanvasEl,
"div",{"class":this.containerClass});fabric.util.setStyle(this.wrapperEl,{width:this.getWidth()+"px",height:this.getHeight()+"px",position:"relative"});fabric.util.makeElementUnselectable(this.wrapperEl)},_applyCanvasStyle:function(a){var b=this.getWidth()||a.width,c=this.getHeight()||a.height;fabric.util.setStyle(a,{position:"absolute",width:b+"px",height:c+"px",left:0,top:0});a.width=b;a.height=c;fabric.util.makeElementUnselectable(a)},getSelectionContext:function(){return this.contextTop},getSelectionElement:function(){return this.upperCanvasEl},
setActiveObject:function(a,b){this._activeObject&&this._activeObject.setActive(!1);this._activeObject=a;a.setActive(!0);this.renderAll();this.fire("object:selected",{target:a,e:b});a.fire("selected",{e:b});return this},getActiveObject:function(){return this._activeObject},discardActiveObject:function(){this._activeObject&&this._activeObject.setActive(!1);this._activeObject=null;return this},setActiveGroup:function(a){if(this._activeGroup=a)a.canvas=this,a.setActive(!0);return this},getActiveGroup:function(){return this._activeGroup},
discardActiveGroup:function(){var a=this.getActiveGroup();a&&a.destroy();return this.setActiveGroup(null)},deactivateAll:function(){for(var a=this.getObjects(),b=0,c=a.length;b<c;b++)a[b].setActive(!1);this.discardActiveGroup();this.discardActiveObject();return this},deactivateAllWithDispatch:function(){var a=this.getActiveGroup()||this.getActiveObject();a&&this.fire("before:selection:cleared",{target:a});this.deactivateAll();a&&this.fire("selection:cleared");return this}});for(var r in fabric.StaticCanvas)"prototype"!==
r&&(fabric.Canvas[r]=fabric.StaticCanvas[r]);fabric.isTouchSupported&&(fabric.Canvas.prototype._setCursorFromEvent=function(){});fabric.Element=fabric.Canvas})();
(function(){var a={tr:"ne-resize",br:"se-resize",bl:"sw-resize",tl:"nw-resize",ml:"w-resize",mt:"n-resize",mr:"e-resize",mb:"s-resize"},c=fabric.util.addListener,b=fabric.util.removeListener,e=fabric.util.getPointer;fabric.util.object.extend(fabric.Canvas.prototype,{_initEvents:function(){var a=this;this._onMouseDown=this._onMouseDown.bind(this);this._onMouseMove=this._onMouseMove.bind(this);this._onMouseUp=this._onMouseUp.bind(this);this._onResize=this._onResize.bind(this);c(fabric.window,"resize",
this._onResize);fabric.isTouchSupported?(c(this.upperCanvasEl,"touchstart",this._onMouseDown),c(this.upperCanvasEl,"touchmove",this._onMouseMove),"undefined"!==typeof Event&&"add"in Event&&Event.add(this.upperCanvasEl,"gesture",function(b,c){a.__onTransformGesture(b,c)})):(c(this.upperCanvasEl,"mousedown",this._onMouseDown),c(this.upperCanvasEl,"mousemove",this._onMouseMove))},_onMouseDown:function(a){this.__onMouseDown(a);!fabric.isTouchSupported&&c(fabric.document,"mouseup",this._onMouseUp);fabric.isTouchSupported&&
c(fabric.document,"touchend",this._onMouseUp);!fabric.isTouchSupported&&c(fabric.document,"mousemove",this._onMouseMove);fabric.isTouchSupported&&c(fabric.document,"touchmove",this._onMouseMove);!fabric.isTouchSupported&&b(this.upperCanvasEl,"mousemove",this._onMouseMove);fabric.isTouchSupported&&b(this.upperCanvasEl,"touchmove",this._onMouseMove)},_onMouseUp:function(a){this.__onMouseUp(a);!fabric.isTouchSupported&&b(fabric.document,"mouseup",this._onMouseUp);fabric.isTouchSupported&&b(fabric.document,
"touchend",this._onMouseUp);!fabric.isTouchSupported&&b(fabric.document,"mousemove",this._onMouseMove);fabric.isTouchSupported&&b(fabric.document,"touchmove",this._onMouseMove);!fabric.isTouchSupported&&c(this.upperCanvasEl,"mousemove",this._onMouseMove);fabric.isTouchSupported&&c(this.upperCanvasEl,"touchmove",this._onMouseMove)},_onMouseMove:function(a){a.preventDefault&&a.preventDefault();this.__onMouseMove(a)},_onResize:function(){this.calcOffset()},__onMouseUp:function(a){var b;if(this.isDrawingMode&&
this._isCurrentlyDrawing)this.freeDrawing._finalizeAndAddPath(),this.fire("mouse:up",{e:a});else{if(this._currentTransform){b=this._currentTransform.target;b._scaling&&(b._scaling=!1);for(var c=this._objects.length;c--;)this._objects[c].setCoords();b.isMoving=!1;this.stateful&&b.hasStateChanged()&&(this.fire("object:modified",{target:b}),b.fire("modified"));this._previousOriginX&&(this._currentTransform.target.adjustPosition(this._previousOriginX),this._previousOriginX=null)}this._currentTransform=
null;this._groupSelector&&this._findSelectedObjects(a);if(c=this.getActiveGroup())c.setObjectsCoords(),c.set("isMoving",!1),this._setCursor(this.defaultCursor);this._groupSelector=null;this.renderAll();this._setCursorFromEvent(a,b);this._setCursor("");var e=this;setTimeout(function(){e._setCursorFromEvent(a,b)},50);this.fire("mouse:up",{target:b,e:a});b&&b.fire("mouseup",{e:a})}},__onMouseDown:function(a){var b;if(("which"in a?1===a.which:1===a.button)||fabric.isTouchSupported)if(this.isDrawingMode)b=
this.getPointer(a),this.freeDrawing._prepareForDrawing(b),this.freeDrawing._captureDrawingPath(b),this.fire("mouse:down",{e:a});else if(!this._currentTransform){var c=this.findTarget(a),e;b=this.getPointer(a);if(this._shouldClearSelection(a))this._groupSelector={ex:b.x,ey:b.y,top:0,left:0},this.deactivateAllWithDispatch();else{this.stateful&&c.saveState();if(e=c._findTargetCorner(a,this._offset))this.onBeforeScaleRotate(c);this._shouldHandleGroupLogic(a,c)?(this._handleGroupLogic(a,c),c=this.getActiveGroup()):
(c!==this.getActiveGroup()&&this.deactivateAll(),this.setActiveObject(c,a));this._setupCurrentTransform(a,c)}this.renderAll();this.fire("mouse:down",{target:c,e:a});c&&c.fire("mousedown",{e:a});"mtr"===e&&(this._previousOriginX=this._currentTransform.target.originX,this._currentTransform.target.adjustPosition("center"),this._currentTransform.left=this._currentTransform.target.left,this._currentTransform.top=this._currentTransform.target.top)}},__onMouseMove:function(a){var b,c;if(this.isDrawingMode)this._isCurrentlyDrawing&&
(c=this.getPointer(a),this.freeDrawing._captureDrawingPath(c),this.clearContext(this.contextTop),this.freeDrawing._render(this.contextTop)),this.upperCanvasEl.style.cursor=this.freeDrawingCursor,this.fire("mouse:move",{e:a});else{var h=this._groupSelector;if(null!==h)c=e(a,this.upperCanvasEl),h.left=c.x-this._offset.left-h.ex,h.top=c.y-this._offset.top-h.ey,this.renderTop();else if(this._currentTransform){c=e(a,this.upperCanvasEl);h=c.x;c=c.y;this._currentTransform.target.isMoving=!0;var m=this._currentTransform,
r=!1;if(("scale"===m.action||"scaleX"===m.action||"scaleY"===m.action)&&(a.altKey&&("center"!==m.originX||"center"!==m.originY)||!a.altKey&&"center"===m.originX&&"center"===m.originY))this._resetCurrentTransform(a),r=!0;"rotate"===this._currentTransform.action?(this._rotateObject(h,c),this.fire("object:rotating",{target:this._currentTransform.target,e:a}),this._currentTransform.target.fire("rotating")):"scale"===this._currentTransform.action?(a.shiftKey||this.uniScaleTransform?(this._currentTransform.currentAction=
"scale",this._scaleObject(h,c)):(!r&&"scale"===m.currentAction&&this._resetCurrentTransform(a),this._currentTransform.currentAction="scaleEqually",this._scaleObject(h,c,"equally")),this.fire("object:scaling",{target:this._currentTransform.target,e:a})):"scaleX"===this._currentTransform.action?(this._scaleObject(h,c,"x"),this.fire("object:scaling",{target:this._currentTransform.target,e:a}),this._currentTransform.target.fire("scaling",{e:a})):"scaleY"===this._currentTransform.action?(this._scaleObject(h,
c,"y"),this.fire("object:scaling",{target:this._currentTransform.target,e:a}),this._currentTransform.target.fire("scaling",{e:a})):(this._translateObject(h,c),this.fire("object:moving",{target:this._currentTransform.target,e:a}),this._setCursor(this.moveCursor),this._currentTransform.target.fire("moving",{e:a}));this.renderAll()}else if(h=this.upperCanvasEl.style,b=this.findTarget(a))this._setCursorFromEvent(a,b);else{for(c=this._objects.length;c--;)this._objects[c]&&!this._objects[c].active&&this._objects[c].setActive(!1);
h.cursor=this.defaultCursor}this.fire("mouse:move",{target:b,e:a});b&&b.fire("mousemove",{e:a})}},_setCursorFromEvent:function(b,c){var e=this.upperCanvasEl.style;if(c){var h=this.getActiveGroup();if(h=c._findTargetCorner&&(!h||!h.contains(c))&&c._findTargetCorner(b,this._offset))if(h in a)e.cursor=a[h];else if("mtr"===h&&c.hasRotatingPoint)e.cursor=this.rotationCursor;else return e.cursor=this.defaultCursor,!1;else e.cursor=this.hoverCursor}else return e.cursor=this.defaultCursor,!1;return!0}})})();
fabric.util.object.extend(fabric.StaticCanvas.prototype,{FX_DURATION:500,fxCenterObjectH:function(a,c){c=c||{};var b=function(){},e=c.onComplete||b,d=c.onChange||b,f=this;fabric.util.animate({startValue:a.get("left"),endValue:this.getCenter().left,duration:this.FX_DURATION,onChange:function(b){a.set("left",b);f.renderAll();d()},onComplete:function(){a.setCoords();e()}});return this},fxCenterObjectV:function(a,c){c=c||{};var b=function(){},e=c.onComplete||b,d=c.onChange||b,f=this;fabric.util.animate({startValue:a.get("top"),
endValue:this.getCenter().top,duration:this.FX_DURATION,onChange:function(b){a.set("top",b);f.renderAll();d()},onComplete:function(){a.setCoords();e()}});return this},fxRemove:function(a,c){c=c||{};var b=function(){},e=c.onComplete||b,d=c.onChange||b,f=this;fabric.util.animate({startValue:a.get("opacity"),endValue:0,duration:this.FX_DURATION,onStart:function(){a.setActive(!1)},onChange:function(b){a.set("opacity",b);f.renderAll();d()},onComplete:function(){f.remove(a);e()}});return this}});
fabric.util.object.extend(fabric.StaticCanvas.prototype,{loadFromDatalessJSON:function(a,c){if(a){var b="string"===typeof a?JSON.parse(a):a;this.setBackgroundColor(b.background,this.renderAll.bind(this));if(b&&(!b||b.objects)){this.clear();var e=this;this._enlivenDatalessObjects(b.objects,function(){e._setBgOverlayImages(b,c)})}}},_enlivenDatalessObjects:function(a,c){function b(a,b){d.insertAt(a,b,!0);a.setCoords();++f===g&&c&&c()}function e(a,c){var d=a.paths?"paths":"path",e=a[d];delete a[d];if("string"!==
typeof e)if("image"===a.type||"group"===a.type)fabric[fabric.util.string.capitalize(a.type)].fromObject(a,function(a){b(a,c)});else{var f=fabric[fabric.util.string.camelize(fabric.util.string.capitalize(a.type))];f&&f.fromObject&&(e&&(a[d]=e),b(f.fromObject(a),c))}else if("image"===a.type)fabric.util.loadImage(e,function(d){d=new fabric.Image(d);d.setSourcePath(e);fabric.util.object.extend(d,a);d.setAngle(a.angle);b(d,c)});else if("text"===a.type)if(a.useNative)b(fabric.Text.fromObject(a),c);else{a.path=
e;var g=fabric.Text.fromObject(a);fabric.util.getScript(e,function(){"[object Opera]"===Object.prototype.toString.call(fabric.window.opera)?setTimeout(function(){b(g,c)},500):b(g,c)})}else fabric.loadSVGFromURL(e,function(d){d=fabric.util.groupSVGElements(d,a,e);d instanceof fabric.PathGroup||(fabric.util.object.extend(d,a),"undefined"!==typeof a.angle&&d.setAngle(a.angle));b(d,c)})}var d=this,f=0,g=a.length;0===g&&c&&c();try{a.forEach(e,this)}catch(h){fabric.log(h)}},loadFromJSON:function(a,c){if(a){var b=
"string"===typeof a?JSON.parse(a):a,e=this;this._enlivenObjects(b.objects,function(){e._setBgOverlayImages(b,c)});return this}},_setBgOverlayImages:function(a,c){var b=this,e,d;this.backgroundColor=a.background;a.backgroundImage?this.setBackgroundImage(a.backgroundImage,function(){b.backgroundImageOpacity=a.backgroundImageOpacity;b.backgroundImageStretch=a.backgroundImageStretch;b.renderAll();e=!0;c&&d&&c()}):e=!0;a.overlayImage?this.setOverlayImage(a.overlayImage,function(){b.overlayImageLeft=a.overlayImageLeft||
0;b.overlayImageTop=a.overlayImageTop||0;b.renderAll();d=!0;c&&e&&c()}):d=!0;!a.backgroundImage&&!a.overlayImage&&c&&c()},_enlivenObjects:function(a,c){var b=this;fabric.util.enlivenObjects(a,function(a){a.forEach(function(a,c){b.insertAt(a,c,!0)});c&&c()})},_toDataURL:function(a,c){this.clone(function(b){c(b.toDataURL(a))})},_toDataURLWithMultiplier:function(a,c,b){this.clone(function(e){b(e.toDataURLWithMultiplier(a,c))})},clone:function(a){var c=JSON.stringify(this);this.cloneWithoutData(function(b){b.loadFromJSON(c,
function(){a&&a(b)})})},cloneWithoutData:function(a){var c=fabric.document.createElement("canvas");c.width=this.getWidth();c.height=this.getHeight();var b=new fabric.Canvas(c);b.clipTo=this.clipTo;this.backgroundImage?(b.setBackgroundImage(this.backgroundImage.src,function(){b.renderAll();a&&a(b)}),b.backgroundImageOpacity=this.backgroundImageOpacity,b.backgroundImageStretch=this.backgroundImageStretch):a&&a(b)}});
(function(a){var c=a.fabric||(a.fabric={}),b=c.util.object.extend,e=c.util.toFixed,d=c.util.string.capitalize,f=c.util.degreesToRadians;if(!c.Object){var g=a.Image;try{var h="undefined"!==typeof require&&require("canvas").Image;h&&(g=h)}catch(m){c.log(m)}c.Object=c.util.createClass({type:"object",originX:"center",originY:"center",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,cornerSize:12,transparentCorners:!0,padding:0,borderColor:"rgba(102,153,255,0.75)",cornerColor:"rgba(102,153,255,0.5)",
fill:"rgb(0,0,0)",fillRule:"source-over",overlayFill:null,stroke:null,strokeWidth:1,strokeDashArray:null,shadow:null,borderOpacityWhenMoving:0.4,borderScaleFactor:1,transformMatrix:null,minScaleLimit:0.01,selectable:!0,hasControls:!0,hasBorders:!0,hasRotatingPoint:!0,rotatingPointOffset:40,perPixelTargetFind:!1,includeDefaultValues:!0,stateProperties:"top left width height scaleX scaleY flipX flipY angle opacity cornerSize fill overlayFill originX originY stroke strokeWidth strokeDashArray fillRule borderScaleFactor transformMatrix selectable shadow".split(" "),
initialize:function(a){a&&this.setOptions(a)},_initGradient:function(a){a.fill&&(a.fill.colorStops&&!(a.fill instanceof c.Gradient))&&this.set("fill",new c.Gradient(a.fill))},_initPattern:function(a){a.fill&&(a.fill.source&&!(a.fill instanceof c.Pattern))&&this.set("fill",new c.Pattern(a.fill));a.stroke&&(a.stroke.source&&!(a.stroke instanceof c.Pattern))&&this.set("stroke",new c.Pattern(a.stroke))},_initShadow:function(a){a.shadow&&!(a.shadow instanceof c.Shadow)&&this.setShadow(a.shadow)},setOptions:function(a){for(var b in a)this.set(b,
a[b]);this._initGradient(a);this._initPattern(a);this._initShadow(a)},transform:function(a){a.globalAlpha=this.opacity;var b=this.getCenterPoint();a.translate(b.x,b.y);a.rotate(f(this.angle));a.scale(this.scaleX*(this.flipX?-1:1),this.scaleY*(this.flipY?-1:1))},toObject:function(a){var b=c.Object.NUM_FRACTION_DIGITS,b={type:this.type,originX:this.originX,originY:this.originY,left:e(this.left,b),top:e(this.top,b),width:e(this.width,b),height:e(this.height,b),fill:this.fill&&this.fill.toObject?this.fill.toObject():
this.fill,overlayFill:this.overlayFill,stroke:this.stroke&&this.stroke.toObject?this.stroke.toObject():this.stroke,strokeWidth:this.strokeWidth,strokeDashArray:this.strokeDashArray,scaleX:e(this.scaleX,b),scaleY:e(this.scaleY,b),angle:e(this.getAngle(),b),flipX:this.flipX,flipY:this.flipY,opacity:e(this.opacity,b),selectable:this.selectable,hasControls:this.hasControls,hasBorders:this.hasBorders,hasRotatingPoint:this.hasRotatingPoint,transparentCorners:this.transparentCorners,perPixelTargetFind:this.perPixelTargetFind,
shadow:this.shadow&&this.shadow.toObject?this.shadow.toObject():this.shadow};this.includeDefaultValues||(b=this._removeDefaultValues(b));c.util.populateWithProperties(this,b,a);return b},toDatalessObject:function(a){return this.toObject(a)},getSvgStyles:function(){return["stroke: ",this.stroke?this.stroke:"none","; stroke-width: ",this.strokeWidth?this.strokeWidth:"0","; stroke-dasharray: ",this.strokeDashArray?this.strokeDashArray.join(" "):"; ","fill: ",this.fill?this.fill:"none","; opacity: ",
this.opacity?this.opacity:"1",";"].join("")},getSvgTransform:function(){var a=this.getAngle(),b=this.getCenterPoint(),d=c.Object.NUM_FRACTION_DIGITS,b="translate("+e(b.x,d)+" "+e(b.y,d)+")",a=0!==a?" rotate("+e(a,d)+")":"",d=1===this.scaleX&&1===this.scaleY?"":" scale("+e(this.scaleX,d)+" "+e(this.scaleY,d)+")";return[b,a,d,this.flipX?"matrix(-1 0 0 1 0 0) ":"",this.flipY?"matrix(1 0 0 -1 0 0)":""].join("")},_removeDefaultValues:function(a){var b=c.Object.prototype.options;b&&this.stateProperties.forEach(function(c){a[c]===
b[c]&&delete a[c]});return a},isActive:function(){return!!this.active},setActive:function(a){this.active=!!a;return this},toString:function(){return"#<fabric."+d(this.type)+">"},get:function(a){return this[a]},set:function(a,b){if("object"===typeof a)for(var c in a)this._set(c,a[c]);else"function"===typeof b?this._set(a,b(this.get(a))):this._set(a,b);return this},_set:function(a,b){if("scaleX"===a||"scaleY"===a)b=this._constrainScale(b);if("scaleX"===a&&0>b)this.flipX=!this.flipX,b*=-1;else if("scaleY"===
a&&0>b)this.flipY=!this.flipY,b*=-1;else if("width"===a||"height"===a)this.minScaleLimit=e(Math.min(0.1,1/Math.max(this.width,this.height)),2);this[a]=b;return this},toggle:function(a){var b=this.get(a);"boolean"===typeof b&&this.set(a,!b);return this},setSourcePath:function(a){this.sourcePath=a;return this},render:function(a,b){if(!(0===this.width||0===this.height)){a.save();var c=this.transformMatrix;c&&!this.group&&a.setTransform(c[0],c[1],c[2],c[3],c[4],c[5]);b||this.transform(a);if(this.stroke||
this.strokeDashArray)a.lineWidth=this.strokeWidth,a.strokeStyle=this.stroke&&this.stroke.toLive?this.stroke.toLive(a):this.stroke;this.overlayFill?a.fillStyle=this.overlayFill:this.fill&&(a.fillStyle=this.fill.toLive?this.fill.toLive(a):this.fill);c&&this.group&&(a.translate(-this.group.width/2,-this.group.height/2),a.transform(c[0],c[1],c[2],c[3],c[4],c[5]));this._setShadow(a);this._render(a,b);this._removeShadow(a);this.active&&!b&&(this.drawBorders(a),this.hideCorners||this.drawCorners(a));a.restore()}},
_setShadow:function(a){this.shadow&&(a.shadowColor=this.shadow.color,a.shadowBlur=this.shadow.blur,a.shadowOffsetX=this.shadow.offsetX,a.shadowOffsetY=this.shadow.offsetY)},_removeShadow:function(a){a.shadowColor="";a.shadowBlur=a.shadowOffsetX=a.shadowOffsetY=0},clone:function(a,b){return this.constructor.fromObject?this.constructor.fromObject(this.toObject(b),a):new c.Object(this.toObject(b))},cloneAsImage:function(a){if(c.Image){var b=new g;b.onload=function(){a&&a(new c.Image(b),d);b=b.onload=
null};var d={angle:this.get("angle"),flipX:this.get("flipX"),flipY:this.get("flipY")};this.set("angle",0).set("flipX",!1).set("flipY",!1);this.toDataURL(function(a){b.src=a})}return this},toDataURL:function(a){function b(c){c.left=d.width/2;c.top=d.height/2;c.setActive(!1);e.add(c);c=e.toDataURL("png");e.dispose();e=null;a&&a(c)}var d=c.util.createCanvasElement();d.width=this.getBoundingRectWidth();d.height=this.getBoundingRectHeight();c.util.wrapElement(d,"div");var e=new c.Canvas(d);e.backgroundColor=
"transparent";e.renderAll();this.constructor.async?this.clone(b):b(this.clone())},hasStateChanged:function(){return this.stateProperties.some(function(a){return this[a]!==this.originalState[a]},this)},saveState:function(){this.stateProperties.forEach(function(a){this.originalState[a]=this.get(a)},this);return this},setupState:function(){this.originalState={};this.saveState()},isType:function(a){return this.type===a},toGrayscale:function(){var a=this.get("fill");a&&this.set("overlayFill",(new c.Color(a)).toGrayscale().toRgb());
return this},complexity:function(){return 0},toJSON:function(a){return this.toObject(a)},setGradientFill:function(a){this.set("fill",c.Gradient.forObject(this,a))},setPatternFill:function(a){this.set("fill",new c.Pattern(a))},setShadow:function(a){this.set("shadow",new c.Shadow(a))},animate:function(){if(arguments[0]&&"object"===typeof arguments[0])for(var a in arguments[0])this._animate(a,arguments[0][a],arguments[1]);else this._animate.apply(this,arguments);return this},_animate:function(a,b,d){var e=
this;b=b.toString();d=d?c.util.object.clone(d):{};"from"in d||(d.from=this.get(a));b=~b.indexOf("=")?this.get(a)+parseFloat(b.replace("=","")):parseFloat(b);c.util.animate({startValue:d.from,endValue:b,byValue:d.by,easing:d.easing,duration:d.duration,onChange:function(b){e.set(a,b);d.onChange&&d.onChange()},onComplete:function(){e.setCoords();d.onComplete&&d.onComplete()}})},centerH:function(){this.canvas.centerObjectH(this);return this},centerV:function(){this.canvas.centerObjectV(this);return this},
center:function(){return this.centerH().centerV()},remove:function(){return this.canvas.remove(this)},sendToBack:function(){this.canvas.sendToBack(this);return this},bringToFront:function(){this.canvas.bringToFront(this);return this},sendBackwards:function(){this.canvas.sendBackwards(this);return this},bringForward:function(){this.canvas.bringForward(this);return this}});a=c.Object.prototype;for(h=a.stateProperties.length;h--;){var r=a.stateProperties[h],u=r.charAt(0).toUpperCase()+r.slice(1),q="set"+
u,u="get"+u;a[u]||(a[u]=new Function('return this.get("'+r+'")'));a[q]||(a[q]=new Function("value",'return this.set("'+r+'", value)'))}c.Object.prototype.rotate=c.Object.prototype.setAngle;b(c.Object.prototype,c.Observable);c.Object.NUM_FRACTION_DIGITS=2}})("undefined"!==typeof exports?exports:this);
(function(){var a=fabric.util.degreesToRadians;fabric.util.object.extend(fabric.Object.prototype,{translateToCenterPoint:function(c,b,e){var d=c.x,f=c.y;"left"===b?d=c.x+this.getWidth()/2:"right"===b&&(d=c.x-this.getWidth()/2);"top"===e?f=c.y+this.getHeight()/2:"bottom"===e&&(f=c.y-this.getHeight()/2);return fabric.util.rotatePoint(new fabric.Point(d,f),c,a(this.angle))},translateToOriginPoint:function(c,b,e){var d=c.x,f=c.y;"left"===b?d=c.x-this.getWidth()/2:"right"===b&&(d=c.x+this.getWidth()/2);
"top"===e?f=c.y-this.getHeight()/2:"bottom"===e&&(f=c.y+this.getHeight()/2);return fabric.util.rotatePoint(new fabric.Point(d,f),c,a(this.angle))},getCenterPoint:function(){return this.translateToCenterPoint(new fabric.Point(this.left,this.top),this.originX,this.originY)},toLocalPoint:function(c,b,e){var d=this.getCenterPoint();void 0!==b&&void 0!==e?(b="left"===b?d.x-this.getWidth()/2:"right"===b?d.x+this.getWidth()/2:d.x,e="top"===e?d.y-this.getHeight()/2:"bottom"===e?d.y+this.getHeight()/2:d.y):
(b=this.left,e=this.top);return fabric.util.rotatePoint(new fabric.Point(c.x,c.y),d,-a(this.angle)).subtractEquals(new fabric.Point(b,e))},setPositionByOrigin:function(a,b,e){a=this.translateToCenterPoint(a,b,e);a=this.translateToOriginPoint(a,this.originX,this.originY);this.set("left",a.x);this.set("top",a.y)},adjustPosition:function(c){var b=a(this.angle),e=this.getWidth()/2,d=Math.cos(b)*e,e=Math.sin(b)*e,f=this.getWidth(),g=Math.cos(b)*f,b=Math.sin(b)*f;"center"===this.originX&&"left"===c||"right"===
this.originX&&"center"===c?(this.left-=d,this.top-=e):"left"===this.originX&&"center"===c||"center"===this.originX&&"right"===c?(this.left+=d,this.top+=e):"left"===this.originX&&"right"===c?(this.left+=g,this.top+=b):"right"===this.originX&&"left"===c&&(this.left-=g,this.top-=b);this.setCoords();this.originX=c}})})();
(function(){var a=fabric.util.degreesToRadians;fabric.util.object.extend(fabric.Object.prototype,{intersectsWithRect:function(a,b){var e=this.oCoords,d=new fabric.Point(e.tl.x,e.tl.y),f=new fabric.Point(e.tr.x,e.tr.y),g=new fabric.Point(e.bl.x,e.bl.y),e=new fabric.Point(e.br.x,e.br.y);return"Intersection"===fabric.Intersection.intersectPolygonRectangle([d,f,e,g],a,b).status},intersectsWithObject:function(a){function b(a){return{tl:new fabric.Point(a.tl.x,a.tl.y),tr:new fabric.Point(a.tr.x,a.tr.y),
bl:new fabric.Point(a.bl.x,a.bl.y),br:new fabric.Point(a.br.x,a.br.y)}}var e=b(this.oCoords);a=b(a.oCoords);return"Intersection"===fabric.Intersection.intersectPolygonPolygon([e.tl,e.tr,e.br,e.bl],[a.tl,a.tr,a.br,a.bl]).status},isContainedWithinObject:function(a){return this.isContainedWithinRect(a.oCoords.tl,a.oCoords.br)},isContainedWithinRect:function(a,b){var e=this.oCoords,d=new fabric.Point(e.tl.x,e.tl.y),f=new fabric.Point(e.tr.x,e.tr.y),e=new fabric.Point(e.bl.x,e.bl.y);return d.x>a.x&&f.x<
b.x&&d.y>a.y&&e.y<b.y},getBoundingRectWidth:function(){return this.getBoundingRect().width},getBoundingRectHeight:function(){return this.getBoundingRect().height},getBoundingRect:function(){this.oCoords||this.setCoords();var a=[this.oCoords.tl.x,this.oCoords.tr.x,this.oCoords.br.x,this.oCoords.bl.x],b=fabric.util.array.min(a),a=fabric.util.array.max(a),a=Math.abs(b-a),e=[this.oCoords.tl.y,this.oCoords.tr.y,this.oCoords.br.y,this.oCoords.bl.y],d=fabric.util.array.min(e),e=fabric.util.array.max(e),
e=Math.abs(d-e);return{left:b,top:d,width:a,height:e}},getWidth:function(){return this.width*this.scaleX},getHeight:function(){return this.height*this.scaleY},_constrainScale:function(a){return Math.abs(a)<this.minScaleLimit?0>a?-this.minScaleLimit:this.minScaleLimit:a},scale:function(a){a=this._constrainScale(a);0>a&&(this.flipX=!this.flipX,this.flipY=!this.flipY,a*=-1);this.scaleY=this.scaleX=a;this.setCoords();return this},scaleToWidth:function(a){var b=this.getBoundingRectWidth()/this.getWidth();
return this.scale(a/this.width/b)},scaleToHeight:function(a){var b=this.getBoundingRectHeight()/this.getHeight();return this.scale(a/this.height/b)},setCoords:function(){var c=1<this.strokeWidth?this.strokeWidth:0,b=this.padding,e=a(this.angle);this.currentWidth=(this.width+c)*this.scaleX+2*b;this.currentHeight=(this.height+c)*this.scaleY+2*b;0>this.currentWidth&&(this.currentWidth=Math.abs(this.currentWidth));var c=Math.sqrt(Math.pow(this.currentWidth/2,2)+Math.pow(this.currentHeight/2,2)),d=Math.atan(this.currentHeight/
this.currentWidth),b=Math.cos(d+e)*c,d=Math.sin(d+e)*c,c=Math.sin(e),e=Math.cos(e),f=this.getCenterPoint(),b={x:f.x-b,y:f.y-d},d={x:b.x+this.currentWidth*e,y:b.y+this.currentWidth*c},f={x:b.x-this.currentHeight*c,y:b.y+this.currentHeight*e};this.oCoords={tl:b,tr:d,br:{x:d.x-this.currentHeight*c,y:d.y+this.currentHeight*e},bl:f,ml:{x:b.x-this.currentHeight/2*c,y:b.y+this.currentHeight/2*e},mt:{x:b.x+this.currentWidth/2*e,y:b.y+this.currentWidth/2*c},mr:{x:d.x-this.currentHeight/2*c,y:d.y+this.currentHeight/
2*e},mb:{x:f.x+this.currentWidth/2*e,y:f.y+this.currentWidth/2*c},mtr:{x:b.x+this.currentWidth/2*e,y:b.y+this.currentWidth/2*c}};this._setCornerCoords();return this}})})();
(function(){var a=fabric.util.getPointer,c=fabric.util.degreesToRadians;fabric.util.object.extend(fabric.Object.prototype,{_findTargetCorner:function(b,c){if(!this.hasControls||!this.active)return!1;var d=a(b,this.canvas.upperCanvasEl),f=d.x-c.left,d=d.y-c.top,g,h;for(h in this.oCoords)if("mtr"!==h||this.hasRotatingPoint)if(!this.get("lockUniScaling")||!("mt"===h||"mr"===h||"mb"===h||"ml"===h))if(g=this._getImageLines(this.oCoords[h].corner,h),g=this._findCrossPoints(f,d,g),1===g%2&&0!==g)return this.__corner=
h;return!1},_findCrossPoints:function(a,c,d){var f,g,h,m=0,r;for(r in d)if(h=d[r],!(h.o.y<c&&h.d.y<c)&&!(h.o.y>=c&&h.d.y>=c)&&(h.o.x===h.d.x&&h.o.x>=a?f=h.o.x:(f=(h.d.y-h.o.y)/(h.d.x-h.o.x),g=c-0*a,h=h.o.y-f*h.o.x,f=-(g-h)/(0-f)),f>=a&&(m+=1),2===m))break;return m},_getImageLines:function(a){return{topline:{o:a.tl,d:a.tr},rightline:{o:a.tr,d:a.br},bottomline:{o:a.br,d:a.bl},leftline:{o:a.bl,d:a.tl}}},_setCornerCoords:function(){var a=this.oCoords,e=c(this.angle),d=c(45-this.angle),f=Math.sqrt(2*Math.pow(this.cornerSize,
2))/2,g=f*Math.cos(d),d=f*Math.sin(d),f=Math.sin(e),e=Math.cos(e);a.tl.corner={tl:{x:a.tl.x-d,y:a.tl.y-g},tr:{x:a.tl.x+g,y:a.tl.y-d},bl:{x:a.tl.x-g,y:a.tl.y+d},br:{x:a.tl.x+d,y:a.tl.y+g}};a.tr.corner={tl:{x:a.tr.x-d,y:a.tr.y-g},tr:{x:a.tr.x+g,y:a.tr.y-d},br:{x:a.tr.x+d,y:a.tr.y+g},bl:{x:a.tr.x-g,y:a.tr.y+d}};a.bl.corner={tl:{x:a.bl.x-d,y:a.bl.y-g},bl:{x:a.bl.x-g,y:a.bl.y+d},br:{x:a.bl.x+d,y:a.bl.y+g},tr:{x:a.bl.x+g,y:a.bl.y-d}};a.br.corner={tr:{x:a.br.x+g,y:a.br.y-d},bl:{x:a.br.x-g,y:a.br.y+d},br:{x:a.br.x+
d,y:a.br.y+g},tl:{x:a.br.x-d,y:a.br.y-g}};a.ml.corner={tl:{x:a.ml.x-d,y:a.ml.y-g},tr:{x:a.ml.x+g,y:a.ml.y-d},bl:{x:a.ml.x-g,y:a.ml.y+d},br:{x:a.ml.x+d,y:a.ml.y+g}};a.mt.corner={tl:{x:a.mt.x-d,y:a.mt.y-g},tr:{x:a.mt.x+g,y:a.mt.y-d},bl:{x:a.mt.x-g,y:a.mt.y+d},br:{x:a.mt.x+d,y:a.mt.y+g}};a.mr.corner={tl:{x:a.mr.x-d,y:a.mr.y-g},tr:{x:a.mr.x+g,y:a.mr.y-d},bl:{x:a.mr.x-g,y:a.mr.y+d},br:{x:a.mr.x+d,y:a.mr.y+g}};a.mb.corner={tl:{x:a.mb.x-d,y:a.mb.y-g},tr:{x:a.mb.x+g,y:a.mb.y-d},bl:{x:a.mb.x-g,y:a.mb.y+d},
br:{x:a.mb.x+d,y:a.mb.y+g}};a.mtr.corner={tl:{x:a.mtr.x-d+f*this.rotatingPointOffset,y:a.mtr.y-g-e*this.rotatingPointOffset},tr:{x:a.mtr.x+g+f*this.rotatingPointOffset,y:a.mtr.y-d-e*this.rotatingPointOffset},bl:{x:a.mtr.x-g+f*this.rotatingPointOffset,y:a.mtr.y+d-e*this.rotatingPointOffset},br:{x:a.mtr.x+d+f*this.rotatingPointOffset,y:a.mtr.y+g-e*this.rotatingPointOffset}}},drawBorders:function(a){if(this.hasBorders){var c=this.padding,d=2*c,f=1<this.strokeWidth?this.strokeWidth:0;a.save();a.globalAlpha=
this.isMoving?this.borderOpacityWhenMoving:1;a.strokeStyle=this.borderColor;var g=1/this._constrainScale(this.scaleX),h=1/this._constrainScale(this.scaleY);a.lineWidth=1/this.borderScaleFactor;a.scale(g,h);g=this.getWidth();h=this.getHeight();a.strokeRect(~~(-(g/2)-c-f/2*this.scaleX)+0.5,~~(-(h/2)-c-f/2*this.scaleY)+0.5,~~(g+d+f*this.scaleX),~~(h+d+f*this.scaleY));this.hasRotatingPoint&&(!this.get("lockRotation")&&this.hasControls)&&(c=(this.flipY?h+f*this.scaleY+2*c:-h-f*this.scaleY-2*c)/2,a.beginPath(),
a.moveTo(0,c),a.lineTo(0,c+(this.flipY?this.rotatingPointOffset:-this.rotatingPointOffset)),a.closePath(),a.stroke());a.restore();return this}},drawCorners:function(a){if(this.hasControls){var c=this.cornerSize,d=c/2,f=this.strokeWidth/2,g=-(this.width/2),h=-(this.height/2),m=c/this.scaleX,r=c/this.scaleY,u=this.padding/this.scaleX,q=this.padding/this.scaleY,v=d/this.scaleY,t=d/this.scaleX,w=(d-c)/this.scaleX,x=(d-c)/this.scaleY,A=this.height,y=this.width,C=this.transparentCorners?"strokeRect":"fillRect",
B="undefined"!==typeof G_vmlCanvasManager;a.save();a.lineWidth=1/Math.max(this.scaleX,this.scaleY);a.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1;a.strokeStyle=a.fillStyle=this.cornerColor;c=g-t-f-u;d=h-v-f-q;B||a.clearRect(c,d,m,r);a[C](c,d,m,r);c=g+y-t+f+u;d=h-v-f-q;B||a.clearRect(c,d,m,r);a[C](c,d,m,r);c=g-t-f-u;d=h+A+x+f+q;B||a.clearRect(c,d,m,r);a[C](c,d,m,r);c=g+y+w+f+u;d=h+A+x+f+q;B||a.clearRect(c,d,m,r);a[C](c,d,m,r);this.get("lockUniScaling")||(c=g+y/2-t,d=h-v-f-q,B||a.clearRect(c,
d,m,r),a[C](c,d,m,r),c=g+y/2-t,d=h+A+x+f+q,B||a.clearRect(c,d,m,r),a[C](c,d,m,r),c=g+y+w+f+u,d=h+A/2-v,B||a.clearRect(c,d,m,r),a[C](c,d,m,r),c=g-t-f-u,d=h+A/2-v,B||a.clearRect(c,d,m,r),a[C](c,d,m,r));this.hasRotatingPoint&&(c=g+y/2-t,d=this.flipY?h+A+this.rotatingPointOffset/this.scaleY-r/2+f+q:h-this.rotatingPointOffset/this.scaleY-r/2-f-q,B||a.clearRect(c,d,m,r),a[C](c,d,m,r));a.restore();return this}}})})();
(function(a){var c=a.fabric||(a.fabric={}),b=c.util.object.extend,e={x1:1,x2:1,y1:1,y2:1};c.Line?c.warn("fabric.Line is already defined"):(c.Line=c.util.createClass(c.Object,{type:"line",initialize:function(a,b){b=b||{};a||(a=[0,0,0,0]);this.callSuper("initialize",b);this.set("x1",a[0]);this.set("y1",a[1]);this.set("x2",a[2]);this.set("y2",a[3]);this._setWidthHeight(b)},_setWidthHeight:function(a){a||(a={});this.set("width",this.x2-this.x1||1);this.set("height",this.y2-this.y1||1);this.set("left",
"left"in a?a.left:this.x1+this.width/2);this.set("top","top"in a?a.top:this.y1+this.height/2)},_set:function(a,b){this[a]=b;a in e&&this._setWidthHeight();return this},_render:function(a){a.beginPath();this.group&&a.translate(-this.group.width/2+this.left,-this.group.height/2+this.top);a.moveTo(1===this.width?0:-this.width/2,1===this.height?0:-this.height/2);a.lineTo(1===this.width?0:this.width/2,1===this.height?0:this.height/2);a.lineWidth=this.strokeWidth;var b=a.strokeStyle;a.strokeStyle=a.fillStyle;
a.stroke();a.strokeStyle=b},complexity:function(){return 1},toObject:function(a){return b(this.callSuper("toObject",a),{x1:this.get("x1"),y1:this.get("y1"),x2:this.get("x2"),y2:this.get("y2")})},toSVG:function(){return['<line x1="',this.get("x1"),'" y1="',this.get("y1"),'" x2="',this.get("x2"),'" y2="',this.get("y2"),'" style="',this.getSvgStyles(),'" />'].join("")}}),c.Line.ATTRIBUTE_NAMES="x1 y1 x2 y2 stroke stroke-width transform".split(" "),c.Line.fromElement=function(a,e){var g=c.parseAttributes(a,
c.Line.ATTRIBUTE_NAMES);return new c.Line([g.x1||0,g.y1||0,g.x2||0,g.y2||0],b(g,e))},c.Line.fromObject=function(a){return new c.Line([a.x1,a.y1,a.x2,a.y2],a)})})("undefined"!==typeof exports?exports:this);
(function(a){var c=a.fabric||(a.fabric={}),b=2*Math.PI,e=c.util.object.extend;c.Circle?c.warn("fabric.Circle is already defined."):(c.Circle=c.util.createClass(c.Object,{type:"circle",initialize:function(a){a=a||{};this.set("radius",a.radius||0);this.callSuper("initialize",a);a=2*this.get("radius");this.set("width",a).set("height",a)},toObject:function(a){return e(this.callSuper("toObject",a),{radius:this.get("radius")})},toSVG:function(){return'<circle cx="0" cy="0" r="'+this.radius+'" style="'+
this.getSvgStyles()+'" transform="'+this.getSvgTransform()+'" />'},_render:function(a,c){a.beginPath();a.globalAlpha=this.group?a.globalAlpha*this.opacity:this.opacity;a.arc(c?this.left:0,c?this.top:0,this.radius,0,b,!1);a.closePath();this.fill&&a.fill();this._removeShadow(a);this.stroke&&a.stroke()},getRadiusX:function(){return this.get("radius")*this.get("scaleX")},getRadiusY:function(){return this.get("radius")*this.get("scaleY")},setRadius:function(a){this.radius=a;this.set("width",2*a).set("height",
2*a)},complexity:function(){return 1}}),c.Circle.ATTRIBUTE_NAMES="cx cy r fill fill-opacity opacity stroke stroke-width transform".split(" "),c.Circle.fromElement=function(a,b){b||(b={});var g=c.parseAttributes(a,c.Circle.ATTRIBUTE_NAMES);if(!("radius"in g&&0<g.radius))throw Error("value of `r` attribute is required and can not be negative");"left"in g&&(g.left-=b.width/2||0);"top"in g&&(g.top-=b.height/2||0);g=new c.Circle(e(g,b));g.cx=parseFloat(a.getAttribute("cx"))||0;g.cy=parseFloat(a.getAttribute("cy"))||
0;return g},c.Circle.fromObject=function(a){return new c.Circle(a)})})("undefined"!==typeof exports?exports:this);
(function(a){var c=a.fabric||(a.fabric={});c.Triangle?c.warn("fabric.Triangle is already defined"):(c.Triangle=c.util.createClass(c.Object,{type:"triangle",initialize:function(a){a=a||{};this.callSuper("initialize",a);this.set("width",a.width||100).set("height",a.height||100)},_render:function(a){var c=this.width/2,d=this.height/2;a.beginPath();a.moveTo(-c,d);a.lineTo(0,-d);a.lineTo(c,d);a.closePath();this.fill&&a.fill();this.stroke&&a.stroke()},complexity:function(){return 1},toSVG:function(){var a=
this.width/2,c=this.height/2;return'<polygon points="'+[-a+" "+c,"0 "+-c,a+" "+c].join()+'" style="'+this.getSvgStyles()+'" transform="'+this.getSvgTransform()+'" />'}}),c.Triangle.fromObject=function(a){return new c.Triangle(a)})})("undefined"!==typeof exports?exports:this);
(function(a){var c=a.fabric||(a.fabric={}),b=2*Math.PI,e=c.util.object.extend;c.Ellipse?c.warn("fabric.Ellipse is already defined."):(c.Ellipse=c.util.createClass(c.Object,{type:"ellipse",initialize:function(a){a=a||{};this.callSuper("initialize",a);this.set("rx",a.rx||0);this.set("ry",a.ry||0);this.set("width",2*this.get("rx"));this.set("height",2*this.get("ry"))},toObject:function(a){return e(this.callSuper("toObject",a),{rx:this.get("rx"),ry:this.get("ry")})},toSVG:function(){return['<ellipse rx="',
this.get("rx"),'" ry="',this.get("ry"),'" style="',this.getSvgStyles(),'" transform="',this.getSvgTransform(),'" />'].join("")},render:function(a,b){if(!(0===this.rx||0===this.ry))return this.callSuper("render",a,b)},_render:function(a,c){a.beginPath();a.save();a.globalAlpha=this.group?a.globalAlpha*this.opacity:this.opacity;this.transformMatrix&&this.group&&a.translate(this.cx,this.cy);a.transform(1,0,0,this.ry/this.rx,0,0);a.arc(c?this.left:0,c?this.top:0,this.rx,0,b,!1);this.stroke&&a.stroke();
this._removeShadow(a);this.fill&&a.fill();a.restore()},complexity:function(){return 1}}),c.Ellipse.ATTRIBUTE_NAMES="cx cy rx ry fill fill-opacity opacity stroke stroke-width transform".split(" "),c.Ellipse.fromElement=function(a,b){b||(b={});var g=c.parseAttributes(a,c.Ellipse.ATTRIBUTE_NAMES),h=g.left,m=g.top;"left"in g&&(g.left-=b.width/2||0);"top"in g&&(g.top-=b.height/2||0);g=new c.Ellipse(e(g,b));g.cx=h||0;g.cy=m||0;return g},c.Ellipse.fromObject=function(a){return new c.Ellipse(a)})})("undefined"!==
typeof exports?exports:this);
(function(a){var c=a.fabric||(a.fabric={}),b=c.util.object.extend;c.Rect?console.warn("fabric.Rect is already defined"):(c.Rect=c.util.createClass(c.Object,{type:"rect",rx:0,ry:0,initialize:function(a){a=a||{};this._initStateProperties();this.callSuper("initialize",a);this._initRxRy();this.y=this.x=0},_initStateProperties:function(){this.stateProperties=this.stateProperties.concat(["rx","ry"])},_initRxRy:function(){this.rx&&!this.ry?this.ry=this.rx:this.ry&&!this.rx&&(this.rx=this.ry)},_render:function(a){var b=
this.rx||0,c=this.ry||0,g=-this.width/2,h=-this.height/2,m=this.width,r=this.height;a.beginPath();a.globalAlpha=this.group?a.globalAlpha*this.opacity:this.opacity;this.transformMatrix&&this.group&&a.translate(this.width/2+this.x,this.height/2+this.y);!this.transformMatrix&&this.group&&a.translate(-this.group.width/2+this.width/2+this.x,-this.group.height/2+this.height/2+this.y);a.moveTo(g+b,h);a.lineTo(g+m-b,h);a.quadraticCurveTo(g+m,h,g+m,h+c,g+m,h+c);a.lineTo(g+m,h+r-c);a.quadraticCurveTo(g+m,h+
r,g+m-b,h+r,g+m-b,h+r);a.lineTo(g+b,h+r);a.quadraticCurveTo(g,h+r,g,h+r-c,g,h+r-c);a.lineTo(g,h+c);a.quadraticCurveTo(g,h,g+b,h,g+b,h);a.closePath();this.fill&&a.fill();this._removeShadow(a);this.strokeDashArray?this._renderDashedStroke(a):this.stroke&&a.stroke()},_renderDashedStroke:function(a){function b(d,v){for(var t=0,w=0,x=(v?m.height:m.width)+2*r;t<x;){var A=m.strokeDashArray[c++],t=t+A;t>x&&(w=t-x);d?g+=A*d-(w*d||0):h+=A*v-(w*v||0);a[1&c?"moveTo":"lineTo"](g,h);c>=u&&(c=0)}}1&this.strokeDashArray.length&&
this.strokeDashArray.push.apply(this.strokeDashArray,this.strokeDashArray);var c=0,g=-this.width/2,h=-this.height/2,m=this,r=this.padding,u=this.strokeDashArray.length;a.save();a.beginPath();b(1,0);b(0,1);b(-1,0);b(0,-1);a.stroke();a.closePath();a.restore()},_normalizeLeftTopProperties:function(a){a.left&&this.set("left",a.left+this.getWidth()/2);this.set("x",a.left||0);a.top&&this.set("top",a.top+this.getHeight()/2);this.set("y",a.top||0);return this},complexity:function(){return 1},toObject:function(a){return b(this.callSuper("toObject",
a),{rx:this.get("rx")||0,ry:this.get("ry")||0})},toSVG:function(){return'<rect x="'+-1*this.width/2+'" y="'+-1*this.height/2+'" rx="'+this.get("rx")+'" ry="'+this.get("ry")+'" width="'+this.width+'" height="'+this.height+'" style="'+this.getSvgStyles()+'" transform="'+this.getSvgTransform()+'" />'}}),c.Rect.ATTRIBUTE_NAMES="x y width height rx ry fill fill-opacity opacity stroke stroke-width transform".split(" "),c.Rect.fromElement=function(a,d){if(!a)return null;var f=c.parseAttributes(a,c.Rect.ATTRIBUTE_NAMES);
f.left=f.left||0;f.top=f.top||0;var g=new c.Rect(b(d?c.util.object.clone(d):{},f));g._normalizeLeftTopProperties(f);return g},c.Rect.fromObject=function(a){return new c.Rect(a)})})("undefined"!==typeof exports?exports:this);
(function(a){var c=a.fabric||(a.fabric={}),b=c.util.toFixed;c.Polyline?c.warn("fabric.Polyline is already defined"):(c.Polyline=c.util.createClass(c.Object,{type:"polyline",initialize:function(a,b){b=b||{};this.set("points",a);this.callSuper("initialize",b);this._calcDimensions()},_calcDimensions:function(){return c.Polygon.prototype._calcDimensions.call(this)},toObject:function(a){return c.Polygon.prototype.toObject.call(this,a)},toSVG:function(){for(var a=[],c=0,f=this.points.length;c<f;c++)a.push(b(this.points[c].x,
2),",",b(this.points[c].y,2)," ");return['<polyline points="',a.join(""),'" style="',this.getSvgStyles(),'" transform="',this.getSvgTransform(),'" />'].join("")},_render:function(a){var b;a.beginPath();a.moveTo(this.points[0].x,this.points[0].y);for(var c=0,g=this.points.length;c<g;c++)b=this.points[c],a.lineTo(b.x,b.y);this.fill&&a.fill();this._removeShadow(a);this.stroke&&a.stroke()},complexity:function(){return this.get("points").length}}),c.Polyline.ATTRIBUTE_NAMES="fill fill-opacity opacity stroke stroke-width transform".split(" "),
c.Polyline.fromElement=function(a,b){if(!a)return null;b||(b={});for(var f=c.parsePointsAttribute(a.getAttribute("points")),g=c.parseAttributes(a,c.Polyline.ATTRIBUTE_NAMES),h=0,m=f.length;h<m;h++)f[h].x-=b.width/2||0,f[h].y-=b.height/2||0;return new c.Polyline(f,c.util.object.extend(g,b))},c.Polyline.fromObject=function(a){return new c.Polyline(a.points,a)})})("undefined"!==typeof exports?exports:this);
(function(a){var c=a.fabric||(a.fabric={}),b=c.util.object.extend,e=c.util.array.min,d=c.util.array.max,f=c.util.toFixed;c.Polygon?c.warn("fabric.Polygon is already defined"):(c.Polygon=c.util.createClass(c.Object,{type:"polygon",initialize:function(a,b){b=b||{};this.points=a;this.callSuper("initialize",b);this._calcDimensions()},_calcDimensions:function(){var a=this.points,b=e(a,"x"),c=e(a,"y"),f=d(a,"x"),a=d(a,"y");this.width=f-b||1;this.height=a-c||1;var u=this.width/2,q=this.height/2;this.points.forEach(function(a){a.x-=
u;a.y-=q},this);this.minX=b;this.minY=c},toObject:function(a){return b(this.callSuper("toObject",a),{points:this.points.concat()})},toSVG:function(){for(var a=[],b=0,c=this.points.length;b<c;b++)a.push(f(this.points[b].x,2),",",f(this.points[b].y,2)," ");return['<polygon points="',a.join(""),'" style="',this.getSvgStyles(),'" transform="',this.getSvgTransform(),'" />'].join("")},_render:function(a){var b;a.beginPath();a.moveTo(this.points[0].x,this.points[0].y);for(var c=0,d=this.points.length;c<
d;c++)b=this.points[c],a.lineTo(b.x,b.y);this.fill&&a.fill();this._removeShadow(a);this.stroke&&(a.closePath(),a.stroke())},complexity:function(){return this.points.length}}),c.Polygon.ATTRIBUTE_NAMES="fill fill-opacity opacity stroke stroke-width transform".split(" "),c.Polygon.fromElement=function(a,d){if(!a)return null;d||(d={});for(var e=c.parsePointsAttribute(a.getAttribute("points")),f=c.parseAttributes(a,c.Polygon.ATTRIBUTE_NAMES),u=0,q=e.length;u<q;u++)e[u].x-=d.width/2||0,e[u].y-=d.height/
2||0;return new c.Polygon(e,b(f,d))},c.Polygon.fromObject=function(a){return new c.Polygon(a.points,a)})})("undefined"!==typeof exports?exports:this);
(function(a){function c(a,c,d,f){c=b(f[5],f[6],f[0],f[1],f[3],f[4],f[2],c,d);for(d=0;d<c.length;d++)f=e.apply(this,c[d]),a.bezierCurveTo.apply(a,f)}function b(a,b,c,d,e,f,g,m,q){u=r.call(arguments);if(h[u])return h[u];var t=g*(Math.PI/180),v=Math.sin(t),t=Math.cos(t);c=Math.abs(c);d=Math.abs(d);var w=0.5*t*(m-a)+0.5*v*(q-b),x=0.5*t*(q-b)-0.5*v*(m-a),w=w*w/(c*c)+x*x/(d*d);1<w&&(w=Math.sqrt(w),c*=w,d*=w);var z=t/c,F=v/c,M=-v/d,N=t/d,w=z*m+F*q,x=M*m+N*q,z=z*a+F*b,F=M*a+N*b,M=1/((z-w)*(z-w)+(F-x)*(F-
x))-0.25;0>M&&(M=0);N=Math.sqrt(M);f===e&&(N=-N);M=0.5*(w+z)-N*(F-x);N=0.5*(x+F)+N*(z-w);w=Math.atan2(x-N,w-M);x=Math.atan2(F-N,z-M)-w;0>x&&1===f?x+=2*Math.PI:0<x&&0===f&&(x-=2*Math.PI);for(var z=Math.ceil(Math.abs(x/(0.5*Math.PI+0.0010))),F=[],R=0;R<z;R++)F[R]=[M,N,w+R*x/z,w+(R+1)*x/z,c,d,v,t];return h[u]=F}function e(a,b,c,d,e,f,g,h){u=r.call(arguments);if(m[u])return m[u];var q=h*e,t=-g*f,v=g*e,w=h*f,x=0.5*(d-c),z=8/3*Math.sin(0.5*x)*Math.sin(0.5*x)/Math.sin(x),x=a+Math.cos(c)-z*Math.sin(c),F=
b+Math.sin(c)+z*Math.cos(c),M=a+Math.cos(d),N=b+Math.sin(d),R=M+z*Math.sin(d),z=N-z*Math.cos(d);return m[u]=[q*x+t*F,v*x+w*F,q*R+t*z,v*R+w*z,q*M+t*N,v*M+w*N]}function d(a){return"H"===a[0]?a[1]:a[a.length-2]}function f(a){return"V"===a[0]?a[1]:a[a.length-1]}var g={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},h={},m={},r=Array.prototype.join,u;"use strict";var q=a.fabric||(a.fabric={}),v=q.util.array.min,t=q.util.array.max,w=q.util.object.extend,x=Object.prototype.toString;q.Path?q.warn("fabric.Path is already defined"):
(q.Path=q.util.createClass(q.Object,{type:"path",initialize:function(a,b){b=b||{};this.setOptions(b);if(!a)throw Error("`path` argument is required");var c="[object Array]"===x.call(a);if(this.path=c?a:a.match&&a.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi))c||(this.path=this._parsePath()),this._initializePath(b),b.sourcePath&&this.setSourcePath(b.sourcePath)},_initializePath:function(a){var b="width"in a,c="height"in a,d="left"in a,e="top"in a;!b||!c?(w(this,this._parseDimensions()),b&&(this.width=a.width),
c&&(this.height=a.height)):(e||(this.top=this.height/2),d||(this.left=this.width/2));this.pathOffset=this._calculatePathOffset(e||d)},_calculatePathOffset:function(a){return{x:a?0:this.left-this.width/2,y:a?0:this.top-this.height/2}},_render:function(a){for(var b,d=null,e=0,f=0,g=0,h=0,m,r,q,t,u=-(this.width/2+this.pathOffset.x),v=-(this.height/2+this.pathOffset.y),w=0,x=this.path.length;w<x;++w){b=this.path[w];switch(b[0]){case "l":e+=b[1];f+=b[2];a.lineTo(e+u,f+v);break;case "L":e=b[1];f=b[2];a.lineTo(e+
u,f+v);break;case "h":e+=b[1];a.lineTo(e+u,f+v);break;case "H":e=b[1];a.lineTo(e+u,f+v);break;case "v":f+=b[1];a.lineTo(e+u,f+v);break;case "V":f=b[1];a.lineTo(e+u,f+v);break;case "m":e+=b[1];f+=b[2];a[d&&("m"===d[0]||"M"===d[0])?"lineTo":"moveTo"](e+u,f+v);break;case "M":e=b[1];f=b[2];a[d&&("m"===d[0]||"M"===d[0])?"lineTo":"moveTo"](e+u,f+v);break;case "c":m=e+b[5];r=f+b[6];g=e+b[3];h=f+b[4];a.bezierCurveTo(e+b[1]+u,f+b[2]+v,g+u,h+v,m+u,r+v);e=m;f=r;break;case "C":e=b[5];f=b[6];g=b[3];h=b[4];a.bezierCurveTo(b[1]+
u,b[2]+v,g+u,h+v,e+u,f+v);break;case "s":m=e+b[3];r=f+b[4];g=g?2*e-g:e;h=h?2*f-h:f;a.bezierCurveTo(g+u,h+v,e+b[1]+u,f+b[2]+v,m+u,r+v);g=e+b[1];h=f+b[2];e=m;f=r;break;case "S":m=b[3];r=b[4];g=2*e-g;h=2*f-h;a.bezierCurveTo(g+u,h+v,b[1]+u,b[2]+v,m+u,r+v);e=m;f=r;g=b[1];h=b[2];break;case "q":m=e+b[3];r=f+b[4];g=e+b[1];h=f+b[2];a.quadraticCurveTo(g+u,h+v,m+u,r+v);e=m;f=r;break;case "Q":m=b[3];r=b[4];a.quadraticCurveTo(b[1]+u,b[2]+v,m+u,r+v);e=m;f=r;g=b[1];h=b[2];break;case "t":m=e+b[1];r=f+b[2];null===
d[0].match(/[QqTt]/)?(g=e,h=f):"t"===d[0]?(g=2*e-q,h=2*f-t):"q"===d[0]&&(g=2*e-g,h=2*f-h);q=g;t=h;a.quadraticCurveTo(g+u,h+v,m+u,r+v);e=m;f=r;g=e+b[1];h=f+b[2];break;case "T":m=b[1];r=b[2];g=2*e-g;h=2*f-h;a.quadraticCurveTo(g+u,h+v,m+u,r+v);e=m;f=r;break;case "a":c(a,e+u,f+v,[b[1],b[2],b[3],b[4],b[5],b[6]+e+u,b[7]+f+v]);e+=b[6];f+=b[7];break;case "A":c(a,e+u,f+v,[b[1],b[2],b[3],b[4],b[5],b[6]+u,b[7]+v]);e=b[6];f=b[7];break;case "z":case "Z":a.closePath()}d=b}},render:function(a,b){a.save();var c=
this.transformMatrix;c&&a.transform(c[0],c[1],c[2],c[3],c[4],c[5]);b||this.transform(a);this.overlayFill?a.fillStyle=this.overlayFill:this.fill&&(a.fillStyle=this.fill.toLive?this.fill.toLive(a):this.fill);this.stroke&&(a.strokeStyle=this.stroke.toLive?this.stroke.toLive(a):this.stroke);a.beginPath();this._setShadow(a);this._render(a);this.fill&&a.fill();this._removeShadow(a);this.stroke&&(a.strokeStyle=this.stroke,a.lineWidth=this.strokeWidth,a.lineCap=a.lineJoin="round",a.stroke());!b&&this.active&&
(this.drawBorders(a),this.hideCorners||this.drawCorners(a));a.restore()},toString:function(){return"#<fabric.Path ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:function(a){a=w(this.callSuper("toObject",a),{path:this.path});this.sourcePath&&(a.sourcePath=this.sourcePath);this.transformMatrix&&(a.transformMatrix=this.transformMatrix);return a},toDatalessObject:function(a){a=this.toObject(a);this.sourcePath&&(a.path=this.sourcePath);delete a.sourcePath;return a},
toSVG:function(){for(var a=[],b=0,c=this.path.length;b<c;b++)a.push(this.path[b].join(" "));a=a.join(" ");return['<g transform="',this.group?"":this.getSvgTransform(),'"><path width="',this.width,'" height="',this.height,'" d="',a,'" style="',this.getSvgStyles(),'" transform="translate(',-this.width/2," ",-this.height/2,')" /></g>'].join("")},complexity:function(){return this.path.length},_parsePath:function(){for(var a=[],b,c,d,e=0,f=this.path.length;e<f;e++){b=this.path[e];c=b.slice(1).trim().replace(/(\d)-/g,
"$1###-").split(/\s|,|###/);b=[b.charAt(0)];for(var h=0,m=c.length;h<m;h++)d=parseFloat(c[h]),isNaN(d)||b.push(d);c=b[0].toLowerCase();c=g[c];if(b.length-1>c){d=1;for(h=b.length;d<h;d+=c)a.push([b[0]].concat(b.slice(d,d+c)))}else a.push(b)}return a},_parseDimensions:function(){var a=[],b=[],c,e,g=!1,h,m;this.path.forEach(function(r,q){"H"!==r[0]&&(c=0===q?d(r):d(this.path[q-1]));"V"!==r[0]&&(e=0===q?f(r):f(this.path[q-1]));r[0]===r[0].toLowerCase()&&(g=!0);h=g?c+d(r):"V"===r[0]?c:d(r);m=g?e+f(r):
"H"===r[0]?e:f(r);var u=parseInt(h,10);isNaN(u)||a.push(u);u=parseInt(m,10);isNaN(u)||b.push(u)},this);var r=v(a),q=v(b),u=t(a),w=t(b),u=u-r,w=w-q,r={top:q+w/2,left:r+u/2,bottom:t(b)-w,right:t(a)-u};r.width=u;r.height=w;return r}}),q.Path.fromObject=function(a){return new q.Path(a.path,a)},q.Path.ATTRIBUTE_NAMES="d fill fill-opacity opacity fill-rule stroke stroke-width transform".split(" "),q.Path.fromElement=function(a,b){var c=q.parseAttributes(a,q.Path.ATTRIBUTE_NAMES);return new q.Path(c.d,w(c,
b))})})("undefined"!==typeof exports?exports:this);
(function(a){var c=a.fabric||(a.fabric={}),b=c.util.object.extend,e=c.util.array.invoke,d=c.Object.prototype.toObject,f=c.util.string.camelize,g=c.util.string.capitalize;c.PathGroup?c.warn("fabric.PathGroup is already defined"):(c.PathGroup=c.util.createClass(c.Path,{type:"path-group",fill:"",initialize:function(a,b){b=b||{};this.paths=a||[];for(var c=this.paths.length;c--;)this.paths[c].group=this;this.setOptions(b);this.setCoords();b.sourcePath&&this.setSourcePath(b.sourcePath)},render:function(a){a.save();
var b=this.transformMatrix;b&&a.transform(b[0],b[1],b[2],b[3],b[4],b[5]);this.transform(a);this._setShadow(a);for(var b=0,c=this.paths.length;b<c;++b)this.paths[b].render(a,!0);this._removeShadow(a);this.active&&(this.drawBorders(a),this.hideCorners||this.drawCorners(a));a.restore()},_set:function(a,b){if(("fill"===a||"overlayFill"===a)&&b&&this.isSameColor())for(var c=this.paths.length;c--;)this.paths[c]._set(a,b);return this.callSuper("_set",a,b)},toObject:function(a){return b(d.call(this,a),{paths:e(this.getObjects(),
"toObject",a),sourcePath:this.sourcePath})},toDatalessObject:function(a){a=this.toObject(a);this.sourcePath&&(a.paths=this.sourcePath);return a},toSVG:function(){for(var a=this.getObjects(),b=["<g ",'width="',this.width,'" ','height="',this.height,'" ','style="',this.getSvgStyles(),'" ','transform="',this.getSvgTransform(),'" ',">"],c=0,d=a.length;c<d;c++)b.push(a[c].toSVG());b.push("</g>");return b.join("")},toString:function(){return"#<fabric.PathGroup ("+this.complexity()+"): { top: "+this.top+
", left: "+this.left+" }>"},isSameColor:function(){var a=this.getObjects()[0].get("fill");return this.getObjects().every(function(b){return b.get("fill")===a})},complexity:function(){return this.paths.reduce(function(a,b){return a+(b&&b.complexity?b.complexity():0)},0)},toGrayscale:function(){for(var a=this.paths.length;a--;)this.paths[a].toGrayscale();return this},getObjects:function(){return this.paths}}),c.PathGroup.fromObject=function(a){for(var b=a.paths,d=0,e=b.length;d<e;d++)if(!(b[d]instanceof
c.Object)){var q=f(g(b[d].type));b[d]=c[q].fromObject(b[d])}return new c.PathGroup(b,a)})})("undefined"!==typeof exports?exports:this);
(function(a){var c=a.fabric||(a.fabric={}),b=c.util.object.extend,e=c.util.array.min,d=c.util.array.max,f=c.util.array.invoke,g=c.util.removeFromArray;if(!c.Group){var h={lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0};c.Group=c.util.createClass(c.Object,{type:"group",initialize:function(a,c){c=c||{};this.objects=a||[];this.originalState={};this.callSuper("initialize");this._calcBounds();this._updateObjectsCoords();c&&b(this,c);this._setOpacityIfSame();
this.setCoords(!0);this.saveCoords()},_updateObjectsCoords:function(){var a=this.left,b=this.top;this.forEachObject(function(c){var d=c.get("left"),e=c.get("top");c.set("originalLeft",d);c.set("originalTop",e);c.set("left",d-a);c.set("top",e-b);c.setCoords();c.hideCorners=!0},this)},toString:function(){return"#<fabric.Group: ("+this.complexity()+")>"},getObjects:function(){return this.objects},addWithUpdate:function(a){this._restoreObjectsState();this.objects.push(a);this._calcBounds();this._updateObjectsCoords();
return this},removeWithUpdate:function(a){this._restoreObjectsState();g(this.objects,a);a.setActive(!1);this._calcBounds();this._updateObjectsCoords();return this},add:function(a){this.objects.push(a);return this},remove:function(a){g(this.objects,a);return this},size:function(){return this.getObjects().length},delegatedProperties:{fill:!0,opacity:!0,fontFamily:!0,fontWeight:!0,lineHeight:!0,textDecoration:!0,textShadow:!0,backgroundColor:!0},_set:function(a,b){if(a in this.delegatedProperties){var c=
this.objects.length;for(this[a]=b;c--;)this.objects[c].set(a,b)}else this[a]=b},contains:function(a){return-1<this.objects.indexOf(a)},toObject:function(a){return b(this.callSuper("toObject",a),{objects:f(this.objects,"toObject",a)})},render:function(a,b){a.save();this.transform(a);for(var c=Math.max(this.scaleX,this.scaleY),d=this.objects.length;0<d;d--){var e=this.objects[d-1],f=e.borderScaleFactor,g=e.hasRotatingPoint;e.borderScaleFactor=c;e.hasRotatingPoint=!1;e.render(a);e.borderScaleFactor=
f;e.hasRotatingPoint=g}!b&&this.active&&(this.drawBorders(a),this.hideCorners||this.drawCorners(a));a.restore();this.setCoords()},item:function(a){return this.getObjects()[a]},complexity:function(){return this.getObjects().reduce(function(a,b){return a+="function"===typeof b.complexity?b.complexity():0},0)},_restoreObjectsState:function(){this.objects.forEach(this._restoreObjectState,this);return this},_restoreObjectState:function(a){var b=this.get("left"),c=this.get("top"),d=this.getAngle()*(Math.PI/
180),e=Math.cos(d)*a.get("top")+Math.sin(d)*a.get("left"),d=-Math.sin(d)*a.get("top")+Math.cos(d)*a.get("left");a.setAngle(a.getAngle()+this.getAngle());a.set("left",b+d*this.get("scaleX"));a.set("top",c+e*this.get("scaleY"));a.set("scaleX",a.get("scaleX")*this.get("scaleX"));a.set("scaleY",a.get("scaleY")*this.get("scaleY"));a.setCoords();a.hideCorners=!1;a.setActive(!1);a.setCoords();return this},destroy:function(){return this._restoreObjectsState()},saveCoords:function(){this._originalLeft=this.get("left");
this._originalTop=this.get("top");return this},hasMoved:function(){return this._originalLeft!==this.get("left")||this._originalTop!==this.get("top")},setObjectsCoords:function(){this.forEachObject(function(a){a.setCoords()});return this},activateAllObjects:function(){this.forEachObject(function(a){a.setActive()});return this},forEachObject:c.StaticCanvas.prototype.forEachObject,_setOpacityIfSame:function(){var a=this.getObjects(),b=a[0]?a[0].get("opacity"):1;a.every(function(a){return a.get("opacity")===
b})&&(this.opacity=b)},_calcBounds:function(){var a=[],b=[],c,f;f=0;for(var g=this.objects.length;f<g;++f){c=this.objects[f];c.setCoords();for(var h in c.oCoords)a.push(c.oCoords[h].x),b.push(c.oCoords[h].y)}c=e(a);f=d(a);a=e(b);b=d(b);f=f-c||0;b=b-a||0;this.width=f;this.height=b;this.left=c+f/2||0;this.top=a+b/2||0},containsPoint:function(a){var b=this.get("width")/2,c=this.get("height")/2,d=this.get("left"),e=this.get("top");return d-b<a.x&&d+b>a.x&&e-c<a.y&&e+c>a.y},toGrayscale:function(){for(var a=
this.objects.length;a--;)this.objects[a].toGrayscale();return this},toSVG:function(){for(var a=[],b=0,c=this.objects.length;b<c;b++)a.push(this.objects[b].toSVG());return'<g transform="'+this.getSvgTransform()+'">'+a.join("")+"</g>"},get:function(a){if(a in h){if(this[a])return this[a];for(var b=0,c=this.objects.length;b<c;b++)if(this.objects[b][a])return!0;return!1}return this[a]}});c.Group.fromObject=function(a,b){c.util.enlivenObjects(a.objects,function(d){delete a.objects;b&&b(new c.Group(d,a))})};
c.Group.async=!0}})("undefined"!==typeof exports?exports:this);
(function(a){var c=fabric.util.object.extend;a.fabric||(a.fabric={});a.fabric.Image?fabric.warn("fabric.Image is already defined."):(fabric.Image=fabric.util.createClass(fabric.Object,{type:"image",initialize:function(a,c){c||(c={});this.callSuper("initialize",c);this._initElement(a);this._originalImage=this.getElement();this._initConfig(c);this.filters=[];c.filters&&(this.filters=c.filters,this.applyFilters())},getElement:function(){return this._element},setElement:function(a){this._element=a;this._initConfig();
return this},getOriginalSize:function(){var a=this.getElement();return{width:a.width,height:a.height}},render:function(a,c){a.save();var d=this.transformMatrix;this.group&&a.translate(-this.group.width/2+this.width/2,-this.group.height/2+this.height/2);d&&a.transform(d[0],d[1],d[2],d[3],d[4],d[5]);c||this.transform(a);this._setShadow(a);this._render(a);this._removeShadow(a);this.active&&!c&&(this.drawBorders(a),this.hideCorners||this.drawCorners(a));a.restore()},toObject:function(a){return c(this.callSuper("toObject",
a),{src:this._originalImage.src||this._originalImage._src,filters:this.filters.concat()})},toSVG:function(){return'<g transform="'+this.getSvgTransform()+'"><image xlink:href="'+this.getSvgSrc()+'" style="'+this.getSvgStyles()+'" transform="translate('+-this.width/2+" "+-this.height/2+')" width="'+this.width+'" height="'+this.height+'"></image></g>'},getSrc:function(){return this.getElement().src||this.getElement()._src},toString:function(){return'#<fabric.Image: { src: "'+this.getSrc()+'" }>'},clone:function(a,
c){this.constructor.fromObject(this.toObject(c),a)},applyFilters:function(a){if(0===this.filters.length)this.setElement(this._originalImage),a&&a();else{var c="undefined"!==typeof Buffer&&"undefined"===typeof window,d=this._originalImage,f=fabric.util.createCanvasElement(),g=c?new (require("canvas").Image):fabric.document.createElement("img"),h=this;f.width=d.width;f.height=d.height;f.getContext("2d").drawImage(d,0,0,d.width,d.height);this.filters.forEach(function(a){a&&a.applyTo(f)});g.onload=function(){h._element=
g;a&&a();g.onload=f=d=null};g.width=d.width;g.height=d.height;c?(c=f.toDataURL("image/png").substring(22),g.src=new Buffer(c,"base64"),h._element=g,a&&a()):g.src=f.toDataURL("image/png");return this}},_render:function(a){a.drawImage(this._element,-this.width/2,-this.height/2,this.width,this.height)},_resetWidthHeight:function(){var a=this.getElement();this.set("width",a.width);this.set("height",a.height)},_initElement:function(a){this.setElement(fabric.util.getById(a));fabric.util.addClass(this.getElement(),
fabric.Image.CSS_CANVAS)},_initConfig:function(a){a||(a={});this.setOptions(a);this._setWidthHeight(a)},_initFilters:function(a){a.filters&&a.filters.length&&(this.filters=a.filters.map(function(a){return a&&fabric.Image.filters[a.type].fromObject(a)}))},_setWidthHeight:function(a){this.width="width"in a?a.width:this.getElement().width||0;this.height="height"in a?a.height:this.getElement().height||0},complexity:function(){return 1}}),fabric.Image.CSS_CANVAS="canvas-img",fabric.Image.prototype.getSvgSrc=
fabric.Image.prototype.getSrc,fabric.Image.fromObject=function(a,c){var d=fabric.document.createElement("img"),f=a.src;a.width&&(d.width=a.width);a.height&&(d.height=a.height);d.onload=function(){fabric.Image.prototype._initFilters.call(a,a);var f=new fabric.Image(d,a);c&&c(f);d=d.onload=d.onerror=null};d.onerror=function(){fabric.log("Error loading "+d.src);c&&c(null,!0);d=d.onload=d.onerror=null};d.src=f},fabric.Image.fromURL=function(a,c,d){var f=fabric.document.createElement("img");f.onload=function(){c&&
c(new fabric.Image(f,d));f=f.onload=null};f.src=a},fabric.Image.ATTRIBUTE_NAMES="x y width height fill fill-opacity opacity stroke stroke-width transform xlink:href".split(" "),fabric.Image.fromElement=function(a,e,d){d||(d={});a=fabric.parseAttributes(a,fabric.Image.ATTRIBUTE_NAMES);fabric.Image.fromURL(a["xlink:href"],e,c(a,d))},fabric.Image.async=!0)})("undefined"!==typeof exports?exports:this);
fabric.util.object.extend(fabric.Object.prototype,{_getAngleValueForStraighten:function(){var a=this.getAngle()%360;return 0<a?90*Math.round((a-1)/90):90*Math.round(a/90)},straighten:function(){this.setAngle(this._getAngleValueForStraighten());return this},fxStraighten:function(a){a=a||{};var c=function(){},b=a.onComplete||c,e=a.onChange||c,d=this;fabric.util.animate({startValue:this.get("angle"),endValue:this._getAngleValueForStraighten(),duration:this.FX_DURATION,onChange:function(a){d.setAngle(a);
e()},onComplete:function(){d.setCoords();b()},onStart:function(){d.setActive(!1)}});return this}});fabric.util.object.extend(fabric.StaticCanvas.prototype,{straightenObject:function(a){a.straighten();this.renderAll();return this},fxStraightenObject:function(a){a.fxStraighten({onChange:this.renderAll.bind(this)});return this}});fabric.Image.filters={};
fabric.Image.filters.Grayscale=fabric.util.createClass({type:"Grayscale",applyTo:function(a){var c=a.getContext("2d");a=c.getImageData(0,0,a.width,a.height);var b=a.data,e=a.width,d=a.height,f,g,h,m;for(h=0;h<e;h++)for(m=0;m<d;m++)f=4*h*d+4*m,g=(b[f]+b[f+1]+b[f+2])/3,b[f]=g,b[f+1]=g,b[f+2]=g;c.putImageData(a,0,0)},toJSON:function(){return{type:this.type}}});fabric.Image.filters.Grayscale.fromObject=function(){return new fabric.Image.filters.Grayscale};
fabric.Image.filters.RemoveWhite=fabric.util.createClass({type:"RemoveWhite",initialize:function(a){a||(a={});this.threshold=a.threshold||30;this.distance=a.distance||20},applyTo:function(a){var c=a.getContext("2d");a=c.getImageData(0,0,a.width,a.height);for(var b=a.data,e=this.distance,d=255-this.threshold,f=Math.abs,g,h,m,r=0,u=b.length;r<u;r+=4)g=b[r],h=b[r+1],m=b[r+2],g>d&&(h>d&&m>d&&f(g-h)<e&&f(g-m)<e&&f(h-m)<e)&&(b[r+3]=1);c.putImageData(a,0,0)},toJSON:function(){return{type:this.type,threshold:this.threshold,
distance:this.distance}}});fabric.Image.filters.RemoveWhite.fromObject=function(a){return new fabric.Image.filters.RemoveWhite(a)};fabric.Image.filters.Invert=fabric.util.createClass({type:"Invert",applyTo:function(a){var c=a.getContext("2d");a=c.getImageData(0,0,a.width,a.height);var b=a.data,e=b.length,d;for(d=0;d<e;d+=4)b[d]=255-b[d],b[d+1]=255-b[d+1],b[d+2]=255-b[d+2];c.putImageData(a,0,0)},toJSON:function(){return{type:this.type}}});fabric.Image.filters.Invert.fromObject=function(){return new fabric.Image.filters.Invert};
fabric.Image.filters.Sepia=fabric.util.createClass({type:"Sepia",applyTo:function(a){var c=a.getContext("2d");a=c.getImageData(0,0,a.width,a.height);var b=a.data,e=b.length,d,f;for(d=0;d<e;d+=4)f=0.3*b[d]+0.59*b[d+1]+0.11*b[d+2],b[d]=f+100,b[d+1]=f+50,b[d+2]=f+255;c.putImageData(a,0,0)},toJSON:function(){return{type:this.type}}});fabric.Image.filters.Sepia.fromObject=function(){return new fabric.Image.filters.Sepia};
fabric.Image.filters.Sepia2=fabric.util.createClass({type:"Sepia2",applyTo:function(a){var c=a.getContext("2d");a=c.getImageData(0,0,a.width,a.height);var b=a.data,e=b.length,d,f,g,h;for(d=0;d<e;d+=4)f=b[d],g=b[d+1],h=b[d+2],b[d]=(0.393*f+0.769*g+0.189*h)/1.351,b[d+1]=(0.349*f+0.686*g+0.168*h)/1.203,b[d+2]=(0.272*f+0.534*g+0.131*h)/2.14;c.putImageData(a,0,0)},toJSON:function(){return{type:this.type}}});fabric.Image.filters.Sepia2.fromObject=function(){return new fabric.Image.filters.Sepia2};
fabric.Image.filters.Brightness=fabric.util.createClass({type:"Brightness",initialize:function(a){a||(a={});this.brightness=a.brightness||100},applyTo:function(a){var c=a.getContext("2d");a=c.getImageData(0,0,a.width,a.height);for(var b=a.data,e=this.brightness,d=0,f=b.length;d<f;d+=4)b[d]+=e,b[d+1]+=e,b[d+2]+=e;c.putImageData(a,0,0)},toJSON:function(){return{type:this.type,brightness:this.brightness}}});fabric.Image.filters.Brightness.fromObject=function(a){return new fabric.Image.filters.Brightness(a)};
fabric.Image.filters.Noise=fabric.util.createClass({type:"Noise",initialize:function(a){a||(a={});this.noise=a.noise||100},applyTo:function(a){var c=a.getContext("2d");a=c.getImageData(0,0,a.width,a.height);for(var b=a.data,e=this.noise,d,f=0,g=b.length;f<g;f+=4)d=(0.5-Math.random())*e,b[f]+=d,b[f+1]+=d,b[f+2]+=d;c.putImageData(a,0,0)},toJSON:function(){return{type:this.type,noise:this.noise}}});fabric.Image.filters.Noise.fromObject=function(a){return new fabric.Image.filters.Noise(a)};
fabric.Image.filters.GradientTransparency=fabric.util.createClass({type:"GradientTransparency",initialize:function(a){a||(a={});this.threshold=a.threshold||100},applyTo:function(a){var c=a.getContext("2d");a=c.getImageData(0,0,a.width,a.height);for(var b=a.data,e=this.threshold,d=b.length,f=0,g=b.length;f<g;f+=4)b[f+3]=e+255*(d-f)/d;c.putImageData(a,0,0)},toJSON:function(){return{type:this.type,threshold:this.threshold}}});fabric.Image.filters.GradientTransparency.fromObject=function(a){return new fabric.Image.filters.GradientTransparency(a)};
fabric.Image.filters.Tint=fabric.util.createClass({type:"Tint",initialize:function(a){a||(a={});this.color=a.color||0},applyTo:function(a){var c=a.getContext("2d");a=c.getImageData(0,0,a.width,a.height);var b=a.data,e=b.length,d,f;d=parseInt(this.color,10).toString(16);var g=parseInt("0x"+d.substr(0,2),16),h=parseInt("0x"+d.substr(2,2),16),m=parseInt("0x"+d.substr(4,2),16);for(d=0;d<e;d+=4)f=b[d+3],0<f&&(b[d]=g,b[d+1]=h,b[d+2]=m);c.putImageData(a,0,0)},toJSON:function(){return{type:this.type,color:this.color}}});
fabric.Image.filters.Tint.fromObject=function(a){return new fabric.Image.filters.Tint(a)};
fabric.Image.filters.Convolute=fabric.util.createClass({type:"Convolute",initialize:function(a){a||(a={});this.opaque=a.opaque;this.matrix=a.matrix||[0,0,0,0,1,0,0,0,0];this.tmpCtx=fabric.util.createCanvasElement().getContext("2d")},_createImageData:function(a,c){return this.tmpCtx.createImageData(a,c)},applyTo:function(a){var c=this.matrix,b=a.getContext("2d"),e=b.getImageData(0,0,a.width,a.height);a=Math.round(Math.sqrt(c.length));for(var d=Math.floor(a/2),f=e.data,g=e.width,e=e.height,h=this._createImageData(g,
e),m=h.data,r=this.opaque?1:0,u=0;u<e;u++)for(var q=0;q<g;q++){for(var v=u,t=q,w=4*(u*g+q),x=0,A=0,y=0,C=0,B=0;B<a;B++)for(var E=0;E<a;E++){var D=v+B-d,I=t+E-d;0<=D&&(D<e&&0<=I&&I<g)&&(D=4*(D*g+I),I=c[B*a+E],x+=f[D]*I,A+=f[D+1]*I,y+=f[D+2]*I,C+=f[D+3]*I)}m[w]=x;m[w+1]=A;m[w+2]=y;m[w+3]=C+r*(255-C)}b.putImageData(h,0,0)},toJSON:function(){return{type:this.type,matrix:this.matrix}}});fabric.Image.filters.Convolute.fromObject=function(a){return new fabric.Image.filters.Convolute(a)};
fabric.Image.filters.Pixelate=fabric.util.createClass({type:"Pixelate",initialize:function(a){a||(a={});this.blocksize=a.blocksize||4},applyTo:function(a){var c=a.getContext("2d");a=c.getImageData(0,0,a.width,a.height);var b=a.data,e=a.width,d=a.height,f,g,h,m,r,u,q;for(g=0;g<e;g+=this.blocksize)for(h=0;h<d;h+=this.blocksize){f=4*g*d+4*h;m=b[f];r=b[f+1];u=b[f+2];q=b[f+3];for(var v=g,t=g+this.blocksize;v<t;v++)for(var w=h,x=h+this.blocksize;w<x;w++)f=4*v*d+4*w,b[f]=m,b[f+1]=r,b[f+2]=u,b[f+3]=q}c.putImageData(a,
0,0)},toJSON:function(){return{type:this.type,blocksize:this.blocksize}}});fabric.Image.filters.Pixelate.fromObject=function(a){return new fabric.Image.filters.Pixelate(a)};
(function(a){var c=a.fabric||(a.fabric={}),b=c.util.object.extend,e=c.util.object.clone,d=c.util.toFixed;c.Text?c.warn("fabric.Text is already defined"):(c.Text=c.util.createClass(c.Object,{fontSize:40,fontWeight:400,fontFamily:"Times New Roman",textDecoration:"",textShadow:"",textAlign:"left",fontStyle:"",lineHeight:1.3,strokeStyle:"",strokeWidth:1,backgroundColor:"",textBackgroundColor:"",path:null,type:"text",useNative:!0,initialize:function(a,b){b=b||{};this._initStateProperties();this.text=a;
this.setOptions(b);this._initDimensions();this.setCoords()},_initDimensions:function(){var a=c.util.createCanvasElement();this._render(a.getContext("2d"))},_initStateProperties:function(){this.stateProperties=this.stateProperties.concat();this.stateProperties.push("fontFamily","fontWeight","fontSize","path","text","textDecoration","textShadow","textAlign","fontStyle","lineHeight","strokeStyle","strokeWidth","backgroundColor","textBackgroundColor","useNative");c.util.removeFromArray(this.stateProperties,
"width")},toString:function(){return"#<fabric.Text ("+this.complexity()+'): { "text": "'+this.text+'", "fontFamily": "'+this.fontFamily+'" }>'},_render:function(a){"undefined"===typeof Cufon||!0===this.useNative?this._renderViaNative(a):this._renderViaCufon(a)},_renderViaCufon:function(a){var b=Cufon.textOptions||(Cufon.textOptions={});b.left=this.left;b.top=this.top;b.context=a;b.color=this.fill;var c=this._initDummyElementForCufon();this.transform(a);Cufon.replaceElement(c,{engine:"canvas",separate:"none",
fontFamily:this.fontFamily,fontWeight:this.fontWeight,textDecoration:this.textDecoration,textShadow:this.textShadow,textAlign:this.textAlign,fontStyle:this.fontStyle,lineHeight:this.lineHeight,strokeStyle:this.strokeStyle,strokeWidth:this.strokeWidth,backgroundColor:this.backgroundColor,textBackgroundColor:this.textBackgroundColor});this.width=b.width;this.height=b.height;this._totalLineHeight=b.totalLineHeight;this._fontAscent=b.fontAscent;this._boundaries=b.boundaries;this._shadowOffsets=b.shadowOffsets;
this._shadows=b.shadows||[];this.setCoords()},_renderViaNative:function(a){this.transform(a);this._setTextStyles(a);var b=this.text.split(/\r?\n/);this.width=this._getTextWidth(a,b);this.height=this._getTextHeight(a,b);this._renderTextBackground(a,b);"left"!==this.textAlign&&"justify"!==this.textAlign&&(a.save(),a.translate("center"===this.textAlign?this.width/2:this.width,0));this._setTextShadow(a);this._renderTextFill(a,b);this.textShadow&&a.restore();this._renderTextStroke(a,b);"left"!==this.textAlign&&
"justify"!==this.textAlign&&a.restore();this._renderTextDecoration(a,b);this._setBoundaries(a,b);this._totalLineHeight=0;this.setCoords()},_setBoundaries:function(a,b){this._boundaries=[];for(var c=0,d=b.length;c<d;c++){var e=this._getLineWidth(a,b[c]),u=this._getLineLeftOffset(e);this._boundaries.push({height:this.fontSize*this.lineHeight,width:e,left:u})}},_setTextStyles:function(a){a.fillStyle=this.fill.toLive?this.fill.toLive(a):this.fill;a.strokeStyle=this.strokeStyle;a.lineWidth=this.strokeWidth;
a.textBaseline="alphabetic";a.textAlign=this.textAlign;a.font=this._getFontDeclaration()},_getTextHeight:function(a,b){return this.fontSize*b.length*this.lineHeight},_getTextWidth:function(a,b){for(var c=a.measureText(b[0]).width,d=1,e=b.length;d<e;d++){var u=a.measureText(b[d]).width;u>c&&(c=u)}return c},_setTextShadow:function(a){if(this.textShadow){var b=/\s+(-?\d+)(?:px)?\s+(-?\d+)(?:px)?\s+(\d+)(?:px)?\s*/,c=this.textShadow,d=b.exec(this.textShadow),b=c.replace(b,"");a.save();a.shadowColor=b;
a.shadowOffsetX=parseInt(d[1],10);a.shadowOffsetY=parseInt(d[2],10);a.shadowBlur=parseInt(d[3],10);this._shadows=[{blur:a.shadowBlur,color:a.shadowColor,offX:a.shadowOffsetX,offY:a.shadowOffsetY}];this._shadowOffsets=[[parseInt(a.shadowOffsetX,10),parseInt(a.shadowOffsetY,10)]]}},_drawTextLine:function(a,b,c,d,e){if("justify"!==this.textAlign)b[a](c,d,e);else{var u=b.measureText(c).width,q=this.width;if(q>u){u=c.split(/\s+/);c=b.measureText(c.replace(/\s+/g,"")).width;for(var q=(q-c)/(u.length-1),
v=c=0,t=u.length;v<t;v++)b[a](u[v],d+c,e),c+=b.measureText(u[v]).width+q}else b[a](c,d,e)}},_renderTextFill:function(a,b){this._boundaries=[];for(var c=0,d=b.length;c<d;c++)this._drawTextLine("fillText",a,b[c],-this.width/2,-this.height/2+c*this.fontSize*this.lineHeight+this.fontSize)},_renderTextStroke:function(a,b){if(this.strokeStyle){a.beginPath();for(var c=0,d=b.length;c<d;c++)this._drawTextLine("strokeText",a,b[c],-this.width/2,-this.height/2+c*this.fontSize*this.lineHeight+this.fontSize);a.closePath()}},
_renderTextBackground:function(a,b){this._renderTextBoxBackground(a);this._renderTextLinesBackground(a,b)},_renderTextBoxBackground:function(a){this.backgroundColor&&(a.save(),a.fillStyle=this.backgroundColor,a.fillRect(-this.width/2,-this.height/2,this.width,this.height),a.restore())},_renderTextLinesBackground:function(a,b){if(this.textBackgroundColor){a.save();a.fillStyle=this.textBackgroundColor;for(var c=0,d=b.length;c<d;c++)if(""!==b[c]){var e=this._getLineWidth(a,b[c]),u=this._getLineLeftOffset(e);
a.fillRect(-this.width/2+u,-this.height/2+c*this.fontSize*this.lineHeight,e,this.fontSize*this.lineHeight)}a.restore()}},_getLineLeftOffset:function(a){return"center"===this.textAlign?(this.width-a)/2:"right"===this.textAlign?this.width-a:0},_getLineWidth:function(a,b){return"justify"===this.textAlign?this.width:a.measureText(b).width},_renderTextDecoration:function(a,b){function c(h){for(var q=0,v=b.length;q<v;q++){var t=e._getLineWidth(a,b[q]),w=e._getLineLeftOffset(t);a.fillRect(-e.width/2+w,h+
q*e.fontSize*e.lineHeight-d,t,1)}}var d=this._getTextHeight(a,b)/2,e=this;-1<this.textDecoration.indexOf("underline")&&c(this.fontSize);-1<this.textDecoration.indexOf("line-through")&&c(this.fontSize/2);-1<this.textDecoration.indexOf("overline")&&c(0)},_getFontDeclaration:function(){return[this.fontStyle,this.fontWeight,this.fontSize+"px",c.isLikelyNode?'"'+this.fontFamily+'"':this.fontFamily].join(" ")},_initDummyElementForCufon:function(){var a=c.document.createElement("pre");c.document.createElement("div").appendChild(a);
"undefined"===typeof G_vmlCanvasManager?a.innerHTML=this.text:a.innerText=this.text.replace(/\r?\n/gi,"\r");a.style.fontSize=this.fontSize+"px";a.style.letterSpacing="normal";return a},render:function(a,b){a.save();this._render(a);!b&&this.active&&(this.drawBorders(a),this.hideCorners||this.drawCorners(a));a.restore()},toObject:function(a){return b(this.callSuper("toObject",a),{text:this.text,fontSize:this.fontSize,fontWeight:this.fontWeight,fontFamily:this.fontFamily,fontStyle:this.fontStyle,lineHeight:this.lineHeight,
textDecoration:this.textDecoration,textShadow:this.textShadow,textAlign:this.textAlign,path:this.path,strokeStyle:this.strokeStyle,strokeWidth:this.strokeWidth,backgroundColor:this.backgroundColor,textBackgroundColor:this.textBackgroundColor,useNative:this.useNative})},toSVG:function(){var a=this.text.split(/\r?\n/),b=this.useNative?this.fontSize*this.lineHeight:-this._fontAscent-this._fontAscent/5*this.lineHeight,c=-(this.width/2),e=this.useNative?this.fontSize-1:this.height/2-a.length*this.fontSize-
this._totalLineHeight,r=this._getSVGTextAndBg(b,c,a),a=this._getSVGShadows(b,a),e=e+(this._fontAscent?this._fontAscent/5*this.lineHeight:0);return['<g transform="',this.getSvgTransform(),'">',r.textBgRects.join(""),"<text ",this.fontFamily?"font-family=\"'"+this.fontFamily+"'\" ":"",this.fontSize?'font-size="'+this.fontSize+'" ':"",this.fontStyle?'font-style="'+this.fontStyle+'" ':"",this.fontWeight?'font-weight="'+this.fontWeight+'" ':"",this.textDecoration?'text-decoration="'+this.textDecoration+
'" ':"",'style="',this.getSvgStyles(),'" transform="translate(',d(c,2)," ",d(e,2),')">',a.join(""),r.textSpans.join(""),"</text></g>"].join("")},_getSVGShadows:function(a,b){var e=[],m,r,u,q,v=1;if(!this._shadows||!this._boundaries)return e;m=0;for(u=this._shadows.length;m<u;m++){r=0;for(q=b.length;r<q;r++)""!==b[r]?(e.push('<tspan x="',d((this._boundaries&&this._boundaries[r]?this._boundaries[r].left:0)+v+this._shadowOffsets[m][0],2),0===r||this.useNative?'" y':'" dy','="',d(this.useNative?a*r-this.height/
2+this._shadowOffsets[m][1]:a+(0===r?this._shadowOffsets[m][1]:0),2),'" ',this._getFillAttributes(this._shadows[m].color),">",c.util.string.escapeXml(b[r]),"</tspan>"),v=1):v++}return e},_getSVGTextAndBg:function(a,b,e){var m=[],r=[],u,q,v,t=1;this.backgroundColor&&this._boundaries&&r.push("<rect ",this._getFillAttributes(this.backgroundColor),' x="',d(-this.width/2,2),'" y="',d(-this.height/2,2),'" width="',d(this.width,2),'" height="',d(this.height,2),'"></rect>');u=0;for(v=e.length;u<v;u++)""!==
e[u]?(q=this._boundaries&&this._boundaries[u]?d(this._boundaries[u].left,2):0,m.push('<tspan x="',q,'" ',0===u||this.useNative?"y":"dy",'="',d(this.useNative?a*u-this.height/2:a*t,2),'" ',this._getFillAttributes(this.fill),">",c.util.string.escapeXml(e[u]),"</tspan>"),t=1):t++,this.textBackgroundColor&&this._boundaries&&r.push("<rect ",this._getFillAttributes(this.textBackgroundColor),' x="',d(b+this._boundaries[u].left,2),'" y="',d(a*u-this.height/2,2),'" width="',d(this._boundaries[u].width,2),
'" height="',d(this._boundaries[u].height,2),'"></rect>');return{textSpans:m,textBgRects:r}},_getFillAttributes:function(a){var b=a?new c.Color(a):"";return!b||!b.getSource()||1===b.getAlpha()?'fill="'+a+'"':'opacity="'+b.getAlpha()+'" fill="'+b.setAlpha(1).toRgb()+'"'},setColor:function(a){this.set("fill",a);return this},setFontsize:function(a){this.set("fontSize",a);this._initDimensions();this.setCoords();return this},getText:function(){return this.text},setText:function(a){this.set("text",a);this._initDimensions();
this.setCoords();return this},_set:function(a,b){"fontFamily"===a&&this.path&&(this.path=this.path.replace(/(.*?)([^\/]*)(\.font\.js)/,"$1"+b+"$3"));this.callSuper("_set",a,b)}}),c.Text.ATTRIBUTE_NAMES="x y fill fill-opacity opacity stroke stroke-width transform font-family font-style font-weight font-size text-decoration".split(" "),c.Text.fromObject=function(a){return new c.Text(a.text,e(a))},c.Text.fromElement=function(a,b){if(!a)return null;var d=c.parseAttributes(a,c.Text.ATTRIBUTE_NAMES);b=
c.util.object.extend(b?c.util.object.clone(b):{},d);d=new c.Text(a.textContent,b);d.set({left:d.getLeft()+d.getWidth()/2,top:d.getTop()-d.getHeight()/2});return d})})("undefined"!==typeof exports?exports:this);
(function(){function a(a,c,d){a=b.parse(a);var f=e.createClient(a.port,a.hostname);a=f.request("GET",a.pathname,{host:a.hostname});f.addListener("error",function(a){a.errno===process.ECONNREFUSED?fabric.log("ECONNREFUSED: connection refused to "+f.host+":"+f.port):fabric.log(a.message)});a.end();a.on("response",function(a){var b="";c&&a.setEncoding(c);a.on("end",function(){d(b)});a.on("data",function(c){200===a.statusCode&&(b+=c)})})}if(!("undefined"!==typeof document&&"undefined"!==typeof window)){var c=
(new require("xmldom")).DOMParser,b=require("url"),e=require("http"),d=require("canvas"),f=require("canvas").Image;fabric.util.loadImage=function(b,c,d){var e=new f;b&&0===b.indexOf("data")?(e.src=e._src=b,c&&c.call(d,e)):b&&a(b,"binary",function(a){e.src=new Buffer(a,"binary");e._src=b;c&&c.call(d,e)})};fabric.loadSVGFromURL=function(b,c){b=b.replace(/^\n\s*/,"").replace(/\?.*$/,"").trim();a(b,"",function(a){fabric.loadSVGFromString(a,c)})};fabric.loadSVGFromString=function(a,b){var d=(new c).parseFromString(a);
fabric.parseSVGDocument(d.documentElement,function(a,c){b(a,c)})};fabric.util.getScript=function(b,c){a(b,"",function(a){eval(a);c&&c()})};fabric.Image.fromObject=function(a,b){fabric.util.loadImage(a.src,function(c){c=new fabric.Image(c);c._initConfig(a);c._initFilters(a);b(c)})};fabric.createCanvasForNode=function(a,b){var c=fabric.document.createElement("canvas"),e=new d(a||600,b||600);c.style={};c.width=e.width;c.height=e.height;c=new (fabric.Canvas||fabric.StaticCanvas)(c);c.contextContainer=
e.getContext("2d");c.nodeCanvas=e;return c};fabric.StaticCanvas.prototype.createPNGStream=function(){return this.nodeCanvas.createPNGStream()};fabric.StaticCanvas.prototype.createJPEGStream=function(a){return this.nodeCanvas.createJPEGStream(a)};var g=fabric.StaticCanvas.prototype.setWidth;fabric.StaticCanvas.prototype.setWidth=function(a){g.call(this);this.nodeCanvas.width=a;return this};fabric.Canvas&&(fabric.Canvas.prototype.setWidth=fabric.StaticCanvas.prototype.setWidth);var h=fabric.StaticCanvas.prototype.setHeight;
fabric.StaticCanvas.prototype.setHeight=function(a){h.call(this);this.nodeCanvas.height=a;return this};fabric.Canvas&&(fabric.Canvas.prototype.setHeight=fabric.StaticCanvas.prototype.setHeight)}})();(function(a){var c=function(){var b=65,c={eventName:"click",onShow:function(){},onBeforeShow:function(){},onHide:function(){},onChange:function(){},onSubmit:function(){},color:"ff0000",livePreview:!0,flat:!1},d=function(b,c){var d=S(b);a(c).data("colorpicker").fields.eq(1).val(d.r).end().eq(2).val(d.g).end().eq(3).val(d.b).end()},f=function(b,c){a(c).data("colorpicker").fields.eq(4).val(b.h).end().eq(5).val(b.s).end().eq(6).val(b.b).end()},g=function(b,c){a(c).data("colorpicker").fields.eq(0).val(aa(S(b))).end()},
h=function(b,c){a(c).data("colorpicker").selector.css("backgroundColor","#"+aa(S({h:b.h,s:100,b:100})));a(c).data("colorpicker").selectorIndic.css({left:parseInt(150*b.s/100,10),top:parseInt(150*(100-b.b)/100,10)})},m=function(b,c){a(c).data("colorpicker").hue.css("top",parseInt(150-150*b.h/360,10))},r=function(b,c){a(c).data("colorpicker").currentColor.css("backgroundColor","#"+aa(S(b)))},u=function(b,c){a(c).data("colorpicker").newColor.css("backgroundColor","#"+aa(S(b)))},q=function(c){c=c.charCode||
c.keyCode||-1;if(c>b&&90>=c||32==c)return!1;!0===a(this).parent().parent().data("colorpicker").livePreview&&t.apply(this)},v=function(b){b=a(this);var c=b.data("colorpicker").color;b.data("colorpicker").origColor=c;r(c,b.get(0));b.data("colorpicker").onSubmit(c,aa(S(c)),S(c),b.data("colorpicker").el)},t=function(b){var c=a(this).parent().parent(),e;if(0<this.parentNode.className.indexOf("_hex")){e=c.data("colorpicker");var r=this.value,q=6-r.length;if(0<q){for(var t=[],v=0;v<q;v++)t.push("0");t.push(r);
r=t.join("")}r=R(N(r));e.color=e=r}else 0<this.parentNode.className.indexOf("_hsb")?c.data("colorpicker").color=e=M({h:parseInt(c.data("colorpicker").fields.eq(4).val(),10),s:parseInt(c.data("colorpicker").fields.eq(5).val(),10),b:parseInt(c.data("colorpicker").fields.eq(6).val(),10)}):(e=c.data("colorpicker"),r=parseInt(c.data("colorpicker").fields.eq(1).val(),10),q=parseInt(c.data("colorpicker").fields.eq(2).val(),10),t=parseInt(c.data("colorpicker").fields.eq(3).val(),10),r={r:Math.min(255,Math.max(0,
r)),g:Math.min(255,Math.max(0,q)),b:Math.min(255,Math.max(0,t))},e.color=e=R(r));b&&(d(e,c.get(0)),g(e,c.get(0)),f(e,c.get(0)));h(e,c.get(0));m(e,c.get(0));u(e,c.get(0));c.data("colorpicker").onChange.apply(c,[e,aa(S(e)),S(e)])},w=function(b){a(this).parent().parent().data("colorpicker").fields.parent().removeClass("colorpicker_focus")},x=function(){b=0<this.parentNode.className.indexOf("_hex")?70:65;a(this).parent().parent().data("colorpicker").fields.parent().removeClass("colorpicker_focus");a(this).parent().addClass("colorpicker_focus")},
A=function(b){var c=a(this).parent().find("input").focus();b={el:a(this).parent().addClass("colorpicker_slider"),max:0<this.parentNode.className.indexOf("_hsb_h")?360:0<this.parentNode.className.indexOf("_hsb")?100:255,y:b.pageY,field:c,val:parseInt(c.val(),10),preview:a(this).parent().parent().data("colorpicker").livePreview};a(document).bind("mouseup",b,C);a(document).bind("mousemove",b,y)},y=function(a){a.data.field.val(Math.max(0,Math.min(a.data.max,parseInt(a.data.val+a.pageY-a.data.y,10))));
a.data.preview&&t.apply(a.data.field.get(0),[!0]);return!1},C=function(b){t.apply(b.data.field.get(0),[!0]);b.data.el.removeClass("colorpicker_slider").find("input").focus();a(document).unbind("mouseup",C);a(document).unbind("mousemove",y);return!1},B=function(b){b={cal:a(this).parent(),y:a(this).offset().top};b.preview=b.cal.data("colorpicker").livePreview;a(document).bind("mouseup",b,D);a(document).bind("mousemove",b,E)},E=function(a){t.apply(a.data.cal.data("colorpicker").fields.eq(4).val(parseInt(360*
(150-Math.max(0,Math.min(150,a.pageY-a.data.y)))/150,10)).get(0),[a.data.preview]);return!1},D=function(b){d(b.data.cal.data("colorpicker").color,b.data.cal.get(0));g(b.data.cal.data("colorpicker").color,b.data.cal.get(0));a(document).unbind("mouseup",D);a(document).unbind("mousemove",E);return!1},I=function(b){b={cal:a(this).parent(),pos:a(this).offset()};b.preview=b.cal.data("colorpicker").livePreview;a(document).bind("mouseup",b,J);a(document).bind("mousemove",b,L)},L=function(a){t.apply(a.data.cal.data("colorpicker").fields.eq(6).val(parseInt(100*
(150-Math.max(0,Math.min(150,a.pageY-a.data.pos.top)))/150,10)).end().eq(5).val(parseInt(100*Math.max(0,Math.min(150,a.pageX-a.data.pos.left))/150,10)).get(0),[a.data.preview]);return!1},J=function(b){d(b.data.cal.data("colorpicker").color,b.data.cal.get(0));g(b.data.cal.data("colorpicker").color,b.data.cal.get(0));a(document).unbind("mouseup",J);a(document).unbind("mousemove",L);return!1},Q=function(b){a(this).addClass("colorpicker_focus")},Z=function(b){a(this).removeClass("colorpicker_focus")},
Y=function(b){b=a(this).parent();var c=b.data("colorpicker").color;b.data("colorpicker").origColor=c;r(c,b.get(0));b.data("colorpicker").onSubmit(c,aa(S(c)),S(c),b.data("colorpicker").el)},O=function(b){var c,d,e=a("#"+a(this).data("colorpickerId"));e.data("colorpicker").onBeforeShow.apply(this,[e.get(0)]);var f=a(this).offset(),g="CSS1Compat"==document.compatMode;b=window.pageXOffset||(g?document.documentElement.scrollLeft:document.body.scrollLeft);c=window.pageYOffset||(g?document.documentElement.scrollTop:
document.body.scrollTop);d=window.innerWidth||(g?document.documentElement.clientWidth:document.body.clientWidth);var h=f.top+this.offsetHeight,f=f.left;h+176>c+(window.innerHeight||(g?document.documentElement.clientHeight:document.body.clientHeight))&&(h-=this.offsetHeight+176);f+356>b+d&&(f-=356);e.css({left:f+"px",top:h+"px","z-index":"80000"});!1!=e.data("colorpicker").onShow.apply(this,[e.get(0)])&&e.show();a(document).bind("mousedown",{cal:e},z);return!1},z=function(b){F(b.data.cal.get(0),b.target,
b.data.cal.get(0))||(!1!=b.data.cal.data("colorpicker").onHide.apply(this,[b.data.cal.get(0)])&&b.data.cal.hide(),a(document).unbind("mousedown",z))},F=function(a,b,c){if(a==b)return!0;if(a.contains)return a.contains(b);if(a.compareDocumentPosition)return!!(a.compareDocumentPosition(b)&16);for(b=b.parentNode;b&&b!=c;){if(b==a)return!0;b=b.parentNode}return!1},M=function(a){return{h:Math.min(360,Math.max(0,a.h)),s:Math.min(100,Math.max(0,a.s)),b:Math.min(100,Math.max(0,a.b))}},N=function(a){a=parseInt(-1<
a.indexOf("#")?a.substring(1):a,16);return{r:a>>16,g:(a&65280)>>8,b:a&255}},R=function(a){var b={h:0,s:0,b:0},c=Math.min(a.r,a.g,a.b),d=Math.max(a.r,a.g,a.b),c=d-c;b.b=d;b.s=0!=d?255*c/d:0;b.h=0!=b.s?a.r==d?(a.g-a.b)/c:a.g==d?2+(a.b-a.r)/c:4+(a.r-a.g)/c:-1;b.h*=60;0>b.h&&(b.h+=360);b.s*=100/255;b.b*=100/255;return b},S=function(a){var b,c,d;b=Math.round(a.h);var e=Math.round(255*a.s/100);a=Math.round(255*a.b/100);if(0==e)b=c=d=a;else{var e=(255-e)*a/255,f=(a-e)*(b%60)/60;360==b&&(b=0);60>b?(b=a,d=
e,c=e+f):120>b?(c=a,d=e,b=a-f):180>b?(c=a,b=e,d=e+f):240>b?(d=a,b=e,c=a-f):300>b?(d=a,c=e,b=e+f):360>b?(b=a,c=e,d=a-f):d=c=b=0}return{r:Math.round(b),g:Math.round(c),b:Math.round(d)}},aa=function(b){var c=[b.r.toString(16),b.g.toString(16),b.b.toString(16)];a.each(c,function(a,b){1==b.length&&(c[a]="0"+b)});return c.join("")},fa=function(){var b=a(this).parent(),c=b.data("colorpicker").origColor;b.data("colorpicker").color=c;d(c,b.get(0));g(c,b.get(0));f(c,b.get(0));h(c,b.get(0));m(c,b.get(0));u(c,
b.get(0))};return{init:function(b){b=a.extend({},c,b||{});if("string"==typeof b.color)b.color=R(N(b.color));else if(void 0!=b.color.r&&void 0!=b.color.g&&void 0!=b.color.b)b.color=R(b.color);else if(void 0!=b.color.h&&void 0!=b.color.s&&void 0!=b.color.b)b.color=M(b.color);else return this;return this.each(function(){if(!a(this).data("colorpickerId")){var c=a.extend({},b);c.origColor=b.color;var e="collorpicker_"+parseInt(1E3*Math.random());a(this).data("colorpickerId",e);e=a('<div class="colorpicker"><div class="colorpicker_color"><div><div></div></div></div><div class="colorpicker_hue"><div></div></div><div class="colorpicker_new_color"></div><div class="colorpicker_current_color"></div><div class="colorpicker_hex"><input type="text" maxlength="6" size="6" /></div><div class="colorpicker_rgb_r colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_rgb_g colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_rgb_b colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_hsb_h colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_hsb_s colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_hsb_b colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_submit"></div></div>').attr("id",
e);c.flat?e.appendTo(this).show():e.appendTo(document.body);c.fields=e.mouseup(v).find("input").bind("keyup",q).bind("change",t).bind("blur",w).bind("focus",x);e.find("span").bind("mousedown",A).end().find(">div.colorpicker_current_color").bind("click",fa);c.selector=e.find("div.colorpicker_color").bind("mousedown",I);c.selectorIndic=c.selector.find("div div");c.el=this;c.hue=e.find("div.colorpicker_hue div");e.find("div.colorpicker_hue").bind("mousedown",B);c.newColor=e.find("div.colorpicker_new_color");
c.currentColor=e.find("div.colorpicker_current_color");e.data("colorpicker",c);e.find("div.colorpicker_submit").bind("mouseenter",Q).bind("mouseleave",Z).bind("click",Y);d(c.color,e.get(0));f(c.color,e.get(0));g(c.color,e.get(0));m(c.color,e.get(0));h(c.color,e.get(0));r(c.color,e.get(0));u(c.color,e.get(0));c.flat?e.css({position:"relative",display:"block"}):a(this).bind(c.eventName,O)}})},showPicker:function(){return this.each(function(){a(this).data("colorpickerId")&&O.apply(this)})},hidePicker:function(){return this.each(function(){a(this).data("colorpickerId")&&
a("#"+a(this).data("colorpickerId")).hide()})},setColor:function(b){if("string"==typeof b)b=R(N(b));else if(void 0!=b.r&&void 0!=b.g&&void 0!=b.b)b=R(b);else if(void 0!=b.h&&void 0!=b.s&&void 0!=b.b)b=M(b);else return this;return this.each(function(){if(a(this).data("colorpickerId")){var c=a("#"+a(this).data("colorpickerId"));c.data("colorpicker").color=b;c.data("colorpicker").origColor=b;d(b,c.get(0));f(b,c.get(0));g(b,c.get(0));m(b,c.get(0));h(b,c.get(0));r(b,c.get(0));u(b,c.get(0))}})}}}();a.fn.extend({ColorPicker:c.init,
ColorPickerHide:c.hidePicker,ColorPickerShow:c.showPicker,ColorPickerSetColor:c.setColor})})(jQuery);/*
 Use it if you like it
*/
function RGBColor(a){function c(a){var b=a.H,c=a.S;a=a.V;if(-1==b)return{R:a,G:a,B:a};var d=Math.floor(b),e=b-d;d&1||(e=1-e);b=a*(1-c);c=a*(1-c*e);switch(d){case 6:case 0:return{R:a,G:c,B:b};case 1:return{R:c,G:a,B:b};case 2:return{R:b,G:a,B:c};case 3:return{R:b,G:c,B:a};case 4:return{R:c,G:b,B:a};case 5:return{R:a,G:b,B:c};default:return{R:a,G:a,B:a}}}this.ok=!1;if("string"==typeof a){"#"==a.charAt(0)&&(a=a.substr(1,6));a=a.replace(/ /g,"");a=a.toLowerCase();var b={aliceblue:"f0f8ff",antiquewhite:"faebd7",
aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",
darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",
indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",
mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",
papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",
wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"},e;for(e in b)a==e&&(a=b[e]);b=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(a){return[parseInt(a[1]),parseInt(a[2]),parseInt(a[3])]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(a){return[parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],process:function(a){return[parseInt(a[1]+
a[1],16),parseInt(a[2]+a[2],16),parseInt(a[3]+a[3],16)]}}];for(e=0;e<b.length;e++){var d=b[e].process,f=b[e].re.exec(a);f&&(channels=d(f),this.r=channels[0],this.g=channels[1],this.b=channels[2],this.ok=!0)}this.r=0>this.r||isNaN(this.r)?0:255<this.r?255:this.r;this.g=0>this.g||isNaN(this.g)?0:255<this.g?255:this.g;this.b=0>this.b||isNaN(this.b)?0:255<this.b?255:this.b;this.a=1;this.setAlpha=function(a){this.a=a};this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"};this.toRGBA=function(){return"rgba("+
this.r+", "+this.g+", "+this.b+", "+this.a+")"};this.toHex=function(){var a=this.r.toString(16),b=this.g.toString(16),c=this.b.toString(16);1==a.length&&(a="0"+a);1==b.length&&(b="0"+b);1==c.length&&(c="0"+c);return"#"+a+b+c};this.toHsv=function(){var a;a=this.r/255;var b=this.g/255,c=this.b/255,d=Math.max(a,Math.max(b,c)),e=Math.min(a,Math.min(b,c));a=d==e?{H:-1,S:0,V:d}:{H:(a==e?3:b==e?5:1)-1*(a==e?b-c:b==e?c-a:a-b)/(d-e),S:(d-1*e)/d,V:d};return a};this.fromHsv=function(a){a=c(a);this.r=Math.round(255*
a.R);this.g=Math.round(255*a.G);this.b=Math.round(255*a.B)}}};this.HashMap=function(){this.array=[]};HashMap.prototype.put=function(a,c){var b=this.getIndex(a);-1<b?this.array[b]={key:a,value:c}:this.array.push({key:a,value:c})};HashMap.prototype.get=function(a){a=this.getIndex(a);if(-1<a)return this.array[a].value};HashMap.prototype.getAtIndex=function(a){return this.array[a].value};HashMap.prototype.getKeyAtIndex=function(a){return this.array[a].key};HashMap.prototype.remove=function(a){a=this.getIndexOfValue(a);this.removeByIndex(a)};
HashMap.prototype.removeByKey=function(a){a=this.getIndex(a);this.removeByIndex(a)};HashMap.prototype.removeByIndex=function(a){-1!=a&&this.array.splice(a,1)};HashMap.prototype.clear=function(){this.array=[]};HashMap.prototype.all=function(){return this.array};HashMap.prototype.getAllValues=function(){for(var a=[],c=0;c<this.array.length;c++)a.push(this.array[c].value);return a};HashMap.prototype.getAllKeys=function(){for(var a=[],c=0;c<this.array.length;c++)a.push(this.array[c].key);return a};
HashMap.prototype.getIndex=function(a){for(var c=-1,b=0;b<this.array.length;b++)this.array[b].key==a&&(c=b);return c};HashMap.prototype.getIndexOfValue=function(a){for(var c=-1,b=0;b<this.array.length;b++)this.array[b].value==a&&(c=b);return c};HashMap.prototype.getKeyOfValue=function(a){for(var c=void 0,b=0;b<this.array.length;b++){var e=this.array[b];e.value==a&&(c=e.key)}return c};HashMap.prototype.contains=function(a){return-1<this.getIndexOfValue(a)};
HashMap.prototype.containsKey=function(a){return-1<this.getIndex(a)};HashMap.prototype.size=function(){return this.array.length};this.CanvasUtilities={};CanvasRenderingContext2D.prototype.clear=CanvasRenderingContext2D.prototype.clear||function(a){a&&(this.save(),this.setTransform(1,0,0,1,0,0));this.clearRect(0,0,this.canvas.width,this.canvas.height);a&&this.restore()};CanvasRenderingContext2D.prototype.roundedRect=function(a,c,b,e,d){b<2*d&&(d=b/2);e<2*d&&(d=e/2);this.beginPath();this.moveTo(a+d,c);this.arcTo(a+b,c,a+b,c+e,d);this.arcTo(a+b,c+e,a,c+e,d);this.arcTo(a,c+e,a,c,d);this.arcTo(a,c,a+b,c,d);this.closePath();return this};
CanvasRenderingContext2D.prototype.roundedRect2=function(a,c,b,e,d,f,g,h,m,r,u){"undefined"==typeof g&&(g=!0);"undefined"===typeof d&&(d=5);this.save();this.beginPath();this.moveTo(a+d,c);this.lineTo(a+b-d,c);m?(this.lineTo(a+b,c),this.lineTo(a+b,c+d)):this.quadraticCurveTo(a+b,c,a+b,c+d);this.lineTo(a+b,c+e-d);r?(this.lineTo(a+b,c+e),this.lineTo(a+b-d,c+e)):this.quadraticCurveTo(a+b,c+e,a+b-d,c+e);this.lineTo(a+d,c+e);u?(this.lineTo(a,c+e),this.lineTo(a,c+e-d)):this.quadraticCurveTo(a,c+e,a,c+e-
d);this.lineTo(a,c+d);h?(this.lineTo(a,c),this.lineTo(a+d,c)):this.quadraticCurveTo(a,c,a+d,c);this.closePath();f&&this.fill();g&&this.stroke();this.restore()};CanvasUtilities.drawLineAngle=function(a,c,b,e,d){a.save();a.moveTo(c,b);a.lineTo(c+d*Math.cos(e),b+d*Math.sin(e));a.stroke();a.restore()};
CanvasUtilities.drawHead=function(a,c,b,e,d,f,g,h){a.save();a.beginPath();a.moveTo(c,b);a.lineTo(e,d);a.lineTo(f,g);switch(h){case 0:h=Math.sqrt((f-c)*(f-c)+(g-b)*(g-b));a.arcTo(e,d,c,b,0.55*h);a.fill();break;case 1:a.lineTo(c,b);a.fill();break;case 2:a.stroke();break;case 3:a.quadraticCurveTo((c+e+f)/3,(b+d+g)/3,c,b);a.fill();break;case 4:if(f==c)h=g-b,f=(e+c)/2,e=(e+c)/2,g=d+h/5,h=d-h/5;else{h=Math.sqrt((f-c)*(f-c)+(g-b)*(g-b));e=((c+f)/2+e)/2;d=((b+g)/2+d)/2;f=(g-b)/(f-c);h=h/(2*Math.sqrt(f*f+
1))/5;var m=f*h;f=e-h;g=d-m;e+=h;h=d+m}a.bezierCurveTo(f,g,e,h,c,b);a.fill()}a.restore()};
CanvasUtilities.drawArcedArrow=function(a,c,b,e,d,f,g,h,m,r,u){h="undefined"!=typeof h?h:3;m="undefined"!=typeof m?m:1;r="undefined"!=typeof r?r:Math.PI/8;u="undefined"!=typeof u?u:10;a.save();a.beginPath();a.arc(c,b,e,d,f,g);a.stroke();var q,v,t;a.strokeStyle="rgba(0,0,0,0)";m&1&&(q=Math.cos(d)*e+c,d=Math.sin(d)*e+b,v=Math.atan2(c-q,d-b),g?(t=q+10*Math.cos(v),v=d+10*Math.sin(v)):(t=q-10*Math.cos(v),v=d-10*Math.sin(v)),CanvasUtilities.drawArrow(a,q,d,t,v,h,2,r,u));m&2&&(q=Math.cos(f)*e+c,d=Math.sin(f)*
e+b,v=Math.atan2(c-q,d-b),g?(t=q-10*Math.cos(v),v=d-10*Math.sin(v)):(t=q+10*Math.cos(v),v=d+10*Math.sin(v)),CanvasUtilities.drawArrow(a,q,d,t,v,h,2,r,u));a.restore()};
CanvasUtilities.drawArrow=function(a,c,b,e,d,f,g,h,m){f="undefined"!=typeof f?f:3;g="undefined"!=typeof g?g:1;h="undefined"!=typeof h?h:Math.PI/8;m="undefined"!=typeof m?m:10;var r="function"!=typeof f?CanvasUtilities.drawHead:f,u=Math.sqrt((e-c)*(e-c)+(d-b)*(d-b)),q=(u-m/3)/u,v,t;g&1?(u=c+(e-c)*q,v=b+(d-b)*q):(u=e,v=d);g&2?(t=c+(e-c)*(1-q),q=b+(d-b)*(1-q)):(t=c,q=b);a.beginPath();a.moveTo(t,q);a.lineTo(u,v);a.stroke();u=Math.atan2(d-b,e-c);m=Math.abs(m/Math.cos(h));if(g&1){t=u+Math.PI+h;v=e+Math.cos(t)*
m;t=d+Math.sin(t)*m;var w=u+Math.PI-h,q=e+Math.cos(w)*m,w=d+Math.sin(w)*m;r(a,v,t,e,d,q,w,f)}g&2&&(t=u+h,v=c+Math.cos(t)*m,t=b+Math.sin(t)*m,w=u-h,q=c+Math.cos(w)*m,w=b+Math.sin(w)*m,r(a,v,t,c,b,q,w,f))};CanvasUtilities.boundingBox=function(a,c,b,e){this.x1=a;this.y1=c;this.x2=a+b;this.y2=c+e;this.toString=function(){return"boundingBox(("+this.x1+","+this.y1+"),("+this.x2+","+this.y2+"))"}};
CanvasUtilities.getCanvasCursorPosition=function(a,c){var b,e;"touchmove"==a.type||"touchstart"==a.type||"touchend"==a.type?(b=a.touches[0].pageX,e=a.touches[0].pageY):a.pageX||a.pageY?(b=a.pageX,e=a.pageY):(b=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,e=a.clientY+document.body.scrollTop+document.documentElement.scrollTop);b-=c.offsetLeft;e-=c.offsetTop;return[b,e]};
var SLIDER_HORIZONTAL=0,SLIDER_VERTICAL=1,CVS_BUTTON_DOWN=0,CVS_BUTTON_UP=1,CVS_BUTTON_NORMAL=0,CVS_BUTTON_TOGGLE=1,CVS_BUTTON_LEFT_ARROW=2,CVS_BUTTON_RIGHT_ARROW=3;
CanvasUtilities.button=function(a,c,b,e,d,f,g,h,m,r,u){var q=this;this.eventmanager=f;this.ctx=a;this.x=c;this.y=b;this.height=d;this.width=e;this.onchange=g;this.name=h;this.state="undefined"!=typeof r?r?CVS_BUTTON_DOWN:CVS_BUTTON_UP:CVS_BUTTON_UP;this.type="undefined"!=typeof m?m:CVS_BUTTON_NORMAL;this.toggle=this.type==CVS_BUTTON_TOGGLE?!0:!1;this.color="undefined"!=typeof u?u:"rgba(205,205,205,1)";var v=new colorObject(this.color);this.getstate=function(){return q.state};this.setstate=function(a){var b=
q.state;q.state="undefined"!=typeof a?a?CVS_BUTTON_DOWN:CVS_BUTTON_UP:CVS_BUTTON_UP;if(b!=q.state)q.onchange()};this.eventhandler=function(a,b,c){a=q.state;if("keydown"==c.type)if(13==c.keyCode)q.keyupID||(q.keyupID=q.eventmanager.listen("keyup",q.hit,q.eventhandler)),q.state=q.toggle?q.state==CVS_BUTTON_DOWN?CVS_BUTTON_UP:CVS_BUTTON_DOWN:CVS_BUTTON_DOWN;else return!0;else if("keyup"==c.type)13==c.keyCode&&(q.eventmanager.quitlistening("keyup",q.keyupID),q.toggle||(q.state=CVS_BUTTON_UP));else if("mousedown"==
c.type)q.state=q.toggle?q.state==CVS_BUTTON_DOWN?CVS_BUTTON_UP:CVS_BUTTON_DOWN:CVS_BUTTON_DOWN,!q.mouseupID&&!q.toggle&&(q.mouseupID=q.eventmanager.listen("mouseup",q.hit,q.eventhandler)),!q.mouseclickID&&!q.toggle&&(q.mouseclickID=q.eventmanager.listen("mouseclick",q.hit,q.eventhandler)),!q.mouseoutID&&!q.toggle&&(q.mouseoutID=q.eventmanager.listen("mouseout",q.hit,q.eventhandler));else if("mouseup"==c.type||"mouseclick"==c.type||"mouseout"==c.type)q.toggle||(q.state=CVS_BUTTON_UP),q.mouseupID&&
(q.eventmanager.quitlistening("mouseup",q.mouseupID),q.mouseupID=null),q.mouseclickID&&(q.eventmanager.quitlistening("mouseclick",q.mouseclickID),q.mouseclickID=null),q.mouseoutID&&(q.eventmanager.quitlistening("mouseout",q.mouseoutID),q.mouseoutID=null);return q.state!=a?(q.onchange(),cancelEvent(c)):!0};this.draw=function(){q.ctx.save();q.ctx.strokeStyle="rgb(0,0,0)";q.ctx.lineWidth=1;if(q.type==CVS_BUTTON_NORMAL)if(a.roundedRect(q.x,q.y,q.width-1,q.height-1,2,!1,!0),q.ctx.strokeStyle="rgb(255,255,255)",
a.roundedRect(q.x+1,q.y+1,q.width,q.height,2,!1,!0),q.state==CVS_BUTTON_DOWN){q.ctx.fillStyle=v.mult(0.75);a.roundedRect(q.x+1,q.y+1,q.width-3,q.height-3,2,!0,!1);var b=a.createLinearGradient(q.x+1,q.y+1,q.x+1,q.height-3+q.y);b.addColorStop(0,"rgba(180,180,180,.6)");b.addColorStop(0.3,"rgba(245,245,245,1.0)");b.addColorStop(1,"rgba(0,0,0,.5)");a.fillStyle=b;a.roundedRect(q.x+1,q.y+1,q.width-3,q.height-3,2,!0,!1)}else q.state==CVS_BUTTON_UP&&(q.ctx.fillStyle=v.mult(0.92),a.roundedRect(q.x+2,q.y+2,
q.width-4,q.height-4,2,!0,!1),b=a.createLinearGradient(q.x+2,q.y+2,q.x+2,q.height+q.y),b.addColorStop(0,"rgba(255,255,255,1)"),b.addColorStop(1,"rgba(245,245,245,0.0)"),a.fillStyle=b,a.roundedRect(q.x+2,q.y+2,q.width-4,q.height-4,2,!0,!1));else q.toggle&&(a.clearRect(q.x,q.y,q.x,q.y),a.beginPath(),a.arc(q.x+0.25*q.width,q.y+0.5*q.height,7,0,2*Math.PI,!1),a.strokeStyle="rgb(0,0,0)",a.stroke(),q.state==CVS_BUTTON_DOWN&&q.toggle&&(a.beginPath(),a.fillStyle="rgb(0,0,0)",a.arc(q.x+0.25*q.width,q.y+0.5*
q.height,2,0,2*Math.PI,!1),a.fill()));if(q.name){q.ctx.fillStyle="rgb(0,0,0)";var c=q.ctx.measureText(q.name).width,b=q.toggle||q.state==CVS_BUTTON_UP?q.y+q.height/2:q.y+q.height/2+1,c=q.toggle?q.x+0.25*q.width+20:q.x+q.width/2-c/2;a.textBaseline="middle";q.ctx.fillText(q.name,c,b)}q.ctx.restore()};this.bb=new CanvasUtilities.boundingBox(this.x,this.y,this.width,this.height);this.hit=function(a,b,c){return a>=q.bb.x1&&a<=q.bb.x2&&b>=q.bb.y1&&b<=q.bb.y2?!0:!1};this.keydown=this.eventmanager.listen("keydown",
this.hit,q.eventhandler);this.mousedownID=this.eventmanager.listen("mousedown",this.hit,q.eventhandler);this.mouseclickID=this.keyupID=this.mouseupID=null};
CanvasUtilities.slider=function(a,c,b,e,d,f,g,h,m,r,u,q,v){var t=this;this.eventmanager=u;this.ctx=a;this.x=c;this.y=b;this.length=e;this.width=d;this.orientation=f;g<=h?(this.min=g,this.max=h):(this.min=h,this.max=g);this.range=this.max-this.min;this.step=m;var w=function(a,b,c,d){a=Math.round(a);a-=a%d;a<b?a=b:a>c&&(a=c);return a};this.value=w(r,this.min,this.max,this.step);this.onchange=q;this.name=v;this.sliderWidth=this.width-2;this.getValue=function(){return t.value};this.setValue=function(a){a=
w(parseInt(a,10),t.min,t.max,t.step);a!=t.value&&(t.value=a,t.onchange())};this.eventhandler=function(a,b,c){var d=t.value;if("keydown"==c.type){if(36==c.keyCode)t.value=w(t.min,t.min,t.max,t.step);else if(35==c.keyCode)t.value=w(t.max,t.min,t.max,t.step);else if(33==c.keyCode)t.value=w(t.value+2*t.step,t.min,t.max,t.step);else if(34==c.keyCode)t.value=w(t.value-2*t.step,t.min,t.max,t.step);else if(37<=c.keyCode&&40>=c.keyCode)if(37==c.keyCode||39==c.keyCode)t.value=w(t.value+(c.keyCode-38)*t.step,
t.min,t.max,t.step);else{if(38==c.keyCode||40==c.keyCode)t.value=w(t.value-(c.keyCode-39)*t.step,t.min,t.max,t.step)}else return!0;if(t.value!=d)t.onchange();return cancelEvent(c)}if("touchmove"==c.type||"touchstart"==c.type||"touchstart"==c.type)t.mousedownID&&(t.eventmanager.quitlistening("mousedown",t.mousedownID),t.mousedownID=null),t.mousewheelID&&(t.eventmanager.quitlistening("mousewheel",t.mousewheelID),t.mousewheelID=null),t.DOMMouseScrollID&&(t.eventmanager.quitlistening("DOMMouseScroll",
t.DOMMouseScrollID),t.DOMMouseScrollID=null),t.mousemoveID&&(t.eventmanager.quitlistening("mousemove",t.mousemoveID),t.mousemoveID=null),t.mouseupID&&(t.eventmanager.quitlistening("mouseup",t.mouseupID),t.mouseupID=null),t.mouseclickID&&(t.eventmanager.quitlistening("mouseclick",t.mouseclickID),t.mouseclickID=null),"touchstart"==c.type?(null==t.touchmoveID&&(t.touchmoveID=t.eventmanager.listen("touchmove",t.hit,t.eventhandler)),null==t.touchendID&&(t.touchendID=t.eventmanager.listen("touchend",t.hit,
t.eventhandler))):"touchend"==c.type&&(t.touchmoveID&&t.eventmanager.quitlistening("touchmove",t.touchmoveID),t.touchendID&&t.eventmanager.quitlistening("touchend",t.touchendID));else{if("DOMMouseScroll"==c.type||"mousewheel"==c.type){t.value=w(t.value-wheelDirection(c)*t.step,t.min,t.max,t.step);if(t.value!=d)t.onchange();return cancelEvent(c)}if("mousedown"==c.type)t.mousemoveID||(t.mousemoveID=t.eventmanager.listen("mousemove",t.hit,t.eventhandler)),t.mouseupID||(t.mouseupID=t.eventmanager.listen("mouseup",
t.hit,t.eventhandler)),t.mouseclickID||(t.mouseclickID=t.eventmanager.listen("mouseclick",t.hit,t.eventhandler)),t.mouseoutID||(t.mouseoutID=t.eventmanager.listen("mouseout",t.hit,t.eventhandler));else if("mousemove"!=c.type)return t.mousemoveID&&(t.eventmanager.quitlistening("mousemove",t.mousemoveID),t.mousemoveID=null),t.mouseupID&&(t.eventmanager.quitlistening("mouseup",t.mouseupID),t.mouseupID=null),t.mouseclickID&&(t.eventmanager.quitlistening("mouseclick",t.mouseclickID),t.mouseclickID=null),
t.mouseoutID&&(t.eventmanager.quitlistening("mouseout",t.mouseoutID),t.mouseoutID=null),cancelEvent(c)}t.value=t.orientation===SLIDER_HORIZONTAL?w(t.min+t.range*(a-(t.x+t.sliderWidth/2))/(t.length-t.sliderWidth),t.min,t.max,t.step):w(t.max-t.range*(b-(t.y+t.sliderWidth/2))/(t.length-t.sliderWidth),t.min,t.max,t.step);if(t.value!=d)t.onchange()};this.valueToPos=function(){return this.orientation===SLIDER_HORIZONTAL?(this.length-this.sliderWidth)*((this.value-this.min)/(this.max-this.min))+this.sliderWidth/
2:(this.length-this.sliderWidth)*((this.max-this.value)/(this.max-this.min))+this.sliderWidth/2};this.draw=function(){this.ctx.save();this.ctx.translate(this.x,this.y);this.orientation===this.vertical&&(a.scale(-1,1),a.rotate(Math.PI/2));this.ctx.fillStyle="rgba(180,180,180,1)";this.ctx.fillRect(0,0,this.length,this.width);this.ctx.lineWidth=1;this.ctx.strokeStyle="rgba(255,255,255,1)";this.ctx.beginPath();this.ctx.moveTo(0,this.width);this.ctx.lineTo(this.length,this.width);this.ctx.lineTo(this.length,
0);this.ctx.stroke();this.ctx.strokeStyle="rgba(0,0,0,1)";this.ctx.beginPath();this.ctx.moveTo(0,this.width);this.ctx.lineTo(0,0);this.ctx.lineTo(this.length,0);this.ctx.stroke();this.ctx.strokeStyle="rgba(90,90,90,1)";for(var b=0;b<=this.max-this.min;b++){var c=(this.length-this.sliderWidth)/((this.max-this.min)/this.step);this.ctx.beginPath();this.ctx.arc(c*b+this.sliderWidth/2,this.width/2,0.5,0,2*Math.PI,!0);this.ctx.stroke()}this.ctx.fillStyle="rgba(230,230,230,1)";this.ctx.strokeStyle="rgba(220,220,220,1)";
b=this.valueToPos();this.ctx.lineWidth=1;this.ctx.beginPath();this.ctx.arc(b,this.width/2,this.sliderWidth/2,0,2*Math.PI,!1);this.ctx.fill();this.ctx.stroke();this.ctx.strokeStyle="rgba(255,255,255,1)";this.ctx.beginPath();this.ctx.arc(b,this.width/2,this.sliderWidth/2,0.9*Math.PI,1.6*Math.PI,!1);this.ctx.stroke();this.ctx.strokeStyle="rgba(100,100,100,1)";this.ctx.beginPath();this.ctx.arc(b,this.width/2,this.sliderWidth/2,0*Math.PI,0.65*Math.PI,!1);this.ctx.stroke();this.ctx.restore()};this.bb=this.orientation==
SLIDER_HORIZONTAL?new CanvasUtilities.boundingBox(this.x,this.y,this.length,this.width):new CanvasUtilities.boundingBox(this.x,this.y,this.width,this.length);this.hit=function(a,b,c){return a>=t.bb.x1&&a<=t.bb.x2&&b>=t.bb.y1&&b<=t.bb.y2?!0:!1};this.keydown=this.eventmanager.listen("keydown",this.hit,t.eventhandler);this.mousedownID=this.eventmanager.listen("mousedown",this.hit,t.eventhandler);this.mousewheel=this.eventmanager.listen("mousewheel",this.hit,t.eventhandler);this.DOMMouseScrollID=this.eventmanager.listen("DOMMouseScroll",
this.hit,t.eventhandler);this.touchstartID=this.eventmanager.listen("touchstart",this.hit,t.eventhandler);this.mouseclickID=this.mouseupID=this.mousemoveID=this.touchendID=this.touchmoveID=null};CanvasUtilities.eventListener=function(a,c,b,e){this.id=a;this.eventType=c;this.hit=b;this.callback=e;this.toString=function(){return"eventListener("+a+","+c+","+b+",callback)"}};
CanvasUtilities.eventManager=function(a){var c=this;this.id=0;this.queues={};this.canvasManager=a;this.listen=function(a,c,d){var f=this.queues[a];if(null==f)this.queues[a]=[],f=this.queues[a];else for(var g=0;g<f.length;g++)if(a==f[g].eventType&&c==f[g].hit&&d==f[g].callback)return alert("duplicate! ctr: "+g+" eventType: "+f[g].eventType+" x: "+f[g].boundingbox.x+" y: "+f[g].boundingbox.y+" xextent: "+f[g].boundingbox.xextent+" yextent: "+f[g].boundingbox.yextent),f[g].id;f[f.length]=new CanvasUtilities.eventListener(this.id,
a,c,d);1==f.length&&hookEvent(this.canvasManager.canvas,a,this.eventhandler);this.id+=1;return this.id-1};this.quitlistening=function(a,c){var d=this.queues[a];if(null!=d)for(var f=0;f<d.length;f++)d[f].id==c&&d.remove(f,f),0==d.length&&("mouseover"!=a&&"mouseout"!=a)&&unhookEvent(this.canvasManager.canvas,a,this.eventhandler)};this.eventhandler=function(a){var e;a||(a=window.event);c.canvasManager.canvas.focus();"mouseout"==a.type&&c.canvasManager.canvas.blur();e=CanvasUtilities.getCanvasCursorPosition(a,
c.canvasManager.canvas);var d=c.queues[a.type],f=!0;if(null!=d)for(var g=0;g<d.length;++g){var h=d[g];if(h.hit(e[0],e[1],a)){if(h.callback(e[0],e[1],a)||(f=!1),"mousedown"==a.type||"touchstart"==a.type||"mousewheel"==a.type||"DOMMouseScroll"==a.type||"touchmove"==a.type||"touchend"==a.type||"touchdown"==a.type||"keydown"==a.type)c.mousefocusedCB=h.callback}else if(h.callback==c.mousefocusedCB&&("mouseup"==a.type||"mouseout"==a.type||"click"==a.type||"mousemove"==a.type||"touchmove"==a.type||"touchend"==
a.type||"mousewheel"==a.type||"DOMMouseScroll"==a.type||"keydown"==a.type))c.mousefocusedCB(e[0],e[1],a)||(f=!1),"mousemove"!=a.type&&("touchmove"!=a.type&&"mousewheel"!=a.type&&"DOMMouseScroll"!=a.type&&"keydown"!=a.type)&&(c.mousefocusedCB=null)}return f};hookEvent(this.canvasManager.canvas,"mouseout",this.eventhandler);hookEvent(this.canvasManager.canvas,"mouseover",this.eventhandler)};
CanvasUtilities.Clock=function(a){var c=document.getElementById(a),b=c.getContext("2d"),e=Math.PI;this.now;var d=c.width/2,f=c.height/2,g=Math.min(0.85*d,0.85*f),h=g/3;this.start=function(){setInterval(CanvasUtilities.drawclock,1E3)};this.drawbody=function(){b.save();b.shadowOffsetX=Math.max(0.04*g,1);b.shadowOffsetY=Math.max(0.04*g,1);b.shadowBlur=Math.max(0.04*g,1);b.shadowColor="rgba(0,0,0,.2)";b.beginPath();b.arc(d,f,g,0,2*e,!1);b.fillStyle="rgb(255,255,180)";b.fill();b.strokeStyle="rgb(30,110,30)";
b.lineWidth=Math.max(g/5,1);b.stroke();b.strokeStyle="rgb(70,150,80)";b.lineWidth=Math.max(g/15,1);b.stroke();b.restore()};this.drawback=function(){b.save();b.beginPath();b.moveTo(d,f);b.arc(d,f,Math.max(0.03*g,1),0,2*e,!1);b.stroke();b.beginPath();for(var a=0;60>a;a++){var c=2*a*e/60,u=0.9*g*Math.cos(c)+d,q=0.9*g*Math.sin(c)+f,v=0.95*g*Math.cos(c)+d,c=0.95*g*Math.sin(c)+f;b.moveTo(u,q);b.lineTo(v,c);b.lineWidth=1;b.stroke()}b.beginPath();b.lineWidth=Math.max(0.05*g,1);for(a=0;12>a;a++)c=2*a*e/12,
u=0.8*g*Math.cos(c)+d,q=0.8*g*Math.sin(c)+f,v=0.95*g*Math.cos(c)+d,c=0.95*g*Math.sin(c)+f,b.moveTo(u,q),b.lineTo(v,c),b.stroke();u="3 4 5 6 7 8 9 10 11 12 1 2".split(" ");b.font=h+"px Times,'Times New Roman',sans-serif";b.textBaseline="middle";for(a=0;12>a;a++)c=2*a*e/12,v=0.5*g,q=v*Math.cos(c)+d-(1-Math.cos(c))/2*b.measureText(u[a]).width,c=v*Math.sin(c)+f+h/3*Math.sin(c),b.fillText(u[a],q,c);b.restore()};this.drawhands=function(){b.save();b.shadowBlur=Math.max(0.04*g,1);b.fillStyle="rgb(100,80,40,0)";
for(var a=0;a<Math.max(0.07*g,1);a+=0.1)b.shadowColor="rgba(0,0,0,.01)",b.beginPath(),b.shadowOffsetX=a,b.shadowOffsetY=a,b.arc(d,f,Math.max(0.04*g,1),0,2*e,!1),b.fill();b.shadowColor="rgba(0,5,0,.5)";b.fillStyle="rgb(0,0,0)";b.shadowOffsetX=Math.max(0.03*g,1);b.shadowOffsetY=Math.max(0.03*g,1);var a=3*e/2+2*e/12*(self.now.getHours()+self.now.getMinutes()/60),c=0.5*g*Math.cos(a)+d,h=0.5*g*Math.sin(a)+f;b.lineWidth=Math.max(0.03*g,1);CanvasUtilities.drawArrow(b,d,f,c,h,3,1,Math.PI/4,0.15*g);c=0.2*
g*Math.cos(a+e)+d;h=0.2*g*Math.sin(a+e)+f;b.beginPath();b.moveTo(d,f);b.lineWidth=Math.max(0.06*g,1);b.lineTo(c,h);b.stroke();b.shadowOffsetX=Math.max(0.05*g,1);b.shadowOffsetY=Math.max(0.05*g,1);a=3*e/2+2*e/60*self.now.getMinutes();c=0.85*g*Math.cos(a)+d;h=0.85*g*Math.sin(a)+f;b.lineWidth=Math.max(0.03*g,1);CanvasUtilities.drawArrow(b,d,f,c,h,3,1,Math.PI/4,0.2*g);c=0.25*g*Math.cos(a+e)+d;h=0.25*g*Math.sin(a+e)+f;b.beginPath();b.moveTo(d,f);b.lineWidth=Math.max(0.06*g,1);b.lineTo(c,h);b.stroke();
b.shadowOffsetX=Math.max(0.07*g,1);b.shadowOffsetY=Math.max(0.07*g,1);b.fillStyle="rgb(255,0,0)";b.strokeStyle="rgb(255,0,0)";a=3*e/2+2*e/60*self.now.getSeconds();c=0.75*g*Math.cos(a)+d;h=0.75*g*Math.sin(a)+f;b.lineWidth=1.01;CanvasUtilities.drawArrow(b,d,f,c,h,3,1,Math.PI/20,0.22*g);c=0.25*g*Math.cos(a+e)+d;h=0.25*g*Math.sin(a+e)+f;b.beginPath();b.moveTo(d,f);b.lineWidth=Math.max(0.04*g,1);b.lineTo(c,h);b.stroke();b.fillStyle="rgb(100,80,40)";b.beginPath();b.arc(d,f,Math.max(0.04*g,1),0,2*e,!1);
b.fill();b.restore();b.beginPath();b.moveTo(d,f);b.fillStyle="rgb(255,255,0)";b.arc(d,f,Math.max(0.03*g,1),0,2*e,!1);b.fill()};this.drawhighlights=function(){b.save();b.shadowOffsetX=Math.max(0.05*g,1);b.shadowOffsetY=Math.max(0.05*g,1);b.shadowBlur=Math.max(0.08*g,1);b.shadowColor="rgba(0,0,0,.5)";b.strokeStyle="rgba(255,255,255,.40)";b.lineWidth=Math.max(0.1*g,1);b.beginPath();b.arc(d,f,0.9*g,0,2*e,!1);b.stroke();b.strokeStyle="rgba(255,255,255,.45)";b.lineWidth=Math.max(0.03*g,1);b.beginPath();
b.arc(d,f,0.9*g,0,2*e,!1);b.stroke();b.beginPath();var a=b.createRadialGradient(d+0.1*g,f-0.3*g,10,d,f,g);a.addColorStop(0,"rgba(255,255,255,.2)");a.addColorStop(0.01,"rgba(255,255,255,.1)");a.addColorStop(1,"rgba(255,255,255,0)");b.fillStyle=a;b.arc(d,f,g,0,2*e,!1);b.fill();b.restore()};this.drawclock=function(){b.save();this.now=new Date;b.clearRect(0,0,c.width,c.height);b.strokeStyle="rgb(0,0,0)";b.fillStyle="rgb(0,0,0)";b.shadowOffsetX=0;b.shadowOffsetY=0;b.shadowBlur=0;b.shadowColor="rgba(0,0,0,0)";
drawbody();drawback();drawhands();drawhighlights();delete this.now}};function GLTools(){GLTools.prototype.RenderLayer=function(a,c){id=c.i;cl=c.c;ll=c.g;if(null!=ll)for(l=0;l<ll.length;++l){lines=ll[l];for(li=0;li<lines.length;++li){line=lines[li];a.beginPath();a.moveTo(line[0],line[1]);for(p=2;p<line.length-1;p+=2)a.lineTo(line[p],line[p+1]);"c"==line[line.length-1]&&a.closePath();this[cl](a)}}};GLTools.prototype.LoadCanvasAsTexture=function(a,c,b){var e=a.createTexture();e.isLoad=!1;e.error=!1;e.req=$.ajax({type:"GET",url:c,dataType:"json",success:function(c,f,g){e.svgRenderer=
document.createElement("canvas");e.svgRenderer.height=256;e.svgRenderer.width=256;for(i=0;i<c.l.length;++i)RenderLayer(e.svgRenderer.getContext("2d"),c.l[i]);a.bindTexture(a.TEXTURE_2D,e);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,e.svgRenderer);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.bindTexture(a.TEXTURE_2D,null);e.isLoad=!0;e.Error=!1;b()},error:function(a,
f,g){e.isLoad=!0;e.error=!0;console.log(c+" : loading failed : "+f);b({},{})}});return e};GLTools.prototype.LoadSvgAsTexture=function(a,c,b){var e=a.createTexture();e.isLoad=!1;e.error=!1;var d=new Image;e.req=$.ajax({type:"GET",url:c,dataType:"text",success:function(c,g,h){d.onload=function(){e.svgRenderer=document.createElement("canvas");e.svgRenderer.getContext("2d").drawImage(d,0,0);a.bindTexture(a.TEXTURE_2D,e);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,
a.UNSIGNED_BYTE,e.svgRenderer);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.bindTexture(a.TEXTURE_2D,null);e.isLoad=!0;e.Error=!1;b()};d.src="data:image/svg+xml;base64,"+btoa(c)},error:function(a,d,e){shader.isLoad=!0;shader.error=!0;console.log(c+" : loading failed : "+d);b({},{})}});return e};GLTools.prototype.CreateFrameBufferTex=function(a,c,b){var e=a.createFramebuffer(),d=a.createTexture();a.bindFramebuffer(a.FRAMEBUFFER,
e);e.width=c;e.height=b;a.bindTexture(a.TEXTURE_2D,d);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,e.width,e.height,0,a.RGBA,a.UNSIGNED_BYTE,null);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,d,0);a.bindTexture(a.TEXTURE_2D,null);a.bindFramebuffer(a.FRAMEBUFFER,null);return[e,d]};GLTools.prototype.BuildShader=function(a,c){var b={error:!1,obj:null};b.attributes=
c.attributes;b.parameters=c.parameters;if("x-shader/x-fragment"==c.type)b.obj=a.createShader(a.FRAGMENT_SHADER);else if("x-shader/x-vertex"==c.type)b.obj=a.createShader(a.VERTEX_SHADER);else{b.error=!0;return}a.shaderSource(b.obj,c.code);a.compileShader(b.obj);a.getShaderParameter(b.obj,a.COMPILE_STATUS)||(b.error=!0,console.log("Build "+c.name+" : Failed ! "),console.log(a.getShaderInfoLog(b.obj)));return b};GLTools.prototype.MakeProgram=function(a,c,b){if(!b.shaderData)return console.log("invalid shader data"),
null;if(!(a in b.shaderData))return console.log(a+" not in shader data"),null;if(!(c in b.shaderData))return console.log(c+" not in shader data"),null;var e=b.shaderData[a];e.name=a;var d=b.shaderData[c];d.name=c;b=b.ctx;e=this.BuildShader(b,e);d=this.BuildShader(b,d);if(e.error||d.error)return null;var f=b.createProgram();f.error=!1;f.attr={};f.params={};var g={},h={};jQuery.extend(g,e.attributes);jQuery.extend(h,e.parameters);jQuery.extend(g,d.attributes);jQuery.extend(h,d.parameters);b.attachShader(f,
e.obj);b.attachShader(f,d.obj);b.linkProgram(f);if(b.getProgramParameter(f,b.LINK_STATUS)){b.useProgram(f);for(var m in g)f.attr[m]=b.getAttribLocation(f,g[m]);for(m in h)f.params[m]=b.getUniformLocation(f,h[m]);return f}console.log("Could not link programm with "+a+" and "+c);f.error=!0};GLTools.prototype.LoadTexture=function(a,c,b){var e=a.createTexture();e.isLoad=!1;e.error=!1;var d=new Image;d.onload=function(){a.bindTexture(a.TEXTURE_2D,e);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,
0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,d);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.bindTexture(a.TEXTURE_2D,null);e.isLoad=!0;delete d;b()};d.onerror=function(){e.isLoad=!0;e.error=!0;delete d};d.onabort=function(){e.isLoad=!0;e.error=!0;delete d};d.src=c;return e};GLTools.prototype.LoadCsvTexture=function(a,c,b){document.createElement("canvas");canvg(this.svgRenderer,"test/auv.svg");var e=a.createTexture();e.isLoad=!1;e.error=
!1;var d=new Image;d.onload=function(){a.bindTexture(a.TEXTURE_2D,e);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,d);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.bindTexture(a.TEXTURE_2D,null);e.isLoad=!0;delete d;b()};d.onerror=function(){e.isLoad=!0;e.error=!0;delete d};d.onabort=function(){e.isLoad=!0;e.error=!0;delete d};d.src=c;return e};GLTools.prototype.LoadData=
function(a,c){var b=a.createTexture();b.isLoad=!1;b.error=!1;b.req=$.ajax({type:"GET",url:c,dataType:"json",success:function(c,d,f){b.isLoad=!0;b.error=!1;a.bindTexture(a.TEXTURE_2D,b);a.texImage2D(a.TEXTURE_2D,0,a[c.input_type],c.width,c.height,0,a[c.output_type],a.UNSIGNED_BYTE,new Uint8Array(c.data));a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST)},error:function(a,d,f){b.isLoad=!0;b.error=!0;console.log(c+" : loading failed : "+
d)}});b.src=c;return b}};function ImageLayer(a,c){this.mapParameters=a;this.assets=a.assets;this.gl=a.assets.ctx;this.data=this.tex=null;this.h=this.w=0;this.z=c}ImageLayer.prototype.GetType=function(){return LayersManager.Raster};ImageLayer.prototype.Init=function(a){!this.tex&&a&&(this.w=a.width,this.h=a.height,this.data=a)};ImageLayer.prototype.Reset=function(){var a=this.gl;this.tex&&(a.deleteTexture(this.tex),delete this.tex,this.tex=null)};
ImageLayer.prototype.Release=function(){var a=this.gl;this.tex&&(a.deleteTexture(this.tex),delete this.tex,this.tex=null);this.data&&(delete this.data,this.data=null)};ImageLayer.prototype.IsUpToDate=function(){return null!=this.tex};
ImageLayer.prototype.Update=function(a){if(this.tex)return 1;a=this.gl;if(null!=this.data)this.tex=a.createTexture(),a.bindTexture(a.TEXTURE_2D,this.tex),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.data),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.bindTexture(a.TEXTURE_2D,null);else{this.tex=a.createTexture();a.bindTexture(a.TEXTURE_2D,this.tex);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,
!1);var c=new Uint8Array([1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0]);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,2,2,0,a.RGBA,a.UNSIGNED_BYTE,c);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.bindTexture(a.TEXTURE_2D,null);this.h=this.w=2}return 2};function RasterLayer(a,c){this.mapParameters=a;this.assets=a.assets;this.gl=a.assets.ctx;this.data=this.tex=null;this.h=this.w=0;this.z=c}RasterLayer.prototype.GetType=function(){return LayersManager.Raster};RasterLayer.prototype.Init=function(a){if(!this.tex&&a){var c=new Uint8Array(a),b=c[0]+1,c=new Uint8Array(a.slice(1));a=c.length/b;this.w=b;this.h=a;this.data=c}};RasterLayer.prototype.Reset=function(){var a=this.gl;this.tex&&(a.deleteTexture(this.tex),delete this.tex,this.tex=null)};
RasterLayer.prototype.Release=function(){var a=this.gl;this.tex&&(a.deleteTexture(this.tex),delete this.tex,this.tex=null);this.data&&(delete this.data,this.data=null)};RasterLayer.prototype.IsUpToDate=function(){return null!=this.tex};
RasterLayer.prototype.Update=function(a){if(this.tex)return 1;var c=this.gl;a=this.mapParameters.GetColorBar(a.colorbar);if(!a||!a.tex)return console.log("Invalid color bar : setting default"),this.mapParameters.SetDefaultColorBar(),1;if(this.data){var b=(new GLTools).CreateFrameBufferTex(c,this.w,this.h),e=c.createTexture();this.tex=b[1];c.bindTexture(c.TEXTURE_2D,e);c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!1);c.texImage2D(c.TEXTURE_2D,0,c.LUMINANCE,this.w,this.h,0,c.LUMINANCE,c.UNSIGNED_BYTE,this.data);
c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE);c.bindFramebuffer(c.FRAMEBUFFER,b[0]);this.gl.clearColor(1,1,1,1);this.gl.disable(this.gl.DEPTH_TEST);c.viewport(0,0,b[0].width,b[0].height);c.clear(c.COLOR_BUFFER_BIT);mvMatrix=mat4.create();pMatrix=mat4.create();mat4.identity(mvMatrix);mat4.scale(mvMatrix,
[this.w/MapParameters.tileSize,this.h/MapParameters.tileSize,1]);mat4.identity(pMatrix);mat4.ortho(0,b[0].width,0,b[0].height,0,1,pMatrix);var d=this.assets.prog.Clut;c.useProgram(d);c.uniformMatrix4fv(d.params.pMatrixUniform,!1,pMatrix);c.uniformMatrix4fv(d.params.mvMatrixUniform,!1,mvMatrix);c.bindBuffer(c.ARRAY_BUFFER,this.assets.squareVertexPositionBuffer);c.enableVertexAttribArray(d.attr.vertexPositionAttribute);c.vertexAttribPointer(d.attr.vertexPositionAttribute,this.assets.squareVertexPositionBuffer.itemSize,
c.FLOAT,!1,0,0);c.bindBuffer(c.ARRAY_BUFFER,this.assets.squareVertexTextureBuffer);c.enableVertexAttribArray(d.attr.textureCoordAttribute);c.vertexAttribPointer(d.attr.textureCoordAttribute,this.assets.squareVertexTextureBuffer.itemSize,c.FLOAT,!1,0,0);c.activeTexture(c.TEXTURE0);c.bindTexture(c.TEXTURE_2D,e);c.uniform1i(d.params.uSamplerTex1,0);c.activeTexture(c.TEXTURE1);c.bindTexture(c.TEXTURE_2D,a.tex);c.uniform1i(d.params.uSamplerTex2,1);c.uniform4fv(d.params.uParams,[0,2,0,1]);c.drawArrays(c.TRIANGLE_STRIP,
0,this.assets.squareVertexPositionBuffer.numItems);c.bindFramebuffer(c.FRAMEBUFFER,null);c.activeTexture(c.TEXTURE0);c.bindTexture(c.TEXTURE_2D,null);c.activeTexture(c.TEXTURE1);c.bindTexture(c.TEXTURE_2D,null);c.deleteTexture(e);c.deleteFramebuffer(b[0])}else this.tex=c.createTexture(),c.bindTexture(c.TEXTURE_2D,this.tex),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!1),a=new Uint8Array([1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0]),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,2,2,0,c.RGBA,c.UNSIGNED_BYTE,a),c.texParameteri(c.TEXTURE_2D,
c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.bindTexture(c.TEXTURE_2D,null),this.h=this.w=2;return 2};function Tile(a,c,b,e,d){this.parameters=a;this.config=c;this.x=b;this.y=e;this.z=d;this.assets=a.assets;this.gl=a.assets.ctx;this.error=!1;this.layers={};this.data={};this.requests={};this.load={};this.errors={};this.frameBufferL=[];this.texL=[];this.tex=null;this.Init()}Tile.prototype.Init=function(){this.initLayers();this.loadSources();this.prepareBuffering()};
Tile.prototype.initLayers=function(){for(var a=0;a<this.config.layers.length;a++)switch(this.config.layers[a].type){case LayersManager.Vector:this.layers[a]=new VectorialLayer(this.parameters,this.z);break;case LayersManager.Raster:this.layers[a]=new RasterLayer(this.parameters,this.z);break;case LayersManager.Images:this.layers[a]=new ImageLayer(this.parameters,this.z)}};
Tile.prototype.loadSources=function(){for(var a=0;a<this.parameters.sources.length;a++){var c=this.parameters.sources[a];if(this.requests[c.type])return!1;switch(c.type){case Source.MaperialOSM:this.LoadVectorial(c);break;case Source.Raster:this.LoadRaster(c);break;case Source.Images:this.LoadImage(c)}}};Tile.prototype.prepareBuffering=function(){for(var a=new GLTools,c=0;2>c;c+=1){var b=a.CreateFrameBufferTex(this.gl,MapParameters.tileSize,MapParameters.tileSize);this.frameBufferL.push(b[0]);this.texL.push(b[1])}};
Tile.prototype.Release=function(){for(var a=0;a<this.parameters.sources.length;a++){a=this.parameters.sources[a];this.requests[a.type]&&this.requests[a.type].abort();for(var c=0;c<this.config.layers.length;c++)this.config.layers[c].source.type==a.type&&this.layers[c].Release();delete this.data[a.type];c=this.gl;for(a=0;2>a;a+=1)c.deleteFramebuffer(this.frameBufferL[a]),c.deleteTexture(this.texL[a])}};
Tile.prototype.Reset=function(){if(this.IsLoaded()){for(i in this.layers)this.layers[i].Reset();this.tex=null}};Tile.prototype.IsLoaded=function(){for(var a=0;a<this.parameters.sources.length;a++)if(!this.load[this.parameters.sources[a].type])return!1;return!0};Tile.prototype.IsUpToDate=function(){return this.tex};
Tile.prototype.LoadVectorial=function(a){var c=this;this.requests[a.type]=$.ajax({type:"GET",url:a.getURL(this.x,this.y,this.z),dataType:"json",timeout:MapParameters.tileDLTimeOut,success:function(b,e,d){b?c.data[a.type]=b:c.error[a.type]=!0;c.appendDataToLayers(a.type,b);c.load[a.type]=!0},error:function(b,e,d){c.error[a.type]=!0;c.load[a.type]=!0;c.appendDataToLayers(a.type,null)}})};
Tile.prototype.LoadImage=function(a){var c=a.getURL(this.x,this.y,this.z),b=this;this.requests[a.type]=new Image;this.requests[a.type].onload=function(c){c=b.requests[a.type];b.error[a.type]=!1;b.load[a.type]=!0;b.appendDataToLayers(a.type,c)};this.requests[a.type].onerror=function(c){b.error[a.type]=!0;b.load[a.type]=!0;b.appendDataToLayers(a.type,null)};this.requests[a.type].abort=function(){this.src=""};setTimeout(function(){b.requests[a.type].abort()},MapParameters.tileDLTimeOut);this.requests[a.type].crossOrigin=
"";this.requests[a.type].src=c};
Tile.prototype.LoadRaster=function(a){function c(){b.requests[a.type].abort()}if(a.getURL(this.x,this.y,this.z)){var b=this;this.requests[a.type]=new XMLHttpRequest;this.requests[a.type].open("GET",a.getURL(this.x,this.y,this.z),!0);this.requests[a.type].responseType="arraybuffer";this.requests[a.type].onload=function(c){if((c=b.requests[a.type].response)&&(200!=b.requests[a.type].status||0>=c.byteLength))c=null;b.error[a.type]=null!=c;b.load[a.type]=!0;b.appendDataToLayers(a.type,c)};this.requests[a.type].onerror=
function(c){b.error[a.type]=!0;b.load[a.type]=!0;b.appendDataToLayers(a.type,null)};setTimeout(c,MapParameters.tileDLTimeOut);this.requests[a.type].send(null)}else this.error[a.type]=!0,this.load[a.type]=!0};Tile.prototype.appendDataToLayers=function(a,c){for(var b=0;b<this.config.layers.length;b++)try{this.config.layers[b].source.type==a&&this.layers[b].Init(c)}catch(e){}};
Tile.prototype.RenderVectorialLayers=function(a,c,b){for(i in this.layers)this.layers[i].GetType()==LayersManager.Vector&&(this.layers[i].IsUpToDate()&&this.layers[i].cnv)&&a.drawImage(this.layers[i].cnv,c,b)};
Tile.prototype.FindSubLayerId=function(a,c,b){var e=document.getElementById("dummyTilesCanvas"),d=e.getContext("2d");ExtendCanvasContext(d);e.height=1;e.width=1;d.translate(-a.x,-a.y);for(e=this.config.layers.length-1;0<=e;--e)if(this.config.layers[e].source.type==Source.MaperialOSM){var f=TileRenderer.FindSubLayerId(a,d,this.data[Source.MaperialOSM],c,b,e,this.context.osmVisibilities);if(f)return f}};
Tile.prototype.Update=function(a){if(this.IsUpToDate()||!this.IsLoaded())return a-1;for(var c=0;c<this.config.layers.length&&(this.layers[c].IsUpToDate()||!(a-=this.layers[c].Update(this.config.layers[c].params,c),0>=a));c++);var b=!0;for(c in this.layers)this.layers[c].IsUpToDate()||(b=!1);b&&this.Compose();return a};
Tile.prototype.Fuse=function(a,c,b,e,d){var f=this.gl;f.bindFramebuffer(f.FRAMEBUFFER,b);this.gl.clearColor(1,1,1,1);this.gl.disable(this.gl.DEPTH_TEST);f.viewport(0,0,b.width,b.height);f.clear(f.COLOR_BUFFER_BIT);mvMatrix=mat4.create();pMatrix=mat4.create();mat4.identity(pMatrix);mat4.identity(mvMatrix);mat4.ortho(0,b.width,0,b.height,0,1,pMatrix);this.gl.useProgram(e);this.gl.uniformMatrix4fv(e.params.pMatrixUniform,!1,pMatrix);this.gl.uniformMatrix4fv(e.params.mvMatrixUniform,!1,mvMatrix);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,
this.assets.squareVertexPositionBuffer);this.gl.enableVertexAttribArray(e.attr.vertexPositionAttribute);this.gl.vertexAttribPointer(e.attr.vertexPositionAttribute,this.assets.squareVertexPositionBuffer.itemSize,this.gl.FLOAT,!1,0,0);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.assets.squareVertexTextureBuffer);this.gl.enableVertexAttribArray(e.attr.textureCoordAttribute);this.gl.vertexAttribPointer(e.attr.textureCoordAttribute,this.assets.squareVertexTextureBuffer.itemSize,this.gl.FLOAT,!1,0,0);this.gl.activeTexture(this.gl.TEXTURE0);
this.gl.bindTexture(this.gl.TEXTURE_2D,a);this.gl.uniform1i(e.params.uSamplerTex1,0);this.gl.activeTexture(this.gl.TEXTURE1);this.gl.bindTexture(this.gl.TEXTURE_2D,c);this.gl.uniform1i(e.params.uSamplerTex2,1);this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,this.assets.squareVertexPositionBuffer.numItems);for(var g in d)this.gl.uniform3fv(e.params[g],d[g]);f.bindFramebuffer(f.FRAMEBUFFER,null);this.gl.activeTexture(this.gl.TEXTURE0);this.gl.bindTexture(this.gl.TEXTURE_2D,null);this.gl.activeTexture(this.gl.TEXTURE1);
this.gl.bindTexture(this.gl.TEXTURE_2D,null)};
Tile.prototype.Copy=function(a,c){var b=this.gl;b.bindFramebuffer(b.FRAMEBUFFER,c);this.gl.clearColor(1,1,1,1);this.gl.disable(this.gl.DEPTH_TEST);b.viewport(0,0,c.width,c.height);b.clear(b.COLOR_BUFFER_BIT);mvMatrix=mat4.create();pMatrix=mat4.create();mat4.identity(pMatrix);mat4.identity(mvMatrix);mat4.ortho(0,c.width,0,c.height,0,1,pMatrix);var e=this.assets.prog.Tex;this.gl.useProgram(e);this.gl.uniformMatrix4fv(e.params.pMatrixUniform,!1,pMatrix);this.gl.uniformMatrix4fv(e.params.mvMatrixUniform,
!1,mvMatrix);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.assets.squareVertexPositionBuffer);this.gl.enableVertexAttribArray(e.attr.vertexPositionAttribute);this.gl.vertexAttribPointer(e.attr.vertexPositionAttribute,this.assets.squareVertexPositionBuffer.itemSize,this.gl.FLOAT,!1,0,0);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.assets.squareVertexTextureBuffer);this.gl.enableVertexAttribArray(e.attr.textureCoordAttribute);this.gl.vertexAttribPointer(e.attr.textureCoordAttribute,this.assets.squareVertexTextureBuffer.itemSize,
this.gl.FLOAT,!1,0,0);this.gl.activeTexture(this.gl.TEXTURE0);this.gl.bindTexture(this.gl.TEXTURE_2D,a);this.gl.uniform1i(e.params.uSamplerTex1,0);this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,this.assets.squareVertexPositionBuffer.numItems);b.bindFramebuffer(b.FRAMEBUFFER,null);this.gl.activeTexture(this.gl.TEXTURE0);this.gl.bindTexture(this.gl.TEXTURE_2D,null)};
Tile.prototype.Compose=function(){var a=this.layers[0].tex,c=this.frameBufferL[0],b=0;if(1<this.config.layers.length)for(var e=1;e<this.config.layers.length;e++){var d=this.layers[e].tex;d?this.Fuse(a,d,c,this.assets.prog[this.config.layers[e].composition.shader],this.config.layers[e].composition.params):this.Copy(a,c);this.tex=a=this.texL[b];b=(b+1)%2;c=this.frameBufferL[b]}else this.Copy(a,c),this.tex=this.texL[0]};
Tile.prototype.Render=function(a,c){if(this.IsUpToDate()){var b=this.assets.prog.Tex;this.gl.useProgram(b);this.gl.uniformMatrix4fv(b.params.pMatrixUniform,!1,a);this.gl.uniformMatrix4fv(b.params.mvMatrixUniform,!1,c);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.assets.squareVertexPositionBuffer);this.gl.enableVertexAttribArray(b.attr.vertexPositionAttribute);this.gl.vertexAttribPointer(b.attr.vertexPositionAttribute,this.assets.squareVertexPositionBuffer.itemSize,this.gl.FLOAT,!1,0,0);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,
this.assets.squareVertexTextureBuffer);this.gl.enableVertexAttribArray(b.attr.textureCoordAttribute);this.gl.vertexAttribPointer(b.attr.textureCoordAttribute,this.assets.squareVertexTextureBuffer.itemSize,this.gl.FLOAT,!1,0,0);this.gl.activeTexture(this.gl.TEXTURE0);this.gl.bindTexture(this.gl.TEXTURE_2D,this.tex);var e=this.gl.getError();0!=e&&console.log(e);this.gl.uniform1i(b.params.uSamplerTex1,0);this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,this.assets.squareVertexPositionBuffer.numItems);this.gl.activeTexture(this.gl.TEXTURE0);
this.gl.bindTexture(this.gl.TEXTURE_2D,null)}};VectorialLayer.BACK="back";VectorialLayer.FRONT="front";function VectorialLayer(a,c){this.mapParameters=a;this.assets=a.assets;this.gl=a.assets.ctx;this.data=this.ctx=this.tex=this.cnv=null;this.z=c;this.layerCount=0}VectorialLayer.prototype.GetType=function(){return LayersManager.Vector};
VectorialLayer.prototype.Init=function(a){if(!this.tex){this.data=a;var c=this.gl;a?(this.tex=c.createTexture(),this.cnv=document.createElement("canvas"),this.cnv.height=MapParameters.tileSize,this.cnv.width=MapParameters.tileSize,this.ctx=this.cnv.getContext("2d"),ExtendCanvasContext(this.ctx),this.ctx.globalCompositeOperation="source-over",this.ctx.beginPath(),this.ctx.rect(0,0,this.cnv.width,this.cnv.height),this.ctx.closePath(),this.ctx.fillStyle="rgba(255,255,255,0.0)",this.ctx.fill()):(this.tex=
c.createTexture(),this.layerCount=null,c.bindTexture(c.TEXTURE_2D,this.tex),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!1),a=new Uint8Array([1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0]),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,2,2,0,c.RGBA,c.UNSIGNED_BYTE,a),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.bindTexture(c.TEXTURE_2D,null))}};
VectorialLayer.prototype.Reset=function(){this.layerCount=0;delete this.cnv;this.cnv=document.createElement("canvas");this.cnv.height=MapParameters.tileSize;this.cnv.width=MapParameters.tileSize;this.ctx=this.cnv.getContext("2d");ExtendCanvasContext(this.ctx);this.ctx.globalCompositeOperation="source-over";this.ctx.beginPath();this.ctx.closePath()};
VectorialLayer.prototype.Release=function(){var a=this.gl;this.tex&&(a.deleteTexture(this.tex),delete this.tex,this.tex=0);this.cnv&&(delete this.cnv,this.cnv=null)};VectorialLayer.prototype.IsUpToDate=function(){return null==this.layerCount};
VectorialLayer.prototype.Update=function(a,c){var b=this.mapParameters.maperial.context.osmVisibilities,e=this.mapParameters.maperial.stylesManager.getStyle(a.styles[a.selectedStyle]).content;e||(console.log("Invalid style"),this.layerCount=0,this._BuildTexture());b=TileRenderer.RenderLayers(b,c,this.ctx,this.data,this.z,e,this.layerCount);this.layerCount=b[0];this.IsUpToDate()&&this._BuildTexture();return b[1]};
VectorialLayer.prototype._BuildTexture=function(){var a=this.gl;a.bindTexture(a.TEXTURE_2D,this.tex);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.cnv);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.bindTexture(a.TEXTURE_2D,null)};function RenderLine(a,c){a.beginPath();a.moveTo(c[0],c[1]);for(var b=2;b<c.length-1;b+=2)a.lineTo(c[b],c[b+1]);"c"==c[c.length-1]&&a.closePath()}
function RenderLineDA(a,c,b){0!=b.length%2&&(b=b.concat(b));c=c.slice(0);var e=!1;"c"==c[c.length-1]?(c.pop(),c.push(c[0]),c.push(c[1]),e=!0):c.pop();if(4>c.length)RenderLine(a,c);else{a.beginPath();a.moveTo(c[0],c[1]);for(var d=0,f=b.length,g=0,h=0,m=0;m<c.length-4;m+=2)for(var r=c[m+0],u=c[m+1],q=c[m+2]-r,v=c[m+3]-u,t=Math.sqrt(q*q+v*v);;){0==g?h+=b[d]:(h+=g,g=0);if(h>=t){0==d%2?a.lineTo(x,w):a.moveTo(x,w);g=h-t;h=0;0==g&&(d=(d+1)%f);break}var w=h/t,x=r+q*w,w=u+v*w;0==d%2?a.lineTo(x,w):a.moveTo(x,
w);d=(d+1)%f}e&&a.closePath()}};var FontFamily=function(){var a={},c={oblique:"italic",italic:"oblique"};this.add=function(b){(a[b.style]||(a[b.style]={}))[b.weight]=b};this.get=function(b,e){"undefined"===typeof b&&(b="normal");"undefined"===typeof e&&(e="normal");var d=a[b]||a[c[b]]||a.normal||a.italic||a.oblique;if(!d)return null;e={normal:400,bold:700}[e]||parseInt(e,10);if(d[e])return d[e];var f={1:1,99:0}[e%100],g=[],h,m;void 0===f&&(f=400<e);500==e&&(e=400);for(var r in d)if(hasOwnProperty(d,r)){r=parseInt(r,10);if(!h||r<
h)h=r;if(!m||r>m)m=r;g.push(r)}e<h&&(e=h);e>m&&(e=m);g.sort(function(a,b){return(f?a>=e&&b>=e?a<b:a>b:a<=e&&b<=e?a>b:a<b)?-1:1});return d[g[0]]}},globalFonts=function(){var a={d:{},Add:function(c){if(!c)return api;c=new Font(c);var b=c.family;a.d[b]||(a.d[b]=new FontFamily);a.d[b].add(c);return a},Get:function(c,b,e){return!a.d[c]?null:a.d[c].get(b,e)}};return a}();function FollowLine(a){4>a.length?console.log("Invalid line"):(this.l=a,this.pi=this.acc=0)}
FollowLine.prototype.IsValid=function(a){return void 0!==this.l};
FollowLine.prototype.Advance=function(a){if(this.pi+3>=this.l.length)return null;var c=[this.l[this.pi],this.l[this.pi+1]],b=[this.l[this.pi+2],this.l[this.pi+3]],e=[b[0]-c[0],b[1]-c[1]],d=Math.sqrt(e[0]*e[0]+e[1]*e[1]),f=[e[0]/d,e[1]/d],b=[f[1],-f[0]],g=this.acc+a;a=[c[0]+f[0]*this.acc,c[1]+f[1]*this.acc];f=[0,0];intPoints=[];if(g>d){for(;g>d;)if(this.pi+=2,this.pi+3<this.l.length)g-=d,c=[this.l[this.pi],this.l[this.pi+1]],b=[this.l[this.pi+2],this.l[this.pi+3]],e=[b[0]-c[0],b[1]-c[1]],d=Math.sqrt(e[0]*
e[0]+e[1]*e[1]),intPoints.push(c[0]),intPoints.push(c[1]);else return null;f=[e[0]/d,e[1]/d];b=[c[0]+f[0]*g,c[1]+f[1]*g];c=[b[0]-a[0],b[1]-a[1]];b=Math.sqrt(c[0]*c[0]+c[1]*c[1]);b=[c[0]/b,c[1]/b];b=[b[1],-b[0]];c=[a[0]+c[0]/2,a[1]+c[1]/2];for(d=e=0;d<intPoints.length;d+=2)var h=[intPoints[d]-c[0],intPoints[d+1]-c[1]],f=Math.sqrt(h[0]*h[0]+h[1]*h[1]),h=[h[0]/f,h[1]/f],e=e+(h[0]*b[0]+h[1]*b[1])*f;e/=intPoints.length/2+2;f=[b[0]*e,b[1]*e]}this.acc=g;g=Math.acos(-b[1]);0>b[0]&&(g=-g);return[a[0]+f[0],
a[1]+f[1],g]};function TextOnLine(a,c,b,e){c=new FollowLine(c);if(c.IsValid())for(i in a.beginPath(),b){var d=b[i],f=a.measureText(d).width,f=c.Advance(f);if(!f)break;a.save();a.translate(f[0],f[1]);a.rotate(f[2]);e?a.fillText(d,0,0):a.strokeText(d,0,0);a.restore()}}function hasOwnProperty(a,c){return a.hasOwnProperty(c)}
var FontSize=function(a,c){this.value=parseFloat(a);this.unit=String(a).match(/[a-z%]*$/)[0]||"px";this.convert=function(a){return a/c*this.value};this.convertFrom=function(a){return a/this.value*c};this.toString=function(){return this.value+this.unit}},Font=function(a){var c=this.face=a.face,b=[],e={" ":1,"\u00a0":1,"\u3000":1};this.glyphs=function(a){var b,c={"\u2011":"-","\u00ad":"\u2011"};for(b in c)hasOwnProperty(c,b)&&(a[b]||(a[b]=a[c[b]]));return a}(a.glyphs);this.w=a.w;this.baseSize=parseInt(c["units-per-em"],
10);this.family=c["font-family"].toLowerCase();this.weight=c["font-weight"];this.style=c["font-style"]||"normal";this.viewBox=function(){var a=c.bbox.split(/\s+/),a={minX:parseInt(a[0],10),minY:parseInt(a[1],10),maxX:parseInt(a[2],10),maxY:parseInt(a[3],10)};a.width=a.maxX-a.minX;a.height=a.maxY-a.minY;a.toString=function(){return[this.minX,this.minY,this.width,this.height].join(" ")};return a}();this.ascent=-parseInt(c.ascent,10);this.descent=-parseInt(c.descent,10);this.height=-this.ascent+this.descent;
this.spacing=function(a,b,c){for(var h=this.glyphs,m,r,u=[],q=0,v=-1,t=-1,w;w=a[++v];)if(m=h[w]||this.missingGlyph)r&&(q-=r=r[w]||0,u[t]-=r),r=m.w,isNaN(r)&&(r=+this.w),0<r&&(r+=b,e[w]&&(r+=c)),q+=u[++t]=~~r,r=m.k;u.total=q;return u};this.applyLigatures=function(a,c){for(var e=0,h;e<b.length&&!h;e++)b[e].ligatures===c&&(h=b[e]);if(!h){var e=[],m;for(m in c)this.glyphs[c[m]]&&e.push(m);m=e.sort(function(a,b){return b.length-a.length||a>b}).join("|");b.push(h={ligatures:c,regexp:0<m.length?regexpCache[m]||
(regexpCache[m]=RegExp(m,"g")):null})}return h.regexp?a.replace(h.regexp,function(a){return c[a]||a}):a}};
function RenderTextCufon(a,c,b,e,d,f){d=new FollowLine(d);if(d.IsValid()){var g=parseInt(c.face["x-height"])/100*b.value,h=c.viewBox;a=a.split("");var m=c.spacing(a,~~b.convertFrom(0),~~b.convertFrom(0));if(!m.length)return null;b=b.convert(h.height);Math.ceil(b);b/=h.height;e.save();f||(e.lineWidth/=b);for(var h=c.glyphs,r,u=-1,q=-1,v=0;a[++u];){var t=d.Advance(m[q+1]*b);if(!t)break;e.save();e.translate(t[0],t[1]);e.rotate(t[2]);e.translate(0,g);e.scale(b,b);if(r=h[a[u]]||c.missingGlyph){if(r.d){e.beginPath();
e.moveTo(0,0);if(r.code){t=r.code;r=e;for(var w=0,x=t.length;w<x;++w){var A=t[w];r[A.m].apply(r,A.a)}}else{t=r;r="m"+r.d;var w=e,A=x=0,y=[],C=/([mrvxe])([^a-z]*)/g,B=void 0,E=0;a:for(;B=C.exec(r);++E){var D=B[2].split(",");switch(B[1]){case "v":y[E]={m:"bezierCurveTo",a:[x+~~D[0],A+~~D[1],x+~~D[2],A+~~D[3],x+=~~D[4],A+=~~D[5]]};break;case "r":y[E]={m:"lineTo",a:[x+=~~D[0],A+=~~D[1]]};break;case "m":y[E]={m:"moveTo",a:[x=~~D[0],A=~~D[1]]};break;case "x":y[E]={m:"closePath"};break;case "e":break a}w[y[E].m].apply(w,
y[E].a)}t.code=y}f?e.fill():e.stroke()}v+=m[++q];e.restore()}}e.restore()}}
function ExtendCanvasContext(a){Object.getPrototypeOf(a).fillTextOnLine=function(c,b){a.save();a.textBaseline="middle";TextOnLine(this,b,c,!0);a.restore()};Object.getPrototypeOf(a).strokeTextOnLine=function(c,b){a.save();a.textBaseline="middle";TextOnLine(this,b,c,!1);a.restore()};Object.getPrototypeOf(a).fillTextOnLine2=function(c,b){a.save();var e=this.fontParams.family.replace(/(^["' \t])|(["' \t]$)/g,"").toLowerCase();if(e=globalFonts.Get(e,this.fontParams.style,this.fontParams.weight)){var d=
new FontSize(this.fontParams.size,e.baseSize);RenderTextCufon(c,e,d,this,b,!0);a.restore()}else console.error("fillTextOnLine2 : font error 2")};Object.getPrototypeOf(a).strokeTextOnLine2=function(c,b){a.save();var e=this.fontParams.family.replace(/(^["' \t])|(["' \t]$)/g,"").toLowerCase();if(e=globalFonts.Get(e,this.fontParams.style,this.fontParams.weight)){var d=new FontSize(this.fontParams.size,e.baseSize);RenderTextCufon(c,e,d,this,b,!1);a.restore()}else console.error("fillTextOnLine2 : font error 2")};
Object.getPrototypeOf(a).SetFont=function(a){this.font=a;var b=$("<span />").appendTo("body");b.css("font",a);a=b.css("fontFamily");var e=parseInt(b.css("fontSize")),d=b.css("fontWeight"),f=b.css("fontStyle");this.fontParams={family:a,size:e,weight:d,style:f};b.remove()}};var TileRenderer={layerDummyColors:[],ApplyStyle:function(a,c,b,e,d,f){try{var g=f[e];if(g.visible)for(e=0;e<g.s.length;e++){var h=g.s[e];if(d>=h.zmax&&d<=h.zmin)for(f=0;f<h.s.length;f++){var m=h.s[f];if(TileRenderer[m.rt])TileRenderer[m.rt](a,c,b,m)}}}catch(r){}},maxRenderTime:0,RenderLayers:function(a,c,b,e,d,f,g){if(!e)return g;var h,m=!1;"undefined"===typeof g||null==g?h=0:(h=g,m=!0);g=(new Date).getTime();for(b.scale(1,1);h<e.l.length;++h){var r=e.l[h],u=r.c;if(!(null!=c&&a[u]!=c)){var q=r.g,
v=null;"a"in r&&(v=r.a);if(null!=q){for(r=0;r<q.length;++r){var t=q[r],w=null;v&&(w=v[r]);for(var x=0;x<t.length;++x)TileRenderer.ApplyStyle(b,t[x],w,u,d,f)}if(m&&(u=(new Date).getTime()-g,TileRenderer.maxRenderTime=Math.max(TileRenderer.maxRenderTime,u),10<u))break}}}u=(new Date).getTime()-g;return h<e.l.length?[h+1,u]:[null,u]},FindSubLayerId:function(a,c,b,e,d,f,g){c.scale(1,1);var h;for(h=b.l.length-1;0<=h;h--){var m=b.l[h],r=m.c;if(g[r]==f){var u=d[r];if(u.visible){c.fillStyle="#fff";c.fillRect(a.x,
a.y,1,1);var q=m.g,v=null;"a"in m&&(v=m.a);if(null!=q){for(m=0;m<q.length;++m){var t=q[m],w=null;v&&(w=v[m]);for(var x=0;x<t.length;++x)TileRenderer.ApplyLookupStyle(c,t[x],w,u,e)}u=c.getImageData(0,0,1,1).data;if("ffffff"!=("000000"+Utils.rgbToHex(u[0],u[1],u[2])).slice(-6))return r}}}}return!1},ApplyLookupStyle:function(a,c,b,e,d){try{for(var f=0;f<e.s.length;f++){var g=e.s[f];if(d>=g.zmax&&d<=g.zmin)for(var h=0;h<g.s.length;h++){var m=g.s[h];TileRenderer[m.rt]&&(m=jQuery.extend(!0,{},m),m.alpha=
"1",m.fill="#000000",m.stroke="#000000",TileRenderer[m.rt](a,c,b,m))}}}catch(r){}},DrawImages:function(a,c,b,e){a&&a.IsLoaded()&&a.IsUpToDate()?(c.beginPath(),c.rect(b,e,MapParameters.tileSize,MapParameters.tileSize),c.closePath(),c.fillStyle="#FFFFFF",c.fill(),c.beginPath(),c.closePath(),a.RenderVectorialLayers(c,b,e)):(c.beginPath(),c.rect(b,e,MapParameters.tileSize,MapParameters.tileSize),c.closePath(),c.fillStyle="#EEEEEE",c.fill(),c.beginPath(),c.closePath())},LineSymbolizer:function(a,c,b,e){a.save();
"dasharray"in e?(b=e.dasharray.split(","),b=$.map(b,function(a){return parseInt(a)}),RenderLineDA(a,c,b)):RenderLine(a,c);"alpha"in e&&(a.globalAlpha=e.alpha);"width"in e&&(a.lineWidth=e.width);"linejoin"in e&&(a.lineJoin=e.linejoin);"linecap"in e&&(a.lineCap=e.linecap);"stroke"in e&&(a.strokeStyle=e.stroke,a.stroke());a.restore()},PolygonSymbolizer:function(a,c,b,e){a.save();RenderLine(a,c);"alpha"in e&&(a.globalAlpha=e.alpha);"fill"in e&&(a.fillStyle=e.fill,a.fill());a.restore()},LinePatternSymbolizer:function(a,
c,b,e){},PolygonPatternSymbolizer:function(a,c,b,e){},PointSymbolizer:function(a,c,b,e){},TextSymbolizer:function(a,c,b,e){},RasterSymbolizer:function(a,c,b,e){},ShieldSymbolizer:function(a,c,b,e){},BuildingSymbolizer:function(a,c,b,e){},MarkersSymbolizer:function(a,c,b,e){},GlyphSymbolizer:function(a,c,b,e){}};function MapRenderer(a){console.log("  building map renderer...");this.drawSceneInterval;this.maperial=a;this.config=a.config;this.context=a.context;this.tileCache={};this.dataCache={};this.initListeners()}MapRenderer.prototype.reset=function(){this.removeListeners();for(var a in this.tileCache)this.tileCache[a].Release(),this.tileCache[a].Reset(),delete this.tileCache[a];this.tileCache={};this.dataCache={};this.DrawScene(!0,!0)};
MapRenderer.prototype.initListeners=function(){var a=this;if(this.config.hud.elements[HUD.MAGNIFIER])this.context.mapCanvas.on(MaperialEvents.MOUSE_MOVE,function(){a.DrawMagnifier()});$(window).on(MaperialEvents.MOUSE_UP_WIHTOUT_AUTOMOVE,function(){a.config.edition&&a.FindLayerId()});$(window).on(MaperialEvents.STYLE_CHANGED,function(){a.DrawScene(!0,!0)});$(window).on(MaperialEvents.COLORBAR_CHANGED,function(){a.BuildColorBar()});$(window).on(MaperialEvents.CONTRAST_CHANGED,function(){});$(window).on(MaperialEvents.LUMINOSITY_CHANGED,
function(){});$(window).on(MaperialEvents.BW_METHOD_CHANGED,function(){});$(window).on(MaperialEvents.DATA_SOURCE_CHANGED,function(){})};
MapRenderer.prototype.removeListeners=function(){this.context.mapCanvas.off(MaperialEvents.MOUSE_MOVE);$(window).off(MaperialEvents.MOUSE_UP_WIHTOUT_AUTOMOVE);$(window).off(MaperialEvents.STYLE_CHANGED);$(window).off(MaperialEvents.COLORBAR_CHANGED);$(window).off(MaperialEvents.CONTRAST_CHANGED);$(window).off(MaperialEvents.LUMINOSITY_CHANGED);$(window).off(MaperialEvents.BW_METHOD_CHANGED);$(window).off(MaperialEvents.DATA_SOURCE_CHANGED);clearInterval(this.drawSceneInterval)};
MapRenderer.prototype.fitToSize=function(){this.gl&&(this.gl.viewportWidth=this.context.mapCanvas.width(),this.gl.viewportHeight=this.context.mapCanvas.height())};
MapRenderer.prototype.InitGL=function(){this.glAsset={};this.glAsset.ctx=this.gl;this.context.parameters.assets=this.glAsset;this.glAsset.shaderData=null;this.glAsset.shaderError=!1;var a=this.glAsset;this.glAsset.ShaderReq=$.ajax({type:"GET",url:MapParameters.shadersPath+"/all.json",dataType:"json",async:!1,success:function(c,b,e){a.shaderData=c;for(k in a.shaderData)a.shaderData[k].code=a.shaderData[k].code.replace(/---/g,"\n")},error:function(c,b,e){a.shaderError=!0;console.log(MapParameters.shadersPath+
"/all.json : loading failed : "+b)}});this.glAsset.squareVertexPositionBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.glAsset.squareVertexPositionBuffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,0,256,0,0,0,256,0,256,256,0]),this.gl.STATIC_DRAW);this.glAsset.squareVertexPositionBuffer.itemSize=3;this.glAsset.squareVertexPositionBuffer.numItems=4;this.glAsset.squareVertexTextureBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.glAsset.squareVertexTextureBuffer);
this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,1,1]),this.gl.STATIC_DRAW);this.glAsset.squareVertexTextureBuffer.itemSize=2;this.glAsset.squareVertexTextureBuffer.numItems=4;this.gl.clearColor(1,1,1,1);this.gl.disable(this.gl.DEPTH_TEST);this.glAsset.prog={};this.glAsset.prog.Tex=this.gltools.MakeProgram("vertexTex","fragmentTex",this.glAsset);this.glAsset.prog.Clut=this.gltools.MakeProgram("vertexTex","fragmentClut",this.glAsset);this.glAsset.prog[MapParameters.MulBlend]=this.gltools.MakeProgram("vertexTex",
"fragmentMulBlend",this.glAsset);this.glAsset.prog[MapParameters.AlphaClip]=this.gltools.MakeProgram("vertexTex","fragmentAlphaClip",this.glAsset);this.glAsset.prog[MapParameters.AlphaBlend]=this.gltools.MakeProgram("vertexTex","fragmentAlphaBlend",this.glAsset)};
MapRenderer.prototype.BuildColorBar=function(){cbs=this.context.parameters.GetColorBars();this.gl.flush();this.gl.finish();for(k in cbs){cbData=cbs[k].data;if(null==cbData||1024!=cbData.length){console.log("Invalid colorbar data : "+k);break}cbs[k].tex&&(this.gl.deleteTexture(cbs[k].tex),delete cbs[k].tex,cbs[k].tex=null);try{cbs[k].tex=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_2D,cbs[k].tex),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!1),this.gl.texImage2D(this.gl.TEXTURE_2D,
0,this.gl.RGBA,256,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,cbData),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.bindTexture(this.gl.TEXTURE_2D,null)}catch(a){this.gl.deleteTexture(cbs[k].tex),delete cbs[k].tex,
cbs[k].tex=null,console.log("Error in colorbar building : "+k)}}return!0};
MapRenderer.prototype.Start=function(){console.log("  starting rendering...");try{this.gl=this.context.mapCanvas[0].getContext("experimental-webgl"),this.fitToSize()}catch(a){}if(!this.gl)return console.log("Could not initialise WebGL"),!1;this.gltools=new GLTools;this.InitGL();if(!this.BuildColorBar())return console.log("Can't build colorbar"),!1;this.DrawScene();this.drawSceneInterval=setInterval(Utils.apply(this,"DrawScene"),MapParameters.refreshRate+5);return!0};
MapRenderer.prototype.UpdateTileCache=function(a,c,b,e,d,f){var g=[];for(tx=c;tx<=b;tx+=1)for(ty=e;ty<=d;ty+=1){var h=tx+","+ty+","+a;g.push(h);null==this.tileCache[h]&&(this.tileCache[h]=new Tile(this.context.parameters,this.config,tx,ty,a))}for(h in this.tileCache){c=!1;for(a=0;a<g.length;a++)g[a]===h&&(c=!0);c||(this.tileCache[h].Release(),delete this.tileCache[h])}if(f)for(h in this.tileCache)f=this.tileCache[h].Reset();h=!1;c=MapParameters.refreshRate;for(a=0;a<g.length;a++)if((f=this.tileCache[g[a]])&&
!f.IsUpToDate())if(h=!0,c=f.Update(c),0>=c)break;return h};
MapRenderer.prototype.DrawScene=function(a,c){"undefined"===typeof a&&(a=!0);"undefined"===typeof c&&(c=!1);var b=this.context.mapCanvas.width(),e=this.context.mapCanvas.height(),d=Math.floor(b/2),f=Math.floor(e/2),g=this.context.coordS.Resolution(this.context.zoom),f=new Point(this.context.centerM.x-d*g,this.context.centerM.y+f*g),d=this.context.coordS.MetersToTile(f.x,f.y,this.context.zoom),f=this.context.coordS.MetersToPixels(f.x,f.y,this.context.zoom),f=new Point(Math.floor(d.x*MapParameters.tileSize-
f.x),Math.floor(-((d.y+1)*MapParameters.tileSize-f.y)));if(this.UpdateTileCache(this.context.zoom,d.x,d.x+Math.floor(b/MapParameters.tileSize+1),d.y-Math.floor(e/MapParameters.tileSize+1),d.y,c)||a){mvMatrix=mat4.create();pMatrix=mat4.create();mat4.identity(pMatrix);mat4.ortho(0,b,e,0,0,1,pMatrix);this.gl.viewport(0,0,b,e);this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);for(var g=f.x,h=d.x;g<b;g+=MapParameters.tileSize,h+=1)for(var m=f.y,r=d.y;m<e;m+=MapParameters.tileSize,r-=1)mat4.identity(mvMatrix),
mat4.translate(mvMatrix,[g,m,0]),this.tileCache[h+","+r+","+this.context.zoom].Render(pMatrix,mvMatrix)}};
MapRenderer.prototype.FindLayerId=function(){var a=this.context.coordS.MetersToTile(this.context.mouseM.x,this.context.mouseM.y,this.context.zoom),c=this.tileCache[a.x+","+a.y+","+this.context.zoom];if(c&&c.IsLoaded()){var b=this.context.coordS.MetersToPixels(this.context.mouseM.x,this.context.mouseM.y,this.context.zoom),a=new Point(Math.floor(b.x-a.x*MapParameters.tileSize),Math.floor((a.y+1)*MapParameters.tileSize-b.y)),b=this.maperial.stylesManager.getSelectedStyle(),c=c.FindSubLayerId(a,this.context.zoom,
b.content);console.log("subLayerId :  "+c);$(window).trigger(MaperialEvents.OPEN_STYLE,[c])}};
MapRenderer.prototype.DrawMagnifier=function(){if(this.config.hud.elements[HUD.MAGNIFIER]){var a=this.context.magnifierCanvas.width(),c=this.context.magnifierCanvas.height(),b=a/2/3,e=c/2/3,d=this.context.coordS.Resolution(this.context.zoom),e=new Point(this.context.mouseM.x-b*d,this.context.mouseM.y+e*d),b=this.context.coordS.MetersToTile(e.x,e.y,this.context.zoom),e=this.context.coordS.MetersToPixels(e.x,e.y,this.context.zoom),e=new Point(Math.floor(b.x*MapParameters.tileSize-e.x),Math.floor(-((b.y+
1)*MapParameters.tileSize-e.y))),d=this.context.magnifierCanvas[0].getContext("2d");d.save();d.globalCompositeOperation="source-over";d.scale(3,3);for(var f=e.x,g=b.x;f<a;f+=MapParameters.tileSize,g+=1)for(var h=e.y,m=b.y;h<c;h+=MapParameters.tileSize,m-=1)TileRenderer.DrawImages(this.tileCache[g+","+m+","+this.context.zoom],d,f,h);d.restore();this.DrawMagnifierSight(d)}};
MapRenderer.prototype.DrawMagnifierSight=function(a){var c=this.context.magnifierCanvas.width(),b=this.context.magnifierCanvas.height();a.beginPath();a.moveTo(c/2-20,b/2);a.lineTo(c/2-4,b/2);a.closePath();a.stroke();a.beginPath();a.moveTo(c/2+4,b/2);a.lineTo(c/2+20,b/2);a.closePath();a.stroke();a.beginPath();a.moveTo(c/2,b/2-20);a.lineTo(c/2,b/2-4);a.closePath();a.stroke();a.beginPath();a.moveTo(c/2,b/2+4);a.lineTo(c/2,b/2+20);a.closePath();a.stroke()};this.MaperialEvents={};MaperialEvents.LOADING="MaperialEvents.LOADING";MaperialEvents.READY="MaperialEvents.READY";MaperialEvents.REFRESH_SIZES="MaperialEvents.REFRESH_SIZES";MaperialEvents.MOUSE_DOWN="MaperialEvents.MOUSE_DOWN";MaperialEvents.MOUSE_UP="MaperialEvents.MOUSE_UP";MaperialEvents.MOUSE_MOVE="MaperialEvents.MOUSE_MOVE";MaperialEvents.MOUSE_UP_WIHTOUT_AUTOMOVE="MaperialEvents.MOUSE_UP_WIHTOUT_AUTOMOVE";MaperialEvents.CONTROL_UP="MaperialEvents.CONTROL_UP";MaperialEvents.CONTROL_DOWN="MaperialEvents.CONTROL_DOWN";
MaperialEvents.CONTROL_LEFT="MaperialEvents.CONTROL_LEFT";MaperialEvents.CONTROL_RIGHT="MaperialEvents.CONTROL_RIGHT";MaperialEvents.DRAGGING_MAP="MaperialEvents.DRAGGING_MAP";MaperialEvents.MAP_MOVING="MaperialEvents.MAP_MOVING";MaperialEvents.ZOOM_TO_REFRESH="MaperialEvents.ZOOM_TO_REFRESH";MaperialEvents.ZOOM_CHANGED="MaperialEvents.ZOOM_CHANGED";MaperialEvents.UPDATE_LATLON="MaperialEvents.UPDATE_LATLON";MaperialEvents.OPEN_STYLE="MaperialEvents.OPEN_STYLE";MaperialEvents.STYLE_CHANGED="MaperialEvents.STYLE_CHANGED";
MaperialEvents.COLORBAR_CHANGED="MaperialEvents.COLORBAR_CHANGED";MaperialEvents.CONTRAST_CHANGED="MaperialEvents.CONTRAST_CHANGED";MaperialEvents.LUMINOSITY_CHANGED="MaperialEvents.LUMINOSITY_CHANGED";MaperialEvents.BW_METHOD_CHANGED="MaperialEvents.BW_METHOD_CHANGED";MaperialEvents.DATA_SOURCE_CHANGED="MaperialEvents.DATA_SOURCE_CHANGED";
MaperialEvents.removeAllListeners=function(){$(window).off(MaperialEvents.UPDATE_LATLON);$(window).off(MaperialEvents.OPEN_STYLE);$(window).off(MaperialEvents.STYLE_CHANGED);$(window).off(MaperialEvents.COLORBAR_CHANGED);$(window).off(MaperialEvents.CONTRAST_CHANGED);$(window).off(MaperialEvents.LUMINOSITY_CHANGED);$(window).off(MaperialEvents.BW_METHOD_CHANGED);$(window).off(MaperialEvents.DATA_SOURCE_CHANGED);$(window).off(MaperialEvents.MOUSE_UP_WIHTOUT_AUTOMOVE);$(window).off(MaperialEvents.CONTROL_UP);
$(window).off(MaperialEvents.CONTROL_DOWN);$(window).off(MaperialEvents.CONTROL_LEFT);$(window).off(MaperialEvents.CONTROL_RIGHT)};Source.MaperialOSM="osm";Source.Raster="raster";Source.Vector="vector";Source.Images="images";Source.IMAGES_MAPQUEST="images.mapquest";Source.IMAGES_MAPQUEST_SATELLITE="images.mapquest.satellite";Source.IMAGES_OSM="images.osm";function Source(a,c){this.type=a;this.params=c}
Source.prototype.getURL=function(a,c,b){switch(this.type){case Source.MaperialOSM:return MapParameters.serverURL+"/api/tile?x="+a+"&y="+c+"&z="+b;case Source.Raster:return MapParameters.serverURL+"/api/tile/"+this.params.rasterUID+"?x="+a+"&y="+c+"&z="+b;case Source.Images:var e=null,e=void 0===this.params||void 0===this.params.src?Source.IMAGES_OSM:this.params.src;c=Math.pow(2,b)-1-c;switch(e){case Source.IMAGES_MAPQUEST:return e=Math.floor(4*Math.random()+1)%5,"http://otile"+e+".mqcdn.com/tiles/1.0.0/osm/"+
b+"/"+a+"/"+c+".png";case Source.IMAGES_MAPQUEST_SATELLITE:return e=Math.floor(4*Math.random()+1)%5,"http://otile"+e+".mqcdn.com/tiles/1.0.0/sat/"+b+"/"+a+"/"+c+".png";default:return"http://tile.openstreetmap.org/"+b+"/"+a+"/"+c+".png"}}};MapParameters.serverURL="//maperial.com";MapParameters.shadersPath="assets/shaders";MapParameters.mapCanvasName="map";MapParameters.magnifierCanvasName="magnifier";MapParameters.DEFAULT_ZOOM=8;MapParameters.DEFAULT_LATITUDE=45.7;MapParameters.DEFAULT_LONGITUDE=3.12;MapParameters.refreshRate=15;MapParameters.tileDLTimeOut=6E4;MapParameters.tileSize=256;MapParameters.autoMoveSpeedRate=0.2;MapParameters.autoMoveMillis=700;MapParameters.autoMoveDeceleration=0.0050;MapParameters.autoMoveAnalyseSize=10;
MapParameters.DEFAULT_STYLE_UID="1_style_13ba851b4e18833e08e";MapParameters.DEFAULT_COLORBAR_UID="default";MapParameters.AlphaClip="AlphaClip";MapParameters.AlphaBlend="AlphaBlend";MapParameters.MulBlend="MulBlend";function MapParameters(a){this.maperial=a;this.rasterUid=null;this.luminosity=this.contrast=0;this.bwMethod=1;this.colorbars={};this.sources={};this.shaders=[MapParameters.AlphaClip,MapParameters.AlphaBlend,MapParameters.MulBlend];this.buildSources(this.maperial.config.layers)}
MapParameters.prototype.buildSources=function(a){console.log("  fetching sources...");var c;this.sources=[];for(var b=0;b<a.length;b++){var e=a[b].source.type,d;switch(e){case Source.MaperialOSM:if(c)continue;c=!0;break;case Source.Raster:d={rasterUID:a[b].source.params.uid};break;case Source.Images:d={src:a[b].source.params.src}}this.sources.push(new Source(e,d))}};
MapParameters.prototype.AddOrRefreshColorbar=function(a,c){this.colorbars[a]&&delete this.colorbars[a];this.colorbars[a]=new ColorBar;c.constructor===String?$.ajax({url:c,async:!1,dataType:"json",success:function(b){this.colorbars[a].data=new Uint8Array(b)}}):this.colorbars[a].data=new Uint8Array(c);$(window).trigger(MaperialEvents.COLORBAR_CHANGED)};MapParameters.prototype.GetColorBars=function(){return this.colorbars};
MapParameters.prototype.GetColorBar=function(a){return a in this.colorbars?this.colorbars[a]:null};MapParameters.prototype.SetRasterUid=function(a){this.rasterUid=a;$(window).trigger(MaperialEvents.DATA_SOURCE_CHANGED)};MapParameters.prototype.SetContrast=function(a){this.contrast=a;$(window).trigger(MaperialEvents.CONTRAST_CHANGED)};MapParameters.prototype.GetContrast=function(){return this.contrast};MapParameters.prototype.SetLuminosity=function(a){this.luminosity=a;$(window).trigger(MaperialEvents.LUMINOSITY_CHANGED)};
MapParameters.prototype.GetLuminosity=function(){return this.luminosity};MapParameters.prototype.SetBWMethod=function(a){this.bwMethod=Math.max(0,Math.min(4,Math.round(a)));$(window).trigger(MaperialEvents.BW_METHOD_CHANGED)};MapParameters.prototype.GetBWMethod=function(){return this.bwMethod};function ColorBar(){this.data=[];this.tex=null}
MapParameters.prototype.SetDefaultColorBar=function(){console.log("SetDefaultColorBar");var a=[];a.push(0);a.push(0);a.push(0);a.push(0);for(i=1;256>i;i+=1){var c=Math.round(2*i);255>=c?a.push(255-c):a.push(0);a.push(0);a.push(0);a.push(255)}this.AddOrRefreshColorbar(MapParameters.DEFAULT_COLORBAR_UID,a)};function MapMouse(a){console.log("  listening mouse...");this.config=a.config;this.context=a.context;this.mouseDown=!1;this.lastWheelMillis=(new Date).getTime();this.initListeners()}MapMouse.prototype.initListeners=function(){this.context.mapCanvas.mousedown(Utils.apply(this,"down")).mouseup(Utils.apply(this,"up")).mousemove(Utils.apply(this,"move")).mouseleave(Utils.apply(this,"leave")).dblclick(Utils.apply(this,"doubleClick")).bind("mousewheel",Utils.apply(this,"wheel"))};
MapMouse.prototype.removeListeners=function(){this.context.mapCanvas.off("mousedown");this.context.mapCanvas.off("mouseup");this.context.mapCanvas.off("mousemove");this.context.mapCanvas.off("mouseleave");this.context.mapCanvas.unbind("dblclick");this.context.mapCanvas.unbind("mousewheel")};MapMouse.prototype.down=function(a){this.mouseDown=!0;this.context.mapCanvas.trigger(MaperialEvents.MOUSE_DOWN)};MapMouse.prototype.leave=function(a){this.mouseDown&&this.up(a)};
MapMouse.prototype.up=function(a){this.mouseDown=!1;this.context.mapCanvas.trigger(MaperialEvents.MOUSE_UP)};MapMouse.prototype.move=function(a){this.context.mouseP=Utils.getPoint(a);this.context.mouseM=this.convertCanvasPointToMeters(this.context.mouseP);this.context.mapCanvas.trigger(MaperialEvents.MOUSE_MOVE);this.mouseDown?this.context.mapCanvas.trigger(MaperialEvents.DRAGGING_MAP):this.context.mapCanvas.trigger(MaperialEvents.UPDATE_LATLON)};
MapMouse.prototype.doubleClick=function(a){this.context.zoom=Math.min(18,this.context.zoom+1);this.context.centerM=this.convertCanvasPointToMeters(this.context.mouseP);this.context.mouseP=Utils.getPoint(a);this.context.mouseM=this.convertCanvasPointToMeters(this.context.mouseP);$(window).trigger(MaperialEvents.ZOOM_TO_REFRESH)};
MapMouse.prototype.wheel=function(a,c){a.preventDefault();if(!this.hasJustWheeled()){if(0<c)this.context.zoom=Math.min(18,this.context.zoom+1),this.context.centerM=this.convertCanvasPointToMeters(this.context.mouseP);else if(0>c){this.context.coordS.MetersToPixels(this.context.centerM.x,this.context.centerM.y,this.context.zoom);var b=new Point(this.context.mapCanvas.width()/2-this.context.mouseP.x,this.context.mapCanvas.height()/2-this.context.mouseP.y);this.context.zoom=Math.max(0,this.context.zoom-
1);var e=this.context.coordS.Resolution(this.context.zoom),b=new Point(b.x*e,b.y*e);this.context.centerM=new Point(this.context.mouseM.x+b.x,this.context.mouseM.y-b.y)}this.context.mouseP=Utils.getPoint(a);this.context.mouseM=this.convertCanvasPointToMeters(this.context.mouseP);$(window).trigger(MaperialEvents.ZOOM_TO_REFRESH)}};MapMouse.prototype.hasJustWheeled=function(){var a=300>(new Date).getTime()-this.lastWheelMillis;this.lastWheelMillis=(new Date).getTime();return a};
MapMouse.prototype.convertCanvasPointToMeters=function(a){var c=this.context.mapCanvas.width(),b=this.context.mapCanvas.height(),e=this.context.coordS.MetersToPixels(this.context.centerM.x,this.context.centerM.y,this.context.zoom);return this.context.coordS.PixelsToMeters(e.x-(c/2-a.x),e.y+(b/2-a.y),this.context.zoom)};function MapMover(a){console.log("  building mover...");this.config=a.config;this.context=a.context;this.lastMouseY=this.lastMouseX=null;this.autoMoving=!1;this.mouseData=[];this.drawers=[];this.defaultMoveDistance=300;this.defaultMoveMillis=150;this.initListeners()}
MapMover.prototype.initListeners=function(a){var c=this;this.context.mapCanvas.on(MaperialEvents.MOUSE_DOWN,function(){c.reset()});this.context.mapCanvas.on(MaperialEvents.MOUSE_UP,function(){c.receivedMouseUp()});this.context.mapCanvas.on(MaperialEvents.DRAGGING_MAP,function(){c.drag()});$(window).on(MaperialEvents.CONTROL_UP,function(){c.moveUp()});$(window).on(MaperialEvents.CONTROL_DOWN,function(){c.moveDown()});$(window).on(MaperialEvents.CONTROL_RIGHT,function(){c.moveRight()});$(window).on(MaperialEvents.CONTROL_LEFT,
function(){c.moveLeft()})};MapMover.prototype.removeListeners=function(){this.context.mapCanvas.off(MaperialEvents.MOUSE_DOWN);this.context.mapCanvas.off(MaperialEvents.MOUSE_UP);this.context.mapCanvas.off(MaperialEvents.DRAGGING_MAP);$(window).off(MaperialEvents.CONTROL_UP);$(window).off(MaperialEvents.CONTROL_DOWN);$(window).off(MaperialEvents.CONTROL_RIGHT);$(window).off(MaperialEvents.CONTROL_LEFT)};
MapMover.prototype.reset=function(){this.mouseData=[];this.lastMouseX=this.context.mouseP.x;this.lastMouseY=this.context.mouseP.y;this.autoMoving=!1};MapMover.prototype.drag=function(){var a=this.context.mouseP.x,c=this.context.mouseP.y,b=a-this.lastMouseX,e=c-this.lastMouseY;this.lastMouseX=a;this.lastMouseY=c;this.registerMouseData(a,c);this.moveMap(b,e);this.moveDrawers(b,e)};
MapMover.prototype.moveMap=function(a,c){var b=this.context.coordS.Resolution(this.context.zoom);this.context.centerM.x-=a*b;this.context.centerM.y+=c*b;$(window).trigger(MaperialEvents.MAP_MOVING)};MapMover.prototype.receivedMouseUp=function(){this.requireAutoMove()?this.prepareAutoMove():$(window).trigger(MaperialEvents.MOUSE_UP_WIHTOUT_AUTOMOVE)};
MapMover.prototype.requireAutoMove=function(){if(3>this.mouseData.length)return!1;var a=this.mouseData.pop();return 120<(new Date).getTime()-a.time?!1:!0};MapMover.prototype.prepareAutoMove=function(){var a=this.mouseData[0],c=this.mouseData.pop();this.move(c.x-a.x,c.y-a.y,c.time-a.time)};
MapMover.prototype.move=function(a,c,b){var e=Math.sqrt(a*a+c*c);b=1E3*e/b/MapParameters.refreshRate;a=b*a/e*MapParameters.autoMoveSpeedRate;c=b*c/e*MapParameters.autoMoveSpeedRate;this.autoMoving=!0;this.moveScene(MapParameters.autoMoveMillis,a,c,0)};MapMover.prototype.moveUp=function(){this.move(0,this.defaultMoveDistance,this.defaultMoveMillis)};MapMover.prototype.moveDown=function(){this.move(0,-this.defaultMoveDistance,this.defaultMoveMillis)};
MapMover.prototype.moveRight=function(){this.move(-this.defaultMoveDistance,0,this.defaultMoveMillis)};MapMover.prototype.moveLeft=function(){this.move(this.defaultMoveDistance,0,this.defaultMoveMillis)};MapMover.prototype.moveScene=function(a,c,b,e){if(!(0>a)&&this.autoMoving&&!isNaN(c)){this.moveMap(c,b);this.moveDrawers(c,b);var d=0.99-e*MapParameters.autoMoveDeceleration,f=this;setTimeout(function(){f.moveScene(a-MapParameters.refreshRate,c*d,b*d,e+1)},MapParameters.refreshRate)}};
MapMover.prototype.registerMouseData=function(a,c){this.mouseData.length>=MapParameters.autoMoveAnalyseSize&&this.mouseData.shift();var b={};b.x=a;b.y=c;b.time=(new Date).getTime();this.mouseData.push(b)};MapMover.prototype.addDrawer=function(a){this.drawers.push(a)};MapMover.prototype.removeDrawer=function(a){for(var c=0;c<this.drawers.length&&this.drawers[c]!==a;c++);this.drawers.splice(c,1)};
MapMover.prototype.resizeDrawers=function(){for(var a=0;a<this.drawers.length;a++)this.drawers[a].resize(this.config.width,this.config.height)};MapMover.prototype.moveDrawers=function(a,c){for(var b=0;b<this.drawers.length;b++){for(var e=this.drawers[b],d=0;d<e.pointsToMove.length;d++){var f=e.pointsToMove[d];f.x+=a;f.y+=c}e.draw()}};function HUD(a){console.log("  building HUD...");this.maperial=a;this.context=this.maperial.context;this.buildTriggers();this.buildControls();this.display();this.initListeners();this.updateScale()}HUD.TRIGGER="trigger";HUD.PANEL="panel";HUD.SETTINGS="HUDSettings";HUD.COLORBAR="ColorBar";HUD.QUICK_EDIT="QuickEdit";HUD.DETAILS_MENU="DetailsMenu";HUD.ZOOMS="Zooms";HUD.CONTROLS="Controls";HUD.SCALE="Scale";HUD.GEOLOC="Geoloc";HUD.LATLON="LatLon";HUD.MAPKEY="MapKey";HUD.MAGNIFIER="Magnifier";
HUD.COMPOSITIONS="Compositions";HUD.SWITCH_IMAGES="SwitchImages";
HUD.VIEWER_OPTIONS={"0":{element:HUD.CONTROLS,label:"Controls",defaultDisableDrag:!0},1:{element:HUD.SCALE,label:"Scale",defaultDisableDrag:!1},2:{element:HUD.GEOLOC,label:"Geoloc",defaultDisableDrag:!1},3:{element:HUD.COMPOSITIONS,label:"Compositions",defaultDisableDrag:!1},4:{element:HUD.LATLON,label:"Lat/Lon",defaultDisableDrag:!1},5:{element:HUD.MAPKEY,label:"Map Key",defaultDisableDrag:!1},6:{element:HUD.MAGNIFIER,label:"Magnifier",defaultDisableDrag:!1},7:{element:HUD.SWITCH_IMAGES,label:"Switch Basemap",
defaultDisableDrag:!0}};HUD.applyDefaultHUD=function(a){a.hud={elements:{},options:{}};for(i in HUD.VIEWER_OPTIONS)a.hud.elements[HUD.VIEWER_OPTIONS[i].element]={show:!1,type:HUD.PANEL,label:HUD.VIEWER_OPTIONS[i].label,disableDrag:HUD.VIEWER_OPTIONS[i].defaultDisableDrag}};HUD.positions=[];HUD.positions[HUD.SETTINGS]={left:"0",top:"0"};HUD.positions[HUD.COMPOSITIONS]={left:"0",bottom:"0"};HUD.positions[HUD.SWITCH_IMAGES]={left:"10",top:"10"};HUD.positions[HUD.MAGNIFIER]={left:"0",bottom:"0"};
HUD.positions[HUD.COLORBAR]={left:"0",top:"180"};HUD.positions[HUD.SCALE]={right:"10",bottom:"10"};HUD.positions[HUD.MAPKEY]={right:"0",bottom:"0"};HUD.positions[HUD.CONTROLS]={left:"15",top:"40"};HUD.positions[HUD.LATLON]={left:"50%",bottom:"0"};HUD.positions[HUD.GEOLOC]={left:"50%",top:"0"};HUD.positions[HUD.DETAILS_MENU]={left:"50%",top:"30%"};HUD.positions[HUD.QUICK_EDIT]={right:"0",top:"38"};HUD.positions[HUD.ZOOMS]={left:"50%",bottom:"0"};HUD.prototype.reset=function(){this.hideAllHUD();this.removeListeners()};
HUD.prototype.initListeners=function(){var a=this;this.context.mapCanvas.on(MaperialEvents.UPDATE_LATLON,function(c,b,e){a.updateLatLon()});$(window).on(MaperialEvents.MAP_MOVING,function(c,b,e){a.updateScale()});$(window).on(MaperialEvents.ZOOM_CHANGED,function(c,b,e){a.updateScale()});$(window).on(MaperialEvents.ZOOM_TO_REFRESH,function(c,b,e){a.refreshZoom()})};
HUD.prototype.removeListeners=function(){this.context.mapCanvas.off(MaperialEvents.UPDATE_LATLON);$(window).off(MaperialEvents.MAP_MOVING);$(window).off(MaperialEvents.ZOOM_CHANGED);$(window).off(MaperialEvents.ZOOM_TO_REFRESH);$(".trigger").unbind("click");$(".panel").unbind("click");$(".trigger").unbind("dragstart");$(".trigger").unbind("dragstop");$(".panel").unbind("dragstart");$(".panel").unbind("dragstop");$("#control-up").unbind("click");$("#control-down").unbind("click");$("#control-left").unbind("click");
$("#control-right").unbind("click");$("#imagesMapquest").unbind("click");$("#imagesMapquestSatellite").unbind("click");$("#imagesOSM").unbind("click")};HUD.prototype.getMargin=function(a){return this.maperial.config.hud.options["margin-"+a]?this.maperial.config.hud.options["margin-"+a]:0};
HUD.prototype.placeElements=function(){for(element in this.maperial.config.hud.elements){var a=HUD.positions[element];this.maperial.config.hud.elements[element].position&&(a=this.maperial.config.hud.elements[element].position);for(property in a){var c=a[property];if(-1==a[property].indexOf("%"))c=parseInt(c)+this.getMargin(property);else{var b=a[property].split("%")[0],e=$("#trigger"+element).width(),d=$("#trigger"+element).height(),f=$("#panel"+element).width(),g=$("#panel"+element).height();switch(property){case "top":case "bottom":switch(this.maperial.config.hud.elements[element].type){case HUD.PANEL:c=
b/100*this.context.mapCanvas[0].height-g/2;break;case HUD.TRIGGER:c=b/100*this.context.mapCanvas[0].height-d/2}break;case "left":case "right":switch(this.maperial.config.hud.elements[element].type){case HUD.PANEL:c=b/100*this.context.mapCanvas[0].width-f/2;break;case HUD.TRIGGER:c=b/100*this.context.mapCanvas[0].width-e/2}}c+=this.getMargin(property)}$("#panel"+element).css(property,c+"px");$("#trigger"+element).css(property,c+"px")}}};
HUD.prototype.display=function(){this.showAllHUD();this.maperial.config.hud.elements[HUD.SETTINGS]&&this.refreshSettingsPanel();this.maperial.config.hud.elements[HUD.COMPOSITIONS]&&this.refreshCompositionsPanel();this.maperial.config.hud.elements[HUD.SWITCH_IMAGES]&&this.refreshSwitchImagesPanel()};HUD.prototype.refreshZoom=function(a){a||$("#control-zoom").slider({value:this.context.zoom});$("#control-zoom a").html(this.context.zoom);$(window).trigger(MaperialEvents.ZOOM_CHANGED)};
HUD.prototype.hideAllHUD=function(){$(".panel").addClass("hide");$(".trigger").addClass("hide")};HUD.prototype.showAllHUD=function(){for(element in this.maperial.config.hud.elements)!0==this.maperial.config.hud.elements[element].show&&$("#"+this.maperial.config.hud.elements[element].type+element).removeClass("hide")};HUD.prototype.putOnTop=function(a){$(".trigger").css({zIndex:101});$(".panel").css({zIndex:100});$("#trigger"+a).css({zIndex:201});$("#panel"+a).css({zIndex:200})};HUD.prototype.refreshSwitchImagesPanel=function(){console.log("     building switch...");var a=this.maperial.layersManager;$("#imagesMapquest").click(function(){a.switchImagesTo(Source.IMAGES_MAPQUEST)});$("#imagesMapquestSatellite").click(function(){a.switchImagesTo(Source.IMAGES_MAPQUEST_SATELLITE)});$("#imagesOSM").click(function(){a.switchImagesTo(Source.IMAGES_OSM)})};HUD.prototype.refreshCompositionsPanel=function(){console.log("     building compositions...");$("#"+HUD.COMPOSITIONS).empty();if(2>this.maperial.config.layers.length)$("#panel"+HUD.COMPOSITIONS).addClass("hide");else{$("#"+HUD.COMPOSITIONS).removeClass("hide");$("#"+HUD.COMPOSITIONS).append('<p id="compositionSettingsTitle">Compositions Settings</p>');for(var a=40,c=this,b=this.maperial.config.layers.length-1;0<b;b--){for(var e=this.maperial.config.layers[b].composition,d="shadersSelection_"+b,f=
'<div class="row-fluid">',f=f+('<div class="span3"><img class="sourceThumb" '+Utils.getSourceThumb(this.maperial.config.layers[b])+"></img></div>"),f=f+('<div class="span4 offset1"><select class="shaderSelectbox" name="'+d+'" id="'+d+'">'),g=0;g<this.maperial.context.parameters.shaders.length;g++)f+='<option value="'+g+'">'+this.maperial.context.parameters.shaders[g]+"</option>";f+="</select></div>";f+="</div>";$("#"+HUD.COMPOSITIONS).append(f);$("#"+d).selectbox({onChange:function(a){return function(b,
d){try{a.shader=d.input[0][b].label,c.maperial.restart()}catch(e){}}}(e),effect:"slide"});$("#"+d).selectbox("change","",e.shader);if(e.shader==MapParameters.MulBlend){var d="mulblend_contrast_"+b,g="mulblend_brightness_"+b,h="mulblend_bw_"+b,f='<div class="row-fluid"><div class="span1 offset4"><div class="mulblendSlider" id='+d+'></div></div><div class="span1 offset1"><div class="mulblendSlider" id='+g+'></div></div><div class="span1 offset1"><div class="mulblendSlider" id='+h+"></div></div></div>";
$("#"+HUD.COMPOSITIONS).append(f);$("#"+d).slider({orientation:"vertical",range:"min",min:-2,max:2,step:0.01,value:e.params.uParams[0],slide:function(a){return function(b,c){$("#"+a+" a").html(c.value)}}(d),change:function(a,b){return function(a,d){console.log(a);console.log(d);console.log(d.value);b.params.uParams[0]=d.value;c.maperial.restart()}}(d,e)});$("#"+g).slider({orientation:"vertical",range:"min",min:-2,max:2,step:0.01,value:e.params.uParams[1],slide:function(a){return function(b,c){$("#"+
a+" a").html(c.value)}}(g),change:function(a,b){return function(a,d){b.params.uParams[1]=d.value;c.maperial.restart()}}(g,e)});$("#"+h).slider({orientation:"vertical",range:"min",min:1,max:4,step:1,value:e.params.uParams[2],slide:function(a){return function(b,c){$("#"+a+" a").html(c.value)}}(h),change:function(a,b){return function(a,d){b.params.uParams[2]=d.value;c.maperial.restart()}}(h,e)});a+=120}a+=60}$("#panel"+HUD.COMPOSITIONS).css("height",a+"px")}};HUD.prototype.buildControls=function(){var a=this;$("#control-zoom").slider({orientation:"vertical",range:"min",min:1,max:18,value:this.context.zoom,slide:function(a,b){$("#control-zoom a").html(b.value)},change:function(c,b){a.context.zoom=parseInt(b.value);a.refreshZoom(!0)}});$("#control-up").click(function(){$(window).trigger(MaperialEvents.CONTROL_UP)});$("#control-down").click(function(){$(window).trigger(MaperialEvents.CONTROL_DOWN)});$("#control-left").click(function(){$(window).trigger(MaperialEvents.CONTROL_LEFT)});
$("#control-right").click(function(){$(window).trigger(MaperialEvents.CONTROL_RIGHT)});Utils.buildSliderStyle("control-zoom");this.refreshZoom()};HUD.prototype.updateLatLon=function(){var a=this.context.coordS.MetersToLatLon(this.context.mouseM.x,this.context.mouseM.y);try{$("#longitudeDiv").empty(),$("#latitudeDiv").empty(),$("#longitudeDiv").append(a.x),$("#latitudeDiv").append(a.y)}catch(c){}};HUD.ZOOM_METERS={1:"15500000",2:"4000000",3:"2000000",4:"1000000",5:"500000",6:"250000",7:"125000",8:"60000",9:"30000",10:"15000",11:"8000",12:"4000",13:"2000",14:"1000",15:"500",16:"250",17:"100",18:"50"};
HUD.prototype.updateScale=function(){var a=new Point(this.context.centerM.x+parseInt(HUD.ZOOM_METERS[this.context.zoom]),this.context.centerM.y),c=this.context.coordS.MetersToPixelsAccurate(this.context.centerM.x,this.context.centerM.y,this.context.zoom),a=this.context.coordS.MetersToPixelsAccurate(a.x,a.y,this.context.zoom).x-c.x,c=0.62137*a,b=HUD.ZOOM_METERS[this.context.zoom],e=6.2137E-4*HUD.ZOOM_METERS[this.context.zoom];try{$("#metersContainer").empty(),$("#milesContainer").empty(),$("#metersContainer").append(b+
"m"),$("#milesContainer").append(e+"mi"),$("#metersContainer").width(a+"px"),$("#milesContainer").width(c+"px")}catch(d){}};HUD.prototype.refreshSettingsPanel=function(){$("#"+HUD.SETTINGS).empty();var a=0,c=this.maperial.config.hud,b=this;for(element in c.elements)if(!c.elements[element].disableHide){var e='<div class="row-fluid"><div class="span5 offset1">'+c.elements[element].label+'</div><div class="slider-frame offset6">   <span class="slider-button" id="toggle'+element+'"></span></div></div>';$("#"+HUD.SETTINGS).append(e);a+=50;$("#toggle"+element).click(function(){if($(this).hasClass("on")){$(this).removeClass("on");
var a=$(this).context.id.replace("toggle","");$("#"+c.elements[a].type+a).addClass("hide");c.elements[a].type==HUD.TRIGGER&&b.hideTrigger(a)}else $(this).addClass("on"),a=$(this).context.id.replace("toggle",""),$("#"+c.elements[a].type+a).removeClass("hide"),b.showTrigger(a)});c.elements[element].show&&$("#toggle"+element).addClass("on")}$("#panel"+HUD.SETTINGS).css("height",a+"px")};HUD.prototype.buildTriggers=function(){var a=this;$(".panel").click(function(){var c=$(this).context.id.replace("panel","");a.putOnTop(c)});$(".trigger").click(function(){a.clickOnTrigger($(this));return!1});$(".panel").draggable({snap:".snapper",containment:"#map",scroll:!1});$(".trigger").draggable({snap:".snapper",containment:"#map",scroll:!1});for(element in this.maperial.config.hud.elements)this.maperial.config.hud.elements[element].disableDrag&&($("#panel"+element).draggable("disable"),$("#trigger"+
element).draggable("disable"));$(".panel").bind("dragstart",function(c){c=$(this).context.id.replace("panel","");a.putOnTop(c);$("#trigger"+c).css({opacity:0})});$("#panelDetailsMenu").bind("dragstart",function(a){if("panelDetailsMenu"==a.srcElement.id)return $("#triggerDetailsMenu").css({opacity:1}),!1});$(".panel").bind("dragstop",function(a){var b=$(this).context.id;a=b.replace("panel","");var e=$("#"+b).css("top"),b=$("#"+b).css("left");$("#trigger"+a).css({top:e,left:b,opacity:1})});$(".trigger").bind("dragstart",
function(c){$(this).addClass("beingdrag");$(this).css("right","auto");$(this).css("bottom","auto");c=$(this).context.id.replace("trigger","");a.putOnTop(c)});$(".trigger").bind("dragstop",function(a){var b=$(this).context.id;a=b.replace("trigger","");var e=$("#"+b).css("top"),b=$("#"+b).css("left");$("#panel"+a).css({top:e,left:b})})};HUD.prototype.showTrigger=function(a){$("#icon"+a).show("fast");$("#trigger"+a).removeClass("active")};
HUD.prototype.hideTrigger=function(a){$("#icon"+a).hide("fast");$("#panel"+a).hide("fast");$("#trigger"+a).addClass("active")};HUD.prototype.clickOnTrigger=function(a){var c=a[0].id.replace("trigger","");this.putOnTop(c);a.hasClass("beingdrag")?a.removeClass("beingdrag"):(a.hasClass("active")&&!this.maperial.config.hud.elements[c].disableDrag?a.draggable("enable"):a.draggable("disable"),$("#icon"+c).toggle("fast"),$("#panel"+c).toggle("fast"),a.toggleClass("active"))};function StylesManager(a,c){this.maperial=a;this.stylesToLoad;this.nextFunction;this.styles=c?this.maperial.stylesManager.styles:{}}StylesManager.prototype.getSelectedStyle=function(){for(var a=0;a<this.maperial.config.layers.length;a++){var c=this.maperial.config.layers[a].params;if(c.styles)return this.styles[c.styles[c.selectedStyle]]}return null};StylesManager.prototype.getStyle=function(a){return this.styles[a]};
StylesManager.prototype.fetchStyles=function(a,c){this.nextFunction=c;if(0<a.length){var b=a.shift();this.stylesToLoad=a;this.loadStyle(b)}else c()};StylesManager.prototype.loadStyle=function(a){var c=this;if(this.styles[a])this.loadNextStyle();else{var b=this.getURL(a);console.log("  fetching : "+b);$.ajax({type:"GET",url:b,dataType:"json",success:function(b){c.styles[a]={uid:a,name:a,content:b};c.loadNextStyle()}})}};
StylesManager.prototype.loadNextStyle=function(){this.fetchStyles(this.stylesToLoad,this.nextFunction)};StylesManager.prototype.getURL=function(a){return MapParameters.serverURL+"/api/style/"+a};function LayersManager(a){this.maperial=a;this.firstOSMPosition=-1}LayersManager.Vector="vector";LayersManager.Raster="raster";LayersManager.Images="images";LayersManager.prototype.addLayer=function(a,c){var b;switch(a){case Source.MaperialOSM:b=this.getOSMLayerConfig();break;case Source.Raster:b=this.getRasterLayerConfig(c[0]);break;case Source.Vector:b=this.getVectorLayerConfig();break;case Source.Images:b=this.getImagesLayerConfig(c[0])}this.maperial.config.layers.push(b);this.maperial.restart()};
LayersManager.prototype.getOSMLayerConfig=function(){return{type:LayersManager.Vector,source:{type:Source.MaperialOSM},params:{},composition:{shader:MapParameters.MulBlend,params:{uParams:[-0.5,-0.5,1]}}}};LayersManager.prototype.getRasterLayerConfig=function(a){return{type:LayersManager.Raster,source:{type:Source.Raster,params:{uid:a}},params:{colorbar:MapParameters.DEFAULT_COLORBAR_UID},composition:{shader:MapParameters.MulBlend,params:{uParams:[-0.5,-0.5,1]}}}};
LayersManager.prototype.getVectorLayerConfig=function(){return{type:LayersManager.Vector,source:{type:Source.Vector},params:{},composition:{shader:MapParameters.AlphaBlend}}};LayersManager.prototype.getImagesLayerConfig=function(a){return{type:LayersManager.Images,source:{type:Source.Images,params:{src:a}},params:{},composition:{shader:MapParameters.AlphaBlend}}};
LayersManager.prototype.deleteLayer=function(a){this.maperial.config.layers.splice(a,1);for(i in this.maperial.config.map.osmSets)this.maperial.config.map.osmSets[i].layerPosition>a&&this.maperial.config.map.osmSets[i].layerPosition--;this.maperial.restart()};LayersManager.prototype.changeRaster=function(a,c){this.maperial.config.layers[a].type==Source.Raster&&this.maperial.config.layers[a].source.params.uid!=c&&(this.maperial.config.layers[a].source.params.uid=c,this.maperial.restart())};
LayersManager.prototype.changeImages=function(a,c){this.maperial.config.layers[a].type==Source.Images&&this.maperial.config.layers[a].source.params.src!=c&&(this.maperial.config.layers[a].source.params.src=c,this.maperial.restart())};LayersManager.prototype.switchImagesTo=function(a){for(var c=0;c<this.maperial.config.layers.length;c++)if(this.maperial.config.layers[c].source.type==Source.Images){this.changeImages(c,a);break}};
LayersManager.prototype.useDefaultLayers=function(){console.log("  using default layers...");this.maperial.config.layers=this.maperial.config.map.layersCreation?[]:[this.getOSMLayerConfig()]};LayersManager.prototype.exchangeLayers=function(a){var c=[];for(id in a)c.push(this.maperial.config.layers[a[id]]);for(i in this.maperial.config.map.osmSets)this.maperial.config.map.osmSets[i].layerPosition=a[this.maperial.config.map.osmSets[i].layerPosition];this.maperial.config.layers=c;this.maperial.restart()};
LayersManager.prototype.detachSet=function(a){this.maperial.config.map.osmSets[a].layerPosition=-1;this.maperial.restart()};LayersManager.prototype.attachSet=function(a,c){this.maperial.config.map.osmSets[a].layerPosition=c;this.maperial.restart()};
LayersManager.prototype.defaultOSMSets=function(a){console.log("  building default OSM Sets for style '"+a.name+"'...");console.log("  firstOSMPosition : "+this.firstOSMPosition);this.maperial.config.map.osmSets={"0":{label:"Roads",subLayerIds:"02f 030 031 032 033 034 035 036 037 038 039 03a 03b 03c 03d 03e".split(" "),layerPosition:-1},1:{label:"Floors",subLayerIds:["001","008","011"],layerPosition:-1},2:{label:"Buildings",subLayerIds:["050"],layerPosition:-1},3:{label:"Others",subLayerIds:[],layerPosition:-1}};
for(subLayerId in a.content){a=!0;for(i in this.maperial.config.map.osmSets)if("3"!=i&&0<=$.inArray(subLayerId,this.maperial.config.map.osmSets[i].subLayerIds)){a=!1;break}a&&this.maperial.config.map.osmSets["3"].subLayerIds.push(subLayerId)}for(i in this.maperial.config.map.osmSets)this.maperial.config.map.osmSets[i].layerPosition=this.firstOSMPosition};
LayersManager.prototype.atLeastOneImageLayer=function(){for(var a=0;a<this.maperial.config.layers.length;a++)if(this.maperial.config.layers[a].source.type==Source.Images)return!0;return!1};LayersManager.buildOSMVisibilities=function(a){console.log("building OSM visibilities...");var c={};for(s in a)for(var b=0;b<a[s].subLayerIds.length;b++)c[a[s].subLayerIds[b]]=a[s].layerPosition;return c};function BoundingBoxDrawer(a){this.map=a;this.drawBoard;this.drawingEnabled=this.selecting=!1;this.currentBox;this.centerLat;this.centerLon;this.latMin;this.lonMin;this.latMax;this.lonMax;this.initLatMin;this.initLonMin;this.initLatMax;this.initLonMax;this.zoomToFit;this.topLeftPoint;this.bottomRightPoint;this.startPoint;this.endPoint;this.pointsToMove=[];this.minSelectionSize=60}BoundingBoxDrawer.prototype.tryToRefresh=function(){try{this.draw()}catch(a){return!1}return!0};
BoundingBoxDrawer.prototype.init=function(){console.log("BoundingBoxDrawer.init");this.zoomToFit=null;if(!this.tryToRefresh()){console.log("init Fabric");this.drawBoard=new fabric.Canvas("drawBoard");this.drawBoard.setHeight(this.map.height);this.drawBoard.setWidth(this.map.width);console.log("newStartBox");this.newStartBox();console.log("mouse listeners");var a=this;this.map.mover.addDrawer(a);this.drawBoard.on("mouse:down",function(c){a.drawBoard.selection?c.target||(a.selecting=!0,a.startPoint=
new Point(c.e.x,c.e.y)):a.map.OnMouseDown(c.e)});this.drawBoard.on("mouse:up",function(c){a.drawBoard.selection?(a.selecting&&(a.endPoint=new Point(c.e.x,c.e.y),a.drawNewBoundingBox()),a.selecting=!1):a.map.OnMouseUp(c.e)});this.drawBoard.on("mouse:move",function(c){a.map.OnMouseMove(c.e)});this.drawBoard.on("object:modified",function(c){a.updateBoundingsFromCurrentBox();a.draw()});$("#drawBoardContainer").bind("mousewheel",function(c,b){a.map.OnMouseWheel(c,b);a.setBoundingsForZoom(a.map.zoom,!1)})}};
BoundingBoxDrawer.prototype.newStartBox=function(){this.topLeftPoint=new Point(this.drawBoard.getWidth()/2-200,this.drawBoard.getHeight()/2-200);this.bottomRightPoint=new Point(this.drawBoard.getWidth()/2+200,this.drawBoard.getHeight()/2+200);this.boundingsHaveChanged();this.setInitLatLon();this.draw()};BoundingBoxDrawer.prototype.cancelEdition=function(){this.setLatLon(this.initLatMin,this.initLonMin,this.initLatMax,this.initLonMax);this.zoomToFit=null;this.center()};
BoundingBoxDrawer.prototype.setInitLatLon=function(){this.initLatMin=this.latMin;this.initLatMax=this.latMax;this.initLonMin=this.lonMin;this.initLonMax=this.lonMax};BoundingBoxDrawer.prototype.setLatLon=function(a,c,b,e){this.latMin=a;this.latMax=b;this.lonMin=c;this.lonMax=e;this.centerLat=(this.latMin+this.latMax)/2;this.centerLon=(this.lonMin+this.lonMax)/2};BoundingBoxDrawer.prototype.resize=function(a,c){this.drawBoard.setHeight(c+App.Globals.HEADER_HEIGHT);this.drawBoard.setWidth(a);this.draw()};
BoundingBoxDrawer.prototype.updateBoundingsFromCurrentBox=function(){this.topLeftPoint.x=this.currentBox.left-this.currentBox.width*this.currentBox.scaleX/2;this.topLeftPoint.y=this.currentBox.top-this.currentBox.height*this.currentBox.scaleY/2;this.bottomRightPoint.x=this.currentBox.left+this.currentBox.width*this.currentBox.scaleX/2;this.bottomRightPoint.y=this.currentBox.top+this.currentBox.height*this.currentBox.scaleY/2;this.boundingsHaveChanged()};
BoundingBoxDrawer.prototype.drawNewBoundingBox=function(){Math.abs(this.endPoint.x-this.startPoint.x)<this.minSelectionSize||Math.abs(this.endPoint.y-this.startPoint.y)<this.minSelectionSize?this.drawBoard.setActiveObject(this.currentBox):(this.setBoundings(),this.draw(),this.zoomToFit=null)};
BoundingBoxDrawer.prototype.setBoundings=function(){this.startPoint.x<this.endPoint.x?this.startPoint.y<this.endPoint.y?(this.topLeftPoint=new Point(this.startPoint.x,this.startPoint.y),this.bottomRightPoint=new Point(this.endPoint.x,this.endPoint.y)):(this.topLeftPoint=new Point(this.startPoint.x,this.endPoint.y),this.bottomRightPoint=new Point(this.endPoint.x,this.startPoint.y)):this.startPoint.y<this.endPoint.y?(this.topLeftPoint=new Point(this.endPoint.x,this.startPoint.y),this.bottomRightPoint=
new Point(this.startPoint.x,this.endPoint.y)):(this.topLeftPoint=new Point(this.endPoint.x,this.endPoint.y),this.bottomRightPoint=new Point(this.startPoint.x,this.startPoint.y));this.boundingsHaveChanged();console.log("box from ["+this.topLeftPoint.x+" | "+this.topLeftPoint.y+"] to ["+this.bottomRightPoint.x+" | "+this.bottomRightPoint.y+"]")};
BoundingBoxDrawer.prototype.draw=function(){this.drawBoard.clear();var a=this.bottomRightPoint.x-this.topLeftPoint.x,c=this.bottomRightPoint.y-this.topLeftPoint.y,b=new fabric.Rect({width:a,height:c,top:this.topLeftPoint.y+c/2,left:this.topLeftPoint.x+a/2,fill:"rgba(0,0,0,0)"}),e=new fabric.Rect({width:this.drawBoard.getWidth(),height:this.topLeftPoint.y,top:this.topLeftPoint.y/2,left:this.drawBoard.getWidth()/2,fill:"rgba(0,0,0,0.7)",selectable:!1,hasControls:!1}),d=this.drawBoard.getHeight()-this.topLeftPoint.y-
c,d=new fabric.Rect({width:this.drawBoard.getWidth(),height:d,top:this.drawBoard.getHeight()-d/2,left:this.drawBoard.getWidth()/2,fill:"rgba(0,0,0,0.7)",selectable:!1,hasControls:!1}),f=new fabric.Rect({width:this.topLeftPoint.x,height:c,top:this.topLeftPoint.y+c/2,left:this.topLeftPoint.x/2,fill:"rgba(0,0,0,0.7)",selectable:!1,hasControls:!1}),a=this.drawBoard.getWidth()-this.topLeftPoint.x-a,c=new fabric.Rect({width:a,height:c,top:this.topLeftPoint.y+c/2,left:this.drawBoard.getWidth()-a/2,fill:"rgba(0,0,0,0.7)",
selectable:!1,hasControls:!1});this.drawBoard.add(f);this.drawBoard.add(c);this.drawBoard.add(e);this.drawBoard.add(d);this.drawBoard.add(b);this.currentBox=this.drawBoard.item(4);this.currentBox.lockRotation=!0;this.currentBox.hasRotatingPoint=!1;this.currentBox.set({borderColor:"black",cornerColor:"black",cornersize:5});this.drawBoard.selection=this.drawingEnabled;this.currentBox.selectable=this.drawingEnabled;(this.currentBox.hasControls=this.drawingEnabled)&&this.drawBoard.setActiveObject(this.currentBox)};
BoundingBoxDrawer.prototype.boundingsHaveChanged=function(){this.refreshLatLon();this.pointsToMove=[this.topLeftPoint,this.bottomRightPoint]};
BoundingBoxDrawer.prototype.refreshLatLon=function(){var a=this.map.coordS.MetersToPixels(this.map.centerM.x,this.map.centerM.y,this.map.zoom),c=this.drawBoard.getWidth()/2-this.topLeftPoint.x,b=this.drawBoard.getHeight()/2-this.topLeftPoint.y,e=this.bottomRightPoint.x-this.drawBoard.getWidth()/2,d=this.bottomRightPoint.y-this.drawBoard.getHeight()/2,c=this.map.coordS.PixelsToMeters(a.x-c,a.y+b,this.map.zoom),a=this.map.coordS.PixelsToMeters(a.x+e,a.y-d,this.map.zoom),e=this.map.coordS.MetersToLatLon(c.x,
c.y),a=this.map.coordS.MetersToLatLon(a.x,a.y);this.setLatLon(a.y,e.x,e.y,a.x)};BoundingBoxDrawer.prototype.center=function(){this.map.SetCenter(this.centerLat,this.centerLon);this.zoomToFit?this.setBoundingsForZoom(this.zoomToFit,!1):this.setBoundingsForZoom(16,!0)};
BoundingBoxDrawer.prototype.setBoundingsForZoom=function(a,c){c&&this.map.SetCenter(this.centerLat,this.centerLon);var b=this.map.coordS.MetersToPixels(this.map.centerM.x,this.map.centerM.y,a),e=this.map.coordS.LatLonToMeters(this.latMax,this.lonMin),d=this.map.coordS.LatLonToMeters(this.latMin,this.lonMax),f=this.map.coordS.MetersToPixels(e.x,e.y,a),e=this.map.coordS.MetersToPixels(d.x,d.y,a),d=b.x-f.x,f=f.y-b.y,g=e.x-b.x,b=b.y-e.y;this.topLeftPoint=new Point(this.drawBoard.getWidth()/2-d,this.drawBoard.getHeight()/
2-f);this.bottomRightPoint=new Point(this.drawBoard.getWidth()/2+g,this.drawBoard.getHeight()/2+b);c&&(0>this.topLeftPoint.x||this.bottomRightPoint.x>this.drawBoard.getWidth()||0>this.topLeftPoint.y||this.bottomRightPoint.y>this.drawBoard.getHeight())?this.setBoundingsForZoom(a-1,!0):(c&&(this.zoomToFit=a),this.map.SetZoom(a),this.boundingsHaveChanged(),this.draw())};BoundingBoxDrawer.prototype.deactivateDrawing=function(){this.drawingEnabled=!1;this.draw()};
BoundingBoxDrawer.prototype.activateDrawing=function(){this.zoomToFit&&this.map.zoom>this.zoomToFit&&this.center();this.drawingEnabled=!0;this.draw()};this.ColorTools={};ColorTools.rgbToHex=function(a,c,b){return ColorTools.toHex(a)+ColorTools.toHex(c)+ColorTools.toHex(b)};ColorTools.toHex=function(a){a=parseInt(a,10);if(isNaN(a))return"00";a=Math.max(0,Math.min(a,255));return"0123456789ABCDEF".charAt((a-a%16)/16)+"0123456789ABCDEF".charAt(a%16)};ColorTools.RGBAToHex=function(a){var c=a.split("(")[1].split(",")[0],b=a.split("(")[1].split(",")[1];a=a.split("(")[1].split(",")[2];return"#"+ColorTools.rgbToHex(c,b,a)};
ColorTools.cutHex=function(a){return"#"==a.charAt(0)?a.substring(1,7):a};ColorTools.hexToR=function(a){return parseInt(ColorTools.cutHex(a).substring(0,2),16)};ColorTools.hexToG=function(a){return parseInt(ColorTools.cutHex(a).substring(2,4),16)};ColorTools.hexToB=function(a){return parseInt(ColorTools.cutHex(a).substring(4,6),16)};ColorTools.HexToRGBA=function(a){var c=ColorTools.hexToR(a),b=ColorTools.hexToG(a);a=ColorTools.hexToB(a);return"rgba("+c+","+b+","+a+",1)"};this.Symbolizer={};Symbolizer.params={PolygonSymbolizer:["fill","alpha"],LineSymbolizer:"width stroke dasharray alpha linejoin linecap".split(" ")};Symbolizer.combos={linejoin:["miter","round","bevel"],linecap:["butt","round","square"]};Symbolizer.defaultValues={fill:"rgba(0,0,0,0)",stroke:"rgba(0,0,0,0)",width:"0",alpha:"1.0",dasharray:"",linejoin:"round",linecap:"round"};Symbolizer.getParamName=function(a,c){return Symbolizer.params[a][c]};(function(a){a.fn.extend({check:function(){return this.filter(":radio, :checkbox").attr("checked",!0)},uncheck:function(){return this.filter(":radio, :checkbox").removeAttr("checked")}})})(jQuery);Object.size=function(a){var c=0,b;for(b in a)a.hasOwnProperty(b)&&c++;return c};StyleMenu.SMALLEST=1;StyleMenu.MEDIUM=2;StyleMenu.BIGGEST=3;
function StyleMenu(a,c,b,e){console.log("  building style menu...");this.maperial=e;this.style=this.maperial.stylesManager.getSelectedStyle();this.size=StyleMenu.SMALLEST;this.currentLayerId="000";this.serverRootDirV="http://serv.x-ray.fr/project/mycarto/wwwClient/";this.serverRootDirD="http://map.x-ray.fr/";this.mappingArray=[];this.mapping=this.groups=null;this.activZooms=[];this.currentZmin=0;this.currentZmax=18;this.styleMenuParentEl=a;this.styleMenuParentEl2=c;this.styleMenuParentEl3=b;this.currentName=
this.currentGroup=this.currentUid=this.zoomDiv=this.widgetDiv=this.mainDiv=null;this.debug=!1;this.Load();this.initListeners();this.ChangeSelectedSubLayer(this.currentLayerId)}StyleMenu.prototype.initListeners=function(a){var c=this;$(window).on(MaperialEvents.OPEN_STYLE,function(a,e){c.ChangeSelectedSubLayer(e)})};StyleMenu.prototype.removeListeners=function(a){$(window).off(MaperialEvents.OPEN_STYLE)};StyleMenu.prototype.Refresh=function(){$(window).trigger(MaperialEvents.STYLE_CHANGED)};
StyleMenu.prototype.DefFromRule=function(a,c){if(void 0==this.style.content[a])return this.debug&&console.log(a+" not in style"),-1;for(var b=0;3>Object.size(this.style.content[a].s[c].s[b]);)if(b+=1,b>=Object.size(this.style.content[a].s[c].s))return this.debug&&console.log("cannot find def ...",a,c),-1;return b};
StyleMenu.prototype.DefRuleIdFromZoom=function(a,c){if(void 0==this.style.content[a])return this.debug&&console.log(a+" not in style"),{def:-1,ruleId:-1,rule:-1};for(var b=0;b<Object.size(this.style.content[a].s);b++)if(this.style.content[a].s[b].zmin==c){for(var e=0;3>Object.size(this.style.content[a].s[b].s[e]);)if(e+=1,e>=Object.size(this.style.content[a].s[b].s))return this.debug&&console.log("cannot find def ...",a,b),{def:-1,ruleId:-1,rule:-1};return{def:e,ruleId:this.style.content[a].s[b].s[e].id,
rule:b}}return{def:-1,ruleId:-1,rule:-1}};StyleMenu.prototype.SetParam=function(a,c,b,e,d){if(void 0==this.style.content[a])return this.debug&&console.log(a+" not in style"),!1;for(var f=!1,g=0;g<Object.size(this.style.content[a].s[c].s[b]);g++){var h=Symbolizer.getParamName(this.style.content[a].s[c].s[b].rt,g);if(h==e){this.style.content[a].s[c].s[b][h]=d;f=!0;break}}f||(this.style.content[a].s[c].s[b][e]=d);this.Refresh();return f};
StyleMenu.prototype.SetParamId=function(a,c,b,e){if(void 0==this.style.content[a])return this.debug&&console.log(a+" not in style"),!1;for(var d=0;d<Object.size(this.style.content[a].s);d++)for(var f=0;Object.size(this.style.content[a].s[d].s);f++)if(this.style.content[a].s[d].s[f].id==c){for(c=0;c<Object.size(this.style.content[a].s[d].s[f]);c++){var g=Symbolizer.getParamName(this.style.content[a].s[d].s[f].rt,c);if(g==b)return this.style.content[a].s[d].s[f][g]=e,this.Refresh(),!0}this.style.content[a].s[d].s[f][b]=
e;this.Refresh();return!0}this.debug&&console.log(" not found !",a,c,b);return!1};StyleMenu.prototype.SetParamIdZNew=function(a,c,b){console.log("---\x3e "+a);if(void 0==this.style.content[a])return this.debug&&console.log(a+" not in style"),!1;for(var e=0;e<Object.size(this.style.content[a].s);e++)if(-1<$.inArray(this.style.content[a].s[e].zmin,this.activZooms)){var d=this.DefFromRule(a,e);0>d||this.SetParam(a,e,d,c,b)}return!0};
StyleMenu.prototype.GetParamId=function(a,c,b){if(void 0==this.style.content[a])this.debug&&console.log(a+" not in style");else for(var e=0;e<Object.size(this.style.content[a].s);e++)for(var d=0;d<Object.size(this.style.content[a].s[e].s);d++)if(this.style.content[a].s[e].s[d].id==c)for(var f=0;f<Object.size(this.style.content[a].s[e].s[d]);f++){var g=Symbolizer.getParamName(this.style.content[a].s[e].s[d].rt,f);if(g==b)return this.style.content[a].s[e].s[d][g]}};StyleMenu.prototype.Load=function(){this.LoadGroup()};
StyleMenu.prototype.ReLoad=function(){this.BuildElements()};StyleMenu.prototype.LoadGroup=function(){this.debug&&console.log("Loading groups");var a=this;$.ajax({url:this.serverRootDirV+"style/group3.json",async:!1,dataType:"json",success:function(c){a.groups=c;a.LoadMapping()},error:function(){a.debug&&console.log("Loading group failed")}})};
StyleMenu.prototype.__LoadMapping=function(){this.debug&&console.log("##### MAPPING ####");for(var a=0;a<Object.size(this.mapping);a++)for(var c=0;c<Object.size(this.mapping[a].layers);c++)this.mappingArray[this.mapping[a].layers[c].id]={name:this.mapping[a].name,filter:this.mapping[a].layers[c].filter};this.BuildElements()};
StyleMenu.prototype.GetUids=function(a){var c=[];if("none"==a)return c;for(var b=0;b<Object.size(this.mapping);b++)if(this.mapping[b].name==a)for(var e=0;e<Object.size(this.mapping[b].layers);e++)c.push(this.mapping[b].layers[e].id);return c};StyleMenu.prototype.GetUid=function(a,c){for(var b=0;b<Object.size(this.mapping);b++)if(this.mapping[b].name==a)for(var e=0;e<Object.size(this.mapping[b].layers);e++)if(this.mapping[b].layers[e].filter==c)return this.mapping[b].layers[e].id;return null};
StyleMenu.prototype.LoadMapping=function(){this.debug&&console.log("Loading mapping");var a=this;$.ajax({url:this.serverRootDirV+"style/mapping.json",async:!1,dataType:"json",success:function(c){a.mapping=c;a.__LoadMapping()},error:function(){a.debug&&console.log("Loading mapping failed")}})};
StyleMenu.prototype.BuildElements=function(){this.styleMenuParentEl.empty();this.styleMenuParentEl2.empty();this.styleMenuParentEl3.empty();this.styleMenuParentEl.hide();this.mainDiv=$('<div id="styleMenu_menu_maindiv"></div>');this.mainDiv.appendTo(this.styleMenuParentEl);this.widgetDiv=$('<div id="styleMenu_menu_widgetDiv"></div>');this.widgetDiv.appendTo(this.styleMenuParentEl2);this.zoomDiv=$('<div class="styleMenu_menu_zoomDiv" id="styleMenu_menu_zoomDiv"></div>');this.zoomDiv.appendTo(this.styleMenuParentEl3);
this.__InsertZoomEdition();this.__InsertZoomEdition2();this.__InsertAccordion()};StyleMenu.prototype.UpdateActivZoom=function(){this.activZooms=[];for(var a=1;19>a;++a)a==this.maperial.GetZoom()?(this.debug&&console.log("map zoom is "+a),$("#styleMenu_menu_zcheck"+a).button("option","label","Z"+a+"*")):$("#styleMenu_menu_zcheck"+a).button("option","label","Z"+a),$("#styleMenu_menu_zcheck"+a).is(":checked")&&this.activZooms.push(a)};
StyleMenu.prototype.ZoomOut=function(){this.maperial.ZoomOut();this.UpdateActivZoom();this.refresh()};StyleMenu.prototype.ZoomIn=function(){this.maperial.ZoomIn();this.UpdateActivZoom();this.refresh()};StyleMenu.prototype.__InsertZoomEdition=function(){$("#styleMenu_menu_rlbutton").button();$("#styleMenu_menu_zbuttonminus").button();$("#styleMenu_menu_zbuttonplus").button()};
StyleMenu.prototype.__InsertZoomEdition2=function(){for(var a=this,c="",b=1;19>b;++b)c+='  <input type="checkbox" class="styleMenu_menu_checkboxz" id="styleMenu_menu_zcheck'+b+'"/><label class="zoom-button" for="styleMenu_menu_zcheck'+b+'">Z'+b+"</label>";$('<h2 class="styleMenu_menu_par_title_z"> Edit some zoom</h2><div id="styleMenu_menu_zoom_selector">'+c+"</div>").appendTo(this.zoomDiv);$('<h2 class="styleMenu_menu_par_title_z"> Edit a zoom range</h2><div id="styleMenu_menu_sliderrangez"></div><br/>').appendTo(this.zoomDiv);
for(b=1;19>b;++b)$("#styleMenu_menu_zcheck"+b).change(function(){a.UpdateActivZoom()});$("#styleMenu_menu_zoom_selector").buttonset();$("#styleMenu_menu_sliderrangez").slider({range:!0,min:1,max:19,values:[this.currentZmin,this.currentZmax],change:function(b,c){var f=c.values[0],g=c.values[1];a.currentZmin=f;a.currentZmax=g;for(var h=1;19>h;++h)h>=f&&h<g?$("#styleMenu_menu_zcheck"+h).check():$("#styleMenu_menu_zcheck"+h).uncheck(),$("#styleMenu_menu_zcheck"+h).button("refresh");a.UpdateActivZoom()},
slide:function(b,c){if(c.values[0]+1>c.values[1])return!1;var f=c.values[0],g=c.values[1];a.currentZmin=f;a.currentZmax=g;for(var h=1;19>h;++h)h>=f&&h<g?$("#styleMenu_menu_zcheck"+h).check():$("#styleMenu_menu_zcheck"+h).uncheck(),$("#styleMenu_menu_zcheck"+h).button("refresh");a.UpdateActivZoom()}});$("#styleMenu_menu_sliderrangez").slider("values",[this.currentZmin,this.currentZmax+1])};
StyleMenu.prototype.ColorPickerChange=function(a,c){return function(b,c,d){$("#styleMenu_menu_colorpicker_"+a+" div").css("backgroundColor","#"+c)}};StyleMenu.prototype.ColorPickerSubmit=function(a,c,b){var e=this;return function(c,f,g){c=e.linkedUIDs(a);for(g=0;g<c.length;g++)e.SetParamIdZNew(c[g],b,ColorTools.HexToRGBA(f))}};StyleMenu.prototype.GetSpinnerCallBack=function(a,c,b){var e=this;return function(c,f){e.SetParamIdZNew(a,b,f.value)}};
StyleMenu.prototype.GetSliderCallBack=function(a,c,b){var e=this;return function(c,f){e.SetParamIdZNew(a,b,f.value)}};StyleMenu.prototype.GetSelectCallBack=function(a,c,b){var e=this;return function(){var d=$("#styleMenu_menu_select_"+b+"_"+c+" option:selected").text();e.SetParamIdZNew(a,b,d)}};
StyleMenu.prototype.GetCheckBoxCallBack=function(a){var c=this;return function(){var b=$("#styleMenu_menu_check_"+a+":checked").val()?!0:!1;c.style[a].visible=b;var e=c.GetGroupNameFilterFromLayerId(a),d=[];if("line"==this.groups[e.group][e.name].type)var f=c.groups[e.group][e.name].center,d=d.concat(c.GetUids(c.groups[e.group][e.name].casing)),d=d.concat(c.GetUids(f));else"poly"==this.groups[e.group][e.name].type&&(d=d.concat(c.GetUids(c.groups[e.group][e.name].line)));for(e=0;e<d.length;e++)f=d[e],
c.mappingArray[f].filter==this.mappingArray[a].filter&&(c.style[f].visible=b);c.Refresh()}};
StyleMenu.prototype.AddColorPicker=function(a,c,b,e,d){$('<div class="colorSelector " id="styleMenu_menu_colorpicker_'+e+'"><div style="background-color:'+ColorTools.RGBAToHex(c)+'"></div></div>').appendTo(d);$("#styleMenu_menu_colorpicker_"+e).ColorPicker({color:ColorTools.RGBAToHex(c),onShow:function(a){$(a).fadeIn(500);return!1},onHide:function(a){$(a).fadeOut(500);return!1},onChange:this.ColorPickerChange(e,a),onSubmit:this.ColorPickerSubmit(b,e,a)})};
StyleMenu.prototype.AddSpinner=function(a,c,b,e,d,f,g,h){$("<li>"+a+' : <input class="styleMenu_menu_spinner" id="styleMenu_menu_spinner_'+a+"_"+e+'"></li>').appendTo(d);$("#styleMenu_menu_spinner_"+a+"_"+e).spinner({spin:this.GetSpinnerCallBack(b,e,a),step:f,min:g,max:h});$("#styleMenu_menu_spinner_"+a+"_"+e).spinner("value",c)};
StyleMenu.prototype.AddSlider=function(a,c,b,e,d,f,g,h){$("<li>"+a+' : <div class="styleMenu_menu_slider" id="styleMenu_menu_slider_'+a+"_"+e+'"></li>').appendTo(d);$("#styleMenu_menu_slider_"+a+"_"+e).slider({range:!1,min:g,max:h,step:f,value:c,stop:this.GetSliderCallBack(b,e,a)});$("#styleMenu_menu_slider_"+a+"_"+e).slider("value",c)};
StyleMenu.prototype.AddCombo=function(a,c,b,e,d,f){$("<li>"+a+' : <select id="styleMenu_menu_select_'+a+"_"+e+'"></li>').appendTo(d);for(d=0;d<Object.size(f);d++)$("#styleMenu_menu_select_"+a+"_"+e).append('<option value="'+f[d]+'"> '+f[d]+"</option>");$("#styleMenu_menu_select_"+a+"_"+e).val(c);$("#styleMenu_menu_select_"+a+"_"+e).change(this.GetSelectCallBack(b,e,a))};
StyleMenu.prototype.Accordion=function(a,c,b){if(1>this.style.content[b].s.length)this.debug&&console.log("Error : empty style "+b);else{c=0;for(var e in this.groups)if(this.groups.hasOwnProperty(e)){if(e==a)break;c++}n=$("#styleMenu_menu_groupaccordion_div_group_"+c+" h2").index($("#styleMenu_menu_headeraccordion_"+b));$("#styleMenu_menu_accordion").accordion("activate",c);$("#styleMenu_menu_groupaccordion_div_group_"+c).accordion("activate",n)}};
StyleMenu.prototype.GetFilterAlias=function(a,c,b){if(this.groups[a][c].hasOwnProperty("alias")){for(var e in this.groups[a][c].alias){var d=this.groups[a][c].alias[e];if(0<=this.mappingArray[b].filter.indexOf(d))return this.debug&&console.log(d+" is in "+this.mappingArray[b].filter),e}if(!aliasFound)return this.mappingArray[b].filter}else return this.mappingArray[b].filter};
StyleMenu.prototype.FillWidget=function(a){if(1>this.style.content[a].s.length)this.debug&&console.log("Error : empty style "+a);else{this.debug&&console.log("Current zoom is ",this.maperial.GetZoom(),a,b,c);var c=this.DefRuleIdFromZoom(a,this.maperial.GetZoom()),b=c.def,e=c.ruleId,c=c.rule;this.debug&&console.log("Fill widget for",b,e,c);if(0>e)this.debug&&console.log("Cannot find ruleId for zoom "+this.maperial.GetZoom());else if(0>c)this.debug&&console.log("Cannot find rule for zoom "+this.maperial.GetZoom());
else if(0>b)this.debug&&console.log("Cannot find def for zoom "+this.maperial.GetZoom());else{var d=$("<div></div>");d.appendTo(this.widgetDiv);var f=$("<ul></ul>");f.appendTo(d);for(d=0;d<Object.size(Symbolizer.params[this.style.content[a].s[c].s[b].rt]);d++){var g=Symbolizer.getParamName(this.style.content[a].s[c].s[b].rt,d),h=this.GetParamId(a,e,g);void 0===h&&(h=Symbolizer.defaultValues[g]);"width"==g?this.AddSlider(g,h,a,e,f,0.25,0,20):"fill"==g||"stroke"==g?this.AddColorPicker(g,h,a,e,f):"alpha"==
g?this.AddSlider(g,h,a,e,f,0.05,0,1):"linejoin"==g?this.AddCombo(g,h,a,e,f,Symbolizer.combos.linejoin):"linecap"==g?this.AddCombo(g,h,a,e,f,Symbolizer.combos.linecap):$("<li>"+g+"(not implemented yet) : "+h+"</li>").appendTo(f)}}}};
StyleMenu.prototype.__BuildWidget=function(a,c,b){var e=this;this.debug&&console.log("building widget ",a,c,b);this.widgetDiv.empty();var d=$('<i class="icon-zoom-out icon-white touchable"></i>');d.click(function(){e.size=StyleMenu.SMALLEST;e.refresh()});d.appendTo(this.widgetDiv);this.currentUid=b;this.currentGroup=a;this.currentName=c;void 0==this.style.content[b]?this.debug&&console.log(b+" not in style"):($('<h2 class="styleMenu_menu_par_title">'+this.mappingArray[b].name+"</h2>").appendTo(this.widgetDiv),
""!=this.mappingArray[b].filter&&1<this.GetUids(c).length&&$('<p class="styleMenu_menu_filter_title">('+this.GetFilterAlias(a,c,b)+")</p>").appendTo(this.widgetDiv),"line"==this.groups[a][this.mappingArray[b].name].type?(this.FillWidget(b),c=this.groups[a][this.mappingArray[b].name].center,a=this.GetUid(this.groups[a][this.mappingArray[b].name].casing,this.mappingArray[b].filter),b=this.GetUid(c,this.mappingArray[b].filter),null!=a&&($('<h2 class="styleMenu_menu_par_title">casing </h2>').appendTo(this.widgetDiv),
this.FillWidget(a)),null!=b&&($('<h2 class="styleMenu_menu_par_title">center line </h2>').appendTo(this.widgetDiv),this.FillWidget(b))):"poly"==this.groups[a][this.mappingArray[b].name].type&&(this.FillWidget(b),this.GetUid(this.groups[a][this.mappingArray[b].name].line,this.mappingArray[b].filter)),this.UpdateActivZoom())};StyleMenu.prototype.GetWidgetCallBack=function(a,c,b){var e=this;return function(){e.__BuildWidget(a,c,b)}};
StyleMenu.prototype.GetGroupNameFilterFromLayerId=function(a){for(var c in this.groups)if(this.groups.hasOwnProperty(c))for(var b in this.groups[c])if(this.groups[c].hasOwnProperty(b)){var e=this.GetUids(b),d=[];if("line"==this.groups[c][b].type)var f=this.groups[c][b].center,d=d.concat(this.GetUids(this.groups[c][b].casing)),d=d.concat(this.GetUids(f));else"poly"==this.groups[c][b].type&&(d=d.concat(this.GetUids(this.groups[c][b].line)));if(0!=e.length){for(f=0;f<e.length;f++){var g=e[f];if(a==g)return{group:c,
name:b,filter:this.mappingArray[a].filter,uid:a}}for(f=0;f<d.length;f++)if(g=d[f],a==g)for(var h=0;h<e.length;++h)if(this.mappingArray[e[h]].filter==this.mappingArray[g].filter)return{group:c,name:b,filter:this.mappingArray[a].filter,uid:e[h]}}}return{group:null,name:null,filter:null,uid:null}};
StyleMenu.prototype.__InsertAccordion=function(){$("#styleMenu_menu_accordion").remove();var a=$('<div class="styleMenu_menu_accordion" id="styleMenu_menu_accordion"></div>');a.appendTo(this.mainDiv);var c=0,b;for(b in this.groups)if(this.groups.hasOwnProperty(b)){this.debug&&console.log(b);$('<h1 id="styleMenu_menu_groupaccordion_head_group_'+c+'"> Group : '+b+"</h1>").appendTo(a);var e=$('<div class="styleMenu_menu_accordion" id="styleMenu_menu_groupaccordion_div_group_'+c+'"></div>');e.appendTo(a);
c++;for(var d in this.groups[b])if(this.groups[b].hasOwnProperty(d)){this.debug&&console.log("found ! : "+d);var f=this.GetUids(d);if(0==f.length)this.debug&&console.log("Warning : no uid found for "+d,b);else for(var g=0;g<f.length;g++){var h=f[g];""!=this.mappingArray[h].filter&&1<this.GetUids(d).length?$('<h2 id="styleMenu_menu_headeraccordion_'+h+'">'+this.GetFilterAlias(b,d,h)+"</h2>").appendTo(e):$('<h2 id="styleMenu_menu_headeraccordion_'+h+'">'+this.mappingArray[h].name+"</h2>").appendTo(e);
$("#styleMenu_menu_headeraccordion_"+h).bind("click",this.GetWidgetCallBack(b,d,h));var m=$('<div class="inner" id="divinner_'+c+"_"+h+'"></div>');m.appendTo(e);$("<strong>Properties :<strong>").appendTo(m);var r=$("<ul></ul>");r.appendTo(m);$("<li>Filter : "+this.mappingArray[h].filter+"</li>").appendTo(r);$('<li>Visible  : <input type="checkbox" id="styleMenu_menu_check_'+h+'" /></li>').appendTo(r);$("#styleMenu_menu_check_"+h).click(this.GetCheckBoxCallBack(h));$("#styleMenu_menu_check_"+h).attr("checked",
this.style.content[h].visible);$("<li>Place : "+this.style.content[h].layer+"</li>").appendTo(r)}}}this.__BuildWidget("xxx","yyy","zzz");this.UpdateActivZoom();$(".styleMenu_menu_accordion").accordion({heightStyle:"content",collapsible:!0,active:!1});this.styleMenuParentEl.show()};
StyleMenu.prototype.BuildSimpleWidget=function(a,c,b){var e=this;this.widgetDiv.empty();this.FillSimpleWidget(b);try{var d=this.groups[a][this.mappingArray[b].name].center,f=this.GetUid(this.groups[a][this.mappingArray[b].name].casing,this.mappingArray[b].filter),g=this.GetUid(d,this.mappingArray[b].filter);f&&this.FillSimpleWidget(f);g&&this.FillSimpleWidget(g)}catch(h){}a=$('<i class="icon-zoom-in icon-white touchable"></i>');a.click(function(){e.size=StyleMenu.MEDIUM;e.refresh()});a.appendTo(this.widgetDiv)};
StyleMenu.prototype.FillSimpleWidget=function(a){var c=this.DefRuleIdFromZoom(a,this.maperial.GetZoom()),b=c.def,e=c.ruleId,c=c.rule;this.debug&&console.log("Fill widget for",b,e,c);if(0>e)this.debug&&console.log("Cannot find ruleId for zoom "+this.maperial.GetZoom());else if(0>c)this.debug&&console.log("Cannot find rule for zoom "+this.maperial.GetZoom());else if(0>b)this.debug&&console.log("Cannot find def for zoom "+this.maperial.GetZoom());else for(var d=0;d<Object.size(Symbolizer.params[this.style.content[a].s[c].s[b].rt]);d++){var f=
Symbolizer.getParamName(this.style.content[a].s[c].s[b].rt,d),g=this.GetParamId(a,e,f);void 0===g&&(g=Symbolizer.defaultValues[f]);("fill"==f||"stroke"==f)&&this.AddColorPicker(f,g,a,e,this.widgetDiv)}};StyleMenu.prototype.refreshWidget=function(a,c,b){switch(this.size){case StyleMenu.SMALLEST:this.BuildSimpleWidget(a,c,b);break;case StyleMenu.MEDIUM:this.__BuildWidget(a,c,b)}};
StyleMenu.prototype.linkedUIDs=function(a){switch(a){case "000":case "001":return["000","001"];case "008":case "014":return["008","014"];default:return[a]}};StyleMenu.prototype.refresh=function(){var a=this.GetGroupNameFilterFromLayerId(this.currentLayerId);null!=a.group&&null!=a.name&&(this.refreshWidget(a.group,a.name,a.uid),this.Accordion(a.group,a.name,a.uid))};StyleMenu.prototype.ChangeSelectedSubLayer=function(a){this.currentLayerId=a;this.refresh()};function Maperial(){this.config;this.context;this.mapRenderer;this.mapMover;this.mapMouse;this.hud;this.stylesManager=new StylesManager(this);this.layersManager=new LayersManager(this);this.styleMenu}Maperial.prototype.restart=function(){$(window).trigger(MaperialEvents.LOADING);this.reset();this.load()};Maperial.prototype.apply=function(a){console.log("MaperialJS applies ",a);this.config=a;this.restart()};
Maperial.prototype.reset=function(){console.log("Reset maperial...");try{this.mapRenderer.reset()}catch(a){}try{this.mapMover.removeListeners(),this.mapMouse.removeListeners(),this.hud.reset()}catch(c){}try{this.styleMenu.removeListeners()}catch(b){}this.stylesManager=new StylesManager(this,!0);this.layersManager=new LayersManager(this);console.log("stylesCache : ",this.stylesManager.styles)};
Maperial.prototype.load=function(){console.log("Starting maperialJS build...");this.checkConfig();this.createContext();if(0<this.config.layers.length){var a=this;this.loadStyles(function(){a.checkOSMSets();a.build()})}else this.finishStartup()};Maperial.prototype.build=function(){console.log("starting build...");this.buildMap();this.buildHUD();this.config.edition&&this.buildStyleMenu();this.initGeoloc();this.finishStartup()};
Maperial.prototype.finishStartup=function(){this.refreshScreen();$(window).resize(Utils.apply(this,"refreshScreen"));$(window).trigger(MaperialEvents.READY)};
Maperial.prototype.checkConfig=function(){console.log("checking config...");this.config||(this.config=this.defaultConfig());this.config.hud||(this.config.hud={elements:{},options:{}});this.config.map||(this.config.map={});this.config.layers?console.log("  using custom layers..."):this.layersManager.useDefaultLayers();this.changeStyle(MapParameters.DEFAULT_STYLE_UID,0,!1)};Maperial.prototype.emptyConfig=function(){return{hud:{elements:{},options:{}},map:{}}};
Maperial.prototype.defaultConfig=function(){console.log("using default config");var a={};HUD.applyDefaultHUD(a);return a};Maperial.prototype.loadStyles=function(a){console.log("checking styles...");for(var c=[],b=0;b<this.config.layers.length;b++){var e=this.config.layers[b].params;e.styles&&(c.push(e.styles[e.selectedStyle]),0>this.layersManager.firstOSMPosition&&(this.layersManager.firstOSMPosition=b))}0<c.length?this.stylesManager.fetchStyles(c,a):a()};
Maperial.prototype.changeStyle=function(a,c,b){void 0===c&&(c=0);void 0===b&&(b=!0);for(var e=0;e<this.config.layers.length;e++)if(this.config.layers[e].source.type==Source.MaperialOSM){var d=this.config.layers[e].params;if(!d.styles||b)b?console.log("Changing style..."):console.log("  using default style..."),d.styles={},d.styles[c]=a,d.selectedStyle=c}b&&this.restart()};
Maperial.prototype.createContext=function(){this.context?console.log("reset context..."):(console.log("creating context..."),this.context={},this.context.coordS=new CoordinateSystem(MapParameters.tileSize),this.context.centerM=this.context.coordS.LatLonToMeters(MapParameters.DEFAULT_LATITUDE,MapParameters.DEFAULT_LONGITUDE),this.context.mouseM=this.context.centerM,this.context.mouseP=null,this.context.zoom=MapParameters.DEFAULT_ZOOM);this.context.mapCanvas=$("#"+MapParameters.mapCanvasName);this.config.hud.elements[HUD.MAGNIFIER]&&
(this.context.magnifierCanvas=$("#"+MapParameters.magnifierCanvasName));this.context.parameters=new MapParameters(this)};Maperial.prototype.buildMap=function(){console.log("  building map...");this.mapRenderer=new MapRenderer(this);this.mapMover=new MapMover(this);this.mapMouse=new MapMouse(this);this.mapRenderer.Start()};Maperial.prototype.initGeoloc=function(){this.config.hud.elements[HUD.GEOLOC]&&GeoLoc.init("GeoLoc",$("#GeoLocGo"),this,!1)};
Maperial.prototype.buildStyleMenu=function(){this.styleMenu=new StyleMenu($("#detailsMenu"),$("#quickEdit"),$("#zooms"),this)};Maperial.prototype.buildHUD=function(){this.hud=new HUD(this)};
Maperial.prototype.refreshScreen=function(){console.log("refreshing screen...");var a=$(window).width(),c=$(window).height();this.config.map.width&&(a=this.config.map.width);this.config.map.height&&(c=this.config.map.height);this.context.mapCanvas[0]&&(this.context.mapCanvas.css("width",a),this.context.mapCanvas.css("height",c),this.context.mapCanvas[0].width=a,this.context.mapCanvas[0].height=c);try{this.mapRenderer.fitToSize(),this.mapMover.resizeDrawers(),this.hud.placeElements()}catch(b){console.log(b)}};
Maperial.prototype.checkOSMSets=function(){if(!$.isEmptyObject(this.stylesManager.styles)){console.log("checking OSM sets...");var a=this.stylesManager.getSelectedStyle();a&&!this.config.map.osmSets&&this.layersManager.defaultOSMSets(a);this.refreshOSMVisibilities()}};Maperial.prototype.refreshOSMVisibilities=function(){this.context.osmVisibilities=LayersManager.buildOSMVisibilities(this.config.map.osmSets)};
Maperial.prototype.SetCenter=function(a,c){this.context.centerM=this.context.coordS.LatLonToMeters(a,c);this.mapRenderer.DrawScene()};Maperial.prototype.SetZoom=function(a){-1<a&&19>a&&(this.context.zoom=a)};Maperial.prototype.GetZoom=function(){return this.context.zoom};Maperial.prototype.ZoomIn=function(){18>this.context.zoom&&this.SetZoom(this.context.zoom+1)};Maperial.prototype.ZoomOut=function(){0<this.context.zoom&&this.SetZoom(this.context.zoom-1)};
