(function(b){function c(a){var c=a||window.event,e=[].slice.call(arguments,1),h=0,m=0,s=0;return a=b.event.fix(c),a.type="mousewheel",c.wheelDelta&&(h=c.wheelDelta/120),c.detail&&(h=-c.detail/3),s=h,void 0!==c.axis&&c.axis===c.HORIZONTAL_AXIS&&(s=0,m=-1*h),void 0!==c.wheelDeltaY&&(s=c.wheelDeltaY/120),void 0!==c.wheelDeltaX&&(m=-1*c.wheelDeltaX/120),e.unshift(a,h,m,s),(b.event.dispatch||b.event.handle).apply(this,e)}var a=["DOMMouseScroll","mousewheel"];if(b.event.fixHooks)for(var e=a.length;e;)b.event.fixHooks[a[--e]]=
b.event.mouseHooks;b.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var b=a.length;b;)this.addEventListener(a[--b],c,!1);else this.onmousewheel=c},teardown:function(){if(this.removeEventListener)for(var b=a.length;b;)this.removeEventListener(a[--b],c,!1);else this.onmousewheel=null}};b.fn.extend({mousewheel:function(a){return a?this.bind("mousewheel",a):this.trigger("mousewheel")},unmousewheel:function(a){return this.unbind("mousewheel",a)}})})(jQuery);this.Utils={};Utils.zeroPad=function(b,c){var a=c-b.toString().length+1;return Array(+(0<a&&a)).join("0")+b};Utils.dateTime=function(){var b=new Date;return b.getFullYear()+"-"+Utils.zeroPad(b.getMonth()+1,2)+"-"+Utils.zeroPad(b.getDate(),2)};
Utils.alert=function(b,c,a,e){$("#"+b).append($("<div class='alert-message alert-"+c+' fade in\' data-alert><a class="btn btn-rounded btn-icon-only btn-dark closer" data-dismiss="alert"> <i class="icon icon-ex-white-outline"></i></a><h4 class="alert-heading">'+a+"</h4> "+e+" </div>"))};Utils.htmlEncode=function(b){return $("<div/>").text(b).html()};Utils.htmlDecode=function(b){return $("<div/>").html(b).text()};Utils.replaceAll=function(b,c,a){return b.replace(RegExp(c,"g"),a)};
Utils.rgbToHex=function(b,c,a){if(255<b||255<c||255<a)throw"Invalid color component";return(b<<16|c<<8|a).toString(16)};Utils.formatFileSize=function(b){return"number"!==typeof b?"":1E9<=b?(b/1E9).toFixed(2)+" GB":1E6<=b?(b/1E6).toFixed(2)+" MB":(b/1E3).toFixed(2)+" KB"};Utils.formatDate=function(b){var c=void 0==b?new Date:new Date(b);b=Utils.zeroPad(c.getDate(),2);var a=Utils.zeroPad(c.getMonth()+1,2),c=c.getFullYear();return b+"/"+a+"/"+c};
Utils.generateGuid=function(){var b,c,a;b="";for(a=0;32>a;a++){if(8==a||12==a||16==a||20==a)b+="_";c=Math.floor(16*Math.random()).toString(16).toUpperCase();b+=c}return b};Utils.popup=function(b,c,a,e){return window.open(b,c,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+a+", height="+e+", top="+(screen.height/2-e/2)+", left="+(screen.width/2-a/2))};
Utils.toHtml=function(b,c){for(;-1!=b.indexOf("{");){var a=b.substring(b.indexOf("{"),b.indexOf("}")+1),e=eval(a);b=b.replace(a,e)}return b};Utils.isObject=function(b){return"[object Object]"===Object.prototype.toString.call(b)};Utils.editObjectInArray=function(b,c,a){Ember.ObjectProxy.create({content:b}).set(c,a)};Utils.styleThumbURL=function(b){return Utils.thumbURL(b,"style")};Utils.colorbarThumbURL=function(b){return Utils.thumbURL(b,"colorbar")};
Utils.thumbURL=function(b,c){if(void 0==b||null==b)return"";var a=b.substring(b.length-4).split(""),e=App.Globals.mapServer+"/thumbs"+c;a.forEach(function(a){e+="/"+a});return e+"/"+b+".png"};Utils.apply=function(b,c){return function(a,e,d,f,g,h){b[c](a,e,d,f,g,h)}};Utils.getPoint=function(b){var c=b.clientX-$(b.target).offset().left;b=b.clientY-$(b.target).offset().top;return new Point(c,b)};(function(b,c){"object"===typeof exports?module.exports=c(global):"function"===typeof define&&define.amd?define([],function(){return c(b)}):c(b)})(this,function(b){function c(a){return d=a}function a(){return d="undefined"!==typeof Float32Array?Float32Array:Array}var e={};(function(){if("undefined"!=typeof Float32Array){var a=new Float32Array(1),b=new Int32Array(a.buffer);e.invsqrt=function(c){a[0]=c;b[0]=1597463007-(b[0]>>1);var d=a[0];return d*(1.5-0.5*c*d*d)}}else e.invsqrt=function(a){return 1/
Math.sqrt(a)}})();var d=null;a();var f={create:function(a){var b=new d(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):b[0]=b[1]=b[2]=0;return b},createFrom:function(a,b,c){var e=new d(3);e[0]=a;e[1]=b;e[2]=c;return e},set:function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];return b},equal:function(a,b){return a===b||1E-6>Math.abs(a[0]-b[0])&&1E-6>Math.abs(a[1]-b[1])&&1E-6>Math.abs(a[2]-b[2])},add:function(a,b,c){if(!c||a===c)return a[0]+=b[0],a[1]+=b[1],a[2]+=b[2],a;c[0]=a[0]+b[0];c[1]=a[1]+b[1];c[2]=a[2]+b[2];return c},
subtract:function(a,b,c){if(!c||a===c)return a[0]-=b[0],a[1]-=b[1],a[2]-=b[2],a;c[0]=a[0]-b[0];c[1]=a[1]-b[1];c[2]=a[2]-b[2];return c},multiply:function(a,b,c){if(!c||a===c)return a[0]*=b[0],a[1]*=b[1],a[2]*=b[2],a;c[0]=a[0]*b[0];c[1]=a[1]*b[1];c[2]=a[2]*b[2];return c},negate:function(a,b){b||(b=a);b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];return b},scale:function(a,b,c){if(!c||a===c)return a[0]*=b,a[1]*=b,a[2]*=b,a;c[0]=a[0]*b;c[1]=a[1]*b;c[2]=a[2]*b;return c},normalize:function(a,b){b||(b=a);var c=a[0],
d=a[1],e=a[2],f=Math.sqrt(c*c+d*d+e*e);if(!f)return b[0]=0,b[1]=0,b[2]=0,b;if(1===f)return b[0]=c,b[1]=d,b[2]=e,b;f=1/f;b[0]=c*f;b[1]=d*f;b[2]=e*f;return b},cross:function(a,b,c){c||(c=a);var d=a[0],e=a[1];a=a[2];var f=b[0],g=b[1];b=b[2];c[0]=e*b-a*g;c[1]=a*f-d*b;c[2]=d*g-e*f;return c},length:function(a){var b=a[0],c=a[1];a=a[2];return Math.sqrt(b*b+c*c+a*a)},squaredLength:function(a){var b=a[0],c=a[1];a=a[2];return b*b+c*c+a*a},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},direction:function(a,
b,c){c||(c=a);var d=a[0]-b[0],e=a[1]-b[1];a=a[2]-b[2];b=Math.sqrt(d*d+e*e+a*a);if(!b)return c[0]=0,c[1]=0,c[2]=0,c;b=1/b;c[0]=d*b;c[1]=e*b;c[2]=a*b;return c},lerp:function(a,b,c,d){d||(d=a);d[0]=a[0]+c*(b[0]-a[0]);d[1]=a[1]+c*(b[1]-a[1]);d[2]=a[2]+c*(b[2]-a[2]);return d},dist:function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2];return Math.sqrt(c*c+d*d+e*e)}},g=null,h=new d(4);f.unproject=function(a,b,c,d,e){e||(e=a);g||(g=r.create());var f=g;h[0]=2*(a[0]-d[0])/d[2]-1;h[1]=2*(a[1]-d[1])/d[3]-1;h[2]=
2*a[2]-1;h[3]=1;r.multiply(c,b,f);if(!r.inverse(f))return null;r.multiplyVec4(f,h);if(0===h[3])return null;e[0]=h[0]/h[3];e[1]=h[1]/h[3];e[2]=h[2]/h[3];return e};var m=f.createFrom(1,0,0),s=f.createFrom(0,1,0),t=f.createFrom(0,0,1),q=f.create();f.rotationTo=function(a,b,c){c||(c=v.create());var d=f.dot(a,b);if(1<=d)v.set(w,c);else if(-0.999999>d)f.cross(m,a,q),1E-6>f.length(q)&&f.cross(s,a,q),1E-6>f.length(q)&&f.cross(t,a,q),f.normalize(q),v.fromAngleAxis(Math.PI,q,c);else{var d=Math.sqrt(2*(1+d)),
e=1/d;f.cross(a,b,q);c[0]=q[0]*e;c[1]=q[1]*e;c[2]=q[2]*e;c[3]=0.5*d;v.normalize(c)}1<c[3]?c[3]=1:-1>c[3]&&(c[3]=-1);return c};f.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+"]"};var u={create:function(a){var b=new d(9);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8]):b[0]=b[1]=b[2]=b[3]=b[4]=b[5]=b[6]=b[7]=b[8]=0;return b},createFrom:function(a,b,c,e,f,g,h,m,r){var u=new d(9);u[0]=a;u[1]=b;u[2]=c;u[3]=e;u[4]=f;u[5]=g;u[6]=h;u[7]=m;u[8]=r;return u},
determinant:function(a){var b=a[3],c=a[4],d=a[5],e=a[6],f=a[7],g=a[8];return a[0]*(g*c-d*f)+a[1]*(-g*b+d*e)+a[2]*(f*b-c*e)},inverse:function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],m=a[6],r=a[7],q=a[8],s=q*g-h*r,t=-q*f+h*m,v=r*f-g*m,x=c*s+d*t+e*v;if(!x)return null;x=1/x;b||(b=u.create());b[0]=s*x;b[1]=(-q*d+e*r)*x;b[2]=(h*d-e*g)*x;b[3]=t*x;b[4]=(q*c-e*m)*x;b[5]=(-h*c+e*f)*x;b[6]=v*x;b[7]=(-r*c+d*m)*x;b[8]=(g*c-d*f)*x;return b},multiply:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],
g=a[3],h=a[4],m=a[5],r=a[6],u=a[7];a=a[8];var q=b[0],s=b[1],t=b[2],v=b[3],x=b[4],z=b[5],w=b[6],F=b[7];b=b[8];c[0]=q*d+s*g+t*r;c[1]=q*e+s*h+t*u;c[2]=q*f+s*m+t*a;c[3]=v*d+x*g+z*r;c[4]=v*e+x*h+z*u;c[5]=v*f+x*m+z*a;c[6]=w*d+F*g+b*r;c[7]=w*e+F*h+b*u;c[8]=w*f+F*m+b*a;return c},multiplyVec2:function(a,b,c){c||(c=b);var d=b[0];b=b[1];c[0]=d*a[0]+b*a[3]+a[6];c[1]=d*a[1]+b*a[4]+a[7];return c},multiplyVec3:function(a,b,c){c||(c=b);var d=b[0],e=b[1];b=b[2];c[0]=d*a[0]+e*a[3]+b*a[6];c[1]=d*a[1]+e*a[4]+b*a[7];
c[2]=d*a[2]+e*a[5]+b*a[8];return c},set:function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return b},equal:function(a,b){return a===b||1E-6>Math.abs(a[0]-b[0])&&1E-6>Math.abs(a[1]-b[1])&&1E-6>Math.abs(a[2]-b[2])&&1E-6>Math.abs(a[3]-b[3])&&1E-6>Math.abs(a[4]-b[4])&&1E-6>Math.abs(a[5]-b[5])&&1E-6>Math.abs(a[6]-b[6])&&1E-6>Math.abs(a[7]-b[7])&&1E-6>Math.abs(a[8]-b[8])},identity:function(a){a||(a=u.create());a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=1;a[5]=
0;a[6]=0;a[7]=0;a[8]=1;return a},transpose:function(a,b){if(!b||a===b){var c=a[1],d=a[2],e=a[5];a[1]=a[3];a[2]=a[6];a[3]=c;a[5]=a[7];a[6]=d;a[7]=e;return a}b[0]=a[0];b[1]=a[3];b[2]=a[6];b[3]=a[1];b[4]=a[4];b[5]=a[7];b[6]=a[2];b[7]=a[5];b[8]=a[8];return b},toMat4:function(a,b){b||(b=r.create());b[15]=1;b[14]=0;b[13]=0;b[12]=0;b[11]=0;b[10]=a[8];b[9]=a[7];b[8]=a[6];b[7]=0;b[6]=a[5];b[5]=a[4];b[4]=a[3];b[3]=0;b[2]=a[2];b[1]=a[1];b[0]=a[0];return b},str:function(a){return"["+a[0]+", "+a[1]+", "+a[2]+
", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+"]"}},r={create:function(a){var b=new d(16);a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15]);return b},createFrom:function(a,b,c,e,f,g,h,m,r,u,q,s,t,v,x,z){var w=new d(16);w[0]=a;w[1]=b;w[2]=c;w[3]=e;w[4]=f;w[5]=g;w[6]=h;w[7]=m;w[8]=r;w[9]=u;w[10]=q;w[11]=s;w[12]=t;w[13]=v;w[14]=x;w[15]=z;return w},set:function(a,
b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return b},equal:function(a,b){return a===b||1E-6>Math.abs(a[0]-b[0])&&1E-6>Math.abs(a[1]-b[1])&&1E-6>Math.abs(a[2]-b[2])&&1E-6>Math.abs(a[3]-b[3])&&1E-6>Math.abs(a[4]-b[4])&&1E-6>Math.abs(a[5]-b[5])&&1E-6>Math.abs(a[6]-b[6])&&1E-6>Math.abs(a[7]-b[7])&&1E-6>Math.abs(a[8]-b[8])&&1E-6>Math.abs(a[9]-b[9])&&1E-6>Math.abs(a[10]-b[10])&&
1E-6>Math.abs(a[11]-b[11])&&1E-6>Math.abs(a[12]-b[12])&&1E-6>Math.abs(a[13]-b[13])&&1E-6>Math.abs(a[14]-b[14])&&1E-6>Math.abs(a[15]-b[15])},identity:function(a){a||(a=r.create());a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},transpose:function(a,b){if(!b||a===b){var c=a[1],d=a[2],e=a[3],f=a[6],g=a[7],h=a[11];a[1]=a[4];a[2]=a[8];a[3]=a[12];a[4]=c;a[6]=a[9];a[7]=a[13];a[8]=d;a[9]=f;a[11]=a[14];a[12]=e;a[13]=g;a[14]=h;
return a}b[0]=a[0];b[1]=a[4];b[2]=a[8];b[3]=a[12];b[4]=a[1];b[5]=a[5];b[6]=a[9];b[7]=a[13];b[8]=a[2];b[9]=a[6];b[10]=a[10];b[11]=a[14];b[12]=a[3];b[13]=a[7];b[14]=a[11];b[15]=a[15];return b},determinant:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],m=a[7],r=a[8],u=a[9],q=a[10],s=a[11],t=a[12],v=a[13],x=a[14];a=a[15];return t*u*h*e-r*v*h*e-t*g*q*e+f*v*q*e+r*g*x*e-f*u*x*e-t*u*d*m+r*v*d*m+t*c*q*m-b*v*q*m-r*c*x*m+b*u*x*m+t*g*d*s-f*v*d*s-t*c*h*s+b*v*h*s+f*c*x*s-b*g*x*s-r*g*d*a+f*u*d*
a+r*c*h*a-b*u*h*a-f*c*q*a+b*g*q*a},inverse:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],m=a[6],r=a[7],u=a[8],q=a[9],s=a[10],t=a[11],v=a[12],x=a[13],w=a[14],z=a[15],F=c*h-d*g,J=c*m-e*g,A=c*r-f*g,G=d*m-e*h,S=d*r-f*h,T=e*r-f*m,U=u*x-q*v,V=u*w-s*v,W=u*z-t*v,ba=q*w-s*x,ca=q*z-t*x,da=s*z-t*w,O=F*da-J*ca+A*ba+G*W-S*V+T*U;if(!O)return null;O=1/O;b[0]=(h*da-m*ca+r*ba)*O;b[1]=(-d*da+e*ca-f*ba)*O;b[2]=(x*T-w*S+z*G)*O;b[3]=(-q*T+s*S-t*G)*O;b[4]=(-g*da+m*W-r*V)*O;b[5]=(c*da-e*W+f*V)*O;
b[6]=(-v*T+w*A-z*J)*O;b[7]=(u*T-s*A+t*J)*O;b[8]=(g*ca-h*W+r*U)*O;b[9]=(-c*ca+d*W-f*U)*O;b[10]=(v*S-x*A+z*F)*O;b[11]=(-u*S+q*A-t*F)*O;b[12]=(-g*ba+h*V-m*U)*O;b[13]=(c*ba-d*V+e*U)*O;b[14]=(-v*G+x*J-w*F)*O;b[15]=(u*G-q*J+s*F)*O;return b},toRotationMat:function(a,b){b||(b=r.create());b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b},toMat3:function(a,b){b||(b=u.create());b[0]=a[0];b[1]=
a[1];b[2]=a[2];b[3]=a[4];b[4]=a[5];b[5]=a[6];b[6]=a[8];b[7]=a[9];b[8]=a[10];return b},toInverseMat3:function(a,b){var c=a[0],d=a[1],e=a[2],f=a[4],g=a[5],h=a[6],m=a[8],r=a[9],q=a[10],s=q*g-h*r,t=-q*f+h*m,v=r*f-g*m,x=c*s+d*t+e*v;if(!x)return null;x=1/x;b||(b=u.create());b[0]=s*x;b[1]=(-q*d+e*r)*x;b[2]=(h*d-e*g)*x;b[3]=t*x;b[4]=(q*c-e*m)*x;b[5]=(-h*c+e*f)*x;b[6]=v*x;b[7]=(-r*c+d*m)*x;b[8]=(g*c-d*f)*x;return b},multiply:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],m=a[5],r=a[6],u=a[7],
q=a[8],s=a[9],t=a[10],v=a[11],x=a[12],w=a[13],z=a[14];a=a[15];var F=b[0],J=b[1],A=b[2],G=b[3];c[0]=F*d+J*h+A*q+G*x;c[1]=F*e+J*m+A*s+G*w;c[2]=F*f+J*r+A*t+G*z;c[3]=F*g+J*u+A*v+G*a;F=b[4];J=b[5];A=b[6];G=b[7];c[4]=F*d+J*h+A*q+G*x;c[5]=F*e+J*m+A*s+G*w;c[6]=F*f+J*r+A*t+G*z;c[7]=F*g+J*u+A*v+G*a;F=b[8];J=b[9];A=b[10];G=b[11];c[8]=F*d+J*h+A*q+G*x;c[9]=F*e+J*m+A*s+G*w;c[10]=F*f+J*r+A*t+G*z;c[11]=F*g+J*u+A*v+G*a;F=b[12];J=b[13];A=b[14];G=b[15];c[12]=F*d+J*h+A*q+G*x;c[13]=F*e+J*m+A*s+G*w;c[14]=F*f+J*r+A*t+G*
z;c[15]=F*g+J*u+A*v+G*a;return c},multiplyVec3:function(a,b,c){c||(c=b);var d=b[0],e=b[1];b=b[2];c[0]=a[0]*d+a[4]*e+a[8]*b+a[12];c[1]=a[1]*d+a[5]*e+a[9]*b+a[13];c[2]=a[2]*d+a[6]*e+a[10]*b+a[14];return c},multiplyVec4:function(a,b,c){c||(c=b);var d=b[0],e=b[1],f=b[2];b=b[3];c[0]=a[0]*d+a[4]*e+a[8]*f+a[12]*b;c[1]=a[1]*d+a[5]*e+a[9]*f+a[13]*b;c[2]=a[2]*d+a[6]*e+a[10]*f+a[14]*b;c[3]=a[3]*d+a[7]*e+a[11]*f+a[15]*b;return c},translate:function(a,b,c){var d=b[0],e=b[1];b=b[2];var f,g,h,m,r,u,q,s,t,v,x,w;
if(!c||a===c)return a[12]=a[0]*d+a[4]*e+a[8]*b+a[12],a[13]=a[1]*d+a[5]*e+a[9]*b+a[13],a[14]=a[2]*d+a[6]*e+a[10]*b+a[14],a[15]=a[3]*d+a[7]*e+a[11]*b+a[15],a;f=a[0];g=a[1];h=a[2];m=a[3];r=a[4];u=a[5];q=a[6];s=a[7];t=a[8];v=a[9];x=a[10];w=a[11];c[0]=f;c[1]=g;c[2]=h;c[3]=m;c[4]=r;c[5]=u;c[6]=q;c[7]=s;c[8]=t;c[9]=v;c[10]=x;c[11]=w;c[12]=f*d+r*e+t*b+a[12];c[13]=g*d+u*e+v*b+a[13];c[14]=h*d+q*e+x*b+a[14];c[15]=m*d+s*e+w*b+a[15];return c},scale:function(a,b,c){var d=b[0],e=b[1];b=b[2];if(!c||a===c)return a[0]*=
d,a[1]*=d,a[2]*=d,a[3]*=d,a[4]*=e,a[5]*=e,a[6]*=e,a[7]*=e,a[8]*=b,a[9]*=b,a[10]*=b,a[11]*=b,a;c[0]=a[0]*d;c[1]=a[1]*d;c[2]=a[2]*d;c[3]=a[3]*d;c[4]=a[4]*e;c[5]=a[5]*e;c[6]=a[6]*e;c[7]=a[7]*e;c[8]=a[8]*b;c[9]=a[9]*b;c[10]=a[10]*b;c[11]=a[11]*b;c[12]=a[12];c[13]=a[13];c[14]=a[14];c[15]=a[15];return c},rotate:function(a,b,c,d){var e=c[0],f=c[1];c=c[2];var g=Math.sqrt(e*e+f*f+c*c),h,m,r,u,q,s,t,v,x,w,z,F,A,aa,G,S,T,U,V,W;if(!g)return null;1!==g&&(g=1/g,e*=g,f*=g,c*=g);h=Math.sin(b);m=Math.cos(b);r=1-m;
b=a[0];g=a[1];u=a[2];q=a[3];s=a[4];t=a[5];v=a[6];x=a[7];w=a[8];z=a[9];F=a[10];A=a[11];aa=e*e*r+m;G=f*e*r+c*h;S=c*e*r-f*h;T=e*f*r-c*h;U=f*f*r+m;V=c*f*r+e*h;W=e*c*r+f*h;e=f*c*r-e*h;f=c*c*r+m;d?a!==d&&(d[12]=a[12],d[13]=a[13],d[14]=a[14],d[15]=a[15]):d=a;d[0]=b*aa+s*G+w*S;d[1]=g*aa+t*G+z*S;d[2]=u*aa+v*G+F*S;d[3]=q*aa+x*G+A*S;d[4]=b*T+s*U+w*V;d[5]=g*T+t*U+z*V;d[6]=u*T+v*U+F*V;d[7]=q*T+x*U+A*V;d[8]=b*W+s*e+w*f;d[9]=g*W+t*e+z*f;d[10]=u*W+v*e+F*f;d[11]=q*W+x*e+A*f;return d},rotateX:function(a,b,c){var d=
Math.sin(b);b=Math.cos(b);var e=a[4],f=a[5],g=a[6],h=a[7],m=a[8],r=a[9],u=a[10],q=a[11];c?a!==c&&(c[0]=a[0],c[1]=a[1],c[2]=a[2],c[3]=a[3],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a;c[4]=e*b+m*d;c[5]=f*b+r*d;c[6]=g*b+u*d;c[7]=h*b+q*d;c[8]=e*-d+m*b;c[9]=f*-d+r*b;c[10]=g*-d+u*b;c[11]=h*-d+q*b;return c},rotateY:function(a,b,c){var d=Math.sin(b);b=Math.cos(b);var e=a[0],f=a[1],g=a[2],h=a[3],m=a[8],r=a[9],u=a[10],q=a[11];c?a!==c&&(c[4]=a[4],c[5]=a[5],c[6]=a[6],c[7]=a[7],c[12]=a[12],c[13]=a[13],
c[14]=a[14],c[15]=a[15]):c=a;c[0]=e*b+m*-d;c[1]=f*b+r*-d;c[2]=g*b+u*-d;c[3]=h*b+q*-d;c[8]=e*d+m*b;c[9]=f*d+r*b;c[10]=g*d+u*b;c[11]=h*d+q*b;return c},rotateZ:function(a,b,c){var d=Math.sin(b);b=Math.cos(b);var e=a[0],f=a[1],g=a[2],h=a[3],m=a[4],r=a[5],u=a[6],q=a[7];c?a!==c&&(c[8]=a[8],c[9]=a[9],c[10]=a[10],c[11]=a[11],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a;c[0]=e*b+m*d;c[1]=f*b+r*d;c[2]=g*b+u*d;c[3]=h*b+q*d;c[4]=e*-d+m*b;c[5]=f*-d+r*b;c[6]=g*-d+u*b;c[7]=h*-d+q*b;return c},frustum:function(a,
b,c,d,e,f,g){g||(g=r.create());var h=b-a,m=d-c,u=f-e;g[0]=2*e/h;g[1]=0;g[2]=0;g[3]=0;g[4]=0;g[5]=2*e/m;g[6]=0;g[7]=0;g[8]=(b+a)/h;g[9]=(d+c)/m;g[10]=-(f+e)/u;g[11]=-1;g[12]=0;g[13]=0;g[14]=-(2*f*e)/u;g[15]=0;return g},perspective:function(a,b,c,d,e){a=c*Math.tan(a*Math.PI/360);b*=a;return r.frustum(-b,b,-a,a,c,d,e)},ortho:function(a,b,c,d,e,f,g){g||(g=r.create());var h=b-a,m=d-c,u=f-e;g[0]=2/h;g[1]=0;g[2]=0;g[3]=0;g[4]=0;g[5]=2/m;g[6]=0;g[7]=0;g[8]=0;g[9]=0;g[10]=-2/u;g[11]=0;g[12]=-(a+b)/h;g[13]=
-(d+c)/m;g[14]=-(f+e)/u;g[15]=1;return g},lookAt:function(a,b,c,d){d||(d=r.create());var e,f,g,h,m,u,q,s,t=a[0],v=a[1];a=a[2];g=c[0];h=c[1];f=c[2];q=b[0];c=b[1];e=b[2];if(t===q&&v===c&&a===e)return r.identity(d);b=t-q;c=v-c;q=a-e;s=1/Math.sqrt(b*b+c*c+q*q);b*=s;c*=s;q*=s;e=h*q-f*c;f=f*b-g*q;g=g*c-h*b;(s=Math.sqrt(e*e+f*f+g*g))?(s=1/s,e*=s,f*=s,g*=s):g=f=e=0;h=c*g-q*f;m=q*e-b*g;u=b*f-c*e;(s=Math.sqrt(h*h+m*m+u*u))?(s=1/s,h*=s,m*=s,u*=s):u=m=h=0;d[0]=e;d[1]=h;d[2]=b;d[3]=0;d[4]=f;d[5]=m;d[6]=c;d[7]=
0;d[8]=g;d[9]=u;d[10]=q;d[11]=0;d[12]=-(e*t+f*v+g*a);d[13]=-(h*t+m*v+u*a);d[14]=-(b*t+c*v+q*a);d[15]=1;return d},fromRotationTranslation:function(a,b,c){c||(c=r.create());var d=a[0],e=a[1],f=a[2],g=a[3],h=d+d,m=e+e,u=f+f;a=d*h;var q=d*m,d=d*u,s=e*m,e=e*u,f=f*u,h=g*h,m=g*m,g=g*u;c[0]=1-(s+f);c[1]=q+g;c[2]=d-m;c[3]=0;c[4]=q-g;c[5]=1-(a+f);c[6]=e+h;c[7]=0;c[8]=d+m;c[9]=e-h;c[10]=1-(a+s);c[11]=0;c[12]=b[0];c[13]=b[1];c[14]=b[2];c[15]=1;return c},str:function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+
a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+"]"}},v={create:function(a){var b=new d(4);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]):b[0]=b[1]=b[2]=b[3]=0;return b},createFrom:function(a,b,c,e){var f=new d(4);f[0]=a;f[1]=b;f[2]=c;f[3]=e;return f},set:function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return b},equal:function(a,b){return a===b||1E-6>Math.abs(a[0]-b[0])&&1E-6>Math.abs(a[1]-b[1])&&1E-6>Math.abs(a[2]-
b[2])&&1E-6>Math.abs(a[3]-b[3])},identity:function(a){a||(a=v.create());a[0]=0;a[1]=0;a[2]=0;a[3]=1;return a}},w=v.identity();v.calculateW=function(a,b){var c=a[0],d=a[1],e=a[2];if(!b||a===b)return a[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e)),a;b[0]=c;b[1]=d;b[2]=e;b[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e));return b};v.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]};v.inverse=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],c=(c=c*c+d*d+e*e+f*f)?1/c:0;if(!b||a===b)return a[0]*=-c,a[1]*=-c,
a[2]*=-c,a[3]*=c,a;b[0]=-a[0]*c;b[1]=-a[1]*c;b[2]=-a[2]*c;b[3]=a[3]*c;return b};v.conjugate=function(a,b){if(!b||a===b)return a[0]*=-1,a[1]*=-1,a[2]*=-1,a;b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];b[3]=a[3];return b};v.length=function(a){var b=a[0],c=a[1],d=a[2];a=a[3];return Math.sqrt(b*b+c*c+d*d+a*a)};v.normalize=function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=a[3],g=Math.sqrt(c*c+d*d+e*e+f*f);if(0===g)return b[0]=0,b[1]=0,b[2]=0,b[3]=0,b;g=1/g;b[0]=c*g;b[1]=d*g;b[2]=e*g;b[3]=f*g;return b};v.add=function(a,
b,c){if(!c||a===c)return a[0]+=b[0],a[1]+=b[1],a[2]+=b[2],a[3]+=b[3],a;c[0]=a[0]+b[0];c[1]=a[1]+b[1];c[2]=a[2]+b[2];c[3]=a[3]+b[3];return c};v.multiply=function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2];a=a[3];var g=b[0],h=b[1],m=b[2];b=b[3];c[0]=d*b+a*g+e*m-f*h;c[1]=e*b+a*h+f*g-d*m;c[2]=f*b+a*m+d*h-e*g;c[3]=a*b-d*g-e*h-f*m;return c};v.multiplyVec3=function(a,b,c){c||(c=b);var d=b[0],e=b[1],f=b[2];b=a[0];var g=a[1],h=a[2];a=a[3];var m=a*d+g*f-h*e,r=a*e+h*d-b*f,u=a*f+b*e-g*d,d=-b*d-g*e-h*f;c[0]=m*a+
d*-b+r*-h-u*-g;c[1]=r*a+d*-g+u*-b-m*-h;c[2]=u*a+d*-h+m*-g-r*-b;return c};v.scale=function(a,b,c){if(!c||a===c)return a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b,a;c[0]=a[0]*b;c[1]=a[1]*b;c[2]=a[2]*b;c[3]=a[3]*b;return c};v.toMat3=function(a,b){b||(b=u.create());var c=a[0],d=a[1],e=a[2],f=a[3],g=c+c,h=d+d,m=e+e,r=c*g,q=c*h,c=c*m,s=d*h,d=d*m,e=e*m,g=f*g,h=f*h,f=f*m;b[0]=1-(s+e);b[1]=q+f;b[2]=c-h;b[3]=q-f;b[4]=1-(r+e);b[5]=d+g;b[6]=c+h;b[7]=d-g;b[8]=1-(r+s);return b};v.toMat4=function(a,b){b||(b=r.create());var c=
a[0],d=a[1],e=a[2],f=a[3],g=c+c,h=d+d,m=e+e,u=c*g,q=c*h,c=c*m,s=d*h,d=d*m,e=e*m,g=f*g,h=f*h,f=f*m;b[0]=1-(s+e);b[1]=q+f;b[2]=c-h;b[3]=0;b[4]=q-f;b[5]=1-(u+e);b[6]=d+g;b[7]=0;b[8]=c+h;b[9]=d-g;b[10]=1-(u+s);b[11]=0;b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b};v.slerp=function(a,b,c,d){d||(d=a);var e=a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3],f,g;if(1<=Math.abs(e))return d!==a&&(d[0]=a[0],d[1]=a[1],d[2]=a[2],d[3]=a[3]),d;f=Math.acos(e);g=Math.sqrt(1-e*e);if(0.0010>Math.abs(g))return d[0]=0.5*a[0]+0.5*b[0],
d[1]=0.5*a[1]+0.5*b[1],d[2]=0.5*a[2]+0.5*b[2],d[3]=0.5*a[3]+0.5*b[3],d;e=Math.sin((1-c)*f)/g;c=Math.sin(c*f)/g;d[0]=a[0]*e+b[0]*c;d[1]=a[1]*e+b[1]*c;d[2]=a[2]*e+b[2]*c;d[3]=a[3]*e+b[3]*c;return d};v.fromRotationMatrix=function(a,b){b||(b=v.create());var c=a[0]+a[4]+a[8],d;if(0<c)d=Math.sqrt(c+1),b[3]=0.5*d,d=0.5/d,b[0]=(a[7]-a[5])*d,b[1]=(a[2]-a[6])*d,b[2]=(a[3]-a[1])*d;else{d=v.fromRotationMatrix.s_iNext=v.fromRotationMatrix.s_iNext||[1,2,0];c=0;a[4]>a[0]&&(c=1);a[8]>a[3*c+c]&&(c=2);var e=d[c],f=
d[e];d=Math.sqrt(a[3*c+c]-a[3*e+e]-a[3*f+f]+1);b[c]=0.5*d;d=0.5/d;b[3]=(a[3*f+e]-a[3*e+f])*d;b[e]=(a[3*e+c]+a[3*c+e])*d;b[f]=(a[3*f+c]+a[3*c+f])*d}return b};u.toQuat4=v.fromRotationMatrix;(function(){var a=u.create();v.fromAxes=function(b,c,d,e){a[0]=c[0];a[3]=c[1];a[6]=c[2];a[1]=d[0];a[4]=d[1];a[7]=d[2];a[2]=b[0];a[5]=b[1];a[8]=b[2];return v.fromRotationMatrix(a,e)}})();v.identity=function(a){a||(a=v.create());a[0]=0;a[1]=0;a[2]=0;a[3]=1;return a};v.fromAngleAxis=function(a,b,c){c||(c=v.create());
a*=0.5;var d=Math.sin(a);c[3]=Math.cos(a);c[0]=d*b[0];c[1]=d*b[1];c[2]=d*b[2];return c};v.toAngleAxis=function(a,b){b||(b=a);var c=a[0]*a[0]+a[1]*a[1]+a[2]*a[2];0<c?(b[3]=2*Math.acos(a[3]),c=e.invsqrt(c),b[0]=a[0]*c,b[1]=a[1]*c,b[2]=a[2]*c):(b[3]=0,b[0]=1,b[1]=0,b[2]=0);return b};v.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"};var z={create:function(a){var b=new d(2);a?(b[0]=a[0],b[1]=a[1]):(b[0]=0,b[1]=0);return b},createFrom:function(a,b){var c=new d(2);c[0]=a;c[1]=b;return c},
add:function(a,b,c){c||(c=b);c[0]=a[0]+b[0];c[1]=a[1]+b[1];return c},subtract:function(a,b,c){c||(c=b);c[0]=a[0]-b[0];c[1]=a[1]-b[1];return c},multiply:function(a,b,c){c||(c=b);c[0]=a[0]*b[0];c[1]=a[1]*b[1];return c},divide:function(a,b,c){c||(c=b);c[0]=a[0]/b[0];c[1]=a[1]/b[1];return c},scale:function(a,b,c){c||(c=a);c[0]=a[0]*b;c[1]=a[1]*b;return c},dist:function(a,b){var c=b[0]-a[0],d=b[1]-a[1];return Math.sqrt(c*c+d*d)},set:function(a,b){b[0]=a[0];b[1]=a[1];return b},equal:function(a,b){return a===
b||1E-6>Math.abs(a[0]-b[0])&&1E-6>Math.abs(a[1]-b[1])},negate:function(a,b){b||(b=a);b[0]=-a[0];b[1]=-a[1];return b},normalize:function(a,b){b||(b=a);var c=a[0]*a[0]+a[1]*a[1];0<c?(c=Math.sqrt(c),b[0]=a[0]/c,b[1]=a[1]/c):b[0]=b[1]=0;return b},cross:function(a,b,c){a=a[0]*b[1]-a[1]*b[0];if(!c)return a;c[0]=c[1]=0;c[2]=a;return c},length:function(a){var b=a[0];a=a[1];return Math.sqrt(b*b+a*a)},squaredLength:function(a){var b=a[0];a=a[1];return b*b+a*a},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]},
direction:function(a,b,c){c||(c=a);var d=a[0]-b[0];a=a[1]-b[1];b=d*d+a*a;if(!b)return c[0]=0,c[1]=0,c[2]=0,c;b=1/Math.sqrt(b);c[0]=d*b;c[1]=a*b;return c},lerp:function(a,b,c,d){d||(d=a);d[0]=a[0]+c*(b[0]-a[0]);d[1]=a[1]+c*(b[1]-a[1]);return d},str:function(a){return"["+a[0]+", "+a[1]+"]"}},x={create:function(a){var b=new d(4);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]):b[0]=b[1]=b[2]=b[3]=0;return b},createFrom:function(a,b,c,e){var f=new d(4);f[0]=a;f[1]=b;f[2]=c;f[3]=e;return f},set:function(a,
b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return b},equal:function(a,b){return a===b||1E-6>Math.abs(a[0]-b[0])&&1E-6>Math.abs(a[1]-b[1])&&1E-6>Math.abs(a[2]-b[2])&&1E-6>Math.abs(a[3]-b[3])},identity:function(a){a||(a=x.create());a[0]=1;a[1]=0;a[2]=0;a[3]=1;return a},transpose:function(a,b){if(!b||a===b){var c=a[1];a[1]=a[2];a[2]=c;return a}b[0]=a[0];b[1]=a[2];b[2]=a[1];b[3]=a[3];return b},determinant:function(a){return a[0]*a[3]-a[2]*a[1]},inverse:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],
f=a[3],g=c*f-e*d;if(!g)return null;g=1/g;b[0]=f*g;b[1]=-d*g;b[2]=-e*g;b[3]=c*g;return b},multiply:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2];a=a[3];c[0]=d*b[0]+e*b[2];c[1]=d*b[1]+e*b[3];c[2]=f*b[0]+a*b[2];c[3]=f*b[1]+a*b[3];return c},rotate:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2];a=a[3];var g=Math.sin(b);b=Math.cos(b);c[0]=d*b+e*g;c[1]=d*-g+e*b;c[2]=f*b+a*g;c[3]=f*-g+a*b;return c},multiplyVec2:function(a,b,c){c||(c=b);var d=b[0];b=b[1];c[0]=d*a[0]+b*a[1];c[1]=d*a[2]+b*a[3];return c},
scale:function(a,b,c){c||(c=a);var d=a[1],e=a[2],f=a[3],g=b[0];b=b[1];c[0]=a[0]*g;c[1]=d*b;c[2]=e*g;c[3]=f*b;return c},str:function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"}},A={create:function(a){var b=new d(4);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]):(b[0]=0,b[1]=0,b[2]=0,b[3]=0);return b},createFrom:function(a,b,c,e){var f=new d(4);f[0]=a;f[1]=b;f[2]=c;f[3]=e;return f},add:function(a,b,c){c||(c=b);c[0]=a[0]+b[0];c[1]=a[1]+b[1];c[2]=a[2]+b[2];c[3]=a[3]+b[3];return c},subtract:function(a,
b,c){c||(c=b);c[0]=a[0]-b[0];c[1]=a[1]-b[1];c[2]=a[2]-b[2];c[3]=a[3]-b[3];return c},multiply:function(a,b,c){c||(c=b);c[0]=a[0]*b[0];c[1]=a[1]*b[1];c[2]=a[2]*b[2];c[3]=a[3]*b[3];return c},divide:function(a,b,c){c||(c=b);c[0]=a[0]/b[0];c[1]=a[1]/b[1];c[2]=a[2]/b[2];c[3]=a[3]/b[3];return c},scale:function(a,b,c){c||(c=a);c[0]=a[0]*b;c[1]=a[1]*b;c[2]=a[2]*b;c[3]=a[3]*b;return c},set:function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return b},equal:function(a,b){return a===b||1E-6>Math.abs(a[0]-b[0])&&
1E-6>Math.abs(a[1]-b[1])&&1E-6>Math.abs(a[2]-b[2])&&1E-6>Math.abs(a[3]-b[3])},negate:function(a,b){b||(b=a);b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];b[3]=-a[3];return b},length:function(a){var b=a[0],c=a[1],d=a[2];a=a[3];return Math.sqrt(b*b+c*c+d*d+a*a)},squaredLength:function(a){var b=a[0],c=a[1],d=a[2];a=a[3];return b*b+c*c+d*d+a*a},lerp:function(a,b,c,d){d||(d=a);d[0]=a[0]+c*(b[0]-a[0]);d[1]=a[1]+c*(b[1]-a[1]);d[2]=a[2]+c*(b[2]-a[2]);d[3]=a[3]+c*(b[3]-a[3]);return d},str:function(a){return"["+a[0]+", "+
a[1]+", "+a[2]+", "+a[3]+"]"}};b&&(b.glMatrixArrayType=d,b.MatrixArray=d,b.setMatrixArrayType=c,b.determineMatrixArrayType=a,b.glMath=e,b.vec2=z,b.vec3=f,b.vec4=A,b.mat2=x,b.mat3=u,b.mat4=r,b.quat4=v);return{glMatrixArrayType:d,MatrixArray:d,setMatrixArrayType:c,determineMatrixArrayType:a,glMath:e,vec2:z,vec3:f,vec4:A,mat2:x,mat3:u,mat4:r,quat4:v}});function Point(b,c){this.x=b;this.y=c}function CoordinateSystem(b){this.tileSize=b;this.initialResolution=12756274*Math.PI/b;this.originShift=12756274*Math.PI/2}CoordinateSystem.prototype.LatLonToMeters=function(b,c){mx=c*this.originShift/180;my=Math.log(Math.tan((90+b)*Math.PI/360))/(Math.PI/180);my=my*this.originShift/180;return new Point(mx,my)};
CoordinateSystem.prototype.MetersToLatLon=function(b,c){lon=180*(b/this.originShift);lat=180*(c/this.originShift);lat=180/Math.PI*(2*Math.atan(Math.exp(lat*Math.PI/180))-Math.PI/2);return new Point(lon,lat)};CoordinateSystem.prototype.PixelsToMeters=function(b,c,a){res=this.Resolution(a);mx=b*res-this.originShift;my=c*res-this.originShift;return new Point(mx,my)};
CoordinateSystem.prototype.MetersToPixels=function(b,c,a){res=this.Resolution(a);px=(b+this.originShift)/res;py=(c+this.originShift)/res;return new Point(px,py)};CoordinateSystem.prototype.MetersToPixelsAccurate=function(b,c,a){var e=this.MetersToLatLon(b,c).y;res=this.ResolutionByLat(a,e);px=(b+this.originShift)/res;py=(c+this.originShift)/res;return new Point(px,py)};
CoordinateSystem.prototype.PixelsToTile=function(b,c){tx=Math.floor(Math.ceil(b/this.tileSize)-1);ty=Math.floor(Math.ceil(c/this.tileSize)-1);return new Point(tx,ty)};CoordinateSystem.prototype.PixelsToRaster=function(b,c,a){mapSize=this.tileSize*Math.pow(2,a);return new Point(b,mapSize-c)};CoordinateSystem.prototype.MetersToTile=function(b,c,a){p=this.MetersToPixels(b,c,a);return this.PixelsToTile(p.x,p.y)};
CoordinateSystem.prototype.Resolution=function(b){return this.initialResolution/Math.pow(2,b)};CoordinateSystem.prototype.ResolutionByLat=function(b,c){var a=6378*Math.cos(c/180*Math.PI);return 1E3*2*Math.PI*a/this.tileSize/Math.pow(2,b)};CoordinateSystem.prototype.GoogleTile=function(b,c,a){return new Point(b,Math.pow(2,a)-1-c)};this.GeoLoc={};
GeoLoc.init=function(b,c,a,e){function d(){var a=document.getElementById(b).value;h.geocode({address:a},function(a,b){if(b==google.maps.GeocoderStatus.OK){var c=a[0].geometry.location.lat(),d=a[0].geometry.location.lng();s.SetCenter(c,d)}else m&&console.log("Geocode failed: "+b)})}function f(){var a=document.getElementById(b),a=new google.maps.places.Autocomplete(a,{types:["geocode"]});google.maps.event.addListener(a,"place_changed",function(){d()});d()}function g(a){s.SetCenter(a.coords.latitude,a.coords.longitude);
f()}var h,m=!1,s=a;c.bind("click",function(){d()});(function(a){h=new google.maps.Geocoder;a&&navigator.geolocation?navigator.geolocation.getCurrentPosition(g):(m&&console.log("No HTML5 geoloc OR tryGeoloc "+a),f())})(e)};var fabric=fabric||{version:"1.0.6"};"undefined"!==typeof exports&&(exports.fabric=fabric);"undefined"!==typeof document&&"undefined"!==typeof window?(fabric.document=document,fabric.window=window):(fabric.document=require("jsdom").jsdom("<!DOCTYPE html><html><head></head><body></body></html>"),fabric.window=fabric.document.createWindow());fabric.isTouchSupported="ontouchstart"in fabric.document.documentElement;fabric.isLikelyNode="undefined"!==typeof Buffer&&"undefined"===typeof window;
var Cufon=function(){function b(a){var b=this.face=a.face;this.glyphs=a.glyphs;this.w=a.w;this.baseSize=parseInt(b["units-per-em"],10);this.family=b["font-family"].toLowerCase();this.weight=b["font-weight"];this.style=b["font-style"]||"normal";this.viewBox=function(){var a=b.bbox.split(/\s+/),a={minX:parseInt(a[0],10),minY:parseInt(a[1],10),maxX:parseInt(a[2],10),maxY:parseInt(a[3],10)};a.width=a.maxX-a.minX;a.height=a.maxY-a.minY;a.toString=function(){return[this.minX,this.minY,this.width,this.height].join(" ")};
return a}();this.ascent=-parseInt(b.ascent,10);this.descent=-parseInt(b.descent,10);this.height=-this.ascent+this.descent}function c(){var a={},b={oblique:"italic",italic:"oblique"};this.add=function(b){(a[b.style]||(a[b.style]={}))[b.weight]=b};this.get=function(c,d){var e=a[c]||a[b[c]]||a.normal||a.italic||a.oblique;if(!e)return null;d={normal:400,bold:700}[d]||parseInt(d,10);if(e[d])return e[d];var f={1:1,99:0}[d%100],g=[],h,m;void 0===f&&(f=400<d);500==d&&(d=400);for(var r in e){r=parseInt(r,
10);if(!h||r<h)h=r;if(!m||r>m)m=r;g.push(r)}d<h&&(d=h);d>m&&(d=m);g.sort(function(a,b){return(f?a>d&&b>d?a<b:a>b:a<d&&b<d?a>b:a<b)?-1:1});return e[g[0]]}}function a(a){var b={},c={};this.get=function(c){return void 0!=b[c]?b[c]:a[c]};this.getSize=function(a,b){return c[a]||(c[a]=new q.Size(this.get(a),b))};this.extend=function(a){for(var c in a)b[c]=a[c];return this}}function e(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,function(){return c.call(a,fabric.window.event)})}
function d(a){var b={};return function(c){b.hasOwnProperty(c)||(b[c]=a.apply(null,arguments));return b[c]}}function f(a){return fabric.document.getElementsByTagName(a)}function g(){for(var a={},b,c=0,d=arguments.length;c<d;++c)for(b in arguments[c])a[b]=arguments[c][b];return a}function h(a,b,c,d,e,f){var g=d.separate;if("none"==g)return z[d.engine].apply(null,arguments);var h=fabric.document.createDocumentFragment(),m=b.split(B[g]),r="words"==g;r&&u&&(/^\s/.test(b)&&m.unshift(""),/\s$/.test(b)&&
m.push(""));for(var s=0,t=m.length;s<t;++s)(g=z[d.engine](a,r?q.textAlign(m[s],c,s,t):m[s],c,d,e,f,s<t-1))&&h.appendChild(g);return h}function m(a,b){var c,d,e,f;e=r.get(a);e.options||(b.hover&&b.hoverables[a.nodeName.toLowerCase()]&&v.attach(a),e.options=b);for(var g=a.firstChild;g;g=e){e=g.nextSibling;f=!1;if(1==g.nodeType){if(!g.firstChild)continue;if(/cufon/.test(g.className))f=!0;else{arguments.callee(g,b);continue}}d||(d=q.getStyle(a).extend(b));if(!c)a:{(c=d)||(c=q.getStyle(a));for(var m=q.quotedList(c.get("fontFamily").toLowerCase()),
u=void 0,s=0,t=m.length;s<t;++s)if(u=m[s],x[u]){c=x[u].get(c.get("fontStyle"),c.get("fontWeight"));break a}c=null}if(c)if(f)z[b.engine](c,null,d,b,g,a);else f=g.data,"undefined"!=typeof G_vmlCanvasManager&&(f=f.replace(/\r/g,"\n")),""!==f&&((f=h(c,f,d,b,g,a))?g.parentNode.replaceChild(f,g):g.parentNode.removeChild(g))}}var s=function(){return s.replace.apply(null,arguments)},t=s.DOM={ready:function(){var a=!1,b={loaded:1,complete:1},c=[],d=function(){if(!a){a=!0;for(var b;b=c.shift();b());}};fabric.document.addEventListener&&
(fabric.document.addEventListener("DOMContentLoaded",d,!1),fabric.window.addEventListener("pageshow",d,!1));!fabric.window.opera&&fabric.document.readyState&&function(){b[fabric.document.readyState]?d():setTimeout(arguments.callee,10)}();fabric.document.readyState&&fabric.document.createStyleSheet&&function(){try{fabric.document.body.doScroll("left"),d()}catch(a){setTimeout(arguments.callee,1)}}();e(fabric.window,"load",d);return function(b){arguments.length?a?b():c.push(b):d()}}()},q=s.CSS={Size:function(a,
b){this.value=parseFloat(a);this.unit=String(a).match(/[a-z%]*$/)[0]||"px";this.convert=function(a){return a/b*this.value};this.convertFrom=function(a){return a/this.value*b};this.toString=function(){return this.value+this.unit}},getStyle:function(b){return new a(b.style)},quotedList:d(function(a){for(var b=[],c=/\s*((["'])([\s\S]*?[^\\])\2|[^,]+)\s*/g,d;d=c.exec(a);)b.push(d[3]||d[1]);return b}),ready:function(){var a=!1,b=[],c=Object.prototype.propertyIsEnumerable?f("style"):{length:0},d=f("link");
t.ready(function(){for(var e=0,f,g=0,h=d.length;f=d[g],g<h;++g)!f.disabled&&"stylesheet"==f.rel.toLowerCase()&&++e;if(fabric.document.styleSheets.length>=c.length+e)for(a=!0;e=b.shift();e());else setTimeout(arguments.callee,10)});return function(c){a?c():b.push(c)}}(),supports:function(a,b){var c=fabric.document.createElement("span").style;if(void 0===c[a])return!1;c[a]=b;return c[a]===b},textAlign:function(a,b,c,d){"right"==b.get("textAlign")?0<c&&(a=" "+a):c<d-1&&(a+=" ");return a},textDecoration:function(a,
b){b||(b=this.getStyle(a));for(var c={underline:null,overline:null,"line-through":null},d=a;d.parentNode&&1==d.parentNode.nodeType;){var e=!0,f;for(f in c)c[f]||(-1!=b.get("textDecoration").indexOf(f)&&(c[f]=b.get("color")),e=!1);if(e)break;b=this.getStyle(d=d.parentNode)}return c},textShadow:d(function(a){if("none"==a)return null;for(var b=[],c={},d,e=0,f=/(#[a-f0-9]+|[a-z]+\(.*?\)|[a-z]+)|(-?[\d.]+[a-z%]*)|,/ig;d=f.exec(a);)","==d[0]?(b.push(c),c={},e=0):d[1]?c.color=d[1]:c[["offX","offY","blur"][e++]]=
d[2];b.push(c);return b}),color:d(function(a){var b={};b.color=a.replace(/^rgba\((.*?),\s*([\d.]+)\)/,function(a,c,d){b.opacity=parseFloat(d);return"rgb("+c+")"});return b}),textTransform:function(a,b){return a[{uppercase:"toUpperCase",lowercase:"toLowerCase"}[b.get("textTransform")]||"toString"]()}},u=0==" ".split(/\s+/).length,r=new function(){var a={},b=0;this.get=function(c){c=c.cufid||(c.cufid=++b);return a[c]||(a[c]={})}},v=new function(){function a(b){b=b.relatedTarget;var d;if(!(d=!b))d=this.contains?
this.contains(b):this.compareDocumentPosition(b)&16;d||c(this)}function b(a){c(this)}function c(a){setTimeout(function(){s.replace(a,r.get(a).options,!0)},10)}this.attach=function(c){void 0===c.onmouseenter?(e(c,"mouseover",a),e(c,"mouseout",a)):(e(c,"mouseenter",b),e(c,"mouseleave",b))}},w=[],z={},x={},A={engine:null,hover:!1,hoverables:{a:!0},printable:!0,selector:fabric.window.Sizzle||fabric.window.jQuery&&function(a){return jQuery(a)}||fabric.window.dojo&&dojo.query||fabric.window.$$&&function(a){return $$(a)}||
fabric.window.$&&function(a){return $(a)}||fabric.document.querySelectorAll&&function(a){return fabric.document.querySelectorAll(a)}||f,separate:"words",textShadow:"none"},B={words:/\s+/,characters:""};s.now=function(){t.ready();return s};s.refresh=function(){for(var a=w.splice(0,w.length),b=0,c=a.length;b<c;++b)s.replace.apply(null,a[b]);return s};s.registerEngine=function(a,b){if(!b)return s;z[a]=b;return s.set("engine",a)};s.registerFont=function(a){a=new b(a);var d=a.family;x[d]||(x[d]=new c);
x[d].add(a);return s.set("fontFamily",'"'+d+'"')};s.replace=function(a,b,c){b=g(A,b);if(!b.engine)return s;"string"==typeof b.textShadow&&b.textShadow&&(b.textShadow=q.textShadow(b.textShadow));c||w.push(arguments);if(a.nodeType||"string"==typeof a)a=[a];q.ready(function(){for(var c=0,d=a.length;c<d;++c){var e=a[c];"string"==typeof e?s.replace(b.selector(e),b,!0):m(e,b)}});return s};s.replaceElement=function(a,b){b=g(A,b);"string"==typeof b.textShadow&&b.textShadow&&(b.textShadow=q.textShadow(b.textShadow));
return m(a,b)};s.engines=z;s.fonts=x;s.getOptions=function(){return g(A)};s.set=function(a,b){A[a]=b;return s};return s}();
Cufon.registerEngine("canvas",function(){var b=Cufon.CSS.supports("display","inline-block"),c=!b&&("BackCompat"==fabric.document.compatMode||/frameset|transitional/i.test(fabric.document.doctype.publicId)),a=fabric.document.createElement("style");a.type="text/css";c=fabric.document.createTextNode(".cufon-canvas{text-indent:0}@media screen,projection{.cufon-canvas{display:inline;display:inline-block;position:relative;vertical-align:middle"+(c?"":";font-size:1px;line-height:1px")+"}.cufon-canvas .cufon-alt{display:-moz-inline-box;display:inline-block;width:0;height:0;overflow:hidden}"+
(b?".cufon-canvas canvas{position:relative}":".cufon-canvas canvas{position:absolute}")+"}@media print{.cufon-canvas{padding:0 !important}.cufon-canvas canvas{display:none}.cufon-canvas .cufon-alt{display:inline}}");try{a.appendChild(c)}catch(e){a.setAttribute("type","text/css"),a.styleSheet.cssText=c.data}fabric.document.getElementsByTagName("head")[0].appendChild(a);return function(a,c,e,h,m,s){function t(b){y.fillStyle=b||Cufon.textOptions.color||e.get("color");var c=b=0;"right"===h.textAlign?
y.translate(N[c],0):"center"===h.textAlign&&y.translate(N[c]/2,0);for(var f=0,m=K.length;f<m;++f)if("\n"===K[f]){c++;var r=-a.ascent-a.ascent/5*h.lineHeight;"right"===h.textAlign?(y.translate(-I,r),y.translate(N[c],0)):"center"===h.textAlign?(y.translate(-b-N[c-1]/2,r),y.translate(N[c]/2,0)):y.translate(-b,r);b=0}else{var u=a.glyphs[K[f]]||a.missingGlyph;if(u){r=Number(u.w||a.w)+v;L&&(y.save(),y.strokeStyle=y.fillStyle,y.lineWidth+=y.lineWidth,y.beginPath(),L.underline&&(y.moveTo(0,-a.face["underline-position"]+
0.5),y.lineTo(r,-a.face["underline-position"]+0.5)),L.overline&&(y.moveTo(0,a.ascent+0.5),y.lineTo(r,a.ascent+0.5)),L["line-through"]&&(y.moveTo(0,-a.descent+0.5),y.lineTo(r,-a.descent+0.5)),y.stroke(),y.restore());M&&(y.save(),y.transform(1,0,-0.25,1,0,0));y.beginPath();if(u.d)if(u.code)for(var q=u.code,u=y,s=0,t=q.length;s<t;++s){var x=q[s];u[x.m].apply(u,x.a)}else{var q=u,u="m"+u.d,s=y,x=t=0,w=[],z=/([mrvxe])([^a-z]*)/g,B=void 0,A=0;a:for(;B=z.exec(u);++A){var D=B[2].split(",");switch(B[1]){case "v":w[A]=
{m:"bezierCurveTo",a:[t+~~D[0],x+~~D[1],t+~~D[2],x+~~D[3],t+=~~D[4],x+=~~D[5]]};break;case "r":w[A]={m:"lineTo",a:[t+=~~D[0],x+=~~D[1]]};break;case "m":w[A]={m:"moveTo",a:[t=~~D[0],x=~~D[1]]};break;case "x":w[A]={m:"closePath",a:[]};break;case "e":break a}s[w[A].m].apply(s,w[A].a)}q.code=w}y.fill();h.strokeStyle&&(y.closePath(),y.save(),y.lineWidth=h.strokeWidth,y.strokeStyle=h.strokeStyle,y.stroke(),y.restore());M&&y.restore();y.translate(r,0);b+=r}}}var q=null===c,u=a.viewBox,r=e.getSize("fontSize",
a.baseSize),v=e.get("letterSpacing"),v="normal"==v?0:r.convertFrom(parseInt(v,10)),w=s=0,z=0,x=h.textShadow,A=[];Cufon.textOptions.shadowOffsets=[];Cufon.textOptions.shadows=null;if(x){Cufon.textOptions.shadows=x;for(var B=0,D=x.length;B<D;++B){var C=x[B],H=r.convertFrom(parseFloat(C.offX)),C=r.convertFrom(parseFloat(C.offY));A[B]=[H,C]}}for(var K=Cufon.CSS.textTransform(q?m.alt:c,e).split(""),I=0,C=null,H=0,P=1,Y=[],B=0,D=K.length;B<D;++B)if("\n"===K[B])P++,I>H&&(H=I),Y.push(I),I=0;else{var X=a.glyphs[K[B]]||
a.missingGlyph;X&&(I+=C=Number(X.w||a.w)+v)}Y.push(I);for(var I=Math.max(H,I),N=[],B=Y.length;B--;)N[B]=I-Y[B];if(null===C)return null;w+=u.width-C;z+=u.minX;q?(q=m,m=m.firstChild):(q=fabric.document.createElement("span"),q.className="cufon cufon-canvas",q.alt=c,m=fabric.document.createElement("canvas"),q.appendChild(m),h.printable&&(B=fabric.document.createElement("span"),B.className="cufon-alt",B.appendChild(fabric.document.createTextNode(c)),q.appendChild(B)));c=q.style;D=m.style||{};C=r.convert(u.height-
s+0);B=Math.ceil(C);C=B/C;m.width=Math.ceil(r.convert(I+w-z)*C);m.height=B;s+=u.minY;D.top=Math.round(r.convert(s-a.ascent))+"px";D.left=Math.round(r.convert(z))+"px";w=Math.ceil(r.convert(I*C));D=w+"px";C=r.convert(a.height);r=(h.lineHeight-1)*r.convert(-a.ascent/5)*(P-1);Cufon.textOptions.width=w;Cufon.textOptions.height=C*P+r;Cufon.textOptions.lines=P;Cufon.textOptions.totalLineHeight=r;b?(c.width=D,c.height=C+"px"):(c.paddingLeft=D,c.paddingBottom=C-1+"px");var y=Cufon.textOptions.context||m.getContext("2d"),
E=B/u.height;Cufon.textOptions.fontAscent=a.ascent*E;Cufon.textOptions.boundaries=null;u=Cufon.textOptions.shadowOffsets;for(B=A.length;B--;)u[B]=[A[B][0]*E,A[B][1]*E];y.save();y.scale(E,E);y.translate(-z-1/E*m.width/2+(Cufon.fonts[a.family].offsetLeft||0),-s-Cufon.textOptions.height/E/2+(Cufon.fonts[a.family].offsetTop||0));y.lineWidth=a.face["underline-thickness"];y.save();var L=Cufon.getTextDecoration(h),M="italic"===h.fontStyle;y.save();(function(){y.save();var b=0,c=0,e=[{left:0}];h.backgroundColor&&
(y.save(),y.fillStyle=h.backgroundColor,y.translate(0,a.ascent),y.fillRect(0,0,I+10,(-a.ascent+a.descent)*P),y.restore());"right"===h.textAlign?(y.translate(N[c],0),e[0].left=N[c]*E):"center"===h.textAlign&&(y.translate(N[c]/2,0),e[0].left=N[c]/2*E);for(var f=0,g=K.length;f<g;++f)if("\n"===K[f]){c++;var m=-a.ascent-a.ascent/5*h.lineHeight,r=e[e.length-1],u={left:0};r.width=b*E;r.height=(-a.ascent+a.descent)*E;"right"===h.textAlign?(y.translate(-I,m),y.translate(N[c],0),u.left=N[c]*E):"center"===h.textAlign?
(y.translate(-b-N[c-1]/2,m),y.translate(N[c]/2,0),u.left=N[c]/2*E):y.translate(-b,m);e.push(u);b=0}else if(m=a.glyphs[K[f]]||a.missingGlyph)m=Number(m.w||a.w)+v,h.textBackgroundColor&&(y.save(),y.fillStyle=h.textBackgroundColor,y.translate(0,a.ascent),y.fillRect(0,0,m+10,-a.ascent+a.descent),y.restore()),y.translate(m,0),b+=m,f==g-1&&(e[e.length-1].width=b*E,e[e.length-1].height=(-a.ascent+a.descent)*E);y.restore();Cufon.textOptions.boundaries=e})();if(x){B=0;for(D=x.length;B<D;++B)C=x[B],y.save(),
y.translate.apply(y,A[B]),t(C.color),y.restore()}t();y.restore();y.restore();y.restore();return q}}());
Cufon.registerEngine("vml",function(){function b(a,b){if(/px$/i.test(b))return parseFloat(b);var c=a.style.left,f=a.runtimeStyle.left;a.runtimeStyle.left=a.currentStyle.left;a.style.left=b;var g=a.style.pixelLeft;a.style.left=c;a.runtimeStyle.left=f;return g}if(fabric.document.namespaces){var c=fabric.document.createElement("canvas");if(!c||!c.getContext||!c.getContext.apply)if(null==fabric.document.namespaces.cvml&&fabric.document.namespaces.add("cvml","urn:schemas-microsoft-com:vml"),c=fabric.document.createElement("cvml:shape"),
c.style.behavior="url(#default#VML)",c.coordsize)return c=null,fabric.document.write('<style type="text/css">.cufon-vml-canvas{text-indent:0}@media screen{cvml\\:shape,cvml\\:shadow{behavior:url(#default#VML);display:block;antialias:true;position:absolute}.cufon-vml-canvas{position:absolute;text-align:left}.cufon-vml{display:inline-block;position:relative;vertical-align:middle}.cufon-vml .cufon-alt{position:absolute;left:-10000in;font-size:1px}a .cufon-vml{cursor:pointer}}@media print{.cufon-vml *{display:none}.cufon-vml .cufon-alt{display:inline}}</style>'),
function(a,c,d,f,g,h,m){var s=null===c;s&&(c=g.alt);var t=a.viewBox,q;if(!(q=d.computedFontSize)){q=Cufon.CSS.Size;var u;u=d.get("fontSize");u=b(h,/(?:em|ex|%)$/i.test(u)?"1em":u);q=d.computedFontSize=new q(u+"px",a.baseSize)}u=d.computedLSpacing;void 0==u&&(u=d.get("letterSpacing"),d.computedLSpacing=u="normal"==u?0:~~q.convertFrom(b(h,u)));if(s)h=g,g=g.firstChild;else{h=fabric.document.createElement("span");h.className="cufon cufon-vml";h.alt=c;g=fabric.document.createElement("span");g.className=
"cufon-vml-canvas";h.appendChild(g);if(f.printable){var r=fabric.document.createElement("span");r.className="cufon-alt";r.appendChild(fabric.document.createTextNode(c));h.appendChild(r)}m||h.appendChild(fabric.document.createElement("cvml:shape"))}m=h.style;var v=g.style,w=q.convert(t.height),r=Math.ceil(w),w=r/w,z=t.minX,x=t.minY;v.height=r;v.top=Math.round(q.convert(x-a.ascent));v.left=Math.round(q.convert(z));m.height=q.convert(a.height)+"px";Cufon.getTextDecoration(f);v=d.get("color");c=Cufon.CSS.textTransform(c,
d).split("");var A=d=0,B=null,D;f=f.textShadow;for(var C=0,H=0,K=c.length;C<K;++C)(D=a.glyphs[c[C]]||a.missingGlyph)&&(d+=B=~~(D.w||a.w)+u);if(null===B)return null;D=-z+d+(t.width-B);for(var C=q.convert(D*w),B=Math.round(C),I=D+","+t.height,P,Y="r"+I+"nsnf",C=0;C<K;++C)if(D=a.glyphs[c[C]]||a.missingGlyph){s?(t=g.childNodes[H],t.firstChild&&t.removeChild(t.firstChild)):(t=fabric.document.createElement("cvml:shape"),g.appendChild(t));t.stroked="f";t.coordsize=I;t.coordorigin=P=z-A+","+x;t.path=(D.d?
"m"+D.d+"xe":"")+"m"+P+Y;t.fillcolor=v;P=t.style;P.width=B;P.height=r;if(f){P=f[0];var X=f[1],N=Cufon.CSS.color(P.color),y,E=fabric.document.createElement("cvml:shadow");E.on="t";E.color=N.color;E.offset=P.offX+","+P.offY;X&&(y=Cufon.CSS.color(X.color),E.type="double",E.color2=y.color,E.offset2=X.offX+","+X.offY);E.opacity=N.opacity||y&&y.opacity||1;t.appendChild(E)}A+=~~(D.w||a.w)+u;++H}m.width=Math.max(Math.ceil(q.convert(d*w)),0);return h}}}());
Cufon.getTextDecoration=function(b){return{underline:"underline"===b.textDecoration,overline:"overline"===b.textDecoration,"line-through":"line-through"===b.textDecoration}};"undefined"!=typeof exports&&(exports.Cufon=Cufon);var JSON;JSON||(JSON={});
(function(){function b(a){return 10>a?"0"+a:a}function c(a){d.lastIndex=0;return d.test(a)?'"'+a.replace(d,function(a){var b=h[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function a(b,d){var e,h,r,v,w=f,z,x=d[b];x&&("object"===typeof x&&"function"===typeof x.toJSON)&&(x=x.toJSON(b));"function"===typeof m&&(x=m.call(d,b,x));switch(typeof x){case "string":return c(x);case "number":return isFinite(x)?String(x):"null";case "boolean":case "null":return String(x);
case "object":if(!x)return"null";f+=g;z=[];if("[object Array]"===Object.prototype.toString.apply(x)){v=x.length;for(e=0;e<v;e+=1)z[e]=a(e,x)||"null";r=0===z.length?"[]":f?"[\n"+f+z.join(",\n"+f)+"\n"+w+"]":"["+z.join(",")+"]";f=w;return r}if(m&&"object"===typeof m){v=m.length;for(e=0;e<v;e+=1)"string"===typeof m[e]&&(h=m[e],(r=a(h,x))&&z.push(c(h)+(f?": ":":")+r))}else for(h in x)Object.prototype.hasOwnProperty.call(x,h)&&(r=a(h,x))&&z.push(c(h)+(f?": ":":")+r);r=0===z.length?"{}":f?"{\n"+f+z.join(",\n"+
f)+"\n"+w+"}":"{"+z.join(",")+"}";f=w;return r}}"function"!==typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(a){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+b(this.getUTCMonth()+1)+"-"+b(this.getUTCDate())+"T"+b(this.getUTCHours())+":"+b(this.getUTCMinutes())+":"+b(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(a){return this.valueOf()});var e=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
d=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,f,g,h={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},m;"function"!==typeof JSON.stringify&&(JSON.stringify=function(b,c,d){var e;g=f="";if("number"===typeof d)for(e=0;e<d;e+=1)g+=" ";else"string"===typeof d&&(g=d);if((m=c)&&"function"!==typeof c&&("object"!==typeof c||"number"!==typeof c.length))throw Error("JSON.stringify");return a("",{"":b})});
"function"!==typeof JSON.parse&&(JSON.parse=function(a,b){function c(a,d){var e,f,g=a[d];if(g&&"object"===typeof g)for(e in g)Object.prototype.hasOwnProperty.call(g,e)&&(f=c(g,e),void 0!==f?g[e]=f:delete g[e]);return b.call(a,d,g)}var d;a=String(a);e.lastIndex=0;e.test(a)&&(a=a.replace(e,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return d=eval("("+a+")"),"function"===typeof b?c({"":d},""):d;throw new SyntaxError("JSON.parse");})})();fabric.log=function(){};fabric.warn=function(){};"undefined"!==typeof console&&("undefined"!==typeof console.log&&console.log.apply&&(fabric.log=function(){return console.log.apply(console,arguments)}),"undefined"!==typeof console.warn&&console.warn.apply&&(fabric.warn=function(){return console.warn.apply(console,arguments)}));
fabric.Observable={observe:function(b,c){this.__eventListeners||(this.__eventListeners={});if(1===arguments.length)for(var a in b)this.on(a,b[a]);else this.__eventListeners[b]||(this.__eventListeners[b]=[]),this.__eventListeners[b].push(c)},stopObserving:function(b,c){this.__eventListeners||(this.__eventListeners={});this.__eventListeners[b]&&(c?fabric.util.removeFromArray(this.__eventListeners[b],c):this.__eventListeners[b].length=0)},fire:function(b,c){this.__eventListeners||(this.__eventListeners=
{});var a=this.__eventListeners[b];if(a)for(var e=0,d=a.length;e<d;e++)a[e](c||{})}};fabric.Observable.on=fabric.Observable.observe;fabric.Observable.off=fabric.Observable.stopObserving;
(function(){var b=Math.sqrt,c=Math.atan2;fabric.util={};var a=Math.PI/180,e=fabric.window.requestAnimationFrame||fabric.window.webkitRequestAnimationFrame||fabric.window.mozRequestAnimationFrame||fabric.window.oRequestAnimationFrame||fabric.window.msRequestAnimationFrame||function(a){fabric.window.setTimeout(a,1E3/60)},d=function(){return e.apply(fabric.window,arguments)};fabric.util.removeFromArray=function(a,b){var c=a.indexOf(b);-1!==c&&a.splice(c,1);return a};fabric.util.degreesToRadians=function(b){return b*
a};fabric.util.radiansToDegrees=function(b){return b/a};fabric.util.rotatePoint=function(a,b,c){var d=Math.sin(c);c=Math.cos(c);a.subtractEquals(b);return(new fabric.Point(a.x*c-a.y*d,a.x*d+a.y*c)).addEquals(b)};fabric.util.toFixed=function(a,b){return parseFloat(Number(a).toFixed(b))};fabric.util.getRandomInt=function(a,b){return Math.floor(Math.random()*(b-a+1))+a};fabric.util.falseFunction=function(){return!1};fabric.util.animate=function(a){a||(a={});var b=+new Date,c=a.duration||500,e=b+c,s,
t=a.onChange||function(){},q=a.abort||function(){return!1},u=a.easing||function(a,b,c,d){return-c*Math.cos(a/d*(Math.PI/2))+c+b},r="startValue"in a?a.startValue:0,v="endValue"in a?a.endValue:100,w=a.byValue||v-r;a.onStart&&a.onStart();(function x(){s=+new Date;t(u(s>e?c:s-b,r,w,c));s>e||q()?a.onComplete&&a.onComplete():d(x)})()};fabric.util.requestAnimFrame=d;fabric.util.loadImage=function(a,b,c){if(a){var d=new Image;d.onload=function(){b&&b.call(c,d);d=d.onload=null};d.src=a}else b&&b.call(c,a)};
fabric.util.enlivenObjects=function(a,b){var c=[],d=0,e=a.length;a.forEach(function(a,f){if(a.type){var u=fabric[fabric.util.string.camelize(fabric.util.string.capitalize(a.type))];u.async?u.fromObject(a,function(a,u){u||(c[f]=a);++d===e&&b&&b(c)}):(c[f]=u.fromObject(a),++d===e&&b&&b(c))}})};fabric.util.groupSVGElements=function(a,b,c){var d;1<a.length?a.some(function(a){return"text"===a.type})?(d=new fabric.Group([],b),a.reverse().forEach(function(a){a.cx&&(a.left=a.cx);a.cy&&(a.top=a.cy);d.addWithUpdate(a)})):
d=new fabric.PathGroup(a,b):d=a[0];"undefined"!==typeof c&&d.setSourcePath(c);return d};fabric.util.populateWithProperties=function(a,b,c){if(c&&"[object Array]"===Object.prototype.toString.call(c))for(var d=0,e=c.length;d<e;d++)b[c[d]]=a[c[d]]};fabric.util.drawDashedLine=function(a,d,e,m,s,t){m-=d;var q=s-e;s=b(m*m+q*q);m=c(q,m);var q=t.length,u=0,r=!0;a.save();a.translate(d,e);a.moveTo(0,0);a.rotate(m);for(d=0;s>d;)d+=t[u++%q],d>s&&(d=s),a[r?"lineTo":"moveTo"](d,0),r=!r;a.restore()};fabric.util.createCanvasElement=
function(){var a=fabric.document.createElement("canvas");!a.getContext&&"undefined"!==typeof G_vmlCanvasManager&&G_vmlCanvasManager.initElement(a);return a}})();
(function(){var b=Array.prototype.slice;Array.prototype.indexOf||(Array.prototype.indexOf=function(b){if(void 0===this||null===this)throw new TypeError;var a=Object(this),e=a.length>>>0;if(0===e)return-1;var d=0;0<arguments.length&&(d=Number(arguments[1]),d!==d?d=0:0!==d&&(d!==1/0&&d!==-(1/0))&&(d=(0<d||-1)*Math.floor(Math.abs(d))));if(d>=e)return-1;for(d=0<=d?d:Math.max(e-Math.abs(d),0);d<e;d++)if(d in a&&a[d]===b)return d;return-1});Array.prototype.forEach||(Array.prototype.forEach=function(b,a){for(var e=
0,d=this.length>>>0;e<d;e++)e in this&&b.call(a,this[e],e,this)});Array.prototype.map||(Array.prototype.map=function(b,a){for(var e=[],d=0,f=this.length>>>0;d<f;d++)d in this&&(e[d]=b.call(a,this[d],d,this));return e});Array.prototype.every||(Array.prototype.every=function(b,a){for(var e=0,d=this.length>>>0;e<d;e++)if(e in this&&!b.call(a,this[e],e,this))return!1;return!0});Array.prototype.some||(Array.prototype.some=function(b,a){for(var e=0,d=this.length>>>0;e<d;e++)if(e in this&&b.call(a,this[e],
e,this))return!0;return!1});Array.prototype.filter||(Array.prototype.filter=function(b,a){for(var e=[],d,f=0,g=this.length>>>0;f<g;f++)f in this&&(d=this[f],b.call(a,d,f,this)&&e.push(d));return e});Array.prototype.reduce||(Array.prototype.reduce=function(b){var a=this.length>>>0,e=0,d;if(1<arguments.length)d=arguments[1];else{do{if(e in this){d=this[e++];break}if(++e>=a)throw new TypeError;}while(1)}for(;e<a;e++)e in this&&(d=b.call(null,d,this[e],e,this));return d});fabric.util.array={invoke:function(c,
a){for(var e=b.call(arguments,2),d=[],f=0,g=c.length;f<g;f++)d[f]=e.length?c[f][a].apply(c[f],e):c[f][a].call(c[f]);return d},min:function(b,a){if(b&&0!==b.length){var e=b.length-1,d=a?b[e][a]:b[e];if(a)for(;e--;)b[e][a]<d&&(d=b[e][a]);else for(;e--;)b[e]<d&&(d=b[e]);return d}},max:function(b,a){if(b&&0!==b.length){var e=b.length-1,d=a?b[e][a]:b[e];if(a)for(;e--;)b[e][a]>=d&&(d=b[e][a]);else for(;e--;)b[e]>=d&&(d=b[e]);return d}}}})();
(function(){function b(b,a){for(var e in a)b[e]=a[e];return b}fabric.util.object={extend:b,clone:function(c){return b({},c)}}})();
(function(){String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s\xA0]+/,"").replace(/[\s\xA0]+$/,"")});fabric.util.string={camelize:function(b){return b.replace(/-+(.)?/g,function(b,a){return a?a.toUpperCase():""})},capitalize:function(b){return b.charAt(0).toUpperCase()+b.slice(1).toLowerCase()},escapeXml:function(b){return b.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}}})();
(function(){var b=Array.prototype.slice,c=Function.prototype.apply,a=function(){};Function.prototype.bind||(Function.prototype.bind=function(e){var d=this,f=b.call(arguments,1),g;g=f.length?function(){return c.call(d,this instanceof a?this:e,f.concat(b.call(arguments)))}:function(){return c.call(d,this instanceof a?this:e,arguments)};a.prototype=this.prototype;g.prototype=new a;return g})})();
(function(){function b(){}function c(b){var c=this.constructor.superclass.prototype[b];return 1<arguments.length?c.apply(this,a.call(arguments,1)):c.call(this)}var a=Array.prototype.slice,e=function(){},d=function(){for(var a in{toString:1})if("toString"===a)return!1;return!0}(),f=function(a,b,c){for(var e in b)e in a.prototype&&"function"===typeof a.prototype[e]&&-1<(b[e]+"").indexOf("callSuper")?a.prototype[e]=function(a){return function(){var d=this.constructor.superclass;this.constructor.superclass=
c;var e=b[a].apply(this,arguments);this.constructor.superclass=d;if("initialize"!==a)return e}}(e):a.prototype[e]=b[e],d&&(b.toString!==Object.prototype.toString&&(a.prototype.toString=b.toString),b.valueOf!==Object.prototype.valueOf&&(a.prototype.valueOf=b.valueOf))};fabric.util.createClass=function(){function d(){this.initialize.apply(this,arguments)}var h=null,m=a.call(arguments,0);"function"===typeof m[0]&&(h=m.shift());d.superclass=h;d.subclasses=[];h&&(b.prototype=h.prototype,d.prototype=new b,
h.subclasses.push(d));for(var s=0,t=m.length;s<t;s++)f(d,m[s],h);d.prototype.initialize||(d.prototype.initialize=e);d.prototype.constructor=d;d.prototype.callSuper=c;return d}})();
(function(){function b(a){var b=Array.prototype.slice.call(arguments,1),c,d,e=b.length;for(d=0;d<e;d++)if(c=typeof a[b[d]],!/^(?:function|object|unknown)$/.test(c))return!1;return!0}function c(a,b){return function(c){b.call(d(a),c||fabric.window.event)}}function a(a,b){return function(c){if(s[a]&&s[a][b])for(var d=s[a][b],e=0,f=d.length;e<f;e++)d[e].call(this,c||fabric.window.event)}}var e=function(){var a=0;return function(b){return b.__uniqueID||(b.__uniqueID="uniqueID__"+a++)}}(),d,f;(function(){var a=
{};d=function(b){return a[b]};f=function(b,c){a[b]=c}})();var g=b(fabric.document.documentElement,"addEventListener","removeEventListener")&&b(fabric.window,"addEventListener","removeEventListener"),h=b(fabric.document.documentElement,"attachEvent","detachEvent")&&b(fabric.window,"attachEvent","detachEvent"),m={},s={};g?(g=function(a,b,c){a.addEventListener(b,c,!1)},h=function(a,b,c){a.removeEventListener(b,c,!1)}):h?(g=function(a,b,d){var g=e(a);f(g,a);m[g]||(m[g]={});m[g][b]||(m[g][b]=[]);d={handler:d,
wrappedHandler:c(g,d)};m[g][b].push(d);a.attachEvent("on"+b,d.wrappedHandler)},h=function(a,b,c){var d=e(a),f;if(m[d]&&m[d][b])for(var g=0,h=m[d][b].length;g<h;g++)if((f=m[d][b][g])&&f.handler===c)a.detachEvent("on"+b,f.wrappedHandler),m[d][b][g]=null}):(g=function(b,c,d){var f=e(b);s[f]||(s[f]={});if(!s[f][c]){s[f][c]=[];var g=b["on"+c];g&&s[f][c].push(g);b["on"+c]=a(f,c)}s[f][c].push(d)},h=function(a,b,c){a=e(a);if(s[a]&&s[a][b]){b=s[a][b];a=0;for(var d=b.length;a<d;a++)b[a]===c&&b.splice(a,1)}});
fabric.util.addListener=g;fabric.util.removeListener=h;var t=function(a){return"unknown"!==typeof a.clientX?a.clientX:0},q=function(a){return"unknown"!==typeof a.clientY?a.clientY:0};fabric.isTouchSupported&&(t=function(a){return a.touches&&a.touches[0]?a.touches[0].pageX-(a.touches[0].pageX-a.touches[0].clientX)||a.clientX:a.clientX},q=function(a){return a.touches&&a.touches[0]?a.touches[0].pageY-(a.touches[0].pageY-a.touches[0].clientY)||a.clientY:a.clientY});fabric.util.getPointer=function(a,b){a||
(a=fabric.window.event);for(var c=a.target||("unknown"!==typeof a.srcElement?a.srcElement:null),d=fabric.document.body||{scrollLeft:0,scrollTop:0},e=fabric.document.documentElement,f=c,g=0,h=0,m;c&&c.parentNode&&!m;)c=c.parentNode,c!==fabric.document&&"fixed"===fabric.util.getElementPosition(c)&&(m=c),c!==fabric.document&&f!==b&&"absolute"===fabric.util.getElementPosition(c)?h=g=0:c===fabric.document&&f!==b?(g=d.scrollLeft||e.scrollLeft||0,h=d.scrollTop||e.scrollTop||0):(g+=c.scrollLeft||0,h+=c.scrollTop||
0);return{x:t(a)+g,y:q(a)+h}};fabric.util.object.extend(fabric.util,fabric.Observable)})();
(function(){var b=fabric.document.createElement("div"),c="string"===typeof b.style.filter,a=/alpha\s*\(\s*opacity\s*=\s*([^\)]+)\)/,e=function(a){return a};"string"===typeof b.style.opacity?e=function(a,b){a.style.opacity=b;return a}:c&&(e=function(b,c){var e=b.style;b.currentStyle&&!b.currentStyle.hasLayout&&(e.zoom=1);a.test(e.filter)?e.filter=e.filter.replace(a,0.9999<=c?"":"alpha(opacity="+100*c+")"):e.filter+=" alpha(opacity="+100*c+")";return b});fabric.util.setStyle=function(a,b){var c=a.style;
if(!c)return a;if("string"===typeof b)return a.style.cssText+=";"+b,-1<b.indexOf("opacity")?e(a,b.match(/opacity:\s*(\d?\.?\d*)/)[1]):a;for(var h in b)"opacity"===h?e(a,b[h]):c["float"===h||"cssFloat"===h?"undefined"===typeof c.styleFloat?"cssFloat":"styleFloat":h]=b[h];return a}})();
(function(){function b(a,b){var c=fabric.document.createElement(a),d;for(d in b)"class"===d?c.className=b[d]:"for"===d?c.htmlFor=b[d]:c.setAttribute(d,b[d]);return c}var c=Array.prototype.slice,a=function(a){return c.call(a,0)},e;try{e=a(fabric.document.childNodes)instanceof Array}catch(d){}e||(a=function(a){for(var b=Array(a.length),c=a.length;c--;)b[c]=a[c];return b});e=fabric.document.defaultView&&fabric.document.defaultView.getComputedStyle?function(a){return fabric.document.defaultView.getComputedStyle(a,
null).position}:function(a){var b=a.style.position;!b&&a.currentStyle&&(b=a.currentStyle.position);return b};(function(){var a=fabric.document.documentElement.style,b="userSelect"in a?"userSelect":"MozUserSelect"in a?"MozUserSelect":"WebkitUserSelect"in a?"WebkitUserSelect":"KhtmlUserSelect"in a?"KhtmlUserSelect":"";fabric.util.makeElementUnselectable=function(a){"undefined"!==typeof a.onselectstart&&(a.onselectstart=fabric.util.falseFunction);b?a.style[b]="none":"string"===typeof a.unselectable&&
(a.unselectable="on");return a};fabric.util.makeElementSelectable=function(a){"undefined"!==typeof a.onselectstart&&(a.onselectstart=null);b?a.style[b]="":"string"===typeof a.unselectable&&(a.unselectable="");return a}})();(function(){fabric.util.getScript=function(a,b){var c=fabric.document.getElementsByTagName("head")[0],d=fabric.document.createElement("script"),e=!0;d.type="text/javascript";d.setAttribute("runat","server");d.onload=d.onreadystatechange=function(a){e&&!("string"===typeof this.readyState&&
"loaded"!==this.readyState&&"complete"!==this.readyState)&&(e=!1,b(a||fabric.window.event),d=d.onload=d.onreadystatechange=null)};d.src=a;c.appendChild(d)}})();fabric.util.getById=function(a){return"string"===typeof a?fabric.document.getElementById(a):a};fabric.util.toArray=a;fabric.util.makeElement=b;fabric.util.addClass=function(a,b){-1===(" "+a.className+" ").indexOf(" "+b+" ")&&(a.className+=(a.className?" ":"")+b)};fabric.util.wrapElement=function(a,c,d){"string"===typeof c&&(c=b(c,d));a.parentNode&&
a.parentNode.replaceChild(c,a);c.appendChild(a);return c};fabric.util.getElementOffset=function(a){var b=0,c=0;do b+=a.offsetTop||0,c+=a.offsetLeft||0,a=a.offsetParent;while(a);return{left:c,top:b}};fabric.util.getElementPosition=e})();
(function(){function b(){}var c=function(){for(var a=[function(){return new ActiveXObject("Microsoft.XMLHTTP")},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml2.XMLHTTP.3.0")},function(){return new XMLHttpRequest}],b=a.length;b--;)try{if(a[b]())return a[b]}catch(c){}}();fabric.util.request=function(a,e){e||(e={});var d=e.method?e.method.toUpperCase():"GET",f=e.onComplete||function(){},g=c(),h;g.onreadystatechange=function(){4===g.readyState&&(f(g),
g.onreadystatechange=b)};"GET"===d&&(h=null,"string"===typeof e.parameters&&(a=a+(/\?/.test(a)?"&":"?")+e.parameters));g.open(d,a,!0);("POST"===d||"PUT"===d)&&g.setRequestHeader("Content-Type","application/x-www-form-urlencoded");g.send(h);return g}})();
(function(){function b(a,b,d,f){return d-c(f-a,0,d,f)+b}function c(a,b,c,f){return(a/=f)<1/2.75?c*7.5625*a*a+b:a<2/2.75?c*(7.5625*(a-=1.5/2.75)*a+0.75)+b:a<2.5/2.75?c*(7.5625*(a-=2.25/2.75)*a+0.9375)+b:c*(7.5625*(a-=2.625/2.75)*a+0.984375)+b}fabric.util.ease={easeInQuad:function(a,b,c,f){return c*(a/=f)*a+b},easeOutQuad:function(a,b,c,f){return-c*(a/=f)*(a-2)+b},easeInOutQuad:function(a,b,c,f){a/=f/2;return 1>a?c/2*a*a+b:-c/2*(--a*(a-2)-1)+b},easeInCubic:function(a,b,c,f){return c*(a/=f)*a*a+b},easeOutCubic:function(a,
b,c,f){return c*((a=a/f-1)*a*a+1)+b},easeInOutCubic:function(a,b,c,f){a/=f/2;return 1>a?c/2*a*a*a+b:c/2*((a-=2)*a*a+2)+b},easeInQuart:function(a,b,c,f){return c*(a/=f)*a*a*a+b},easeOutQuart:function(a,b,c,f){return-c*((a=a/f-1)*a*a*a-1)+b},easeInOutQuart:function(a,b,c,f){a/=f/2;return 1>a?c/2*a*a*a*a+b:-c/2*((a-=2)*a*a*a-2)+b},easeInQuint:function(a,b,c,f){return c*(a/=f)*a*a*a*a+b},easeOutQuint:function(a,b,c,f){return c*((a=a/f-1)*a*a*a*a+1)+b},easeInOutQuint:function(a,b,c,f){a/=f/2;return 1>
a?c/2*a*a*a*a*a+b:c/2*((a-=2)*a*a*a*a+2)+b},easeInSine:function(a,b,c,f){return-c*Math.cos(a/f*(Math.PI/2))+c+b},easeOutSine:function(a,b,c,f){return c*Math.sin(a/f*(Math.PI/2))+b},easeInOutSine:function(a,b,c,f){return-c/2*(Math.cos(Math.PI*a/f)-1)+b},easeInExpo:function(a,b,c,f){return 0===a?b:c*Math.pow(2,10*(a/f-1))+b},easeOutExpo:function(a,b,c,f){return a===f?b+c:c*(-Math.pow(2,-10*a/f)+1)+b},easeInOutExpo:function(a,b,c,f){if(0===a)return b;if(a===f)return b+c;a/=f/2;return 1>a?c/2*Math.pow(2,
10*(a-1))+b:c/2*(-Math.pow(2,-10*--a)+2)+b},easeInCirc:function(a,b,c,f){return-c*(Math.sqrt(1-(a/=f)*a)-1)+b},easeOutCirc:function(a,b,c,f){return c*Math.sqrt(1-(a=a/f-1)*a)+b},easeInOutCirc:function(a,b,c,f){a/=f/2;return 1>a?-c/2*(Math.sqrt(1-a*a)-1)+b:c/2*(Math.sqrt(1-(a-=2)*a)+1)+b},easeInElastic:function(a,b,c,f){var g=1.70158,h=0,m=c;if(0===a)return b;a/=f;if(1===a)return b+c;h||(h=0.3*f);m<Math.abs(c)?(m=c,g=h/4):g=h/(2*Math.PI)*Math.asin(c/m);return-(m*Math.pow(2,10*(a-=1))*Math.sin((a*f-
g)*2*Math.PI/h))+b},easeOutElastic:function(a,b,c,f){var g=1.70158,h=0,m=c;if(0===a)return b;a/=f;if(1===a)return b+c;h||(h=0.3*f);m<Math.abs(c)?(m=c,g=h/4):g=h/(2*Math.PI)*Math.asin(c/m);return m*Math.pow(2,-10*a)*Math.sin((a*f-g)*2*Math.PI/h)+c+b},easeInOutElastic:function(a,b,c,f){var g=1.70158,h=0,m=c;if(0===a)return b;a/=f/2;if(2===a)return b+c;h||(h=f*0.3*1.5);m<Math.abs(c)?(m=c,g=h/4):g=h/(2*Math.PI)*Math.asin(c/m);return 1>a?-0.5*m*Math.pow(2,10*(a-=1))*Math.sin((a*f-g)*2*Math.PI/h)+b:0.5*
m*Math.pow(2,-10*(a-=1))*Math.sin((a*f-g)*2*Math.PI/h)+c+b},easeInBack:function(a,b,c,f,g){void 0===g&&(g=1.70158);return c*(a/=f)*a*((g+1)*a-g)+b},easeOutBack:function(a,b,c,f,g){void 0===g&&(g=1.70158);return c*((a=a/f-1)*a*((g+1)*a+g)+1)+b},easeInOutBack:function(a,b,c,f,g){void 0===g&&(g=1.70158);a/=f/2;return 1>a?c/2*a*a*(((g*=1.525)+1)*a-g)+b:c/2*((a-=2)*a*(((g*=1.525)+1)*a+g)+2)+b},easeInBounce:b,easeOutBounce:c,easeInOutBounce:function(a,e,d,f){return a<f/2?0.5*b(2*a,0,d,f)+e:0.5*c(2*a-f,
0,d,f)+0.5*d+e}}})();
(function(b){function c(a){return a in t?t[a]:a}function a(a){for(var b=a.length;b--;){var c=a[b].get("fill");/^url\(/.test(c)&&(c=c.slice(5,c.length-1),g.gradientDefs[c]&&a[b].set("fill",g.Gradient.fromElement(g.gradientDefs[c],a[b])))}}function e(a){a=a.getElementsByTagName("style");for(var b={},c,d=0,e=a.length;d<e;d++)c=a[0].textContent,c=c.replace(/\/\*[\s\S]*?\*\//g,""),c=c.match(/[^{]*\{[\s\S]*?\}/g),c=c.map(function(a){return a.trim()}),c.forEach(function(a){var c=a.match(/([\s\S]*?)\s*\{([^}]*)\}/);a=
c[1];c=c[2].trim().replace(/;$/,"").split(/\s*;\s*/);b[a]||(b[a]={});for(var d=0,e=c.length;d<e;d++){var f=c[d].split(/\s*:\s*/);b[a][f[0]]=f[1]}});return b}function d(a){var b=a.nodeName,c=a.getAttribute("class");a=a.getAttribute("id");var d={},e;for(e in g.cssRules)if(c&&RegExp("^\\."+c).test(e)||a&&RegExp("^#"+a).test(e)||RegExp("^"+b).test(e))for(var f in g.cssRules[e])d[f]=g.cssRules[e][f];return d}function f(a){var b=a.objects;a=a.options;b=b.map(function(a){return g[m(a.type)].fromObject(a)});
return{objects:b,options:a}}var g=b.fabric||(b.fabric={}),h=g.util.object.extend,m=g.util.string.capitalize,s=g.util.object.clone,t={cx:"left",x:"left",cy:"top",y:"top",r:"radius","fill-opacity":"opacity","fill-rule":"fillRule","stroke-width":"strokeWidth",transform:"transformMatrix","text-decoration":"textDecoration","font-size":"fontSize","font-weight":"fontWeight","font-style":"fontStyle","font-family":"fontFamily"};g.parseTransformAttribute=function(){function a(b,c){var d=c[0];b[0]=Math.cos(d);
b[1]=Math.sin(d);b[2]=-Math.sin(d);b[3]=Math.cos(d)}function b(a,c){var d=2===c.length?c[1]:c[0];a[0]=c[0];a[3]=d}function c(a,b){a[4]=b[0];2===b.length&&(a[5]=b[1])}var d=[1,0,0,1,0,0],e=RegExp("^\\s*(?:(?:(?:(?:(matrix)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\))|(?:(translate)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(scale)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(rotate)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(skewX)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\))|(?:(skewY)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\)))(?:(?:\\s+,?\\s*|,\\s*)(?:(?:(matrix)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\))|(?:(translate)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(scale)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(rotate)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(skewX)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\))|(?:(skewY)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\))))*)?)\\s*$"),
f=RegExp("(?:(?:(matrix)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\))|(?:(translate)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(scale)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(rotate)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(skewX)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\))|(?:(skewY)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\)))");
return function(g){var h=d.concat();if(!g||g&&!e.test(g))return h;g.replace(f,function(d){var e=RegExp("(?:(?:(matrix)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\))|(?:(translate)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(scale)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(rotate)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))(?:\\s+,?\\s*|,\\s*)((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)))?\\s*\\))|(?:(skewX)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\))|(?:(skewY)\\s*\\(\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?))\\s*\\)))").exec(d).filter(function(a){return""!==
a&&null!=a});d=e[1];e=e.slice(2).map(parseFloat);switch(d){case "translate":c(h,e);break;case "rotate":a(h,e);break;case "scale":b(h,e);break;case "skewX":h[2]=e[0];break;case "skewY":h[1]=e[0];break;case "matrix":h=e}});return h}}();g.parseSVGDocument=function(){var a=/^(path|circle|polygon|polyline|ellipse|rect|line|image|text)$/,b=RegExp("^\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)+)\\s*,?\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)+)\\s*,?\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)+)\\s*,?\\s*((?:[-+]?\\d+(?:\\.\\d+)?(?:e[-+]?\\d+)?)+)\\s*$");
return function(c,d,f){if(c){var h=new Date,m=g.util.toArray(c.getElementsByTagName("*"));if(0===m.length){for(var m=c.selectNodes("//*[name(.)!='svg']"),q=[],t=0,C=m.length;t<C;t++)q[t]=m[t];m=q}if((m=m.filter(function(b){var c;if(c=a.test(b.tagName)){a:{for(c=/^(?:pattern|defs)$/;b&&(b=b.parentNode);)if(c.test(b.nodeName)){b=!0;break a}b=!1}c=!b}return c}))&&(!m||m.length)){var q=c.getAttribute("viewBox"),t=c.getAttribute("width"),C=c.getAttribute("height"),H=null,K=null;if(q&&(q=q.match(b)))parseInt(q[1],
10),parseInt(q[2],10),H=parseInt(q[3],10),K=parseInt(q[4],10);var H=t?parseFloat(t):H,K=C?parseFloat(C):K,I={width:H,height:K};g.gradientDefs=g.getGradientDefs(c);g.cssRules=e(c);g.parseElements(m,function(a){g.documentParsingTime=new Date-h;d&&d(a,I)},s(I),f)}}}}();var q={has:function(a,b){b(!1)},get:function(){},set:function(){}};h(g,{parseAttributes:function(a,b){if(a){var e,f,m={};a.parentNode&&/^g$/i.test(a.parentNode.nodeName)&&(m=g.parseAttributes(a.parentNode,b));var q=b.reduce(function(b,
d){e=a.getAttribute(d);f=parseFloat(e);if(e){if(("fill"===d||"stroke"===d)&&"none"===e)e="";"fill-rule"===d&&(e="evenodd"===e?"destination-over":e);"transform"===d&&(e=g.parseTransformAttribute(e));d=c(d);b[d]=isNaN(f)?e:f}return b},{}),q=h(q,h(d(a),g.parseStyleAttribute(a)));return h(m,q)}},parseElements:function(b,c,d,e){function f(){0===--q&&(h=h.filter(function(a){return null!=a}),a(h),c(h))}for(var h=Array(b.length),q=b.length,s=0,t,C=b.length;s<C;s++){t=b[s];var H=g[m(t.tagName)];if(H&&H.fromElement)try{if(H.async)H.fromElement(t,
function(a,b){return function(c){e&&e(b,c);h.splice(a,0,c);f()}}(s),d);else{var K=H.fromElement(t,d);e&&e(t,K);h.splice(s,0,K);f()}}catch(I){g.log(I)}else f()}},parseStyleAttribute:function(a){var b={};a=a.getAttribute("style");if(!a)return b;if("string"===typeof a)a=a.replace(/;$/,"").split(";").forEach(function(a){a=a.split(":");var d=a[1].trim(),e=parseFloat(d);b[c(a[0].trim().toLowerCase())]=isNaN(e)?d:e});else for(var d in a)if("undefined"!==typeof a[d]){var e=parseFloat(a[d]);b[c(d.toLowerCase())]=
isNaN(e)?a[d]:e}return b},parsePointsAttribute:function(a){if(!a)return null;a=a.trim();var b=-1<a.indexOf(",");a=a.split(/\s+/);var c=[],d;if(b){b=0;for(d=a.length;b<d;b++){var e=a[b].split(",");c.push({x:parseFloat(e[0]),y:parseFloat(e[1])})}}else{b=0;for(d=a.length;b<d;b+=2)c.push({x:parseFloat(a[b]),y:parseFloat(a[b+1])})}return c},getCSSRules:e,loadSVGFromURL:function(a,b,c){function d(e){var f=e.responseXML;!f.documentElement&&(g.window.ActiveXObject&&e.responseText)&&(f=new ActiveXObject("Microsoft.XMLDOM"),
f.async="false",f.loadXML(e.responseText.replace(/<!DOCTYPE[\s\S]*?(\[[\s\S]*\])*?>/i,"")));f.documentElement&&g.parseSVGDocument(f.documentElement,function(c,d){q.set(a,{objects:g.util.array.invoke(c,"toObject"),options:d});b(c,d)},c)}a=a.replace(/^\n\s*/,"").trim();q.has(a,function(c){c?q.get(a,function(a){a=f(a);b(a.objects,a.options)}):new g.util.request(a,{method:"get",onComplete:d})})},loadSVGFromString:function(a,b,c){a=a.trim();var d;if("undefined"!==typeof DOMParser){var e=new DOMParser;
e&&e.parseFromString&&(d=e.parseFromString(a,"text/xml"))}else g.window.ActiveXObject&&(d=new ActiveXObject("Microsoft.XMLDOM"),d.async="false",d.loadXML(a.replace(/<!DOCTYPE[\s\S]*?(\[[\s\S]*\])*?>/i,"")));g.parseSVGDocument(d.documentElement,function(a,c){b(a,c)},c)},createSVGFontFacesMarkup:function(a){for(var b="",c=0,d=a.length;c<d;c++)"text"===a[c].type&&a[c].path&&(b+=["@font-face {font-family: ",a[c].fontFamily,"; src: url('",a[c].path,"')}"].join(""));b&&(b=['<defs><style type="text/css"><![CDATA[',
b,"]]\x3e</style></defs>"].join(""));return b}})})("undefined"!==typeof exports?exports:this);
(function(){function b(b,a){for(var e in a){if("string"===typeof a[e]&&/^\d+%$/.test(a[e])){var d=parseFloat(a[e],10);if("x1"===e||"x2"===e)a[e]=fabric.util.toFixed(b.width*d/100,2);else if("y1"===e||"y2"===e)a[e]=fabric.util.toFixed(b.height*d/100,2)}if("x1"===e||"x2"===e)a[e]-=fabric.util.toFixed(b.width/2,2);else if("y1"===e||"y2"===e)a[e]-=fabric.util.toFixed(b.height/2,2)}}fabric.Gradient=fabric.util.createClass({initialize:function(b){b||(b={});this.x1=b.x1||0;this.y1=b.y1||0;this.x2=b.x2||
0;this.y2=b.y2||0;this.colorStops=b.colorStops},toObject:function(){return{x1:this.x1,x2:this.x2,y1:this.y1,y2:this.y2,colorStops:this.colorStops}},toLive:function(b){b=b.createLinearGradient(this.x1,this.y1,this.x2||b.canvas.width,this.y2);for(var a in this.colorStops){var e=this.colorStops[a];b.addColorStop(parseFloat(a),e)}return b}});fabric.util.object.extend(fabric.Gradient,{fromElement:function(c,a){for(var e=c.getElementsByTagName("stop"),d,f={},g={x1:c.getAttribute("x1")||0,y1:c.getAttribute("y1")||
0,x2:c.getAttribute("x2")||"100%",y2:c.getAttribute("y2")||0},h=e.length;h--;){c=e[h];d=c.getAttribute("offset");d=parseFloat(d)/(/%$/.test(d)?100:1);var m=f,s;a:{if(s=c.getAttribute("style")){s=s.split(/\s*;\s*/);""===s[s.length-1]&&s.pop();for(var t=s.length;t--;){var q=s[t].split(/\s*:\s*/),u=q[0].trim(),q=q[1].trim();if("stop-color"===u){s=q;break a}}}s=void 0}m[d]=s||c.getAttribute("stop-color")}b(a,g);return new fabric.Gradient({x1:g.x1,y1:g.y1,x2:g.x2,y2:g.y2,colorStops:f})},forObject:function(c,
a){a||(a={});b(c,a);return new fabric.Gradient(a)}});fabric.getGradientDefs=function(b){var a=b.getElementsByTagName("linearGradient");b=b.getElementsByTagName("radialGradient");var e,d,f={};for(d=a.length;d--;)e=a[d],f[e.getAttribute("id")]=e;for(d=b.length;d--;)e=b[d],f[e.getAttribute("id")]=e;return f}})();
fabric.Pattern=fabric.util.createClass({repeat:"repeat",initialize:function(b){b||(b={});b.source&&(this.source="string"===typeof b.source?new Function(b.source):b.source);b.repeat&&(this.repeat=b.repeat)},toObject:function(){var b;"function"===typeof this.source?b=String(this.source).match(/function\s+\w*\s*\(.*\)\s+\{([\s\S]*)\}/)[1]:"string"===typeof this.source.src&&(b=this.source.src);return{source:b,repeat:this.repeat}},toLive:function(b){var c="function"===typeof this.source?this.source():
this.source;return b.createPattern(c,this.repeat)}});fabric.Shadow=fabric.util.createClass({color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,initialize:function(b){for(var c in b)this[c]=b[c]},toObject:function(){return{color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY}},toSVG:function(){}});
(function(b){function c(a,b){0<arguments.length&&this.init(a,b)}b=b.fabric||(b.fabric={});b.Point?b.warn("fabric.Point is already defined"):(b.Point=c,c.prototype={constructor:c,init:function(a,b){this.x=a;this.y=b},add:function(a){return new c(this.x+a.x,this.y+a.y)},addEquals:function(a){this.x+=a.x;this.y+=a.y;return this},scalarAdd:function(a){return new c(this.x+a,this.y+a)},scalarAddEquals:function(a){this.x+=a;this.y+=a;return this},subtract:function(a){return new c(this.x-a.x,this.y-a.y)},
subtractEquals:function(a){this.x-=a.x;this.y-=a.y;return this},scalarSubtract:function(a){return new c(this.x-a,this.y-a)},scalarSubtractEquals:function(a){this.x-=a;this.y-=a;return this},multiply:function(a){return new c(this.x*a,this.y*a)},multiplyEquals:function(a){this.x*=a;this.y*=a;return this},divide:function(a){return new c(this.x/a,this.y/a)},divideEquals:function(a){this.x/=a;this.y/=a;return this},eq:function(a){return this.x===a.x&&this.y===a.y},lt:function(a){return this.x<a.x&&this.y<
a.y},lte:function(a){return this.x<=a.x&&this.y<=a.y},gt:function(a){return this.x>a.x&&this.y>a.y},gte:function(a){return this.x>=a.x&&this.y>=a.y},lerp:function(a,b){return new c(this.x+(a.x-this.x)*b,this.y+(a.y-this.y)*b)},distanceFrom:function(a){var b=this.x-a.x;a=this.y-a.y;return Math.sqrt(b*b+a*a)},midPointFrom:function(a){return new c(this.x+(a.x-this.x)/2,this.y+(a.y-this.y)/2)},min:function(a){return new c(Math.min(this.x,a.x),Math.min(this.y,a.y))},max:function(a){return new c(Math.max(this.x,
a.x),Math.max(this.y,a.y))},toString:function(){return this.x+","+this.y},setXY:function(a,b){this.x=a;this.y=b},setFromPoint:function(a){this.x=a.x;this.y=a.y},swap:function(a){var b=this.x,c=this.y;this.x=a.x;this.y=a.y;a.x=b;a.y=c}})})("undefined"!==typeof exports?exports:this);
(function(b){function c(a){0<arguments.length&&this.init(a)}var a=b.fabric||(b.fabric={});a.Intersection?a.warn("fabric.Intersection is already defined"):(a.Intersection=c,a.Intersection.prototype={init:function(a){this.status=a;this.points=[]},appendPoint:function(a){this.points.push(a)},appendPoints:function(a){this.points=this.points.concat(a)}},a.Intersection.intersectLineLine=function(b,d,f,g){var h,m=(g.x-f.x)*(b.y-f.y)-(g.y-f.y)*(b.x-f.x);h=(d.x-b.x)*(b.y-f.y)-(d.y-b.y)*(b.x-f.x);f=(g.y-f.y)*
(d.x-b.x)-(g.x-f.x)*(d.y-b.y);0!==f?(m/=f,h/=f,0<=m&&1>=m&&0<=h&&1>=h?(h=new c("Intersection"),h.points.push(new a.Point(b.x+m*(d.x-b.x),b.y+m*(d.y-b.y)))):h=new c("No Intersection")):h=0===m||0===h?new c("Coincident"):new c("Parallel");return h},a.Intersection.intersectLinePolygon=function(a,b,f){for(var g=new c("No Intersection"),h=f.length,m=0;m<h;m++){var s=c.intersectLineLine(a,b,f[m],f[(m+1)%h]);g.appendPoints(s.points)}0<g.points.length&&(g.status="Intersection");return g},a.Intersection.intersectPolygonPolygon=
function(a,b){for(var f=new c("No Intersection"),g=a.length,h=0;h<g;h++){var m=c.intersectLinePolygon(a[h],a[(h+1)%g],b);f.appendPoints(m.points)}0<f.points.length&&(f.status="Intersection");return f},a.Intersection.intersectPolygonRectangle=function(b,d,f){var g=d.min(f),h=d.max(f);f=new a.Point(h.x,g.y);var m=new a.Point(g.x,h.y);d=c.intersectLinePolygon(g,f,b);f=c.intersectLinePolygon(f,h,b);h=c.intersectLinePolygon(h,m,b);b=c.intersectLinePolygon(m,g,b);g=new c("No Intersection");g.appendPoints(d.points);
g.appendPoints(f.points);g.appendPoints(h.points);g.appendPoints(b.points);0<g.points.length&&(g.status="Intersection");return g})})("undefined"!==typeof exports?exports:this);
(function(b){function c(a){a?this._tryParsingColor(a):this.setSource([0,0,0,1])}b=b.fabric||(b.fabric={});b.Color?b.warn("fabric.Color is already defined."):(b.Color=c,b.Color.prototype={_tryParsingColor:function(a){var b=c.sourceFromHex(a);b||(b=c.sourceFromRgb(a));b&&this.setSource(b)},getSource:function(){return this._source},setSource:function(a){this._source=a},toRgb:function(){var a=this.getSource();return"rgb("+a[0]+","+a[1]+","+a[2]+")"},toRgba:function(){var a=this.getSource();return"rgba("+
a[0]+","+a[1]+","+a[2]+","+a[3]+")"},toHex:function(){var a=this.getSource(),b=a[0].toString(16),b=1===b.length?"0"+b:b,c=a[1].toString(16),c=1===c.length?"0"+c:c,a=a[2].toString(16),a=1===a.length?"0"+a:a;return b.toUpperCase()+c.toUpperCase()+a.toUpperCase()},getAlpha:function(){return this.getSource()[3]},setAlpha:function(a){var b=this.getSource();b[3]=a;this.setSource(b);return this},toGrayscale:function(){var a=this.getSource(),b=parseInt((0.3*a[0]+0.59*a[1]+0.11*a[2]).toFixed(0),10);this.setSource([b,
b,b,a[3]]);return this},toBlackWhite:function(a){var b=this.getSource(),c=(0.3*b[0]+0.59*b[1]+0.11*b[2]).toFixed(0),b=b[3],c=Number(c)<Number(a||127)?0:255;this.setSource([c,c,c,b]);return this},overlayWith:function(a){a instanceof c||(a=new c(a));var b=[],d=this.getAlpha(),f=this.getSource();a=a.getSource();for(var g=0;3>g;g++)b.push(Math.round(0.5*f[g]+0.5*a[g]));b[3]=d;this.setSource(b);return this}},b.Color.reRGBa=/^rgba?\((\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})(?:\s*,\s*(\d+(?:\.\d+)?))?\)$/,
b.Color.reHex=/^#?([0-9a-f]{6}|[0-9a-f]{3})$/i,b.Color.fromRgb=function(a){return c.fromSource(c.sourceFromRgb(a))},b.Color.sourceFromRgb=function(a){if(a=a.match(c.reRGBa))return[parseInt(a[1],10),parseInt(a[2],10),parseInt(a[3],10),a[4]?parseFloat(a[4]):1]},b.Color.fromRgba=c.fromRgb,b.Color.fromHex=function(a){return c.fromSource(c.sourceFromHex(a))},b.Color.sourceFromHex=function(a){if(a.match(c.reHex)){var b=a.slice(a.indexOf("#")+1),d=3===b.length;a=d?b.charAt(0)+b.charAt(0):b.substring(0,2);
var f=d?b.charAt(1)+b.charAt(1):b.substring(2,4),b=d?b.charAt(2)+b.charAt(2):b.substring(4,6);return[parseInt(a,16),parseInt(f,16),parseInt(b,16),1]}},b.Color.fromSource=function(a){var b=new c;b.setSource(a);return b})})("undefined"!==typeof exports?exports:this);
(function(){if(fabric.StaticCanvas)fabric.warn("fabric.StaticCanvas is already defined.");else{var b=fabric.util.object.extend,c=fabric.util.getElementOffset,a=fabric.util.removeFromArray,e=fabric.util.removeListener,d=Error("Could not initialize `canvas` element");fabric.StaticCanvas=function(a,b){b||(b={});this._initStatic(a,b);fabric.StaticCanvas.activeInstance=this};b(fabric.StaticCanvas.prototype,fabric.Observable);b(fabric.StaticCanvas.prototype,{backgroundColor:"",backgroundImage:"",backgroundImageOpacity:1,
backgroundImageStretch:!0,overlayImage:"",overlayImageLeft:0,overlayImageTop:0,includeDefaultValues:!0,stateful:!0,renderOnAddition:!0,clipTo:null,controlsAboveOverlay:!1,onBeforeScaleRotate:function(){},_initStatic:function(a,b){this._objects=[];this._createLowerCanvas(a);this._initOptions(b);b.overlayImage&&this.setOverlayImage(b.overlayImage,this.renderAll.bind(this));b.backgroundImage&&this.setBackgroundImage(b.backgroundImage,this.renderAll.bind(this));b.backgroundColor&&this.setBackgroundColor(b.backgroundColor,
this.renderAll.bind(this));this.calcOffset()},calcOffset:function(){this._offset=c(this.lowerCanvasEl);return this},setOverlayImage:function(a,b,c){fabric.util.loadImage(a,function(a){this.overlayImage=a;c&&"overlayImageLeft"in c&&(this.overlayImageLeft=c.overlayImageLeft);c&&"overlayImageTop"in c&&(this.overlayImageTop=c.overlayImageTop);b&&b()},this);return this},setBackgroundImage:function(a,b,c){fabric.util.loadImage(a,function(a){this.backgroundImage=a;c&&"backgroundImageOpacity"in c&&(this.backgroundImageOpacity=
c.backgroundImageOpacity);c&&"backgroundImageStretch"in c&&(this.backgroundImageStretch=c.backgroundImageStretch);b&&b()},this);return this},setBackgroundColor:function(a,b){if(a.source){var c=this;fabric.util.loadImage(a.source,function(d){c.backgroundColor=new fabric.Pattern({source:d,pattern:a.pattern});b&&b()})}else this.backgroundColor=a,b&&b();return this},_createCanvasElement:function(){var a=fabric.document.createElement("canvas");a.style||(a.style={});if(!a)throw d;this._initCanvasElement(a);
return a},_initCanvasElement:function(a){fabric.util.createCanvasElement(a);if("undefined"===typeof a.getContext)throw d;},_initOptions:function(a){for(var b in a)this[b]=a[b];this.width=parseInt(this.lowerCanvasEl.width,10)||0;this.height=parseInt(this.lowerCanvasEl.height,10)||0;this.lowerCanvasEl.style&&(this.lowerCanvasEl.style.width=this.width+"px",this.lowerCanvasEl.style.height=this.height+"px")},_createLowerCanvas:function(a){this.lowerCanvasEl=fabric.util.getById(a)||this._createCanvasElement();
this._initCanvasElement(this.lowerCanvasEl);fabric.util.addClass(this.lowerCanvasEl,"lower-canvas");this.interactive&&this._applyCanvasStyle(this.lowerCanvasEl);this.contextContainer=this.lowerCanvasEl.getContext("2d")},getWidth:function(){return this.width},getHeight:function(){return this.height},setWidth:function(a){return this._setDimension("width",a)},setHeight:function(a){return this._setDimension("height",a)},setDimensions:function(a){for(var b in a)this._setDimension(b,a[b]);return this},
_setDimension:function(a,b){this.lowerCanvasEl[a]=b;this.lowerCanvasEl.style[a]=b+"px";this.upperCanvasEl&&(this.upperCanvasEl[a]=b,this.upperCanvasEl.style[a]=b+"px");this.cacheCanvasEl&&(this.cacheCanvasEl[a]=b);this.wrapperEl&&(this.wrapperEl.style[a]=b+"px");this[a]=b;this.calcOffset();this.renderAll();return this},getElement:function(){return this.lowerCanvasEl},getActiveObject:function(){return null},getActiveGroup:function(){return null},_draw:function(a,b){if(b)if(this.controlsAboveOverlay){var c=
b.hasBorders,d=b.hasCorners;b.hasBorders=b.hasCorners=!1;b.render(a);b.hasBorders=c;b.hasCorners=d}else b.render(a)},add:function(){this._objects.push.apply(this._objects,arguments);for(var a=arguments.length;a--;)this._initObject(arguments[a]);this.renderOnAddition&&this.renderAll();return this},_initObject:function(a){this.stateful&&a.setupState();a.setCoords();a.canvas=this;this.fire("object:added",{target:a});a.fire("added")},insertAt:function(a,b,c){c?this._objects[b]=a:this._objects.splice(b,
0,a);this._initObject(a);this.renderOnAddition&&this.renderAll();return this},getObjects:function(){return this._objects},clearContext:function(a){a.clearRect(0,0,this.width,this.height);return this},getContext:function(){return this.contextContainer},clear:function(){this._objects.length=0;this.discardActiveGroup&&this.discardActiveGroup();this.clearContext(this.contextContainer);this.contextTop&&this.clearContext(this.contextTop);this.fire("canvas:cleared");this.renderAll();return this},renderAll:function(a){var b=
this[!0===a&&this.interactive?"contextTop":"contextContainer"];this.contextTop&&this.selection&&this.clearContext(this.contextTop);a||this.clearContext(b);this.fire("before:render");this.clipTo&&this._clipCanvas(b);this.backgroundColor&&(b.fillStyle=this.backgroundColor.toLive?this.backgroundColor.toLive(b):this.backgroundColor,b.fillRect(0,0,this.width,this.height));"object"===typeof this.backgroundImage&&this._drawBackroundImage(b);var c=this.getActiveGroup();a=0;for(var d=this._objects.length;a<
d;++a)(!c||c&&this._objects[a]&&!c.contains(this._objects[a]))&&this._draw(b,this._objects[a]);if(c){var e=[];this.forEachObject(function(a){c.contains(a)&&e.push(a)});c._set("objects",e);this._draw(b,c)}this.clipTo&&b.restore();this.overlayImage&&b.drawImage(this.overlayImage,this.overlayImageLeft,this.overlayImageTop);this.controlsAboveOverlay&&this.drawControls(b);this.fire("after:render");return this},_clipCanvas:function(a){a.save();a.beginPath();this.clipTo(a);a.clip()},_drawBackroundImage:function(a){a.save();
a.globalAlpha=this.backgroundImageOpacity;this.backgroundImageStretch?a.drawImage(this.backgroundImage,0,0,this.width,this.height):a.drawImage(this.backgroundImage,0,0);a.restore()},renderTop:function(){var a=this.contextTop||this.contextContainer;this.clearContext(a);this.selection&&this._groupSelector&&this._drawSelection();var b=this.getActiveGroup();b&&b.render(a);this.overlayImage&&a.drawImage(this.overlayImage,this.overlayImageLeft,this.overlayImageTop);this.fire("after:render");return this},
drawControls:function(a){var b=this.getActiveGroup();if(b)a.save(),fabric.Group.prototype.transform.call(b,a),b.drawBorders(a).drawCorners(a),a.restore();else for(var b=0,c=this._objects.length;b<c;++b)this._objects[b]&&this._objects[b].active&&(a.save(),fabric.Object.prototype.transform.call(this._objects[b],a),this._objects[b].drawBorders(a).drawCorners(a),a.restore(),this.lastRenderedObjectWithControlsAboveOverlay=this._objects[b])},toDataURL:function(a,b){var c=this.upperCanvasEl||this.lowerCanvasEl;
this.renderAll(!0);c=fabric.StaticCanvas.supports("toDataURLWithQuality")?c.toDataURL("image/"+a,b):c.toDataURL("image/"+a);this.contextTop&&this.clearContext(this.contextTop);this.renderAll();return c},toDataURLWithMultiplier:function(a,b,c){var d=this.getWidth(),e=this.getHeight(),t=d*b,q=e*b,u=this.getActiveObject(),r=this.getActiveGroup(),v=this.contextTop||this.contextContainer;this.setWidth(t).setHeight(q);v.scale(b,b);r?this._tempRemoveBordersCornersFromGroup(r):u&&this.deactivateAll&&this.deactivateAll();
this.width=d;this.height=e;this.renderAll(!0);a=this.toDataURL(a,c);v.scale(1/b,1/b);this.setWidth(d).setHeight(e);r?this._restoreBordersCornersOnGroup(r):u&&this.setActiveObject&&this.setActiveObject(u);this.contextTop&&this.clearContext(this.contextTop);this.renderAll();return a},_tempRemoveBordersCornersFromGroup:function(a){a.origHideCorners=a.hideCorners;a.origBorderColor=a.borderColor;a.hideCorners=!0;a.borderColor="rgba(0,0,0,0)";a.forEachObject(function(a){a.origBorderColor=a.borderColor;
a.borderColor="rgba(0,0,0,0)"})},_restoreBordersCornersOnGroup:function(a){a.hideCorners=a.origHideCorners;a.borderColor=a.origBorderColor;a.forEachObject(function(a){a.borderColor=a.origBorderColor;delete a.origBorderColor})},getCenter:function(){return{top:this.getHeight()/2,left:this.getWidth()/2}},centerObjectH:function(a){a.set("left",this.getCenter().left);this.renderAll();return this},centerObjectV:function(a){a.set("top",this.getCenter().top);this.renderAll();return this},centerObject:function(a){return this.centerObjectH(a).centerObjectV(a)},
toDatalessJSON:function(a){return this.toDatalessObject(a)},toObject:function(a){return this._toObjectMethod("toObject",a)},toDatalessObject:function(a){return this._toObjectMethod("toDatalessObject",a)},_toObjectMethod:function(a,b){var c={objects:this._objects.map(function(c){var d;this.includeDefaultValues||(d=c.includeDefaultValues,c.includeDefaultValues=!1);var e=c[a](b);this.includeDefaultValues||(c.includeDefaultValues=d);return e},this),background:this.backgroundColor&&this.backgroundColor.toObject?
this.backgroundColor.toObject():this.backgroundColor};this.backgroundImage&&(c.backgroundImage=this.backgroundImage.src,c.backgroundImageOpacity=this.backgroundImageOpacity,c.backgroundImageStretch=this.backgroundImageStretch);this.overlayImage&&(c.overlayImage=this.overlayImage.src,c.overlayImageLeft=this.overlayImageLeft,c.overlayImageTop=this.overlayImageTop);fabric.util.populateWithProperties(this,c,b);return c},toSVG:function(){var a=['<?xml version="1.0" standalone="no" ?>','<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN" ',
'"http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">',"<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',this.width,'" ','height="',this.height,'" ','xml:space="preserve">',"<desc>Created with Fabric.js ",fabric.version,"</desc>",fabric.createSVGFontFacesMarkup(this.getObjects())];this.backgroundImage&&a.push('<image x="0" y="0" ','width="',this.width,'" height="',this.height,'" preserveAspectRatio="',this.backgroundImageStretch?
"none":"defer",'" xlink:href="',this.backgroundImage.src,'" style="opacity:',this.backgroundImageOpacity,'"></image>');this.overlayImage&&a.push('<image x="',this.overlayImageLeft,'" y="',this.overlayImageTop,'" width="',this.overlayImage.width,'" height="',this.overlayImage.height,'" xlink:href="',this.overlayImage.src,'"></image>');for(var b=0,c=this.getObjects(),d=c.length;b<d;b++)a.push(c[b].toSVG());a.push("</svg>");return a.join("")},isEmpty:function(){return 0===this._objects.length},remove:function(a){this.getActiveObject()===
a&&(this.fire("before:selection:cleared",{target:a}),this.discardActiveObject(),this.fire("selection:cleared"));var b=this._objects,c=b.indexOf(a);-1!==c&&(b.splice(c,1),this.fire("object:removed",{target:a}));this.renderAll();return a},sendToBack:function(b){a(this._objects,b);this._objects.unshift(b);return this.renderAll()},bringToFront:function(b){a(this._objects,b);this._objects.push(b);return this.renderAll()},sendBackwards:function(b){var c=this._objects.indexOf(b),d=c;if(0!==c){for(c-=1;0<=
c;--c)if(b.intersectsWithObject(this._objects[c])||b.isContainedWithinObject(this._objects[c])||this._objects[c].isContainedWithinObject(b)){d=c;break}a(this._objects,b);this._objects.splice(d,0,b)}return this.renderAll()},bringForward:function(b){var c=this.getObjects(),d=c.indexOf(b),e=d;if(d!==c.length-1){for(var d=d+1,s=this._objects.length;d<s;++d)if(b.intersectsWithObject(c[d])||b.isContainedWithinObject(this._objects[d])||this._objects[d].isContainedWithinObject(b)){e=d;break}a(c,b);c.splice(e,
0,b)}this.renderAll()},item:function(a){return this.getObjects()[a]},complexity:function(){return this.getObjects().reduce(function(a,b){return a+=b.complexity?b.complexity():0},0)},forEachObject:function(a,b){for(var c=this.getObjects(),d=c.length;d--;)a.call(b,c[d],d,c);return this},dispose:function(){this.clear();this.interactive&&(e(this.upperCanvasEl,"mousedown",this._onMouseDown),e(this.upperCanvasEl,"mousemove",this._onMouseMove),e(fabric.window,"resize",this._onResize));return this},_resizeImageToFit:function(a){var b=
a.width||a.offsetWidth,c=this.getWidth()/b;b&&(a.width=b*c)}});fabric.StaticCanvas.prototype.toString=function(){return"#<fabric.Canvas ("+this.complexity()+"): { objects: "+this.getObjects().length+" }>"};b(fabric.StaticCanvas,{EMPTY_JSON:'{"objects": [], "background": "white"}',toGrayscale:function(a){var b=a.getContext("2d");a=b.getImageData(0,0,a.width,a.height);var c=a.data,d=a.width,e=a.height,t,q,u,r;for(u=0;u<d;u++)for(r=0;r<e;r++)t=4*u*e+4*r,q=(c[t]+c[t+1]+c[t+2])/3,c[t]=q,c[t+1]=q,c[t+2]=
q;b.putImageData(a,0,0)},supports:function(a){var b=fabric.util.createCanvasElement();if(!b||!b.getContext)return null;var c=b.getContext("2d");if(!c)return null;switch(a){case "getImageData":return"undefined"!==typeof c.getImageData;case "toDataURL":return"undefined"!==typeof b.toDataURL;case "toDataURLWithQuality":try{return b.toDataURL("image/jpeg",0),!0}catch(d){}return!1;default:return null}}});fabric.StaticCanvas.prototype.toJSON=fabric.StaticCanvas.prototype.toObject}})();
(function(b){var c=b.fabric||(b.fabric={}),a=c.util.array.min,e=c.util.array.max;c.FreeDrawing?c.warn("fabric.FreeDrawing is already defined"):c.FreeDrawing=c.util.createClass({initialize:function(a){this.canvas=a;this._points=[]},_addPoint:function(a){this._points.push(a)},_reset:function(){this._points.length=0;var a=this.canvas.contextTop;a.strokeStyle=this.canvas.freeDrawingColor;a.lineWidth=this.canvas.freeDrawingLineWidth;a.lineCap=a.lineJoin="round"},_prepareForDrawing:function(a){this.canvas._isCurrentlyDrawing=
!0;this.canvas.discardActiveObject().renderAll();a=new c.Point(a.x,a.y);this._reset();this._addPoint(a);this.canvas.contextTop.moveTo(a.x,a.y)},_captureDrawingPath:function(a){a=new c.Point(a.x,a.y);this._addPoint(a)},_render:function(){var a=this.canvas.contextTop;a.beginPath();var b=this._points[0],c=this._points[1];a.moveTo(b.x,b.y);for(var e=1,m=this._points.length;e<m;e++)c=b.midPointFrom(c),a.quadraticCurveTo(b.x,b.y,c.x,c.y),b=this._points[e],c=this._points[e+1];a.lineTo(b.x,b.y);a.stroke()},
_getSVGPathData:function(){this.box=this.getPathBoundingBox(this._points);return this.convertPointsToSVGPath(this._points,this.box.minx,this.box.maxx,this.box.miny,this.box.maxy)},getPathBoundingBox:function(b){for(var c=[],g=[],h=b[0],m=b[1],s=h,t=1,q=b.length;t<q;t++){var u=h.midPointFrom(m);c.push(s.x);c.push(u.x);g.push(s.y);g.push(u.y);h=b[t];m=b[t+1];s=u}c.push(h.x);g.push(h.y);return{minx:a(c),miny:a(g),maxx:e(c),maxy:e(g)}},convertPointsToSVGPath:function(a,b,e,h,m){e=[];m=new c.Point(a[0].x-
b,a[0].y-h);var s=new c.Point(a[1].x-b,a[1].y-h);e.push("M ",a[0].x-b," ",a[0].y-h," ");for(var t=1,q=a.length;t<q;t++){var u=m.midPointFrom(s);e.push("Q ",m.x," ",m.y," ",u.x," ",u.y," ");m=new c.Point(a[t].x-b,a[t].y-h);t+1<a.length&&(s=new c.Point(a[t+1].x-b,a[t+1].y-h))}e.push("L ",m.x," ",m.y," ");return e},createPath:function(a){a=new c.Path(a);a.fill=null;a.stroke=this.color;a.strokeWidth=this.width;return a},_finalizeAndAddPath:function(){this.canvas._isCurrentlyDrawing=!1;this.canvas.contextTop.closePath();
var a=this._getSVGPathData().join("");if("M 0 0 Q 0 0 0 0 L 0 0"===a)this.canvas.renderAll();else{var b=this.box.minx+(this.box.maxx-this.box.minx)/2,c=this.box.miny+(this.box.maxy-this.box.miny)/2;this.canvas.contextTop.arc(b,c,3,0,2*Math.PI,!1);a=this.createPath(a);a.set({left:b,top:c});this.canvas.add(a);a.setCoords();this.canvas.contextTop&&this.canvas.clearContext(this.canvas.contextTop);this.canvas.renderAll();this.canvas.fire("path:created",{path:a})}}})})("undefined"!==typeof exports?exports:
this);
(function(){function b(){}var c=fabric.util.object.extend,a=fabric.util.getPointer,e=fabric.util.degreesToRadians,d=fabric.util.radiansToDegrees,f=Math.atan2,g=Math.abs,h=Math.min,m=Math.max;fabric.Canvas=function(a,b){b||(b={});this._initStatic(a,b);this._initInteractive();this._createCacheCanvas();fabric.Canvas.activeInstance=this};b.prototype=fabric.StaticCanvas.prototype;fabric.Canvas.prototype=new b;fabric.Canvas.prototype.toString=fabric.StaticCanvas.prototype.toString;c(fabric.Canvas.prototype,{uniScaleTransform:!1,
centerTransform:!1,interactive:!0,selection:!0,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,freeDrawingColor:"rgb(0, 0, 0)",freeDrawingLineWidth:1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",rotationCursor:"crosshair",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,_initInteractive:function(){this._groupSelector=this._currentTransform=
null;this.freeDrawing=fabric.FreeDrawing&&new fabric.FreeDrawing(this);this._initWrapperElement();this._createUpperCanvas();this._initEvents();this.calcOffset()},_resetCurrentTransform:function(a){var b=this._currentTransform;b.target.set("scaleX",b.original.scaleX);b.target.set("scaleY",b.original.scaleY);b.target.set("left",b.original.left);b.target.set("top",b.original.top);a.altKey||this.centerTransform?("center"!==b.originX&&(b.mouseXSign="right"===b.originX?-1:1),"center"!==b.originY&&(b.mouseYSign=
"bottom"===b.originY?-1:1),b.originX="center",b.originY="center"):(b.originX=b.original.originX,b.originY=b.original.originY)},containsPoint:function(a,b){var c=this.getPointer(a),d=this._normalizePointer(b,c),c=d.x,d=d.y,e=b._getImageLines(b.oCoords);return(c=b._findCrossPoints(c,d,e))&&1===c%2||b._findTargetCorner(a,this._offset)?!0:!1},_normalizePointer:function(a,b){var c=this.getActiveGroup(),d=b.x,e=b.y;c&&("group"!==a.type&&c.contains(a))&&(d-=c.left,e-=c.top);return{x:d,y:e}},_isTargetTransparent:function(a,
b,c){var d=this.contextCache,e=a.hasBorders,f=a.transparentCorners;a.hasBorders=a.transparentCorners=!1;this._draw(d,a);a.hasBorders=e;a.transparentCorners=f;0<this.targetFindTolerance&&(b=b>this.targetFindTolerance?b-this.targetFindTolerance:0,c=c>this.targetFindTolerance?c-this.targetFindTolerance:0);a=!0;b=d.getImageData(b,c,2*this.targetFindTolerance||1,2*this.targetFindTolerance||1);for(c=3;c<b.data.length&&!(a=0>=b.data[c],!1===a);c+=4);this.clearContext(d);return a},_shouldClearSelection:function(a){var b=
this.findTarget(a),c=this.getActiveGroup();return!b||b&&c&&!c.contains(b)&&c!==b&&!a.shiftKey},_setupCurrentTransform:function(b,c){var d="drag",f,g=a(b,c.canvas.upperCanvasEl);(f=c._findTargetCorner(b,this._offset))&&(d="ml"===f||"mr"===f?"scaleX":"mt"===f||"mb"===f?"scaleY":"mtr"===f?"rotate":"scale");var h="center",m="center";if("ml"===f||"tl"===f||"bl"===f)h="right";else if("mr"===f||"tr"===f||"br"===f)h="left";if("tl"===f||"mt"===f||"tr"===f)m="bottom";else if("bl"===f||"mb"===f||"br"===f)m=
"top";"mtr"===f&&(m=h="center");this._currentTransform={target:c,action:d,scaleX:c.scaleX,scaleY:c.scaleY,offsetX:g.x-c.left,offsetY:g.y-c.top,originX:h,originY:m,ex:g.x,ey:g.y,left:c.left,top:c.top,theta:e(c.angle),width:c.width*c.scaleX,mouseXSign:1,mouseYSign:1};this._currentTransform.original={left:c.left,top:c.top,scaleX:c.scaleX,scaleY:c.scaleY,originX:h,originY:m};this._resetCurrentTransform(b)},_shouldHandleGroupLogic:function(a,b){var c=this.getActiveObject();return a.shiftKey&&(this.getActiveGroup()||
c&&c!==b)&&this.selection},_handleGroupLogic:function(a,b){if(b===this.getActiveGroup()&&(b=this.findTarget(a,!0),!b||b.isType("group")))return;var c=this.getActiveGroup();c?(c.contains(b)?(c.removeWithUpdate(b),this._resetObjectTransform(c),b.setActive(!1),1===c.size()&&this.discardActiveGroup()):(c.addWithUpdate(b),this._resetObjectTransform(c)),this.fire("selection:created",{target:c,e:a}),c.setActive(!0)):(this._activeObject&&b!==this._activeObject&&(c=new fabric.Group([this._activeObject,b]),
this.setActiveGroup(c),c=this.getActiveGroup()),b.setActive(!0));c&&c.saveCoords()},_translateObject:function(a,b){var c=this._currentTransform.target;c.get("lockMovementX")||c.set("left",a-this._currentTransform.offsetX);c.get("lockMovementY")||c.set("top",b-this._currentTransform.offsetY)},_scaleObject:function(a,b,c){var d=this._currentTransform,e=this._offset,f=d.target,g=f.get("lockScalingX"),h=f.get("lockScalingY");if(!g||!h){var m=f.translateToOriginPoint(f.getCenterPoint(),d.originX,d.originY);
b=f.toLocalPoint(new fabric.Point(a-e.left,b-e.top),d.originX,d.originY);"right"===d.originX?b.x*=-1:"center"===d.originX&&(b.x*=2*d.mouseXSign,0>b.x&&(d.mouseXSign=-d.mouseXSign));"bottom"===d.originY?b.y*=-1:"center"===d.originY&&(b.y*=2*d.mouseYSign,0>b.y&&(d.mouseYSign=-d.mouseYSign));a=f.scaleX;e=f.scaleY;"equally"===c&&!g&&!h?(c=b.y+b.x,g=f.height*d.original.scaleY+f.width*d.original.scaleX+2*f.padding-2*f.strokeWidth+1,a=d.original.scaleX*c/g,e=d.original.scaleY*c/g,f.set("scaleX",a),f.set("scaleY",
e)):c?"x"===c&&!f.get("lockUniScaling")?(a=b.x/(f.width+f.padding),g||f.set("scaleX",a)):"y"===c&&!f.get("lockUniScaling")&&(e=b.y/(f.height+f.padding),h||f.set("scaleY",e)):(a=b.x/(f.width+f.padding),e=b.y/(f.height+f.padding),g||f.set("scaleX",a),h||f.set("scaleY",e));0>a&&("left"===d.originX?d.originX="right":"right"===d.originX&&(d.originX="left"));0>e&&("top"===d.originY?d.originY="bottom":"bottom"===d.originY&&(d.originY="top"));f.setPositionByOrigin(m,d.originX,d.originY)}},_rotateObject:function(a,
b){var c=this._currentTransform,e=this._offset;if(!c.target.get("lockRotation")){var g=f(c.ey-c.top-e.top,c.ex-c.left-e.left),e=f(b-c.top-e.top,a-c.left-e.left);c.target.angle=d(e-g+c.theta)}},_setCursor:function(a){this.upperCanvasEl.style.cursor=a},_resetObjectTransform:function(a){a.scaleX=1;a.scaleY=1;a.setAngle(0)},_drawSelection:function(){var a=this.contextTop,b=this._groupSelector,c=b.left,d=b.top,e=g(c),f=g(d);a.fillStyle=this.selectionColor;a.fillRect(b.ex-(0<c?0:-c),b.ey-(0<d?0:-d),e,f);
a.lineWidth=this.selectionLineWidth;a.strokeStyle=this.selectionBorderColor;1<this.selectionDashArray.length?(c=b.ex+0.5-(0<c?0:e),b=b.ey+0.5-(0<d?0:f),a.beginPath(),fabric.util.drawDashedLine(a,c,b,c+e,b,this.selectionDashArray),fabric.util.drawDashedLine(a,c,b+f-1,c+e,b+f-1,this.selectionDashArray),fabric.util.drawDashedLine(a,c,b,c,b+f,this.selectionDashArray),fabric.util.drawDashedLine(a,c+e-1,b,c+e-1,b+f,this.selectionDashArray),a.closePath(),a.stroke()):a.strokeRect(b.ex+0.5-(0<c?0:e),b.ey+
0.5-(0<d?0:f),e,f)},_findSelectedObjects:function(a){for(var b=[],c=this._groupSelector.ex,d=this._groupSelector.ey,e=c+this._groupSelector.left,f=d+this._groupSelector.top,g=new fabric.Point(h(c,e),h(d,f)),d=new fabric.Point(m(c,e),m(d,f)),e=0,f=this._objects.length;e<f;++e)if((c=this._objects[e])&&(c.intersectsWithRect(g,d)||c.isContainedWithinRect(g,d))&&this.selection&&c.selectable)c.setActive(!0),b.push(c);1===b.length?this.setActiveObject(b[0],a):1<b.length&&(b=new fabric.Group(b),this.setActiveGroup(b),
b.saveCoords(),this.fire("selection:created",{target:b}));this.renderAll()},findTarget:function(a,b){var c,d=this.getPointer(a);if(this.controlsAboveOverlay&&this.lastRenderedObjectWithControlsAboveOverlay&&this.containsPoint(a,this.lastRenderedObjectWithControlsAboveOverlay)&&this.lastRenderedObjectWithControlsAboveOverlay._findTargetCorner(a,this._offset))return c=this.lastRenderedObjectWithControlsAboveOverlay;var e=this.getActiveGroup();if(e&&!b&&this.containsPoint(a,e))return e;e=[];for(d=this._objects.length;d--;)if(this._objects[d]&&
this.containsPoint(a,this._objects[d]))if(this.perPixelTargetFind||this._objects[d].perPixelTargetFind)e[e.length]=this._objects[d];else{this.relatedTarget=c=this._objects[d];break}for(var f=0,g=e.length;f<g;f++)if(d=this.getPointer(a),!this._isTargetTransparent(e[f],d.x,d.y)){this.relatedTarget=c=e[f];break}if(c&&c.selectable)return c},getPointer:function(b){b=a(b,this.upperCanvasEl);return{x:b.x-this._offset.left,y:b.y-this._offset.top}},_createUpperCanvas:function(){this.upperCanvasEl=this._createCanvasElement();
this.upperCanvasEl.className="upper-canvas";this.wrapperEl.appendChild(this.upperCanvasEl);this._applyCanvasStyle(this.upperCanvasEl);this.contextTop=this.upperCanvasEl.getContext("2d")},_createCacheCanvas:function(){this.cacheCanvasEl=this._createCanvasElement();this.cacheCanvasEl.setAttribute("width",this.width);this.cacheCanvasEl.setAttribute("height",this.height);this.contextCache=this.cacheCanvasEl.getContext("2d")},_initWrapperElement:function(){this.wrapperEl=fabric.util.wrapElement(this.lowerCanvasEl,
"div",{"class":this.containerClass});fabric.util.setStyle(this.wrapperEl,{width:this.getWidth()+"px",height:this.getHeight()+"px",position:"relative"});fabric.util.makeElementUnselectable(this.wrapperEl)},_applyCanvasStyle:function(a){var b=this.getWidth()||a.width,c=this.getHeight()||a.height;fabric.util.setStyle(a,{position:"absolute",width:b+"px",height:c+"px",left:0,top:0});a.width=b;a.height=c;fabric.util.makeElementUnselectable(a)},getSelectionContext:function(){return this.contextTop},getSelectionElement:function(){return this.upperCanvasEl},
setActiveObject:function(a,b){this._activeObject&&this._activeObject.setActive(!1);this._activeObject=a;a.setActive(!0);this.renderAll();this.fire("object:selected",{target:a,e:b});a.fire("selected",{e:b});return this},getActiveObject:function(){return this._activeObject},discardActiveObject:function(){this._activeObject&&this._activeObject.setActive(!1);this._activeObject=null;return this},setActiveGroup:function(a){if(this._activeGroup=a)a.canvas=this,a.setActive(!0);return this},getActiveGroup:function(){return this._activeGroup},
discardActiveGroup:function(){var a=this.getActiveGroup();a&&a.destroy();return this.setActiveGroup(null)},deactivateAll:function(){for(var a=this.getObjects(),b=0,c=a.length;b<c;b++)a[b].setActive(!1);this.discardActiveGroup();this.discardActiveObject();return this},deactivateAllWithDispatch:function(){var a=this.getActiveGroup()||this.getActiveObject();a&&this.fire("before:selection:cleared",{target:a});this.deactivateAll();a&&this.fire("selection:cleared");return this}});for(var s in fabric.StaticCanvas)"prototype"!==
s&&(fabric.Canvas[s]=fabric.StaticCanvas[s]);fabric.isTouchSupported&&(fabric.Canvas.prototype._setCursorFromEvent=function(){});fabric.Element=fabric.Canvas})();
(function(){var b={tr:"ne-resize",br:"se-resize",bl:"sw-resize",tl:"nw-resize",ml:"w-resize",mt:"n-resize",mr:"e-resize",mb:"s-resize"},c=fabric.util.addListener,a=fabric.util.removeListener,e=fabric.util.getPointer;fabric.util.object.extend(fabric.Canvas.prototype,{_initEvents:function(){var a=this;this._onMouseDown=this._onMouseDown.bind(this);this._onMouseMove=this._onMouseMove.bind(this);this._onMouseUp=this._onMouseUp.bind(this);this._onResize=this._onResize.bind(this);c(fabric.window,"resize",
this._onResize);fabric.isTouchSupported?(c(this.upperCanvasEl,"touchstart",this._onMouseDown),c(this.upperCanvasEl,"touchmove",this._onMouseMove),"undefined"!==typeof Event&&"add"in Event&&Event.add(this.upperCanvasEl,"gesture",function(b,c){a.__onTransformGesture(b,c)})):(c(this.upperCanvasEl,"mousedown",this._onMouseDown),c(this.upperCanvasEl,"mousemove",this._onMouseMove))},_onMouseDown:function(b){this.__onMouseDown(b);!fabric.isTouchSupported&&c(fabric.document,"mouseup",this._onMouseUp);fabric.isTouchSupported&&
c(fabric.document,"touchend",this._onMouseUp);!fabric.isTouchSupported&&c(fabric.document,"mousemove",this._onMouseMove);fabric.isTouchSupported&&c(fabric.document,"touchmove",this._onMouseMove);!fabric.isTouchSupported&&a(this.upperCanvasEl,"mousemove",this._onMouseMove);fabric.isTouchSupported&&a(this.upperCanvasEl,"touchmove",this._onMouseMove)},_onMouseUp:function(b){this.__onMouseUp(b);!fabric.isTouchSupported&&a(fabric.document,"mouseup",this._onMouseUp);fabric.isTouchSupported&&a(fabric.document,
"touchend",this._onMouseUp);!fabric.isTouchSupported&&a(fabric.document,"mousemove",this._onMouseMove);fabric.isTouchSupported&&a(fabric.document,"touchmove",this._onMouseMove);!fabric.isTouchSupported&&c(this.upperCanvasEl,"mousemove",this._onMouseMove);fabric.isTouchSupported&&c(this.upperCanvasEl,"touchmove",this._onMouseMove)},_onMouseMove:function(a){a.preventDefault&&a.preventDefault();this.__onMouseMove(a)},_onResize:function(){this.calcOffset()},__onMouseUp:function(a){var b;if(this.isDrawingMode&&
this._isCurrentlyDrawing)this.freeDrawing._finalizeAndAddPath(),this.fire("mouse:up",{e:a});else{if(this._currentTransform){b=this._currentTransform.target;b._scaling&&(b._scaling=!1);for(var c=this._objects.length;c--;)this._objects[c].setCoords();b.isMoving=!1;this.stateful&&b.hasStateChanged()&&(this.fire("object:modified",{target:b}),b.fire("modified"));this._previousOriginX&&(this._currentTransform.target.adjustPosition(this._previousOriginX),this._previousOriginX=null)}this._currentTransform=
null;this._groupSelector&&this._findSelectedObjects(a);if(c=this.getActiveGroup())c.setObjectsCoords(),c.set("isMoving",!1),this._setCursor(this.defaultCursor);this._groupSelector=null;this.renderAll();this._setCursorFromEvent(a,b);this._setCursor("");var e=this;setTimeout(function(){e._setCursorFromEvent(a,b)},50);this.fire("mouse:up",{target:b,e:a});b&&b.fire("mouseup",{e:a})}},__onMouseDown:function(a){var b;if(("which"in a?1===a.which:1===a.button)||fabric.isTouchSupported)if(this.isDrawingMode)b=
this.getPointer(a),this.freeDrawing._prepareForDrawing(b),this.freeDrawing._captureDrawingPath(b),this.fire("mouse:down",{e:a});else if(!this._currentTransform){var c=this.findTarget(a),e;b=this.getPointer(a);if(this._shouldClearSelection(a))this._groupSelector={ex:b.x,ey:b.y,top:0,left:0},this.deactivateAllWithDispatch();else{this.stateful&&c.saveState();if(e=c._findTargetCorner(a,this._offset))this.onBeforeScaleRotate(c);this._shouldHandleGroupLogic(a,c)?(this._handleGroupLogic(a,c),c=this.getActiveGroup()):
(c!==this.getActiveGroup()&&this.deactivateAll(),this.setActiveObject(c,a));this._setupCurrentTransform(a,c)}this.renderAll();this.fire("mouse:down",{target:c,e:a});c&&c.fire("mousedown",{e:a});"mtr"===e&&(this._previousOriginX=this._currentTransform.target.originX,this._currentTransform.target.adjustPosition("center"),this._currentTransform.left=this._currentTransform.target.left,this._currentTransform.top=this._currentTransform.target.top)}},__onMouseMove:function(a){var b,c;if(this.isDrawingMode)this._isCurrentlyDrawing&&
(c=this.getPointer(a),this.freeDrawing._captureDrawingPath(c),this.clearContext(this.contextTop),this.freeDrawing._render(this.contextTop)),this.upperCanvasEl.style.cursor=this.freeDrawingCursor,this.fire("mouse:move",{e:a});else{var h=this._groupSelector;if(null!==h)c=e(a,this.upperCanvasEl),h.left=c.x-this._offset.left-h.ex,h.top=c.y-this._offset.top-h.ey,this.renderTop();else if(this._currentTransform){c=e(a,this.upperCanvasEl);h=c.x;c=c.y;this._currentTransform.target.isMoving=!0;var m=this._currentTransform,
s=!1;if(("scale"===m.action||"scaleX"===m.action||"scaleY"===m.action)&&(a.altKey&&("center"!==m.originX||"center"!==m.originY)||!a.altKey&&"center"===m.originX&&"center"===m.originY))this._resetCurrentTransform(a),s=!0;"rotate"===this._currentTransform.action?(this._rotateObject(h,c),this.fire("object:rotating",{target:this._currentTransform.target,e:a}),this._currentTransform.target.fire("rotating")):"scale"===this._currentTransform.action?(a.shiftKey||this.uniScaleTransform?(this._currentTransform.currentAction=
"scale",this._scaleObject(h,c)):(!s&&"scale"===m.currentAction&&this._resetCurrentTransform(a),this._currentTransform.currentAction="scaleEqually",this._scaleObject(h,c,"equally")),this.fire("object:scaling",{target:this._currentTransform.target,e:a})):"scaleX"===this._currentTransform.action?(this._scaleObject(h,c,"x"),this.fire("object:scaling",{target:this._currentTransform.target,e:a}),this._currentTransform.target.fire("scaling",{e:a})):"scaleY"===this._currentTransform.action?(this._scaleObject(h,
c,"y"),this.fire("object:scaling",{target:this._currentTransform.target,e:a}),this._currentTransform.target.fire("scaling",{e:a})):(this._translateObject(h,c),this.fire("object:moving",{target:this._currentTransform.target,e:a}),this._setCursor(this.moveCursor),this._currentTransform.target.fire("moving",{e:a}));this.renderAll()}else if(h=this.upperCanvasEl.style,b=this.findTarget(a))this._setCursorFromEvent(a,b);else{for(c=this._objects.length;c--;)this._objects[c]&&!this._objects[c].active&&this._objects[c].setActive(!1);
h.cursor=this.defaultCursor}this.fire("mouse:move",{target:b,e:a});b&&b.fire("mousemove",{e:a})}},_setCursorFromEvent:function(a,c){var e=this.upperCanvasEl.style;if(c){var h=this.getActiveGroup();if(h=c._findTargetCorner&&(!h||!h.contains(c))&&c._findTargetCorner(a,this._offset))if(h in b)e.cursor=b[h];else if("mtr"===h&&c.hasRotatingPoint)e.cursor=this.rotationCursor;else return e.cursor=this.defaultCursor,!1;else e.cursor=this.hoverCursor}else return e.cursor=this.defaultCursor,!1;return!0}})})();
fabric.util.object.extend(fabric.StaticCanvas.prototype,{FX_DURATION:500,fxCenterObjectH:function(b,c){c=c||{};var a=function(){},e=c.onComplete||a,d=c.onChange||a,f=this;fabric.util.animate({startValue:b.get("left"),endValue:this.getCenter().left,duration:this.FX_DURATION,onChange:function(a){b.set("left",a);f.renderAll();d()},onComplete:function(){b.setCoords();e()}});return this},fxCenterObjectV:function(b,c){c=c||{};var a=function(){},e=c.onComplete||a,d=c.onChange||a,f=this;fabric.util.animate({startValue:b.get("top"),
endValue:this.getCenter().top,duration:this.FX_DURATION,onChange:function(a){b.set("top",a);f.renderAll();d()},onComplete:function(){b.setCoords();e()}});return this},fxRemove:function(b,c){c=c||{};var a=function(){},e=c.onComplete||a,d=c.onChange||a,f=this;fabric.util.animate({startValue:b.get("opacity"),endValue:0,duration:this.FX_DURATION,onStart:function(){b.setActive(!1)},onChange:function(a){b.set("opacity",a);f.renderAll();d()},onComplete:function(){f.remove(b);e()}});return this}});
fabric.util.object.extend(fabric.StaticCanvas.prototype,{loadFromDatalessJSON:function(b,c){if(b){var a="string"===typeof b?JSON.parse(b):b;this.setBackgroundColor(a.background,this.renderAll.bind(this));if(a&&(!a||a.objects)){this.clear();var e=this;this._enlivenDatalessObjects(a.objects,function(){e._setBgOverlayImages(a,c)})}}},_enlivenDatalessObjects:function(b,c){function a(a,b){d.insertAt(a,b,!0);a.setCoords();++f===g&&c&&c()}function e(b,c){var d=b.paths?"paths":"path",e=b[d];delete b[d];if("string"!==
typeof e)if("image"===b.type||"group"===b.type)fabric[fabric.util.string.capitalize(b.type)].fromObject(b,function(b){a(b,c)});else{var f=fabric[fabric.util.string.camelize(fabric.util.string.capitalize(b.type))];f&&f.fromObject&&(e&&(b[d]=e),a(f.fromObject(b),c))}else if("image"===b.type)fabric.util.loadImage(e,function(d){d=new fabric.Image(d);d.setSourcePath(e);fabric.util.object.extend(d,b);d.setAngle(b.angle);a(d,c)});else if("text"===b.type)if(b.useNative)a(fabric.Text.fromObject(b),c);else{b.path=
e;var g=fabric.Text.fromObject(b);fabric.util.getScript(e,function(){"[object Opera]"===Object.prototype.toString.call(fabric.window.opera)?setTimeout(function(){a(g,c)},500):a(g,c)})}else fabric.loadSVGFromURL(e,function(d){d=fabric.util.groupSVGElements(d,b,e);d instanceof fabric.PathGroup||(fabric.util.object.extend(d,b),"undefined"!==typeof b.angle&&d.setAngle(b.angle));a(d,c)})}var d=this,f=0,g=b.length;0===g&&c&&c();try{b.forEach(e,this)}catch(h){fabric.log(h)}},loadFromJSON:function(b,c){if(b){var a=
"string"===typeof b?JSON.parse(b):b,e=this;this._enlivenObjects(a.objects,function(){e._setBgOverlayImages(a,c)});return this}},_setBgOverlayImages:function(b,c){var a=this,e,d;this.backgroundColor=b.background;b.backgroundImage?this.setBackgroundImage(b.backgroundImage,function(){a.backgroundImageOpacity=b.backgroundImageOpacity;a.backgroundImageStretch=b.backgroundImageStretch;a.renderAll();e=!0;c&&d&&c()}):e=!0;b.overlayImage?this.setOverlayImage(b.overlayImage,function(){a.overlayImageLeft=b.overlayImageLeft||
0;a.overlayImageTop=b.overlayImageTop||0;a.renderAll();d=!0;c&&e&&c()}):d=!0;!b.backgroundImage&&!b.overlayImage&&c&&c()},_enlivenObjects:function(b,c){var a=this;fabric.util.enlivenObjects(b,function(b){b.forEach(function(b,c){a.insertAt(b,c,!0)});c&&c()})},_toDataURL:function(b,c){this.clone(function(a){c(a.toDataURL(b))})},_toDataURLWithMultiplier:function(b,c,a){this.clone(function(e){a(e.toDataURLWithMultiplier(b,c))})},clone:function(b){var c=JSON.stringify(this);this.cloneWithoutData(function(a){a.loadFromJSON(c,
function(){b&&b(a)})})},cloneWithoutData:function(b){var c=fabric.document.createElement("canvas");c.width=this.getWidth();c.height=this.getHeight();var a=new fabric.Canvas(c);a.clipTo=this.clipTo;this.backgroundImage?(a.setBackgroundImage(this.backgroundImage.src,function(){a.renderAll();b&&b(a)}),a.backgroundImageOpacity=this.backgroundImageOpacity,a.backgroundImageStretch=this.backgroundImageStretch):b&&b(a)}});
(function(b){var c=b.fabric||(b.fabric={}),a=c.util.object.extend,e=c.util.toFixed,d=c.util.string.capitalize,f=c.util.degreesToRadians;if(!c.Object){var g=b.Image;try{var h="undefined"!==typeof require&&require("canvas").Image;h&&(g=h)}catch(m){c.log(m)}c.Object=c.util.createClass({type:"object",originX:"center",originY:"center",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,cornerSize:12,transparentCorners:!0,padding:0,borderColor:"rgba(102,153,255,0.75)",cornerColor:"rgba(102,153,255,0.5)",
fill:"rgb(0,0,0)",fillRule:"source-over",overlayFill:null,stroke:null,strokeWidth:1,strokeDashArray:null,shadow:null,borderOpacityWhenMoving:0.4,borderScaleFactor:1,transformMatrix:null,minScaleLimit:0.01,selectable:!0,hasControls:!0,hasBorders:!0,hasRotatingPoint:!0,rotatingPointOffset:40,perPixelTargetFind:!1,includeDefaultValues:!0,stateProperties:"top left width height scaleX scaleY flipX flipY angle opacity cornerSize fill overlayFill originX originY stroke strokeWidth strokeDashArray fillRule borderScaleFactor transformMatrix selectable shadow".split(" "),
initialize:function(a){a&&this.setOptions(a)},_initGradient:function(a){a.fill&&(a.fill.colorStops&&!(a.fill instanceof c.Gradient))&&this.set("fill",new c.Gradient(a.fill))},_initPattern:function(a){a.fill&&(a.fill.source&&!(a.fill instanceof c.Pattern))&&this.set("fill",new c.Pattern(a.fill));a.stroke&&(a.stroke.source&&!(a.stroke instanceof c.Pattern))&&this.set("stroke",new c.Pattern(a.stroke))},_initShadow:function(a){a.shadow&&!(a.shadow instanceof c.Shadow)&&this.setShadow(a.shadow)},setOptions:function(a){for(var b in a)this.set(b,
a[b]);this._initGradient(a);this._initPattern(a);this._initShadow(a)},transform:function(a){a.globalAlpha=this.opacity;var b=this.getCenterPoint();a.translate(b.x,b.y);a.rotate(f(this.angle));a.scale(this.scaleX*(this.flipX?-1:1),this.scaleY*(this.flipY?-1:1))},toObject:function(a){var b=c.Object.NUM_FRACTION_DIGITS,b={type:this.type,originX:this.originX,originY:this.originY,left:e(this.left,b),top:e(this.top,b),width:e(this.width,b),height:e(this.height,b),fill:this.fill&&this.fill.toObject?this.fill.toObject():
this.fill,overlayFill:this.overlayFill,stroke:this.stroke&&this.stroke.toObject?this.stroke.toObject():this.stroke,strokeWidth:this.strokeWidth,strokeDashArray:this.strokeDashArray,scaleX:e(this.scaleX,b),scaleY:e(this.scaleY,b),angle:e(this.getAngle(),b),flipX:this.flipX,flipY:this.flipY,opacity:e(this.opacity,b),selectable:this.selectable,hasControls:this.hasControls,hasBorders:this.hasBorders,hasRotatingPoint:this.hasRotatingPoint,transparentCorners:this.transparentCorners,perPixelTargetFind:this.perPixelTargetFind,
shadow:this.shadow&&this.shadow.toObject?this.shadow.toObject():this.shadow};this.includeDefaultValues||(b=this._removeDefaultValues(b));c.util.populateWithProperties(this,b,a);return b},toDatalessObject:function(a){return this.toObject(a)},getSvgStyles:function(){return["stroke: ",this.stroke?this.stroke:"none","; stroke-width: ",this.strokeWidth?this.strokeWidth:"0","; stroke-dasharray: ",this.strokeDashArray?this.strokeDashArray.join(" "):"; ","fill: ",this.fill?this.fill:"none","; opacity: ",
this.opacity?this.opacity:"1",";"].join("")},getSvgTransform:function(){var a=this.getAngle(),b=this.getCenterPoint(),d=c.Object.NUM_FRACTION_DIGITS,b="translate("+e(b.x,d)+" "+e(b.y,d)+")",a=0!==a?" rotate("+e(a,d)+")":"",d=1===this.scaleX&&1===this.scaleY?"":" scale("+e(this.scaleX,d)+" "+e(this.scaleY,d)+")";return[b,a,d,this.flipX?"matrix(-1 0 0 1 0 0) ":"",this.flipY?"matrix(1 0 0 -1 0 0)":""].join("")},_removeDefaultValues:function(a){var b=c.Object.prototype.options;b&&this.stateProperties.forEach(function(c){a[c]===
b[c]&&delete a[c]});return a},isActive:function(){return!!this.active},setActive:function(a){this.active=!!a;return this},toString:function(){return"#<fabric."+d(this.type)+">"},get:function(a){return this[a]},set:function(a,b){if("object"===typeof a)for(var c in a)this._set(c,a[c]);else"function"===typeof b?this._set(a,b(this.get(a))):this._set(a,b);return this},_set:function(a,b){if("scaleX"===a||"scaleY"===a)b=this._constrainScale(b);if("scaleX"===a&&0>b)this.flipX=!this.flipX,b*=-1;else if("scaleY"===
a&&0>b)this.flipY=!this.flipY,b*=-1;else if("width"===a||"height"===a)this.minScaleLimit=e(Math.min(0.1,1/Math.max(this.width,this.height)),2);this[a]=b;return this},toggle:function(a){var b=this.get(a);"boolean"===typeof b&&this.set(a,!b);return this},setSourcePath:function(a){this.sourcePath=a;return this},render:function(a,b){if(!(0===this.width||0===this.height)){a.save();var c=this.transformMatrix;c&&!this.group&&a.setTransform(c[0],c[1],c[2],c[3],c[4],c[5]);b||this.transform(a);if(this.stroke||
this.strokeDashArray)a.lineWidth=this.strokeWidth,a.strokeStyle=this.stroke&&this.stroke.toLive?this.stroke.toLive(a):this.stroke;this.overlayFill?a.fillStyle=this.overlayFill:this.fill&&(a.fillStyle=this.fill.toLive?this.fill.toLive(a):this.fill);c&&this.group&&(a.translate(-this.group.width/2,-this.group.height/2),a.transform(c[0],c[1],c[2],c[3],c[4],c[5]));this._setShadow(a);this._render(a,b);this._removeShadow(a);this.active&&!b&&(this.drawBorders(a),this.hideCorners||this.drawCorners(a));a.restore()}},
_setShadow:function(a){this.shadow&&(a.shadowColor=this.shadow.color,a.shadowBlur=this.shadow.blur,a.shadowOffsetX=this.shadow.offsetX,a.shadowOffsetY=this.shadow.offsetY)},_removeShadow:function(a){a.shadowColor="";a.shadowBlur=a.shadowOffsetX=a.shadowOffsetY=0},clone:function(a,b){return this.constructor.fromObject?this.constructor.fromObject(this.toObject(b),a):new c.Object(this.toObject(b))},cloneAsImage:function(a){if(c.Image){var b=new g;b.onload=function(){a&&a(new c.Image(b),d);b=b.onload=
null};var d={angle:this.get("angle"),flipX:this.get("flipX"),flipY:this.get("flipY")};this.set("angle",0).set("flipX",!1).set("flipY",!1);this.toDataURL(function(a){b.src=a})}return this},toDataURL:function(a){function b(c){c.left=d.width/2;c.top=d.height/2;c.setActive(!1);e.add(c);c=e.toDataURL("png");e.dispose();e=null;a&&a(c)}var d=c.util.createCanvasElement();d.width=this.getBoundingRectWidth();d.height=this.getBoundingRectHeight();c.util.wrapElement(d,"div");var e=new c.Canvas(d);e.backgroundColor=
"transparent";e.renderAll();this.constructor.async?this.clone(b):b(this.clone())},hasStateChanged:function(){return this.stateProperties.some(function(a){return this[a]!==this.originalState[a]},this)},saveState:function(){this.stateProperties.forEach(function(a){this.originalState[a]=this.get(a)},this);return this},setupState:function(){this.originalState={};this.saveState()},isType:function(a){return this.type===a},toGrayscale:function(){var a=this.get("fill");a&&this.set("overlayFill",(new c.Color(a)).toGrayscale().toRgb());
return this},complexity:function(){return 0},toJSON:function(a){return this.toObject(a)},setGradientFill:function(a){this.set("fill",c.Gradient.forObject(this,a))},setPatternFill:function(a){this.set("fill",new c.Pattern(a))},setShadow:function(a){this.set("shadow",new c.Shadow(a))},animate:function(){if(arguments[0]&&"object"===typeof arguments[0])for(var a in arguments[0])this._animate(a,arguments[0][a],arguments[1]);else this._animate.apply(this,arguments);return this},_animate:function(a,b,d){var e=
this;b=b.toString();d=d?c.util.object.clone(d):{};"from"in d||(d.from=this.get(a));b=~b.indexOf("=")?this.get(a)+parseFloat(b.replace("=","")):parseFloat(b);c.util.animate({startValue:d.from,endValue:b,byValue:d.by,easing:d.easing,duration:d.duration,onChange:function(b){e.set(a,b);d.onChange&&d.onChange()},onComplete:function(){e.setCoords();d.onComplete&&d.onComplete()}})},centerH:function(){this.canvas.centerObjectH(this);return this},centerV:function(){this.canvas.centerObjectV(this);return this},
center:function(){return this.centerH().centerV()},remove:function(){return this.canvas.remove(this)},sendToBack:function(){this.canvas.sendToBack(this);return this},bringToFront:function(){this.canvas.bringToFront(this);return this},sendBackwards:function(){this.canvas.sendBackwards(this);return this},bringForward:function(){this.canvas.bringForward(this);return this}});b=c.Object.prototype;for(h=b.stateProperties.length;h--;){var s=b.stateProperties[h],t=s.charAt(0).toUpperCase()+s.slice(1),q="set"+
t,t="get"+t;b[t]||(b[t]=new Function('return this.get("'+s+'")'));b[q]||(b[q]=new Function("value",'return this.set("'+s+'", value)'))}c.Object.prototype.rotate=c.Object.prototype.setAngle;a(c.Object.prototype,c.Observable);c.Object.NUM_FRACTION_DIGITS=2}})("undefined"!==typeof exports?exports:this);
(function(){var b=fabric.util.degreesToRadians;fabric.util.object.extend(fabric.Object.prototype,{translateToCenterPoint:function(c,a,e){var d=c.x,f=c.y;"left"===a?d=c.x+this.getWidth()/2:"right"===a&&(d=c.x-this.getWidth()/2);"top"===e?f=c.y+this.getHeight()/2:"bottom"===e&&(f=c.y-this.getHeight()/2);return fabric.util.rotatePoint(new fabric.Point(d,f),c,b(this.angle))},translateToOriginPoint:function(c,a,e){var d=c.x,f=c.y;"left"===a?d=c.x-this.getWidth()/2:"right"===a&&(d=c.x+this.getWidth()/2);
"top"===e?f=c.y-this.getHeight()/2:"bottom"===e&&(f=c.y+this.getHeight()/2);return fabric.util.rotatePoint(new fabric.Point(d,f),c,b(this.angle))},getCenterPoint:function(){return this.translateToCenterPoint(new fabric.Point(this.left,this.top),this.originX,this.originY)},toLocalPoint:function(c,a,e){var d=this.getCenterPoint();void 0!==a&&void 0!==e?(a="left"===a?d.x-this.getWidth()/2:"right"===a?d.x+this.getWidth()/2:d.x,e="top"===e?d.y-this.getHeight()/2:"bottom"===e?d.y+this.getHeight()/2:d.y):
(a=this.left,e=this.top);return fabric.util.rotatePoint(new fabric.Point(c.x,c.y),d,-b(this.angle)).subtractEquals(new fabric.Point(a,e))},setPositionByOrigin:function(b,a,e){b=this.translateToCenterPoint(b,a,e);b=this.translateToOriginPoint(b,this.originX,this.originY);this.set("left",b.x);this.set("top",b.y)},adjustPosition:function(c){var a=b(this.angle),e=this.getWidth()/2,d=Math.cos(a)*e,e=Math.sin(a)*e,f=this.getWidth(),g=Math.cos(a)*f,a=Math.sin(a)*f;"center"===this.originX&&"left"===c||"right"===
this.originX&&"center"===c?(this.left-=d,this.top-=e):"left"===this.originX&&"center"===c||"center"===this.originX&&"right"===c?(this.left+=d,this.top+=e):"left"===this.originX&&"right"===c?(this.left+=g,this.top+=a):"right"===this.originX&&"left"===c&&(this.left-=g,this.top-=a);this.setCoords();this.originX=c}})})();
(function(){var b=fabric.util.degreesToRadians;fabric.util.object.extend(fabric.Object.prototype,{intersectsWithRect:function(b,a){var e=this.oCoords,d=new fabric.Point(e.tl.x,e.tl.y),f=new fabric.Point(e.tr.x,e.tr.y),g=new fabric.Point(e.bl.x,e.bl.y),e=new fabric.Point(e.br.x,e.br.y);return"Intersection"===fabric.Intersection.intersectPolygonRectangle([d,f,e,g],b,a).status},intersectsWithObject:function(b){function a(a){return{tl:new fabric.Point(a.tl.x,a.tl.y),tr:new fabric.Point(a.tr.x,a.tr.y),
bl:new fabric.Point(a.bl.x,a.bl.y),br:new fabric.Point(a.br.x,a.br.y)}}var e=a(this.oCoords);b=a(b.oCoords);return"Intersection"===fabric.Intersection.intersectPolygonPolygon([e.tl,e.tr,e.br,e.bl],[b.tl,b.tr,b.br,b.bl]).status},isContainedWithinObject:function(b){return this.isContainedWithinRect(b.oCoords.tl,b.oCoords.br)},isContainedWithinRect:function(b,a){var e=this.oCoords,d=new fabric.Point(e.tl.x,e.tl.y),f=new fabric.Point(e.tr.x,e.tr.y),e=new fabric.Point(e.bl.x,e.bl.y);return d.x>b.x&&f.x<
a.x&&d.y>b.y&&e.y<a.y},getBoundingRectWidth:function(){return this.getBoundingRect().width},getBoundingRectHeight:function(){return this.getBoundingRect().height},getBoundingRect:function(){this.oCoords||this.setCoords();var b=[this.oCoords.tl.x,this.oCoords.tr.x,this.oCoords.br.x,this.oCoords.bl.x],a=fabric.util.array.min(b),b=fabric.util.array.max(b),b=Math.abs(a-b),e=[this.oCoords.tl.y,this.oCoords.tr.y,this.oCoords.br.y,this.oCoords.bl.y],d=fabric.util.array.min(e),e=fabric.util.array.max(e),
e=Math.abs(d-e);return{left:a,top:d,width:b,height:e}},getWidth:function(){return this.width*this.scaleX},getHeight:function(){return this.height*this.scaleY},_constrainScale:function(b){return Math.abs(b)<this.minScaleLimit?0>b?-this.minScaleLimit:this.minScaleLimit:b},scale:function(b){b=this._constrainScale(b);0>b&&(this.flipX=!this.flipX,this.flipY=!this.flipY,b*=-1);this.scaleY=this.scaleX=b;this.setCoords();return this},scaleToWidth:function(b){var a=this.getBoundingRectWidth()/this.getWidth();
return this.scale(b/this.width/a)},scaleToHeight:function(b){var a=this.getBoundingRectHeight()/this.getHeight();return this.scale(b/this.height/a)},setCoords:function(){var c=1<this.strokeWidth?this.strokeWidth:0,a=this.padding,e=b(this.angle);this.currentWidth=(this.width+c)*this.scaleX+2*a;this.currentHeight=(this.height+c)*this.scaleY+2*a;0>this.currentWidth&&(this.currentWidth=Math.abs(this.currentWidth));var c=Math.sqrt(Math.pow(this.currentWidth/2,2)+Math.pow(this.currentHeight/2,2)),d=Math.atan(this.currentHeight/
this.currentWidth),a=Math.cos(d+e)*c,d=Math.sin(d+e)*c,c=Math.sin(e),e=Math.cos(e),f=this.getCenterPoint(),a={x:f.x-a,y:f.y-d},d={x:a.x+this.currentWidth*e,y:a.y+this.currentWidth*c},f={x:a.x-this.currentHeight*c,y:a.y+this.currentHeight*e};this.oCoords={tl:a,tr:d,br:{x:d.x-this.currentHeight*c,y:d.y+this.currentHeight*e},bl:f,ml:{x:a.x-this.currentHeight/2*c,y:a.y+this.currentHeight/2*e},mt:{x:a.x+this.currentWidth/2*e,y:a.y+this.currentWidth/2*c},mr:{x:d.x-this.currentHeight/2*c,y:d.y+this.currentHeight/
2*e},mb:{x:f.x+this.currentWidth/2*e,y:f.y+this.currentWidth/2*c},mtr:{x:a.x+this.currentWidth/2*e,y:a.y+this.currentWidth/2*c}};this._setCornerCoords();return this}})})();
(function(){var b=fabric.util.getPointer,c=fabric.util.degreesToRadians;fabric.util.object.extend(fabric.Object.prototype,{_findTargetCorner:function(a,c){if(!this.hasControls||!this.active)return!1;var d=b(a,this.canvas.upperCanvasEl),f=d.x-c.left,d=d.y-c.top,g,h;for(h in this.oCoords)if("mtr"!==h||this.hasRotatingPoint)if(!this.get("lockUniScaling")||!("mt"===h||"mr"===h||"mb"===h||"ml"===h))if(g=this._getImageLines(this.oCoords[h].corner,h),g=this._findCrossPoints(f,d,g),1===g%2&&0!==g)return this.__corner=
h;return!1},_findCrossPoints:function(a,b,c){var f,g,h,m=0,s;for(s in c)if(h=c[s],!(h.o.y<b&&h.d.y<b)&&!(h.o.y>=b&&h.d.y>=b)&&(h.o.x===h.d.x&&h.o.x>=a?f=h.o.x:(f=(h.d.y-h.o.y)/(h.d.x-h.o.x),g=b-0*a,h=h.o.y-f*h.o.x,f=-(g-h)/(0-f)),f>=a&&(m+=1),2===m))break;return m},_getImageLines:function(a){return{topline:{o:a.tl,d:a.tr},rightline:{o:a.tr,d:a.br},bottomline:{o:a.br,d:a.bl},leftline:{o:a.bl,d:a.tl}}},_setCornerCoords:function(){var a=this.oCoords,b=c(this.angle),d=c(45-this.angle),f=Math.sqrt(2*Math.pow(this.cornerSize,
2))/2,g=f*Math.cos(d),d=f*Math.sin(d),f=Math.sin(b),b=Math.cos(b);a.tl.corner={tl:{x:a.tl.x-d,y:a.tl.y-g},tr:{x:a.tl.x+g,y:a.tl.y-d},bl:{x:a.tl.x-g,y:a.tl.y+d},br:{x:a.tl.x+d,y:a.tl.y+g}};a.tr.corner={tl:{x:a.tr.x-d,y:a.tr.y-g},tr:{x:a.tr.x+g,y:a.tr.y-d},br:{x:a.tr.x+d,y:a.tr.y+g},bl:{x:a.tr.x-g,y:a.tr.y+d}};a.bl.corner={tl:{x:a.bl.x-d,y:a.bl.y-g},bl:{x:a.bl.x-g,y:a.bl.y+d},br:{x:a.bl.x+d,y:a.bl.y+g},tr:{x:a.bl.x+g,y:a.bl.y-d}};a.br.corner={tr:{x:a.br.x+g,y:a.br.y-d},bl:{x:a.br.x-g,y:a.br.y+d},br:{x:a.br.x+
d,y:a.br.y+g},tl:{x:a.br.x-d,y:a.br.y-g}};a.ml.corner={tl:{x:a.ml.x-d,y:a.ml.y-g},tr:{x:a.ml.x+g,y:a.ml.y-d},bl:{x:a.ml.x-g,y:a.ml.y+d},br:{x:a.ml.x+d,y:a.ml.y+g}};a.mt.corner={tl:{x:a.mt.x-d,y:a.mt.y-g},tr:{x:a.mt.x+g,y:a.mt.y-d},bl:{x:a.mt.x-g,y:a.mt.y+d},br:{x:a.mt.x+d,y:a.mt.y+g}};a.mr.corner={tl:{x:a.mr.x-d,y:a.mr.y-g},tr:{x:a.mr.x+g,y:a.mr.y-d},bl:{x:a.mr.x-g,y:a.mr.y+d},br:{x:a.mr.x+d,y:a.mr.y+g}};a.mb.corner={tl:{x:a.mb.x-d,y:a.mb.y-g},tr:{x:a.mb.x+g,y:a.mb.y-d},bl:{x:a.mb.x-g,y:a.mb.y+d},
br:{x:a.mb.x+d,y:a.mb.y+g}};a.mtr.corner={tl:{x:a.mtr.x-d+f*this.rotatingPointOffset,y:a.mtr.y-g-b*this.rotatingPointOffset},tr:{x:a.mtr.x+g+f*this.rotatingPointOffset,y:a.mtr.y-d-b*this.rotatingPointOffset},bl:{x:a.mtr.x-g+f*this.rotatingPointOffset,y:a.mtr.y+d-b*this.rotatingPointOffset},br:{x:a.mtr.x+d+f*this.rotatingPointOffset,y:a.mtr.y+g-b*this.rotatingPointOffset}}},drawBorders:function(a){if(this.hasBorders){var b=this.padding,c=2*b,f=1<this.strokeWidth?this.strokeWidth:0;a.save();a.globalAlpha=
this.isMoving?this.borderOpacityWhenMoving:1;a.strokeStyle=this.borderColor;var g=1/this._constrainScale(this.scaleX),h=1/this._constrainScale(this.scaleY);a.lineWidth=1/this.borderScaleFactor;a.scale(g,h);g=this.getWidth();h=this.getHeight();a.strokeRect(~~(-(g/2)-b-f/2*this.scaleX)+0.5,~~(-(h/2)-b-f/2*this.scaleY)+0.5,~~(g+c+f*this.scaleX),~~(h+c+f*this.scaleY));this.hasRotatingPoint&&(!this.get("lockRotation")&&this.hasControls)&&(b=(this.flipY?h+f*this.scaleY+2*b:-h-f*this.scaleY-2*b)/2,a.beginPath(),
a.moveTo(0,b),a.lineTo(0,b+(this.flipY?this.rotatingPointOffset:-this.rotatingPointOffset)),a.closePath(),a.stroke());a.restore();return this}},drawCorners:function(a){if(this.hasControls){var b=this.cornerSize,c=b/2,f=this.strokeWidth/2,g=-(this.width/2),h=-(this.height/2),m=b/this.scaleX,s=b/this.scaleY,t=this.padding/this.scaleX,q=this.padding/this.scaleY,u=c/this.scaleY,r=c/this.scaleX,v=(c-b)/this.scaleX,w=(c-b)/this.scaleY,z=this.height,x=this.width,A=this.transparentCorners?"strokeRect":"fillRect",
B="undefined"!==typeof G_vmlCanvasManager;a.save();a.lineWidth=1/Math.max(this.scaleX,this.scaleY);a.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1;a.strokeStyle=a.fillStyle=this.cornerColor;b=g-r-f-t;c=h-u-f-q;B||a.clearRect(b,c,m,s);a[A](b,c,m,s);b=g+x-r+f+t;c=h-u-f-q;B||a.clearRect(b,c,m,s);a[A](b,c,m,s);b=g-r-f-t;c=h+z+w+f+q;B||a.clearRect(b,c,m,s);a[A](b,c,m,s);b=g+x+v+f+t;c=h+z+w+f+q;B||a.clearRect(b,c,m,s);a[A](b,c,m,s);this.get("lockUniScaling")||(b=g+x/2-r,c=h-u-f-q,B||a.clearRect(b,
c,m,s),a[A](b,c,m,s),b=g+x/2-r,c=h+z+w+f+q,B||a.clearRect(b,c,m,s),a[A](b,c,m,s),b=g+x+v+f+t,c=h+z/2-u,B||a.clearRect(b,c,m,s),a[A](b,c,m,s),b=g-r-f-t,c=h+z/2-u,B||a.clearRect(b,c,m,s),a[A](b,c,m,s));this.hasRotatingPoint&&(b=g+x/2-r,c=this.flipY?h+z+this.rotatingPointOffset/this.scaleY-s/2+f+q:h-this.rotatingPointOffset/this.scaleY-s/2-f-q,B||a.clearRect(b,c,m,s),a[A](b,c,m,s));a.restore();return this}}})})();
(function(b){var c=b.fabric||(b.fabric={}),a=c.util.object.extend,e={x1:1,x2:1,y1:1,y2:1};c.Line?c.warn("fabric.Line is already defined"):(c.Line=c.util.createClass(c.Object,{type:"line",initialize:function(a,b){b=b||{};a||(a=[0,0,0,0]);this.callSuper("initialize",b);this.set("x1",a[0]);this.set("y1",a[1]);this.set("x2",a[2]);this.set("y2",a[3]);this._setWidthHeight(b)},_setWidthHeight:function(a){a||(a={});this.set("width",this.x2-this.x1||1);this.set("height",this.y2-this.y1||1);this.set("left",
"left"in a?a.left:this.x1+this.width/2);this.set("top","top"in a?a.top:this.y1+this.height/2)},_set:function(a,b){this[a]=b;a in e&&this._setWidthHeight();return this},_render:function(a){a.beginPath();this.group&&a.translate(-this.group.width/2+this.left,-this.group.height/2+this.top);a.moveTo(1===this.width?0:-this.width/2,1===this.height?0:-this.height/2);a.lineTo(1===this.width?0:this.width/2,1===this.height?0:this.height/2);a.lineWidth=this.strokeWidth;var b=a.strokeStyle;a.strokeStyle=a.fillStyle;
a.stroke();a.strokeStyle=b},complexity:function(){return 1},toObject:function(b){return a(this.callSuper("toObject",b),{x1:this.get("x1"),y1:this.get("y1"),x2:this.get("x2"),y2:this.get("y2")})},toSVG:function(){return['<line x1="',this.get("x1"),'" y1="',this.get("y1"),'" x2="',this.get("x2"),'" y2="',this.get("y2"),'" style="',this.getSvgStyles(),'" />'].join("")}}),c.Line.ATTRIBUTE_NAMES="x1 y1 x2 y2 stroke stroke-width transform".split(" "),c.Line.fromElement=function(b,e){var g=c.parseAttributes(b,
c.Line.ATTRIBUTE_NAMES);return new c.Line([g.x1||0,g.y1||0,g.x2||0,g.y2||0],a(g,e))},c.Line.fromObject=function(a){return new c.Line([a.x1,a.y1,a.x2,a.y2],a)})})("undefined"!==typeof exports?exports:this);
(function(b){var c=b.fabric||(b.fabric={}),a=2*Math.PI,e=c.util.object.extend;c.Circle?c.warn("fabric.Circle is already defined."):(c.Circle=c.util.createClass(c.Object,{type:"circle",initialize:function(a){a=a||{};this.set("radius",a.radius||0);this.callSuper("initialize",a);a=2*this.get("radius");this.set("width",a).set("height",a)},toObject:function(a){return e(this.callSuper("toObject",a),{radius:this.get("radius")})},toSVG:function(){return'<circle cx="0" cy="0" r="'+this.radius+'" style="'+
this.getSvgStyles()+'" transform="'+this.getSvgTransform()+'" />'},_render:function(b,c){b.beginPath();b.globalAlpha=this.group?b.globalAlpha*this.opacity:this.opacity;b.arc(c?this.left:0,c?this.top:0,this.radius,0,a,!1);b.closePath();this.fill&&b.fill();this._removeShadow(b);this.stroke&&b.stroke()},getRadiusX:function(){return this.get("radius")*this.get("scaleX")},getRadiusY:function(){return this.get("radius")*this.get("scaleY")},setRadius:function(a){this.radius=a;this.set("width",2*a).set("height",
2*a)},complexity:function(){return 1}}),c.Circle.ATTRIBUTE_NAMES="cx cy r fill fill-opacity opacity stroke stroke-width transform".split(" "),c.Circle.fromElement=function(a,b){b||(b={});var g=c.parseAttributes(a,c.Circle.ATTRIBUTE_NAMES);if(!("radius"in g&&0<g.radius))throw Error("value of `r` attribute is required and can not be negative");"left"in g&&(g.left-=b.width/2||0);"top"in g&&(g.top-=b.height/2||0);g=new c.Circle(e(g,b));g.cx=parseFloat(a.getAttribute("cx"))||0;g.cy=parseFloat(a.getAttribute("cy"))||
0;return g},c.Circle.fromObject=function(a){return new c.Circle(a)})})("undefined"!==typeof exports?exports:this);
(function(b){var c=b.fabric||(b.fabric={});c.Triangle?c.warn("fabric.Triangle is already defined"):(c.Triangle=c.util.createClass(c.Object,{type:"triangle",initialize:function(a){a=a||{};this.callSuper("initialize",a);this.set("width",a.width||100).set("height",a.height||100)},_render:function(a){var b=this.width/2,c=this.height/2;a.beginPath();a.moveTo(-b,c);a.lineTo(0,-c);a.lineTo(b,c);a.closePath();this.fill&&a.fill();this.stroke&&a.stroke()},complexity:function(){return 1},toSVG:function(){var a=
this.width/2,b=this.height/2;return'<polygon points="'+[-a+" "+b,"0 "+-b,a+" "+b].join()+'" style="'+this.getSvgStyles()+'" transform="'+this.getSvgTransform()+'" />'}}),c.Triangle.fromObject=function(a){return new c.Triangle(a)})})("undefined"!==typeof exports?exports:this);
(function(b){var c=b.fabric||(b.fabric={}),a=2*Math.PI,e=c.util.object.extend;c.Ellipse?c.warn("fabric.Ellipse is already defined."):(c.Ellipse=c.util.createClass(c.Object,{type:"ellipse",initialize:function(a){a=a||{};this.callSuper("initialize",a);this.set("rx",a.rx||0);this.set("ry",a.ry||0);this.set("width",2*this.get("rx"));this.set("height",2*this.get("ry"))},toObject:function(a){return e(this.callSuper("toObject",a),{rx:this.get("rx"),ry:this.get("ry")})},toSVG:function(){return['<ellipse rx="',
this.get("rx"),'" ry="',this.get("ry"),'" style="',this.getSvgStyles(),'" transform="',this.getSvgTransform(),'" />'].join("")},render:function(a,b){if(!(0===this.rx||0===this.ry))return this.callSuper("render",a,b)},_render:function(b,c){b.beginPath();b.save();b.globalAlpha=this.group?b.globalAlpha*this.opacity:this.opacity;this.transformMatrix&&this.group&&b.translate(this.cx,this.cy);b.transform(1,0,0,this.ry/this.rx,0,0);b.arc(c?this.left:0,c?this.top:0,this.rx,0,a,!1);this.stroke&&b.stroke();
this._removeShadow(b);this.fill&&b.fill();b.restore()},complexity:function(){return 1}}),c.Ellipse.ATTRIBUTE_NAMES="cx cy rx ry fill fill-opacity opacity stroke stroke-width transform".split(" "),c.Ellipse.fromElement=function(a,b){b||(b={});var g=c.parseAttributes(a,c.Ellipse.ATTRIBUTE_NAMES),h=g.left,m=g.top;"left"in g&&(g.left-=b.width/2||0);"top"in g&&(g.top-=b.height/2||0);g=new c.Ellipse(e(g,b));g.cx=h||0;g.cy=m||0;return g},c.Ellipse.fromObject=function(a){return new c.Ellipse(a)})})("undefined"!==
typeof exports?exports:this);
(function(b){var c=b.fabric||(b.fabric={}),a=c.util.object.extend;c.Rect?console.warn("fabric.Rect is already defined"):(c.Rect=c.util.createClass(c.Object,{type:"rect",rx:0,ry:0,initialize:function(a){a=a||{};this._initStateProperties();this.callSuper("initialize",a);this._initRxRy();this.y=this.x=0},_initStateProperties:function(){this.stateProperties=this.stateProperties.concat(["rx","ry"])},_initRxRy:function(){this.rx&&!this.ry?this.ry=this.rx:this.ry&&!this.rx&&(this.rx=this.ry)},_render:function(a){var b=
this.rx||0,c=this.ry||0,g=-this.width/2,h=-this.height/2,m=this.width,s=this.height;a.beginPath();a.globalAlpha=this.group?a.globalAlpha*this.opacity:this.opacity;this.transformMatrix&&this.group&&a.translate(this.width/2+this.x,this.height/2+this.y);!this.transformMatrix&&this.group&&a.translate(-this.group.width/2+this.width/2+this.x,-this.group.height/2+this.height/2+this.y);a.moveTo(g+b,h);a.lineTo(g+m-b,h);a.quadraticCurveTo(g+m,h,g+m,h+c,g+m,h+c);a.lineTo(g+m,h+s-c);a.quadraticCurveTo(g+m,h+
s,g+m-b,h+s,g+m-b,h+s);a.lineTo(g+b,h+s);a.quadraticCurveTo(g,h+s,g,h+s-c,g,h+s-c);a.lineTo(g,h+c);a.quadraticCurveTo(g,h,g+b,h,g+b,h);a.closePath();this.fill&&a.fill();this._removeShadow(a);this.strokeDashArray?this._renderDashedStroke(a):this.stroke&&a.stroke()},_renderDashedStroke:function(a){function b(d,u){for(var r=0,v=0,w=(u?m.height:m.width)+2*s;r<w;){var z=m.strokeDashArray[c++],r=r+z;r>w&&(v=r-w);d?g+=z*d-(v*d||0):h+=z*u-(v*u||0);a[1&c?"moveTo":"lineTo"](g,h);c>=t&&(c=0)}}1&this.strokeDashArray.length&&
this.strokeDashArray.push.apply(this.strokeDashArray,this.strokeDashArray);var c=0,g=-this.width/2,h=-this.height/2,m=this,s=this.padding,t=this.strokeDashArray.length;a.save();a.beginPath();b(1,0);b(0,1);b(-1,0);b(0,-1);a.stroke();a.closePath();a.restore()},_normalizeLeftTopProperties:function(a){a.left&&this.set("left",a.left+this.getWidth()/2);this.set("x",a.left||0);a.top&&this.set("top",a.top+this.getHeight()/2);this.set("y",a.top||0);return this},complexity:function(){return 1},toObject:function(b){return a(this.callSuper("toObject",
b),{rx:this.get("rx")||0,ry:this.get("ry")||0})},toSVG:function(){return'<rect x="'+-1*this.width/2+'" y="'+-1*this.height/2+'" rx="'+this.get("rx")+'" ry="'+this.get("ry")+'" width="'+this.width+'" height="'+this.height+'" style="'+this.getSvgStyles()+'" transform="'+this.getSvgTransform()+'" />'}}),c.Rect.ATTRIBUTE_NAMES="x y width height rx ry fill fill-opacity opacity stroke stroke-width transform".split(" "),c.Rect.fromElement=function(b,d){if(!b)return null;var f=c.parseAttributes(b,c.Rect.ATTRIBUTE_NAMES);
f.left=f.left||0;f.top=f.top||0;var g=new c.Rect(a(d?c.util.object.clone(d):{},f));g._normalizeLeftTopProperties(f);return g},c.Rect.fromObject=function(a){return new c.Rect(a)})})("undefined"!==typeof exports?exports:this);
(function(b){var c=b.fabric||(b.fabric={}),a=c.util.toFixed;c.Polyline?c.warn("fabric.Polyline is already defined"):(c.Polyline=c.util.createClass(c.Object,{type:"polyline",initialize:function(a,b){b=b||{};this.set("points",a);this.callSuper("initialize",b);this._calcDimensions()},_calcDimensions:function(){return c.Polygon.prototype._calcDimensions.call(this)},toObject:function(a){return c.Polygon.prototype.toObject.call(this,a)},toSVG:function(){for(var b=[],c=0,f=this.points.length;c<f;c++)b.push(a(this.points[c].x,
2),",",a(this.points[c].y,2)," ");return['<polyline points="',b.join(""),'" style="',this.getSvgStyles(),'" transform="',this.getSvgTransform(),'" />'].join("")},_render:function(a){var b;a.beginPath();a.moveTo(this.points[0].x,this.points[0].y);for(var c=0,g=this.points.length;c<g;c++)b=this.points[c],a.lineTo(b.x,b.y);this.fill&&a.fill();this._removeShadow(a);this.stroke&&a.stroke()},complexity:function(){return this.get("points").length}}),c.Polyline.ATTRIBUTE_NAMES="fill fill-opacity opacity stroke stroke-width transform".split(" "),
c.Polyline.fromElement=function(a,b){if(!a)return null;b||(b={});for(var f=c.parsePointsAttribute(a.getAttribute("points")),g=c.parseAttributes(a,c.Polyline.ATTRIBUTE_NAMES),h=0,m=f.length;h<m;h++)f[h].x-=b.width/2||0,f[h].y-=b.height/2||0;return new c.Polyline(f,c.util.object.extend(g,b))},c.Polyline.fromObject=function(a){return new c.Polyline(a.points,a)})})("undefined"!==typeof exports?exports:this);
(function(b){var c=b.fabric||(b.fabric={}),a=c.util.object.extend,e=c.util.array.min,d=c.util.array.max,f=c.util.toFixed;c.Polygon?c.warn("fabric.Polygon is already defined"):(c.Polygon=c.util.createClass(c.Object,{type:"polygon",initialize:function(a,b){b=b||{};this.points=a;this.callSuper("initialize",b);this._calcDimensions()},_calcDimensions:function(){var a=this.points,b=e(a,"x"),c=e(a,"y"),f=d(a,"x"),a=d(a,"y");this.width=f-b||1;this.height=a-c||1;var t=this.width/2,q=this.height/2;this.points.forEach(function(a){a.x-=
t;a.y-=q},this);this.minX=b;this.minY=c},toObject:function(b){return a(this.callSuper("toObject",b),{points:this.points.concat()})},toSVG:function(){for(var a=[],b=0,c=this.points.length;b<c;b++)a.push(f(this.points[b].x,2),",",f(this.points[b].y,2)," ");return['<polygon points="',a.join(""),'" style="',this.getSvgStyles(),'" transform="',this.getSvgTransform(),'" />'].join("")},_render:function(a){var b;a.beginPath();a.moveTo(this.points[0].x,this.points[0].y);for(var c=0,d=this.points.length;c<
d;c++)b=this.points[c],a.lineTo(b.x,b.y);this.fill&&a.fill();this._removeShadow(a);this.stroke&&(a.closePath(),a.stroke())},complexity:function(){return this.points.length}}),c.Polygon.ATTRIBUTE_NAMES="fill fill-opacity opacity stroke stroke-width transform".split(" "),c.Polygon.fromElement=function(b,d){if(!b)return null;d||(d={});for(var e=c.parsePointsAttribute(b.getAttribute("points")),f=c.parseAttributes(b,c.Polygon.ATTRIBUTE_NAMES),t=0,q=e.length;t<q;t++)e[t].x-=d.width/2||0,e[t].y-=d.height/
2||0;return new c.Polygon(e,a(f,d))},c.Polygon.fromObject=function(a){return new c.Polygon(a.points,a)})})("undefined"!==typeof exports?exports:this);
(function(b){function c(b,c,d,f){c=a(f[5],f[6],f[0],f[1],f[3],f[4],f[2],c,d);for(d=0;d<c.length;d++)f=e.apply(this,c[d]),b.bezierCurveTo.apply(b,f)}function a(a,b,c,d,e,f,g,m,q){t=s.call(arguments);if(h[t])return h[t];var r=g*(Math.PI/180),u=Math.sin(r),r=Math.cos(r);c=Math.abs(c);d=Math.abs(d);var v=0.5*r*(m-a)+0.5*u*(q-b),w=0.5*r*(q-b)-0.5*u*(m-a),v=v*v/(c*c)+w*w/(d*d);1<v&&(v=Math.sqrt(v),c*=v,d*=v);var y=r/c,E=u/c,L=-u/d,M=r/d,v=y*m+E*q,w=L*m+M*q,y=y*a+E*b,E=L*a+M*b,L=1/((y-v)*(y-v)+(E-w)*(E-
w))-0.25;0>L&&(L=0);M=Math.sqrt(L);f===e&&(M=-M);L=0.5*(v+y)-M*(E-w);M=0.5*(w+E)+M*(y-v);v=Math.atan2(w-M,v-L);w=Math.atan2(E-M,y-L)-v;0>w&&1===f?w+=2*Math.PI:0<w&&0===f&&(w-=2*Math.PI);for(var y=Math.ceil(Math.abs(w/(0.5*Math.PI+0.0010))),E=[],Q=0;Q<y;Q++)E[Q]=[L,M,v+Q*w/y,v+(Q+1)*w/y,c,d,u,r];return h[t]=E}function e(a,b,c,d,e,f,g,h){t=s.call(arguments);if(m[t])return m[t];var q=h*e,r=-g*f,u=g*e,v=h*f,w=0.5*(d-c),y=8/3*Math.sin(0.5*w)*Math.sin(0.5*w)/Math.sin(w),w=a+Math.cos(c)-y*Math.sin(c),E=
b+Math.sin(c)+y*Math.cos(c),L=a+Math.cos(d),M=b+Math.sin(d),Q=L+y*Math.sin(d),y=M-y*Math.cos(d);return m[t]=[q*w+r*E,u*w+v*E,q*Q+r*y,u*Q+v*y,q*L+r*M,u*L+v*M]}function d(a){return"H"===a[0]?a[1]:a[a.length-2]}function f(a){return"V"===a[0]?a[1]:a[a.length-1]}var g={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},h={},m={},s=Array.prototype.join,t;"use strict";var q=b.fabric||(b.fabric={}),u=q.util.array.min,r=q.util.array.max,v=q.util.object.extend,w=Object.prototype.toString;q.Path?q.warn("fabric.Path is already defined"):
(q.Path=q.util.createClass(q.Object,{type:"path",initialize:function(a,b){b=b||{};this.setOptions(b);if(!a)throw Error("`path` argument is required");var c="[object Array]"===w.call(a);if(this.path=c?a:a.match&&a.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi))c||(this.path=this._parsePath()),this._initializePath(b),b.sourcePath&&this.setSourcePath(b.sourcePath)},_initializePath:function(a){var b="width"in a,c="height"in a,d="left"in a,e="top"in a;!b||!c?(v(this,this._parseDimensions()),b&&(this.width=a.width),
c&&(this.height=a.height)):(e||(this.top=this.height/2),d||(this.left=this.width/2));this.pathOffset=this._calculatePathOffset(e||d)},_calculatePathOffset:function(a){return{x:a?0:this.left-this.width/2,y:a?0:this.top-this.height/2}},_render:function(a){for(var b,d=null,e=0,f=0,g=0,h=0,m,s,q,r,t=-(this.width/2+this.pathOffset.x),u=-(this.height/2+this.pathOffset.y),v=0,w=this.path.length;v<w;++v){b=this.path[v];switch(b[0]){case "l":e+=b[1];f+=b[2];a.lineTo(e+t,f+u);break;case "L":e=b[1];f=b[2];a.lineTo(e+
t,f+u);break;case "h":e+=b[1];a.lineTo(e+t,f+u);break;case "H":e=b[1];a.lineTo(e+t,f+u);break;case "v":f+=b[1];a.lineTo(e+t,f+u);break;case "V":f=b[1];a.lineTo(e+t,f+u);break;case "m":e+=b[1];f+=b[2];a[d&&("m"===d[0]||"M"===d[0])?"lineTo":"moveTo"](e+t,f+u);break;case "M":e=b[1];f=b[2];a[d&&("m"===d[0]||"M"===d[0])?"lineTo":"moveTo"](e+t,f+u);break;case "c":m=e+b[5];s=f+b[6];g=e+b[3];h=f+b[4];a.bezierCurveTo(e+b[1]+t,f+b[2]+u,g+t,h+u,m+t,s+u);e=m;f=s;break;case "C":e=b[5];f=b[6];g=b[3];h=b[4];a.bezierCurveTo(b[1]+
t,b[2]+u,g+t,h+u,e+t,f+u);break;case "s":m=e+b[3];s=f+b[4];g=g?2*e-g:e;h=h?2*f-h:f;a.bezierCurveTo(g+t,h+u,e+b[1]+t,f+b[2]+u,m+t,s+u);g=e+b[1];h=f+b[2];e=m;f=s;break;case "S":m=b[3];s=b[4];g=2*e-g;h=2*f-h;a.bezierCurveTo(g+t,h+u,b[1]+t,b[2]+u,m+t,s+u);e=m;f=s;g=b[1];h=b[2];break;case "q":m=e+b[3];s=f+b[4];g=e+b[1];h=f+b[2];a.quadraticCurveTo(g+t,h+u,m+t,s+u);e=m;f=s;break;case "Q":m=b[3];s=b[4];a.quadraticCurveTo(b[1]+t,b[2]+u,m+t,s+u);e=m;f=s;g=b[1];h=b[2];break;case "t":m=e+b[1];s=f+b[2];null===
d[0].match(/[QqTt]/)?(g=e,h=f):"t"===d[0]?(g=2*e-q,h=2*f-r):"q"===d[0]&&(g=2*e-g,h=2*f-h);q=g;r=h;a.quadraticCurveTo(g+t,h+u,m+t,s+u);e=m;f=s;g=e+b[1];h=f+b[2];break;case "T":m=b[1];s=b[2];g=2*e-g;h=2*f-h;a.quadraticCurveTo(g+t,h+u,m+t,s+u);e=m;f=s;break;case "a":c(a,e+t,f+u,[b[1],b[2],b[3],b[4],b[5],b[6]+e+t,b[7]+f+u]);e+=b[6];f+=b[7];break;case "A":c(a,e+t,f+u,[b[1],b[2],b[3],b[4],b[5],b[6]+t,b[7]+u]);e=b[6];f=b[7];break;case "z":case "Z":a.closePath()}d=b}},render:function(a,b){a.save();var c=
this.transformMatrix;c&&a.transform(c[0],c[1],c[2],c[3],c[4],c[5]);b||this.transform(a);this.overlayFill?a.fillStyle=this.overlayFill:this.fill&&(a.fillStyle=this.fill.toLive?this.fill.toLive(a):this.fill);this.stroke&&(a.strokeStyle=this.stroke.toLive?this.stroke.toLive(a):this.stroke);a.beginPath();this._setShadow(a);this._render(a);this.fill&&a.fill();this._removeShadow(a);this.stroke&&(a.strokeStyle=this.stroke,a.lineWidth=this.strokeWidth,a.lineCap=a.lineJoin="round",a.stroke());!b&&this.active&&
(this.drawBorders(a),this.hideCorners||this.drawCorners(a));a.restore()},toString:function(){return"#<fabric.Path ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:function(a){a=v(this.callSuper("toObject",a),{path:this.path});this.sourcePath&&(a.sourcePath=this.sourcePath);this.transformMatrix&&(a.transformMatrix=this.transformMatrix);return a},toDatalessObject:function(a){a=this.toObject(a);this.sourcePath&&(a.path=this.sourcePath);delete a.sourcePath;return a},
toSVG:function(){for(var a=[],b=0,c=this.path.length;b<c;b++)a.push(this.path[b].join(" "));a=a.join(" ");return['<g transform="',this.group?"":this.getSvgTransform(),'"><path width="',this.width,'" height="',this.height,'" d="',a,'" style="',this.getSvgStyles(),'" transform="translate(',-this.width/2," ",-this.height/2,')" /></g>'].join("")},complexity:function(){return this.path.length},_parsePath:function(){for(var a=[],b,c,d,e=0,f=this.path.length;e<f;e++){b=this.path[e];c=b.slice(1).trim().replace(/(\d)-/g,
"$1###-").split(/\s|,|###/);b=[b.charAt(0)];for(var h=0,m=c.length;h<m;h++)d=parseFloat(c[h]),isNaN(d)||b.push(d);c=b[0].toLowerCase();c=g[c];if(b.length-1>c){d=1;for(h=b.length;d<h;d+=c)a.push([b[0]].concat(b.slice(d,d+c)))}else a.push(b)}return a},_parseDimensions:function(){var a=[],b=[],c,e,g=!1,h,m;this.path.forEach(function(s,q){"H"!==s[0]&&(c=0===q?d(s):d(this.path[q-1]));"V"!==s[0]&&(e=0===q?f(s):f(this.path[q-1]));s[0]===s[0].toLowerCase()&&(g=!0);h=g?c+d(s):"V"===s[0]?c:d(s);m=g?e+f(s):
"H"===s[0]?e:f(s);var r=parseInt(h,10);isNaN(r)||a.push(r);r=parseInt(m,10);isNaN(r)||b.push(r)},this);var s=u(a),q=u(b),t=r(a),v=r(b),t=t-s,v=v-q,s={top:q+v/2,left:s+t/2,bottom:r(b)-v,right:r(a)-t};s.width=t;s.height=v;return s}}),q.Path.fromObject=function(a){return new q.Path(a.path,a)},q.Path.ATTRIBUTE_NAMES="d fill fill-opacity opacity fill-rule stroke stroke-width transform".split(" "),q.Path.fromElement=function(a,b){var c=q.parseAttributes(a,q.Path.ATTRIBUTE_NAMES);return new q.Path(c.d,v(c,
b))})})("undefined"!==typeof exports?exports:this);
(function(b){var c=b.fabric||(b.fabric={}),a=c.util.object.extend,e=c.util.array.invoke,d=c.Object.prototype.toObject,f=c.util.string.camelize,g=c.util.string.capitalize;c.PathGroup?c.warn("fabric.PathGroup is already defined"):(c.PathGroup=c.util.createClass(c.Path,{type:"path-group",fill:"",initialize:function(a,b){b=b||{};this.paths=a||[];for(var c=this.paths.length;c--;)this.paths[c].group=this;this.setOptions(b);this.setCoords();b.sourcePath&&this.setSourcePath(b.sourcePath)},render:function(a){a.save();
var b=this.transformMatrix;b&&a.transform(b[0],b[1],b[2],b[3],b[4],b[5]);this.transform(a);this._setShadow(a);for(var b=0,c=this.paths.length;b<c;++b)this.paths[b].render(a,!0);this._removeShadow(a);this.active&&(this.drawBorders(a),this.hideCorners||this.drawCorners(a));a.restore()},_set:function(a,b){if(("fill"===a||"overlayFill"===a)&&b&&this.isSameColor())for(var c=this.paths.length;c--;)this.paths[c]._set(a,b);return this.callSuper("_set",a,b)},toObject:function(b){return a(d.call(this,b),{paths:e(this.getObjects(),
"toObject",b),sourcePath:this.sourcePath})},toDatalessObject:function(a){a=this.toObject(a);this.sourcePath&&(a.paths=this.sourcePath);return a},toSVG:function(){for(var a=this.getObjects(),b=["<g ",'width="',this.width,'" ','height="',this.height,'" ','style="',this.getSvgStyles(),'" ','transform="',this.getSvgTransform(),'" ',">"],c=0,d=a.length;c<d;c++)b.push(a[c].toSVG());b.push("</g>");return b.join("")},toString:function(){return"#<fabric.PathGroup ("+this.complexity()+"): { top: "+this.top+
", left: "+this.left+" }>"},isSameColor:function(){var a=this.getObjects()[0].get("fill");return this.getObjects().every(function(b){return b.get("fill")===a})},complexity:function(){return this.paths.reduce(function(a,b){return a+(b&&b.complexity?b.complexity():0)},0)},toGrayscale:function(){for(var a=this.paths.length;a--;)this.paths[a].toGrayscale();return this},getObjects:function(){return this.paths}}),c.PathGroup.fromObject=function(a){for(var b=a.paths,d=0,e=b.length;d<e;d++)if(!(b[d]instanceof
c.Object)){var q=f(g(b[d].type));b[d]=c[q].fromObject(b[d])}return new c.PathGroup(b,a)})})("undefined"!==typeof exports?exports:this);
(function(b){var c=b.fabric||(b.fabric={}),a=c.util.object.extend,e=c.util.array.min,d=c.util.array.max,f=c.util.array.invoke,g=c.util.removeFromArray;if(!c.Group){var h={lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0};c.Group=c.util.createClass(c.Object,{type:"group",initialize:function(b,c){c=c||{};this.objects=b||[];this.originalState={};this.callSuper("initialize");this._calcBounds();this._updateObjectsCoords();c&&a(this,c);this._setOpacityIfSame();
this.setCoords(!0);this.saveCoords()},_updateObjectsCoords:function(){var a=this.left,b=this.top;this.forEachObject(function(c){var d=c.get("left"),e=c.get("top");c.set("originalLeft",d);c.set("originalTop",e);c.set("left",d-a);c.set("top",e-b);c.setCoords();c.hideCorners=!0},this)},toString:function(){return"#<fabric.Group: ("+this.complexity()+")>"},getObjects:function(){return this.objects},addWithUpdate:function(a){this._restoreObjectsState();this.objects.push(a);this._calcBounds();this._updateObjectsCoords();
return this},removeWithUpdate:function(a){this._restoreObjectsState();g(this.objects,a);a.setActive(!1);this._calcBounds();this._updateObjectsCoords();return this},add:function(a){this.objects.push(a);return this},remove:function(a){g(this.objects,a);return this},size:function(){return this.getObjects().length},delegatedProperties:{fill:!0,opacity:!0,fontFamily:!0,fontWeight:!0,lineHeight:!0,textDecoration:!0,textShadow:!0,backgroundColor:!0},_set:function(a,b){if(a in this.delegatedProperties){var c=
this.objects.length;for(this[a]=b;c--;)this.objects[c].set(a,b)}else this[a]=b},contains:function(a){return-1<this.objects.indexOf(a)},toObject:function(b){return a(this.callSuper("toObject",b),{objects:f(this.objects,"toObject",b)})},render:function(a,b){a.save();this.transform(a);for(var c=Math.max(this.scaleX,this.scaleY),d=this.objects.length;0<d;d--){var e=this.objects[d-1],f=e.borderScaleFactor,g=e.hasRotatingPoint;e.borderScaleFactor=c;e.hasRotatingPoint=!1;e.render(a);e.borderScaleFactor=
f;e.hasRotatingPoint=g}!b&&this.active&&(this.drawBorders(a),this.hideCorners||this.drawCorners(a));a.restore();this.setCoords()},item:function(a){return this.getObjects()[a]},complexity:function(){return this.getObjects().reduce(function(a,b){return a+="function"===typeof b.complexity?b.complexity():0},0)},_restoreObjectsState:function(){this.objects.forEach(this._restoreObjectState,this);return this},_restoreObjectState:function(a){var b=this.get("left"),c=this.get("top"),d=this.getAngle()*(Math.PI/
180),e=Math.cos(d)*a.get("top")+Math.sin(d)*a.get("left"),d=-Math.sin(d)*a.get("top")+Math.cos(d)*a.get("left");a.setAngle(a.getAngle()+this.getAngle());a.set("left",b+d*this.get("scaleX"));a.set("top",c+e*this.get("scaleY"));a.set("scaleX",a.get("scaleX")*this.get("scaleX"));a.set("scaleY",a.get("scaleY")*this.get("scaleY"));a.setCoords();a.hideCorners=!1;a.setActive(!1);a.setCoords();return this},destroy:function(){return this._restoreObjectsState()},saveCoords:function(){this._originalLeft=this.get("left");
this._originalTop=this.get("top");return this},hasMoved:function(){return this._originalLeft!==this.get("left")||this._originalTop!==this.get("top")},setObjectsCoords:function(){this.forEachObject(function(a){a.setCoords()});return this},activateAllObjects:function(){this.forEachObject(function(a){a.setActive()});return this},forEachObject:c.StaticCanvas.prototype.forEachObject,_setOpacityIfSame:function(){var a=this.getObjects(),b=a[0]?a[0].get("opacity"):1;a.every(function(a){return a.get("opacity")===
b})&&(this.opacity=b)},_calcBounds:function(){var a=[],b=[],c,f;f=0;for(var g=this.objects.length;f<g;++f){c=this.objects[f];c.setCoords();for(var h in c.oCoords)a.push(c.oCoords[h].x),b.push(c.oCoords[h].y)}c=e(a);f=d(a);a=e(b);b=d(b);f=f-c||0;b=b-a||0;this.width=f;this.height=b;this.left=c+f/2||0;this.top=a+b/2||0},containsPoint:function(a){var b=this.get("width")/2,c=this.get("height")/2,d=this.get("left"),e=this.get("top");return d-b<a.x&&d+b>a.x&&e-c<a.y&&e+c>a.y},toGrayscale:function(){for(var a=
this.objects.length;a--;)this.objects[a].toGrayscale();return this},toSVG:function(){for(var a=[],b=0,c=this.objects.length;b<c;b++)a.push(this.objects[b].toSVG());return'<g transform="'+this.getSvgTransform()+'">'+a.join("")+"</g>"},get:function(a){if(a in h){if(this[a])return this[a];for(var b=0,c=this.objects.length;b<c;b++)if(this.objects[b][a])return!0;return!1}return this[a]}});c.Group.fromObject=function(a,b){c.util.enlivenObjects(a.objects,function(d){delete a.objects;b&&b(new c.Group(d,a))})};
c.Group.async=!0}})("undefined"!==typeof exports?exports:this);
(function(b){var c=fabric.util.object.extend;b.fabric||(b.fabric={});b.fabric.Image?fabric.warn("fabric.Image is already defined."):(fabric.Image=fabric.util.createClass(fabric.Object,{type:"image",initialize:function(a,b){b||(b={});this.callSuper("initialize",b);this._initElement(a);this._originalImage=this.getElement();this._initConfig(b);this.filters=[];b.filters&&(this.filters=b.filters,this.applyFilters())},getElement:function(){return this._element},setElement:function(a){this._element=a;this._initConfig();
return this},getOriginalSize:function(){var a=this.getElement();return{width:a.width,height:a.height}},render:function(a,b){a.save();var c=this.transformMatrix;this.group&&a.translate(-this.group.width/2+this.width/2,-this.group.height/2+this.height/2);c&&a.transform(c[0],c[1],c[2],c[3],c[4],c[5]);b||this.transform(a);this._setShadow(a);this._render(a);this._removeShadow(a);this.active&&!b&&(this.drawBorders(a),this.hideCorners||this.drawCorners(a));a.restore()},toObject:function(a){return c(this.callSuper("toObject",
a),{src:this._originalImage.src||this._originalImage._src,filters:this.filters.concat()})},toSVG:function(){return'<g transform="'+this.getSvgTransform()+'"><image xlink:href="'+this.getSvgSrc()+'" style="'+this.getSvgStyles()+'" transform="translate('+-this.width/2+" "+-this.height/2+')" width="'+this.width+'" height="'+this.height+'"></image></g>'},getSrc:function(){return this.getElement().src||this.getElement()._src},toString:function(){return'#<fabric.Image: { src: "'+this.getSrc()+'" }>'},clone:function(a,
b){this.constructor.fromObject(this.toObject(b),a)},applyFilters:function(a){if(0===this.filters.length)this.setElement(this._originalImage),a&&a();else{var b="undefined"!==typeof Buffer&&"undefined"===typeof window,c=this._originalImage,f=fabric.util.createCanvasElement(),g=b?new (require("canvas").Image):fabric.document.createElement("img"),h=this;f.width=c.width;f.height=c.height;f.getContext("2d").drawImage(c,0,0,c.width,c.height);this.filters.forEach(function(a){a&&a.applyTo(f)});g.onload=function(){h._element=
g;a&&a();g.onload=f=c=null};g.width=c.width;g.height=c.height;b?(b=f.toDataURL("image/png").substring(22),g.src=new Buffer(b,"base64"),h._element=g,a&&a()):g.src=f.toDataURL("image/png");return this}},_render:function(a){a.drawImage(this._element,-this.width/2,-this.height/2,this.width,this.height)},_resetWidthHeight:function(){var a=this.getElement();this.set("width",a.width);this.set("height",a.height)},_initElement:function(a){this.setElement(fabric.util.getById(a));fabric.util.addClass(this.getElement(),
fabric.Image.CSS_CANVAS)},_initConfig:function(a){a||(a={});this.setOptions(a);this._setWidthHeight(a)},_initFilters:function(a){a.filters&&a.filters.length&&(this.filters=a.filters.map(function(a){return a&&fabric.Image.filters[a.type].fromObject(a)}))},_setWidthHeight:function(a){this.width="width"in a?a.width:this.getElement().width||0;this.height="height"in a?a.height:this.getElement().height||0},complexity:function(){return 1}}),fabric.Image.CSS_CANVAS="canvas-img",fabric.Image.prototype.getSvgSrc=
fabric.Image.prototype.getSrc,fabric.Image.fromObject=function(a,b){var c=fabric.document.createElement("img"),f=a.src;a.width&&(c.width=a.width);a.height&&(c.height=a.height);c.onload=function(){fabric.Image.prototype._initFilters.call(a,a);var f=new fabric.Image(c,a);b&&b(f);c=c.onload=c.onerror=null};c.onerror=function(){fabric.log("Error loading "+c.src);b&&b(null,!0);c=c.onload=c.onerror=null};c.src=f},fabric.Image.fromURL=function(a,b,c){var f=fabric.document.createElement("img");f.onload=function(){b&&
b(new fabric.Image(f,c));f=f.onload=null};f.src=a},fabric.Image.ATTRIBUTE_NAMES="x y width height fill fill-opacity opacity stroke stroke-width transform xlink:href".split(" "),fabric.Image.fromElement=function(a,b,d){d||(d={});a=fabric.parseAttributes(a,fabric.Image.ATTRIBUTE_NAMES);fabric.Image.fromURL(a["xlink:href"],b,c(a,d))},fabric.Image.async=!0)})("undefined"!==typeof exports?exports:this);
fabric.util.object.extend(fabric.Object.prototype,{_getAngleValueForStraighten:function(){var b=this.getAngle()%360;return 0<b?90*Math.round((b-1)/90):90*Math.round(b/90)},straighten:function(){this.setAngle(this._getAngleValueForStraighten());return this},fxStraighten:function(b){b=b||{};var c=function(){},a=b.onComplete||c,e=b.onChange||c,d=this;fabric.util.animate({startValue:this.get("angle"),endValue:this._getAngleValueForStraighten(),duration:this.FX_DURATION,onChange:function(a){d.setAngle(a);
e()},onComplete:function(){d.setCoords();a()},onStart:function(){d.setActive(!1)}});return this}});fabric.util.object.extend(fabric.StaticCanvas.prototype,{straightenObject:function(b){b.straighten();this.renderAll();return this},fxStraightenObject:function(b){b.fxStraighten({onChange:this.renderAll.bind(this)});return this}});fabric.Image.filters={};
fabric.Image.filters.Grayscale=fabric.util.createClass({type:"Grayscale",applyTo:function(b){var c=b.getContext("2d");b=c.getImageData(0,0,b.width,b.height);var a=b.data,e=b.width,d=b.height,f,g,h,m;for(h=0;h<e;h++)for(m=0;m<d;m++)f=4*h*d+4*m,g=(a[f]+a[f+1]+a[f+2])/3,a[f]=g,a[f+1]=g,a[f+2]=g;c.putImageData(b,0,0)},toJSON:function(){return{type:this.type}}});fabric.Image.filters.Grayscale.fromObject=function(){return new fabric.Image.filters.Grayscale};
fabric.Image.filters.RemoveWhite=fabric.util.createClass({type:"RemoveWhite",initialize:function(b){b||(b={});this.threshold=b.threshold||30;this.distance=b.distance||20},applyTo:function(b){var c=b.getContext("2d");b=c.getImageData(0,0,b.width,b.height);for(var a=b.data,e=this.distance,d=255-this.threshold,f=Math.abs,g,h,m,s=0,t=a.length;s<t;s+=4)g=a[s],h=a[s+1],m=a[s+2],g>d&&(h>d&&m>d&&f(g-h)<e&&f(g-m)<e&&f(h-m)<e)&&(a[s+3]=1);c.putImageData(b,0,0)},toJSON:function(){return{type:this.type,threshold:this.threshold,
distance:this.distance}}});fabric.Image.filters.RemoveWhite.fromObject=function(b){return new fabric.Image.filters.RemoveWhite(b)};fabric.Image.filters.Invert=fabric.util.createClass({type:"Invert",applyTo:function(b){var c=b.getContext("2d");b=c.getImageData(0,0,b.width,b.height);var a=b.data,e=a.length,d;for(d=0;d<e;d+=4)a[d]=255-a[d],a[d+1]=255-a[d+1],a[d+2]=255-a[d+2];c.putImageData(b,0,0)},toJSON:function(){return{type:this.type}}});fabric.Image.filters.Invert.fromObject=function(){return new fabric.Image.filters.Invert};
fabric.Image.filters.Sepia=fabric.util.createClass({type:"Sepia",applyTo:function(b){var c=b.getContext("2d");b=c.getImageData(0,0,b.width,b.height);var a=b.data,e=a.length,d,f;for(d=0;d<e;d+=4)f=0.3*a[d]+0.59*a[d+1]+0.11*a[d+2],a[d]=f+100,a[d+1]=f+50,a[d+2]=f+255;c.putImageData(b,0,0)},toJSON:function(){return{type:this.type}}});fabric.Image.filters.Sepia.fromObject=function(){return new fabric.Image.filters.Sepia};
fabric.Image.filters.Sepia2=fabric.util.createClass({type:"Sepia2",applyTo:function(b){var c=b.getContext("2d");b=c.getImageData(0,0,b.width,b.height);var a=b.data,e=a.length,d,f,g,h;for(d=0;d<e;d+=4)f=a[d],g=a[d+1],h=a[d+2],a[d]=(0.393*f+0.769*g+0.189*h)/1.351,a[d+1]=(0.349*f+0.686*g+0.168*h)/1.203,a[d+2]=(0.272*f+0.534*g+0.131*h)/2.14;c.putImageData(b,0,0)},toJSON:function(){return{type:this.type}}});fabric.Image.filters.Sepia2.fromObject=function(){return new fabric.Image.filters.Sepia2};
fabric.Image.filters.Brightness=fabric.util.createClass({type:"Brightness",initialize:function(b){b||(b={});this.brightness=b.brightness||100},applyTo:function(b){var c=b.getContext("2d");b=c.getImageData(0,0,b.width,b.height);for(var a=b.data,e=this.brightness,d=0,f=a.length;d<f;d+=4)a[d]+=e,a[d+1]+=e,a[d+2]+=e;c.putImageData(b,0,0)},toJSON:function(){return{type:this.type,brightness:this.brightness}}});fabric.Image.filters.Brightness.fromObject=function(b){return new fabric.Image.filters.Brightness(b)};
fabric.Image.filters.Noise=fabric.util.createClass({type:"Noise",initialize:function(b){b||(b={});this.noise=b.noise||100},applyTo:function(b){var c=b.getContext("2d");b=c.getImageData(0,0,b.width,b.height);for(var a=b.data,e=this.noise,d,f=0,g=a.length;f<g;f+=4)d=(0.5-Math.random())*e,a[f]+=d,a[f+1]+=d,a[f+2]+=d;c.putImageData(b,0,0)},toJSON:function(){return{type:this.type,noise:this.noise}}});fabric.Image.filters.Noise.fromObject=function(b){return new fabric.Image.filters.Noise(b)};
fabric.Image.filters.GradientTransparency=fabric.util.createClass({type:"GradientTransparency",initialize:function(b){b||(b={});this.threshold=b.threshold||100},applyTo:function(b){var c=b.getContext("2d");b=c.getImageData(0,0,b.width,b.height);for(var a=b.data,e=this.threshold,d=a.length,f=0,g=a.length;f<g;f+=4)a[f+3]=e+255*(d-f)/d;c.putImageData(b,0,0)},toJSON:function(){return{type:this.type,threshold:this.threshold}}});fabric.Image.filters.GradientTransparency.fromObject=function(b){return new fabric.Image.filters.GradientTransparency(b)};
fabric.Image.filters.Tint=fabric.util.createClass({type:"Tint",initialize:function(b){b||(b={});this.color=b.color||0},applyTo:function(b){var c=b.getContext("2d");b=c.getImageData(0,0,b.width,b.height);var a=b.data,e=a.length,d,f;d=parseInt(this.color,10).toString(16);var g=parseInt("0x"+d.substr(0,2),16),h=parseInt("0x"+d.substr(2,2),16),m=parseInt("0x"+d.substr(4,2),16);for(d=0;d<e;d+=4)f=a[d+3],0<f&&(a[d]=g,a[d+1]=h,a[d+2]=m);c.putImageData(b,0,0)},toJSON:function(){return{type:this.type,color:this.color}}});
fabric.Image.filters.Tint.fromObject=function(b){return new fabric.Image.filters.Tint(b)};
fabric.Image.filters.Convolute=fabric.util.createClass({type:"Convolute",initialize:function(b){b||(b={});this.opaque=b.opaque;this.matrix=b.matrix||[0,0,0,0,1,0,0,0,0];this.tmpCtx=fabric.util.createCanvasElement().getContext("2d")},_createImageData:function(b,c){return this.tmpCtx.createImageData(b,c)},applyTo:function(b){var c=this.matrix,a=b.getContext("2d"),e=a.getImageData(0,0,b.width,b.height);b=Math.round(Math.sqrt(c.length));for(var d=Math.floor(b/2),f=e.data,g=e.width,e=e.height,h=this._createImageData(g,
e),m=h.data,s=this.opaque?1:0,t=0;t<e;t++)for(var q=0;q<g;q++){for(var u=t,r=q,v=4*(t*g+q),w=0,z=0,x=0,A=0,B=0;B<b;B++)for(var D=0;D<b;D++){var C=u+B-d,H=r+D-d;0<=C&&(C<e&&0<=H&&H<g)&&(C=4*(C*g+H),H=c[B*b+D],w+=f[C]*H,z+=f[C+1]*H,x+=f[C+2]*H,A+=f[C+3]*H)}m[v]=w;m[v+1]=z;m[v+2]=x;m[v+3]=A+s*(255-A)}a.putImageData(h,0,0)},toJSON:function(){return{type:this.type,matrix:this.matrix}}});fabric.Image.filters.Convolute.fromObject=function(b){return new fabric.Image.filters.Convolute(b)};
fabric.Image.filters.Pixelate=fabric.util.createClass({type:"Pixelate",initialize:function(b){b||(b={});this.blocksize=b.blocksize||4},applyTo:function(b){var c=b.getContext("2d");b=c.getImageData(0,0,b.width,b.height);var a=b.data,e=b.width,d=b.height,f,g,h,m,s,t,q;for(g=0;g<e;g+=this.blocksize)for(h=0;h<d;h+=this.blocksize){f=4*g*d+4*h;m=a[f];s=a[f+1];t=a[f+2];q=a[f+3];for(var u=g,r=g+this.blocksize;u<r;u++)for(var v=h,w=h+this.blocksize;v<w;v++)f=4*u*d+4*v,a[f]=m,a[f+1]=s,a[f+2]=t,a[f+3]=q}c.putImageData(b,
0,0)},toJSON:function(){return{type:this.type,blocksize:this.blocksize}}});fabric.Image.filters.Pixelate.fromObject=function(b){return new fabric.Image.filters.Pixelate(b)};
(function(b){var c=b.fabric||(b.fabric={}),a=c.util.object.extend,e=c.util.object.clone,d=c.util.toFixed;c.Text?c.warn("fabric.Text is already defined"):(c.Text=c.util.createClass(c.Object,{fontSize:40,fontWeight:400,fontFamily:"Times New Roman",textDecoration:"",textShadow:"",textAlign:"left",fontStyle:"",lineHeight:1.3,strokeStyle:"",strokeWidth:1,backgroundColor:"",textBackgroundColor:"",path:null,type:"text",useNative:!0,initialize:function(a,b){b=b||{};this._initStateProperties();this.text=a;
this.setOptions(b);this._initDimensions();this.setCoords()},_initDimensions:function(){var a=c.util.createCanvasElement();this._render(a.getContext("2d"))},_initStateProperties:function(){this.stateProperties=this.stateProperties.concat();this.stateProperties.push("fontFamily","fontWeight","fontSize","path","text","textDecoration","textShadow","textAlign","fontStyle","lineHeight","strokeStyle","strokeWidth","backgroundColor","textBackgroundColor","useNative");c.util.removeFromArray(this.stateProperties,
"width")},toString:function(){return"#<fabric.Text ("+this.complexity()+'): { "text": "'+this.text+'", "fontFamily": "'+this.fontFamily+'" }>'},_render:function(a){"undefined"===typeof Cufon||!0===this.useNative?this._renderViaNative(a):this._renderViaCufon(a)},_renderViaCufon:function(a){var b=Cufon.textOptions||(Cufon.textOptions={});b.left=this.left;b.top=this.top;b.context=a;b.color=this.fill;var c=this._initDummyElementForCufon();this.transform(a);Cufon.replaceElement(c,{engine:"canvas",separate:"none",
fontFamily:this.fontFamily,fontWeight:this.fontWeight,textDecoration:this.textDecoration,textShadow:this.textShadow,textAlign:this.textAlign,fontStyle:this.fontStyle,lineHeight:this.lineHeight,strokeStyle:this.strokeStyle,strokeWidth:this.strokeWidth,backgroundColor:this.backgroundColor,textBackgroundColor:this.textBackgroundColor});this.width=b.width;this.height=b.height;this._totalLineHeight=b.totalLineHeight;this._fontAscent=b.fontAscent;this._boundaries=b.boundaries;this._shadowOffsets=b.shadowOffsets;
this._shadows=b.shadows||[];this.setCoords()},_renderViaNative:function(a){this.transform(a);this._setTextStyles(a);var b=this.text.split(/\r?\n/);this.width=this._getTextWidth(a,b);this.height=this._getTextHeight(a,b);this._renderTextBackground(a,b);"left"!==this.textAlign&&"justify"!==this.textAlign&&(a.save(),a.translate("center"===this.textAlign?this.width/2:this.width,0));this._setTextShadow(a);this._renderTextFill(a,b);this.textShadow&&a.restore();this._renderTextStroke(a,b);"left"!==this.textAlign&&
"justify"!==this.textAlign&&a.restore();this._renderTextDecoration(a,b);this._setBoundaries(a,b);this._totalLineHeight=0;this.setCoords()},_setBoundaries:function(a,b){this._boundaries=[];for(var c=0,d=b.length;c<d;c++){var e=this._getLineWidth(a,b[c]),t=this._getLineLeftOffset(e);this._boundaries.push({height:this.fontSize*this.lineHeight,width:e,left:t})}},_setTextStyles:function(a){a.fillStyle=this.fill.toLive?this.fill.toLive(a):this.fill;a.strokeStyle=this.strokeStyle;a.lineWidth=this.strokeWidth;
a.textBaseline="alphabetic";a.textAlign=this.textAlign;a.font=this._getFontDeclaration()},_getTextHeight:function(a,b){return this.fontSize*b.length*this.lineHeight},_getTextWidth:function(a,b){for(var c=a.measureText(b[0]).width,d=1,e=b.length;d<e;d++){var t=a.measureText(b[d]).width;t>c&&(c=t)}return c},_setTextShadow:function(a){if(this.textShadow){var b=/\s+(-?\d+)(?:px)?\s+(-?\d+)(?:px)?\s+(\d+)(?:px)?\s*/,c=this.textShadow,d=b.exec(this.textShadow),b=c.replace(b,"");a.save();a.shadowColor=b;
a.shadowOffsetX=parseInt(d[1],10);a.shadowOffsetY=parseInt(d[2],10);a.shadowBlur=parseInt(d[3],10);this._shadows=[{blur:a.shadowBlur,color:a.shadowColor,offX:a.shadowOffsetX,offY:a.shadowOffsetY}];this._shadowOffsets=[[parseInt(a.shadowOffsetX,10),parseInt(a.shadowOffsetY,10)]]}},_drawTextLine:function(a,b,c,d,e){if("justify"!==this.textAlign)b[a](c,d,e);else{var t=b.measureText(c).width,q=this.width;if(q>t){t=c.split(/\s+/);c=b.measureText(c.replace(/\s+/g,"")).width;for(var q=(q-c)/(t.length-1),
u=c=0,r=t.length;u<r;u++)b[a](t[u],d+c,e),c+=b.measureText(t[u]).width+q}else b[a](c,d,e)}},_renderTextFill:function(a,b){this._boundaries=[];for(var c=0,d=b.length;c<d;c++)this._drawTextLine("fillText",a,b[c],-this.width/2,-this.height/2+c*this.fontSize*this.lineHeight+this.fontSize)},_renderTextStroke:function(a,b){if(this.strokeStyle){a.beginPath();for(var c=0,d=b.length;c<d;c++)this._drawTextLine("strokeText",a,b[c],-this.width/2,-this.height/2+c*this.fontSize*this.lineHeight+this.fontSize);a.closePath()}},
_renderTextBackground:function(a,b){this._renderTextBoxBackground(a);this._renderTextLinesBackground(a,b)},_renderTextBoxBackground:function(a){this.backgroundColor&&(a.save(),a.fillStyle=this.backgroundColor,a.fillRect(-this.width/2,-this.height/2,this.width,this.height),a.restore())},_renderTextLinesBackground:function(a,b){if(this.textBackgroundColor){a.save();a.fillStyle=this.textBackgroundColor;for(var c=0,d=b.length;c<d;c++)if(""!==b[c]){var e=this._getLineWidth(a,b[c]),t=this._getLineLeftOffset(e);
a.fillRect(-this.width/2+t,-this.height/2+c*this.fontSize*this.lineHeight,e,this.fontSize*this.lineHeight)}a.restore()}},_getLineLeftOffset:function(a){return"center"===this.textAlign?(this.width-a)/2:"right"===this.textAlign?this.width-a:0},_getLineWidth:function(a,b){return"justify"===this.textAlign?this.width:a.measureText(b).width},_renderTextDecoration:function(a,b){function c(h){for(var q=0,u=b.length;q<u;q++){var r=e._getLineWidth(a,b[q]),v=e._getLineLeftOffset(r);a.fillRect(-e.width/2+v,h+
q*e.fontSize*e.lineHeight-d,r,1)}}var d=this._getTextHeight(a,b)/2,e=this;-1<this.textDecoration.indexOf("underline")&&c(this.fontSize);-1<this.textDecoration.indexOf("line-through")&&c(this.fontSize/2);-1<this.textDecoration.indexOf("overline")&&c(0)},_getFontDeclaration:function(){return[this.fontStyle,this.fontWeight,this.fontSize+"px",c.isLikelyNode?'"'+this.fontFamily+'"':this.fontFamily].join(" ")},_initDummyElementForCufon:function(){var a=c.document.createElement("pre");c.document.createElement("div").appendChild(a);
"undefined"===typeof G_vmlCanvasManager?a.innerHTML=this.text:a.innerText=this.text.replace(/\r?\n/gi,"\r");a.style.fontSize=this.fontSize+"px";a.style.letterSpacing="normal";return a},render:function(a,b){a.save();this._render(a);!b&&this.active&&(this.drawBorders(a),this.hideCorners||this.drawCorners(a));a.restore()},toObject:function(b){return a(this.callSuper("toObject",b),{text:this.text,fontSize:this.fontSize,fontWeight:this.fontWeight,fontFamily:this.fontFamily,fontStyle:this.fontStyle,lineHeight:this.lineHeight,
textDecoration:this.textDecoration,textShadow:this.textShadow,textAlign:this.textAlign,path:this.path,strokeStyle:this.strokeStyle,strokeWidth:this.strokeWidth,backgroundColor:this.backgroundColor,textBackgroundColor:this.textBackgroundColor,useNative:this.useNative})},toSVG:function(){var a=this.text.split(/\r?\n/),b=this.useNative?this.fontSize*this.lineHeight:-this._fontAscent-this._fontAscent/5*this.lineHeight,c=-(this.width/2),e=this.useNative?this.fontSize-1:this.height/2-a.length*this.fontSize-
this._totalLineHeight,s=this._getSVGTextAndBg(b,c,a),a=this._getSVGShadows(b,a),e=e+(this._fontAscent?this._fontAscent/5*this.lineHeight:0);return['<g transform="',this.getSvgTransform(),'">',s.textBgRects.join(""),"<text ",this.fontFamily?"font-family=\"'"+this.fontFamily+"'\" ":"",this.fontSize?'font-size="'+this.fontSize+'" ':"",this.fontStyle?'font-style="'+this.fontStyle+'" ':"",this.fontWeight?'font-weight="'+this.fontWeight+'" ':"",this.textDecoration?'text-decoration="'+this.textDecoration+
'" ':"",'style="',this.getSvgStyles(),'" transform="translate(',d(c,2)," ",d(e,2),')">',a.join(""),s.textSpans.join(""),"</text></g>"].join("")},_getSVGShadows:function(a,b){var e=[],m,s,t,q,u=1;if(!this._shadows||!this._boundaries)return e;m=0;for(t=this._shadows.length;m<t;m++){s=0;for(q=b.length;s<q;s++)""!==b[s]?(e.push('<tspan x="',d((this._boundaries&&this._boundaries[s]?this._boundaries[s].left:0)+u+this._shadowOffsets[m][0],2),0===s||this.useNative?'" y':'" dy','="',d(this.useNative?a*s-this.height/
2+this._shadowOffsets[m][1]:a+(0===s?this._shadowOffsets[m][1]:0),2),'" ',this._getFillAttributes(this._shadows[m].color),">",c.util.string.escapeXml(b[s]),"</tspan>"),u=1):u++}return e},_getSVGTextAndBg:function(a,b,e){var m=[],s=[],t,q,u,r=1;this.backgroundColor&&this._boundaries&&s.push("<rect ",this._getFillAttributes(this.backgroundColor),' x="',d(-this.width/2,2),'" y="',d(-this.height/2,2),'" width="',d(this.width,2),'" height="',d(this.height,2),'"></rect>');t=0;for(u=e.length;t<u;t++)""!==
e[t]?(q=this._boundaries&&this._boundaries[t]?d(this._boundaries[t].left,2):0,m.push('<tspan x="',q,'" ',0===t||this.useNative?"y":"dy",'="',d(this.useNative?a*t-this.height/2:a*r,2),'" ',this._getFillAttributes(this.fill),">",c.util.string.escapeXml(e[t]),"</tspan>"),r=1):r++,this.textBackgroundColor&&this._boundaries&&s.push("<rect ",this._getFillAttributes(this.textBackgroundColor),' x="',d(b+this._boundaries[t].left,2),'" y="',d(a*t-this.height/2,2),'" width="',d(this._boundaries[t].width,2),
'" height="',d(this._boundaries[t].height,2),'"></rect>');return{textSpans:m,textBgRects:s}},_getFillAttributes:function(a){var b=a?new c.Color(a):"";return!b||!b.getSource()||1===b.getAlpha()?'fill="'+a+'"':'opacity="'+b.getAlpha()+'" fill="'+b.setAlpha(1).toRgb()+'"'},setColor:function(a){this.set("fill",a);return this},setFontsize:function(a){this.set("fontSize",a);this._initDimensions();this.setCoords();return this},getText:function(){return this.text},setText:function(a){this.set("text",a);this._initDimensions();
this.setCoords();return this},_set:function(a,b){"fontFamily"===a&&this.path&&(this.path=this.path.replace(/(.*?)([^\/]*)(\.font\.js)/,"$1"+b+"$3"));this.callSuper("_set",a,b)}}),c.Text.ATTRIBUTE_NAMES="x y fill fill-opacity opacity stroke stroke-width transform font-family font-style font-weight font-size text-decoration".split(" "),c.Text.fromObject=function(a){return new c.Text(a.text,e(a))},c.Text.fromElement=function(a,b){if(!a)return null;var d=c.parseAttributes(a,c.Text.ATTRIBUTE_NAMES);b=
c.util.object.extend(b?c.util.object.clone(b):{},d);d=new c.Text(a.textContent,b);d.set({left:d.getLeft()+d.getWidth()/2,top:d.getTop()-d.getHeight()/2});return d})})("undefined"!==typeof exports?exports:this);
(function(){function b(b,c,d){b=a.parse(b);var f=e.createClient(b.port,b.hostname);b=f.request("GET",b.pathname,{host:b.hostname});f.addListener("error",function(a){a.errno===process.ECONNREFUSED?fabric.log("ECONNREFUSED: connection refused to "+f.host+":"+f.port):fabric.log(a.message)});b.end();b.on("response",function(a){var b="";c&&a.setEncoding(c);a.on("end",function(){d(b)});a.on("data",function(c){200===a.statusCode&&(b+=c)})})}if(!("undefined"!==typeof document&&"undefined"!==typeof window)){var c=
(new require("xmldom")).DOMParser,a=require("url"),e=require("http"),d=require("canvas"),f=require("canvas").Image;fabric.util.loadImage=function(a,c,d){var e=new f;a&&0===a.indexOf("data")?(e.src=e._src=a,c&&c.call(d,e)):a&&b(a,"binary",function(b){e.src=new Buffer(b,"binary");e._src=a;c&&c.call(d,e)})};fabric.loadSVGFromURL=function(a,c){a=a.replace(/^\n\s*/,"").replace(/\?.*$/,"").trim();b(a,"",function(a){fabric.loadSVGFromString(a,c)})};fabric.loadSVGFromString=function(a,b){var d=(new c).parseFromString(a);
fabric.parseSVGDocument(d.documentElement,function(a,c){b(a,c)})};fabric.util.getScript=function(a,c){b(a,"",function(a){eval(a);c&&c()})};fabric.Image.fromObject=function(a,b){fabric.util.loadImage(a.src,function(c){c=new fabric.Image(c);c._initConfig(a);c._initFilters(a);b(c)})};fabric.createCanvasForNode=function(a,b){var c=fabric.document.createElement("canvas"),e=new d(a||600,b||600);c.style={};c.width=e.width;c.height=e.height;c=new (fabric.Canvas||fabric.StaticCanvas)(c);c.contextContainer=
e.getContext("2d");c.nodeCanvas=e;return c};fabric.StaticCanvas.prototype.createPNGStream=function(){return this.nodeCanvas.createPNGStream()};fabric.StaticCanvas.prototype.createJPEGStream=function(a){return this.nodeCanvas.createJPEGStream(a)};var g=fabric.StaticCanvas.prototype.setWidth;fabric.StaticCanvas.prototype.setWidth=function(a){g.call(this);this.nodeCanvas.width=a;return this};fabric.Canvas&&(fabric.Canvas.prototype.setWidth=fabric.StaticCanvas.prototype.setWidth);var h=fabric.StaticCanvas.prototype.setHeight;
fabric.StaticCanvas.prototype.setHeight=function(a){h.call(this);this.nodeCanvas.height=a;return this};fabric.Canvas&&(fabric.Canvas.prototype.setHeight=fabric.StaticCanvas.prototype.setHeight)}})();(function(b){var c=function(){var a=65,c={eventName:"click",onShow:function(){},onBeforeShow:function(){},onHide:function(){},onChange:function(){},onSubmit:function(){},color:"ff0000",livePreview:!0,flat:!1},d=function(a,c){var d=R(a);b(c).data("colorpicker").fields.eq(1).val(d.r).end().eq(2).val(d.g).end().eq(3).val(d.b).end()},f=function(a,c){b(c).data("colorpicker").fields.eq(4).val(a.h).end().eq(5).val(a.s).end().eq(6).val(a.b).end()},g=function(a,c){b(c).data("colorpicker").fields.eq(0).val(Z(R(a))).end()},
h=function(a,c){b(c).data("colorpicker").selector.css("backgroundColor","#"+Z(R({h:a.h,s:100,b:100})));b(c).data("colorpicker").selectorIndic.css({left:parseInt(150*a.s/100,10),top:parseInt(150*(100-a.b)/100,10)})},m=function(a,c){b(c).data("colorpicker").hue.css("top",parseInt(150-150*a.h/360,10))},s=function(a,c){b(c).data("colorpicker").currentColor.css("backgroundColor","#"+Z(R(a)))},t=function(a,c){b(c).data("colorpicker").newColor.css("backgroundColor","#"+Z(R(a)))},q=function(c){c=c.charCode||
c.keyCode||-1;if(c>a&&90>=c||32==c)return!1;!0===b(this).parent().parent().data("colorpicker").livePreview&&r.apply(this)},u=function(a){a=b(this);var c=a.data("colorpicker").color;a.data("colorpicker").origColor=c;s(c,a.get(0));a.data("colorpicker").onSubmit(c,Z(R(c)),R(c),a.data("colorpicker").el)},r=function(a){var c=b(this).parent().parent(),e;if(0<this.parentNode.className.indexOf("_hex")){e=c.data("colorpicker");var s=this.value,q=6-s.length;if(0<q){for(var r=[],u=0;u<q;u++)r.push("0");r.push(s);
s=r.join("")}s=Q(M(s));e.color=e=s}else 0<this.parentNode.className.indexOf("_hsb")?c.data("colorpicker").color=e=L({h:parseInt(c.data("colorpicker").fields.eq(4).val(),10),s:parseInt(c.data("colorpicker").fields.eq(5).val(),10),b:parseInt(c.data("colorpicker").fields.eq(6).val(),10)}):(e=c.data("colorpicker"),s=parseInt(c.data("colorpicker").fields.eq(1).val(),10),q=parseInt(c.data("colorpicker").fields.eq(2).val(),10),r=parseInt(c.data("colorpicker").fields.eq(3).val(),10),s={r:Math.min(255,Math.max(0,
s)),g:Math.min(255,Math.max(0,q)),b:Math.min(255,Math.max(0,r))},e.color=e=Q(s));a&&(d(e,c.get(0)),g(e,c.get(0)),f(e,c.get(0)));h(e,c.get(0));m(e,c.get(0));t(e,c.get(0));c.data("colorpicker").onChange.apply(c,[e,Z(R(e)),R(e)])},v=function(a){b(this).parent().parent().data("colorpicker").fields.parent().removeClass("colorpicker_focus")},w=function(){a=0<this.parentNode.className.indexOf("_hex")?70:65;b(this).parent().parent().data("colorpicker").fields.parent().removeClass("colorpicker_focus");b(this).parent().addClass("colorpicker_focus")},
z=function(a){var c=b(this).parent().find("input").focus();a={el:b(this).parent().addClass("colorpicker_slider"),max:0<this.parentNode.className.indexOf("_hsb_h")?360:0<this.parentNode.className.indexOf("_hsb")?100:255,y:a.pageY,field:c,val:parseInt(c.val(),10),preview:b(this).parent().parent().data("colorpicker").livePreview};b(document).bind("mouseup",a,A);b(document).bind("mousemove",a,x)},x=function(a){a.data.field.val(Math.max(0,Math.min(a.data.max,parseInt(a.data.val+a.pageY-a.data.y,10))));
a.data.preview&&r.apply(a.data.field.get(0),[!0]);return!1},A=function(a){r.apply(a.data.field.get(0),[!0]);a.data.el.removeClass("colorpicker_slider").find("input").focus();b(document).unbind("mouseup",A);b(document).unbind("mousemove",x);return!1},B=function(a){a={cal:b(this).parent(),y:b(this).offset().top};a.preview=a.cal.data("colorpicker").livePreview;b(document).bind("mouseup",a,C);b(document).bind("mousemove",a,D)},D=function(a){r.apply(a.data.cal.data("colorpicker").fields.eq(4).val(parseInt(360*
(150-Math.max(0,Math.min(150,a.pageY-a.data.y)))/150,10)).get(0),[a.data.preview]);return!1},C=function(a){d(a.data.cal.data("colorpicker").color,a.data.cal.get(0));g(a.data.cal.data("colorpicker").color,a.data.cal.get(0));b(document).unbind("mouseup",C);b(document).unbind("mousemove",D);return!1},H=function(a){a={cal:b(this).parent(),pos:b(this).offset()};a.preview=a.cal.data("colorpicker").livePreview;b(document).bind("mouseup",a,I);b(document).bind("mousemove",a,K)},K=function(a){r.apply(a.data.cal.data("colorpicker").fields.eq(6).val(parseInt(100*
(150-Math.max(0,Math.min(150,a.pageY-a.data.pos.top)))/150,10)).end().eq(5).val(parseInt(100*Math.max(0,Math.min(150,a.pageX-a.data.pos.left))/150,10)).get(0),[a.data.preview]);return!1},I=function(a){d(a.data.cal.data("colorpicker").color,a.data.cal.get(0));g(a.data.cal.data("colorpicker").color,a.data.cal.get(0));b(document).unbind("mouseup",I);b(document).unbind("mousemove",K);return!1},P=function(a){b(this).addClass("colorpicker_focus")},Y=function(a){b(this).removeClass("colorpicker_focus")},
X=function(a){a=b(this).parent();var c=a.data("colorpicker").color;a.data("colorpicker").origColor=c;s(c,a.get(0));a.data("colorpicker").onSubmit(c,Z(R(c)),R(c),a.data("colorpicker").el)},N=function(a){var c,d,e=b("#"+b(this).data("colorpickerId"));e.data("colorpicker").onBeforeShow.apply(this,[e.get(0)]);var f=b(this).offset(),g="CSS1Compat"==document.compatMode;a=window.pageXOffset||(g?document.documentElement.scrollLeft:document.body.scrollLeft);c=window.pageYOffset||(g?document.documentElement.scrollTop:
document.body.scrollTop);d=window.innerWidth||(g?document.documentElement.clientWidth:document.body.clientWidth);var h=f.top+this.offsetHeight,f=f.left;h+176>c+(window.innerHeight||(g?document.documentElement.clientHeight:document.body.clientHeight))&&(h-=this.offsetHeight+176);f+356>a+d&&(f-=356);e.css({left:f+"px",top:h+"px","z-index":"80000"});!1!=e.data("colorpicker").onShow.apply(this,[e.get(0)])&&e.show();b(document).bind("mousedown",{cal:e},y);return!1},y=function(a){E(a.data.cal.get(0),a.target,
a.data.cal.get(0))||(!1!=a.data.cal.data("colorpicker").onHide.apply(this,[a.data.cal.get(0)])&&a.data.cal.hide(),b(document).unbind("mousedown",y))},E=function(a,b,c){if(a==b)return!0;if(a.contains)return a.contains(b);if(a.compareDocumentPosition)return!!(a.compareDocumentPosition(b)&16);for(b=b.parentNode;b&&b!=c;){if(b==a)return!0;b=b.parentNode}return!1},L=function(a){return{h:Math.min(360,Math.max(0,a.h)),s:Math.min(100,Math.max(0,a.s)),b:Math.min(100,Math.max(0,a.b))}},M=function(a){a=parseInt(-1<
a.indexOf("#")?a.substring(1):a,16);return{r:a>>16,g:(a&65280)>>8,b:a&255}},Q=function(a){var b={h:0,s:0,b:0},c=Math.min(a.r,a.g,a.b),d=Math.max(a.r,a.g,a.b),c=d-c;b.b=d;b.s=0!=d?255*c/d:0;b.h=0!=b.s?a.r==d?(a.g-a.b)/c:a.g==d?2+(a.b-a.r)/c:4+(a.r-a.g)/c:-1;b.h*=60;0>b.h&&(b.h+=360);b.s*=100/255;b.b*=100/255;return b},R=function(a){var b,c,d;b=Math.round(a.h);var e=Math.round(255*a.s/100);a=Math.round(255*a.b/100);if(0==e)b=c=d=a;else{var e=(255-e)*a/255,f=(a-e)*(b%60)/60;360==b&&(b=0);60>b?(b=a,d=
e,c=e+f):120>b?(c=a,d=e,b=a-f):180>b?(c=a,b=e,d=e+f):240>b?(d=a,b=e,c=a-f):300>b?(d=a,c=e,b=e+f):360>b?(b=a,c=e,d=a-f):d=c=b=0}return{r:Math.round(b),g:Math.round(c),b:Math.round(d)}},Z=function(a){var c=[a.r.toString(16),a.g.toString(16),a.b.toString(16)];b.each(c,function(a,b){1==b.length&&(c[a]="0"+b)});return c.join("")},ea=function(){var a=b(this).parent(),c=a.data("colorpicker").origColor;a.data("colorpicker").color=c;d(c,a.get(0));g(c,a.get(0));f(c,a.get(0));h(c,a.get(0));m(c,a.get(0));t(c,
a.get(0))};return{init:function(a){a=b.extend({},c,a||{});if("string"==typeof a.color)a.color=Q(M(a.color));else if(void 0!=a.color.r&&void 0!=a.color.g&&void 0!=a.color.b)a.color=Q(a.color);else if(void 0!=a.color.h&&void 0!=a.color.s&&void 0!=a.color.b)a.color=L(a.color);else return this;return this.each(function(){if(!b(this).data("colorpickerId")){var c=b.extend({},a);c.origColor=a.color;var e="collorpicker_"+parseInt(1E3*Math.random());b(this).data("colorpickerId",e);e=b('<div class="colorpicker"><div class="colorpicker_color"><div><div></div></div></div><div class="colorpicker_hue"><div></div></div><div class="colorpicker_new_color"></div><div class="colorpicker_current_color"></div><div class="colorpicker_hex"><input type="text" maxlength="6" size="6" /></div><div class="colorpicker_rgb_r colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_rgb_g colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_rgb_b colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_hsb_h colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_hsb_s colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_hsb_b colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_submit"></div></div>').attr("id",
e);c.flat?e.appendTo(this).show():e.appendTo(document.body);c.fields=e.mouseup(u).find("input").bind("keyup",q).bind("change",r).bind("blur",v).bind("focus",w);e.find("span").bind("mousedown",z).end().find(">div.colorpicker_current_color").bind("click",ea);c.selector=e.find("div.colorpicker_color").bind("mousedown",H);c.selectorIndic=c.selector.find("div div");c.el=this;c.hue=e.find("div.colorpicker_hue div");e.find("div.colorpicker_hue").bind("mousedown",B);c.newColor=e.find("div.colorpicker_new_color");
c.currentColor=e.find("div.colorpicker_current_color");e.data("colorpicker",c);e.find("div.colorpicker_submit").bind("mouseenter",P).bind("mouseleave",Y).bind("click",X);d(c.color,e.get(0));f(c.color,e.get(0));g(c.color,e.get(0));m(c.color,e.get(0));h(c.color,e.get(0));s(c.color,e.get(0));t(c.color,e.get(0));c.flat?e.css({position:"relative",display:"block"}):b(this).bind(c.eventName,N)}})},showPicker:function(){return this.each(function(){b(this).data("colorpickerId")&&N.apply(this)})},hidePicker:function(){return this.each(function(){b(this).data("colorpickerId")&&
b("#"+b(this).data("colorpickerId")).hide()})},setColor:function(a){if("string"==typeof a)a=Q(M(a));else if(void 0!=a.r&&void 0!=a.g&&void 0!=a.b)a=Q(a);else if(void 0!=a.h&&void 0!=a.s&&void 0!=a.b)a=L(a);else return this;return this.each(function(){if(b(this).data("colorpickerId")){var c=b("#"+b(this).data("colorpickerId"));c.data("colorpicker").color=a;c.data("colorpicker").origColor=a;d(a,c.get(0));f(a,c.get(0));g(a,c.get(0));m(a,c.get(0));h(a,c.get(0));s(a,c.get(0));t(a,c.get(0))}})}}}();b.fn.extend({ColorPicker:c.init,
ColorPickerHide:c.hidePicker,ColorPickerShow:c.showPicker,ColorPickerSetColor:c.setColor})})(jQuery);/*
 Use it if you like it
*/
function RGBColor(b){function c(a){var b=a.H,c=a.S;a=a.V;if(-1==b)return{R:a,G:a,B:a};var d=Math.floor(b),e=b-d;d&1||(e=1-e);b=a*(1-c);c=a*(1-c*e);switch(d){case 6:case 0:return{R:a,G:c,B:b};case 1:return{R:c,G:a,B:b};case 2:return{R:b,G:a,B:c};case 3:return{R:b,G:c,B:a};case 4:return{R:c,G:b,B:a};case 5:return{R:a,G:b,B:c};default:return{R:a,G:a,B:a}}}this.ok=!1;if("string"==typeof b){"#"==b.charAt(0)&&(b=b.substr(1,6));b=b.replace(/ /g,"");b=b.toLowerCase();var a={aliceblue:"f0f8ff",antiquewhite:"faebd7",
aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",
darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",
indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",
mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",
papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",
wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"},e;for(e in a)b==e&&(b=a[e]);a=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(a){return[parseInt(a[1]),parseInt(a[2]),parseInt(a[3])]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(a){return[parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],process:function(a){return[parseInt(a[1]+
a[1],16),parseInt(a[2]+a[2],16),parseInt(a[3]+a[3],16)]}}];for(e=0;e<a.length;e++){var d=a[e].process,f=a[e].re.exec(b);f&&(channels=d(f),this.r=channels[0],this.g=channels[1],this.b=channels[2],this.ok=!0)}this.r=0>this.r||isNaN(this.r)?0:255<this.r?255:this.r;this.g=0>this.g||isNaN(this.g)?0:255<this.g?255:this.g;this.b=0>this.b||isNaN(this.b)?0:255<this.b?255:this.b;this.a=1;this.setAlpha=function(a){this.a=a};this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"};this.toRGBA=function(){return"rgba("+
this.r+", "+this.g+", "+this.b+", "+this.a+")"};this.toHex=function(){var a=this.r.toString(16),b=this.g.toString(16),c=this.b.toString(16);1==a.length&&(a="0"+a);1==b.length&&(b="0"+b);1==c.length&&(c="0"+c);return"#"+a+b+c};this.toHsv=function(){var a;a=this.r/255;var b=this.g/255,c=this.b/255,d=Math.max(a,Math.max(b,c)),e=Math.min(a,Math.min(b,c));a=d==e?{H:-1,S:0,V:d}:{H:(a==e?3:b==e?5:1)-1*(a==e?b-c:b==e?c-a:a-b)/(d-e),S:(d-1*e)/d,V:d};return a};this.fromHsv=function(a){a=c(a);this.r=Math.round(255*
a.R);this.g=Math.round(255*a.G);this.b=Math.round(255*a.B)}}};this.HashMap=function(){this.array=[]};HashMap.prototype.put=function(b,c){var a=this.getIndex(b);-1<a?this.array[a]={key:b,value:c}:this.array.push({key:b,value:c})};HashMap.prototype.get=function(b){b=this.getIndex(b);if(-1<b)return this.array[b].value};HashMap.prototype.getAtIndex=function(b){return this.array[b].value};HashMap.prototype.getKeyAtIndex=function(b){return this.array[b].key};HashMap.prototype.remove=function(b){b=this.getIndexOfValue(b);this.removeByIndex(b)};
HashMap.prototype.removeByKey=function(b){b=this.getIndex(b);this.removeByIndex(b)};HashMap.prototype.removeByIndex=function(b){-1!=b&&this.array.splice(b,1)};HashMap.prototype.clear=function(){this.array=[]};HashMap.prototype.all=function(){return this.array};HashMap.prototype.getAllValues=function(){for(var b=[],c=0;c<this.array.length;c++)b.push(this.array[c].value);return b};HashMap.prototype.getAllKeys=function(){for(var b=[],c=0;c<this.array.length;c++)b.push(this.array[c].key);return b};
HashMap.prototype.getIndex=function(b){for(var c=-1,a=0;a<this.array.length;a++)this.array[a].key==b&&(c=a);return c};HashMap.prototype.getIndexOfValue=function(b){for(var c=-1,a=0;a<this.array.length;a++)this.array[a].value==b&&(c=a);return c};HashMap.prototype.getKeyOfValue=function(b){for(var c=void 0,a=0;a<this.array.length;a++){var e=this.array[a];e.value==b&&(c=e.key)}return c};HashMap.prototype.contains=function(b){return-1<this.getIndexOfValue(b)};
HashMap.prototype.containsKey=function(b){return-1<this.getIndex(b)};HashMap.prototype.size=function(){return this.array.length};this.CanvasUtilities={};CanvasRenderingContext2D.prototype.clear=CanvasRenderingContext2D.prototype.clear||function(b){b&&(this.save(),this.setTransform(1,0,0,1,0,0));this.clearRect(0,0,this.canvas.width,this.canvas.height);b&&this.restore()};CanvasRenderingContext2D.prototype.roundedRect=function(b,c,a,e,d){a<2*d&&(d=a/2);e<2*d&&(d=e/2);this.beginPath();this.moveTo(b+d,c);this.arcTo(b+a,c,b+a,c+e,d);this.arcTo(b+a,c+e,b,c+e,d);this.arcTo(b,c+e,b,c,d);this.arcTo(b,c,b+a,c,d);this.closePath();return this};
CanvasRenderingContext2D.prototype.roundedRect2=function(b,c,a,e,d,f,g,h,m,s,t){"undefined"==typeof g&&(g=!0);"undefined"===typeof d&&(d=5);this.save();this.beginPath();this.moveTo(b+d,c);this.lineTo(b+a-d,c);m?(this.lineTo(b+a,c),this.lineTo(b+a,c+d)):this.quadraticCurveTo(b+a,c,b+a,c+d);this.lineTo(b+a,c+e-d);s?(this.lineTo(b+a,c+e),this.lineTo(b+a-d,c+e)):this.quadraticCurveTo(b+a,c+e,b+a-d,c+e);this.lineTo(b+d,c+e);t?(this.lineTo(b,c+e),this.lineTo(b,c+e-d)):this.quadraticCurveTo(b,c+e,b,c+e-
d);this.lineTo(b,c+d);h?(this.lineTo(b,c),this.lineTo(b+d,c)):this.quadraticCurveTo(b,c,b+d,c);this.closePath();f&&this.fill();g&&this.stroke();this.restore()};CanvasUtilities.drawLineAngle=function(b,c,a,e,d){b.save();b.moveTo(c,a);b.lineTo(c+d*Math.cos(e),a+d*Math.sin(e));b.stroke();b.restore()};
CanvasUtilities.drawHead=function(b,c,a,e,d,f,g,h){b.save();b.beginPath();b.moveTo(c,a);b.lineTo(e,d);b.lineTo(f,g);switch(h){case 0:h=Math.sqrt((f-c)*(f-c)+(g-a)*(g-a));b.arcTo(e,d,c,a,0.55*h);b.fill();break;case 1:b.lineTo(c,a);b.fill();break;case 2:b.stroke();break;case 3:b.quadraticCurveTo((c+e+f)/3,(a+d+g)/3,c,a);b.fill();break;case 4:if(f==c)h=g-a,f=(e+c)/2,e=(e+c)/2,g=d+h/5,h=d-h/5;else{h=Math.sqrt((f-c)*(f-c)+(g-a)*(g-a));e=((c+f)/2+e)/2;d=((a+g)/2+d)/2;f=(g-a)/(f-c);h=h/(2*Math.sqrt(f*f+
1))/5;var m=f*h;f=e-h;g=d-m;e+=h;h=d+m}b.bezierCurveTo(f,g,e,h,c,a);b.fill()}b.restore()};
CanvasUtilities.drawArcedArrow=function(b,c,a,e,d,f,g,h,m,s,t){h="undefined"!=typeof h?h:3;m="undefined"!=typeof m?m:1;s="undefined"!=typeof s?s:Math.PI/8;t="undefined"!=typeof t?t:10;b.save();b.beginPath();b.arc(c,a,e,d,f,g);b.stroke();var q,u,r;b.strokeStyle="rgba(0,0,0,0)";m&1&&(q=Math.cos(d)*e+c,d=Math.sin(d)*e+a,u=Math.atan2(c-q,d-a),g?(r=q+10*Math.cos(u),u=d+10*Math.sin(u)):(r=q-10*Math.cos(u),u=d-10*Math.sin(u)),CanvasUtilities.drawArrow(b,q,d,r,u,h,2,s,t));m&2&&(q=Math.cos(f)*e+c,d=Math.sin(f)*
e+a,u=Math.atan2(c-q,d-a),g?(r=q-10*Math.cos(u),u=d-10*Math.sin(u)):(r=q+10*Math.cos(u),u=d+10*Math.sin(u)),CanvasUtilities.drawArrow(b,q,d,r,u,h,2,s,t));b.restore()};
CanvasUtilities.drawArrow=function(b,c,a,e,d,f,g,h,m){f="undefined"!=typeof f?f:3;g="undefined"!=typeof g?g:1;h="undefined"!=typeof h?h:Math.PI/8;m="undefined"!=typeof m?m:10;var s="function"!=typeof f?CanvasUtilities.drawHead:f,t=Math.sqrt((e-c)*(e-c)+(d-a)*(d-a)),q=(t-m/3)/t,u,r;g&1?(t=c+(e-c)*q,u=a+(d-a)*q):(t=e,u=d);g&2?(r=c+(e-c)*(1-q),q=a+(d-a)*(1-q)):(r=c,q=a);b.beginPath();b.moveTo(r,q);b.lineTo(t,u);b.stroke();t=Math.atan2(d-a,e-c);m=Math.abs(m/Math.cos(h));if(g&1){r=t+Math.PI+h;u=e+Math.cos(r)*
m;r=d+Math.sin(r)*m;var v=t+Math.PI-h,q=e+Math.cos(v)*m,v=d+Math.sin(v)*m;s(b,u,r,e,d,q,v,f)}g&2&&(r=t+h,u=c+Math.cos(r)*m,r=a+Math.sin(r)*m,v=t-h,q=c+Math.cos(v)*m,v=a+Math.sin(v)*m,s(b,u,r,c,a,q,v,f))};CanvasUtilities.boundingBox=function(b,c,a,e){this.x1=b;this.y1=c;this.x2=b+a;this.y2=c+e;this.toString=function(){return"boundingBox(("+this.x1+","+this.y1+"),("+this.x2+","+this.y2+"))"}};
CanvasUtilities.getCanvasCursorPosition=function(b,c){var a,e;"touchmove"==b.type||"touchstart"==b.type||"touchend"==b.type?(a=b.touches[0].pageX,e=b.touches[0].pageY):b.pageX||b.pageY?(a=b.pageX,e=b.pageY):(a=b.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,e=b.clientY+document.body.scrollTop+document.documentElement.scrollTop);a-=c.offsetLeft;e-=c.offsetTop;return[a,e]};
var SLIDER_HORIZONTAL=0,SLIDER_VERTICAL=1,CVS_BUTTON_DOWN=0,CVS_BUTTON_UP=1,CVS_BUTTON_NORMAL=0,CVS_BUTTON_TOGGLE=1,CVS_BUTTON_LEFT_ARROW=2,CVS_BUTTON_RIGHT_ARROW=3;
CanvasUtilities.button=function(b,c,a,e,d,f,g,h,m,s,t){var q=this;this.eventmanager=f;this.ctx=b;this.x=c;this.y=a;this.height=d;this.width=e;this.onchange=g;this.name=h;this.state="undefined"!=typeof s?s?CVS_BUTTON_DOWN:CVS_BUTTON_UP:CVS_BUTTON_UP;this.type="undefined"!=typeof m?m:CVS_BUTTON_NORMAL;this.toggle=this.type==CVS_BUTTON_TOGGLE?!0:!1;this.color="undefined"!=typeof t?t:"rgba(205,205,205,1)";var u=new colorObject(this.color);this.getstate=function(){return q.state};this.setstate=function(a){var b=
q.state;q.state="undefined"!=typeof a?a?CVS_BUTTON_DOWN:CVS_BUTTON_UP:CVS_BUTTON_UP;if(b!=q.state)q.onchange()};this.eventhandler=function(a,b,c){a=q.state;if("keydown"==c.type)if(13==c.keyCode)q.keyupID||(q.keyupID=q.eventmanager.listen("keyup",q.hit,q.eventhandler)),q.state=q.toggle?q.state==CVS_BUTTON_DOWN?CVS_BUTTON_UP:CVS_BUTTON_DOWN:CVS_BUTTON_DOWN;else return!0;else if("keyup"==c.type)13==c.keyCode&&(q.eventmanager.quitlistening("keyup",q.keyupID),q.toggle||(q.state=CVS_BUTTON_UP));else if("mousedown"==
c.type)q.state=q.toggle?q.state==CVS_BUTTON_DOWN?CVS_BUTTON_UP:CVS_BUTTON_DOWN:CVS_BUTTON_DOWN,!q.mouseupID&&!q.toggle&&(q.mouseupID=q.eventmanager.listen("mouseup",q.hit,q.eventhandler)),!q.mouseclickID&&!q.toggle&&(q.mouseclickID=q.eventmanager.listen("mouseclick",q.hit,q.eventhandler)),!q.mouseoutID&&!q.toggle&&(q.mouseoutID=q.eventmanager.listen("mouseout",q.hit,q.eventhandler));else if("mouseup"==c.type||"mouseclick"==c.type||"mouseout"==c.type)q.toggle||(q.state=CVS_BUTTON_UP),q.mouseupID&&
(q.eventmanager.quitlistening("mouseup",q.mouseupID),q.mouseupID=null),q.mouseclickID&&(q.eventmanager.quitlistening("mouseclick",q.mouseclickID),q.mouseclickID=null),q.mouseoutID&&(q.eventmanager.quitlistening("mouseout",q.mouseoutID),q.mouseoutID=null);return q.state!=a?(q.onchange(),cancelEvent(c)):!0};this.draw=function(){q.ctx.save();q.ctx.strokeStyle="rgb(0,0,0)";q.ctx.lineWidth=1;if(q.type==CVS_BUTTON_NORMAL)if(b.roundedRect(q.x,q.y,q.width-1,q.height-1,2,!1,!0),q.ctx.strokeStyle="rgb(255,255,255)",
b.roundedRect(q.x+1,q.y+1,q.width,q.height,2,!1,!0),q.state==CVS_BUTTON_DOWN){q.ctx.fillStyle=u.mult(0.75);b.roundedRect(q.x+1,q.y+1,q.width-3,q.height-3,2,!0,!1);var a=b.createLinearGradient(q.x+1,q.y+1,q.x+1,q.height-3+q.y);a.addColorStop(0,"rgba(180,180,180,.6)");a.addColorStop(0.3,"rgba(245,245,245,1.0)");a.addColorStop(1,"rgba(0,0,0,.5)");b.fillStyle=a;b.roundedRect(q.x+1,q.y+1,q.width-3,q.height-3,2,!0,!1)}else q.state==CVS_BUTTON_UP&&(q.ctx.fillStyle=u.mult(0.92),b.roundedRect(q.x+2,q.y+2,
q.width-4,q.height-4,2,!0,!1),a=b.createLinearGradient(q.x+2,q.y+2,q.x+2,q.height+q.y),a.addColorStop(0,"rgba(255,255,255,1)"),a.addColorStop(1,"rgba(245,245,245,0.0)"),b.fillStyle=a,b.roundedRect(q.x+2,q.y+2,q.width-4,q.height-4,2,!0,!1));else q.toggle&&(b.clearRect(q.x,q.y,q.x,q.y),b.beginPath(),b.arc(q.x+0.25*q.width,q.y+0.5*q.height,7,0,2*Math.PI,!1),b.strokeStyle="rgb(0,0,0)",b.stroke(),q.state==CVS_BUTTON_DOWN&&q.toggle&&(b.beginPath(),b.fillStyle="rgb(0,0,0)",b.arc(q.x+0.25*q.width,q.y+0.5*
q.height,2,0,2*Math.PI,!1),b.fill()));if(q.name){q.ctx.fillStyle="rgb(0,0,0)";var c=q.ctx.measureText(q.name).width,a=q.toggle||q.state==CVS_BUTTON_UP?q.y+q.height/2:q.y+q.height/2+1,c=q.toggle?q.x+0.25*q.width+20:q.x+q.width/2-c/2;b.textBaseline="middle";q.ctx.fillText(q.name,c,a)}q.ctx.restore()};this.bb=new CanvasUtilities.boundingBox(this.x,this.y,this.width,this.height);this.hit=function(a,b,c){return a>=q.bb.x1&&a<=q.bb.x2&&b>=q.bb.y1&&b<=q.bb.y2?!0:!1};this.keydown=this.eventmanager.listen("keydown",
this.hit,q.eventhandler);this.mousedownID=this.eventmanager.listen("mousedown",this.hit,q.eventhandler);this.mouseclickID=this.keyupID=this.mouseupID=null};
CanvasUtilities.slider=function(b,c,a,e,d,f,g,h,m,s,t,q,u){var r=this;this.eventmanager=t;this.ctx=b;this.x=c;this.y=a;this.length=e;this.width=d;this.orientation=f;g<=h?(this.min=g,this.max=h):(this.min=h,this.max=g);this.range=this.max-this.min;this.step=m;var v=function(a,b,c,d){a=Math.round(a);a-=a%d;a<b?a=b:a>c&&(a=c);return a};this.value=v(s,this.min,this.max,this.step);this.onchange=q;this.name=u;this.sliderWidth=this.width-2;this.getValue=function(){return r.value};this.setValue=function(a){a=
v(parseInt(a,10),r.min,r.max,r.step);a!=r.value&&(r.value=a,r.onchange())};this.eventhandler=function(a,b,c){var d=r.value;if("keydown"==c.type){if(36==c.keyCode)r.value=v(r.min,r.min,r.max,r.step);else if(35==c.keyCode)r.value=v(r.max,r.min,r.max,r.step);else if(33==c.keyCode)r.value=v(r.value+2*r.step,r.min,r.max,r.step);else if(34==c.keyCode)r.value=v(r.value-2*r.step,r.min,r.max,r.step);else if(37<=c.keyCode&&40>=c.keyCode)if(37==c.keyCode||39==c.keyCode)r.value=v(r.value+(c.keyCode-38)*r.step,
r.min,r.max,r.step);else{if(38==c.keyCode||40==c.keyCode)r.value=v(r.value-(c.keyCode-39)*r.step,r.min,r.max,r.step)}else return!0;if(r.value!=d)r.onchange();return cancelEvent(c)}if("touchmove"==c.type||"touchstart"==c.type||"touchstart"==c.type)r.mousedownID&&(r.eventmanager.quitlistening("mousedown",r.mousedownID),r.mousedownID=null),r.mousewheelID&&(r.eventmanager.quitlistening("mousewheel",r.mousewheelID),r.mousewheelID=null),r.DOMMouseScrollID&&(r.eventmanager.quitlistening("DOMMouseScroll",
r.DOMMouseScrollID),r.DOMMouseScrollID=null),r.mousemoveID&&(r.eventmanager.quitlistening("mousemove",r.mousemoveID),r.mousemoveID=null),r.mouseupID&&(r.eventmanager.quitlistening("mouseup",r.mouseupID),r.mouseupID=null),r.mouseclickID&&(r.eventmanager.quitlistening("mouseclick",r.mouseclickID),r.mouseclickID=null),"touchstart"==c.type?(null==r.touchmoveID&&(r.touchmoveID=r.eventmanager.listen("touchmove",r.hit,r.eventhandler)),null==r.touchendID&&(r.touchendID=r.eventmanager.listen("touchend",r.hit,
r.eventhandler))):"touchend"==c.type&&(r.touchmoveID&&r.eventmanager.quitlistening("touchmove",r.touchmoveID),r.touchendID&&r.eventmanager.quitlistening("touchend",r.touchendID));else{if("DOMMouseScroll"==c.type||"mousewheel"==c.type){r.value=v(r.value-wheelDirection(c)*r.step,r.min,r.max,r.step);if(r.value!=d)r.onchange();return cancelEvent(c)}if("mousedown"==c.type)r.mousemoveID||(r.mousemoveID=r.eventmanager.listen("mousemove",r.hit,r.eventhandler)),r.mouseupID||(r.mouseupID=r.eventmanager.listen("mouseup",
r.hit,r.eventhandler)),r.mouseclickID||(r.mouseclickID=r.eventmanager.listen("mouseclick",r.hit,r.eventhandler)),r.mouseoutID||(r.mouseoutID=r.eventmanager.listen("mouseout",r.hit,r.eventhandler));else if("mousemove"!=c.type)return r.mousemoveID&&(r.eventmanager.quitlistening("mousemove",r.mousemoveID),r.mousemoveID=null),r.mouseupID&&(r.eventmanager.quitlistening("mouseup",r.mouseupID),r.mouseupID=null),r.mouseclickID&&(r.eventmanager.quitlistening("mouseclick",r.mouseclickID),r.mouseclickID=null),
r.mouseoutID&&(r.eventmanager.quitlistening("mouseout",r.mouseoutID),r.mouseoutID=null),cancelEvent(c)}r.value=r.orientation===SLIDER_HORIZONTAL?v(r.min+r.range*(a-(r.x+r.sliderWidth/2))/(r.length-r.sliderWidth),r.min,r.max,r.step):v(r.max-r.range*(b-(r.y+r.sliderWidth/2))/(r.length-r.sliderWidth),r.min,r.max,r.step);if(r.value!=d)r.onchange()};this.valueToPos=function(){return this.orientation===SLIDER_HORIZONTAL?(this.length-this.sliderWidth)*((this.value-this.min)/(this.max-this.min))+this.sliderWidth/
2:(this.length-this.sliderWidth)*((this.max-this.value)/(this.max-this.min))+this.sliderWidth/2};this.draw=function(){this.ctx.save();this.ctx.translate(this.x,this.y);this.orientation===this.vertical&&(b.scale(-1,1),b.rotate(Math.PI/2));this.ctx.fillStyle="rgba(180,180,180,1)";this.ctx.fillRect(0,0,this.length,this.width);this.ctx.lineWidth=1;this.ctx.strokeStyle="rgba(255,255,255,1)";this.ctx.beginPath();this.ctx.moveTo(0,this.width);this.ctx.lineTo(this.length,this.width);this.ctx.lineTo(this.length,
0);this.ctx.stroke();this.ctx.strokeStyle="rgba(0,0,0,1)";this.ctx.beginPath();this.ctx.moveTo(0,this.width);this.ctx.lineTo(0,0);this.ctx.lineTo(this.length,0);this.ctx.stroke();this.ctx.strokeStyle="rgba(90,90,90,1)";for(var a=0;a<=this.max-this.min;a++){var c=(this.length-this.sliderWidth)/((this.max-this.min)/this.step);this.ctx.beginPath();this.ctx.arc(c*a+this.sliderWidth/2,this.width/2,0.5,0,2*Math.PI,!0);this.ctx.stroke()}this.ctx.fillStyle="rgba(230,230,230,1)";this.ctx.strokeStyle="rgba(220,220,220,1)";
a=this.valueToPos();this.ctx.lineWidth=1;this.ctx.beginPath();this.ctx.arc(a,this.width/2,this.sliderWidth/2,0,2*Math.PI,!1);this.ctx.fill();this.ctx.stroke();this.ctx.strokeStyle="rgba(255,255,255,1)";this.ctx.beginPath();this.ctx.arc(a,this.width/2,this.sliderWidth/2,0.9*Math.PI,1.6*Math.PI,!1);this.ctx.stroke();this.ctx.strokeStyle="rgba(100,100,100,1)";this.ctx.beginPath();this.ctx.arc(a,this.width/2,this.sliderWidth/2,0*Math.PI,0.65*Math.PI,!1);this.ctx.stroke();this.ctx.restore()};this.bb=this.orientation==
SLIDER_HORIZONTAL?new CanvasUtilities.boundingBox(this.x,this.y,this.length,this.width):new CanvasUtilities.boundingBox(this.x,this.y,this.width,this.length);this.hit=function(a,b,c){return a>=r.bb.x1&&a<=r.bb.x2&&b>=r.bb.y1&&b<=r.bb.y2?!0:!1};this.keydown=this.eventmanager.listen("keydown",this.hit,r.eventhandler);this.mousedownID=this.eventmanager.listen("mousedown",this.hit,r.eventhandler);this.mousewheel=this.eventmanager.listen("mousewheel",this.hit,r.eventhandler);this.DOMMouseScrollID=this.eventmanager.listen("DOMMouseScroll",
this.hit,r.eventhandler);this.touchstartID=this.eventmanager.listen("touchstart",this.hit,r.eventhandler);this.mouseclickID=this.mouseupID=this.mousemoveID=this.touchendID=this.touchmoveID=null};CanvasUtilities.eventListener=function(b,c,a,e){this.id=b;this.eventType=c;this.hit=a;this.callback=e;this.toString=function(){return"eventListener("+b+","+c+","+a+",callback)"}};
CanvasUtilities.eventManager=function(b){var c=this;this.id=0;this.queues={};this.canvasManager=b;this.listen=function(a,b,c){var f=this.queues[a];if(null==f)this.queues[a]=[],f=this.queues[a];else for(var g=0;g<f.length;g++)if(a==f[g].eventType&&b==f[g].hit&&c==f[g].callback)return alert("duplicate! ctr: "+g+" eventType: "+f[g].eventType+" x: "+f[g].boundingbox.x+" y: "+f[g].boundingbox.y+" xextent: "+f[g].boundingbox.xextent+" yextent: "+f[g].boundingbox.yextent),f[g].id;f[f.length]=new CanvasUtilities.eventListener(this.id,
a,b,c);1==f.length&&hookEvent(this.canvasManager.canvas,a,this.eventhandler);this.id+=1;return this.id-1};this.quitlistening=function(a,b){var c=this.queues[a];if(null!=c)for(var f=0;f<c.length;f++)c[f].id==b&&c.remove(f,f),0==c.length&&("mouseover"!=a&&"mouseout"!=a)&&unhookEvent(this.canvasManager.canvas,a,this.eventhandler)};this.eventhandler=function(a){var b;a||(a=window.event);c.canvasManager.canvas.focus();"mouseout"==a.type&&c.canvasManager.canvas.blur();b=CanvasUtilities.getCanvasCursorPosition(a,
c.canvasManager.canvas);var d=c.queues[a.type],f=!0;if(null!=d)for(var g=0;g<d.length;++g){var h=d[g];if(h.hit(b[0],b[1],a)){if(h.callback(b[0],b[1],a)||(f=!1),"mousedown"==a.type||"touchstart"==a.type||"mousewheel"==a.type||"DOMMouseScroll"==a.type||"touchmove"==a.type||"touchend"==a.type||"touchdown"==a.type||"keydown"==a.type)c.mousefocusedCB=h.callback}else if(h.callback==c.mousefocusedCB&&("mouseup"==a.type||"mouseout"==a.type||"click"==a.type||"mousemove"==a.type||"touchmove"==a.type||"touchend"==
a.type||"mousewheel"==a.type||"DOMMouseScroll"==a.type||"keydown"==a.type))c.mousefocusedCB(b[0],b[1],a)||(f=!1),"mousemove"!=a.type&&("touchmove"!=a.type&&"mousewheel"!=a.type&&"DOMMouseScroll"!=a.type&&"keydown"!=a.type)&&(c.mousefocusedCB=null)}return f};hookEvent(this.canvasManager.canvas,"mouseout",this.eventhandler);hookEvent(this.canvasManager.canvas,"mouseover",this.eventhandler)};
CanvasUtilities.Clock=function(b){var c=document.getElementById(b),a=c.getContext("2d"),e=Math.PI;this.now;var d=c.width/2,f=c.height/2,g=Math.min(0.85*d,0.85*f),h=g/3;this.start=function(){setInterval(CanvasUtilities.drawclock,1E3)};this.drawbody=function(){a.save();a.shadowOffsetX=Math.max(0.04*g,1);a.shadowOffsetY=Math.max(0.04*g,1);a.shadowBlur=Math.max(0.04*g,1);a.shadowColor="rgba(0,0,0,.2)";a.beginPath();a.arc(d,f,g,0,2*e,!1);a.fillStyle="rgb(255,255,180)";a.fill();a.strokeStyle="rgb(30,110,30)";
a.lineWidth=Math.max(g/5,1);a.stroke();a.strokeStyle="rgb(70,150,80)";a.lineWidth=Math.max(g/15,1);a.stroke();a.restore()};this.drawback=function(){a.save();a.beginPath();a.moveTo(d,f);a.arc(d,f,Math.max(0.03*g,1),0,2*e,!1);a.stroke();a.beginPath();for(var b=0;60>b;b++){var c=2*b*e/60,t=0.9*g*Math.cos(c)+d,q=0.9*g*Math.sin(c)+f,u=0.95*g*Math.cos(c)+d,c=0.95*g*Math.sin(c)+f;a.moveTo(t,q);a.lineTo(u,c);a.lineWidth=1;a.stroke()}a.beginPath();a.lineWidth=Math.max(0.05*g,1);for(b=0;12>b;b++)c=2*b*e/12,
t=0.8*g*Math.cos(c)+d,q=0.8*g*Math.sin(c)+f,u=0.95*g*Math.cos(c)+d,c=0.95*g*Math.sin(c)+f,a.moveTo(t,q),a.lineTo(u,c),a.stroke();t="3 4 5 6 7 8 9 10 11 12 1 2".split(" ");a.font=h+"px Times,'Times New Roman',sans-serif";a.textBaseline="middle";for(b=0;12>b;b++)c=2*b*e/12,u=0.5*g,q=u*Math.cos(c)+d-(1-Math.cos(c))/2*a.measureText(t[b]).width,c=u*Math.sin(c)+f+h/3*Math.sin(c),a.fillText(t[b],q,c);a.restore()};this.drawhands=function(){a.save();a.shadowBlur=Math.max(0.04*g,1);a.fillStyle="rgb(100,80,40,0)";
for(var b=0;b<Math.max(0.07*g,1);b+=0.1)a.shadowColor="rgba(0,0,0,.01)",a.beginPath(),a.shadowOffsetX=b,a.shadowOffsetY=b,a.arc(d,f,Math.max(0.04*g,1),0,2*e,!1),a.fill();a.shadowColor="rgba(0,5,0,.5)";a.fillStyle="rgb(0,0,0)";a.shadowOffsetX=Math.max(0.03*g,1);a.shadowOffsetY=Math.max(0.03*g,1);var b=3*e/2+2*e/12*(self.now.getHours()+self.now.getMinutes()/60),c=0.5*g*Math.cos(b)+d,h=0.5*g*Math.sin(b)+f;a.lineWidth=Math.max(0.03*g,1);CanvasUtilities.drawArrow(a,d,f,c,h,3,1,Math.PI/4,0.15*g);c=0.2*
g*Math.cos(b+e)+d;h=0.2*g*Math.sin(b+e)+f;a.beginPath();a.moveTo(d,f);a.lineWidth=Math.max(0.06*g,1);a.lineTo(c,h);a.stroke();a.shadowOffsetX=Math.max(0.05*g,1);a.shadowOffsetY=Math.max(0.05*g,1);b=3*e/2+2*e/60*self.now.getMinutes();c=0.85*g*Math.cos(b)+d;h=0.85*g*Math.sin(b)+f;a.lineWidth=Math.max(0.03*g,1);CanvasUtilities.drawArrow(a,d,f,c,h,3,1,Math.PI/4,0.2*g);c=0.25*g*Math.cos(b+e)+d;h=0.25*g*Math.sin(b+e)+f;a.beginPath();a.moveTo(d,f);a.lineWidth=Math.max(0.06*g,1);a.lineTo(c,h);a.stroke();
a.shadowOffsetX=Math.max(0.07*g,1);a.shadowOffsetY=Math.max(0.07*g,1);a.fillStyle="rgb(255,0,0)";a.strokeStyle="rgb(255,0,0)";b=3*e/2+2*e/60*self.now.getSeconds();c=0.75*g*Math.cos(b)+d;h=0.75*g*Math.sin(b)+f;a.lineWidth=1.01;CanvasUtilities.drawArrow(a,d,f,c,h,3,1,Math.PI/20,0.22*g);c=0.25*g*Math.cos(b+e)+d;h=0.25*g*Math.sin(b+e)+f;a.beginPath();a.moveTo(d,f);a.lineWidth=Math.max(0.04*g,1);a.lineTo(c,h);a.stroke();a.fillStyle="rgb(100,80,40)";a.beginPath();a.arc(d,f,Math.max(0.04*g,1),0,2*e,!1);
a.fill();a.restore();a.beginPath();a.moveTo(d,f);a.fillStyle="rgb(255,255,0)";a.arc(d,f,Math.max(0.03*g,1),0,2*e,!1);a.fill()};this.drawhighlights=function(){a.save();a.shadowOffsetX=Math.max(0.05*g,1);a.shadowOffsetY=Math.max(0.05*g,1);a.shadowBlur=Math.max(0.08*g,1);a.shadowColor="rgba(0,0,0,.5)";a.strokeStyle="rgba(255,255,255,.40)";a.lineWidth=Math.max(0.1*g,1);a.beginPath();a.arc(d,f,0.9*g,0,2*e,!1);a.stroke();a.strokeStyle="rgba(255,255,255,.45)";a.lineWidth=Math.max(0.03*g,1);a.beginPath();
a.arc(d,f,0.9*g,0,2*e,!1);a.stroke();a.beginPath();var b=a.createRadialGradient(d+0.1*g,f-0.3*g,10,d,f,g);b.addColorStop(0,"rgba(255,255,255,.2)");b.addColorStop(0.01,"rgba(255,255,255,.1)");b.addColorStop(1,"rgba(255,255,255,0)");a.fillStyle=b;a.arc(d,f,g,0,2*e,!1);a.fill();a.restore()};this.drawclock=function(){a.save();this.now=new Date;a.clearRect(0,0,c.width,c.height);a.strokeStyle="rgb(0,0,0)";a.fillStyle="rgb(0,0,0)";a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;a.shadowColor="rgba(0,0,0,0)";
drawbody();drawback();drawhands();drawhighlights();delete this.now}};function GLTools(){GLTools.prototype.RenderLayer=function(b,c){id=c.i;cl=c.c;ll=c.g;if(null!=ll)for(l=0;l<ll.length;++l){lines=ll[l];for(li=0;li<lines.length;++li){line=lines[li];b.beginPath();b.moveTo(line[0],line[1]);for(p=2;p<line.length-1;p+=2)b.lineTo(line[p],line[p+1]);"c"==line[line.length-1]&&b.closePath();this[cl](b)}}};GLTools.prototype.LoadCanvasAsTexture=function(b,c,a){var e=b.createTexture();e.isLoad=!1;e.error=!1;e.req=$.ajax({type:"GET",url:c,dataType:"json",success:function(c,f,g){e.svgRenderer=
document.createElement("canvas");e.svgRenderer.height=256;e.svgRenderer.width=256;for(i=0;i<c.l.length;++i)RenderLayer(e.svgRenderer.getContext("2d"),c.l[i]);b.bindTexture(b.TEXTURE_2D,e);b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!0);b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,e.svgRenderer);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST);b.bindTexture(b.TEXTURE_2D,null);e.isLoad=!0;e.Error=!1;a()},error:function(b,
f,g){e.isLoad=!0;e.error=!0;console.log(c+" : loading failed : "+f);a({},{})}});return e};GLTools.prototype.LoadSvgAsTexture=function(b,c,a){var e=b.createTexture();e.isLoad=!1;e.error=!1;var d=new Image;e.req=$.ajax({type:"GET",url:c,dataType:"text",success:function(c,g,h){d.onload=function(){e.svgRenderer=document.createElement("canvas");e.svgRenderer.getContext("2d").drawImage(d,0,0);b.bindTexture(b.TEXTURE_2D,e);b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!0);b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,
b.UNSIGNED_BYTE,e.svgRenderer);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST);b.bindTexture(b.TEXTURE_2D,null);e.isLoad=!0;e.Error=!1;a()};d.src="data:image/svg+xml;base64,"+btoa(c)},error:function(b,d,e){shader.isLoad=!0;shader.error=!0;console.log(c+" : loading failed : "+d);a({},{})}});return e};GLTools.prototype.CreateFrameBufferTex=function(b,c,a){var e=b.createFramebuffer(),d=b.createTexture();b.bindFramebuffer(b.FRAMEBUFFER,
e);e.width=c;e.height=a;b.bindTexture(b.TEXTURE_2D,d);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST);b.texImage2D(b.TEXTURE_2D,0,b.RGBA,e.width,e.height,0,b.RGBA,b.UNSIGNED_BYTE,null);b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,d,0);b.bindTexture(b.TEXTURE_2D,null);b.bindFramebuffer(b.FRAMEBUFFER,null);return[e,d]};GLTools.prototype.BuildShader=function(b,c){var a={error:!1,obj:null};a.attributes=
c.attributes;a.parameters=c.parameters;if("x-shader/x-fragment"==c.type)a.obj=b.createShader(b.FRAGMENT_SHADER);else if("x-shader/x-vertex"==c.type)a.obj=b.createShader(b.VERTEX_SHADER);else{a.error=!0;return}b.shaderSource(a.obj,c.code);b.compileShader(a.obj);b.getShaderParameter(a.obj,b.COMPILE_STATUS)||(a.error=!0,console.log("Build "+c.name+" : Failed ! "),console.log(b.getShaderInfoLog(a.obj)));return a};GLTools.prototype.MakeProgram=function(b,c,a){if(!a.shaderData)return console.log("invalid shader data"),
null;if(!(b in a.shaderData))return console.log(b+" not in shader data"),null;if(!(c in a.shaderData))return console.log(c+" not in shader data"),null;var e=a.shaderData[b];e.name=b;var d=a.shaderData[c];d.name=c;a=a.ctx;e=this.BuildShader(a,e);d=this.BuildShader(a,d);if(e.error||d.error)return null;var f=a.createProgram();f.error=!1;f.attr={};f.params={};var g={},h={};jQuery.extend(g,e.attributes);jQuery.extend(h,e.parameters);jQuery.extend(g,d.attributes);jQuery.extend(h,d.parameters);a.attachShader(f,
e.obj);a.attachShader(f,d.obj);a.linkProgram(f);if(a.getProgramParameter(f,a.LINK_STATUS)){a.useProgram(f);for(var m in g)f.attr[m]=a.getAttribLocation(f,g[m]);for(m in h)f.params[m]=a.getUniformLocation(f,h[m]);return f}console.log("Could not link programm with "+b+" and "+c);f.error=!0};GLTools.prototype.LoadTexture=function(b,c,a){var e=b.createTexture();e.isLoad=!1;e.error=!1;var d=new Image;d.onload=function(){b.bindTexture(b.TEXTURE_2D,e);b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!0);b.texImage2D(b.TEXTURE_2D,
0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,d);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST);b.bindTexture(b.TEXTURE_2D,null);e.isLoad=!0;delete d;a()};d.onerror=function(){e.isLoad=!0;e.error=!0;delete d};d.onabort=function(){e.isLoad=!0;e.error=!0;delete d};d.src=c;return e};GLTools.prototype.LoadCsvTexture=function(b,c,a){document.createElement("canvas");canvg(this.svgRenderer,"test/auv.svg");var e=b.createTexture();e.isLoad=!1;e.error=
!1;var d=new Image;d.onload=function(){b.bindTexture(b.TEXTURE_2D,e);b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!0);b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,d);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST);b.bindTexture(b.TEXTURE_2D,null);e.isLoad=!0;delete d;a()};d.onerror=function(){e.isLoad=!0;e.error=!0;delete d};d.onabort=function(){e.isLoad=!0;e.error=!0;delete d};d.src=c;return e};GLTools.prototype.LoadData=
function(b,c){var a=b.createTexture();a.isLoad=!1;a.error=!1;a.req=$.ajax({type:"GET",url:c,dataType:"json",success:function(c,d,f){a.isLoad=!0;a.error=!1;b.bindTexture(b.TEXTURE_2D,a);b.texImage2D(b.TEXTURE_2D,0,b[c.input_type],c.width,c.height,0,b[c.output_type],b.UNSIGNED_BYTE,new Uint8Array(c.data));b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST)},error:function(b,d,f){a.isLoad=!0;a.error=!0;console.log(c+" : loading failed : "+
d)}});a.src=c;return a}};function RasterLayer(b,c,a){this.mapParameters=b;this.assets=b.assets;this.gl=b.assets.ctx;this.data=this.tex=null;this.h=this.w=0;this.z=a}RasterLayer.prototype.GetType=function(){return LayersManager.Raster};RasterLayer.prototype.Init=function(b){if(!this.tex&&b){var c=new Uint8Array(b),a=c[0]+1,c=new Uint8Array(b.slice(1));b=c.length/a;this.w=a;this.h=b;this.data=c}};RasterLayer.prototype.Reset=function(){var b=this.gl;this.tex&&(b.deleteTexture(this.tex),delete this.tex,this.tex=null)};
RasterLayer.prototype.Release=function(){var b=this.gl;this.tex&&(b.deleteTexture(this.tex),delete this.tex,this.tex=null);this.data&&(delete this.data,this.data=null)};RasterLayer.prototype.IsUpToDate=function(){return null!=this.tex};
RasterLayer.prototype.Update=function(b){if(this.tex)return 1;var c=this.gl;b=this.mapParameters.GetColorBar(b.colorbar);if(!b||!b.tex)console.log("Invalid color bar : setting default"),this.mapParameters.SetDefaultColorBar();else{if(this.data){var a=(new GLTools).CreateFrameBufferTex(c,this.w,this.h),e=c.createTexture();this.tex=a[1];c.bindTexture(c.TEXTURE_2D,e);c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!1);c.texImage2D(c.TEXTURE_2D,0,c.LUMINANCE,this.w,this.h,0,c.LUMINANCE,c.UNSIGNED_BYTE,this.data);
c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE);c.bindFramebuffer(c.FRAMEBUFFER,a[0]);this.gl.clearColor(1,1,1,1);this.gl.disable(this.gl.DEPTH_TEST);c.viewport(0,0,a[0].width,a[0].height);c.clear(c.COLOR_BUFFER_BIT);mvMatrix=mat4.create();pMatrix=mat4.create();mat4.identity(mvMatrix);mat4.scale(mvMatrix,
[this.w/MapParameters.tileSize,this.h/MapParameters.tileSize,1]);mat4.identity(pMatrix);mat4.ortho(0,a[0].width,0,a[0].height,0,1,pMatrix);var d=this.assets.prog.Clut;c.useProgram(d);c.uniformMatrix4fv(d.params.pMatrixUniform,!1,pMatrix);c.uniformMatrix4fv(d.params.mvMatrixUniform,!1,mvMatrix);c.bindBuffer(c.ARRAY_BUFFER,this.assets.squareVertexPositionBuffer);c.enableVertexAttribArray(d.attr.vertexPositionAttribute);c.vertexAttribPointer(d.attr.vertexPositionAttribute,this.assets.squareVertexPositionBuffer.itemSize,
c.FLOAT,!1,0,0);c.bindBuffer(c.ARRAY_BUFFER,this.assets.squareVertexTextureBuffer);c.enableVertexAttribArray(d.attr.textureCoordAttribute);c.vertexAttribPointer(d.attr.textureCoordAttribute,this.assets.squareVertexTextureBuffer.itemSize,c.FLOAT,!1,0,0);c.activeTexture(c.TEXTURE0);c.bindTexture(c.TEXTURE_2D,e);c.uniform1i(d.params.uSamplerTex1,0);c.activeTexture(c.TEXTURE1);c.bindTexture(c.TEXTURE_2D,b.tex);c.uniform1i(d.params.uSamplerTex2,1);c.uniform4fv(d.params.uParams,[0,2,0,1]);c.drawArrays(c.TRIANGLE_STRIP,
0,this.assets.squareVertexPositionBuffer.numItems);c.bindFramebuffer(c.FRAMEBUFFER,null);c.activeTexture(c.TEXTURE0);c.bindTexture(c.TEXTURE_2D,null);c.activeTexture(c.TEXTURE1);c.bindTexture(c.TEXTURE_2D,null);c.deleteTexture(e);c.deleteFramebuffer(a[0])}else this.tex=c.createTexture(),c.bindTexture(c.TEXTURE_2D,this.tex),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!1),b=new Uint8Array([1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0]),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,2,2,0,c.RGBA,c.UNSIGNED_BYTE,b),c.texParameteri(c.TEXTURE_2D,
c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.bindTexture(c.TEXTURE_2D,null),this.h=this.w=2;return 2}};function Tile(b,c,a,e){this.groups=b.maperial.config.groups;this.layersConfig=b.maperial.config.layers;this.x=c;this.y=a;this.z=e;this.parameters=b;this.assets=b.assets;this.gl=b.assets.ctx;this.error=!1;this.layers={};this.data={};this.requests={};this.load={};this.errors={};this.frameBufferL=[];this.texL=[];this.tex=null;this.Init()}Tile.prototype.Init=function(){this.initLayers();this.loadSources();this.prepareBuffering()};
Tile.prototype.initLayers=function(){for(var b=0;b<this.layersConfig.length;b++)switch(this.layersConfig[b].type){case LayersManager.Vector:this.layers[b]=new VectorialLayer(this.parameters,this.z);break;case LayersManager.Raster:this.layers[b]=new RasterLayer(this.parameters,this.z)}};
Tile.prototype.loadSources=function(){for(var b=0;b<this.parameters.sources.length;b++){var c=this.parameters.sources[b];if(this.requests[c.type])return!1;switch(c.type){case Source.MaperialOSM:this.LoadVectorial(c);break;case Source.Raster:this.LoadRaster(c)}}};Tile.prototype.prepareBuffering=function(){for(var b=new GLTools,c=0;2>c;c+=1){var a=b.CreateFrameBufferTex(this.gl,MapParameters.tileSize,MapParameters.tileSize);this.frameBufferL.push(a[0]);this.texL.push(a[1])}};
Tile.prototype.Release=function(){for(var b=0;b<this.parameters.sources.length;b++){b=this.parameters.sources[b];this.requests[b.type]&&this.requests[b.type].abort();for(var c=0;c<this.layersConfig.length;c++)this.layersConfig[c].source.type==b.type&&this.layers[c].Release();delete this.data[b.type];c=this.gl;for(b=0;2>b;b+=1)c.deleteFramebuffer(this.frameBufferL[b]),c.deleteTexture(this.texL[b])}};
Tile.prototype.Reset=function(){if(this.IsLoaded()){for(i in this.layers)this.layers[i].Reset();this.tex=null}};Tile.prototype.IsLoaded=function(){for(var b=0;b<this.parameters.sources.length;b++)if(!this.load[this.parameters.sources[b].type])return!1;return!0};Tile.prototype.IsUpToDate=function(){return this.tex};
Tile.prototype.LoadVectorial=function(b){var c=this;this.requests[b.type]=$.ajax({type:"GET",url:b.getURL(this.x,this.y,this.z),dataType:"json",timeout:MapParameters.tileDLTimeOut,success:function(a,e,d){a?c.data[b.type]=a:c.error[b.type]=!0;c.appendDataToLayers(b.type,a);c.load[b.type]=!0},error:function(a,e,d){c.error[b.type]=!0;c.load[b.type]=!0;c.appendDataToLayers(b.type,null)}})};
Tile.prototype.LoadRaster=function(b){function c(){a.requests[b.type].abort()}if(b.getURL(this.x,this.y,this.z)){var a=this;this.requests[b.type]=new XMLHttpRequest;this.requests[b.type].open("GET",b.getURL(this.x,this.y,this.z),!0);this.requests[b.type].responseType="arraybuffer";this.requests[b.type].onload=function(c){if((c=a.requests[b.type].response)&&(200!=a.requests[b.type].status||0>=c.byteLength))c=null;a.error[b.type]=null!=c;a.load[b.type]=!0;a.appendDataToLayers(b.type,c)};this.requests[b.type].onerror=
function(c){a.error[b.type]=!0;a.load[b.type]=!0;a.appendDataToLayers(b.type,null)};setTimeout(c,MapParameters.tileDLTimeOut);this.requests[b.type].send(null)}else this.error[b.type]=!0,this.load[b.type]=!0};Tile.prototype.appendDataToLayers=function(b,c){for(var a=0;a<this.layersConfig.length;a++)this.layersConfig[a].source.type==b&&this.layers[a].Init(c)};
Tile.prototype.RenderVectorialLayers=function(b,c,a){for(i in this.layers)this.layers[i].GetType()==LayersManager.Vector&&(this.layers[i].IsUpToDate()&&this.layers[i].cnv)&&b.drawImage(this.layers[i].cnv,c,a)};
Tile.prototype.FindSubLayerId=function(b,c,a){var e=document.getElementById("dummyTilesCanvas"),d=e.getContext("2d");ExtendCanvasContext(d);e.height=1;e.width=1;d.translate(-b.x,-b.y);for(e=this.layersConfig.length-1;0<=e;--e)if(this.layersConfig[e].source.type==Source.MaperialOSM){var f=TileRenderer.FindSubLayerId(b,d,this.data[Source.MaperialOSM],c,a,this.layersConfig[e].params.group,this.groups);if(f)return f}};
Tile.prototype.Update=function(b){if(this.IsUpToDate()||!this.IsLoaded())return b-1;for(var c=0;c<this.layersConfig.length&&(this.layers[c].IsUpToDate()||!(b-=this.layers[c].Update(this.layersConfig[c].params),0>=b));c++);var a=!0;for(c in this.layers)this.layers[c].IsUpToDate()||(a=!1);a&&this.Compose();return b};
Tile.prototype.Fuse=function(b,c,a,e,d){var f=this.gl;f.bindFramebuffer(f.FRAMEBUFFER,a);this.gl.clearColor(1,1,1,1);this.gl.disable(this.gl.DEPTH_TEST);f.viewport(0,0,a.width,a.height);f.clear(f.COLOR_BUFFER_BIT);mvMatrix=mat4.create();pMatrix=mat4.create();mat4.identity(pMatrix);mat4.identity(mvMatrix);mat4.ortho(0,a.width,0,a.height,0,1,pMatrix);this.gl.useProgram(e);this.gl.uniformMatrix4fv(e.params.pMatrixUniform,!1,pMatrix);this.gl.uniformMatrix4fv(e.params.mvMatrixUniform,!1,mvMatrix);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,
this.assets.squareVertexPositionBuffer);this.gl.enableVertexAttribArray(e.attr.vertexPositionAttribute);this.gl.vertexAttribPointer(e.attr.vertexPositionAttribute,this.assets.squareVertexPositionBuffer.itemSize,this.gl.FLOAT,!1,0,0);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.assets.squareVertexTextureBuffer);this.gl.enableVertexAttribArray(e.attr.textureCoordAttribute);this.gl.vertexAttribPointer(e.attr.textureCoordAttribute,this.assets.squareVertexTextureBuffer.itemSize,this.gl.FLOAT,!1,0,0);this.gl.activeTexture(this.gl.TEXTURE0);
this.gl.bindTexture(this.gl.TEXTURE_2D,b);this.gl.uniform1i(e.params.uSamplerTex1,0);this.gl.activeTexture(this.gl.TEXTURE1);this.gl.bindTexture(this.gl.TEXTURE_2D,c);this.gl.uniform1i(e.params.uSamplerTex2,1);this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,this.assets.squareVertexPositionBuffer.numItems);for(var g in d)this.gl.uniform3fv(e.params[g],d[g]);f.bindFramebuffer(f.FRAMEBUFFER,null);this.gl.activeTexture(this.gl.TEXTURE0);this.gl.bindTexture(this.gl.TEXTURE_2D,null);this.gl.activeTexture(this.gl.TEXTURE1);
this.gl.bindTexture(this.gl.TEXTURE_2D,null)};
Tile.prototype.Copy=function(b,c){var a=this.gl;a.bindFramebuffer(a.FRAMEBUFFER,c);this.gl.clearColor(1,1,1,1);this.gl.disable(this.gl.DEPTH_TEST);a.viewport(0,0,c.width,c.height);a.clear(a.COLOR_BUFFER_BIT);mvMatrix=mat4.create();pMatrix=mat4.create();mat4.identity(pMatrix);mat4.identity(mvMatrix);mat4.ortho(0,c.width,0,c.height,0,1,pMatrix);var e=this.assets.prog.Tex;this.gl.useProgram(e);this.gl.uniformMatrix4fv(e.params.pMatrixUniform,!1,pMatrix);this.gl.uniformMatrix4fv(e.params.mvMatrixUniform,
!1,mvMatrix);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.assets.squareVertexPositionBuffer);this.gl.enableVertexAttribArray(e.attr.vertexPositionAttribute);this.gl.vertexAttribPointer(e.attr.vertexPositionAttribute,this.assets.squareVertexPositionBuffer.itemSize,this.gl.FLOAT,!1,0,0);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.assets.squareVertexTextureBuffer);this.gl.enableVertexAttribArray(e.attr.textureCoordAttribute);this.gl.vertexAttribPointer(e.attr.textureCoordAttribute,this.assets.squareVertexTextureBuffer.itemSize,
this.gl.FLOAT,!1,0,0);this.gl.activeTexture(this.gl.TEXTURE0);this.gl.bindTexture(this.gl.TEXTURE_2D,b);this.gl.uniform1i(e.params.uSamplerTex1,0);this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,this.assets.squareVertexPositionBuffer.numItems);a.bindFramebuffer(a.FRAMEBUFFER,null);this.gl.activeTexture(this.gl.TEXTURE0);this.gl.bindTexture(this.gl.TEXTURE_2D,null)};
Tile.prototype.Compose=function(){var b=this.layers[0].tex,c=this.frameBufferL[0],a=0;if(1<this.layers.length)for(var e=1;e<this.layers.length;e++){var d=this.layers[e].tex;d?this.Fuse(b,d,c,this.assets.prog[this.layersConfig[e].composition.shader],this.layersConfig[e].composition.params):this.Copy(b,c);this.tex=b=this.texL[a];a=(a+1)%2;c=this.frameBufferL[a]}else this.Copy(b,c),this.tex=this.texL[0]};
Tile.prototype.Render=function(b,c){if(this.IsUpToDate()){var a=this.assets.prog.Tex;this.gl.useProgram(a);this.gl.uniformMatrix4fv(a.params.pMatrixUniform,!1,b);this.gl.uniformMatrix4fv(a.params.mvMatrixUniform,!1,c);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.assets.squareVertexPositionBuffer);this.gl.enableVertexAttribArray(a.attr.vertexPositionAttribute);this.gl.vertexAttribPointer(a.attr.vertexPositionAttribute,this.assets.squareVertexPositionBuffer.itemSize,this.gl.FLOAT,!1,0,0);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,
this.assets.squareVertexTextureBuffer);this.gl.enableVertexAttribArray(a.attr.textureCoordAttribute);this.gl.vertexAttribPointer(a.attr.textureCoordAttribute,this.assets.squareVertexTextureBuffer.itemSize,this.gl.FLOAT,!1,0,0);this.gl.activeTexture(this.gl.TEXTURE0);this.gl.bindTexture(this.gl.TEXTURE_2D,this.tex);var e=this.gl.getError();0!=e&&console.log(e);this.gl.uniform1i(a.params.uSamplerTex1,0);this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,this.assets.squareVertexPositionBuffer.numItems);this.gl.activeTexture(this.gl.TEXTURE0);
this.gl.bindTexture(this.gl.TEXTURE_2D,null)}};VectorialLayer.BACK="back";VectorialLayer.FRONT="front";function VectorialLayer(b,c){this.mapParameters=b;this.assets=b.assets;this.gl=b.assets.ctx;this.data=this.ctx=this.tex=this.cnv=null;this.z=c;this.layerCount=0}VectorialLayer.prototype.GetType=function(){return LayersManager.Vector};
VectorialLayer.prototype.Init=function(b){if(!this.tex){this.data=b;var c=this.gl;b?(this.tex=c.createTexture(),this.cnv=document.createElement("canvas"),this.cnv.height=MapParameters.tileSize,this.cnv.width=MapParameters.tileSize,this.ctx=this.cnv.getContext("2d"),ExtendCanvasContext(this.ctx),this.ctx.globalCompositeOperation="source-over",this.ctx.beginPath(),this.ctx.rect(0,0,this.cnv.width,this.cnv.height),this.ctx.closePath(),this.ctx.fillStyle="rgba(255,255,255,0.0)",this.ctx.fill()):(this.tex=
c.createTexture(),this.layerCount=null,c.bindTexture(c.TEXTURE_2D,this.tex),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!1),b=new Uint8Array([1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0]),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,2,2,0,c.RGBA,c.UNSIGNED_BYTE,b),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.bindTexture(c.TEXTURE_2D,null))}};
VectorialLayer.prototype.Reset=function(){this.layerCount=0;delete this.cnv;this.cnv=document.createElement("canvas");this.cnv.height=MapParameters.tileSize;this.cnv.width=MapParameters.tileSize;this.ctx=this.cnv.getContext("2d");ExtendCanvasContext(this.ctx);this.ctx.globalCompositeOperation="source-over";this.ctx.beginPath();this.ctx.closePath()};
VectorialLayer.prototype.Release=function(){var b=this.gl;this.tex&&(b.deleteTexture(this.tex),delete this.tex,this.tex=0);this.cnv&&(delete this.cnv,this.cnv=null)};VectorialLayer.prototype.IsUpToDate=function(){return null==this.layerCount};
VectorialLayer.prototype.Update=function(b){var c=b.group;b=this.mapParameters.maperial.stylesManager.getStyle(b.styles[b.selectedStyle]).content;var a=this.mapParameters.maperial.config.groups;b||(console.log("Invalid style"),this.layerCount=0,this._BuildTexture());c=TileRenderer.RenderLayers(a,c,this.ctx,this.data,this.z,b,this.layerCount);this.layerCount=c[0];this.IsUpToDate()&&this._BuildTexture();return c[1]};
VectorialLayer.prototype._BuildTexture=function(){var b=this.gl;b.bindTexture(b.TEXTURE_2D,this.tex);b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!1);b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,this.cnv);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST);b.bindTexture(b.TEXTURE_2D,null)};function RenderLine(b,c){b.beginPath();b.moveTo(c[0],c[1]);for(var a=2;a<c.length-1;a+=2)b.lineTo(c[a],c[a+1]);"c"==c[c.length-1]&&b.closePath()}
function RenderLineDA(b,c,a){0!=a.length%2&&(a=a.concat(a));c=c.slice(0);var e=!1;"c"==c[c.length-1]?(c.pop(),c.push(c[0]),c.push(c[1]),e=!0):c.pop();if(4>c.length)RenderLine(b,c);else{b.beginPath();b.moveTo(c[0],c[1]);for(var d=0,f=a.length,g=0,h=0,m=0;m<c.length-4;m+=2)for(var s=c[m+0],t=c[m+1],q=c[m+2]-s,u=c[m+3]-t,r=Math.sqrt(q*q+u*u);;){0==g?h+=a[d]:(h+=g,g=0);if(h>=r){0==d%2?b.lineTo(w,v):b.moveTo(w,v);g=h-r;h=0;0==g&&(d=(d+1)%f);break}var v=h/r,w=s+q*v,v=t+u*v;0==d%2?b.lineTo(w,v):b.moveTo(w,
v);d=(d+1)%f}e&&b.closePath()}};var FontFamily=function(){var b={},c={oblique:"italic",italic:"oblique"};this.add=function(a){(b[a.style]||(b[a.style]={}))[a.weight]=a};this.get=function(a,e){"undefined"===typeof a&&(a="normal");"undefined"===typeof e&&(e="normal");var d=b[a]||b[c[a]]||b.normal||b.italic||b.oblique;if(!d)return null;e={normal:400,bold:700}[e]||parseInt(e,10);if(d[e])return d[e];var f={1:1,99:0}[e%100],g=[],h,m;void 0===f&&(f=400<e);500==e&&(e=400);for(var s in d)if(hasOwnProperty(d,s)){s=parseInt(s,10);if(!h||s<
h)h=s;if(!m||s>m)m=s;g.push(s)}e<h&&(e=h);e>m&&(e=m);g.sort(function(a,b){return(f?a>=e&&b>=e?a<b:a>b:a<=e&&b<=e?a>b:a<b)?-1:1});return d[g[0]]}},globalFonts=function(){var b={d:{},Add:function(c){if(!c)return api;c=new Font(c);var a=c.family;b.d[a]||(b.d[a]=new FontFamily);b.d[a].add(c);return b},Get:function(c,a,e){return!b.d[c]?null:b.d[c].get(a,e)}};return b}();function FollowLine(b){4>b.length?console.log("Invalid line"):(this.l=b,this.pi=this.acc=0)}
FollowLine.prototype.IsValid=function(b){return void 0!==this.l};
FollowLine.prototype.Advance=function(b){if(this.pi+3>=this.l.length)return null;var c=[this.l[this.pi],this.l[this.pi+1]],a=[this.l[this.pi+2],this.l[this.pi+3]],e=[a[0]-c[0],a[1]-c[1]],d=Math.sqrt(e[0]*e[0]+e[1]*e[1]),f=[e[0]/d,e[1]/d],a=[f[1],-f[0]],g=this.acc+b;b=[c[0]+f[0]*this.acc,c[1]+f[1]*this.acc];f=[0,0];intPoints=[];if(g>d){for(;g>d;)if(this.pi+=2,this.pi+3<this.l.length)g-=d,c=[this.l[this.pi],this.l[this.pi+1]],a=[this.l[this.pi+2],this.l[this.pi+3]],e=[a[0]-c[0],a[1]-c[1]],d=Math.sqrt(e[0]*
e[0]+e[1]*e[1]),intPoints.push(c[0]),intPoints.push(c[1]);else return null;f=[e[0]/d,e[1]/d];a=[c[0]+f[0]*g,c[1]+f[1]*g];c=[a[0]-b[0],a[1]-b[1]];a=Math.sqrt(c[0]*c[0]+c[1]*c[1]);a=[c[0]/a,c[1]/a];a=[a[1],-a[0]];c=[b[0]+c[0]/2,b[1]+c[1]/2];for(d=e=0;d<intPoints.length;d+=2)var h=[intPoints[d]-c[0],intPoints[d+1]-c[1]],f=Math.sqrt(h[0]*h[0]+h[1]*h[1]),h=[h[0]/f,h[1]/f],e=e+(h[0]*a[0]+h[1]*a[1])*f;e/=intPoints.length/2+2;f=[a[0]*e,a[1]*e]}this.acc=g;g=Math.acos(-a[1]);0>a[0]&&(g=-g);return[b[0]+f[0],
b[1]+f[1],g]};function TextOnLine(b,c,a,e){c=new FollowLine(c);if(c.IsValid())for(i in b.beginPath(),a){var d=a[i],f=b.measureText(d).width,f=c.Advance(f);if(!f)break;b.save();b.translate(f[0],f[1]);b.rotate(f[2]);e?b.fillText(d,0,0):b.strokeText(d,0,0);b.restore()}}function hasOwnProperty(b,c){return b.hasOwnProperty(c)}
var FontSize=function(b,c){this.value=parseFloat(b);this.unit=String(b).match(/[a-z%]*$/)[0]||"px";this.convert=function(a){return a/c*this.value};this.convertFrom=function(a){return a/this.value*c};this.toString=function(){return this.value+this.unit}},Font=function(b){var c=this.face=b.face,a=[],e={" ":1,"\u00a0":1,"\u3000":1};this.glyphs=function(a){var b,c={"\u2011":"-","\u00ad":"\u2011"};for(b in c)hasOwnProperty(c,b)&&(a[b]||(a[b]=a[c[b]]));return a}(b.glyphs);this.w=b.w;this.baseSize=parseInt(c["units-per-em"],
10);this.family=c["font-family"].toLowerCase();this.weight=c["font-weight"];this.style=c["font-style"]||"normal";this.viewBox=function(){var a=c.bbox.split(/\s+/),a={minX:parseInt(a[0],10),minY:parseInt(a[1],10),maxX:parseInt(a[2],10),maxY:parseInt(a[3],10)};a.width=a.maxX-a.minX;a.height=a.maxY-a.minY;a.toString=function(){return[this.minX,this.minY,this.width,this.height].join(" ")};return a}();this.ascent=-parseInt(c.ascent,10);this.descent=-parseInt(c.descent,10);this.height=-this.ascent+this.descent;
this.spacing=function(a,b,c){for(var h=this.glyphs,m,s,t=[],q=0,u=-1,r=-1,v;v=a[++u];)if(m=h[v]||this.missingGlyph)s&&(q-=s=s[v]||0,t[r]-=s),s=m.w,isNaN(s)&&(s=+this.w),0<s&&(s+=b,e[v]&&(s+=c)),q+=t[++r]=~~s,s=m.k;t.total=q;return t};this.applyLigatures=function(b,c){for(var e=0,h;e<a.length&&!h;e++)a[e].ligatures===c&&(h=a[e]);if(!h){var e=[],m;for(m in c)this.glyphs[c[m]]&&e.push(m);m=e.sort(function(a,b){return b.length-a.length||a>b}).join("|");a.push(h={ligatures:c,regexp:0<m.length?regexpCache[m]||
(regexpCache[m]=RegExp(m,"g")):null})}return h.regexp?b.replace(h.regexp,function(a){return c[a]||a}):b}};
function RenderTextCufon(b,c,a,e,d,f){d=new FollowLine(d);if(d.IsValid()){var g=parseInt(c.face["x-height"])/100*a.value,h=c.viewBox;b=b.split("");var m=c.spacing(b,~~a.convertFrom(0),~~a.convertFrom(0));if(!m.length)return null;a=a.convert(h.height);Math.ceil(a);a/=h.height;e.save();f||(e.lineWidth/=a);for(var h=c.glyphs,s,t=-1,q=-1,u=0;b[++t];){var r=d.Advance(m[q+1]*a);if(!r)break;e.save();e.translate(r[0],r[1]);e.rotate(r[2]);e.translate(0,g);e.scale(a,a);if(s=h[b[t]]||c.missingGlyph){if(s.d){e.beginPath();
e.moveTo(0,0);if(s.code){r=s.code;s=e;for(var v=0,w=r.length;v<w;++v){var z=r[v];s[z.m].apply(s,z.a)}}else{r=s;s="m"+s.d;var v=e,z=w=0,x=[],A=/([mrvxe])([^a-z]*)/g,B=void 0,D=0;a:for(;B=A.exec(s);++D){var C=B[2].split(",");switch(B[1]){case "v":x[D]={m:"bezierCurveTo",a:[w+~~C[0],z+~~C[1],w+~~C[2],z+~~C[3],w+=~~C[4],z+=~~C[5]]};break;case "r":x[D]={m:"lineTo",a:[w+=~~C[0],z+=~~C[1]]};break;case "m":x[D]={m:"moveTo",a:[w=~~C[0],z=~~C[1]]};break;case "x":x[D]={m:"closePath"};break;case "e":break a}v[x[D].m].apply(v,
x[D].a)}r.code=x}f?e.fill():e.stroke()}u+=m[++q];e.restore()}}e.restore()}}
function ExtendCanvasContext(b){Object.getPrototypeOf(b).fillTextOnLine=function(c,a){b.save();b.textBaseline="middle";TextOnLine(this,a,c,!0);b.restore()};Object.getPrototypeOf(b).strokeTextOnLine=function(c,a){b.save();b.textBaseline="middle";TextOnLine(this,a,c,!1);b.restore()};Object.getPrototypeOf(b).fillTextOnLine2=function(c,a){b.save();var e=this.fontParams.family.replace(/(^["' \t])|(["' \t]$)/g,"").toLowerCase();if(e=globalFonts.Get(e,this.fontParams.style,this.fontParams.weight)){var d=
new FontSize(this.fontParams.size,e.baseSize);RenderTextCufon(c,e,d,this,a,!0);b.restore()}else console.error("fillTextOnLine2 : font error 2")};Object.getPrototypeOf(b).strokeTextOnLine2=function(c,a){b.save();var e=this.fontParams.family.replace(/(^["' \t])|(["' \t]$)/g,"").toLowerCase();if(e=globalFonts.Get(e,this.fontParams.style,this.fontParams.weight)){var d=new FontSize(this.fontParams.size,e.baseSize);RenderTextCufon(c,e,d,this,a,!1);b.restore()}else console.error("fillTextOnLine2 : font error 2")};
Object.getPrototypeOf(b).SetFont=function(b){this.font=b;var a=$("<span />").appendTo("body");a.css("font",b);b=a.css("fontFamily");var e=parseInt(a.css("fontSize")),d=a.css("fontWeight"),f=a.css("fontStyle");this.fontParams={family:b,size:e,weight:d,style:f};a.remove()}};var TileRenderer={layerDummyColors:[],ApplyStyle:function(b,c,a,e,d,f,g){try{var h=g[e];if(h.visible)for(e=0;e<h.s.length;e++){var m=h.s[e];if(d>=m.zmax&&d<=m.zmin)for(f=0;f<m.s.length;f++){var s=m.s[f];if(TileRenderer[s.rt])TileRenderer[s.rt](b,c,a,s)}}}catch(t){}},maxRenderTime:0,RenderLayers:function(b,c,a,e,d,f,g){if(!e)return g;var h,m=!1;"undefined"===typeof g||null==g?h=0:(h=g,m=!0);g=(new Date).getTime();for(a.scale(1,1);h<e.l.length;++h){var s=e.l[h],t=s.c;if(b[t]==c){var q=s.g,u=null;"a"in
s&&(u=s.a);if(null!=q){for(s=0;s<q.length;++s){var r=q[s],v=null;u&&(v=u[s]);for(var w=0;w<r.length;++w)TileRenderer.ApplyStyle(a,r[w],v,t,d,c,f)}if(m&&(t=(new Date).getTime()-g,TileRenderer.maxRenderTime=Math.max(TileRenderer.maxRenderTime,t),10<t))break}}}t=(new Date).getTime()-g;return h<e.l.length?[h+1,t]:[null,t]},FindSubLayerId:function(b,c,a,e,d,f,g){c.scale(1,1);var h;for(h=a.l.length-1;0<=h;h--){var m=a.l[h],s=m.c;if(g[s]==f){var t=d[s];if(t.visible){c.fillStyle="#fff";c.fillRect(b.x,b.y,
1,1);var q=m.g,u=null;"a"in m&&(u=m.a);if(null!=q){for(m=0;m<q.length;++m){var r=q[m],v=null;u&&(v=u[m]);for(var w=0;w<r.length;++w)TileRenderer.ApplyLookupStyle(c,r[w],v,t,e)}t=c.getImageData(0,0,1,1).data;if("ffffff"!=("000000"+Utils.rgbToHex(t[0],t[1],t[2])).slice(-6))return s}}}}return!1},ApplyLookupStyle:function(b,c,a,e,d){try{for(var f=0;f<e.s.length;f++){var g=e.s[f];if(d>=g.zmax&&d<=g.zmin)for(var h=0;h<g.s.length;h++){var m=g.s[h];TileRenderer[m.rt]&&(m=jQuery.extend(!0,{},m),m.alpha="1",
m.fill="#000000",m.stroke="#000000",TileRenderer[m.rt](b,c,a,m))}}}catch(s){}},DrawImages:function(b,c,a,e){b&&b.IsLoaded()&&b.IsUpToDate()?(c.beginPath(),c.rect(a,e,MapParameters.tileSize,MapParameters.tileSize),c.closePath(),c.fillStyle="#FFFFFF",c.fill(),c.beginPath(),c.closePath(),b.RenderVectorialLayers(c,a,e)):(c.beginPath(),c.rect(a,e,MapParameters.tileSize,MapParameters.tileSize),c.closePath(),c.fillStyle="#EEEEEE",c.fill(),c.beginPath(),c.closePath())},LineSymbolizer:function(b,c,a,e){b.save();
"dasharray"in e?(a=e.dasharray.split(","),a=$.map(a,function(a){return parseInt(a)}),RenderLineDA(b,c,a)):RenderLine(b,c);"alpha"in e&&(b.globalAlpha=e.alpha);"width"in e&&(b.lineWidth=e.width);"linejoin"in e&&(b.lineJoin=e.linejoin);"linecap"in e&&(b.lineCap=e.linecap);"stroke"in e&&(b.strokeStyle=e.stroke,b.stroke());b.restore()},PolygonSymbolizer:function(b,c,a,e){b.save();RenderLine(b,c);"alpha"in e&&(b.globalAlpha=e.alpha);"fill"in e&&(b.fillStyle=e.fill,b.fill());b.restore()},LinePatternSymbolizer:function(b,
c,a,e){},PolygonPatternSymbolizer:function(b,c,a,e){},PointSymbolizer:function(b,c,a,e){},TextSymbolizer:function(b,c,a,e){},RasterSymbolizer:function(b,c,a,e){},ShieldSymbolizer:function(b,c,a,e){},BuildingSymbolizer:function(b,c,a,e){},MarkersSymbolizer:function(b,c,a,e){},GlyphSymbolizer:function(b,c,a,e){}};this.MaperialEvents={};MaperialEvents.LOADING="MaperialEvents.LOADING";MaperialEvents.READY="MaperialEvents.READY";MaperialEvents.REFRESH_SIZES="MaperialEvents.REFRESH_SIZES";MaperialEvents.MOUSE_DOWN="MaperialEvents.MOUSE_DOWN";MaperialEvents.MOUSE_UP="MaperialEvents.MOUSE_UP";MaperialEvents.MOUSE_MOVE="MaperialEvents.MOUSE_MOVE";MaperialEvents.MOUSE_UP_WIHTOUT_AUTOMOVE="MaperialEvents.MOUSE_UP_WIHTOUT_AUTOMOVE";MaperialEvents.CONTROL_UP="MaperialEvents.CONTROL_UP";MaperialEvents.CONTROL_DOWN="MaperialEvents.CONTROL_DOWN";
MaperialEvents.CONTROL_LEFT="MaperialEvents.CONTROL_LEFT";MaperialEvents.CONTROL_RIGHT="MaperialEvents.CONTROL_RIGHT";MaperialEvents.DRAGGING_MAP="MaperialEvents.DRAGGING_MAP";MaperialEvents.MAP_MOVING="MaperialEvents.MAP_MOVING";MaperialEvents.ZOOM_CHANGED="MaperialEvents.ZOOM_CHANGED";MaperialEvents.UPDATE_LATLON="MaperialEvents.UPDATE_LATLON";MaperialEvents.OPEN_STYLE="MaperialEvents.OPEN_STYLE";MaperialEvents.STYLE_CHANGED="MaperialEvents.STYLE_CHANGED";MaperialEvents.COLORBAR_CHANGED="MaperialEvents.COLORBAR_CHANGED";
MaperialEvents.CONTRAST_CHANGED="MaperialEvents.CONTRAST_CHANGED";MaperialEvents.LUMINOSITY_CHANGED="MaperialEvents.LUMINOSITY_CHANGED";MaperialEvents.BW_METHOD_CHANGED="MaperialEvents.BW_METHOD_CHANGED";MaperialEvents.DATA_SOURCE_CHANGED="MaperialEvents.DATA_SOURCE_CHANGED";
MaperialEvents.removeAllListeners=function(){$(window).off(MaperialEvents.UPDATE_LATLON);$(window).off(MaperialEvents.OPEN_STYLE);$(window).off(MaperialEvents.STYLE_CHANGED);$(window).off(MaperialEvents.COLORBAR_CHANGED);$(window).off(MaperialEvents.CONTRAST_CHANGED);$(window).off(MaperialEvents.LUMINOSITY_CHANGED);$(window).off(MaperialEvents.BW_METHOD_CHANGED);$(window).off(MaperialEvents.DATA_SOURCE_CHANGED);$(window).off(MaperialEvents.MOUSE_UP_WIHTOUT_AUTOMOVE);$(window).off(MaperialEvents.CONTROL_UP);
$(window).off(MaperialEvents.CONTROL_DOWN);$(window).off(MaperialEvents.CONTROL_LEFT);$(window).off(MaperialEvents.CONTROL_RIGHT)};Source.MaperialOSM="osm";Source.Raster="raster";Source.Vector="vector";Source.Images="images";function Source(b,c){this.type=b;this.params=c}Source.prototype.getURL=function(b,c,a){switch(this.type){case Source.MaperialOSM:return"http://www.maperial.com/api/tile?x="+b+"&y="+c+"&z="+a;case Source.Raster:return"http://map.x-ray.fr/api/tile/"+this.params.rasterUID+"?x="+b+"&y="+c+"&z="+a}};MapParameters.shadersPath="assets/shaders";MapParameters.mapCanvasName="map";MapParameters.magnifierCanvasName="magnifier";MapParameters.refreshRate=15;MapParameters.tileDLTimeOut=6E4;MapParameters.tileSize=256;MapParameters.autoMoveSpeedRate=0.2;MapParameters.autoMoveMillis=700;MapParameters.autoMoveDeceleration=0.0050;MapParameters.autoMoveAnalyseSize=10;MapParameters.DEFAULT="1_style_13ba851b4e18833e08e";MapParameters.AlphaBlend="AlphaBlend";MapParameters.AlphaClip="AlphaClip";
MapParameters.MulBlend="MulBlend";function MapParameters(b){console.log("creating parameters...");this.maperial=b;this.rasterUid=null;this.luminosity=this.contrast=0;this.bwMethod=1;this.obs=[];this.colorbars={};this.sources={};this.buildSources(this.maperial.config.layers)}
MapParameters.prototype.buildSources=function(b){console.log("fetching sources...");var c;this.sources=[];for(var a=0;a<b.length;a++){var e=b[a].source.type,d;switch(e){case Source.MaperialOSM:if(c)continue;c=!0;break;case Source.Raster:d={rasterUID:b[a].source.params.uid}}this.sources.push(new Source(e,d))}};
MapParameters.prototype.AddOrRefreshColorbar=function(b,c){this.colorbars[b]&&delete this.colorbars[b];this.colorbars[b]=new ColorBar;c.constructor===String?$.ajax({url:c,async:!1,dataType:"json",success:function(a){this.colorbars[b].data=new Uint8Array(a)}}):this.colorbars[b].data=new Uint8Array(c);$(window).trigger(MaperialEvents.COLORBAR_CHANGED)};MapParameters.prototype.GetColorBars=function(){return this.colorbars};
MapParameters.prototype.GetColorBar=function(b){return b in this.colorbars?this.colorbars[b]:null};MapParameters.prototype.SetRasterUid=function(b){this.rasterUid=b;$(window).trigger(MaperialEvents.DATA_SOURCE_CHANGED)};MapParameters.prototype.SetContrast=function(b){this.contrast=b;$(window).trigger(MaperialEvents.CONTRAST_CHANGED)};MapParameters.prototype.GetContrast=function(){return this.contrast};MapParameters.prototype.SetLuminosity=function(b){this.luminosity=b;$(window).trigger(MaperialEvents.LUMINOSITY_CHANGED)};
MapParameters.prototype.GetLuminosity=function(){return this.luminosity};MapParameters.prototype.SetBWMethod=function(b){this.bwMethod=Math.max(0,Math.min(4,Math.round(b)));$(window).trigger(MaperialEvents.BW_METHOD_CHANGED)};MapParameters.prototype.GetBWMethod=function(){return this.bwMethod};function ColorBar(){this.data=[];this.tex=null}
MapParameters.prototype.SetDefaultColorBar=function(){console.log("SetDefaultColorBar");var b=[];b.push(0);b.push(0);b.push(0);b.push(0);for(i=1;256>i;i+=1){var c=Math.round(2*i);255>=c?b.push(255-c):b.push(0);b.push(0);b.push(0);b.push(255)}this.AddOrRefreshColorbar(MapParameters.DEFAULT,b)};function MapMouse(b){console.log("listening mouse...");this.config=b.config;this.context=b.context;this.mouseDown=!1;this.lastWheelMillis=(new Date).getTime();this.initListeners()}MapMouse.prototype.initListeners=function(){this.context.mapCanvas.mousedown(Utils.apply(this,"down")).mouseup(Utils.apply(this,"up")).mousemove(Utils.apply(this,"move")).mouseleave(Utils.apply(this,"leave")).dblclick(Utils.apply(this,"doubleClick")).bind("mousewheel",Utils.apply(this,"wheel"))};
MapMouse.prototype.removeListeners=function(){this.context.mapCanvas.off("mousedown");this.context.mapCanvas.off("mouseup");this.context.mapCanvas.off("mousemove");this.context.mapCanvas.off("mouseleave");this.context.mapCanvas.unbind("dblclick");this.context.mapCanvas.unbind("mousewheel")};MapMouse.prototype.down=function(b){this.mouseDown=!0;this.context.mapCanvas.trigger(MaperialEvents.MOUSE_DOWN)};MapMouse.prototype.leave=function(b){this.mouseDown&&this.up(b)};
MapMouse.prototype.up=function(b){this.mouseDown=!1;this.context.mapCanvas.trigger(MaperialEvents.MOUSE_UP)};MapMouse.prototype.move=function(b){this.context.mouseP=Utils.getPoint(b);this.context.mouseM=this.convertCanvasPointToMeters(this.context.mouseP);this.context.mapCanvas.trigger(MaperialEvents.MOUSE_MOVE);this.mouseDown?this.context.mapCanvas.trigger(MaperialEvents.DRAGGING_MAP):this.context.mapCanvas.trigger(MaperialEvents.UPDATE_LATLON)};
MapMouse.prototype.doubleClick=function(b){this.context.zoom=Math.min(18,this.context.zoom+1);this.context.centerM=this.convertCanvasPointToMeters(this.context.mouseP);this.context.mouseP=Utils.getPoint(b);this.context.mouseM=this.convertCanvasPointToMeters(this.context.mouseP);$(window).trigger(MaperialEvents.ZOOM_CHANGED)};
MapMouse.prototype.wheel=function(b,c){b.preventDefault();if(!this.hasJustWheeled()){if(0<c)this.context.zoom=Math.min(18,this.context.zoom+1),this.context.centerM=this.convertCanvasPointToMeters(this.context.mouseP);else if(0>c){this.context.coordS.MetersToPixels(this.context.centerM.x,this.context.centerM.y,this.context.zoom);var a=new Point(this.context.mapCanvas.width()/2-this.context.mouseP.x,this.context.mapCanvas.height()/2-this.context.mouseP.y);this.context.zoom=Math.max(0,this.context.zoom-
1);var e=this.context.coordS.Resolution(this.context.zoom),a=new Point(a.x*e,a.y*e);this.context.centerM=new Point(this.context.mouseM.x+a.x,this.context.mouseM.y-a.y)}this.context.mouseP=Utils.getPoint(b);this.context.mouseM=this.convertCanvasPointToMeters(this.context.mouseP);$(window).trigger(MaperialEvents.ZOOM_CHANGED)}};MapMouse.prototype.hasJustWheeled=function(){var b=300>(new Date).getTime()-this.lastWheelMillis;this.lastWheelMillis=(new Date).getTime();return b};
MapMouse.prototype.convertCanvasPointToMeters=function(b){var c=this.context.mapCanvas.width(),a=this.context.mapCanvas.height(),e=this.context.coordS.MetersToPixels(this.context.centerM.x,this.context.centerM.y,this.context.zoom);return this.context.coordS.PixelsToMeters(e.x-(c/2-b.x),e.y+(a/2-b.y),this.context.zoom)};function HUD(b){console.log("building HUD...");this.config=b.config;this.context=b.context;this.buildTriggers();this.buildControls();this.display();this.initListeners();this.updateScale()}HUD.DISABLED="Maperial.DISABLED";HUD.TRIGGER="trigger";HUD.PANEL="panel";HUD.SETTINGS="HUDSettings";HUD.MAGNIFIER="Magnifier";HUD.COLORBAR="ColorBar";HUD.LATLON="LatLon";HUD.SCALE="Scale";HUD.MAPKEY="MapKey";HUD.CONTROLS="Controls";HUD.GEOLOC="Geoloc";HUD.DETAILS_MENU="DetailsMenu";HUD.QUICK_EDIT="QuickEdit";
HUD.ZOOMS="Zooms";HUD.positions=[];HUD.positions[HUD.SETTINGS]={left:"0",top:"0"};HUD.positions[HUD.MAGNIFIER]={left:"0",bottom:"0"};HUD.positions[HUD.COLORBAR]={left:"0",top:"180"};HUD.positions[HUD.SCALE]={left:"10",bottom:"10"};HUD.positions[HUD.MAPKEY]={right:"0",bottom:"0"};HUD.positions[HUD.CONTROLS]={left:"15",top:"40"};HUD.positions[HUD.LATLON]={left:"50%",bottom:"0"};HUD.positions[HUD.GEOLOC]={left:"50%",top:"0"};HUD.positions[HUD.DETAILS_MENU]={left:"0",top:"360"};
HUD.positions[HUD.QUICK_EDIT]={left:"0",top:"280"};HUD.positions[HUD.ZOOMS]={right:"25%",top:"0"};HUD.prototype.initListeners=function(){var b=this;this.context.mapCanvas.on(MaperialEvents.UPDATE_LATLON,function(c,a,e){b.updateLatLon()});$(window).on(MaperialEvents.MAP_MOVING,function(c,a,e){b.updateScale()});$(window).on(MaperialEvents.ZOOM_CHANGED,function(c,a,e){b.updateScale()})};
HUD.prototype.removeListeners=function(){this.context.mapCanvas.off(MaperialEvents.UPDATE_LATLON);$(window).off(MaperialEvents.MAP_MOVING);$(window).off(MaperialEvents.ZOOM_CHANGED);$(".trigger").unbind("click");$(".panel").unbind("click");$(".trigger").unbind("dragstart");$(".trigger").unbind("dragstop");$(".panel").unbind("dragstart");$(".panel").unbind("dragstop");$("#control-up").unbind("click");$("#control-down").unbind("click");$("#control-left").unbind("click");$("#control-right").unbind("click")};
HUD.prototype.getMargin=function(b){return this.config.hud.options["margin-"+b]?this.config.hud.options["margin-"+b]:0};
HUD.prototype.placeElements=function(){for(element in this.config.hud.elements){var b=HUD.positions[element];this.config.hud.elements[element].position&&(b=this.config.hud.elements[element].position);for(property in b){var c=b[property];if(-1==b[property].indexOf("%"))c=parseInt(c)+this.getMargin(property);else{var a=b[property].split("%")[0],e=$("#trigger"+element).width(),d=$("#trigger"+element).height(),f=$("#panel"+element).width(),g=$("#panel"+element).height();switch(property){case "top":case "bottom":switch(this.config.hud.elements[element].type){case HUD.PANEL:c=
a/100*this.context.mapCanvas[0].height-g/2;break;case HUD.TRIGGER:c=a/100*this.context.mapCanvas[0].height-d/2}break;case "left":case "right":switch(this.config.hud.elements[element].type){case HUD.PANEL:c=a/100*this.context.mapCanvas[0].width-f/2;break;case HUD.TRIGGER:c=a/100*this.context.mapCanvas[0].width-e/2}}c+=this.getMargin(property)}$("#panel"+element).css(property,c+"px");$("#trigger"+element).css(property,c+"px")}}};HUD.prototype.reset=function(){this.hideAllHUD()};
HUD.prototype.display=function(){this.showAllHUD();this.refreshSettingsPanel()};
HUD.prototype.buildControls=function(){var b=this;$("#control-zoom").slider({orientation:"vertical",range:"min",min:0,max:18,value:14,slide:function(b,a){},change:function(c,a){b.context.zoom=parseInt(a.value);$(window).trigger(MaperialEvents.ZOOM_CHANGED)}});$("#control-up").click(function(){$(window).trigger(MaperialEvents.CONTROL_UP)});$("#control-down").click(function(){$(window).trigger(MaperialEvents.CONTROL_DOWN)});$("#control-left").click(function(){$(window).trigger(MaperialEvents.CONTROL_LEFT)});
$("#control-right").click(function(){$(window).trigger(MaperialEvents.CONTROL_RIGHT)})};
HUD.prototype.buildTriggers=function(){var b=this;$(".panel").click(function(){var c=$(this).context.id.replace("panel","");b.putOnTop(c)});$(".trigger").click(function(){b.clickOnTrigger($(this));return!1});$(".panel").draggable({snap:".snapper",containment:"#map",scroll:!1});$(".trigger").draggable({snap:".snapper",containment:"#map",scroll:!1});for(element in this.config.hud.elements)this.config.hud.elements[element]!=HUD.DISABLED&&this.config.hud.elements[element].disableDrag&&($("#panel"+element).draggable("disable"),
$("#trigger"+element).draggable("disable"));$(".panel").bind("dragstart",function(c){c=$(this).context.id.replace("panel","");b.putOnTop(c);$("#trigger"+c).css({opacity:0})});$("#panelDetailsMenu").bind("dragstart",function(b){if("panelDetailsMenu"==b.srcElement.id)return $("#triggerDetailsMenu").css({opacity:1}),!1});$(".panel").bind("dragstop",function(b){var a=$(this).context.id;b=a.replace("panel","");var e=$("#"+a).css("top"),a=$("#"+a).css("left");$("#trigger"+b).css({top:e,left:a,opacity:1})});
$(".trigger").bind("dragstart",function(c){$(this).addClass("beingdrag");$(this).css("right","auto");$(this).css("bottom","auto");c=$(this).context.id.replace("trigger","");b.putOnTop(c)});$(".trigger").bind("dragstop",function(b){var a=$(this).context.id;b=a.replace("trigger","");var e=$("#"+a).css("top"),a=$("#"+a).css("left");$("#panel"+b).css({top:e,left:a})})};HUD.prototype.showTrigger=function(b){$("#icon"+b).show("fast");$("#trigger"+b).removeClass("active")};
HUD.prototype.hideTrigger=function(b){$("#icon"+b).hide("fast");$("#panel"+b).hide("fast");$("#trigger"+b).addClass("active")};HUD.prototype.clickOnTrigger=function(b){var c=b[0].id.replace("trigger","");this.putOnTop(c);b.hasClass("beingdrag")?b.removeClass("beingdrag"):(b.hasClass("active")&&!this.config.hud.elements[c].disableDrag?b.draggable("enable"):b.draggable("disable"),$("#icon"+c).toggle("fast"),$("#panel"+c).toggle("fast"),b.toggleClass("active"))};
HUD.prototype.refreshSettingsPanel=function(){$("#HUDSettings").empty();var b=0,c=this.config.hud,a=this;for(element in c.elements)if(c.elements[element]!=HUD.DISABLED&&!c.elements[element].disableHide){var e='<div class="row-fluid"><div class="span5 offset1">'+c.elements[element].label+'</div><div class="slider-frame offset6">   <span class="slider-button" id="toggle'+element+'"></span></div></div>';$("#HUDSettings").append(e);b+=50;$("#toggle"+element).click(function(){if($(this).hasClass("on")){$(this).removeClass("on");
var b=$(this).context.id.replace("toggle","");$("#"+c.elements[b].type+b).addClass("hide");c.elements[b].type==HUD.TRIGGER&&a.hideTrigger(b)}else $(this).addClass("on"),b=$(this).context.id.replace("toggle",""),$("#"+c.elements[b].type+b).removeClass("hide"),a.showTrigger(b)});c.elements[element].show&&$("#toggle"+element).addClass("on")}$("#panelHUDSettings").css("height",b+"px")};
HUD.prototype.hideAllHUD=function(){for(element in this.config.hud.elements)$("#"+this.config.hud[element].type+element).addClass("hide"),$("#toggle"+element).removeClass("on"),this.config.hud.elements[element].type==HUD.TRIGGER&&this.hideTrigger(element)};HUD.prototype.showAllHUD=function(){for(element in this.config.hud.elements)!0==this.config.hud.elements[element].show&&$("#"+this.config.hud.elements[element].type+element).removeClass("hide")};
HUD.prototype.putOnTop=function(b){$(".trigger").css({zIndex:101});$(".panel").css({zIndex:100});$("#trigger"+b).css({zIndex:201});$("#panel"+b).css({zIndex:200})};HUD.prototype.updateLatLon=function(){var b=this.context.coordS.MetersToLatLon(this.context.mouseM.x,this.context.mouseM.y);try{$("#longitudeDiv").empty(),$("#latitudeDiv").empty(),$("#longitudeDiv").append(b.x),$("#latitudeDiv").append(b.y)}catch(c){}};
HUD.ZOOM_METERS={1:"15500000",2:"4000000",3:"2000000",4:"1000000",5:"500000",6:"250000",7:"125000",8:"60000",9:"30000",10:"15000",11:"8000",12:"4000",13:"2000",14:"1000",15:"500",16:"250",17:"100",18:"50"};
HUD.prototype.updateScale=function(){var b=new Point(this.context.centerM.x+parseInt(HUD.ZOOM_METERS[this.context.zoom]),this.context.centerM.y),c=this.context.coordS.MetersToPixelsAccurate(this.context.centerM.x,this.context.centerM.y,this.context.zoom),b=this.context.coordS.MetersToPixelsAccurate(b.x,b.y,this.context.zoom).x-c.x,c=0.62137*b,a=HUD.ZOOM_METERS[this.context.zoom],e=6.2137E-4*HUD.ZOOM_METERS[this.context.zoom];try{$("#metersContainer").empty(),$("#milesContainer").empty(),$("#metersContainer").append(a+
"m"),$("#milesContainer").append(e+"mi"),$("#metersContainer").width(b+"px"),$("#milesContainer").width(c+"px")}catch(d){}};function MapRenderer(b){console.log("building map renderer...");this.drawSceneInterval;this.maperial=b;this.config=b.config;this.context=b.context;this.tileCache={};this.dataCache={};this.initListeners()}MapRenderer.prototype.reset=function(){this.removeListeners();for(var b in this.tileCache)this.tileCache[b].Release(),this.tileCache[b].Reset(),delete this.tileCache[b];this.tileCache={};this.dataCache={};this.DrawScene(!0,!0)};
MapRenderer.prototype.initListeners=function(){var b=this;if(this.config.hud.elements[HUD.MAGNIFIER])this.context.mapCanvas.on(MaperialEvents.MOUSE_MOVE,function(){b.DrawMagnifier()});$(window).on(MaperialEvents.MOUSE_UP_WIHTOUT_AUTOMOVE,function(){b.config.edition&&b.FindLayerId()});$(window).on(MaperialEvents.STYLE_CHANGED,function(){b.DrawScene(!0,!0)});$(window).on(MaperialEvents.COLORBAR_CHANGED,function(){b.BuildColorBar()});$(window).on(MaperialEvents.CONTRAST_CHANGED,function(){});$(window).on(MaperialEvents.LUMINOSITY_CHANGED,
function(){});$(window).on(MaperialEvents.BW_METHOD_CHANGED,function(){});$(window).on(MaperialEvents.DATA_SOURCE_CHANGED,function(){})};
MapRenderer.prototype.removeListeners=function(){this.context.mapCanvas.off(MaperialEvents.MOUSE_MOVE);$(window).off(MaperialEvents.MOUSE_UP_WIHTOUT_AUTOMOVE);$(window).off(MaperialEvents.STYLE_CHANGED);$(window).off(MaperialEvents.COLORBAR_CHANGED);$(window).off(MaperialEvents.CONTRAST_CHANGED);$(window).off(MaperialEvents.LUMINOSITY_CHANGED);$(window).off(MaperialEvents.BW_METHOD_CHANGED);$(window).off(MaperialEvents.DATA_SOURCE_CHANGED);clearInterval(this.drawSceneInterval)};
MapRenderer.prototype.fitToSize=function(){this.gl&&(this.gl.viewportWidth=this.context.mapCanvas.width(),this.gl.viewportHeight=this.context.mapCanvas.height())};
MapRenderer.prototype.InitGL=function(){this.glAsset={};this.glAsset.ctx=this.gl;this.context.parameters.assets=this.glAsset;this.glAsset.shaderData=null;this.glAsset.shaderError=!1;var b=this.glAsset;this.glAsset.ShaderReq=$.ajax({type:"GET",url:MapParameters.shadersPath+"/all.json",dataType:"json",async:!1,success:function(c,a,e){b.shaderData=c;for(k in b.shaderData)b.shaderData[k].code=b.shaderData[k].code.replace(/---/g,"\n")},error:function(c,a,e){b.shaderError=!0;console.log(MapParameters.shadersPath+
"/all.json : loading failed : "+a)}});this.glAsset.squareVertexPositionBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.glAsset.squareVertexPositionBuffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,0,256,0,0,0,256,0,256,256,0]),this.gl.STATIC_DRAW);this.glAsset.squareVertexPositionBuffer.itemSize=3;this.glAsset.squareVertexPositionBuffer.numItems=4;this.glAsset.squareVertexTextureBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.glAsset.squareVertexTextureBuffer);
this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,1,1]),this.gl.STATIC_DRAW);this.glAsset.squareVertexTextureBuffer.itemSize=2;this.glAsset.squareVertexTextureBuffer.numItems=4;this.gl.clearColor(1,1,1,1);this.gl.disable(this.gl.DEPTH_TEST);this.glAsset.prog={};this.glAsset.prog.Tex=this.gltools.MakeProgram("vertexTex","fragmentTex",this.glAsset);this.glAsset.prog.Clut=this.gltools.MakeProgram("vertexTex","fragmentClut",this.glAsset);this.glAsset.prog[MapParameters.MulBlend]=this.gltools.MakeProgram("vertexTex",
"fragmentMulBlend",this.glAsset);this.glAsset.prog[MapParameters.AlphaClip]=this.gltools.MakeProgram("vertexTex","fragmentAlphaClip",this.glAsset);this.glAsset.prog[MapParameters.AlphaBlend]=this.gltools.MakeProgram("vertexTex","fragmentAlphaBlend",this.glAsset)};
MapRenderer.prototype.BuildColorBar=function(){cbs=this.context.parameters.GetColorBars();this.gl.flush();this.gl.finish();for(k in cbs){cbData=cbs[k].data;if(null==cbData||1024!=cbData.length){console.log("Invalid colorbar data : "+k);break}cbs[k].tex&&(this.gl.deleteTexture(cbs[k].tex),delete cbs[k].tex,cbs[k].tex=null);try{cbs[k].tex=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_2D,cbs[k].tex),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!1),this.gl.texImage2D(this.gl.TEXTURE_2D,
0,this.gl.RGBA,256,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,cbData),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.bindTexture(this.gl.TEXTURE_2D,null)}catch(b){this.gl.deleteTexture(cbs[k].tex),delete cbs[k].tex,
cbs[k].tex=null,console.log("Error in colorbar building : "+k)}}return!0};
MapRenderer.prototype.Start=function(){console.log("Starting renderer...");try{this.gl=this.context.mapCanvas[0].getContext("experimental-webgl"),this.fitToSize()}catch(b){}if(!this.gl)return console.log("Could not initialise WebGL"),!1;this.gltools=new GLTools;this.InitGL();if(!this.BuildColorBar())return console.log("Can't build colorbar"),!1;this.DrawScene();this.drawSceneInterval=setInterval(Utils.apply(this,"DrawScene"),MapParameters.refreshRate+5);return!0};
MapRenderer.prototype.UpdateTileCache=function(b,c,a,e,d,f){var g=[];for(tx=c;tx<=a;tx+=1)for(ty=e;ty<=d;ty+=1){var h=tx+","+ty+","+b;g.push(h);null==this.tileCache[h]&&(this.tileCache[h]=new Tile(this.context.parameters,tx,ty,b))}for(h in this.tileCache){c=!1;for(b=0;b<g.length;b++)g[b]===h&&(c=!0);c||(this.tileCache[h].Release(),delete this.tileCache[h])}if(f)for(h in this.tileCache)f=this.tileCache[h].Reset();h=!1;c=MapParameters.refreshRate;for(b=0;b<g.length;b++)if((f=this.tileCache[g[b]])&&
!f.IsUpToDate())if(h=!0,c=f.Update(c),0>=c)break;return h};
MapRenderer.prototype.DrawScene=function(b,c){"undefined"===typeof b&&(b=!0);"undefined"===typeof c&&(c=!1);var a=this.context.mapCanvas.width(),e=this.context.mapCanvas.height(),d=Math.floor(a/2),f=Math.floor(e/2),g=this.context.coordS.Resolution(this.context.zoom),f=new Point(this.context.centerM.x-d*g,this.context.centerM.y+f*g),d=this.context.coordS.MetersToTile(f.x,f.y,this.context.zoom),f=this.context.coordS.MetersToPixels(f.x,f.y,this.context.zoom),f=new Point(Math.floor(d.x*MapParameters.tileSize-
f.x),Math.floor(-((d.y+1)*MapParameters.tileSize-f.y)));if(this.UpdateTileCache(this.context.zoom,d.x,d.x+Math.floor(a/MapParameters.tileSize+1),d.y-Math.floor(e/MapParameters.tileSize+1),d.y,c)||b){mvMatrix=mat4.create();pMatrix=mat4.create();mat4.identity(pMatrix);mat4.ortho(0,a,e,0,0,1,pMatrix);this.gl.viewport(0,0,a,e);this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);this.context.parameters.GetContrast();this.context.parameters.GetLuminosity();this.context.parameters.GetBWMethod();
for(var g=f.x,h=d.x;g<a;g+=MapParameters.tileSize,h+=1)for(var m=f.y,s=d.y;m<e;m+=MapParameters.tileSize,s-=1)mat4.identity(mvMatrix),mat4.translate(mvMatrix,[g,m,0]),this.tileCache[h+","+s+","+this.context.zoom].Render(pMatrix,mvMatrix)}};
MapRenderer.prototype.FindLayerId=function(){var b=this.context.coordS.MetersToTile(this.context.mouseM.x,this.context.mouseM.y,this.context.zoom),c=this.tileCache[b.x+","+b.y+","+this.context.zoom];if(c.IsLoaded()){var a=this.context.coordS.MetersToPixels(this.context.mouseM.x,this.context.mouseM.y,this.context.zoom),b=new Point(Math.floor(a.x-b.x*MapParameters.tileSize),Math.floor((b.y+1)*MapParameters.tileSize-a.y)),a=this.maperial.stylesManager.getSelectedStyle(),c=c.FindSubLayerId(b,this.context.zoom,
a.content);console.log("subLayerId :  "+c);$(window).trigger(MaperialEvents.OPEN_STYLE,[c])}};
MapRenderer.prototype.DrawMagnifier=function(){if(this.config.hud.elements[HUD.MAGNIFIER]!=HUD.DISABLED){var b=this.context.magnifierCanvas.width(),c=this.context.magnifierCanvas.height(),a=b/2/3,e=c/2/3,d=this.context.coordS.Resolution(this.context.zoom),e=new Point(this.context.mouseM.x-a*d,this.context.mouseM.y+e*d),a=this.context.coordS.MetersToTile(e.x,e.y,this.context.zoom),e=this.context.coordS.MetersToPixels(e.x,e.y,this.context.zoom),e=new Point(Math.floor(a.x*MapParameters.tileSize-e.x),
Math.floor(-((a.y+1)*MapParameters.tileSize-e.y))),d=this.context.magnifierCanvas[0].getContext("2d");d.save();d.globalCompositeOperation="source-over";d.scale(3,3);for(var f=e.x,g=a.x;f<b;f+=MapParameters.tileSize,g+=1)for(var h=e.y,m=a.y;h<c;h+=MapParameters.tileSize,m-=1)TileRenderer.DrawImages(this.tileCache[g+","+m+","+this.context.zoom],d,f,h);d.restore();this.DrawMagnifierSight(d)}};
MapRenderer.prototype.DrawMagnifierSight=function(b){var c=this.context.magnifierCanvas.width(),a=this.context.magnifierCanvas.height();b.beginPath();b.moveTo(c/2-20,a/2);b.lineTo(c/2-4,a/2);b.closePath();b.stroke();b.beginPath();b.moveTo(c/2+4,a/2);b.lineTo(c/2+20,a/2);b.closePath();b.stroke();b.beginPath();b.moveTo(c/2,a/2-20);b.lineTo(c/2,a/2-4);b.closePath();b.stroke();b.beginPath();b.moveTo(c/2,a/2+4);b.lineTo(c/2,a/2+20);b.closePath();b.stroke()};function MapMover(b){console.log("building mover...");this.config=b.config;this.context=b.context;this.lastMouseY=this.lastMouseX=null;this.autoMoving=!1;this.mouseData=[];this.drawers=[];this.defaultMoveDistance=300;this.defaultMoveMillis=150;this.initListeners()}
MapMover.prototype.initListeners=function(b){var c=this;this.context.mapCanvas.on(MaperialEvents.MOUSE_DOWN,function(){c.reset()});this.context.mapCanvas.on(MaperialEvents.MOUSE_UP,function(){c.receivedMouseUp()});this.context.mapCanvas.on(MaperialEvents.DRAGGING_MAP,function(){c.drag()});$(window).on(MaperialEvents.CONTROL_UP,function(){c.moveUp()});$(window).on(MaperialEvents.CONTROL_DOWN,function(){c.moveDown()});$(window).on(MaperialEvents.CONTROL_RIGHT,function(){c.moveRight()});$(window).on(MaperialEvents.CONTROL_LEFT,
function(){c.moveLeft()})};MapMover.prototype.removeListeners=function(){this.context.mapCanvas.off(MaperialEvents.MOUSE_DOWN);this.context.mapCanvas.off(MaperialEvents.MOUSE_UP);this.context.mapCanvas.off(MaperialEvents.DRAGGING_MAP);$(window).off(MaperialEvents.CONTROL_UP);$(window).off(MaperialEvents.CONTROL_DOWN);$(window).off(MaperialEvents.CONTROL_RIGHT);$(window).off(MaperialEvents.CONTROL_LEFT)};
MapMover.prototype.reset=function(){this.mouseData=[];this.lastMouseX=this.context.mouseP.x;this.lastMouseY=this.context.mouseP.y;this.autoMoving=!1};MapMover.prototype.drag=function(){var b=this.context.mouseP.x,c=this.context.mouseP.y,a=b-this.lastMouseX,e=c-this.lastMouseY;this.lastMouseX=b;this.lastMouseY=c;this.registerMouseData(b,c);this.moveMap(a,e);this.moveDrawers(a,e)};
MapMover.prototype.moveMap=function(b,c){var a=this.context.coordS.Resolution(this.context.zoom);this.context.centerM.x-=b*a;this.context.centerM.y+=c*a;$(window).trigger(MaperialEvents.MAP_MOVING)};MapMover.prototype.receivedMouseUp=function(){this.requireAutoMove()?this.prepareAutoMove():$(window).trigger(MaperialEvents.MOUSE_UP_WIHTOUT_AUTOMOVE)};
MapMover.prototype.requireAutoMove=function(){if(3>this.mouseData.length)return!1;var b=this.mouseData.pop();return 120<(new Date).getTime()-b.time?!1:!0};MapMover.prototype.prepareAutoMove=function(){var b=this.mouseData[0],c=this.mouseData.pop();this.move(c.x-b.x,c.y-b.y,c.time-b.time)};
MapMover.prototype.move=function(b,c,a){var e=Math.sqrt(b*b+c*c);a=1E3*e/a/MapParameters.refreshRate;b=a*b/e*MapParameters.autoMoveSpeedRate;c=a*c/e*MapParameters.autoMoveSpeedRate;this.autoMoving=!0;this.moveScene(MapParameters.autoMoveMillis,b,c,0)};MapMover.prototype.moveUp=function(){this.move(0,this.defaultMoveDistance,this.defaultMoveMillis)};MapMover.prototype.moveDown=function(){this.move(0,-this.defaultMoveDistance,this.defaultMoveMillis)};
MapMover.prototype.moveRight=function(){this.move(-this.defaultMoveDistance,0,this.defaultMoveMillis)};MapMover.prototype.moveLeft=function(){this.move(this.defaultMoveDistance,0,this.defaultMoveMillis)};MapMover.prototype.moveScene=function(b,c,a,e){if(!(0>b)&&this.autoMoving&&!isNaN(c)){this.moveMap(c,a);this.moveDrawers(c,a);var d=0.99-e*MapParameters.autoMoveDeceleration,f=this;setTimeout(function(){f.moveScene(b-MapParameters.refreshRate,c*d,a*d,e+1)},MapParameters.refreshRate)}};
MapMover.prototype.registerMouseData=function(b,c){this.mouseData.length>=MapParameters.autoMoveAnalyseSize&&this.mouseData.shift();var a={};a.x=b;a.y=c;a.time=(new Date).getTime();this.mouseData.push(a)};MapMover.prototype.addDrawer=function(b){this.drawers.push(b)};MapMover.prototype.removeDrawer=function(b){for(var c=0;c<this.drawers.length&&this.drawers[c]!==b;c++);this.drawers.splice(c,1)};
MapMover.prototype.resizeDrawers=function(){for(var b=0;b<this.drawers.length;b++)this.drawers[b].resize(this.config.width,this.config.height)};MapMover.prototype.moveDrawers=function(b,c){for(var a=0;a<this.drawers.length;a++){for(var e=this.drawers[a],d=0;d<e.pointsToMove.length;d++){var f=e.pointsToMove[d];f.x+=b;f.y+=c}e.draw()}};function StylesManager(b){this.maperial=b;this.stylesToLoad;this.nextFunction;this.styles={}}StylesManager.prototype.getSelectedStyle=function(){for(var b=0;b<this.maperial.config.layers.length;b++){var c=this.maperial.config.layers[b].params;if(c.styles)return this.styles[c.styles[c.selectedStyle]]}return null};StylesManager.prototype.getStyle=function(b){return this.styles[b]};
StylesManager.prototype.fetchStyles=function(b,c){this.nextFunction=c;if(0<b.length){var a=b.shift();this.stylesToLoad=b;this.loadStyle(a)}else c()};StylesManager.prototype.loadStyle=function(b){var c=this;if(this.styles[b])this.loadNextStyle();else{var a=this.getURL(b);console.log("fetching : "+a);$.ajax({type:"GET",url:a,dataType:"json",success:function(a){c.styles[b]={uid:b,name:"name_"+b,content:a};c.loadNextStyle()}})}};
StylesManager.prototype.loadNextStyle=function(){this.fetchStyles(this.stylesToLoad,this.nextFunction)};StylesManager.prototype.getURL=function(b){return this.maperial.config.serverURL+"/api/style/"+b};function LayersManager(b){this.maperial=b;this.layerSets={"0":{label:"Roads",subLayerIds:"02f 030 031 032 033 034 035 036 037 038 039 03a 03b 03c 03d 03e".split(" "),group:-1},1:{label:"Floors",subLayerIds:["001","008","011"],group:-1},2:{label:"Buildings",subLayerIds:["050"],group:-1}}}LayersManager.Vector="vector";LayersManager.Raster="raster";LayersManager.Images="images";
LayersManager.prototype.addLayer=function(b,c){var a;switch(b){case Source.MaperialOSM:a=this.getOSMLayerConfig(this.maperial.config.layers.length);break;case Source.Raster:a=c[0];console.log(a);a=this.getRasterLayerConfig(a);break;case Source.Vector:a=this.getVectorLayerConfig();break;case Source.Images:a=this.getImagesLayerConfig()}console.log("layerConfig");console.log(a);this.maperial.config.layers.push(a);this.maperial.restart()};
LayersManager.prototype.getOSMLayerConfig=function(b){return{type:LayersManager.Vector,source:{type:Source.MaperialOSM},params:{group:b}}};LayersManager.prototype.getRasterLayerConfig=function(b){return{type:LayersManager.Raster,source:{type:Source.Raster,params:{uid:b}},params:{colorbar:MapParameters.DEFAULT}}};LayersManager.prototype.getVectorLayerConfig=function(){return{type:LayersManager.Vector,source:{type:Source.Vector},params:{}}};
LayersManager.prototype.getImagesLayerConfig=function(){return{type:LayersManager.Images,source:{type:Source.Images},params:{}}};LayersManager.prototype.deleteLayer=function(b){b=this.maperial.config.layers.splice(b,1)[0];b.source.type==Source.MaperialOSM&&this.updateGroups(b.params.group);this.maperial.restart()};
LayersManager.prototype.updateGroups=function(b){console.log("updating groups with a groupRemovedId...");for(var c=0;c<this.maperial.config.layers.length;c++)this.maperial.config.layers[c].source.type==Source.MaperialOSM&&this.maperial.config.layers[c].params.group>b&&this.maperial.config.layers[c].params.group--;for(layerId in this.maperial.config.groups)this.maperial.config.groups[layerId]>b&&this.maperial.config.groups[layerId]--;for(c in this.layerSets)this.layerSets[c].group>b&&this.layerSets[c].group--};
LayersManager.prototype.buildGroups=function(b){console.log("building groups for style '"+b.name+"'...");this.maperial.config.groups={};for(layerId in b.content)this.maperial.config.groups[layerId]=0;for(i in this.layerSets)this.layerSets[i].group=0};LayersManager.prototype.useDefaultLayers=function(){console.log("  using default layers...");this.maperial.config.layers=[this.getOSMLayerConfig(0)]};
LayersManager.prototype.detachSet=function(b){this.layerSets[b].group=-1;for(var c=0;c<this.layerSets[b].subLayerIds.length;c++){var a=this.layerSets[b].subLayerIds[c];console.log("detaching "+a);this.maperial.config.groups[a]=-1}this.maperial.restart()};LayersManager.prototype.attachSet=function(b,c){this.layerSets[b].group=c;for(var a=0;a<this.layerSets[b].subLayerIds.length;a++){var e=this.layerSets[b].subLayerIds[a];console.log("attaching "+e);this.maperial.config.groups[e]=c}this.maperial.restart()};function BoundingBoxDrawer(b){this.map=b;this.drawBoard;this.drawingEnabled=this.selecting=!1;this.currentBox;this.centerLat;this.centerLon;this.latMin;this.lonMin;this.latMax;this.lonMax;this.initLatMin;this.initLonMin;this.initLatMax;this.initLonMax;this.zoomToFit;this.topLeftPoint;this.bottomRightPoint;this.startPoint;this.endPoint;this.pointsToMove=[];this.minSelectionSize=60}BoundingBoxDrawer.prototype.tryToRefresh=function(){try{this.draw()}catch(b){return!1}return!0};
BoundingBoxDrawer.prototype.init=function(){console.log("BoundingBoxDrawer.init");this.zoomToFit=null;if(!this.tryToRefresh()){console.log("init Fabric");this.drawBoard=new fabric.Canvas("drawBoard");this.drawBoard.setHeight(this.map.height);this.drawBoard.setWidth(this.map.width);console.log("newStartBox");this.newStartBox();console.log("mouse listeners");var b=this;this.map.mover.addDrawer(b);this.drawBoard.on("mouse:down",function(c){b.drawBoard.selection?c.target||(b.selecting=!0,b.startPoint=
new Point(c.e.x,c.e.y)):b.map.OnMouseDown(c.e)});this.drawBoard.on("mouse:up",function(c){b.drawBoard.selection?(b.selecting&&(b.endPoint=new Point(c.e.x,c.e.y),b.drawNewBoundingBox()),b.selecting=!1):b.map.OnMouseUp(c.e)});this.drawBoard.on("mouse:move",function(c){b.map.OnMouseMove(c.e)});this.drawBoard.on("object:modified",function(c){b.updateBoundingsFromCurrentBox();b.draw()});$("#drawBoardContainer").bind("mousewheel",function(c,a){b.map.OnMouseWheel(c,a);b.setBoundingsForZoom(b.map.zoom,!1)})}};
BoundingBoxDrawer.prototype.newStartBox=function(){this.topLeftPoint=new Point(this.drawBoard.getWidth()/2-200,this.drawBoard.getHeight()/2-200);this.bottomRightPoint=new Point(this.drawBoard.getWidth()/2+200,this.drawBoard.getHeight()/2+200);this.boundingsHaveChanged();this.setInitLatLon();this.draw()};BoundingBoxDrawer.prototype.cancelEdition=function(){this.setLatLon(this.initLatMin,this.initLonMin,this.initLatMax,this.initLonMax);this.zoomToFit=null;this.center()};
BoundingBoxDrawer.prototype.setInitLatLon=function(){this.initLatMin=this.latMin;this.initLatMax=this.latMax;this.initLonMin=this.lonMin;this.initLonMax=this.lonMax};BoundingBoxDrawer.prototype.setLatLon=function(b,c,a,e){this.latMin=b;this.latMax=a;this.lonMin=c;this.lonMax=e;this.centerLat=(this.latMin+this.latMax)/2;this.centerLon=(this.lonMin+this.lonMax)/2};BoundingBoxDrawer.prototype.resize=function(b,c){this.drawBoard.setHeight(c+App.Globals.HEADER_HEIGHT);this.drawBoard.setWidth(b);this.draw()};
BoundingBoxDrawer.prototype.updateBoundingsFromCurrentBox=function(){this.topLeftPoint.x=this.currentBox.left-this.currentBox.width*this.currentBox.scaleX/2;this.topLeftPoint.y=this.currentBox.top-this.currentBox.height*this.currentBox.scaleY/2;this.bottomRightPoint.x=this.currentBox.left+this.currentBox.width*this.currentBox.scaleX/2;this.bottomRightPoint.y=this.currentBox.top+this.currentBox.height*this.currentBox.scaleY/2;this.boundingsHaveChanged()};
BoundingBoxDrawer.prototype.drawNewBoundingBox=function(){Math.abs(this.endPoint.x-this.startPoint.x)<this.minSelectionSize||Math.abs(this.endPoint.y-this.startPoint.y)<this.minSelectionSize?this.drawBoard.setActiveObject(this.currentBox):(this.setBoundings(),this.draw(),this.zoomToFit=null)};
BoundingBoxDrawer.prototype.setBoundings=function(){this.startPoint.x<this.endPoint.x?this.startPoint.y<this.endPoint.y?(this.topLeftPoint=new Point(this.startPoint.x,this.startPoint.y),this.bottomRightPoint=new Point(this.endPoint.x,this.endPoint.y)):(this.topLeftPoint=new Point(this.startPoint.x,this.endPoint.y),this.bottomRightPoint=new Point(this.endPoint.x,this.startPoint.y)):this.startPoint.y<this.endPoint.y?(this.topLeftPoint=new Point(this.endPoint.x,this.startPoint.y),this.bottomRightPoint=
new Point(this.startPoint.x,this.endPoint.y)):(this.topLeftPoint=new Point(this.endPoint.x,this.endPoint.y),this.bottomRightPoint=new Point(this.startPoint.x,this.startPoint.y));this.boundingsHaveChanged();console.log("box from ["+this.topLeftPoint.x+" | "+this.topLeftPoint.y+"] to ["+this.bottomRightPoint.x+" | "+this.bottomRightPoint.y+"]")};
BoundingBoxDrawer.prototype.draw=function(){this.drawBoard.clear();var b=this.bottomRightPoint.x-this.topLeftPoint.x,c=this.bottomRightPoint.y-this.topLeftPoint.y,a=new fabric.Rect({width:b,height:c,top:this.topLeftPoint.y+c/2,left:this.topLeftPoint.x+b/2,fill:"rgba(0,0,0,0)"}),e=new fabric.Rect({width:this.drawBoard.getWidth(),height:this.topLeftPoint.y,top:this.topLeftPoint.y/2,left:this.drawBoard.getWidth()/2,fill:"rgba(0,0,0,0.7)",selectable:!1,hasControls:!1}),d=this.drawBoard.getHeight()-this.topLeftPoint.y-
c,d=new fabric.Rect({width:this.drawBoard.getWidth(),height:d,top:this.drawBoard.getHeight()-d/2,left:this.drawBoard.getWidth()/2,fill:"rgba(0,0,0,0.7)",selectable:!1,hasControls:!1}),f=new fabric.Rect({width:this.topLeftPoint.x,height:c,top:this.topLeftPoint.y+c/2,left:this.topLeftPoint.x/2,fill:"rgba(0,0,0,0.7)",selectable:!1,hasControls:!1}),b=this.drawBoard.getWidth()-this.topLeftPoint.x-b,c=new fabric.Rect({width:b,height:c,top:this.topLeftPoint.y+c/2,left:this.drawBoard.getWidth()-b/2,fill:"rgba(0,0,0,0.7)",
selectable:!1,hasControls:!1});this.drawBoard.add(f);this.drawBoard.add(c);this.drawBoard.add(e);this.drawBoard.add(d);this.drawBoard.add(a);this.currentBox=this.drawBoard.item(4);this.currentBox.lockRotation=!0;this.currentBox.hasRotatingPoint=!1;this.currentBox.set({borderColor:"black",cornerColor:"black",cornersize:5});this.drawBoard.selection=this.drawingEnabled;this.currentBox.selectable=this.drawingEnabled;(this.currentBox.hasControls=this.drawingEnabled)&&this.drawBoard.setActiveObject(this.currentBox)};
BoundingBoxDrawer.prototype.boundingsHaveChanged=function(){this.refreshLatLon();this.pointsToMove=[this.topLeftPoint,this.bottomRightPoint]};
BoundingBoxDrawer.prototype.refreshLatLon=function(){var b=this.map.coordS.MetersToPixels(this.map.centerM.x,this.map.centerM.y,this.map.zoom),c=this.drawBoard.getWidth()/2-this.topLeftPoint.x,a=this.drawBoard.getHeight()/2-this.topLeftPoint.y,e=this.bottomRightPoint.x-this.drawBoard.getWidth()/2,d=this.bottomRightPoint.y-this.drawBoard.getHeight()/2,c=this.map.coordS.PixelsToMeters(b.x-c,b.y+a,this.map.zoom),b=this.map.coordS.PixelsToMeters(b.x+e,b.y-d,this.map.zoom),e=this.map.coordS.MetersToLatLon(c.x,
c.y),b=this.map.coordS.MetersToLatLon(b.x,b.y);this.setLatLon(b.y,e.x,e.y,b.x)};BoundingBoxDrawer.prototype.center=function(){this.map.SetCenter(this.centerLat,this.centerLon);this.zoomToFit?this.setBoundingsForZoom(this.zoomToFit,!1):this.setBoundingsForZoom(16,!0)};
BoundingBoxDrawer.prototype.setBoundingsForZoom=function(b,c){c&&this.map.SetCenter(this.centerLat,this.centerLon);var a=this.map.coordS.MetersToPixels(this.map.centerM.x,this.map.centerM.y,b),e=this.map.coordS.LatLonToMeters(this.latMax,this.lonMin),d=this.map.coordS.LatLonToMeters(this.latMin,this.lonMax),f=this.map.coordS.MetersToPixels(e.x,e.y,b),e=this.map.coordS.MetersToPixels(d.x,d.y,b),d=a.x-f.x,f=f.y-a.y,g=e.x-a.x,a=a.y-e.y;this.topLeftPoint=new Point(this.drawBoard.getWidth()/2-d,this.drawBoard.getHeight()/
2-f);this.bottomRightPoint=new Point(this.drawBoard.getWidth()/2+g,this.drawBoard.getHeight()/2+a);c&&(0>this.topLeftPoint.x||this.bottomRightPoint.x>this.drawBoard.getWidth()||0>this.topLeftPoint.y||this.bottomRightPoint.y>this.drawBoard.getHeight())?this.setBoundingsForZoom(b-1,!0):(c&&(this.zoomToFit=b),this.map.SetZoom(b),this.boundingsHaveChanged(),this.draw())};BoundingBoxDrawer.prototype.deactivateDrawing=function(){this.drawingEnabled=!1;this.draw()};
BoundingBoxDrawer.prototype.activateDrawing=function(){this.zoomToFit&&this.map.zoom>this.zoomToFit&&this.center();this.drawingEnabled=!0;this.draw()};this.ColorTools={};ColorTools.rgbToHex=function(b,c,a){return ColorTools.toHex(b)+ColorTools.toHex(c)+ColorTools.toHex(a)};ColorTools.toHex=function(b){b=parseInt(b,10);if(isNaN(b))return"00";b=Math.max(0,Math.min(b,255));return"0123456789ABCDEF".charAt((b-b%16)/16)+"0123456789ABCDEF".charAt(b%16)};ColorTools.RGBAToHex=function(b){var c=b.split("(")[1].split(",")[0],a=b.split("(")[1].split(",")[1];b=b.split("(")[1].split(",")[2];return"#"+ColorTools.rgbToHex(c,a,b)};
ColorTools.cutHex=function(b){return"#"==b.charAt(0)?b.substring(1,7):b};ColorTools.hexToR=function(b){return parseInt(ColorTools.cutHex(b).substring(0,2),16)};ColorTools.hexToG=function(b){return parseInt(ColorTools.cutHex(b).substring(2,4),16)};ColorTools.hexToB=function(b){return parseInt(ColorTools.cutHex(b).substring(4,6),16)};ColorTools.HexToRGBA=function(b){var c=ColorTools.hexToR(b),a=ColorTools.hexToG(b);b=ColorTools.hexToB(b);return"rgba("+c+","+a+","+b+",1)"};this.Symbolizer={};Symbolizer.params={PolygonSymbolizer:["fill","alpha"],LineSymbolizer:"width stroke dasharray alpha linejoin linecap".split(" ")};Symbolizer.combos={linejoin:["miter","round","bevel"],linecap:["butt","round","square"]};Symbolizer.defaultValues={fill:"rgba(0,0,0,0)",stroke:"rgba(0,0,0,0)",width:"0",alpha:"1.0",dasharray:"",linejoin:"round",linecap:"round"};Symbolizer.getParamName=function(b,c){return Symbolizer.params[b][c]};(function(b){b.fn.extend({check:function(){return this.filter(":radio, :checkbox").attr("checked",!0)},uncheck:function(){return this.filter(":radio, :checkbox").removeAttr("checked")}})})(jQuery);Object.size=function(b){var c=0,a;for(a in b)b.hasOwnProperty(a)&&c++;return c};
function StyleMenu(b,c,a,e){console.log("building style menu...");this.maperial=e;this.style=this.maperial.stylesManager.getSelectedStyle();this.serverRootDirV="http://serv.x-ray.fr/project/mycarto/wwwClient/";this.serverRootDirD="http://map.x-ray.fr/";this.mappingArray=[];this.mapping=this.groups=null;this.activZooms=[];this.currentZmin=0;this.currentZmax=18;this.styleMenuParentEl=b;this.styleMenuParentEl2=c;this.styleMenuParentEl3=a;this.currentName=this.currentGroup=this.currentUid=this.zoomDiv=
this.widgetDiv=this.mainDiv=null;this.debug=!1;this.Load();this.initListeners();this.ChangeSelectedSubLayer("001")}StyleMenu.prototype.initListeners=function(b){var c=this;$(window).on(MaperialEvents.OPEN_STYLE,function(a,b){c.ChangeSelectedSubLayer(b)})};StyleMenu.prototype.removeListeners=function(b){$(window).off(MaperialEvents.OPEN_STYLE)};StyleMenu.prototype.Refresh=function(){$(window).trigger(MaperialEvents.STYLE_CHANGED)};
StyleMenu.prototype.DefFromRule=function(b,c){if(void 0==this.style.content[b])return this.debug&&console.log(b+" not in style"),-1;for(var a=0;3>Object.size(this.style.content[b].s[c].s[a]);)if(a+=1,a>=Object.size(this.style.content[b].s[c].s))return this.debug&&console.log("cannot find def ...",b,c),-1;return a};
StyleMenu.prototype.DefRuleIdFromZoom=function(b,c){if(void 0==this.style.content[b])return this.debug&&console.log(b+" not in style"),{def:-1,ruleId:-1,rule:-1};for(var a=0;a<Object.size(this.style.content[b].s);a++)if(this.style.content[b].s[a].zmin==c){for(var e=0;3>Object.size(this.style.content[b].s[a].s[e]);)if(e+=1,e>=Object.size(this.style.content[b].s[a].s))return this.debug&&console.log("cannot find def ...",b,a),{def:-1,ruleId:-1,rule:-1};return{def:e,ruleId:this.style.content[b].s[a].s[e].id,
rule:a}}return{def:-1,ruleId:-1,rule:-1}};StyleMenu.prototype.SetParam=function(b,c,a,e,d){if(void 0==this.style.content[b])return this.debug&&console.log(b+" not in style"),!1;for(var f=!1,g=0;g<Object.size(this.style.content[b].s[c].s[a]);g++){var h=Symbolizer.getParamName(this.style.content[b].s[c].s[a].rt,g);if(h==e){this.style.content[b].s[c].s[a][h]=d;f=!0;break}}f||(this.style.content[b].s[c].s[a][e]=d);this.Refresh();return f};
StyleMenu.prototype.SetParamId=function(b,c,a,e){if(void 0==this.style.content[b])return this.debug&&console.log(b+" not in style"),!1;for(var d=0;d<Object.size(this.style.content[b].s);d++)for(var f=0;Object.size(this.style.content[b].s[d].s);f++)if(this.style.content[b].s[d].s[f].id==c){for(c=0;c<Object.size(this.style.content[b].s[d].s[f]);c++){var g=Symbolizer.getParamName(this.style.content[b].s[d].s[f].rt,c);if(g==a)return this.style.content[b].s[d].s[f][g]=e,this.Refresh(),!0}this.style.content[b].s[d].s[f][a]=
e;this.Refresh();return!0}this.debug&&console.log(" not found !",b,c,a);return!1};StyleMenu.prototype.SetParamIdZNew=function(b,c,a){if(void 0==this.style.content[b])return this.debug&&console.log(b+" not in style"),!1;for(var e=0;e<Object.size(this.style.content[b].s);e++)if(-1<$.inArray(this.style.content[b].s[e].zmin,this.activZooms)){var d=this.DefFromRule(b,e);0>d||this.SetParam(b,e,d,c,a)}return!0};
StyleMenu.prototype.GetParamId=function(b,c,a){if(void 0==this.style.content[b])this.debug&&console.log(b+" not in style");else for(var e=0;e<Object.size(this.style.content[b].s);e++)for(var d=0;d<Object.size(this.style.content[b].s[e].s);d++)if(this.style.content[b].s[e].s[d].id==c)for(var f=0;f<Object.size(this.style.content[b].s[e].s[d]);f++){var g=Symbolizer.getParamName(this.style.content[b].s[e].s[d].rt,f);if(g==a)return this.style.content[b].s[e].s[d][g]}};StyleMenu.prototype.Load=function(){this.LoadGroup()};
StyleMenu.prototype.ReLoad=function(){this.BuildElements()};StyleMenu.prototype.LoadGroup=function(){this.debug&&console.log("Loading groups");var b=this;$.ajax({url:this.serverRootDirV+"style/group3.json",async:!1,dataType:"json",success:function(c){b.groups=c;b.LoadMapping()},error:function(){b.debug&&console.log("Loading group failed")}})};
StyleMenu.prototype.__LoadMapping=function(){this.debug&&console.log("##### MAPPING ####");for(var b=0;b<Object.size(this.mapping);b++)for(var c=0;c<Object.size(this.mapping[b].layers);c++)this.mappingArray[this.mapping[b].layers[c].id]={name:this.mapping[b].name,filter:this.mapping[b].layers[c].filter};this.BuildElements()};
StyleMenu.prototype.GetUids=function(b){var c=[];if("none"==b)return c;for(var a=0;a<Object.size(this.mapping);a++)if(this.mapping[a].name==b)for(var e=0;e<Object.size(this.mapping[a].layers);e++)c.push(this.mapping[a].layers[e].id);return c};StyleMenu.prototype.GetUid=function(b,c){for(var a=0;a<Object.size(this.mapping);a++)if(this.mapping[a].name==b)for(var e=0;e<Object.size(this.mapping[a].layers);e++)if(this.mapping[a].layers[e].filter==c)return this.mapping[a].layers[e].id;return null};
StyleMenu.prototype.LoadMapping=function(){this.debug&&console.log("Loading mapping");var b=this;$.ajax({url:this.serverRootDirV+"style/mapping.json",async:!1,dataType:"json",success:function(c){b.mapping=c;b.__LoadMapping()},error:function(){b.debug&&console.log("Loading mapping failed")}})};
StyleMenu.prototype.BuildElements=function(){this.styleMenuParentEl.empty();this.styleMenuParentEl2.empty();this.styleMenuParentEl3.empty();this.styleMenuParentEl.hide();this.mainDiv=$('<div id="styleMenu_menu_maindiv"></div>');this.mainDiv.appendTo(this.styleMenuParentEl);this.widgetDiv=$('<div class="styleMenu_menu_widgetDiv" id="styleMenu_menu_widgetDiv"></div>');this.widgetDiv.appendTo(this.styleMenuParentEl2);this.zoomDiv=$('<div class="styleMenu_menu_zoomDiv" id="styleMenu_menu_zoomDiv"></div>');
this.zoomDiv.appendTo(this.styleMenuParentEl3);this.__InsertZoomEdition();this.__InsertZoomEdition2();this.__InsertAccordion()};StyleMenu.prototype.UpdateActivZoom=function(){this.activZooms=[];for(var b=1;19>b;++b)b==this.maperial.GetZoom()?(this.debug&&console.log("map zoom is "+b),$("#styleMenu_menu_zcheck"+b).button("option","label","Z"+b+"*")):$("#styleMenu_menu_zcheck"+b).button("option","label","Z"+b),$("#styleMenu_menu_zcheck"+b).is(":checked")&&this.activZooms.push(b)};
StyleMenu.prototype.ZoomOut=function(){this.maperial.ZoomOut();this.UpdateActivZoom();this.__BuildWidget(this.currentGroup,this.currentName,this.currentUid)};StyleMenu.prototype.ZoomIn=function(){this.maperial.ZoomIn();this.UpdateActivZoom();this.__BuildWidget(this.currentGroup,this.currentName,this.currentUid)};StyleMenu.prototype.__InsertZoomEdition=function(){$("#styleMenu_menu_rlbutton").button();$("#styleMenu_menu_zbuttonminus").button();$("#styleMenu_menu_zbuttonplus").button()};
StyleMenu.prototype.__InsertZoomEdition2=function(){for(var b=this,c="",a=1;19>a;++a)c+='  <input type="checkbox" class="styleMenu_menu_checkboxz" id="styleMenu_menu_zcheck'+a+'"/><label class="zoom-button" for="styleMenu_menu_zcheck'+a+'">Z'+a+"</label>";$('<h2 class="styleMenu_menu_par_title_z"> Edit some zoom</h2><div id="styleMenu_menu_zoom_selector">'+c+"</div>").appendTo(this.zoomDiv);$('<h2 class="styleMenu_menu_par_title_z"> Edit a zoom range</h2><div id="styleMenu_menu_sliderrangez"></div><br/>').appendTo(this.zoomDiv);
for(a=1;19>a;++a)$("#styleMenu_menu_zcheck"+a).change(function(){b.UpdateActivZoom()});$("#styleMenu_menu_zoom_selector").buttonset();$("#styleMenu_menu_sliderrangez").slider({range:!0,min:1,max:19,values:[this.currentZmin,this.currentZmax],change:function(a,c){var f=c.values[0],g=c.values[1];b.currentZmin=f;b.currentZmax=g;for(var h=1;19>h;++h)h>=f&&h<g?$("#styleMenu_menu_zcheck"+h).check():$("#styleMenu_menu_zcheck"+h).uncheck(),$("#styleMenu_menu_zcheck"+h).button("refresh");b.UpdateActivZoom()},
slide:function(a,c){if(c.values[0]+1>c.values[1])return!1;var f=c.values[0],g=c.values[1];b.currentZmin=f;b.currentZmax=g;for(var h=1;19>h;++h)h>=f&&h<g?$("#styleMenu_menu_zcheck"+h).check():$("#styleMenu_menu_zcheck"+h).uncheck(),$("#styleMenu_menu_zcheck"+h).button("refresh");b.UpdateActivZoom()}});$("#styleMenu_menu_sliderrangez").slider("values",[this.currentZmin,this.currentZmax+1])};
StyleMenu.prototype.ColorPickerChange=function(b,c,a){return function(a,b,f){$("#styleMenu_menu_colorpicker_"+c+" div").css("backgroundColor","#"+b)}};StyleMenu.prototype.ColorPickerSubmit=function(b,c,a){var e=this;return function(c,f,g){e.SetParamIdZNew(b,a,ColorTools.HexToRGBA(f))}};StyleMenu.prototype.GetSpinnerCallBack=function(b,c,a){var e=this;return function(c,f){e.SetParamIdZNew(b,a,f.value)}};
StyleMenu.prototype.GetSliderCallBack=function(b,c,a){var e=this;return function(c,f){e.SetParamIdZNew(b,a,f.value)}};StyleMenu.prototype.GetSelectCallBack=function(b,c,a){var e=this;return function(){var d=$("#styleMenu_menu_select_"+a+"_"+c+" option:selected").text();e.SetParamIdZNew(b,a,d)}};
StyleMenu.prototype.GetCheckBoxCallBack=function(b){var c=this;return function(){var a=$("#styleMenu_menu_check_"+b+":checked").val()?!0:!1;c.style[b].visible=a;var e=c.GetGroupNameFilterFromLayerId(b),d=[];if("line"==this.groups[e.group][e.name].type)var f=c.groups[e.group][e.name].center,d=d.concat(c.GetUids(c.groups[e.group][e.name].casing)),d=d.concat(c.GetUids(f));else"poly"==this.groups[e.group][e.name].type&&(d=d.concat(c.GetUids(c.groups[e.group][e.name].line)));for(e=0;e<d.length;e++)f=d[e],
c.mappingArray[f].filter==this.mappingArray[b].filter&&(c.style[f].visible=a);c.Refresh()}};
StyleMenu.prototype.AddColorPicker=function(b,c,a,e,d){$("<li>"+b+' : <div class="colorSelector " id="styleMenu_menu_colorpicker_'+e+'"><div style="background-color:'+ColorTools.RGBAToHex(c)+'"></div></div> </li>').appendTo(d);$("#styleMenu_menu_colorpicker_"+e).ColorPicker({color:ColorTools.RGBAToHex(c),onShow:function(a){$(a).fadeIn(500);return!1},onHide:function(a){$(a).fadeOut(500);return!1},onChange:this.ColorPickerChange(a,e,b),onSubmit:this.ColorPickerSubmit(a,e,b)})};
StyleMenu.prototype.AddSpinner=function(b,c,a,e,d,f,g,h){$("<li>"+b+' : <input class="styleMenu_menu_spinner" id="styleMenu_menu_spinner_'+b+"_"+e+'"></li>').appendTo(d);$("#styleMenu_menu_spinner_"+b+"_"+e).spinner({spin:this.GetSpinnerCallBack(a,e,b),step:f,min:g,max:h});$("#styleMenu_menu_spinner_"+b+"_"+e).spinner("value",c)};
StyleMenu.prototype.AddSlider=function(b,c,a,e,d,f,g,h){$("<li>"+b+' : <div class="styleMenu_menu_slider" id="styleMenu_menu_slider_'+b+"_"+e+'"></li>').appendTo(d);$("#styleMenu_menu_slider_"+b+"_"+e).slider({range:!1,min:g,max:h,step:f,value:c,stop:this.GetSliderCallBack(a,e,b)});$("#styleMenu_menu_slider_"+b+"_"+e).slider("value",c)};
StyleMenu.prototype.AddCombo=function(b,c,a,e,d,f){$("<li>"+b+' : <select id="styleMenu_menu_select_'+b+"_"+e+'"></li>').appendTo(d);for(d=0;d<Object.size(f);d++)$("#styleMenu_menu_select_"+b+"_"+e).append('<option value="'+f[d]+'"> '+f[d]+"</option>");$("#styleMenu_menu_select_"+b+"_"+e).val(c);$("#styleMenu_menu_select_"+b+"_"+e).change(this.GetSelectCallBack(a,e,b))};
StyleMenu.prototype.Accordion=function(b,c,a){if(1>this.style.content[a].s.length)this.debug&&console.log("Error : empty style "+a);else{c=0;for(var e in this.groups)if(this.groups.hasOwnProperty(e)){if(e==b)break;c++}n=$("#styleMenu_menu_groupaccordion_div_group_"+c+" h2").index($("#styleMenu_menu_headeraccordion_"+a));$("#styleMenu_menu_accordion").accordion("activate",c);$("#styleMenu_menu_groupaccordion_div_group_"+c).accordion("activate",n)}};
StyleMenu.prototype.GetFilterAlias=function(b,c,a){if(this.groups[b][c].hasOwnProperty("alias")){for(var e in this.groups[b][c].alias){var d=this.groups[b][c].alias[e];if(0<=this.mappingArray[a].filter.indexOf(d))return this.debug&&console.log(d+" is in "+this.mappingArray[a].filter),e}if(!aliasFound)return this.mappingArray[a].filter}else return this.mappingArray[a].filter};
StyleMenu.prototype.FillWidget=function(b){if(1>this.style.content[b].s.length)this.debug&&console.log("Error : empty style "+b);else{this.debug&&console.log("Current zoom is ",this.maperial.GetZoom(),b,a,c);var c=this.DefRuleIdFromZoom(b,this.maperial.GetZoom()),a=c.def,e=c.ruleId,c=c.rule;this.debug&&console.log("Fill widget for",a,e,c);if(0>e)this.debug&&console.log("Cannot find ruleId for zoom "+this.maperial.GetZoom());else if(0>c)this.debug&&console.log("Cannot find rule for zoom "+this.maperial.GetZoom());
else if(0>a)this.debug&&console.log("Cannot find def for zoom "+this.maperial.GetZoom());else{var d=$("<div></div>");d.appendTo(this.widgetDiv);var f=$("<ul></ul>");f.appendTo(d);for(d=0;d<Object.size(Symbolizer.params[this.style.content[b].s[c].s[a].rt]);d++){var g=Symbolizer.getParamName(this.style.content[b].s[c].s[a].rt,d),h=this.GetParamId(b,e,g);void 0===h&&(h=Symbolizer.defaultValues[g]);"width"==g?this.AddSlider(g,h,b,e,f,0.25,0,20):"fill"==g||"stroke"==g?this.AddColorPicker(g,h,b,e,f):"alpha"==
g?this.AddSlider(g,h,b,e,f,0.05,0,1):"linejoin"==g?this.AddCombo(g,h,b,e,f,Symbolizer.combos.linejoin):"linecap"==g?this.AddCombo(g,h,b,e,f,Symbolizer.combos.linecap):$("<li>"+g+"(not implemented yet) : "+h+"</li>").appendTo(f)}}}};
StyleMenu.prototype.__BuildWidget=function(b,c,a){this.debug&&console.log("building widget ",b,c,a);this.widgetDiv.empty();this.currentUid=a;this.currentGroup=b;this.currentName=c;void 0==this.style.content[a]?this.debug&&console.log(a+" not in style"):($('<h2 class="styleMenu_menu_par_title">'+this.mappingArray[a].name+"</h2>").appendTo(this.widgetDiv),""!=this.mappingArray[a].filter&&1<this.GetUids(c).length&&$('<p class="styleMenu_menu_filter_title">('+this.GetFilterAlias(b,c,a)+")</p>").appendTo(this.widgetDiv),
"line"==this.groups[b][this.mappingArray[a].name].type?(this.FillWidget(a),c=this.groups[b][this.mappingArray[a].name].center,b=this.GetUid(this.groups[b][this.mappingArray[a].name].casing,this.mappingArray[a].filter),a=this.GetUid(c,this.mappingArray[a].filter),null!=b&&($('<h2 class="styleMenu_menu_par_title">casing </h2>').appendTo(this.widgetDiv),this.FillWidget(b)),null!=a&&($('<h2 class="styleMenu_menu_par_title">center line </h2>').appendTo(this.widgetDiv),this.FillWidget(a))):"poly"==this.groups[b][this.mappingArray[a].name].type&&
(this.FillWidget(a),this.GetUid(this.groups[b][this.mappingArray[a].name].line,this.mappingArray[a].filter)),this.UpdateActivZoom())};StyleMenu.prototype.GetWidgetCallBack=function(b,c,a){var e=this;return function(){e.__BuildWidget(b,c,a)}};
StyleMenu.prototype.GetGroupNameFilterFromLayerId=function(b){for(var c in this.groups)if(this.groups.hasOwnProperty(c))for(var a in this.groups[c])if(this.groups[c].hasOwnProperty(a)){var e=this.GetUids(a),d=[];if("line"==this.groups[c][a].type)var f=this.groups[c][a].center,d=d.concat(this.GetUids(this.groups[c][a].casing)),d=d.concat(this.GetUids(f));else"poly"==this.groups[c][a].type&&(d=d.concat(this.GetUids(this.groups[c][a].line)));if(0!=e.length){for(f=0;f<e.length;f++){var g=e[f];if(b==g)return{group:c,
name:a,filter:this.mappingArray[b].filter,uid:b}}for(f=0;f<d.length;f++)if(g=d[f],b==g)for(var h=0;h<e.length;++h)if(this.mappingArray[e[h]].filter==this.mappingArray[g].filter)return{group:c,name:a,filter:this.mappingArray[b].filter,uid:e[h]}}}return{group:null,name:null,filter:null,uid:null}};
StyleMenu.prototype.__InsertAccordion=function(){$("#styleMenu_menu_accordion").remove();var b=$('<div class="styleMenu_menu_accordion" id="styleMenu_menu_accordion"></div>');b.appendTo(this.mainDiv);var c=0,a;for(a in this.groups)if(this.groups.hasOwnProperty(a)){this.debug&&console.log(a);$('<h1 id="styleMenu_menu_groupaccordion_head_group_'+c+'"> Group : '+a+"</h1>").appendTo(b);var e=$('<div class="styleMenu_menu_accordion" id="styleMenu_menu_groupaccordion_div_group_'+c+'"></div>');e.appendTo(b);
c++;for(var d in this.groups[a])if(this.groups[a].hasOwnProperty(d)){this.debug&&console.log("found ! : "+d);var f=this.GetUids(d);if(0==f.length)this.debug&&console.log("Warning : no uid found for "+d,a);else for(var g=0;g<f.length;g++){var h=f[g];""!=this.mappingArray[h].filter&&1<this.GetUids(d).length?$('<h2 id="styleMenu_menu_headeraccordion_'+h+'">'+this.GetFilterAlias(a,d,h)+"</h2>").appendTo(e):$('<h2 id="styleMenu_menu_headeraccordion_'+h+'">'+this.mappingArray[h].name+"</h2>").appendTo(e);
$("#styleMenu_menu_headeraccordion_"+h).bind("click",this.GetWidgetCallBack(a,d,h));var m=$('<div class="inner" id="divinner_'+c+"_"+h+'"></div>');m.appendTo(e);$("<strong>Properties :<strong>").appendTo(m);var s=$("<ul></ul>");s.appendTo(m);$("<li>Filter : "+this.mappingArray[h].filter+"</li>").appendTo(s);$('<li>Visible  : <input type="checkbox" id="styleMenu_menu_check_'+h+'" /></li>').appendTo(s);$("#styleMenu_menu_check_"+h).click(this.GetCheckBoxCallBack(h));$("#styleMenu_menu_check_"+h).attr("checked",
this.style.content[h].visible);$("<li>Place : "+this.style.content[h].layer+"</li>").appendTo(s)}}}this.__BuildWidget("xxx","yyy","zzz");this.UpdateActivZoom();$(".styleMenu_menu_accordion").accordion({heightStyle:"content",collapsible:!0,active:!1});this.styleMenuParentEl.show()};StyleMenu.prototype.ChangeSelectedSubLayer=function(b){b=this.GetGroupNameFilterFromLayerId(b);null!=b.group&&null!=b.name&&(this.__BuildWidget(b.group,b.name,b.uid),this.Accordion(b.group,b.name,b.uid))};function Maperial(){this.config;this.context;this.mapRenderer;this.mapMover;this.mapMouse;this.hud;this.stylesManager=new StylesManager(this);this.layersManager=new LayersManager(this);this.styleMenu;this.serverURL="//map.x-ray.fr";this.scriptsPath="assets/javascripts/extensions"}Maperial.prototype.restart=function(){this.reset();this.load()};Maperial.prototype.apply=function(b){this.config=b;this.restart()};
Maperial.prototype.reset=function(){console.log("Reset maperial...");try{this.mapRenderer.reset()}catch(b){}try{this.mapMover.removeListeners(),this.mapMouse.removeListeners(),this.hud.removeListeners()}catch(c){}try{this.styleMenu.removeListeners()}catch(a){}var e=this.stylesManager.styles,d=this,d=new Maperial;d.stylesManager.styles=e};
Maperial.prototype.load=function(){console.log("Starting maperialJS build...");$(window).trigger(MaperialEvents.LOADING);this.checkConfig();if(0<this.config.layers.length){var b=this;this.loadStyles(function(){b.checkGroups();b.build()})}else this.finishStartup()};Maperial.prototype.build=function(){console.log("starting build...");this.createContext();this.buildMap();this.buildHUD();this.config.edition&&this.buildStyleMenu();this.initGeoloc();this.finishStartup()};
Maperial.prototype.finishStartup=function(){this.refreshScreen();$(window).resize(Utils.apply(this,"refreshScreen"));$(window).trigger(MaperialEvents.READY)};
Maperial.prototype.checkConfig=function(){console.log("checking config...");this.config||(this.config={});this.config.hud||(this.config.hud={elements:{},options:{}});this.config.map||(this.config.map={});this.config.serverURL||(this.config.serverURL=this.serverURL);this.config.layers?(console.log("  using custom layers..."),console.log(this.config.layers)):this.layersManager.useDefaultLayers();this.changeStyle(MapParameters.DEFAULT,0,!1)};
Maperial.prototype.loadStyles=function(b){console.log("checking styles...");for(var c=[],a=0;a<this.config.layers.length;a++){var e=this.config.layers[a].params;e.styles&&(c[a]=e.styles[e.selectedStyle])}0<c.length?(console.log("loading styles..."),this.stylesManager.fetchStyles(c,b)):b()};
Maperial.prototype.changeStyle=function(b,c,a){for(var e=0;e<this.config.layers.length;e++)if(this.config.layers[e].source.type==Source.MaperialOSM){var d=this.config.layers[e].params;if(!d.styles||a)a?console.log("Changing style..."):console.log("  using default style..."),d.styles={},d.styles[c]=b,d.selectedStyle=c}a&&this.restart()};
Maperial.prototype.createContext=function(){console.log("creating context...");this.context={};this.context.mapCanvas=$("#"+MapParameters.mapCanvasName);this.context.coordS=new CoordinateSystem(MapParameters.tileSize);this.context.centerM=this.context.coordS.LatLonToMeters(45.7,3.12);this.context.mouseM=this.context.centerM;this.context.mouseP=null;this.context.zoom=14;this.context.parameters=new MapParameters(this);this.config.hud.elements[HUD.MAGNIFIER]&&(this.context.magnifierCanvas=$("#"+MapParameters.magnifierCanvasName))};
Maperial.prototype.buildMap=function(){console.log("building map...");this.mapRenderer=new MapRenderer(this);this.mapMover=new MapMover(this);this.mapMouse=new MapMouse(this);this.mapRenderer.Start()};Maperial.prototype.initGeoloc=function(){this.config.hud.elements[HUD.GEOLOC]&&GeoLoc.init("GeoLoc",$("#GeoLocGo"),this,!1)};Maperial.prototype.buildStyleMenu=function(){this.styleMenu=new StyleMenu($("#detailsMenu"),$("#quickEdit"),$("#zooms"),this)};
Maperial.prototype.buildHUD=function(){this.hud=new HUD(this)};
Maperial.prototype.refreshScreen=function(){console.log("refreshing screen...");var b=$(window).width(),c=$(window).height();this.config.map.width&&(b=this.config.map.width);this.config.map.height&&(c=this.config.map.height);this.context.mapCanvas[0]&&(this.context.mapCanvas.css("width",b),this.context.mapCanvas.css("height",c),this.context.mapCanvas[0].width=b,this.context.mapCanvas[0].height=c);this.mapRenderer.fitToSize();this.mapMover.resizeDrawers();this.hud.placeElements()};
Maperial.prototype.checkGroups=function(){console.log("checking groups...");var b=this.stylesManager.getSelectedStyle();b&&!this.config.groups&&this.layersManager.buildGroups(b)};Maperial.prototype.SetCenter=function(b,c){this.context.centerM=this.context.coordS.LatLonToMeters(b,c);this.mapRenderer.DrawScene()};Maperial.prototype.SetZoom=function(b){-1<b&&19>b&&(this.context.zoom=b)};Maperial.prototype.GetZoom=function(){return this.context.zoom};
Maperial.prototype.ZoomIn=function(){18>this.context.zoom&&this.SetZoom(this.context.zoom+1)};Maperial.prototype.ZoomOut=function(){0<this.context.zoom&&this.SetZoom(this.context.zoom-1)};
